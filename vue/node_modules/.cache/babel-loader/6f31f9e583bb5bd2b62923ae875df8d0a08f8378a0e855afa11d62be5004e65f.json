{"ast":null,"code":"//======================================================\n//\n// Agora関連の処理管理用\n//\n// [索引]\n//  □ 0.   トークン生成\n//\n//\n//======================================================\n\n// AgoraSDK\nimport AgoraRTC from \"agora-rtc-sdk-ng\";\n// 定数\nimport { CONSTANTS } from '@/consts/ConstantVals';\n\n// role ホスト\nconst ROLE_HOST = \"host\";\n// role audience\nconst ROLE_AUDIENCE = \"audience\";\n\n// オプション設定\nlet _options = {};\n\n// パラメータ\nlet _channelParameters = {\n  // A variable to hold a local audio track.\n  localAudioTrack: null,\n  // A variable to hold a remote audio track.\n  remoteAudioTrack: null,\n  // A variable to hold the remote user id.\n  remoteUid: null\n};\n\n// agoraEngine\nlet _agoraEngine;\n\n// 通話中か\nlet _isPublishing = false;\n\n//======================================================\n//\n// 1-1. 自音声をPublish（音声通話に参加）\n//\n//======================================================\n\n/**\n * 自音声をPublish（音声通話に参加）\n */\nexport async function publishMyAudioByAgora() {\n  try {\n    // roleをhostに\n    _options.role = ROLE_HOST;\n    await _agoraEngine.setClientRole(_options.role);\n\n    // Create a local audio track from the microphone audio.\n    _channelParameters.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();\n    // Publish the local audio track in the channel.\n    await _agoraEngine.publish(_channelParameters.localAudioTrack);\n    console.log(\"Publish success!\");\n    _isPublishing = true;\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n//\n// 1-2. 自音声をUnPublish（音声通話から退出）\n//\n//======================================================\n\n/**\n * 自音声をUnPublish（音声通話から退出）\n */\nexport async function unpublishMyAudioByAgora() {\n  try {\n    // Create a local audio track from the microphone audio.\n    _channelParameters.localAudioTrack.close();\n    console.log(\"UnPublish success!\");\n    _isPublishing = false;\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n//\n// 2. subscribe\n//\n//======================================================\n\n/**\n * subscribe\n * \n * @param dom\n * @param roomId\n * @param userId\n */\nexport async function subscribeRoomAudioByAgora(dom, roomId, userId) {\n  try {\n    // optionsをセット\n    setOptions(roomId, userId, ROLE_AUDIENCE);\n    // 初期設定\n    initAgoraToken(dom);\n    // ロールをセット\n    await _agoraEngine.setClientRole(_options.role);\n    // Join a channel.\n    await _agoraEngine.join(_options.appId, _options.channel, _options.token, _options.uid);\n    console.log(\"Joined channel: \" + _options.channel);\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n// optionをセット\n//======================================================\n\n/**\n * optionsをセット\n * \n * @param {*} roomId \n * @param {*} userId\n * @param {*} myRole\n */\nfunction setOptions(roomId, userId, myRole) {\n  try {\n    _options = {\n      // Pass your App ID here.\n      appId: CONSTANTS.AGORA_APP_ID,\n      // Set the channel name.\n      channel: \"room\" + roomId,\n      // Pass your temp token here.\n      token: null,\n      // role\n      role: myRole,\n      // Set the user ID.\n      uid: userId //Math.floor(Math.random() * 1000000),\n    };\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n// agora初期化\n//======================================================\n\n/**\n * agora初期化\n */\nasync function initAgoraToken(dom) {\n  try {\n    // Create an instance of the Agora Engine\n    _agoraEngine = AgoraRTC.createClient({\n      mode: \"live\",\n      codec: \"vp8\"\n    });\n    // Listen for the \"user-unpublished\" event.\n    _agoraEngine.on(\"user-unpublished\", user => {\n      console.log(user.uid + \"has left the channel\");\n      console.log(\"Remote user has left the channel\");\n    });\n\n    // Listen for the \"user-published\" event to retrieve an AgoraRTCRemoteUser object.\n    _agoraEngine.on(\"user-published\", async (user, mediaType) => {\n      // Subscribe to the remote user when the SDK triggers the \"user-published\" event.\n      await _agoraEngine.subscribe(user, mediaType);\n      console.log(\"subscribe success\");\n\n      // Subscribe and play the remote audio track.\n      if (mediaType == \"audio\") {\n        if (user.uid !== _options.uid) {\n          _channelParameters.remoteUid = user.uid;\n          _channelParameters.remoteAudioTrack = user.audioTrack;\n          _channelParameters.remoteAudioTrack.play();\n          console.log(\"Remote user connected: \" + user.uid);\n\n          /*\n          let newMedia;\n          let stream = user.audioTrack.getMediaStreamTrack.stream;\n          newMedia = await document.createElement('audio');\n          newMedia.autoplay = true;\n          newMedia.src = stream;\n          //stream.attach(newMedia);\n          //dom.appendChild(_channelParameters.remoteAudioTrack);      \n          dom.appendChild(newMedia); \n          */\n          console.log(dom);\n        }\n      }\n    });\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n//\n// 3-1. Mute\n//\n//======================================================\n\n/**\n * Mute\n */\nexport async function muteByAgora() {\n  try {\n    await _channelParameters.localAudioTrack.setMuted(true);\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n//\n// 3-2. UnMute\n//\n//======================================================\n\n/**\n * Mute\n */\nexport async function unmuteByAgora() {\n  try {\n    await _channelParameters.localAudioTrack.setMuted(false);\n    //await localTracks.audioTrack.setMuted(true);\n    //localTrackState.audioTrackMuted = true;    \n  } catch (error) {\n    console.error(error);\n  }\n}\n\n//======================================================\n//\n// 4. 退室処理\n//\n//======================================================\n\n/**\n * 退室処理\n */\nexport async function leaveFromRoomByAgora() {\n  try {\n    // Destroy the local audio track.\n    if (_isPublishing) {\n      _channelParameters.localAudioTrack.close();\n      _isPublishing = false;\n    }\n\n    // Leave the channel\n    await _agoraEngine.leave();\n    console.log(\"[Agora Room退室] \");\n  } catch (error) {\n    console.error(error);\n  }\n}","map":{"version":3,"names":["AgoraRTC","CONSTANTS","ROLE_HOST","ROLE_AUDIENCE","_options","_channelParameters","localAudioTrack","remoteAudioTrack","remoteUid","_agoraEngine","_isPublishing","publishMyAudioByAgora","role","setClientRole","createMicrophoneAudioTrack","publish","console","log","error","unpublishMyAudioByAgora","close","subscribeRoomAudioByAgora","dom","roomId","userId","setOptions","initAgoraToken","join","appId","channel","token","uid","myRole","AGORA_APP_ID","createClient","mode","codec","on","user","mediaType","subscribe","audioTrack","play","muteByAgora","setMuted","unmuteByAgora","leaveFromRoomByAgora","leave"],"sources":["/Users/tsukamotohideki/go/src/github.com/tsubame/Voices/vue/src/utils/AgoraManager.js"],"sourcesContent":["//======================================================\n//\n// Agora関連の処理管理用\n//\n// [索引]\n//  □ 0.   トークン生成\n//\n//\n//======================================================\n\n// AgoraSDK\nimport AgoraRTC from \"agora-rtc-sdk-ng\"\n// 定数\nimport { CONSTANTS } from '@/consts/ConstantVals';\n\n// role ホスト\nconst ROLE_HOST = \"host\"\n// role audience\nconst ROLE_AUDIENCE = \"audience\"\n\n\n// オプション設定\nlet _options = {\n};\n\n// パラメータ\nlet _channelParameters = {\n  // A variable to hold a local audio track.\n  localAudioTrack: null,\n  // A variable to hold a remote audio track.\n  remoteAudioTrack: null,\n  // A variable to hold the remote user id.\n  remoteUid: null,\n};\n\n// agoraEngine\nlet _agoraEngine;\n\n// 通話中か\nlet _isPublishing = false;\n\n\n//======================================================\n//\n// 1-1. 自音声をPublish（音声通話に参加）\n//\n//======================================================\n\n/**\n * 自音声をPublish（音声通話に参加）\n */\nexport async function publishMyAudioByAgora()\n{\n  try {    \n    // roleをhostに\n    _options.role = ROLE_HOST;    \n    await _agoraEngine.setClientRole(_options.role);\n\n    // Create a local audio track from the microphone audio.\n    _channelParameters.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();\n    // Publish the local audio track in the channel.\n    await _agoraEngine.publish(_channelParameters.localAudioTrack);\n    console.log(\"Publish success!\");  \n    \n    _isPublishing = true;\n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n//\n// 1-2. 自音声をUnPublish（音声通話から退出）\n//\n//======================================================\n\n/**\n * 自音声をUnPublish（音声通話から退出）\n */\nexport async function unpublishMyAudioByAgora()\n{\n  try {    \n\n    // Create a local audio track from the microphone audio.\n    _channelParameters.localAudioTrack.close()    \n    console.log(\"UnPublish success!\");    \n\n    _isPublishing = false;    \n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n//\n// 2. subscribe\n//\n//======================================================\n\n/**\n * subscribe\n * \n * @param dom\n * @param roomId\n * @param userId\n */\nexport async function subscribeRoomAudioByAgora(dom, roomId, userId)\n{\n  try {\n    // optionsをセット\n    setOptions(roomId, userId, ROLE_AUDIENCE) \n    // 初期設定\n    initAgoraToken(dom)\n    // ロールをセット\n    await _agoraEngine.setClientRole(_options.role);       \n    // Join a channel.\n    await _agoraEngine.join(_options.appId, _options.channel, _options.token, _options.uid);\n    console.log(\"Joined channel: \" + _options.channel);\n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n// optionをセット\n//======================================================\n\n/**\n * optionsをセット\n * \n * @param {*} roomId \n * @param {*} userId\n * @param {*} myRole\n */\nfunction setOptions(roomId, userId, myRole) {\n  try {\n    _options = {\n      // Pass your App ID here.\n      appId: CONSTANTS.AGORA_APP_ID,\n      // Set the channel name.\n      channel: \"room\" + roomId,\n      // Pass your temp token here.\n      token: null,\n      // role\n      role: myRole,\n      // Set the user ID.\n      uid: userId,//Math.floor(Math.random() * 1000000),\n    };\n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n// agora初期化\n//======================================================\n\n/**\n * agora初期化\n */\nasync function initAgoraToken(dom) {\n  try {\n    // Create an instance of the Agora Engine\n    _agoraEngine = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    // Listen for the \"user-unpublished\" event.\n    _agoraEngine.on(\"user-unpublished\", user => {\n      console.log(user.uid + \"has left the channel\");\n      console.log(\"Remote user has left the channel\");\n    });    \n\n    // Listen for the \"user-published\" event to retrieve an AgoraRTCRemoteUser object.\n    _agoraEngine.on(\"user-published\", async (user, mediaType) => {\n      // Subscribe to the remote user when the SDK triggers the \"user-published\" event.\n      await _agoraEngine.subscribe(user, mediaType);      \n      console.log(\"subscribe success\");\n\n      // Subscribe and play the remote audio track.\n      if (mediaType == \"audio\") {\n        if (user.uid !== _options.uid) {\n          _channelParameters.remoteUid=user.uid;\n          _channelParameters.remoteAudioTrack = user.audioTrack;   \n          _channelParameters.remoteAudioTrack.play();\n          console.log(\"Remote user connected: \" + user.uid);    \n\n          /*\n          let newMedia;\n          let stream = user.audioTrack.getMediaStreamTrack.stream;\n          newMedia = await document.createElement('audio');\n          newMedia.autoplay = true;\n          newMedia.src = stream;\n          //stream.attach(newMedia);\n          //dom.appendChild(_channelParameters.remoteAudioTrack);      \n          dom.appendChild(newMedia); \n          */\n          console.log(dom)\n        }\n      }\n    });\n  } catch (error) {\n    console.error(error);    \n  }\n}\n\n//======================================================\n//\n// 3-1. Mute\n//\n//======================================================\n\n/**\n * Mute\n */\nexport async function muteByAgora() {\n  try {     \n    await _channelParameters.localAudioTrack.setMuted(true); \n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n//\n// 3-2. UnMute\n//\n//======================================================\n\n/**\n * Mute\n */\nexport async function unmuteByAgora() {\n  try {     \n    await _channelParameters.localAudioTrack.setMuted(false);\n    //await localTracks.audioTrack.setMuted(true);\n    //localTrackState.audioTrackMuted = true;    \n  } catch (error) {        \n    console.error(error);      \n  }\n}\n\n//======================================================\n//\n// 4. 退室処理\n//\n//======================================================\n\n/**\n * 退室処理\n */\nexport async function leaveFromRoomByAgora() {\n  try {     \n    // Destroy the local audio track.\n    if (_isPublishing) {\n      _channelParameters.localAudioTrack.close();\n      _isPublishing = false;\n    }\n\n    // Leave the channel\n    await _agoraEngine.leave();\n\n    console.log(\"[Agora Room退室] \")\n  } catch (error) {        \n    console.error(error);      \n  }\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}