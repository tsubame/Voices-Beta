(self["webpackChunkvue_test"]=self["webpackChunkvue_test"]||[]).push([[576],{8799:function(e,t,i){i(7658),i(2801),i(3767),i(8585),i(8696),i(541),function(t,i){e.exports=i()}(0,(function(){"use strict";function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof i.g?i.g:"undefined"!=typeof self?self:{},n=function(e){try{return!!e()}catch(e){return!0}},r=!n((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),s=r,o=Function.prototype,a=o.bind,c=o.call,d=s&&a.bind(c,c),l=s?function(e){return e&&d(e)}:function(e){return e&&function(){return c.apply(e,arguments)}},h=l({}.isPrototypeOf),u=function(e){return e&&e.Math==Math&&e},p=u("object"==typeof globalThis&&globalThis)||u("object"==typeof window&&window)||u("object"==typeof self&&self)||u("object"==typeof t&&t)||function(){return this}()||Function("return this")(),m=r,f=Function.prototype,g=f.apply,_=f.call,v="object"==typeof Reflect&&Reflect.apply||(m?_.bind(g):function(){return _.apply(g,arguments)}),y=function(e){return"function"==typeof e},E={},S=!n((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),b=r,w=Function.prototype.call,T=b?w.bind(w):function(){return w.apply(w,arguments)},C={},R={}.propertyIsEnumerable,I=Object.getOwnPropertyDescriptor,A=I&&!R.call({1:2},1);C.f=A?function(e){var t=I(this,e);return!!t&&t.enumerable}:R;var P,O,N=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},D=l,k=D({}.toString),x=D("".slice),L=function(e){return x(k(e),8,-1)},M=l,F=n,U=L,j=p.Object,V=M("".split),B=F((function(){return!j("z").propertyIsEnumerable(0)}))?function(e){return"String"==U(e)?V(e,""):j(e)}:j,H=p.TypeError,W=function(e){if(null==e)throw H("Can't call method on "+e);return e},K=B,G=W,q=function(e){return K(G(e))},z=y,J=function(e){return"object"==typeof e?null!==e:z(e)},Y={},X=Y,$=p,Q=y,Z=function(e){return Q(e)?e:void 0},ee=function(e,t){return arguments.length<2?Z(X[e])||Z($[e]):X[e]&&X[e][t]||$[e]&&$[e][t]},te=ee("navigator","userAgent")||"",ie=p,ne=te,re=ie.process,se=ie.Deno,oe=re&&re.versions||se&&se.version,ae=oe&&oe.v8;ae&&(O=(P=ae.split("."))[0]>0&&P[0]<4?1:+(P[0]+P[1])),!O&&ne&&(!(P=ne.match(/Edge\/(\d+)/))||P[1]>=74)&&(P=ne.match(/Chrome\/(\d+)/))&&(O=+P[1]);var ce=O,de=ce,le=n,he=!!Object.getOwnPropertySymbols&&!le((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&de&&de<41})),ue=he&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,pe=ee,me=y,fe=h,ge=ue,_e=p.Object,ve=ge?function(e){return"symbol"==typeof e}:function(e){var t=pe("Symbol");return me(t)&&fe(t.prototype,_e(e))},ye=p.String,Ee=function(e){try{return ye(e)}catch(e){return"Object"}},Se=y,be=Ee,we=p.TypeError,Te=function(e){if(Se(e))return e;throw we(be(e)+" is not a function")},Ce=Te,Re=function(e,t){var i=e[t];return null==i?void 0:Ce(i)},Ie=T,Ae=y,Pe=J,Oe=p.TypeError,Ne={exports:{}},De=p,ke=Object.defineProperty,xe=function(e,t){try{ke(De,e,{value:t,configurable:!0,writable:!0})}catch(n){De[e]=t}return t},Le="__core-js_shared__",Me=p[Le]||xe(Le,{}),Fe=Me;(Ne.exports=function(e,t){return Fe[e]||(Fe[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.20.3",mode:"pure",copyright:"Â© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.20.3/LICENSE",source:"https://github.com/zloirock/core-js"});var Ue=W,je=p.Object,Ve=function(e){return je(Ue(e))},Be=Ve,He=l({}.hasOwnProperty),We=Object.hasOwn||function(e,t){return He(Be(e),t)},Ke=l,Ge=0,qe=Math.random(),ze=Ke(1..toString),Je=function(e){return"Symbol("+(void 0===e?"":e)+")_"+ze(++Ge+qe,36)},Ye=p,Xe=Ne.exports,$e=We,Qe=Je,Ze=he,et=ue,tt=Xe("wks"),it=Ye.Symbol,nt=it&&it.for,rt=et?it:it&&it.withoutSetter||Qe,st=function(e){if(!$e(tt,e)||!Ze&&"string"!=typeof tt[e]){var t="Symbol."+e;Ze&&$e(it,e)?tt[e]=it[e]:tt[e]=et&&nt?nt(t):rt(t)}return tt[e]},ot=T,at=J,ct=ve,dt=Re,lt=function(e,t){var i,n;if("string"===t&&Ae(i=e.toString)&&!Pe(n=Ie(i,e)))return n;if(Ae(i=e.valueOf)&&!Pe(n=Ie(i,e)))return n;if("string"!==t&&Ae(i=e.toString)&&!Pe(n=Ie(i,e)))return n;throw Oe("Can't convert object to primitive value")},ht=st,ut=p.TypeError,pt=ht("toPrimitive"),mt=function(e,t){if(!at(e)||ct(e))return e;var i,n=dt(e,pt);if(n){if(void 0===t&&(t="default"),i=ot(n,e,t),!at(i)||ct(i))return i;throw ut("Can't convert object to primitive value")}return void 0===t&&(t="number"),lt(e,t)},ft=ve,gt=function(e){var t=mt(e,"string");return ft(t)?t:t+""},_t=J,vt=p.document,yt=_t(vt)&&_t(vt.createElement),Et=function(e){return yt?vt.createElement(e):{}},St=Et,bt=!S&&!n((function(){return 7!=Object.defineProperty(St("div"),"a",{get:function(){return 7}}).a})),wt=S,Tt=T,Ct=C,Rt=N,It=q,At=gt,Pt=We,Ot=bt,Nt=Object.getOwnPropertyDescriptor;E.f=wt?Nt:function(e,t){if(e=It(e),t=At(t),Ot)try{return Nt(e,t)}catch(e){}if(Pt(e,t))return Rt(!Tt(Ct.f,e,t),e[t])};var Dt=n,kt=y,xt=/#|\.prototype\./,Lt=function(e,t){var i=Ft[Mt(e)];return i==jt||i!=Ut&&(kt(t)?Dt(t):!!t)},Mt=Lt.normalize=function(e){return String(e).replace(xt,".").toLowerCase()},Ft=Lt.data={},Ut=Lt.NATIVE="N",jt=Lt.POLYFILL="P",Vt=Lt,Bt=Te,Ht=r,Wt=l(l.bind),Kt=function(e,t){return Bt(e),void 0===t?e:Ht?Wt(e,t):function(){return e.apply(t,arguments)}},Gt={},qt=S&&n((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),zt=p,Jt=J,Yt=zt.String,Xt=zt.TypeError,$t=function(e){if(Jt(e))return e;throw Xt(Yt(e)+" is not an object")},Qt=S,Zt=bt,ei=qt,ti=$t,ii=gt,ni=p.TypeError,ri=Object.defineProperty,si=Object.getOwnPropertyDescriptor,oi="enumerable",ai="configurable",ci="writable";Gt.f=Qt?ei?function(e,t,i){if(ti(e),t=ii(t),ti(i),"function"==typeof e&&"prototype"===t&&"value"in i&&ci in i&&!i.writable){var n=si(e,t);n&&n.writable&&(e[t]=i.value,i={configurable:ai in i?i.configurable:n.configurable,enumerable:oi in i?i.enumerable:n.enumerable,writable:!1})}return ri(e,t,i)}:ri:function(e,t,i){if(ti(e),t=ii(t),ti(i),Zt)try{return ri(e,t,i)}catch(e){}if("get"in i||"set"in i)throw ni("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var di=Gt,li=N,hi=S?function(e,t,i){return di.f(e,t,li(1,i))}:function(e,t,i){return e[t]=i,e},ui=p,pi=v,mi=l,fi=y,gi=E.f,_i=Vt,vi=Y,yi=Kt,Ei=hi,Si=We,bi=function(e){var t=function(i,n,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,n)}return new e(i,n,r)}return pi(e,this,arguments)};return t.prototype=e.prototype,t},wi=function(e,t){var i,n,r,s,o,a,c,d,l=e.target,h=e.global,u=e.stat,p=e.proto,m=h?ui:u?ui[l]:(ui[l]||{}).prototype,f=h?vi:vi[l]||Ei(vi,l,{})[l],g=f.prototype;for(r in t)i=!_i(h?r:l+(u?".":"#")+r,e.forced)&&m&&Si(m,r),o=f[r],i&&(a=e.noTargetGet?(d=gi(m,r))&&d.value:m[r]),s=i&&a?a:t[r],i&&typeof o==typeof s||(c=e.bind&&i?yi(s,ui):e.wrap&&i?bi(s):p&&fi(s)?mi(s):s,(e.sham||s&&s.sham||o&&o.sham)&&Ei(c,"sham",!0),Ei(f,r,c),p&&(Si(vi,n=l+"Prototype")||Ei(vi,n,{}),Ei(vi[n],r,s),e.real&&g&&!g[r]&&Ei(g,r,s)))},Ti=Math.ceil,Ci=Math.floor,Ri=function(e){var t=+e;return t!=t||0===t?0:(t>0?Ci:Ti)(t)},Ii=Ri,Ai=Math.min,Pi=function(e){return e>0?Ai(Ii(e),9007199254740991):0},Oi=function(e){return Pi(e.length)},Ni=Te,Di=Ve,ki=B,xi=Oi,Li=p.TypeError,Mi=function(e){return function(t,i,n,r){Ni(i);var s=Di(t),o=ki(s),a=xi(s),c=e?a-1:0,d=e?-1:1;if(n<2)for(;;){if(c in o){r=o[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw Li("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=d)c in o&&(r=i(r,o[c],c,s));return r}},Fi={left:Mi(!1),right:Mi(!0)},Ui=n,ji=function(e,t){var i=[][e];return!!i&&Ui((function(){i.call(null,t||function(){throw 1},1)}))},Vi="process"==L(p.process),Bi=Fi.left,Hi=ce,Wi=Vi;wi({target:"Array",proto:!0,forced:!ji("reduce")||!Wi&&Hi>79&&Hi<83},{reduce:function(e){var t=arguments.length;return Bi(this,e,t,t>1?arguments[1]:void 0)}});var Ki=Y,Gi=function(e){return Ki[e+"Prototype"]},qi=Gi("Array").reduce,zi=h,Ji=qi,Yi=Array.prototype,Xi=function(e){var t=e.reduce;return e===Yi||zi(Yi,e)&&t===Yi.reduce?Ji:t},$i=Xi;let Qi=!0,Zi=!0;function en(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}function tn(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return r.apply(this,arguments);const s=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,s),r.apply(this,[e,s])};const s=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(i))return s.apply(this,arguments);const n=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function nn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Qi=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function rn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Zi=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function sn(){if("object"==typeof window){if(Qi)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function on(e,t){Zi&&console.warn(e+" is deprecated, please use "+t+" instead.")}function an(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=en(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=en(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=en(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function cn(e){return"[object Object]"===Object.prototype.toString.call(e)}function dn(e){var t;return cn(e)?$i(t=Object.keys(e)).call(t,(function(t,i){const n=cn(e[i]),r=n?dn(e[i]):e[i],s=n&&!Object.keys(r).length;return void 0===r||s?t:Object.assign(t,{[i]:r})}),{}):e}function ln(e,t,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const s=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)})),s.forEach((t=>{e.forEach((i=>{i.type===n&&i.trackId===t.id&&function e(t,i,n){i&&!n.has(i.id)&&(n.set(i.id,i),Object.keys(i).forEach((r=>{r.endsWith("Id")?e(t,t.get(i[r]),n):r.endsWith("Ids")&&i[r].forEach((i=>{e(t,t.get(i),n)}))})))}(e,i,r)}))})),r}var hn=Ne.exports,un=Je,pn=hn("keys"),mn=function(e){return pn[e]||(pn[e]=un(e))},fn=!n((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),gn=p,_n=We,vn=y,yn=Ve,En=fn,Sn=mn("IE_PROTO"),bn=gn.Object,wn=bn.prototype,Tn=En?bn.getPrototypeOf:function(e){var t=yn(e);if(_n(t,Sn))return t[Sn];var i=t.constructor;return vn(i)&&t instanceof i?i.prototype:t instanceof bn?wn:null},Cn=p,Rn=y,In=Cn.String,An=Cn.TypeError,Pn=l,On=$t,Nn=function(e){if("object"==typeof e||Rn(e))return e;throw An("Can't set "+In(e)+" as a prototype")},Dn=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Pn(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return On(i),Nn(n),t?e(i,n):i.__proto__=n,i}}():void 0),kn={},xn=Ri,Ln=Math.max,Mn=Math.min,Fn=function(e,t){var i=xn(e);return i<0?Ln(i+t,0):Mn(i,t)},Un=q,jn=Fn,Vn=Oi,Bn=function(e){return function(t,i,n){var r,s=Un(t),o=Vn(s),a=jn(n,o);if(e&&i!=i){for(;o>a;)if((r=s[a++])!=r)return!0}else for(;o>a;a++)if((e||a in s)&&s[a]===i)return e||a||0;return!e&&-1}},Hn={includes:Bn(!0),indexOf:Bn(!1)},Wn={},Kn=We,Gn=q,qn=Hn.indexOf,zn=Wn,Jn=l([].push),Yn=function(e,t){var i,n=Gn(e),r=0,s=[];for(i in n)!Kn(zn,i)&&Kn(n,i)&&Jn(s,i);for(;t.length>r;)Kn(n,i=t[r++])&&(~qn(s,i)||Jn(s,i));return s},Xn=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],$n=Yn,Qn=Xn.concat("length","prototype");kn.f=Object.getOwnPropertyNames||function(e){return $n(e,Qn)};var Zn={};Zn.f=Object.getOwnPropertySymbols;var er=ee,tr=kn,ir=Zn,nr=$t,rr=l([].concat),sr=er("Reflect","ownKeys")||function(e){var t=tr.f(nr(e)),i=ir.f;return i?rr(t,i(e)):t},or=We,ar=sr,cr=E,dr=Gt,lr={},hr=Yn,ur=Xn,pr=Object.keys||function(e){return hr(e,ur)},mr=S,fr=qt,gr=Gt,_r=$t,vr=q,yr=pr;lr.f=mr&&!fr?Object.defineProperties:function(e,t){_r(e);for(var i,n=vr(t),r=yr(t),s=r.length,o=0;s>o;)gr.f(e,i=r[o++],n[i]);return e};var Er,Sr=ee("document","documentElement"),br=$t,wr=lr,Tr=Xn,Cr=Wn,Rr=Sr,Ir=Et,Ar=mn("IE_PROTO"),Pr=function(){},Or=function(e){return"<script>"+e+"<\/script>"},Nr=function(e){e.write(Or("")),e.close();var t=e.parentWindow.Object;return e=null,t},Dr=function(){try{Er=new ActiveXObject("htmlfile")}catch(e){}var e,t;Dr="undefined"!=typeof document?document.domain&&Er?Nr(Er):((t=Ir("iframe")).style.display="none",Rr.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(Or("document.F=Object")),e.close(),e.F):Nr(Er);for(var i=Tr.length;i--;)delete Dr.prototype[Tr[i]];return Dr()};Cr[Ar]=!0;var kr=Object.create||function(e,t){var i;return null!==e?(Pr.prototype=br(e),i=new Pr,Pr.prototype=null,i[Ar]=e):i=Dr(),void 0===t?i:wr.f(i,t)},xr=l("".replace),Lr=String(Error("zxcasd").stack),Mr=/\n\s*at [^:]*:[^\n]*/,Fr=Mr.test(Lr),Ur=J,jr=hi,Vr={},Br=Vr,Hr=st("iterator"),Wr=Array.prototype,Kr={};Kr[st("toStringTag")]="z";var Gr="[object z]"===String(Kr),qr=p,zr=Gr,Jr=y,Yr=L,Xr=st("toStringTag"),$r=qr.Object,Qr="Arguments"==Yr(function(){return arguments}()),Zr=zr?Yr:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=$r(e),Xr))?i:Qr?Yr(t):"Object"==(n=Yr(t))&&Jr(t.callee)?"Arguments":n},es=Zr,ts=Re,is=Vr,ns=st("iterator"),rs=function(e){if(null!=e)return ts(e,ns)||ts(e,"@@iterator")||is[es(e)]},ss=T,os=Te,as=$t,cs=Ee,ds=rs,ls=p.TypeError,hs=T,us=$t,ps=Re,ms=Kt,fs=T,gs=$t,_s=Ee,vs=function(e){return void 0!==e&&(Br.Array===e||Wr[Hr]===e)},ys=Oi,Es=h,Ss=function(e,t){var i=arguments.length<2?ds(e):t;if(os(i))return as(ss(i,e));throw ls(cs(e)+" is not iterable")},bs=rs,ws=function(e,t,i){var n,r;us(e);try{if(!(n=ps(e,"return"))){if("throw"===t)throw i;return i}n=hs(n,e)}catch(e){r=!0,n=e}if("throw"===t)throw i;if(r)throw n;return us(n),i},Ts=p.TypeError,Cs=function(e,t){this.stopped=e,this.result=t},Rs=Cs.prototype,Is=function(e,t,i){var n,r,s,o,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_ITERATOR),p=!(!i||!i.INTERRUPTED),m=ms(t,l),f=function(e){return n&&ws(n,"normal",e),new Cs(!0,e)},g=function(e){return h?(gs(e),p?m(e[0],e[1],f):m(e[0],e[1])):p?m(e,f):m(e)};if(u)n=e;else{if(!(r=bs(e)))throw Ts(_s(e)+" is not iterable");if(vs(r)){for(s=0,o=ys(e);o>s;s++)if((a=g(e[s]))&&Es(Rs,a))return a;return new Cs(!1)}n=Ss(e,r)}for(c=n.next;!(d=fs(c,n)).done;){try{a=g(d.value)}catch(e){ws(n,"throw",e)}if("object"==typeof a&&a&&Es(Rs,a))return a}return new Cs(!1)},As=Zr,Ps=p.String,Os=function(e){if("Symbol"===As(e))throw TypeError("Cannot convert a Symbol value to a string");return Ps(e)},Ns=Os,Ds=N,ks=!n((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",Ds(1,7)),7!==e.stack)})),xs=wi,Ls=p,Ms=h,Fs=Tn,Us=Dn,js=function(e,t,i){for(var n=ar(t),r=dr.f,s=cr.f,o=0;o<n.length;o++){var a=n[o];or(e,a)||i&&or(i,a)||r(e,a,s(t,a))}},Vs=kr,Bs=hi,Hs=N,Ws=function(e,t){if(Fr&&"string"==typeof e)for(;t--;)e=xr(e,Mr,"");return e},Ks=function(e,t){Ur(t)&&"cause"in t&&jr(e,"cause",t.cause)},Gs=Is,qs=function(e,t){return void 0===e?arguments.length<2?"":t:Ns(e)},zs=ks,Js=st("toStringTag"),Ys=Ls.Error,Xs=[].push,$s=function(e,t){var i,n=arguments.length>2?arguments[2]:void 0,r=Ms(Qs,this);Us?i=Us(new Ys,r?Fs(this):Qs):(i=r?this:Vs(Qs),Bs(i,Js,"Error")),void 0!==t&&Bs(i,"message",qs(t)),zs&&Bs(i,"stack",Ws(i.stack,1)),Ks(i,n);var s=[];return Gs(e,Xs,{that:s}),Bs(i,"errors",s),i};Us?Us($s,Ys):js($s,Ys,{name:!0});var Qs=$s.prototype=Vs(Ys.prototype,{constructor:Hs(1,$s),message:Hs(1,""),name:Hs(1,"AggregateError")});xs({global:!0},{AggregateError:$s});var Zs=y,eo=Me,to=l(Function.toString);Zs(eo.inspectSource)||(eo.inspectSource=function(e){return to(e)});var io,no,ro,so=eo.inspectSource,oo=y,ao=so,co=p.WeakMap,lo=oo(co)&&/native code/.test(ao(co)),ho=p,uo=l,po=J,mo=hi,fo=We,go=Me,_o=mn,vo=Wn,yo="Object already initialized",Eo=ho.TypeError,So=ho.WeakMap;if(lo||go.state){var bo=go.state||(go.state=new So),wo=uo(bo.get),To=uo(bo.has),Co=uo(bo.set);io=function(e,t){if(To(bo,e))throw new Eo(yo);return t.facade=e,Co(bo,e,t),t},no=function(e){return wo(bo,e)||{}},ro=function(e){return To(bo,e)}}else{var Ro=_o("state");vo[Ro]=!0,io=function(e,t){if(fo(e,Ro))throw new Eo(yo);return t.facade=e,mo(e,Ro,t),t},no=function(e){return fo(e,Ro)?e[Ro]:{}},ro=function(e){return fo(e,Ro)}}var Io,Ao,Po,Oo={set:io,get:no,has:ro,enforce:function(e){return ro(e)?no(e):io(e,{})},getterFor:function(e){return function(t){var i;if(!po(t)||(i=no(t)).type!==e)throw Eo("Incompatible receiver, "+e+" required");return i}}},No=S,Do=We,ko=Function.prototype,xo=No&&Object.getOwnPropertyDescriptor,Lo=Do(ko,"name"),Mo={EXISTS:Lo,PROPER:Lo&&"something"===function(){}.name,CONFIGURABLE:Lo&&(!No||No&&xo(ko,"name").configurable)},Fo=hi,Uo=function(e,t,i,n){n&&n.enumerable?e[t]=i:Fo(e,t,i)},jo=n,Vo=y,Bo=kr,Ho=Tn,Wo=Uo,Ko=st("iterator"),Go=!1;[].keys&&("next"in(Po=[].keys())?(Ao=Ho(Ho(Po)))!==Object.prototype&&(Io=Ao):Go=!0);var qo=null==Io||jo((function(){var e={};return Io[Ko].call(e)!==e}));Vo((Io=qo?{}:Bo(Io))[Ko])||Wo(Io,Ko,(function(){return this}));var zo={IteratorPrototype:Io,BUGGY_SAFARI_ITERATORS:Go},Jo=Zr,Yo=Gr?{}.toString:function(){return"[object "+Jo(this)+"]"},Xo=Gr,$o=Gt.f,Qo=hi,Zo=We,ea=Yo,ta=st("toStringTag"),ia=function(e,t,i,n){if(e){var r=i?e:e.prototype;Zo(r,ta)||$o(r,ta,{configurable:!0,value:t}),n&&!Xo&&Qo(r,"toString",ea)}},na=zo.IteratorPrototype,ra=kr,sa=N,oa=ia,aa=Vr,ca=function(){return this},da=wi,la=T,ha=function(e,t,i,n){var r=t+" Iterator";return e.prototype=ra(na,{next:sa(+!n,i)}),oa(e,r,!1,!0),aa[r]=ca,e},ua=Tn,pa=ia,ma=Uo,fa=Vr,ga=Mo.PROPER,_a=zo.BUGGY_SAFARI_ITERATORS,va=st("iterator"),ya="keys",Ea="values",Sa="entries",ba=function(){return this},wa=function(e,t,i,n,r,s,o){ha(i,t,n);var a,c,d,l=function(e){if(e===r&&f)return f;if(!_a&&e in p)return p[e];switch(e){case ya:case Ea:case Sa:return function(){return new i(this,e)}}return function(){return new i(this)}},h=t+" Iterator",u=!1,p=e.prototype,m=p[va]||p["@@iterator"]||r&&p[r],f=!_a&&m||l(r),g="Array"==t&&p.entries||m;if(g&&(a=ua(g.call(new e)))!==Object.prototype&&a.next&&(pa(a,h,!0,!0),fa[h]=ba),ga&&r==Ea&&m&&m.name!==Ea&&(u=!0,f=function(){return la(m,this)}),r)if(c={values:l(Ea),keys:s?f:l(ya),entries:l(Sa)},o)for(d in c)(_a||u||!(d in p))&&ma(p,d,c[d]);else da({target:t,proto:!0,forced:_a||u},c);return o&&p[va]!==f&&ma(p,va,f,{name:r}),fa[t]=f,c},Ta=q,Ca=Vr,Ra=Oo;Gt.f;var Ia=wa,Aa="Array Iterator",Pa=Ra.set,Oa=Ra.getterFor(Aa);Ia(Array,"Array",(function(e,t){Pa(this,{type:Aa,target:Ta(e),index:0,kind:t})}),(function(){var e=Oa(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==i?{value:n,done:!1}:"values"==i?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values"),Ca.Arguments=Ca.Array;var Na=p.Promise,Da=Uo,ka=ee,xa=Gt,La=S,Ma=st("species"),Fa=h,Ua=p.TypeError,ja=st("iterator"),Va=!1;try{var Ba=0,Ha={next:function(){return{done:!!Ba++}},return:function(){Va=!0}};Ha[ja]=function(){return this},Array.from(Ha,(function(){throw 2}))}catch(e){}var Wa=l,Ka=n,Ga=y,qa=Zr,za=so,Ja=function(){},Ya=[],Xa=ee("Reflect","construct"),$a=/^\s*(?:class|function)\b/,Qa=Wa($a.exec),Za=!$a.exec(Ja),ec=function(e){if(!Ga(e))return!1;try{return Xa(Ja,Ya,e),!0}catch(e){return!1}},tc=function(e){if(!Ga(e))return!1;switch(qa(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Za||!!Qa($a,za(e))}catch(e){return!0}};tc.sham=!0;var ic,nc,rc,sc,oc=!Xa||Ka((function(){var e;return ec(ec.call)||!ec(Object)||!ec((function(){e=!0}))||e}))?tc:ec,ac=oc,cc=Ee,dc=p.TypeError,lc=$t,hc=function(e){if(ac(e))return e;throw dc(cc(e)+" is not a constructor")},uc=st("species"),pc=function(e,t){var i,n=lc(e).constructor;return void 0===n||null==(i=lc(n)[uc])?t:hc(i)},mc=l([].slice),fc=/(?:ipad|iphone|ipod).*applewebkit/i.test(te),gc=p,_c=v,vc=Kt,yc=y,Ec=We,Sc=n,bc=Sr,wc=mc,Tc=Et,Cc=fc,Rc=Vi,Ic=gc.setImmediate,Ac=gc.clearImmediate,Pc=gc.process,Oc=gc.Dispatch,Nc=gc.Function,Dc=gc.MessageChannel,kc=gc.String,xc=0,Lc={},Mc="onreadystatechange";try{ic=gc.location}catch(e){}var Fc=function(e){if(Ec(Lc,e)){var t=Lc[e];delete Lc[e],t()}},Uc=function(e){return function(){Fc(e)}},jc=function(e){Fc(e.data)},Vc=function(e){gc.postMessage(kc(e),ic.protocol+"//"+ic.host)};Ic&&Ac||(Ic=function(e){var t=wc(arguments,1);return Lc[++xc]=function(){_c(yc(e)?e:Nc(e),void 0,t)},nc(xc),xc},Ac=function(e){delete Lc[e]},Rc?nc=function(e){Pc.nextTick(Uc(e))}:Oc&&Oc.now?nc=function(e){Oc.now(Uc(e))}:Dc&&!Cc?(sc=(rc=new Dc).port2,rc.port1.onmessage=jc,nc=vc(sc.postMessage,sc)):gc.addEventListener&&yc(gc.postMessage)&&!gc.importScripts&&ic&&"file:"!==ic.protocol&&!Sc(Vc)?(nc=Vc,gc.addEventListener("message",jc,!1)):nc=Mc in Tc("script")?function(e){bc.appendChild(Tc("script")).onreadystatechange=function(){bc.removeChild(this),Fc(e)}}:function(e){setTimeout(Uc(e),0)});var Bc,Hc,Wc,Kc,Gc,qc,zc,Jc,Yc={set:Ic,clear:Ac},Xc=p,$c=/ipad|iphone|ipod/i.test(te)&&void 0!==Xc.Pebble,Qc=/web0s(?!.*chrome)/i.test(te),Zc=p,ed=Kt,td=E.f,id=Yc.set,nd=fc,rd=$c,sd=Qc,od=Vi,ad=Zc.MutationObserver||Zc.WebKitMutationObserver,cd=Zc.document,dd=Zc.process,ld=Zc.Promise,hd=td(Zc,"queueMicrotask"),ud=hd&&hd.value;ud||(Bc=function(){var e,t;for(od&&(e=dd.domain)&&e.exit();Hc;){t=Hc.fn,Hc=Hc.next;try{t()}catch(e){throw Hc?Kc():Wc=void 0,e}}Wc=void 0,e&&e.enter()},nd||od||sd||!ad||!cd?!rd&&ld&&ld.resolve?((zc=ld.resolve(void 0)).constructor=ld,Jc=ed(zc.then,zc),Kc=function(){Jc(Bc)}):od?Kc=function(){dd.nextTick(Bc)}:(id=ed(id,Zc),Kc=function(){id(Bc)}):(Gc=!0,qc=cd.createTextNode(""),new ad(Bc).observe(qc,{characterData:!0}),Kc=function(){qc.data=Gc=!Gc}));var pd=ud||function(e){var t={fn:e,next:void 0};Wc&&(Wc.next=t),Hc||(Hc=t,Kc()),Wc=t},md={},fd=Te,gd=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=n})),this.resolve=fd(t),this.reject=fd(i)};md.f=function(e){return new gd(e)};var _d=$t,vd=J,yd=md,Ed=function(e,t){if(_d(e),vd(t)&&t.constructor===e)return t;var i=yd.f(e);return(0,i.resolve)(t),i.promise},Sd=p,bd=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},wd=function(){this.head=null,this.tail=null};wd.prototype={add:function(e){var t={item:e,next:null};this.head?this.tail.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return this.head=e.next,this.tail===e&&(this.tail=null),e.item}};var Td,Cd,Rd,Id="object"==typeof window,Ad=wi,Pd=p,Od=ee,Nd=T,Dd=Na,kd=function(e,t,i){for(var n in t)i&&i.unsafe&&e[n]?e[n]=t[n]:Da(e,n,t[n],i);return e},xd=ia,Ld=function(e){var t=ka(e),i=xa.f;La&&t&&!t[Ma]&&i(t,Ma,{configurable:!0,get:function(){return this}})},Md=Te,Fd=y,Ud=J,jd=function(e,t){if(Fa(t,e))return e;throw Ua("Incorrect invocation")},Vd=so,Bd=Is,Hd=function(e,t){if(!t&&!Va)return!1;var i=!1;try{var n={};n[ja]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},Wd=pc,Kd=Yc.set,Gd=pd,qd=Ed,zd=function(e,t){var i=Sd.console;i&&i.error&&(1==arguments.length?i.error(e):i.error(e,t))},Jd=md,Yd=bd,Xd=wd,$d=Oo,Qd=Vt,Zd=Id,el=Vi,tl=ce,il=st("species"),nl="Promise",rl=$d.getterFor(nl),sl=$d.set,ol=$d.getterFor(nl),al=Dd&&Dd.prototype,cl=Dd,dl=al,ll=Pd.TypeError,hl=Pd.document,ul=Pd.process,pl=Jd.f,ml=pl,fl=!!(hl&&hl.createEvent&&Pd.dispatchEvent),gl=Fd(Pd.PromiseRejectionEvent),_l="unhandledrejection",vl=Qd(nl,(function(){var e=Vd(cl),t=e!==String(cl);if(!t&&66===tl)return!0;if(!dl.finally)return!0;if(tl>=51&&/native code/.test(e))return!1;var i=new cl((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};return(i.constructor={})[il]=n,!(i.then((function(){}))instanceof n)||!t&&Zd&&!gl})),yl=vl||!Hd((function(e){cl.all(e).catch((function(){}))})),El=function(e){var t;return!(!Ud(e)||!Fd(t=e.then))&&t},Sl=function(e,t){var i,n,r,s=t.value,o=1==t.state,a=o?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(o||(2===t.rejection&&Rl(t),t.rejection=1),!0===a?i=s:(l&&l.enter(),i=a(s),l&&(l.exit(),r=!0)),i===e.promise?d(ll("Promise-chain cycle")):(n=El(i))?Nd(n,i,c,d):c(i)):d(s)}catch(e){l&&!r&&l.exit(),d(e)}},bl=function(e,t){e.notified||(e.notified=!0,Gd((function(){for(var i,n=e.reactions;i=n.get();)Sl(i,e);e.notified=!1,t&&!e.rejection&&Tl(e)})))},wl=function(e,t,i){var n,r;fl?((n=hl.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),Pd.dispatchEvent(n)):n={promise:t,reason:i},!gl&&(r=Pd["on"+e])?r(n):e===_l&&zd("Unhandled promise rejection",i)},Tl=function(e){Nd(Kd,Pd,(function(){var t,i=e.facade,n=e.value;if(Cl(e)&&(t=Yd((function(){el?ul.emit("unhandledRejection",n,i):wl(_l,i,n)})),e.rejection=el||Cl(e)?2:1,t.error))throw t.value}))},Cl=function(e){return 1!==e.rejection&&!e.parent},Rl=function(e){Nd(Kd,Pd,(function(){var t=e.facade;el?ul.emit("rejectionHandled",t):wl("rejectionhandled",t,e.value)}))},Il=function(e,t,i){return function(n){e(t,n,i)}},Al=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,bl(e,!0))},Pl=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw ll("Promise can't be resolved itself");var n=El(t);n?Gd((function(){var i={done:!1};try{Nd(n,t,Il(Pl,i,e),Il(Al,i,e))}catch(t){Al(i,t,e)}})):(e.value=t,e.state=1,bl(e,!1))}catch(t){Al({done:!1},t,e)}}};vl&&(dl=(cl=function(e){jd(this,dl),Md(e),Nd(Td,this);var t=rl(this);try{e(Il(Pl,t),Il(Al,t))}catch(e){Al(t,e)}}).prototype,(Td=function(e){sl(this,{type:nl,done:!1,notified:!1,parent:!1,reactions:new Xd,rejection:!1,state:0,value:void 0})}).prototype=kd(dl,{then:function(e,t){var i=ol(this),n=pl(Wd(this,cl));return i.parent=!0,n.ok=!Fd(e)||e,n.fail=Fd(t)&&t,n.domain=el?ul.domain:void 0,0==i.state?i.reactions.add(n):Gd((function(){Sl(n,i)})),n.promise},catch:function(e){return this.then(void 0,e)}}),Cd=function(){var e=new Td,t=rl(e);this.promise=e,this.resolve=Il(Pl,t),this.reject=Il(Al,t)},Jd.f=pl=function(e){return e===cl||e===Rd?new Cd(e):ml(e)}),Ad({global:!0,wrap:!0,forced:vl},{Promise:cl}),xd(cl,nl,!1,!0),Ld(nl),Rd=Od(nl),Ad({target:nl,stat:!0,forced:vl},{reject:function(e){var t=pl(this);return Nd(t.reject,void 0,e),t.promise}}),Ad({target:nl,stat:!0,forced:!0},{resolve:function(e){return qd(this===Rd?cl:this,e)}}),Ad({target:nl,stat:!0,forced:yl},{all:function(e){var t=this,i=pl(t),n=i.resolve,r=i.reject,s=Yd((function(){var i=Md(t.resolve),s=[],o=0,a=1;Bd(e,(function(e){var c=o++,d=!1;a++,Nd(i,t,e).then((function(e){d||(d=!0,s[c]=e,--a||n(s))}),r)})),--a||n(s)}));return s.error&&r(s.value),i.promise},race:function(e){var t=this,i=pl(t),n=i.reject,r=Yd((function(){var r=Md(t.resolve);Bd(e,(function(e){Nd(r,t,e).then(i.resolve,n)}))}));return r.error&&n(r.value),i.promise}});var Ol=T,Nl=Te,Dl=md,kl=bd,xl=Is;wi({target:"Promise",stat:!0},{allSettled:function(e){var t=this,i=Dl.f(t),n=i.resolve,r=i.reject,s=kl((function(){var i=Nl(t.resolve),r=[],s=0,o=1;xl(e,(function(e){var a=s++,c=!1;o++,Ol(i,t,e).then((function(e){c||(c=!0,r[a]={status:"fulfilled",value:e},--o||n(r))}),(function(e){c||(c=!0,r[a]={status:"rejected",reason:e},--o||n(r))}))})),--o||n(r)}));return s.error&&r(s.value),i.promise}});var Ll=Te,Ml=ee,Fl=T,Ul=md,jl=bd,Vl=Is,Bl="No one promise resolved";wi({target:"Promise",stat:!0},{any:function(e){var t=this,i=Ml("AggregateError"),n=Ul.f(t),r=n.resolve,s=n.reject,o=jl((function(){var n=Ll(t.resolve),o=[],a=0,c=1,d=!1;Vl(e,(function(e){var l=a++,h=!1;c++,Fl(n,t,e).then((function(e){h||d||(d=!0,r(e))}),(function(e){h||d||(h=!0,o[l]=e,--c||s(new i(o,Bl)))}))})),--c||s(new i(o,Bl))}));return o.error&&s(o.value),n.promise}});var Hl=Na,Wl=ee,Kl=y,Gl=pc,ql=Ed;wi({target:"Promise",proto:!0,real:!0,forced:!!Hl&&n((function(){Hl.prototype.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=Gl(this,Wl("Promise")),i=Kl(e);return this.then(i?function(i){return ql(t,e()).then((function(){return i}))}:e,i?function(i){return ql(t,e()).then((function(){throw i}))}:e)}});var zl=l,Jl=Ri,Yl=Os,Xl=W,$l=zl("".charAt),Ql=zl("".charCodeAt),Zl=zl("".slice),eh=function(e){return function(t,i){var n,r,s=Yl(Xl(t)),o=Jl(i),a=s.length;return o<0||o>=a?e?"":void 0:(n=Ql(s,o))<55296||n>56319||o+1===a||(r=Ql(s,o+1))<56320||r>57343?e?$l(s,o):n:e?Zl(s,o,o+2):r-56320+(n-55296<<10)+65536}},th={codeAt:eh(!1),charAt:eh(!0)}.charAt,ih=Os,nh=Oo,rh=wa,sh="String Iterator",oh=nh.set,ah=nh.getterFor(sh);rh(String,"String",(function(e){oh(this,{type:sh,string:ih(e),index:0})}),(function(){var e,t=ah(this),i=t.string,n=t.index;return n>=i.length?{value:void 0,done:!0}:(e=th(i,n),t.index+=e.length,{value:e,done:!1})}));var ch=Y.Promise,dh={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},lh=p,hh=Zr,uh=hi,ph=Vr,mh=st("toStringTag");for(var fh in dh){var gh=lh[fh],_h=gh&&gh.prototype;_h&&hh(_h)!==mh&&uh(_h,mh,fh),ph[fh]=ph.Array}var vh=ch,yh=vh;const Eh=sn;function Sh(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[r("min",i)]=n.ideal,t.optional.push(e),e={},e[r("max",i)]=n.ideal,t.optional.push(e)):(e[r("",i)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=n.exact):["min","max"].forEach((e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=n[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const o=t.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||o)){let t;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?t=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let o=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!o&&i.length&&t.includes("back")&&(o=i[i.length-1]),o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),Eh("chrome: "+JSON.stringify(e)),r(e)}))}e.video=n(e.video)}return Eh("chrome: "+JSON.stringify(e)),r(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,n){r(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{n&&n(s(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>yh.reject(s(e))))))}}}function bh(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function wh(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const r=new Event("track");r.track=i.track,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const r=new Event("track");r.track=i,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else tn(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Th(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let r=i.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Ch(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},s=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const n=function(e){i(s(r(e)))};return t.apply(this,[n,e])}return new yh(((e,i)=>{t.apply(this,[function(t){e(s(r(t)))},i])})).then(i,n)}}function Rh(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ln(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),tn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ln(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,n;return this.getSenders().forEach((i=>{i.track===e&&(t?n=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?n=!0:i=t),t.track===e))),n||t&&i?yh.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():yh.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Ih(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function Ah(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Ih(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}function o(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find((e=>e.track===t));if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[i.id];if(s)s.addTrack(t),yh.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new e.MediaStream([t]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=s(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ph(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function Oh(e,t){tn(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var Nh=Object.freeze({__proto__:null,shimMediaStream:bh,shimOnTrack:wh,shimGetSendersWithDtmf:Th,shimGetStats:Ch,shimSenderReceiverGetStats:Rh,shimAddTrackRemoveTrackWithNative:Ih,shimAddTrackRemoveTrack:Ah,shimPeerConnection:Ph,fixNegotiationNeeded:Oh,shimGetUserMedia:Sh,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const n=i.video&&i.video.width,r=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},n&&(i.video.mandatory.maxWidth=n),r&&(i.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function Dh(e,t){const i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){on("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function kh(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function xh(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,s]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,s)}}function Lh(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):yh.resolve(new Map)}}function Mh(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),tn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Fh(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){on("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Uh(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function jh(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(i){const{sender:t}=n,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return n})}function Vh(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Bh(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?yh.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Hh(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?yh.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var Wh=Object.freeze({__proto__:null,shimOnTrack:kh,shimPeerConnection:xh,shimSenderGetStats:Lh,shimReceiverGetStats:Mh,shimRemoveStream:Fh,shimRTCDataChannel:Uh,shimAddTransceiver:jh,shimGetParameters:Vh,shimCreateOffer:Bh,shimCreateAnswer:Hh,shimGetUserMedia:Dh,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,yh.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}});function Kh(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return n&&n.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function Gh(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function qh(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),yh.resolve()):r},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),yh.resolve()):r};let a=function(e,t,i){const n=r.apply(this,[e]);return i?(n.then(t,i),yh.resolve()):n};t.setLocalDescription=a,a=function(e,t,i){const n=s.apply(this,[e]);return i?(n.then(t,i),yh.resolve()):n},t.setRemoteDescription=a,a=function(e,t,i){const n=o.apply(this,[e]);return i?(n.then(t,i),yh.resolve()):n},t.addIceCandidate=a}function zh(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(Jh(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function Jh(e){return e&&void 0!==e.video?Object.assign({},e,{video:dn(e.video)}):e}function Yh(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(on("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Xh(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function $h(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Qh(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var Zh=Object.freeze({__proto__:null,shimLocalStreamsAPI:Kh,shimRemoteStreamsAPI:Gh,shimCallbacksAPI:qh,shimGetUserMedia:zh,shimConstraints:Jh,shimRTCIceServerUrls:Yh,shimTrackEventTransceiver:Xh,shimCreateOfferLegacy:$h,shimAudioContext:Qh}),eu="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",tu=W,iu=Os,nu=l("".replace),ru="[\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff]",su=RegExp("^"+ru+ru+"*"),ou=RegExp(ru+ru+"*$"),au=function(e){return function(t){var i=iu(tu(t));return 1&e&&(i=nu(i,su,"")),2&e&&(i=nu(i,ou,"")),i}},cu={start:au(1),end:au(2),trim:au(3)},du=Mo.PROPER,lu=n,hu=eu,uu=cu.trim;wi({target:"String",proto:!0,forced:function(e){return lu((function(){return!!hu[e]()||"âÂá "!=="âÂá "[e]()||du&&hu[e].name!==e}))}("trim")},{trim:function(){return uu(this)}});var pu=Gi("String").trim,mu=h,fu=pu,gu=String.prototype,_u=function(e){var t=e.trim;return"string"==typeof e||e===gu||mu(gu,e)&&t===gu.trim?fu:t},vu={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return _u(e).call(e).split("\n").map((e=>_u(e).call(e)))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>{var i;return _u(i=t>0?"m="+e:e).call(i)+"\r\n"}))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1];break;case"ufrag":i.ufrag=t[n+1],i.usernameFragment=t[n+1];break;default:void 0===i[t[n]]&&(i[t[n]]=t[n+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){let t=e.substr(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){const t={};let i;const n=e.substr(e.indexOf(" ")+1).split(";");for(let o=0;o<n.length;o++){var r,s;i=_u(r=n[o]).call(r).split("="),t[_u(s=i[0]).call(s)]=i[1]}return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substr(t+1,n-t-1),i.value=e.substr(n+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){const t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){const t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],r=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substr(12),password:r.substr(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");for(let r=3;r<n.length;r++){const s=n[r],o=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){const n=t.parseRtpMap(o),r=t.matchPrefix(e,"a=fmtp:"+s+" ");switch(n.parameters=r.length?t.parseFmtp(r[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){let n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let r=0;return i.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(n+="a=maxptime:"+r+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const i=[],n=t.parseRtpParameters(e),r=-1!==n.fecMechanisms.indexOf("RED"),s=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=o.length>0&&o[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substr(17).split(" ").map((e=>parseInt(e,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),i.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:s?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){const i={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=r.length>0,i.compound=0===r.length;const s=t.matchPrefix(e,"a=rtcp-mux");return i.mux=s.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return i=n[0].substr(7).split(" "),{stream:i[0],track:i[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(i=r[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let r;n.length>0&&(r=parseInt(n[0].substr(19),10)),isNaN(r)&&(r=65536);const s=t.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substr(12),10),protocol:i.fmt,maxMessageSize:r};const o=t.matchPrefix(e,"a=sctpmap:");if(o.length>0){const e=o[0].substr(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,n){let r;const s=void 0!==i?i:2;return r=e||t.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+r+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const n=t.splitLines(e);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},e.exports=t}(vu);var yu=vu.exports,Eu=Object.freeze(e({__proto__:null,default:yu},[vu.exports]));function Su(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),n=yu.parseCandidate(e.candidate),r=Object.assign(i,n);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,tn(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function bu(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||tn(e,"icecandidate",(e=>{if(e.candidate){const t=yu.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function wu(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=yu.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=yu.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},r=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},s=function(e,i){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const r=yu.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?n=parseInt(r[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=n(arguments[0]),t=r(e),i=s(arguments[0],e);let o;o=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return o.apply(this,arguments)}}function Tu(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0],r=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},tn(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function Cu(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function Ru(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==_u(e).call(e))).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function Iu(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?yh.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),yh.resolve())})}function Au(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);const t="offer"===e.type?this.createOffer:this.createAnswer;return t.apply(this).then((e=>i.apply(this,[e])))})}var Pu=Object.freeze({__proto__:null,shimRTCIceCandidate:Su,shimRTCIceCandidateRelayProtocol:bu,shimMaxMessageSize:wu,shimSendThrowTypeError:Tu,shimConnectionState:Cu,removeExtmapAllowMixed:Ru,shimAddIceCandidateNullOrEmpty:Iu,shimParameterlessSetLocalDescription:Au});let Ou,Nu;!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=sn,n=an(e),r={browserDetails:n,commonShim:Pu,extractVersion:en,disableLog:nn,disableWarnings:rn,sdp:Eu};switch(n.browser){case"chrome":if(!Nh||!Ph||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=Nh,Iu(e,n),Au(e),Sh(e,n),bh(e),Ph(e,n),wh(e),Ah(e,n),Th(e),Ch(e),Rh(e),Oh(e,n),Su(e),bu(e),Cu(e),wu(e,n),Tu(e),Ru(e,n);break;case"firefox":if(!Wh||!xh||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=Wh,Iu(e,n),Au(e),Dh(e,n),xh(e,n),kh(e),Fh(e),Lh(e),Mh(e),Uh(e),jh(e),Vh(e),Bh(e),Hh(e),Su(e),Cu(e),wu(e,n),Tu(e);break;case"safari":if(!Zh||!t.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=Zh,Iu(e,n),Au(e),Yh(e),$h(e),qh(e),Kh(e),Gh(e),Xh(e),zh(e),Qh(e),Su(e),bu(e),wu(e,n),Tu(e),Ru(e,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),function(e){e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot"}(Ou||(Ou={})),function(e){e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger"}(Nu||(Nu={}));var Du={exports:{}};!function(e,i){!function(t,n){var r="function",s="undefined",o="object",a="string",c="major",d="model",l="name",h="type",u="vendor",p="version",m="architecture",f="console",g="mobile",_="tablet",v="smarttv",y="wearable",E="embedded",S="Amazon",b="Apple",w="ASUS",T="BlackBerry",C="Firefox",R="Google",I="Huawei",A="LG",P="Microsoft",O="Motorola",N="Opera",D="Samsung",k="Sharp",x="Sony",L="Xiaomi",M="Zebra",F="Facebook",U="Chromium OS",j="Mac OS",V=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},B=function(e,t){return typeof e===a&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},W=function(e,t){if(typeof e===a)return e=e.replace(/^\s\s*/,""),typeof t===s?e:e.substring(0,350)},K=function(e,t){for(var i,s,a,c,d,l,h=0;h<t.length&&!d;){var u=t[h],p=t[h+1];for(i=s=0;i<u.length&&!d&&u[i];)if(d=u[i++].exec(e))for(a=0;a<p.length;a++)l=d[++s],typeof(c=p[a])===o&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,l):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=l?l.replace(c[1],c[2]):n:this[c[0]]=l?c[1].call(this,l,c[2]):n:4===c.length&&(this[c[0]]=l?c[3].call(this,l.replace(c[1],c[2])):n):this[c]=l||n;h+=2}},G=function(e,t){for(var i in t)if(typeof t[i]===o&&t[i].length>0){for(var r=0;r<t[i].length;r++)if(B(t[i][r],e))return"?"===i?n:i}else if(B(t[i],e))return"?"===i?n:i;return e},q={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},z={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,"Opera Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,N]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure Browser"],p],[/\bfocus\/([\w\.]+)/i],[p,[l,"Firefox Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,"Opera Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,"Opera Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI Browser"]],[/fxios\/([-\w\.]+)/i],[p,[l,C]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 Browser"]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 Browser"],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,F],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,"Chrome Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,"Chrome WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,G,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,H]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[u,D],[h,_]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[u,D],[h,g]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[u,b],[h,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[u,b],[h,_]],[/(macintosh);/i],[d,[u,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[u,k],[h,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[u,I],[h,_]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[u,I],[h,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[u,L],[h,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[u,L],[h,_]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[u,"OPPO"],[h,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[u,"Vivo"],[h,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[u,"Realme"],[h,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[u,O],[h,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[u,O],[h,_]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[u,A],[h,_]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[u,A],[h,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[u,"Lenovo"],[h,_]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[u,"Nokia"],[h,g]],[/(pixel c)\b/i],[d,[u,R],[h,_]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[u,R],[h,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[u,x],[h,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[u,x],[h,_]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[u,"OnePlus"],[h,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[u,S],[h,_]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[u,S],[h,g]],[/(playbook);[-\w\),; ]+(rim)/i],[d,u,[h,_]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[u,T],[h,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[u,w],[h,_]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[u,w],[h,g]],[/(nexus 9)/i],[d,[u,"HTC"],[h,_]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[d,/_/g," "],[h,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[u,"Acer"],[h,_]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[u,"Meizu"],[h,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,d,[h,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,d,[h,_]],[/(surface duo)/i],[d,[u,P],[h,_]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[u,"Fairphone"],[h,g]],[/(u304aa)/i],[d,[u,"AT&T"],[h,g]],[/\bsie-(\w*)/i],[d,[u,"Siemens"],[h,g]],[/\b(rct\w+) b/i],[d,[u,"RCA"],[h,_]],[/\b(venue[\d ]{2,7}) b/i],[d,[u,"Dell"],[h,_]],[/\b(q(?:mv|ta)\w+) b/i],[d,[u,"Verizon"],[h,_]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[u,"Barnes & Noble"],[h,_]],[/\b(tm\d{3}\w+) b/i],[d,[u,"NuVision"],[h,_]],[/\b(k88) b/i],[d,[u,"ZTE"],[h,_]],[/\b(nx\d{3}j) b/i],[d,[u,"ZTE"],[h,g]],[/\b(gen\d{3}) b.+49h/i],[d,[u,"Swiss"],[h,g]],[/\b(zur\d{3}) b/i],[d,[u,"Swiss"],[h,_]],[/\b((zeki)?tb.*\b) b/i],[d,[u,"Zeki"],[h,_]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],d,[h,_]],[/\b(ns-?\w{0,9}) b/i],[d,[u,"Insignia"],[h,_]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[u,"NextBook"],[h,_]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],d,[h,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],d,[h,g]],[/\b(ph-1) /i],[d,[u,"Essential"],[h,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[u,"Envizen"],[h,_]],[/\b(trio[-\w\. ]+) b/i],[d,[u,"MachSpeed"],[h,_]],[/\btu_(1491) b/i],[d,[u,"Rotor"],[h,_]],[/(shield[\w ]+) b/i],[d,[u,"Nvidia"],[h,_]],[/(sprint) (\w+)/i],[u,d,[h,g]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[u,P],[h,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[u,M],[h,_]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[u,M],[h,g]],[/smart-tv.+(samsung)/i],[u,[h,v]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[u,D],[h,v]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,A],[h,v]],[/(apple) ?tv/i],[u,[d,"Apple TV"],[h,v]],[/crkey/i],[[d,"Chromecast"],[u,R],[h,v]],[/droid.+aft(\w)( bui|\))/i],[d,[u,S],[h,v]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[u,k],[h,v]],[/(bravia[\w ]+)( bui|\))/i],[d,[u,x],[h,v]],[/(mitv-\w{5}) bui/i],[d,[u,L],[h,v]],[/Hbbtv.*(technisat) (.*);/i],[u,d,[h,v]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,W],[d,W],[h,v]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,v]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,d,[h,f]],[/droid.+; (shield) bui/i],[d,[u,"Nvidia"],[h,f]],[/(playstation [345portablevi]+)/i],[d,[u,x],[h,f]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[u,P],[h,f]],[/((pebble))app/i],[u,d,[h,y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[u,b],[h,y]],[/droid.+; (glass) \d/i],[d,[u,R],[h,y]],[/droid.+; (wt63?0{2,3})\)/i],[d,[u,M],[h,y]],[/(quest( 2| pro)?)/i],[d,[u,F],[h,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[h,E]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[h,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,_]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,_]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,g]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,G,q]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,G,q]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,j],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,T]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,"Chromecast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,U],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},J=function(e,i){if(typeof e===o&&(i=e,e=n),!(this instanceof J))return new J(e,i).getResult();var c=typeof t!==s&&t.navigator?t.navigator:n,d=e||(c&&c.userAgent?c.userAgent:""),l=c&&c.userAgentData?c.userAgentData:n,h=i?function(e,t){var i={};for(var n in e)t[n]&&t[n].length%2==0?i[n]=t[n].concat(e[n]):i[n]=e[n];return i}(z,i):z;return this.getBrowser=function(){var e={};return e.name=n,e.version=n,K.call(e,d,h.browser),e.major=function(e){return typeof e===a?e.replace(/[^\d\.]/g,"").split(".")[0]:n}(e.version),c&&c.brave&&typeof c.brave.isBrave==r&&(e.name="Brave"),e},this.getCPU=function(){var e={};return e.architecture=n,K.call(e,d,h.cpu),e},this.getDevice=function(){var e={};return e.vendor=n,e.model=n,e.type=n,K.call(e,d,h.device),!e.type&&l&&l.mobile&&(e.type=g),"Macintosh"==e.model&&c&&typeof c.standalone!==s&&c.maxTouchPoints&&c.maxTouchPoints>2&&(e.model="iPad",e.type=_),e},this.getEngine=function(){var e={};return e.name=n,e.version=n,K.call(e,d,h.engine),e},this.getOS=function(){var e={};return e.name=n,e.version=n,K.call(e,d,h.os),!e.name&&l&&"Unknown"!=l.platform&&(e.name=l.platform.replace(/chrome os/i,U).replace(/macos/i,j)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return d},this.setUA=function(e){return d=typeof e===a&&e.length>350?W(e,350):e,this},this.setUA(d),this};J.VERSION="0.7.34",J.BROWSER=V([l,p,c]),J.CPU=V([m]),J.DEVICE=V([d,u,h,f,g,v,_,y,E]),J.ENGINE=J.OS=V([l,p]),e.exports&&(i=e.exports=J),i.UAParser=J;var Y=typeof t!==s&&(t.jQuery||t.Zepto);if(Y&&!Y.ua){var X=new J;Y.ua=X.getResult(),Y.ua.get=function(){return X.getUA()},Y.ua.set=function(e){X.setUA(e);var t=X.getResult();for(var i in t)Y.ua[i]=t[i]}}}("object"==typeof window?window:t)}(Du,Du.exports);const ku=new(0,Du.exports);let xu,Lu=ku.getResult();function Mu(e){return e&&ku.setUA(e),Lu=ku.getResult(),{name:Fu(Lu),version:Uu(Lu),os:ju(Lu),osVersion:Lu.os.version}}function Fu(e){if("Blink"===e.engine.name&&"WeChat"!==e.browser.name)return Nu.CHROME;switch(e.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Nu.CHROME;case"Safari":case"Mobile Safari":return Nu.SAFARI;case"Edge":return Nu.EDGE;case"Firefox":return Nu.FIREFOX;case"QQBrowser":return Nu.QQ;case"Opera":return Nu.OPERA;case"WeChat":return Nu.WECHAT;default:return e.browser.name||""}}function Uu(e){let t;return t="Blink"===e.engine.name?e.engine.version||"":e.browser.version||"",t.split(".")[0]}function ju(e){switch(e.os.name){case"Windows":return e.os.version?e.os.name+" "+e.os.version:e.os.name;default:return e.os.name||""}}function Vu(){const e=Mu();return!!("WebKit"===Lu.engine.name&&e.os===Ou.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==Nu.SAFARI||qu()&&e.name!==Nu.SAFARI)}function Bu(){const e=Mu();if(Vu()){if(e.os===Ou.MAC_OS)return!0;if(e.os===Ou.IOS){const e=Lu.os.version&&Lu.os.version.split(".");if(e&&14===Number(e[0])&&e[1]&&Number(e[1])>=3)return!0;if(e&&Number(e[0])>14)return!0}}return!1}function Hu(){return"WebKit"===Lu.engine.name}function Wu(){return Mu().name===Nu.CHROME}function Ku(){return Mu().name===Nu.SAFARI}function Gu(){return Mu().name===Nu.FIREFOX}function qu(){return Mu().os===Ou.IOS}function zu(e){const t=Mu();return!(t.name!==Nu.CHROME||!t.osVersion)&&Number(t.version)>=e}function Ju(e){const t=Mu();return!(t.name!==Nu.EDGE||!t.osVersion)&&Number(t.version)>=e}function Yu(e){const t=Mu();return!(t.name!==Nu.OPERA||!t.osVersion)&&Number(t.version)>=e}function Xu(){const e=Mu();return!(e.name!==Nu.CHROME||!e.osVersion)&&Number(e.version)<=90}function $u(){const e=Mu();if(e.os!==Ou.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||14===Number(t[0])&&Number(t[1])<=6}function Qu(){const e=Mu();if(e.os!==Ou.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])}function Zu(){const e=Mu();if(e.os!==Ou.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&0===Number(t[1])}function ep(){const e=Mu();if(e.os!==Ou.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=1}function tp(){const e=Mu();if(e.os!==Ou.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=2}function ip(){return Ku()&&navigator.maxTouchPoints>0}function np(){return Mu().name===Nu.WECHAT}function rp(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function sp(){const e=Mu();return e.name!==Nu.EDGE&&e.name!==Nu.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function op(){return Mu().os===Ou.ANDROID}function ap(){const e=Mu();return"Android"===e.os&&("Chrome"===e.name||e.name===Nu.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}!function(e){e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver"}(xu||(xu={}));var cp={exports:{}},dp=wi,lp=S,hp=Gt.f;dp({target:"Object",stat:!0,forced:Object.defineProperty!==hp,sham:!lp},{defineProperty:hp});var up=Y.Object,pp=cp.exports=function(e,t,i){return up.defineProperty(e,t,i)};up.defineProperty.sham&&(pp.sham=!0);var mp=cp.exports;function fp(e,t,i){return t in e?mp(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var gp,_p={exports:{}},vp=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}},yp=vp,Ep=Object.prototype.toString,Sp=(gp=Object.create(null),function(e){var t=Ep.call(e);return gp[t]||(gp[t]=t.slice(8,-1).toLowerCase())});function bp(e){return e=e.toLowerCase(),function(t){return Sp(t)===e}}function wp(e){return Array.isArray(e)}function Tp(e){return void 0===e}var Cp=bp("ArrayBuffer");function Rp(e){return null!==e&&"object"==typeof e}function Ip(e){if("object"!==Sp(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}var Ap=bp("Date"),Pp=bp("File"),Op=bp("Blob"),Np=bp("FileList");function Dp(e){return"[object Function]"===Ep.call(e)}var kp=bp("URLSearchParams");function xp(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),wp(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)}var Lp,Mp=(Lp="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(e){return Lp&&e instanceof Lp}),Fp={isArray:wp,isArrayBuffer:Cp,isBuffer:function(e){return null!==e&&!Tp(e)&&null!==e.constructor&&!Tp(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){var t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||Ep.call(e)===t||Dp(e.toString)&&e.toString()===t)},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Cp(e.buffer)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:Rp,isPlainObject:Ip,isUndefined:Tp,isDate:Ap,isFile:Pp,isBlob:Op,isFunction:Dp,isStream:function(e){return Rp(e)&&Dp(e.pipe)},isURLSearchParams:kp,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:xp,merge:function e(){var t={};function i(i,n){Ip(t[n])&&Ip(i)?t[n]=e(t[n],i):Ip(i)?t[n]=e({},i):wp(i)?t[n]=i.slice():t[n]=i}for(var n=0,r=arguments.length;n<r;n++)xp(arguments[n],i);return t},extend:function(e,t,i){return xp(t,(function(t,n){e[n]=i&&"function"==typeof t?yp(t,i):t})),e},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e},inherits:function(e,t,i,n){e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,i&&Object.assign(e.prototype,i)},toFlatObject:function(e,t,i){var n,r,s,o={};t=t||{};do{for(r=(n=Object.getOwnPropertyNames(e)).length;r-- >0;)o[s=n[r]]||(t[s]=e[s],o[s]=!0);e=Object.getPrototypeOf(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:Sp,kindOfTest:bp,endsWith:function(e,t,i){e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;var n=e.indexOf(t,i);return-1!==n&&n===i},toArray:function(e){if(!e)return null;var t=e.length;if(Tp(t))return null;for(var i=new Array(t);t-- >0;)i[t]=e[t];return i},isTypedArray:Mp,isFileList:Np},Up=Fp;function jp(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Vp=function(e,t,i){if(!t)return e;var n;if(i)n=i(t);else if(Up.isURLSearchParams(t))n=t.toString();else{var r=[];Up.forEach(t,(function(e,t){null!=e&&(Up.isArray(e)?t+="[]":e=[e],Up.forEach(e,(function(e){Up.isDate(e)?e=e.toISOString():Up.isObject(e)&&(e=JSON.stringify(e)),r.push(jp(t)+"="+jp(e))})))})),n=r.join("&")}if(n){var s=e.indexOf("#");-1!==s&&(e=e.slice(0,s)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e},Bp=Fp;function Hp(){this.handlers=[]}Hp.prototype.use=function(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},Hp.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},Hp.prototype.forEach=function(e){Bp.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var Wp=Hp,Kp=Fp,Gp=Fp;function qp(e,t,i,n,r){Error.call(this),this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r)}Gp.inherits(qp,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var zp=qp.prototype,Jp={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(e){Jp[e]={value:e}})),Object.defineProperties(qp,Jp),Object.defineProperty(zp,"isAxiosError",{value:!0}),qp.from=function(e,t,i,n,r,s){var o=Object.create(zp);return Gp.toFlatObject(e,o,(function(e){return e!==Error.prototype})),qp.call(o,e.message,t,i,n,r),o.name=e.name,s&&Object.assign(o,s),o};var Yp=qp,Xp={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},$p=Fp,Qp=function(e,t){t=t||new FormData;var i=[];function n(e){return null===e?"":$p.isDate(e)?e.toISOString():$p.isArrayBuffer(e)||$p.isTypedArray(e)?"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}return function e(r,s){if($p.isPlainObject(r)||$p.isArray(r)){if(-1!==i.indexOf(r))throw Error("Circular reference detected in "+s);i.push(r),$p.forEach(r,(function(i,r){if(!$p.isUndefined(i)){var o,a=s?s+"."+r:r;if(i&&!s&&"object"==typeof i)if($p.endsWith(r,"{}"))i=JSON.stringify(i);else if($p.endsWith(r,"[]")&&(o=$p.toArray(i)))return void o.forEach((function(e){!$p.isUndefined(e)&&t.append(a,n(e))}));e(i,a)}})),i.pop()}else t.append(s,n(r))}(e),t},Zp=Yp,em=Fp,tm=em.isStandardBrowserEnv()?{write:function(e,t,i,n,r,s){var o=[];o.push(e+"="+encodeURIComponent(t)),em.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),em.isString(n)&&o.push("path="+n),em.isString(r)&&o.push("domain="+r),!0===s&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},im=function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)},nm=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e},rm=function(e,t){return e&&!im(t)?nm(e,t):t},sm=Fp,om=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],am=Fp,cm=am.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(e){var n=e;return t&&(i.setAttribute("href",n),n=i.href),i.setAttribute("href",n),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=n(window.location.href),function(t){var i=am.isString(t)?n(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0},dm=Yp;function lm(e){dm.call(this,null==e?"canceled":e,dm.ERR_CANCELED),this.name="CanceledError"}Fp.inherits(lm,dm,{__CANCEL__:!0});var hm=lm,um=Fp,pm=function(e,t,i){var n=i.config.validateStatus;i.status&&n&&!n(i.status)?t(new Zp("Request failed with status code "+i.status,[Zp.ERR_BAD_REQUEST,Zp.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)},mm=tm,fm=Vp,gm=rm,_m=function(e){var t,i,n,r={};return e?(sm.forEach(e.split("\n"),(function(e){if(n=e.indexOf(":"),t=sm.trim(e.substr(0,n)).toLowerCase(),i=sm.trim(e.substr(n+1)),t){if(r[t]&&om.indexOf(t)>=0)return;r[t]="set-cookie"===t?(r[t]?r[t]:[]).concat([i]):r[t]?r[t]+", "+i:i}})),r):r},vm=cm,ym=Xp,Em=Yp,Sm=hm,bm=function(e){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""},wm=function(e){return new Promise((function(t,i){var n,r=e.data,s=e.headers,o=e.responseType;function a(){e.cancelToken&&e.cancelToken.unsubscribe(n),e.signal&&e.signal.removeEventListener("abort",n)}um.isFormData(r)&&um.isStandardBrowserEnv()&&delete s["Content-Type"];var c=new XMLHttpRequest;if(e.auth){var d=e.auth.username||"",l=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";s.Authorization="Basic "+btoa(d+":"+l)}var h=gm(e.baseURL,e.url);function u(){if(c){var n="getAllResponseHeaders"in c?_m(c.getAllResponseHeaders()):null,r={data:o&&"text"!==o&&"json"!==o?c.response:c.responseText,status:c.status,statusText:c.statusText,headers:n,config:e,request:c};pm((function(e){t(e),a()}),(function(e){i(e),a()}),r),c=null}}if(c.open(e.method.toUpperCase(),fm(h,e.params,e.paramsSerializer),!0),c.timeout=e.timeout,"onloadend"in c?c.onloadend=u:c.onreadystatechange=function(){c&&4===c.readyState&&(0!==c.status||c.responseURL&&0===c.responseURL.indexOf("file:"))&&setTimeout(u)},c.onabort=function(){c&&(i(new Em("Request aborted",Em.ECONNABORTED,e,c)),c=null)},c.onerror=function(){i(new Em("Network Error",Em.ERR_NETWORK,e,c,c)),c=null},c.ontimeout=function(){var t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",n=e.transitional||ym;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(new Em(t,n.clarifyTimeoutError?Em.ETIMEDOUT:Em.ECONNABORTED,e,c)),c=null},um.isStandardBrowserEnv()){var p=(e.withCredentials||vm(h))&&e.xsrfCookieName?mm.read(e.xsrfCookieName):void 0;p&&(s[e.xsrfHeaderName]=p)}"setRequestHeader"in c&&um.forEach(s,(function(e,t){void 0===r&&"content-type"===t.toLowerCase()?delete s[t]:c.setRequestHeader(t,e)})),um.isUndefined(e.withCredentials)||(c.withCredentials=!!e.withCredentials),o&&"json"!==o&&(c.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&c.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&c.upload&&c.upload.addEventListener("progress",e.onUploadProgress),(e.cancelToken||e.signal)&&(n=function(e){c&&(i(!e||e&&e.type?new Sm:e),c.abort(),c=null)},e.cancelToken&&e.cancelToken.subscribe(n),e.signal&&(e.signal.aborted?n():e.signal.addEventListener("abort",n))),r||(r=null);var m=bm(h);m&&-1===["http","https","file"].indexOf(m)?i(new Em("Unsupported protocol "+m+":",Em.ERR_BAD_REQUEST,e)):c.send(r)}))},Tm=Fp,Cm=function(e,t){Kp.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))},Rm=Yp,Im=Qp,Am={"Content-Type":"application/x-www-form-urlencoded"};function Pm(e,t){!Tm.isUndefined(e)&&Tm.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var Om,Nm={transitional:Xp,adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(Om=wm),Om),transformRequest:[function(e,t){if(Cm(t,"Accept"),Cm(t,"Content-Type"),Tm.isFormData(e)||Tm.isArrayBuffer(e)||Tm.isBuffer(e)||Tm.isStream(e)||Tm.isFile(e)||Tm.isBlob(e))return e;if(Tm.isArrayBufferView(e))return e.buffer;if(Tm.isURLSearchParams(e))return Pm(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString();var i,n=Tm.isObject(e),r=t&&t["Content-Type"];if((i=Tm.isFileList(e))||n&&"multipart/form-data"===r){var s=this.env&&this.env.FormData;return Im(i?{"files[]":e}:e,s&&new s)}return n||"application/json"===r?(Pm(t,"application/json"),function(e,t,i){if(Tm.isString(e))try{return(t||JSON.parse)(e),Tm.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(i||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){var t=this.transitional||Nm.transitional,i=t&&t.silentJSONParsing,n=t&&t.forcedJSONParsing,r=!i&&"json"===this.responseType;if(r||n&&Tm.isString(e)&&e.length)try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw Rm.from(e,Rm.ERR_BAD_RESPONSE,this,null,this.response);throw e}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:null},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};Tm.forEach(["delete","get","head"],(function(e){Nm.headers[e]={}})),Tm.forEach(["post","put","patch"],(function(e){Nm.headers[e]=Tm.merge(Am)}));var Dm=Nm,km=Fp,xm=Dm,Lm=function(e){return!(!e||!e.__CANCEL__)},Mm=Fp,Fm=function(e,t,i){var n=this||xm;return km.forEach(i,(function(i){e=i.call(n,e,t)})),e},Um=Lm,jm=Dm,Vm=hm;function Bm(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Vm}var Hm=Fp,Wm=function(e,t){t=t||{};var i={};function n(e,t){return Hm.isPlainObject(e)&&Hm.isPlainObject(t)?Hm.merge(e,t):Hm.isPlainObject(t)?Hm.merge({},t):Hm.isArray(t)?t.slice():t}function r(i){return Hm.isUndefined(t[i])?Hm.isUndefined(e[i])?void 0:n(void 0,e[i]):n(e[i],t[i])}function s(e){if(!Hm.isUndefined(t[e]))return n(void 0,t[e])}function o(i){return Hm.isUndefined(t[i])?Hm.isUndefined(e[i])?void 0:n(void 0,e[i]):n(void 0,t[i])}function a(i){return i in t?n(e[i],t[i]):i in e?n(void 0,e[i]):void 0}var c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a};return Hm.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=c[e]||r,n=t(e);Hm.isUndefined(n)&&t!==a||(i[e]=n)})),i},Km="0.27.2",Gm=Km,qm=Yp,zm={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){zm[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));var Jm={};zm.transitional=function(e,t,i){function n(e,t){return"[Axios v"+Gm+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return function(i,r,s){if(!1===e)throw new qm(n(r," has been removed"+(t?" in "+t:"")),qm.ERR_DEPRECATED);return t&&!Jm[r]&&(Jm[r]=!0,console.warn(n(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,r,s)}};var Ym=Fp,Xm=Vp,$m=Wp,Qm=function(e){return Bm(e),e.headers=e.headers||{},e.data=Fm.call(e,e.data,e.headers,e.transformRequest),e.headers=Mm.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),Mm.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||jm.adapter)(e).then((function(t){return Bm(e),t.data=Fm.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return Um(t)||(Bm(e),t&&t.response&&(t.response.data=Fm.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},Zm=Wm,ef=rm,tf={assertOptions:function(e,t,i){if("object"!=typeof e)throw new qm("options must be an object",qm.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(e),r=n.length;r-- >0;){var s=n[r],o=t[s];if(o){var a=e[s],c=void 0===a||o(a,s,e);if(!0!==c)throw new qm("option "+s+" must be "+c,qm.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new qm("Unknown option "+s,qm.ERR_BAD_OPTION)}},validators:zm},nf=tf.validators;function rf(e){this.defaults=e,this.interceptors={request:new $m,response:new $m}}rf.prototype.request=function(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},(t=Zm(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var i=t.transitional;void 0!==i&&tf.assertOptions(i,{silentJSONParsing:nf.transitional(nf.boolean),forcedJSONParsing:nf.transitional(nf.boolean),clarifyTimeoutError:nf.transitional(nf.boolean)},!1);var n=[],r=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(r=r&&e.synchronous,n.unshift(e.fulfilled,e.rejected))}));var s,o=[];if(this.interceptors.response.forEach((function(e){o.push(e.fulfilled,e.rejected)})),!r){var a=[Qm,void 0];for(Array.prototype.unshift.apply(a,n),a=a.concat(o),s=Promise.resolve(t);a.length;)s=s.then(a.shift(),a.shift());return s}for(var c=t;n.length;){var d=n.shift(),l=n.shift();try{c=d(c)}catch(e){l(e);break}}try{s=Qm(c)}catch(e){return Promise.reject(e)}for(;o.length;)s=s.then(o.shift(),o.shift());return s},rf.prototype.getUri=function(e){e=Zm(this.defaults,e);var t=ef(e.baseURL,e.url);return Xm(t,e.params,e.paramsSerializer)},Ym.forEach(["delete","get","head","options"],(function(e){rf.prototype[e]=function(t,i){return this.request(Zm(i||{},{method:e,url:t,data:(i||{}).data}))}})),Ym.forEach(["post","put","patch"],(function(e){function t(t){return function(i,n,r){return this.request(Zm(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}rf.prototype[e]=t(),rf.prototype[e+"Form"]=t(!0)}));var sf=rf,of=hm;function af(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;this.promise.then((function(e){if(i._listeners){var t,n=i._listeners.length;for(t=0;t<n;t++)i._listeners[t](e);i._listeners=null}})),this.promise.then=function(e){var t,n=new Promise((function(e){i.subscribe(e),t=e})).then(e);return n.cancel=function(){i.unsubscribe(t)},n},e((function(e){i.reason||(i.reason=new of(e),t(i.reason))}))}af.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},af.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},af.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},af.source=function(){var e;return{token:new af((function(t){e=t})),cancel:e}};var cf=af,df=Fp,lf=Fp,hf=vp,uf=sf,pf=Wm,mf=function e(t){var i=new uf(t),n=hf(uf.prototype.request,i);return lf.extend(n,uf.prototype,i),lf.extend(n,i),n.create=function(i){return e(pf(t,i))},n}(Dm);mf.Axios=uf,mf.CanceledError=hm,mf.CancelToken=cf,mf.isCancel=Lm,mf.VERSION=Km,mf.toFormData=Qp,mf.AxiosError=Yp,mf.Cancel=mf.CanceledError,mf.all=function(e){return Promise.all(e)},mf.spread=function(e){return function(t){return e.apply(null,t)}},mf.isAxiosError=function(e){return df.isObject(e)&&!0===e.isAxiosError},_p.exports=mf,_p.exports.default=mf;var ff=_p.exports;class gf{constructor(e){fp(this,"logger",void 0),fp(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}class _f{constructor(){fp(this,"_events",{}),fp(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map((e=>e.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const i=this._events[e],n=this._indexOfListener(i,t);-1!==n&&i.splice(n,1),0===this._events[e].length&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((e=>e));for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(let s=0;s<t.length;s+=1){const i=t[s];i.once&&this.off(e,i.listener),i.listener.apply(this,n||[])}}_indexOfListener(e,t){let i=e.length;for(;i--;)if(e[i].listener===t)return i;return-1}}const vf=new class extends _f{reportLogUploadError(e){this.emit("REPORT_LOG_UPLOAD",e)}};let yf;!function(e){e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION"}(yf||(yf={}));class Ef extends Error{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(t),fp(this,"code",void 0),fp(this,"message",void 0),fp(this,"data",void 0),fp(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return"error"===e&&Pf.error(this.toString()),"warning"===e&&Pf.warning(this.toString()),this}throw(){throw this.print(),this}}const Sf={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function bf(e,t){const i=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,i)}function wf(e,t,i,n){const r=Object.assign({},Sf,n);let s=r.timeout;const o=async()=>{await function(e){return new yh((t=>{window.setTimeout(t,e)}))}(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new yh((async(n,s)=>{t=t||(()=>!1),i=i||(()=>!0);for(let c=0;c<r.maxRetryCount;c+=1){if(a)return s(new Ef(yf.OPERATION_ABORTED));try{const i=await e();if(!t(i,c))return n(i);if(c+1===r.maxRetryCount)return n(i);await o()}catch(e){if(!i(e,c))return s(e);if(c+1===r.maxRetryCount)return s(e);await o()}}}));return c.cancel=()=>a=!0,c}function Tf(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function Cf(){const e=new Date,t=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return t?(null==t?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const Rf={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},If=Date.now(),Af=e=>{for(const t in Rf)if(Object.prototype.hasOwnProperty.call(Rf,t)&&Rf[t]===e)return t;return"DEFAULT"},Pf=new class{constructor(){fp(this,"proxyServerURL",void 0),fp(this,"logLevel",Rf.DEBUG),fp(this,"uploadState","collecting"),fp(this,"uploadLogWaitingList",[]),fp(this,"uploadLogUploadingList",[]),fp(this,"uploadErrorCount",0),fp(this,"currentLogID",0),fp(this,"url",void 0),fp(this,"extLog",((e,t)=>{this.appendLogToWaitingList(e,...t)}))}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[Rf.DEBUG].concat(t);this.log.apply(this,n)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[Rf.INFO].concat(t);this.log.apply(this,n)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[Rf.WARNING].concat(t);this.log.apply(this,n)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[Rf.ERROR].concat(t);this.log.apply(this,n)}upload(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[Rf.DEBUG].concat(t);this.uploadLog.apply(this,n)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){Wf("UPLOAD_LOG",!0)}disableLogUpload(){Wf("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new gf(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-If<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-If);const n=Math.max(0,Math.min(4,t[0]));if(t[0]=Tf()+" Agora-SDK [".concat(Af(n),"]:"),this.appendLogToWaitingList(n,...t),n<this.logLevel)return;const r=Tf()+" %cAgora-SDK [".concat(Af(n),"]:");let s=[];if(!Kf("USE_NEW_LOG"))switch(n){case Rf.DEBUG:s=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,s);break;case Rf.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,s);break;case Rf.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,s);break;case Rf.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-If<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-If);const n=Math.max(0,Math.min(4,t[0]));t[0]=Tf()+" Agora-SDK [".concat(Af(n),"]:"),this.appendLogToWaitingList(n,...t)}appendLogToWaitingList(e){if(!Kf("UPLOAD_LOG"))return;for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=Cf()+" Agora-SDK [".concat(Af(e),"]:"):i[0]=Cf()+" Agora-SDK [".concat(Af(e),"]:");let r="";i.forEach((e=>{"object"==typeof e&&(e=JSON.stringify(e)),r+="".concat(e," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:Nf,process_id:Kf("PROCESS_ID"),payload:JSON.stringify(e)};return wf((async()=>{const e=await ff.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Kf("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Kf("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if("OK"!==e.data){const t=new Error("unexpected upload log response");throw t.response=e,t}}),(()=>(this.uploadLogUploadingList=[],!1)),(e=>(e.response?vf.reportLogUploadError({status:e.response.status,data:e.response.data,headers:e.response.headers,message:e.message}):e.request?vf.reportLogUploadError({status:e.request.status,message:e.message}):vf.reportLogUploadError({status:-1,message:e.message}),!0)),{timeout:Kf("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Kf("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Kf("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),Kf("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),Kf("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),Kf("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}},Of="v4.17.2-0-gb960eec4-dirty(4/20/2023, 10:39:51 AM)",Nf=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const e=t[1],i=t[2];return"".concat(e,".").concat(i)}const i=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const e=i[1],t=i[2];return"".concat(e,".").concat(100*(Number(t)+1))}return"4.0.0.999"}("4.17.2"),Df=function(){try{return!0===JSON.parse("true")}catch(e){return!0}}(),kf=["CHINA","GLOBAL"],xf=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[e]=n,o[t]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=xf;const Lf={"90p":Jf(160,90),"90p_1":Jf(160,90),"120p":Jf(160,120,15,30,65),"120p_1":Jf(160,120,15,30,65),"120p_3":Jf(120,120,15,30,50),"120p_4":Jf(212,120),"180p":Jf(320,180,15,30,140),"180p_1":Jf(320,180,15,30,140),"180p_3":Jf(180,180,15,30,100),"180p_4":Jf(240,180,15,30,120),"240p":Jf(320,240,15,40,200),"240p_1":Jf(320,240,15,40,200),"240p_3":Jf(240,240,15,40,140),"240p_4":Jf(424,240,15,40,220),"360p":Jf(640,360,15,80,400),"360p_1":Jf(640,360,15,80,400),"360p_3":Jf(360,360,15,80,260),"360p_4":Jf(640,360,30,80,600),"360p_6":Jf(360,360,30,80,400),"360p_7":Jf(480,360,15,80,320),"360p_8":Jf(480,360,30,80,490),"360p_9":Jf(640,360,15,80,800),"360p_10":Jf(640,360,24,80,800),"360p_11":Jf(640,360,24,80,1e3),"480p":Jf(640,480,15,100,500),"480p_1":Jf(640,480,15,100,500),"480p_2":Jf(640,480,30,100,1e3),"480p_3":Jf(480,480,15,100,400),"480p_4":Jf(640,480,30,100,750),"480p_6":Jf(480,480,30,100,600),"480p_8":Jf(848,480,15,100,610),"480p_9":Jf(848,480,30,100,930),"480p_10":Jf(640,480,10,100,400),"720p":Jf(1280,720,15,120,1130),"720p_1":Jf(1280,720,15,120,1130),"720p_2":Jf(1280,720,30,120,2e3),"720p_3":Jf(1280,720,30,120,1710),"720p_5":Jf(960,720,15,120,910),"720p_6":Jf(960,720,30,120,1380),"1080p":Jf(1920,1080,15,120,2080),"1080p_1":Jf(1920,1080,15,120,2080),"1080p_2":Jf(1920,1080,30,120,3e3),"1080p_3":Jf(1920,1080,30,120,3150),"1080p_5":Jf(1920,1080,60,120,4780),"1440p":Jf(2560,1440,30,120,4850),"1440p_1":Jf(2560,1440,30,120,4850),"1440p_2":Jf(2560,1440,60,120,7350),"4k":Jf(3840,2160,30,120,8910),"4k_1":Jf(3840,2160,30,120,8910),"4k_3":Jf(3840,2160,60,120,13500)},Mf={"480p":Yf(640,480,5),"480p_1":Yf(640,480,5),"480p_2":Yf(640,480,30),"480p_3":Yf(640,480,15),"720p":Yf(1280,720,5),"720p_1":Yf(1280,720,5),"720p_2":Yf(1280,720,30),"720p_3":Yf(1280,720,15),"1080p":Yf(1920,1080,5),"1080p_1":Yf(1920,1080,5),"1080p_2":Yf(1920,1080,30),"1080p_3":Yf(1920,1080,15)},Ff={"1SL1TL":Xf(1,1),"3SL3TL":Xf(3,3),"2SL3TL":Xf(2,3)};function Uf(e){return e||(e="480p_1"),"string"==typeof e?Object.assign({},Lf[e]):e}function jf(e){return"string"==typeof e?Object.assign({},Mf[e]):e}function Vf(e){return"string"==typeof e?Object.assign({},Ff[e]):e}const Bf={speech_low_quality:zf(16e3,!1),speech_standard:zf(32e3,!1,18),music_standard:zf(48e3,!1),standard_stereo:zf(48e3,!0,56),high_quality:zf(48e3,!1,128),high_quality_stereo:zf(48e3,!0,192)};function Hf(e){return"string"==typeof e?Object.assign({},Bf[e]):e}function Wf(e,t,i){Object.keys(Gf).includes(e)&&(!i&&Object.keys(qf).includes(e)||(Gf[e]=t))}function Kf(e){return Gf[e]}const Gf={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:kf,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION:2e3,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0}},qf={};function zf(e,t,i){return{sampleRate:e,stereo:t,bitrate:i}}function Jf(e,t,i,n,r){return{width:e,height:t,frameRate:i,bitrateMin:n,bitrateMax:r}}function Yf(e,t,i,n,r){return{width:{max:e},height:{max:t},frameRate:i,bitrateMin:n,bitrateMax:r}}function Xf(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}Df||(Gf.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Gf.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Gf.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Gf.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Gf.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Gf.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Gf.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Gf.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Gf.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Gf.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Gf.AREAS=["NORTH_AMERICA","OVERSEA"]);const $f=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Qf=[],Zf=[];function eg(e,t){return!!t&&Qf.some((i=>i.uid===e&&i.channelName===t))}var tg=gt,ig=Gt,ng=N,rg=function(e,t,i){var n=tg(t);n in e?ig.f(e,n,ng(0,i)):e[n]=i},sg=Fn,og=Oi,ag=rg,cg=p.Array,dg=Math.max,lg=function(e,t,i){for(var n=og(e),r=sg(t,n),s=sg(void 0===i?n:i,n),o=cg(dg(s-r,0)),a=0;r<s;r++,a++)ag(o,a,e[r]);return o.length=a,o},hg=lg,ug=Math.floor,pg=function(e,t){var i=e.length,n=ug(i/2);return i<8?mg(e,t):fg(e,pg(hg(e,0,n),t),pg(hg(e,n),t),t)},mg=function(e,t){for(var i,n,r=e.length,s=1;s<r;){for(n=s,i=e[s];n&&t(e[n-1],i)>0;)e[n]=e[--n];n!==s++&&(e[n]=i)}return e},fg=function(e,t,i,n){for(var r=t.length,s=i.length,o=0,a=0;o<r||a<s;)e[o+a]=o<r&&a<s?n(t[o],i[a])<=0?t[o++]:i[a++]:o<r?t[o++]:i[a++];return e},gg=pg,_g=te.match(/firefox\/(\d+)/i),vg=!!_g&&+_g[1],yg=/MSIE|Trident/.test(te),Eg=te.match(/AppleWebKit\/(\d+)\./),Sg=!!Eg&&+Eg[1],bg=wi,wg=l,Tg=Te,Cg=Ve,Rg=Oi,Ig=Os,Ag=n,Pg=gg,Og=ji,Ng=vg,Dg=yg,kg=ce,xg=Sg,Lg=[],Mg=wg(Lg.sort),Fg=wg(Lg.push),Ug=Ag((function(){Lg.sort(void 0)})),jg=Ag((function(){Lg.sort(null)})),Vg=Og("sort"),Bg=!Ag((function(){if(kg)return kg<70;if(!(Ng&&Ng>3)){if(Dg)return!0;if(xg)return xg<603;var e,t,i,n,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)Lg.push({k:t+n,v:i})}for(Lg.sort((function(e,t){return t.v-e.v})),n=0;n<Lg.length;n++)t=Lg[n].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return"DGBEFHACIJK"!==r}}));bg({target:"Array",proto:!0,forced:Ug||!jg||!Vg||!Bg},{sort:function(e){void 0!==e&&Tg(e);var t=Cg(this);if(Bg)return void 0===e?Mg(t):Mg(t,e);var i,n,r=[],s=Rg(t);for(n=0;n<s;n++)n in t&&Fg(r,t[n]);for(Pg(r,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:Ig(t)>Ig(i)?1:-1}}(e)),i=r.length,n=0;n<i;)t[n]=r[n++];for(;n<s;)delete t[n++];return t}});var Hg=Gi("Array").sort,Wg=h,Kg=Hg,Gg=Array.prototype,qg=function(e){var t=e.sort;return e===Gg||Wg(Gg,e)&&t===Gg.sort?Kg:t};function zg(e,t){if("boolean"!=typeof e)throw new Ef(yf.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Jg(e,t,i){if(!i.includes(e))throw new Ef(yf.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(i)))}function Yg(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(e<i||e>n||r&&!n_(e))throw new Ef(yf.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function Xg(e,t){if("number"!=typeof e){if(!(e.min||e.max||e.ideal||e.exact))throw new Ef(yf.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));void 0!==e.min&&Yg(e.min,"".concat(t,".min"),0,1/0),void 0!==e.max&&Yg(e.max,"".concat(t,".max"),1,1/0),void 0!==e.exact&&Yg(e.exact,"".concat(t,".exact"),1,1/0),void 0!==e.ideal&&Yg(e.ideal,"".concat(t,".ideal"),1,1/0)}else Yg(e,t,1,1/0)}function $g(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==e)throw new Ef(yf.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!i_(e,i,n,r))throw new Ef(yf.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(r?" ASCII characters only.":""))}function Qg(e,t){if(!Array.isArray(e))throw new Ef(yf.INVALID_PARAMS,"".concat(t," should be an array"))}function Zg(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw Pf.error("Invalid Channel Name ".concat(e)),new Ef(yf.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function e_(e){if(t=e,!("number"==typeof t&&Math.floor(t)===t&&0<=t&&t<=4294967295||i_(e,1,255)))throw Pf.error("Invalid UID ".concat(e," ").concat(typeof e)),new Ef(yf.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;"string"==typeof e&&Pf.warning("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}function t_(e){return null==e}function i_(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof e&&e.length<=i&&e.length>=t&&(!n||r_(e))}function n_(e){return"number"==typeof e&&e%1==0}function r_(e){if("string"!=typeof e)return!1;for(let t=0;t<e.length;t+=1){const i=e.charCodeAt(t);if(i<0||i>255)return!1}return!0}let s_,o_,a_;!function(e){e.FREE="free",e.UPLOADING="uploading"}(s_||(s_={})),function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}(o_||(o_={})),function(e){e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata"}(a_||(a_={}));const c_={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};function d_(e){return $g(e.reportId,"params.reportId",0,100,!1),$g(e.category,"params.category",0,100,!1),$g(e.event,"params.event",0,100,!1),$g(e.label,"params.label",0,100,!1),Yg(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const l_={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let h_,u_,p_,m_,f_,g_,__,v_,y_,E_,S_,b_,w_,T_,C_,R_,I_,A_,P_,O_,N_,D_,k_,x_;function L_(e){return Yg(e.timeout,"config.timeout",0,1e5),Yg(e.timeoutFactor,"config.timeoutFactor",0,100,!1),Yg(e.maxRetryCount,"config.maxRetryConfig",0,1/0),Yg(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function M_(e){return Jg(e.codec,"config.codec",["vp8","vp9","av1","h264"]),Jg(e.mode,"config.mode",["rtc","live"]),void 0!==e.audioCodec&&Jg(e.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==e.proxyServer&&$g(e.proxyServer,"config.proxyServer",1,1e4),void 0!==e.turnServer&&U_(e.turnServer),void 0!==e.httpRetryConfig&&L_(e.httpRetryConfig),void 0!==e.websocketRetryConfig&&L_(e.websocketRetryConfig),!0}function F_(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((e=>{if(!e.urls)throw Error()}))}catch(e){return!1}return!0}function U_(e){return $g(e.turnServerURL,"turnServerURL"),$g(e.username,"username"),$g(e.password,"password"),e.udpport&&Yg(e.udpport,"udpport",1,99999,!0),e.forceturn&&zg(e.forceturn,"forceturn"),e.security&&zg(e.security,"security"),e.tcpport&&Yg(e.tcpport,"tcpport",1,99999,!0),!0}function j_(e){return void 0!==e.level&&Jg(e.level,"level",[1,2,3]),!0}!function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics"}(h_||(h_={})),function(e){e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed"}(u_||(u_={})),function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(p_||(p_={})),function(e){e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(m_||(m_={})),function(e){e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",e.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage"}(f_||(f_={})),function(e){e.TRACER="tracer"}(g_||(g_={})),function(e){e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND"}(__||(__={})),function(e){e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(v_||(v_={})),function(e){e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(y_||(y_={})),function(e){e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(E_||(E_={})),function(e){e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(S_||(S_={})),function(e){e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(b_||(b_={})),function(e){e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(w_||(w_={})),function(e){e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(T_||(T_={})),function(e){e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL"}(C_||(C_={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result"}(R_||(R_={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(I_||(I_={})),function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed"}(A_||(A_={})),function(e){e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback"}(P_||(P_={})),function(e){e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.SUBSCRIBE="subscribe",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter"}(O_||(O_={})),function(e){e.PUBLISH_STATS="publish_stats",e.PUBLISH_RELATED_STATS="publish_related_stats",e.SUBSCRIBE_STATS="subscribe_stats",e.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.TRANSPORT_STATS="transport_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats"}(N_||(N_={})),function(e){e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list"}(D_||(D_={})),function(e){e.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",e.NEED_ANSWER="NEED_ANSWER",e.NEED_RENEGOTIATE="NEED_RENEGOTIATE",e.P2P_LOST="P2P_LOST",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NEED_UNPUB="NEED_UNPUB",e.NEED_UNSUB="NEED_UNSUB",e.NEED_UPLOAD="NEED_UPLOAD",e.NEED_CONTROL="NEED_CONTROL",e.START_RECONNECT="START_RECONNECT",e.END_RECONNECT="END_RECONNECT",e.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(k_||(k_={})),function(e){e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source"}(x_||(x_={}));const V_={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,currentPacketLossRate:0},B_={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},H_={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},W_={uplinkNetworkQuality:0,downlinkNetworkQuality:0},K_={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let G_,q_,z_;!function(e){e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(G_||(G_={})),function(e){e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming"}(q_||(q_={})),function(e){e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(z_||(z_={}));const J_={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Y_={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function X_(e,t){$g(e.url,"".concat(t,".url"),1,1e3,!1),t_(e.x)||Yg(e.x,"".concat(t,".x"),0,1e4),t_(e.y)||Yg(e.y,"".concat(t,".y"),0,1e4),t_(e.width)||Yg(e.width,"".concat(t,".width"),0,1e4),t_(e.height)||Yg(e.height,"".concat(t,".height"),0,1e4),t_(e.zOrder)||Yg(e.zOrder,"".concat(t,".zOrder"),0,255),t_(e.alpha)||Yg(e.alpha,"".concat(t,".alpha"),0,1,!1)}const $_={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Q_={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let Z_,ev,tv,iv,nv,rv,sv,ov,av,cv,dv,lv,hv,uv,pv,mv,fv,gv,_v;function vv(e){if(!e.channelName)throw new Ef(yf.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new Ef(yf.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&$g(e.token,"info.token",1,2047),e_(e.uid),Zg(e.channelName),!0}function yv(e){return Jg(e,"mediaSource",["screen","window","application"]),!0}!function(e){e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(Z_||(Z_={})),function(e){e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(ev||(ev={})),function(e){e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(tv||(tv={})),function(e){e.CONNECT_FAILED="connect failed",e.CONNECT_TIMEOUT="connect timeout",e.WS_DISCONNECTED="websocket disconnected",e.REQUEST_TIMEOUT="request timeout",e.REQUEST_FAILED="request failed",e.WAIT_STATUS_TIMEOUT="wait status timeout",e.WAIT_STATUS_ERROR="wait status error",e.BAD_STATE="bad state",e.WS_ABORT="ws abort",e.AP_REQUEST_TIMEOUT="AP request timeout",e.AP_JSON_PARSE_ERROR="AP json parse error",e.AP_REQUEST_ERROR="AP request error",e.AP_REQUEST_ABORT="AP request abort"}(iv||(iv={})),function(e){e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile"}(nv||(nv={})),function(e){e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(rv||(rv={})),function(e){e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(sv||(sv={})),function(e){e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(ov||(ov={})),function(e){e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low"}(av||(av={})),function(e){e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal"}(cv||(cv={})),function(e){e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data"}(dv||(dv={})),function(e){e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel"}(lv||(lv={})),function(e){e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track"}(hv||(hv={})),function(e){e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream"}(uv||(uv={})),function(e){e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM"}(pv||(pv={})),function(e){e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY"}(mv||(mv={})),function(e){e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed"}(fv||(fv={})),function(e){e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(gv||(gv={})),function(e){e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS"}(_v||(_v={}));const Ev=[_v.AFRICA,_v.ASIA,_v.CHINA,_v.EUROPE,_v.GLOBAL,_v.INDIA,_v.JAPAN,_v.NORTH_AMERICA,_v.OCEANIA,_v.OVERSEA,_v.SOUTH_AMERICA];let Sv;!function(e){e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL"}(Sv||(Sv={}));const bv={CHINA:{},ASIA:{CODE:Sv.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Sv.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Sv.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Sv.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","\tuap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Sv.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Sv.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Sv.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Sv.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Sv.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Sv.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Sv.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Sv.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Sv.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};let wv,Tv,Cv,Rv,Iv,Av,Pv,Ov,Nv,Dv,kv,xv,Lv,Mv,Fv;Df&&(bv.CHINA={CODE:Sv.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(e){e.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(wv||(wv={}));class Uv extends _f{constructor(e,t){super(),fp(this,"onICEConnectionStateChange",void 0),fp(this,"onConnectionStateChange",void 0),fp(this,"onDTLSTransportStateChange",void 0),fp(this,"onDTLSTransportError",void 0),fp(this,"onICETransportStateChange",void 0),fp(this,"onFirstAudioReceived",void 0),fp(this,"onFirstVideoReceived",void 0),fp(this,"onFirstAudioDecoded",void 0),fp(this,"onFirstVideoDecoded",void 0),fp(this,"onFirstVideoDecodedTimeout",void 0),fp(this,"onSelectedLocalCandidateChanged",void 0),fp(this,"onSelectedRemoteCandidateChanged",void 0),fp(this,"establishPromise",void 0)}}!function(e){e.SEND="sendonly",e.RECV="recvonly",e.SENDRECV="sendrecv",e.INACTIVE="inactive"}(Tv||(Tv={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(Cv||(Cv={})),function(e){e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack"}(Rv||(Rv={})),function(e){e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected"}(Iv||(Iv={})),function(e){e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState"}(Av||(Av={})),function(e){e.ONLINE="ONLINE",e.OFFLINE="OFFLINE"}(Pv||(Pv={})),function(e){e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE"}(Ov||(Ov={})),function(e){e.ON_TRACK="on_track",e.ON_NODE="on_node"}(Nv||(Nv={})),function(e){e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints"}(Dv||(Dv={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(kv||(kv={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(xv||(xv={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Lv||(Lv={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(Mv||(Mv={})),function(e){e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback"}(Fv||(Fv={}));const jv={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1};function Vv(){return jv}let Bv;!function(e){e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(Bv||(Bv={}));var Hv=L,Wv=Array.isArray||function(e){return"Array"==Hv(e)},Kv=p,Gv=Wv,qv=oc,zv=J,Jv=st("species"),Yv=Kv.Array,Xv=function(e){var t;return Gv(e)&&(t=e.constructor,(qv(t)&&(t===Yv||Gv(t.prototype))||zv(t)&&null===(t=t[Jv]))&&(t=void 0)),void 0===t?Yv:t},$v=function(e,t){return new(Xv(e))(0===t?0:t)},Qv=Kt,Zv=B,ey=Ve,ty=Oi,iy=$v,ny=l([].push),ry=function(e){var t=1==e,i=2==e,n=3==e,r=4==e,s=6==e,o=7==e,a=5==e||s;return function(c,d,l,h){for(var u,p,m=ey(c),f=Zv(m),g=Qv(d,l),_=ty(f),v=0,y=h||iy,E=t?y(c,_):i||o?y(c,0):void 0;_>v;v++)if((a||v in f)&&(p=g(u=f[v],v,m),e))if(t)E[v]=p;else if(p)switch(e){case 3:return!0;case 5:return u;case 6:return v;case 2:ny(E,u)}else switch(e){case 4:return!1;case 7:ny(E,u)}return s?-1:n||r?r:E}},sy={forEach:ry(0),map:ry(1),filter:ry(2),some:ry(3),every:ry(4),find:ry(5),findIndex:ry(6),filterReject:ry(7)},oy=sy.forEach,ay=ji("forEach")?[].forEach:function(e){return oy(this,e,arguments.length>1?arguments[1]:void 0)};wi({target:"Array",proto:!0,forced:[].forEach!=ay},{forEach:ay});var cy=Gi("Array").forEach,dy=Zr,ly=We,hy=h,uy=cy,py=Array.prototype,my={DOMTokenList:!0,NodeList:!0},fy=function(e){var t=e.forEach;return e===py||hy(py,e)&&t===py.forEach||ly(my,dy(e))?uy:t},gy=Ve,_y=pr;wi({target:"Object",stat:!0,forced:n((function(){_y(1)}))},{keys:function(e){return _y(gy(e))}});var vy=Y.Object.keys,yy=Xi,Ey=wi,Sy=Wv,by=l([].reverse),wy=[1,2];Ey({target:"Array",proto:!0,forced:String(wy)===String(wy.reverse())},{reverse:function(){return Sy(this)&&(this.length=this.length),by(this)}});var Ty=Gi("Array").reverse,Cy=h,Ry=Ty,Iy=Array.prototype,Ay=function(e){var t=e.reverse;return e===Iy||Cy(Iy,e)&&t===Iy.reverse?Ry:t},Py=n,Oy=ce,Ny=st("species"),Dy=function(e){return Oy>=51||!Py((function(){var t=[];return(t.constructor={})[Ny]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},ky=wi,xy=p,Ly=Wv,My=oc,Fy=J,Uy=Fn,jy=Oi,Vy=q,By=rg,Hy=st,Wy=mc,Ky=Dy("slice"),Gy=Hy("species"),qy=xy.Array,zy=Math.max;ky({target:"Array",proto:!0,forced:!Ky},{slice:function(e,t){var i,n,r,s=Vy(this),o=jy(s),a=Uy(e,o),c=Uy(void 0===t?o:t,o);if(Ly(s)&&(i=s.constructor,(My(i)&&(i===qy||Ly(i.prototype))||Fy(i)&&null===(i=i[Gy]))&&(i=void 0),i===qy||void 0===i))return Wy(s,a,c);for(n=new(void 0===i?qy:i)(zy(c-a,0)),r=0;a<c;a++,r++)a in s&&By(n,r,s[a]);return n.length=r,n}});var Jy=Gi("Array").slice,Yy=h,Xy=Jy,$y=Array.prototype,Qy=function(e){var t=e.slice;return e===$y||Yy($y,e)&&t===$y.slice?Xy:t};function Zy(e,t,i,n,r){var s,o,a,c={};return fy(s=vy(n)).call(s,(function(e){c[e]=n[e]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=yy(o=Ay(a=Qy(i).call(i)).call(a)).call(o,(function(i,n){return n(e,t,i)||i}),c),r&&void 0!==c.initializer&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),void 0===c.initializer&&(mp(e,t,c),c=null),c}var eE=Gi("Array").keys,tE=Zr,iE=We,nE=h,rE=eE,sE=Array.prototype,oE={DOMTokenList:!0,NodeList:!0},aE=function(e){var t=e.keys;return e===sE||nE(sE,e)&&t===sE.keys||iE(oE,tE(e))?rE:t};function cE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function dE(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?cE(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):cE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let lE=0,hE=0;function uE(e,t,i,n){return new yh(((r,s)=>{t.timeout=t.timeout||Kf("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),lE+=Vb(t.data)):i&&(t.data.size?lE+=t.data.size:t.data instanceof FormData?lE+=function(e){let t=0;return/DingTalk/i.test(navigator.userAgent)&&e.realFormData&&(e=e.realFormData),e.forEach((e=>{t+="string"==typeof e?Vb(e):e.size})),t+138}(t.data):lE+=Vb(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ff.request(t).then((e=>{"string"==typeof e.data?hE+=Vb(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?hE+=e.data.byteLength:hE+=Vb(JSON.stringify(e.data)),n&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{ff.isCancel(e)?s(new Ef(yf.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?s(new Ef(yf.NETWORK_TIMEOUT,e.message)):e.response?s(new Ef(yf.NETWORK_RESPONSE_ERROR,e.response.status)):s(new Ef(yf.NETWORK_ERROR,e.message))}))}))}async function pE(e,t){const i=new Blob([t.data],{type:"buffer"});return await uE(e,dE(dE({},t),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const mE=new class extends _f{set networkState(e){Pf.info("[".concat(this._moduleName,"]")+"network state changed, "+this._networkState+" -> "+e),this.emit(Ov.NETWORK_STATE_CHANGE,e,this._networkState),e===Pv.ONLINE?this.emit(Ov.ONLINE):e===Pv.OFFLINE&&(this.onlineWaiter=new yh((e=>{this.once(Ov.ONLINE,(()=>{this.onlineWaiter=void 0,e(Pv.ONLINE)}))})),this.emit(Ov.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}constructor(){super(),fp(this,"_moduleName","network-indicator"),fp(this,"_networkState",Pv.ONLINE),fp(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=Pv.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=Pv.OFFLINE}))}};let fE=!1;const gE=new class extends _f{constructor(){super(...arguments),fp(this,"onAutoplayFailed",void 0),fp(this,"onAudioAutoplayFailed",void 0)}};function _E(){if(Mu(),!fE){const e=t=>{t.preventDefault(),fE=!1,ap()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};fE=!0,ap()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Pf.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),gE.onAutoplayFailed?gE.onAutoplayFailed():gE.onAudioAutoplayFailed?Pf.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):Pf.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),gE.emit("autoplay-failed")}}function vE(e){return(new TextEncoder).encode(e)}const yE=function(e,t){const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i},EE=async e=>function(e,t){let i="";return new Uint8Array(e).forEach((e=>{i+=e.toString(t).padStart(2,"0")})),i}(await crypto.subtle.digest("SHA-256",vE(e)),16);function SE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function bE(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?SE(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):SE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function wE(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,i,n){const r=n.value;if("function"==typeof r){const s=e.className||t.__className__||("AgoraRTCClient"===t.constructor.name?"Client":t.constructor.name);n.value=function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];let a=n;if(e.argsMap)try{a=e.argsMap(this,...n)}catch(e){Pf.warning(e),a=[]}try{JSON.stringify(a)}catch(e){Pf.warning("arguments for method ".concat(s,".").concat(i," not serializable for apiInvoke.")),a=[]}const c=(e.report||TE).reportApiInvoke(this._sessionId||null,{name:"".concat(s,".").concat(i),options:a,tag:g_.TRACER,reportResult:e.reportResult},e.throttleTime);try{const t=r.apply(this,n);return t instanceof yh?t.then((t=>(c.onSuccess(e.reportResult&&t),t))).catch((e=>{throw c.onError(e),e})):(c.onSuccess(e.reportResult&&t),t)}catch(e){throw c.onError(e),e}}}return n}}const TE=new class{constructor(){fp(this,"baseInfoMap",new Map),fp(this,"proxyServer",void 0),fp(this,"clientList",Qf),fp(this,"eventUploadTimer",void 0),fp(this,"setSessionIdTimer",void 0),fp(this,"url",void 0),fp(this,"backupUrl",void 0),fp(this,"_appId",void 0),fp(this,"keyEventUploadPendingItems",[]),fp(this,"normalEventUploadPendingItems",[]),fp(this,"apiInvokeUploadPendingItems",[]),fp(this,"apiInvokeCount",0),fp(this,"ltsList",[]),fp(this,"lastSendNormalEventTime",Date.now()),fp(this,"customReportCounterTimer",void 0),fp(this,"customReportCount",0),fp(this,"extApiInvoke",(async e=>{for(const t of e){const e=bE(bE({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:g_.TRACER});this.sendApiInvoke(e)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Kf("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Kf("EVENT_REPORT_SEND_INTERVAL"))}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void Pf.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const t=this.baseInfoMap.get(e),i=Date.now(),n=t.startTime;t.startTime=i,Pf.debug("rewrite session ".concat(e," startTime: ").concat(i," , ").concat(i-n,"ms")),this.baseInfoMap.set(e,t)}setAppId(e){this._appId=e}reportApiInvoke(e,t,i){t.timeout=t.timeout||6e4,t.reportResult=void 0===t.reportResult||t.reportResult;const n=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,s=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:n,options:t.options,states:t.states||null}),o=!!Kf("SHOW_REPORT_INVOKER_LOG");o&&Pf.info("".concat(t.name," start"),t.options);let a=!1;Bb(t.timeout).then((()=>{a||(this.sendApiInvoke(bE(bE({},s()),{},{error:yf.API_INVOKE_TIMEOUT,success:!1})),Pf.debug("".concat(t.name," timeout")))}));const c=new Ef(yf.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:e=>{const n=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(bE(bE({},s()),{},{success:!0},t.reportResult&&{result:e})),o&&Pf.info("".concat(t.name," onSuccess")),e};return i?aw(n,t.name+"Success",i,(()=>a=!0)):n()},onError:e=>{const n=()=>{if(a)throw e;a=!0,this.sendApiInvoke(bE(bE({},s()),{},{success:!1,error:e})),o&&Pf.info("".concat(t.name," onFailure"),e.toString())};return i?aw(n,t.name+"Error",i,(()=>a=!0)):n()}}}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const i=Date.now(),n=this.createBaseInfo(e,i);n.cname=t.cname;const r=Object.assign({},{willUploadConsoleLog:Kf("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Df?"global":"oversea",areas:Kf("AREAS")&&Kf("AREAS").join(",")},t.extend),s=Date.now(),o=bE(bE({},n),{},{eventType:h_.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,build:Of,lts:s,elapse:s-i,extend:JSON.stringify(r),mode:t.mode,process:Kf("PROCESS_ID"),appType:Kf("APP_TYPE"),success:!0,version:Nf});this.send({type:u_.SESSION,data:o},!0)}joinChooseServer(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.JOIN_CHOOSE_SERVER,lts:r,eventElapse:r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-i.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3});this.send({type:u_.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:r-i.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:u_.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info;t.vid&&(n.vid=t.vid),n.uid=t.uid,n.cid=t.cid;const r=Date.now(),{firstSuccess:s,avoidJoinStartTime:o,isProxy:a,addr:c}=t,d=r-(s&&o?o:i.startTime),l=bE(bE({},n),{},{eventType:h_.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,elapse:d,eventElapse:r-t.lts,firstSuccess:s,signalChannel:t.signalChannel}),h=l.success?1:0;if(t.succ&&(i.lastJoinSuccessTime=r),s)this.send({type:u_.JOIN_GATEWAY,data:l},!0);else{let e;if(c)if(a){const t=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),i=c.match(/p=[0-9]{1,6}/g);e={isSuccess:h,gatewayIp:t&&t.length?t[0].split("=")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split("=")[1]:"",isProxy:a?1:0}}else{const t=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),i=c.match(/:[0-9]{1,6}/g);e={isSuccess:h,gatewayIp:t&&t.length?t[0].split("//")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split(":")[1]:"",isProxy:a?1:0}}else e={isSuccess:h,gatewayIp:"",port:"",isProxy:a?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const t=Object.assign({},l,e,{eventType:h_.REJOIN_GATEWAY});this.send({type:u_.RE_JOIN_GATEWAY,data:t},!0)}}joinChannelTimeout(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=Date.now(),r=bE(bE({},i.info),{},{lts:n,timeout:t,elapse:n-i.startTime});this.send({type:u_.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-i.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:u_.PUBLISH,data:s},!0)}subscribe(e,t,i){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,s=Date.now(),o=bE(bE({},r),{},{eventType:h_.SUBSCRIBE,lts:s,eventElapse:t.eventElapse,elapse:s-n.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof t.peerid?o.peerSuid=t.peerid:o.peer=t.peerid,this.send({type:u_.SUBSCRIBE,data:o},!0)}wsCompressorInit(e){var t;const i=[...aE(t=this.baseInfoMap).call(t)],n=i.length?i[0]:"UnableToGetSid",r=this.baseInfoMap.get(n);if(!r)return;const s=r.info,o=Date.now(),a=bE(bE({},s),{},{eventType:h_.WS_COMPRESSOR_INIT,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,status:e.status?1:2});this.send({type:u_.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(e,t,i,n){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=bE(bE(bE({},s),n),{},{elapse:o-r.startTime,eventType:t,lts:o,firstDecodeFrame:Math.max(o-r.startTime,0),apEnd:Math.max(n.apEnd-r.startTime,0),apStart:Math.max(n.apStart-r.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-r.startTime,0),joinGwStart:Math.max(n.joinGwStart-r.startTime,0),pcEnd:Math.max(n.pcEnd-r.startTime,0),pcStart:Math.max(n.pcStart-r.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-r.startTime,0),subscriberStart:Math.max(n.subscriberStart-r.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-r.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(e,t,i,n){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=bE(bE(bE({},s),n),{},{elapse:o-r.startTime,eventType:t,lts:o});this.send({type:i,data:a},!0)}onGatewayStream(e,t,i,n){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=bE(bE(bE({},s),n),{},{eventType:t,lts:o});this.send({type:i,data:a},!0)}streamSwitch(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-i.startTime,success:t.succ});this.send({type:u_.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-i.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:u_.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{eventType:h_.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-i.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:u_.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(e){this.proxyServer=e,e?Pf.debug("reportProxyServerurl: ".concat(e)):Pf.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE({},n),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-i.startTime,joinChannelSuccessElapse:r-(i.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:u_.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now();(function(e,t,i){const n=e[t];if(!n||"string"!=typeof n)return[e];e[t]="";const r=Vb(JSON.stringify(e));let s=0;const o=[];let a=0;for(let c=0;c<n.length;c++)a+=n.charCodeAt(c)<=127?1:3,a<=i-r||(o[o.length]=jb(jb({},e),{},{[t]:n.substring(s,c)}),s=c,a=n.charCodeAt(c)<=127?1:3);return s!==n.length-1&&(o[o.length]=jb(jb({},e),{},{[t]:n.substring(s)})),o})(bE(bE(bE({},n),t),{},{elapse:r-i.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach((e=>this.send({type:u_.WORKER_EVENT,data:e},!0)))}apworkerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE(bE({},n),t),{},{elapse:r-i.startTime,lts:r});this.send({type:u_.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE(bE({},n),t),{},{elapse:r-i.startTime,lts:r,extend:t.extend||void 0});this.send({type:u_.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,r=Date.now(),s=bE(bE(bE({},n),t),{},{elapse:r-i.startTime,lts:r});this.send({type:u_.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>Kf("CUSTOM_REPORT_LIMIT"))throw new Ef(yf.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const i=Date.now(),n=t.map((t=>({type:u_.USER_ANALYTICS,data:bE(bE({sid:e},t),{},{lts:i})})));try{Kf("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(e){throw Pf.error("send custom report message failed",e.toString()),new Ef(yf.CUSTOM_REPORT_SEND_FAILED,e.message)}}autoplayFailed(e,t,i,n){if(!e)return;const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=bE(bE({},s),{},{vid:void 0===s.vid?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:gE.onAutoplayFailed||gE.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:t,trackId:n,extend:void 0});this.send({type:u_.AUTOPLAY_FAILED,data:a},!0)}sendApiInvoke(e){const t=Kf("NOT_REPORT_EVENT");if(e.tag&&t.includes&&t.includes(e.tag))return!1;if(null===e.sid)return this.apiInvokeUploadPendingItems.push(e),!1;const i=this.baseInfoMap.get(e.sid);if(!i)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:n,uid:r,cid:s}=i.info;let o;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof Ef){const{code:t,message:i}=e.error;o=t||i||e.error.toString()}else o=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:n,cid:s,uid:r,lts:e.lts,success:e.success,elapse:e.lts-i.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?o:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:u_.API_INVOKE,data:a},!1),!0}appendSessionId(){this.clientList.forEach((e=>{if(e._sessionId){const t=this.apiInvokeUploadPendingItems.length;for(let i=0;i<t;i++){const t=this.apiInvokeUploadPendingItems.shift();t&&(t.sid=e._sessionId,this.sendApiInvoke(Object.assign({},t)))}}}))}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>Kf("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const i=[],n=[];for(;e.length;){const t=e.shift();i.length<20?i.push(t):n.push(t)}e.push(...n);for(const s of[...i]){var r;-1!==this.ltsList.indexOf(s.data.lts)?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),qg(r=this.ltsList).call(r,((e,t)=>e-t)))}return t||(this.lastSendNormalEventTime=Date.now()),Kf("ENABLE_EVENT_REPORT")?(i.length&&(Kf("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((e=>i=>{Kf("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(e):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(e),this.normalEventUploadPendingItems.length>Kf("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Kf("NORMAL_EVENT_QUEUE_CAPACITY")),Pf.warning("report: drop normal events"))))})(i)),e):e}async postDataToStatsCollector2(e){mE.networkState===Pv.OFFLINE&&await yh.race([mE.onlineWaiter,Bb(2*Sf.maxRetryTimeout)]);const t=e=>{let t=new Uint8Array;return e.forEach((e=>{const i=vE(JSON.stringify(e.data)),n=new ArrayBuffer(5),r=(e=>{let t=0;return Object.entries(u_).forEach((i=>{let[n,r]=i;r===e.type&&(t=m_[n])})),t})(e),s=new DataView(n);s.setUint16(0,i.byteLength,!0),s.setUint8(2,255&r),s.setUint8(3,r>>>8&255),s.setUint8(4,r>>>16&255),t=yE(t,new Uint8Array(n)),t=yE(t,i)})),t},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Kf("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(Kf("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let r=0;r<2;r+=1){1===r&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Kf("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(Kf("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await uE(n,{timeout:1e4,data:t(e),headers:bE(bE({token:"32f24ab2ddb74f508aa9286c356cec84",biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(e){if(1===r)throw e;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((e=>JSON.stringify(e))),vid:(e=>{const t=e&&e.data.sid&&this.baseInfoMap.get(e.data.sid);return t&&t.info.vid&&+t.info.vid||0})(e[0])};mE.networkState===Pv.OFFLINE&&await yh.race([mE.onlineWaiter,Bb(2*Sf.maxRetryTimeout)]);const n=t?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Kf("EVENT_REPORT_DOMAIN"),"&p=").concat(Kf("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Kf("EVENT_REPORT_DOMAIN"),":").concat(Kf("STATS_COLLECTOR_PORT")).concat(n));for(let s=0;s<2;s+=1){1===s&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Kf("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Kf("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Kf("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Kf("STATS_COLLECTOR_PORT")).concat(n)));try{t?await pE(r,{timeout:1e4,data:i}):await uE(r,{timeout:1e4,data:i})}catch(t){if(1===s)throw t;continue}return}}createBaseInfo(e,t){const i=Object.assign({},l_);return i.sid=e,this.baseInfoMap.set(e,{info:i,startTime:t}),i}reportResourceTiming(e,t){const i=performance.getEntriesByName(e),n=i[i.length-1];n&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:n,tag:g_.TRACER}).onSuccess()}};vf.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=mE.networkState,TE.reportApiInvoke(null,{name:"logUploadError",options:e,tag:g_.TRACER})}));class CE extends _f{constructor(e,t){super(),fp(this,"trackMediaType",void 0),fp(this,"_ID",void 0),fp(this,"_hints",[]),fp(this,"_isClosed",!1),fp(this,"_originMediaStreamTrack",void 0),fp(this,"_mediaStreamTrack",void 0),fp(this,"_external",{}),this._ID=t||Wb(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(e){Zf.includes(e)||Zf.push(e)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const e=TE.reportApiInvoke(null,{name:f_.GET_MEDIA_STREAM_TRACK,options:[],tag:g_.TRACER});this._mediaStreamTrack&&"string"==typeof this._mediaStreamTrack.label?e.onSuccess(this._mediaStreamTrack.label):e.onSuccess("")}return this._mediaStreamTrack}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,function(e){const t=Zf.indexOf(e);-1!==t&&Zf.splice(t,1)}(this),this.emit(fv.CLOSED)}}let RE,IE=1;class AE{constructor(e){fp(this,"lockingPromise",yh.resolve()),fp(this,"locks",0),fp(this,"name",""),fp(this,"lockId",void 0),this.lockId=IE++,e&&(this.name=e),Pf.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,Pf.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:""));const i=new yh((i=>{t=()=>{this.locks-=1,Pf.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:"")),i()}})),n=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>i)),n}}function PE(e,t){return function(i,n,r){const s=r.value;if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return r.value=async function(){const i=this[t];if(!i)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const r=await i.lock("From ".concat(e,".").concat(n));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await s.apply(this,a)}finally{r()}},r}}class OE extends CE{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}constructor(e,t){super(e,t),fp(this,"_enabled",!0),fp(this,"_muted",!1),fp(this,"_isExternalTrack",!1),fp(this,"_isClosed",!1),fp(this,"_enabledMutex",void 0),fp(this,"processor",void 0),fp(this,"_processorContext",void 0),fp(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new AE("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return null!==(e=null===(t=this._originMediaStreamTrack)||void 0===t?void 0:t.label)&&void 0!==e?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,Pf.debug("[".concat(this.getTrackId(),"] close")),this.emit(hv.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop(),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Yb(this,hv.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){Pf.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(fv.TRACK_ENDED)}stateCheck(e,t){if(Pf.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),zg(t,e),this._enabled&&this._muted&&"enabled"===e&&!1===t)throw new Ef(yf.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print();if(!this._enabled&&!this._muted&&"muted"===e&&!0===t)throw new Ef(yf.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function NE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}!function(e){e.IOS_15_INTERRUPTION_START="ios15-interruption-start",e.IOS_15_INTERRUPTION_END="ios15-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change"}(RE||(RE={}));const DE=window.AudioContext||window.webkitAudioContext;let kE=null;const xE=new class extends _f{constructor(){super(...arguments),fp(this,"prevState",void 0),fp(this,"curState",void 0),fp(this,"currentTime",void 0),fp(this,"currentTimeStuckAt",void 0),fp(this,"interruptDetectorTrack",void 0),fp(this,"onLocalAudioTrackMute",(()=>{Pf.info("ios15-interruption-start"),this.emit(RE.IOS_15_INTERRUPTION_START)})),fp(this,"onLocalAudioTrackUnmute",(async()=>{Pf.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?Pf.info("ios15-interruption-end-canceled"):(kE&&await kE.suspend(),this.emit(RE.IOS_15_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(e){Pf.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){Pf.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function LE(){if(!DE)return void Pf.error("your browser is not support web audio");Pf.info("create audio context");const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?NE(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):NE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},Kf("WEBAUDIO_INIT_OPTIONS"));Pf.debug("audio context init option:",JSON.stringify(e)),kE=new DE(e),xE.curState=kE.state,kE.onstatechange=()=>{xE.prevState=xE.curState,xE.curState=kE?kE.state:void 0,(qu()||ip())&&"running"===xE.prevState&&"interrupted"===xE.curState&&(Pf.info("ios-interruption-start"),xE.emit(RE.IOS_INTERRUPTION_START)),(qu()||ip())&&"interrupted"===xE.prevState&&"running"===xE.curState&&(Pf.info("ios-interruption-end"),xE.emit(RE.IOS_INTERRUPTION_END)),xE.prevState!==xE.curState&&(Pf.debug("AudioContext State Change","".concat(xE.prevState,"=>").concat(xE.curState)),xE.emit(RE.STATE_CHANGE))},setInterval((()=>{var e;const t=null===(e=kE)||void 0===e?void 0:e.currentTime;xE.currentTime!==t?(xE.currentTimeStuckAt&&(Pf.debug("AudioContext current time resume at ".concat(t)),xE.currentTimeStuckAt=void 0),xE.currentTime=t):(t!==xE.currentTimeStuckAt&&(TE.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:g_.TRACER}).onSuccess(),Pf.warning("AudioContext current time stuck at ".concat(t))),xE.currentTimeStuckAt=t)}),5e3),async function(e){const t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,n=!1,r=!1,s=!1;function o(t){"running"===e.state?a(!1):qu()||ip()?"suspended"===e.state&&(a(!0),t&&e.resume().then(d,d)):"closed"!==e.state&&(a(!0),t&&e.resume().then(d,d))}function a(e){if(n!==e){n=e;for(let i=0,n=t;i<n.length;i+=1){const t=n[i];e?window.addEventListener(t,l,{capture:!0,passive:!0}):window.removeEventListener(t,l,{capture:!0,passive:!0})}}}function c(){o(!0)}function d(){o(!1)}function l(){o(!0)}function h(e){if(!s)if(i.paused)if(e){let t;u(!1),s=!0;try{t=i.play(),t?t.then(p,p):(i.addEventListener("playing",p),i.addEventListener("abort",p),i.addEventListener("error",p))}catch(e){p()}}else u(!0);else u(!1)}function u(e){if(r!==e){r=e;for(let i=0,n=t;i<n.length;i++){const t=n[i];e?window.addEventListener(t,m,{capture:!0,passive:!0}):window.removeEventListener(t,m,{capture:!0,passive:!0})}}}function p(){i.removeEventListener("playing",p),i.removeEventListener("abort",p),i.removeEventListener("error",p),s=!1,h(!1)}function m(){h(!0)}if(qu()){const t=e.createMediaStreamDestination(),n=document.createElement("div");n.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=n.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=t.stream,h(!0)}xE.on(RE.STATE_CHANGE,c),o(!1)}(kE)}function ME(){if(!kE){if(LE(),!kE)throw new Ef(yf.NOT_SUPPORTED,"can not create audio context");return kE}return kE}function FE(){return!!kE}function UE(e){if(function(){if(null!==jE)return jE;const e=ME(),t=e.createBufferSource(),i=e.createGain(),n=e.createGain();t.connect(i),t.connect(n),t.disconnect(i);let r=!1;try{t.disconnect(i)}catch(e){r=!0}return t.disconnect(),jE=r,r}())return;const t=e.connect,i=e.disconnect;e.connect=(i,n,r)=>(e._inputNodes||(e._inputNodes=[]),e._inputNodes.includes(i)||(i instanceof AudioNode?(e._inputNodes.push(i),t.call(e,i,n,r)):t.call(e,i,n)),e),e.disconnect=(n,r,s)=>{i.call(e),n?Qb(e._inputNodes,n):e._inputNodes=[];for(const i of e._inputNodes)t.call(e,i)}}let jE=null;function VE(e,t){let i=!1;const n=1/t;if(Kf("DISABLE_WEBAUDIO")){const t=window.setInterval((()=>{i?window.clearInterval(t):e(performance.now()/1e3)}),1e3*n)}else{const t=ME();let r=t.createGain();r.gain.value=0,r.connect(t.destination);const s=()=>{if(i)return void(r=null);const o=t.createOscillator();o.onended=s,o.connect(r),o.start(0),o.stop(t.currentTime+n),e(t.currentTime)};s()}return()=>{i=!0}}class BE{constructor(){fp(this,"context",void 0),fp(this,"analyserNode",void 0),fp(this,"sourceNode",void 0),this.context=ME(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(e){}this.sourceNode=e,null==e||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||qu()||ip()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const t=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(t);for(let i=0;i<e.length;++i)e[i]=t[i]/128-1}const t=$i(e).call(e,((e,t)=>e+t*t),0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;null===(e=this.sourceNode)||void 0===e||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(t=this.sourceNode)||void 0===t||t.connect(this.analyserNode)}catch(e){Pf.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class HE extends _f{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var i;null===(i=this.sourceNode)||void 0===i||i.disconnect(this.outputNode)}catch(e){}null===(t=this._processedNode)||void 0===t||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),fp(this,"outputNode",void 0),fp(this,"outputTrack",void 0),fp(this,"isPlayed",!1),fp(this,"sourceNode",void 0),fp(this,"context",void 0),fp(this,"audioBufferNode",void 0),fp(this,"destNode",void 0),fp(this,"audioOutputLevel",0),fp(this,"volumeLevelAnalyser",void 0),fp(this,"_processedNode",void 0),fp(this,"playNode",void 0),fp(this,"isDestroyed",!1),fp(this,"onNoAudioInput",void 0),fp(this,"isNoAudioInput",!1),fp(this,"_noAudioInputCount",0),this.context=ME(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),UE(this.outputNode),this.volumeLevelAnalyser=new BE}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit(x_.ON_AUDIO_BUFFER,function(e){for(let t=0;t<e.outputBuffer.numberOfChannels;t+=1){const i=e.outputBuffer.getChannelData(t);for(let e=0;e<i.length;e+=1)i[e]=0}return e.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Vv().webAudioMediaStreamDest)throw new Ef(yf.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){"running"!==this.context.state&&ew((()=>{xE.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(e){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;qu()||ip()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const t=this.volumeLevelAnalyser.getAnalyserNode();let i;t.getFloatTimeDomainData?(i=new Float32Array(t.fftSize),t.getFloatTimeDomainData(i)):(i=new Uint8Array(t.fftSize),t.getByteTimeDomainData(i));let n=!1;for(let r=0;r<i.length;r++)0!==i[r]&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await Bb(200),await this.checkHasAudioInput(e?e+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;null===(e=this.processedNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?null===(e=this.processedNode)||void 0===e||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class WE extends HE{get isFreeze(){return!1}constructor(e,t,i){var n;if(super(),fp(this,"sourceNode",void 0),fp(this,"track",void 0),fp(this,"clonedTrack",void 0),fp(this,"audioElement",void 0),fp(this,"isCurrentTrackCloned",!1),fp(this,"isRemoteTrack",!1),fp(this,"originVolumeLevelAnalyser",void 0),fp(this,"rebuildWebAudio",(async()=>{if(Pf.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void Pf.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>Pf.info("resume success"))),Pf.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const e=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?e.stop():this.isCurrentTrackCloned=!0;const t=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(t),UE(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const i=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(i,this.context.currentTime),UE(this.outputNode),this.emit(x_.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=t,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==e.kind)throw new Ef(yf.UNEXPECTED_ERROR);this.track=e;const r=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(r),UE(this.sourceNode),i){const e=i.clone();e.enabled=!0,this.clonedTrack=e,Pf.debug("create an unmuted track ".concat(e.id," from the original track ").concat(i.id," to get the volume"));const t=this.context.createMediaStreamSource(new MediaStream([e]));UE(t),this.originVolumeLevelAnalyser=new BE,this.originVolumeLevelAnalyser.updateSource(t)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=r;const s=Mu();t&&s.os===Ou.IOS&&Number(null===(n=s.osVersion)||void 0===n?void 0:n.split(".")[0])<15&&(xE.on(RE.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((e=>{e||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),UE(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(x_.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),xE.off("state-change",this.rebuildWebAudio),null===(e=this.originVolumeLevelAnalyser)||void 0===e||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),Pf.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([t]));UE(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function KE(e,t){const i=(e,t)=>e?"number"!=typeof e?e.max||e.exact||e.ideal||e.min||t:e:t,n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&"number"!=typeof t.frameRate?(n.video.mandatory.maxFrameRate=t.frameRate.max,n.video.mandatory.minFrameRate=t.frameRate.min):"number"==typeof t.frameRate&&(n.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(n)}async function GE(e){const t=await qE(e.mediaSource),i=await function(e){return new yh(((t,i)=>{const n=document.createElement("div");n.innerText="share screen",n.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const r=document.createElement("div");r.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const s=document.createElement("div");s.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",s.setAttribute("style","height: 12%;");const o=document.createElement("div");o.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const a=document.createElement("div");a.setAttribute("style","text-align: right; padding: 16px 0;");const c=document.createElement("button");c.innerHTML="cancel",c.setAttribute("style","width: 85px;"),c.onclick=()=>{document.body.removeChild(d);const e=new Error("NotAllowedError");e.name="NotAllowedError",i(e)},a.appendChild(c),r.appendChild(s),r.appendChild(o),r.appendChild(a);const d=document.createElement("div");d.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),d.appendChild(n),d.appendChild(r),document.body.appendChild(d),e.map((e=>{if(e.id){const i=document.createElement("div");i.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let n=e.thumbnail;const{width:r}=n.getSize();r>1920&&(n=n.resize({width:1920})),i.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+n.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+e.name.replace(/[\u00A0-\u9999<>\&]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))+"</span>",i.onclick=()=>{document.body.removeChild(d),t(e.id)},o.appendChild(i)}}))}))}(t);return await KE(i,e)}async function qE(e){let t=["window","screen"];"application"!==e&&"window"!==e||(t=["window"]),"screen"===e&&(t=["screen"]);const i=JE();if(!i)throw new Ef(yf.ELECTRON_IS_NULL);let n=null;try{var r;n=(null===(r=i.desktopCapturer)||void 0===r?void 0:r.getSources({types:t}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch(e){n=null}n&&n.then||(n=new yh(((e,n)=>{i.desktopCapturer.getSources({types:t},((t,i)=>{t?n(t):e(i)}))})));try{return await n}catch(e){throw new Ef(yf.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,e.toString())}}let zE=null;function JE(){if(zE)return zE;try{return zE=window.require("electron"),zE}catch(e){return null}}function YE(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const XE=new AE("safari");let $E=!1,QE=!1;async function ZE(e,t){let i=0,n=null;for(;i<2;)try{n=await eS(e,t,i>0);break}catch(e){if(e instanceof Ef)throw Pf.error("[".concat(t,"] ").concat(e.toString())),e;const n=tS(e.name||e.code||e,e.message);if(n.code===yf.MEDIA_OPTION_INVALID){Pf.debug("[".concat(t,"] detect media option invalid, retry")),i+=1,await Bb(500);continue}throw Pf.error("[".concat(t,"] ").concat(n.toString())),n}if(!n)throw new Ef(yf.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function eS(e,t,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Ef(yf.NOT_SUPPORTED,"can not find getUserMedia");i&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const n=Vv(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return Pf.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(JE())e.screen.sourceId?iS(r,await KE(e.screen.sourceId,e.screen)):iS(r,await GE(e.screen));else if(Wu()&&e.screen.extensionId&&e.screen.mandatory){if(!n.getStreamFromExtension)throw new Ef(yf.NOT_SUPPORTED,"This browser does not support screen sharing");Pf.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const i=await(o=e.screen.extensionId,a=t,new yh(((e,t)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},(i=>{if(!i||!i.streamId)return Pf.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),i),void t(new Ef(yf.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));e(i.streamId)}))}catch(e){Pf.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),e.toString()),t(new Ef(yf.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=i,iS(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(n.getDisplayMedia){var s;e.screen.mediaSource&&yv(e.screen.mediaSource);const i={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:null!==(s=e.screen.displaySurface)&&void 0!==s?s:"screen"===e.screen.mediaSource?"monitor":e.screen.mediaSource},{selfBrowserSurface:n,surfaceSwitching:o,systemAudio:a}=e.screen,c={selfBrowserSurface:n,surfaceSwitching:o,systemAudio:a};!n&&delete c.selfBrowserSurface,!o&&delete c.surfaceSwitching,!a&&delete c.systemAudio,Pf.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:i,audio:!!e.screenAudio,controls:c})),iS(r,await navigator.mediaDevices.getDisplayMedia(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?YE(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):YE(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({video:i,audio:!!e.screenAudio},c)))}else{if(!Gu())throw Pf.error("[".concat(t,"] This browser does not support screenSharing")),new Ef(yf.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&yv(e.screen.mediaSource);const i={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};Pf.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(i))),iS(r,await navigator.mediaDevices.getUserMedia(i))}}var o,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},d=Kf("MEDIA_DEVICE_CONSTRAINTS");if(d)try{"string"==typeof d&&(d=JSON.parse(d)),c=function e(t,i){if(!dw(t)||!dw(i))return i;if(Array.isArray(t)&&!Array.isArray(i)||!Array.isArray(t)&&Array.isArray(i))return i;if(Array.isArray(i)&&Array.isArray(t)){const n=[...t];for(let r=0;r<i.length;r++)n[r]=e(t[r],i[r]);return n}{const n=jb({},t);for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&(Object.prototype.hasOwnProperty.call(t,r)?n[r]=e(t[r],i[r]):n[r]=i[r]);return n}}(c,d)}catch(e){}Pf.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),Mu();let l,h=null;(Ku()||qu()||Vu())&&(h=await XE.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(e){throw h&&h(),e}return c.audio&&($E=!0),c.video&&(QE=!0),iS(r,l),h&&h(),r}function tS(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new Ef(yf.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new Ef(yf.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new Ef(yf.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new Ef(yf.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new Ef(yf.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new Ef(yf.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return Pf.error("getUserMedia unexpected error",e),new Ef(yf.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function iS(e,t){const i=e.getVideoTracks()[0],n=e.getAudioTracks()[0],r=t.getVideoTracks()[0],s=t.getAudioTracks()[0];s&&(n&&e.removeTrack(n),e.addTrack(s)),r&&(i&&e.removeTrack(i),e.addTrack(r))}const nS=new class extends _f{get state(){return this._state}set state(e){e!==this._state&&(this.emit(v_.STATE_CHANGE,e),this._state=e)}constructor(){super(),fp(this,"_state",__.IDLE),fp(this,"isAccessMicrophonePermission",!1),fp(this,"isAccessCameraPermission",!1),fp(this,"lastAccessMicrophonePermission",!1),fp(this,"lastAccessCameraPermission",!1),fp(this,"checkdeviceMatched",!1),fp(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(Kf("ENUMERATE_DEVICES_INTERVAL")||op()&&sp())&&this.updateDevicesInfo()}),Kf("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>Pf.error(e.toString())))}async enumerateDevices(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new Ef(yf.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(n);let s=!this.isAccessMicrophonePermission&&e,o=!this.isAccessCameraPermission&&t;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,d=null;if(!i&&(s||o)){if(XE.isLocked&&(Pf.debug("[device manager] wait GUM lock"),(await XE.lock())(),Pf.debug("[device manager] GUM unlock")),$E&&(s=!1,this.isAccessMicrophonePermission=!0),QE&&(o=!1,this.isAccessCameraPermission=!0),Pf.debug("[device manager] check media device permissions",e,t,s,o),s&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){const t=tS(e.name||e.code||e,e.message);if(t.code===yf.PERMISSION_DENIED)throw t;Pf.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(e){const t=tS(e.name||e.code||e,e.message);if(t.code===yf.PERMISSION_DENIED)throw t;Pf.warning("getUserMedia failed in getDevices",t)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(e){const t=tS(e.name||e.code||e,e.message);if(t.code===yf.PERMISSION_DENIED)throw t;Pf.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0}Pf.debug("[device manager] mic permission",e,"cam permission",t)}try{const e=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,e}catch(e){return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,new Ef(yf.ENUMERATE_DEVICES_FAILED,e.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audioinput"===e.kind))}async getCamerasDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((e=>"videoinput"===e.kind))}async getSpeakers(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audiooutput"===e.kind))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((i=>{i.device.label===e&&(t=i.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((t=>t.deviceId===e));if(!t)throw new Ef(yf.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=__.INITING;try{await this.updateDevicesInfo(),this.state=__.INITEND}catch(e){throw Pf.warning("Device Detection functionality cannot start properly.",e.toString()),this.state=__.IDLE,function(){return"boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname}()||new Ef(yf.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),i=[];if(e[0]&&e[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const t=e.find((e=>"audioinput"===e.kind&&"default"===e.deviceId)),i=e.find((e=>"audiooutput"===e.kind&&"default"===e.deviceId));t&&i?i.groupId===t.groupId?Pf.debug("[device-check] default input ".concat(t.label," and output ").concat(i.label," is the same group")):Pf.warning("[device-check] default input ".concat(t.label," and output ").concat(i.label," is not the same group")):Pf.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((e=>{if(!e.deviceId)return;const n=this.deviceInfoMap.get("".concat(e.kind,"_").concat(e.deviceId));if("ACTIVE"!==(n?n.state:"INACTIVE")){const n={initAt:t,updateAt:t,device:e,state:"ACTIVE"};this.deviceInfoMap.set("".concat(e.kind,"_").concat(e.deviceId),n),i.push(n)}n&&(n.updateAt=t)})),this.deviceInfoMap.forEach(((e,n)=>{"ACTIVE"===e.state&&e.updateAt!==t&&(e.state="INACTIVE",i.push(e))})),this.state!==__.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach((e=>{switch(e.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(v_.RECORDING_DEVICE_CHANGED,e);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(v_.CAMERA_DEVICE_CHANGED,e);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(v_.PLAYOUT_DEVICE_CHANGED,e)}})),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((e=>"audioinput"===e.kind)),i=e.filter((e=>"videoinput"===e.kind)),n={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){n.audio=!0;break}for(const r of i)if(r.label&&r.deviceId){n.video=!0;break}return n}},rS=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],sS=new class{constructor(){fp(this,"onAutoplayFailed",void 0),fp(this,"elementMap",new Map),fp(this,"elementStateMap",new Map),fp(this,"elementsNeedToResume",[]),fp(this,"sinkIdMap",new Map),fp(this,"autoResumeAfterInterruption",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,i]=e;const n=this.elementStateMap.get(t),r=i.srcObject.getAudioTracks()[0];Qu()?r&&"live"===r.readyState&&"running"===xE.curState&&(Pf.debug("auto resume after interruption for iOS 15"),i.pause(),i.play()):n&&"paused"===n&&r&&"live"===r.readyState&&"running"===xE.curState&&(Pf.debug("auto resume after interruption for iOS"),i.play())}))})),fp(this,"autoResumeAfterInterruptionOnIOS15",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,i]=e;const n=i.srcObject.getAudioTracks()[0];n&&"live"===n.readyState&&(Pf.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())}))})),this.autoResumeAudioElement(),xE.on(RE.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),xE.on(RE.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15),xE.on(RE.STATE_CHANGE,(()=>{qu()&&"suspended"===xE.prevState&&"running"===xE.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const i=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),i)try{await i.setSinkId(t)}catch(e){throw new Ef(yf.PERMISSION_DENIED,"can not set sink id: "+e.toString())}}play(e,t,i,n){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,a_.INIT),this.setVolume(t,i);const s=this.sinkIdMap.get(t);if(s)try{r.setSinkId(s).catch((e=>{Pf.warning("[".concat(t,"] set sink id failed"),e.toString())}))}catch(e){Pf.warning("[".concat(t,"] set sink id failed"),e.toString())}const o=r.play();o&&o.then&&o.catch((e=>{n&&TE.autoplayFailed(n,"audio",e.message,t),Pf.warning("audio element play warning",e.toString()),this.elementMap.has(t)&&"NotAllowedError"===e.name&&(Pf.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),ew((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),_E()})))}))}updateTrack(e,t){const i=this.elementMap.get(e);i&&(i.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)}setVolume(e,t){const i=this.elementMap.get(e);i&&(t=Math.max(0,Math.min(100,t)),i.volume=t/100)}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const i=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(i,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){rS.forEach((i=>{t.addEventListener(i,(i=>{const n=this.elementStateMap.get(e),r="pause"===i.type?"paused":i.type;if(Pf.debug("[".concat(e,"] audio-element-status change ").concat(n," => ").concat(r)),"error"===i.type){const i=null==t?void 0:t.error;i&&Pf.error("[".concat(e,"] media error, code: ").concat(i.code,", message: ").concat(i.message))}this.elementStateMap.set(e,r)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((e=>{e.play().then((e=>{Pf.debug("Auto resume audio element success")})).catch((e=>{Pf.warning("Auto resume audio element failed!",e)}))})),this.elementsNeedToResume=[]};new yh((e=>{document.body?e():window.addEventListener("load",(()=>e()))})).then((()=>{ap()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function oS(){return function(e,t,i){const n=i.value;return"function"==typeof n&&(i.value=function(){this._isClosed&&new Ef(yf.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning");for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const r=n.apply(this,t);return r instanceof yh?new yh(((e,t)=>{r.then(e).catch(t)})):r}),i}}var aS=Gi("Array").values,cS=Zr,dS=We,lS=h,hS=aS,uS=Array.prototype,pS={DOMTokenList:!0,NodeList:!0},mS=function(e){var t=e.values;return e===uS||lS(uS,e)&&t===uS.values||dS(pS,cS(e))?hS:t};function fS(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function gS(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fS(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fS(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class _S extends _f{constructor(e){super(),fp(this,"name","VideoProcessorDestination"),fp(this,"ID","0"),fp(this,"_source",void 0),fp(this,"videoContext",void 0),fp(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new Ef(yf.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new Ef(yf.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Nv.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Nv.ON_TRACK,void 0)}}class vS extends _f{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),fp(this,"constraintsMap",new Map),fp(this,"statsRegistry",[]),fp(this,"usageRegistry",[]),fp(this,"trackId",void 0),fp(this,"direction",void 0),fp(this,"_chained",!1),this.trackId=e,this.direction=t}async getConstraints(){return await Jb(this,Dv.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){var i;return Pf.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),Yb(this,Dv.REQUEST_UPDATE_CONSTRAINTS,Array.from(mS(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return Pf.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Yb(this,Dv.REQUEST_UPDATE_CONSTRAINTS,Array.from(mS(t=this.constraintsMap).call(t)))}registerStats(e,t,i){this.statsRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){const i=this.statsRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:i,type:n,cb:r}of this.statsRegistry)try{const s=r();e.push({processorID:t,processorName:i,type:n,stats:s})}catch(e){Pf.error(new Ef(yf.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let i=t();i instanceof yh&&(i=await i),e.push(gS(gS({},i),{},{direction:this.direction}))}catch(e){Pf.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class yS extends _f{constructor(e){super(),fp(this,"name","AudioProcessorDestination"),fp(this,"ID","0"),fp(this,"inputTrack",void 0),fp(this,"inputNode",void 0),fp(this,"audioProcessorContext",void 0),fp(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new Ef(yf.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new Ef(yf.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Nv.ON_TRACK,void 0),this.emit(Nv.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Nv.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Nv.ON_NODE,this.inputNode))}}class ES extends _f{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,i){super(),fp(this,"constraintsMap",new Map),fp(this,"statsRegistry",[]),fp(this,"audioContext",void 0),fp(this,"trackId",void 0),fp(this,"direction",void 0),fp(this,"usageRegistry",[]),fp(this,"_chained",!1),this.audioContext=e,this.trackId=t,this.direction=i}async getConstraints(){return Jb(this,Dv.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){var i;return Pf.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),Yb(this,Dv.REQUEST_UPDATE_CONSTRAINTS,Array.from(mS(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Yb(this,Dv.REQUEST_UPDATE_CONSTRAINTS,Array.from(mS(t=this.constraintsMap).call(t)))}registerStats(e,t,i){this.statsRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){const i=this.statsRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:i,type:n,cb:r}of this.statsRegistry)try{const s=r();e.push({processorID:t,processorName:i,type:n,stats:s})}catch(e){Pf.error(new Ef(yf.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let i=t();i instanceof yh&&(i=await i),e.push(gS(gS({},i),{},{direction:this.direction}))}catch(e){Pf.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class SS extends _f{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),fp(this,"context",void 0),fp(this,"processSourceNode",void 0),fp(this,"outputTrack",void 0),fp(this,"processedNode",void 0),fp(this,"clonedTrack",void 0),fp(this,"outputNode",void 0),this.outputNode=new bS}setVolume(){}createOutputTrack(){throw new Ef(yf.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class bS{disconnect(){}connect(){}}let wS,TS=null;class CS{constructor(){fp(this,"state","open"),fp(this,"trigger",void 0),fp(this,"tasks",[]),Pf.debug("[macro-task-queue] is created."),this.trigger=setTimeout((()=>{this.state="closed",Pf.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map((e=>e.key)),"]")),this.trigger=void 0,this.tasks.forEach((e=>{let{func:t}=e;return t()})),this.tasks.length=0,Pf.debug("[macro-task-queue] is closed.")}))}enqueue(e,t){"closed"!==this.state&&(this.tasks.push({key:e,func:t}),Pf.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof e?e:"")))}runTask(e){if("closed"===this.state)return;const t=this.tasks.findIndex((t=>t.key===e));if(-1!==t){const i=this.tasks.splice(t,1);Pf.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof e?e:"")),i[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,Pf.debug("[macro-task-queue] is closed."))}}function RS(e){return function(t,i,n){var r;const s=null!==(r=n.value)&&void 0!==r?r:n.get,o=function(){TS&&"open"===TS.state&&TS.runTask(e);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return null==s?void 0:s.apply(this,...i)};return n.value?n.value=o:n.get=o,n}}var IS,AS,PS,OS,NS,DS,kS,xS,LS,MS,FS,US,jS,VS,BS,HS,WS,KS,GS,qS,zS,JS,YS,XS,$S,QS,ZS,eb,tb,ib,nb,rb,sb,ob,ab,cb,db,lb,hb,ub;function pb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function mb(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?pb(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pb(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}!function(e){e.UPDATE_TRACK_SOURCE="update-track-source"}(wS||(wS={}));let fb=(IS=RS("INIT_WEBAUDIO"),AS=RS("INIT_WEBAUDIO"),PS=RS("INIT_WEBAUDIO"),OS=wE({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),NS=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),DS=oS(),kS=PE("LocalAudioTrack","_enabledMutex"),xS=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),LS=oS(),MS=PE("LocalAudioTrack","_enabledMutex"),FS=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),US=oS(),jS=oS(),VS=oS(),BS=wE({argsMap:e=>[e.getTrackId()]}),HS=oS(),WS=wE({argsMap:e=>[e.getTrackId()]}),KS=oS(),GS=wE({argsMap:e=>[e.getTrackId()]}),qS=wE({argsMap:(e,t)=>[e.getTrackId(),t.name]}),zS=wE({argsMap:e=>[e.getTrackId()]}),Zy((JS=class extends OE{get _source(){return this._trackSource}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get processorDestination(){return this._processorDestination}set processorDestination(e){this._processorDestination=e}get isPlaying(){return this._useAudioElement?sS.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,i,n,r){super(e,i),fp(this,"trackMediaType","audio"),fp(this,"_encoderConfig",void 0),fp(this,"_trackSource",void 0),fp(this,"_enabled",!0),fp(this,"_volume",100),fp(this,"_useAudioElement",!1),fp(this,"_bypassWebAudio",!1),fp(this,"processor",void 0),fp(this,"_processorContext",void 0),fp(this,"_processorDestination",void 0),fp(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!n;const s=()=>{this.processorContext=new ES(this._source.context,this.getTrackId(),"local"),this.processorDestination=new yS(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(x_.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))},o=r&&Ku()&&!FE();Kf("DISABLE_WEBAUDIO")?(this._source=new SS,this._useAudioElement=!0,this._bypassWebAudio=!0):o?this._source=new SS:(this._source=new WE(e,!1,this._getOriginVolumeLevel?e:void 0),Kf("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),s(),!Kf("DISABLE_WEBAUDIO")&&o&&(TS||(TS=new CS),TS).enqueue("INIT_WEBAUDIO",(()=>{this._source=new WE(e,!1,this._getOriginVolumeLevel?e:void 0),Kf("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),s(),this.emit(wS.UPDATE_TRACK_SOURCE)}))}setVolume(e){Yg(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&sS.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void Pf.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Yb(this,hv.NEED_REPLACE_TRACK,this).then((()=>{Pf.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((e=>{Pf.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),e)})))}catch(e){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement)throw new Ef(yf.NOT_SUPPORTED,"your browser does not support setting the audio output device");await sS.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,i){return this._setEnabled(e,t,i)}async _setEnabled(e,t,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Pf.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await Yb(this,hv.NEED_ENABLE_TRACK,this),Pf.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(e){throw i||(this._enabled=!1),Pf.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await Yb(this,hv.NEED_DISABLE_TRACK,this)}catch(e){throw i||(this._enabled=!0),Pf.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,Pf.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Yb(this,hv.NEED_MUTE_TRACK,this):await Yb(this,hv.NEED_UNMUTE_TRACK,this))}getStats(){nw((()=>{Pf.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning");const e=Xb(this,hv.GET_STATS);return e||mb({},V_)}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(x_.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(x_.ON_AUDIO_BUFFER),this._source.on(x_.ON_AUDIO_BUFFER,(t=>e(t)))}play(){Pf.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(Pf.debug("[".concat(this.getTrackId(),"] start audio playback in element")),sS.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){Pf.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?sS.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Pf.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&sS.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e.addEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop(),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:e,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Yb(this,hv.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return yh.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new Ef(yf.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new Ef(yf.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Nv.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Yb(this,hv.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Yb(this,hv.NEED_REPLACE_TRACK,this))})),this.processorDestination.on(Nv.ON_NODE,(e=>{this._source.processedNode=e}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Nv.ON_TRACK),this.processorDestination.removeAllListeners(Nv.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Dv.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Dv.REQUEST_CONSTRAINTS)}}).prototype,"_source",[IS],Object.getOwnPropertyDescriptor(JS.prototype,"_source"),JS.prototype),Zy(JS.prototype,"processorContext",[AS],Object.getOwnPropertyDescriptor(JS.prototype,"processorContext"),JS.prototype),Zy(JS.prototype,"processorDestination",[PS],Object.getOwnPropertyDescriptor(JS.prototype,"processorDestination"),JS.prototype),Zy(JS.prototype,"setVolume",[OS],Object.getOwnPropertyDescriptor(JS.prototype,"setVolume"),JS.prototype),Zy(JS.prototype,"setPlaybackDevice",[NS,DS],Object.getOwnPropertyDescriptor(JS.prototype,"setPlaybackDevice"),JS.prototype),Zy(JS.prototype,"setEnabled",[kS,xS,LS],Object.getOwnPropertyDescriptor(JS.prototype,"setEnabled"),JS.prototype),Zy(JS.prototype,"setMuted",[MS,FS,US],Object.getOwnPropertyDescriptor(JS.prototype,"setMuted"),JS.prototype),Zy(JS.prototype,"getStats",[jS],Object.getOwnPropertyDescriptor(JS.prototype,"getStats"),JS.prototype),Zy(JS.prototype,"setAudioFrameCallback",[VS],Object.getOwnPropertyDescriptor(JS.prototype,"setAudioFrameCallback"),JS.prototype),Zy(JS.prototype,"play",[BS,HS],Object.getOwnPropertyDescriptor(JS.prototype,"play"),JS.prototype),Zy(JS.prototype,"stop",[WS,KS],Object.getOwnPropertyDescriptor(JS.prototype,"stop"),JS.prototype),Zy(JS.prototype,"close",[GS],Object.getOwnPropertyDescriptor(JS.prototype,"close"),JS.prototype),Zy(JS.prototype,"pipe",[qS],Object.getOwnPropertyDescriptor(JS.prototype,"pipe"),JS.prototype),Zy(JS.prototype,"unpipe",[zS],Object.getOwnPropertyDescriptor(JS.prototype,"unpipe"),JS.prototype),JS),gb=(YS=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),XS=oS(),$S=PE("MicrophoneAudioTrack","_enabledMutex"),QS=wE({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),ZS=oS(),eb=wE({argsMap:e=>[e.getTrackId()]}),Zy((tb=class extends fb{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,i,n){super(e,t.encoderConfig?Hf(t.encoderConfig):{},n,Kf("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),fp(this,"_config",void 0),fp(this,"_deviceName","default"),fp(this,"_constraints",void 0),fp(this,"_originalConstraints",void 0),fp(this,"_enabled",!0),this._config=t,this._constraints=i,this._originalConstraints=i,this._deviceName=e.label,"boolean"==typeof t.bypassWebAudio&&(this._bypassWebAudio=t.bypassWebAudio),Qu()&&xE.bindInterruptDetectorTrack(this),this.on(wS.UPDATE_TRACK_SOURCE,(()=>{this.bindProcessorContextEvents()})),FE()&&this.bindProcessorContextEvents()}async setDevice(e){if(Pf.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await nS.getDeviceById(e),i={};i.audio=mb({},this._constraints),i.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let n=null;try{n=await ZE(i,this.getTrackId())}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),n=await ZE({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await nS.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,i){if(t)return Pf.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Pf.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(n=this._source.clonedTrack)||void 0===n||n.stop(),i||(this._enabled=!1);try{await Yb(this,hv.NEED_DISABLE_TRACK,this)}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setEnabled false failed"),e.toString()),e}return}const r=mb({},this._constraints),s=nS.searchDeviceIdByName(this._deviceName);s&&!r.deviceId&&(r.deviceId=s);try{i||(this._enabled=!0);const e=await ZE({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!1),await Yb(this,hv.NEED_ENABLE_TRACK,this)}catch(e){throw i||(this._enabled=!1),Pf.error("[".concat(this.getTrackId(),"] setEnabled true failed"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),Qu()&&xE.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((qu()||ip())&&this._enabled&&!this._isClosed&&xE.duringInterruption){const e=async()=>{xE.off(RE.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Pf.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};xE.on(RE.IOS_INTERRUPTION_END,e)}else Pf.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(fv.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,i=nS.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId=i),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const e=await ZE({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(Dv.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,i)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),t()}catch(e){i(e)}})),this.processorContext.on(Dv.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}}).prototype,"setDevice",[YS,XS],Object.getOwnPropertyDescriptor(tb.prototype,"setDevice"),tb.prototype),Zy(tb.prototype,"setEnabled",[$S,QS,ZS],Object.getOwnPropertyDescriptor(tb.prototype,"setEnabled"),tb.prototype),Zy(tb.prototype,"close",[eb],Object.getOwnPropertyDescriptor(tb.prototype,"close"),tb.prototype),tb),_b=(ib=wE({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),nb=oS(),rb=wE({argsMap:e=>[e.getTrackId()]}),sb=oS(),ob=wE({argsMap:e=>[e.getTrackId()]}),ab=oS(),cb=wE({argsMap:e=>[e.getTrackId()]}),db=oS(),lb=wE({argsMap:e=>[e.getTrackId()]}),hb=oS(),Zy((ub=class extends fb{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,i,n){super(t.createOutputTrack(),i,n),fp(this,"source",void 0),fp(this,"_bufferSource",void 0),this.source=e,this._bufferSource=t,this._bufferSource.on(x_.AUDIO_SOURCE_STATE_CHANGE,(e=>{this.emit(fv.SOURCE_STATE_CHANGE,e)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}}).prototype,"startProcessAudioBuffer",[ib,nb],Object.getOwnPropertyDescriptor(ub.prototype,"startProcessAudioBuffer"),ub.prototype),Zy(ub.prototype,"pauseProcessAudioBuffer",[rb,sb],Object.getOwnPropertyDescriptor(ub.prototype,"pauseProcessAudioBuffer"),ub.prototype),Zy(ub.prototype,"seekAudioBuffer",[ob,ab],Object.getOwnPropertyDescriptor(ub.prototype,"seekAudioBuffer"),ub.prototype),Zy(ub.prototype,"resumeProcessAudioBuffer",[cb,db],Object.getOwnPropertyDescriptor(ub.prototype,"resumeProcessAudioBuffer"),ub.prototype),Zy(ub.prototype,"stopProcessAudioBuffer",[lb,hb],Object.getOwnPropertyDescriptor(ub.prototype,"stopProcessAudioBuffer"),ub.prototype),ub);class vb extends fb{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=ME().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Wb(8,"track-mix-")),fp(this,"trackList",void 0),fp(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return-1!==this.trackList.indexOf(e)}addAudioTrack(e){-1===this.trackList.indexOf(e)?(Pf.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):Pf.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(-1!==this.trackList.indexOf(e)){Pf.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch(e){}Qb(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach((t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))})),this._encoderConfig=e}}class yb extends _f{constructor(){super(...arguments),fp(this,"resultStorage",new Map)}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){const i=n.result.includes(!0);n.isPrevNormal&&!i&&this.emit("exception",Eb[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",Eb[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof vb&&!t.isActive||!!t.muted||0!==e.sendVolumeLevel}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=Ob(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof vb&&!t.isActive||!!t.muted||0!==e.sendBitrate}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const Eb={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Sb=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function bb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function wb(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?bb(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):bb(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Tb{constructor(e){fp(this,"store",void 0),fp(this,"onStatsException",void 0),fp(this,"onUploadPublishDuration",void 0),fp(this,"localStats",new Map),fp(this,"remoteStats",new Map),fp(this,"updateStatsInterval",void 0),fp(this,"trafficStats",void 0),fp(this,"trafficStatsPeerList",[]),fp(this,"uplinkStats",void 0),fp(this,"exceptionMonitor",void 0),fp(this,"p2pChannel",void 0),fp(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new yb,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Rv.LocalAudioTrack)||wb({},V_)}getLocalVideoTrackStats(){return this.localStats.get(Rv.LocalVideoTrack)||wb({},B_)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const r=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;r&&(i[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:r}]=e;r&&(i[n]=t(n,r))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const r=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;r&&(i[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:r}]=e;r&&(i[n]=t(n,r))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const r=this.localStats.get(Rv.LocalAudioTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate);const s=this.localStats.get(Rv.LocalVideoTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(Rv.LocalVideoLowTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:r}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),r&&(i+=r.receiveBytes,n+=r.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd)),e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?Sb.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,r=null!=i&&i.audioSSRC?Sb.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>r?n:r),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&Pf.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,r=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!r}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((t=>{let[i,n]=t;switch(i){case Rv.LocalVideoTrack:case Rv.LocalVideoLowTrack:{const t=n,r=wb({},B_),s=e.getStats(),o=e.getLocalMedia(i);if(s){const i=s.videoSend.find((e=>e.ssrc===(null==o?void 0:o.ssrcs[0].ssrcId)));if(i){const n=e.getLocalVideoSize(),s=e.getEncoderConfig(Rv.LocalVideoTrack);"H264"!==i.codec&&"VP8"!==i.codec&&"VP9"!==i.codec&&"AV1X"!==i.codec&&"AV1"!==i.codec||(r.codecType=i.codec),r.sendBytes=i.bytes,r.sendBitrate=t?8*Math.max(0,r.sendBytes-t.sendBytes):0,i.inputFrame?(r.captureFrameRate=i.inputFrame.frameRate,r.captureResolutionHeight=i.inputFrame.height,r.captureResolutionWidth=i.inputFrame.width):n&&(r.captureResolutionWidth=n.width,r.captureResolutionHeight=n.height),i.sentFrame?(r.sendFrameRate=i.sentFrame.frameRate,r.sendResolutionHeight=i.sentFrame.height,r.sendResolutionWidth=i.sentFrame.width):n&&(r.sendResolutionWidth=n.width,r.sendResolutionHeight=n.height),i.avgEncodeMs&&(r.encodeDelay=i.avgEncodeMs),s&&s.bitrateMax&&(r.targetSendBitrate=1e3*s.bitrateMax),r.sendPackets=i.packets,r.sendPacketsLost=i.packetsLost,r.totalDuration=t?t.totalDuration+1:1,r.totalFreezeTime=t?t.totalFreezeTime:0,this.isLocalVideoFreeze(i)&&(r.totalFreezeTime+=1)}this.trafficStats&&(r.sendPacketsLost=this.trafficStats.B_pvlr4/100)}this.localStats.set(i,r),r&&o&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,o.track,r);break}case Rv.LocalAudioTrack:{const t=n,r=wb({},V_),s=e.getStats(),o=e.getLocalMedia(i);if(s){const i=s.audioSend.find((e=>e.ssrc===(null==o?void 0:o.ssrcs[0].ssrcId)));if(i){if("opus"!==i.codec&&"aac"!==i.codec&&"PCMU"!==i.codec&&"PCMA"!==i.codec&&"G722"!==i.codec||(r.codecType=i.codec),i.inputLevel)r.sendVolumeLevel=Math.round(32767*i.inputLevel);else{const t=e.getLocalAudioVolume();t&&(r.sendVolumeLevel=Math.round(32767*t))}r.sendBytes=i.bytes,r.sendPackets=i.packets,r.sendPacketsLost=i.packetsLost,r.sendBitrate=t?8*Math.max(0,r.sendBytes-t.sendBytes):0}}this.trafficStats&&(r.sendPacketsLost=this.trafficStats.B_pvlr4/100),this.localStats.set(Rv.LocalAudioTrack,r),r&&o&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,o.track,r);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{let[i,{videoStats:n,audioStats:r,videoPcStats:s}]=t;const o=r,a=n,c=s,d=wb({},H_),l=wb({},K_),h=wb({},W_),{audioTrack:u,videoTrack:p,audioSSRC:m,videoSSRC:f}=e.getRemoteMedia(i),g=e.getStats(),_=null==g?void 0:g.audioRecv.find((e=>e.ssrc===m)),v=null==g?void 0:g.videoRecv.find((e=>e.ssrc===f)),y=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===i));if(_&&("opus"!==_.codec&&"aac"!==_.codec&&"PCMU"!==_.codec&&"PCMA"!==_.codec&&"G722"!==_.codec||(d.codecType=_.codec),_.outputLevel?d.receiveLevel=Math.round(32767*_.outputLevel):u&&(d.receiveLevel=Math.round(32767*u.getVolumeLevel())),d.receiveBytes=_.bytes,d.receivePackets=_.packets,d.receivePacketsLost=_.packetsLost,d.packetLossRate=d.receivePacketsLost/(d.receivePackets+d.receivePacketsLost),d.receiveBitrate=o?8*Math.max(0,d.receiveBytes-o.receiveBytes):0,d.totalDuration=o?o.totalDuration+1:1,d.totalFreezeTime=o?o.totalFreezeTime:0,d.freezeRate=d.totalFreezeTime/d.totalDuration,d.receiveDelay=_.jitterBufferMs,d.totalDuration>10&&Tb.isRemoteAudioFreeze(u)&&(d.totalFreezeTime+=1)),v){"H264"!==v.codec&&"VP8"!==v.codec&&"VP9"!==v.codec&&"AV1X"!==v.codec&&"AV1"!==v.codec||(l.codecType=v.codec),l.receiveBytes=v.bytes,l.receiveBitrate=a?8*Math.max(0,l.receiveBytes-a.receiveBytes):0,l.decodeFrameRate=v.decodeFrameRate<0?0:v.decodeFrameRate,l.renderFrameRate=v.decodeFrameRate<0?0:v.decodeFrameRate,v.outputFrame&&(l.renderFrameRate=v.outputFrame.frameRate),v.receivedFrame?(l.receiveFrameRate=v.receivedFrame.frameRate,l.receiveResolutionHeight=v.receivedFrame.height,l.receiveResolutionWidth=v.receivedFrame.width):p&&(l.receiveResolutionHeight=p._videoHeight||0,l.receiveResolutionWidth=p._videoWidth||0),void 0!==v.framesRateFirefox&&(l.receiveFrameRate=Math.round(v.framesRateFirefox)),l.receivePackets=v.packets,l.receivePacketsLost=v.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.totalDuration=a?a.totalDuration+1:1,l.totalFreezeTime=a?a.totalFreezeTime:0,l.receiveDelay=v.jitterBufferMs||0;const t=!!f&&e.getRemoteVideoIsReady(f);p&&t&&Tb.isRemoteVideoFreeze(p,v,c)&&(l.totalFreezeTime+=1),l.freezeRate=l.totalFreezeTime/l.totalDuration}y&&(d.end2EndDelay=y.B_ad,l.end2EndDelay=y.B_vd,d.transportDelay=y.B_ed,l.transportDelay=y.B_ed,d.currentPacketLossRate=y.B_ealr4/100,l.currentPacketLossRate=y.B_evlr4/100,h.uplinkNetworkQuality=y.B_punq?y.B_punq:0,h.downlinkNetworkQuality=y.B_pdnq?y.B_pdnq:0),this.remoteStats.set(i,{audioStats:d,videoStats:l,videoPcStats:v,networkStats:h}),u&&this.exceptionMonitor.setRemoteAudioStats(u,d),p&&this.exceptionMonitor.setRemoteVideoStats(p,l)}))}}const Cb=new class extends _f{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),fp(this,"_lastHiddenTime",0),fp(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),Pf.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};function Rb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ib(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Rb(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Rb(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Ab(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(Kf("TURN_DOMAIN")):(Pf.info("Cannot recognized as IP address ".concat(e,". Used As Host instead")),e)}function Pb(e,t){var i,n;const r=Kf("GATEWAY_DOMAINS");let s=r[1]&&-1!==t.indexOf(r[1])?1:0;e.addresses=e.addresses||[];const o=e.addresses.map((e=>e.domain_prefix?{address:"".concat(e.domain_prefix,".").concat(r[s++%r.length],":").concat(e.port)}:e.ip.match(/^[\.\:\d]+$/)?{ip:e.ip,port:e.port,address:"".concat(e.ip.replace(/[^\d]/g,"-"),".").concat(r[s++%r.length],":").concat(e.port)}:(Pf.info("Cannot recognized as IP address ".concat(e.ip,". Used As Host instead")),{ip:e.ip,port:e.port,address:"".concat(e.ip,":").concat(e.port)})));if(null!==(i=e.detail)&&void 0!==i&&i[18]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[18])){const t=e.detail[18],i=null==t?void 0:t.split(";");for(let e=0;e<i.length;e++){var a;const t=_u(a=i[e]).call(a);o[e]&&t&&(o[e].ip6=t)}}return{gatewayAddrs:o,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function Ob(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function Nb(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(Ob(t.width),"x").concat(Ob(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function Db(e,t,i){var n,r,s,o,a,c,d,l;const h=t.videoSend.find((t=>t.ssrc===e));if(!h)return null;const u={id:Wb(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:h.ssrc.toString()},p=null!==(n=null!==(r=null===(s=h.inputFrame)||void 0===s?void 0:s.height)&&void 0!==r?r:null==i?void 0:i._videoHeight)&&void 0!==n?n:0,m=null!==(o=null!==(a=null===(c=h.inputFrame)||void 0===c?void 0:c.width)&&void 0!==a?a:null==i?void 0:i._videoWidth)&&void 0!==o?o:0,f=null!==(d=null===(l=h.inputFrame)||void 0===l?void 0:l.frameRate)&&void 0!==d?d:0;return p&&(u.A_fhi=p+""),m&&(u.A_fwi=m+""),f&&(u.A_fri=f+""),u}function kb(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function xb(e,t){let i,n,r;switch(t){case Bv.CHOOSE_SERVER:i=4096,n="choose server";break;case Bv.CLOUD_PROXY:i=1048576,n="proxy";break;case Bv.CLOUD_PROXY_5:i=4194304,n="proxy5";break;case Bv.CLOUD_PROXY_FALLBACK:i=4194310,n="proxy fallback";break;default:throw new Ef(yf.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===i&&(r={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>Ib(Ib({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:Ib(Ib({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!r)throw new Ef(yf.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(n," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return r}async function Lb(e,t){return await yh.all(e.addresses.map((async e=>({address:Ab(e.ip),tcpport:e.port,udpport:e.port,username:t&&Kf("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():xf.username,password:t&&Kf("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await EE(t.toString()):xf.password}))))}function Mb(e,t){const i=t._videoWidth||t.getMediaStreamTrack(!0).getSettings().width;return i||Pf.warning("cannot get original video track's width, default scale down 4 times for low stream"),i?i/Ob(e.width):4}function Fb(e){let{candidateType:t,relayProtocol:i,type:n,address:r,port:s,protocol:o}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:o}:{candidateType:t,relayProtocol:i,address:r,port:s,protocol:o}}function Ub(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function jb(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ub(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ub(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Vb(e){return window.TextEncoder?(new TextEncoder).encode(e).length:e.length}function Bb(e){return new yh((t=>{window.setTimeout(t,e)}))}function Hb(e){const t=new Ef(yf.TIMEOUT,"timeout");return new yh(((i,n)=>{window.setTimeout((()=>n(t)),e)}))}function Wb(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,e).toLowerCase();return i.length===e?"".concat(t).concat(i):"".concat(t).concat(i)+Wb(e-i.length,"")}function Kb(){return Wb(32,"").toUpperCase()}const Gb=()=>{};function qb(e){return new yh(((t,i)=>{let n=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=qu()?"canplay":"playing";r.addEventListener(s,(()=>{const e=r.videoWidth,i=r.videoHeight;!e&&Gu()||(n=!0,r.srcObject=null,r.remove(),t([e,i]))})),r.srcObject=new MediaStream([e]),r.play().catch(Gb),setTimeout((()=>{n||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))}),4e3)}))}function zb(e){return yh.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}function Jb(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return 0===e.getListeners(t).length?yh.reject(new Ef(yf.UNEXPECTED_ERROR,"can not emit promise")):new yh(((i,r)=>{e.emit(t,...n,i,r)}))}function Yb(e,t){if(0===e.getListeners(t).length)return yh.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return Jb(e,t,...n)}function Xb(e,t){if(0===e.getListeners(t).length)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return $b(e,t,...n)}function $b(e,t){let i=null,n=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(e.emit(t,...s,(e=>{i=e}),(e=>{n=e})),null!==n)throw n;if(null===i)throw new Ef(yf.UNEXPECTED_ERROR,"handler is not sync");return i}function Qb(e,t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}function Zb(e){const t=[];return e.forEach((e=>{-1===t.indexOf(e)&&t.push(e)})),t}function ew(e){yh.resolve().then(e)}function tw(e){return JSON.parse(JSON.stringify(e))}const iw={};function nw(e,t){iw[t]||(iw[t]=!0,e())}function rw(e){const t=window.atob(e),i=new Uint8Array(new ArrayBuffer(t.length));for(let n=0;n<t.length;n+=1)i[n]=t.charCodeAt(n);return i}function sw(e){let t="";for(let i=0;i<e.length;i+=1)t+=String.fromCharCode(e[i]);return window.btoa(t)}const ow=new class{constructor(){fp(this,"fnMap",new Map)}throttleByKey(e,t,i,n){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(t)){const r=this.fnMap.get(t);if(r.threshold!==i){r.fn(...r.args),clearTimeout(r.timer);const o=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),i);this.fnMap.set(t,{fn:e,threshold:i,timer:o,args:s,skipFn:n})}else r.skipFn&&r.skipFn(...r.args),this.fnMap.set(t,jb(jb({},r),{},{fn:e,args:s,skipFn:n}))}else{const r=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),i);this.fnMap.set(t,{fn:e,threshold:i,timer:r,args:s,skipFn:n})}}},aw=ow.throttleByKey.bind(ow),cw=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:r,promisesCollector:s}=e,o=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=o*a,t=e+a;return i.slice(e,t).map(n)})();s&&s.push(...e);try{c=await zb(e)}catch(e){if(d+=a,o++,!(d>=i.length))return void await l();r(e)}e.forEach((e=>e.cancel()))};return await l(),c};function dw(e){return"object"==typeof e&&null!==e&&!(e instanceof RegExp)}const lw={[y_.ACCESS_POINT]:{[b_.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[b_.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[b_.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[b_.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[b_.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[b_.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voice service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[b_.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[y_.UNILBS]:{[S_.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[S_.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[S_.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[S_.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[S_.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[S_.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[S_.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[S_.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[S_.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[S_.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[S_.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[S_.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[y_.STRING_UID_ALLOCATOR]:{[E_.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[E_.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[E_.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function hw(e){const t=lw[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===y_.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const uw={[w_.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[w_.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[w_.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[w_.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[w_.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[w_.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[w_.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[w_.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[w_.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[w_.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[w_.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[w_.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[w_.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[w_.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[w_.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[w_.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[w_.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[w_.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[w_.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[w_.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[w_.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[w_.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[w_.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[w_.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[w_.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[w_.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[w_.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[w_.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[w_.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[w_.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[w_.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[w_.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[w_.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[w_.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[w_.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[w_.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[w_.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[w_.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[w_.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[w_.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[w_.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[w_.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[w_.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[w_.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[w_.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[w_.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[w_.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[w_.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[w_.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[w_.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[w_.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[w_.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[w_.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[w_.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[w_.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[w_.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[w_.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[w_.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[w_.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[w_.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[w_.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[w_.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[w_.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[w_.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function pw(e){const t=uw[e];return t||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function mw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class fw extends _f{get url(){return this.websocket?this.websocket.url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(G_.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(G_.CONNECTED):"closed"===this._state?this.emit(G_.CLOSED):"failed"===this._state&&this.emit(G_.FAILED))}resetReconnectCount(e){Pf.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4?arguments[4]:void 0;super(),fp(this,"connectionID",0),fp(this,"currentURLIndex",0),fp(this,"urls",void 0),fp(this,"_reconnectMode","tryNext"),fp(this,"reconnectReason",void 0),fp(this,"_initMutex",new AE("websocket")),fp(this,"name",void 0),fp(this,"_state","closed"),fp(this,"reconnectInterrupter",void 0),fp(this,"websocket",void 0),fp(this,"retryConfig",void 0),fp(this,"reconnectCount",0),fp(this,"forceCloseTimeout",5e3),fp(this,"onlineReconnectListener",void 0),fp(this,"useCompress",void 0),fp(this,"tryDoubleDomain",!1),fp(this,"wsInflateLength",0),fp(this,"wsDeflateLength",0),fp(this,"closeEstablishingWs",(()=>{})),fp(this,"store",void 0),fp(this,"joinChannelServiceRecordIndex",void 0),this.store=r,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?mw(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):mw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this.useCompress=i,this.tryDoubleDomain=n;const{timeout:s,timeoutFactor:o}=t,a=Math.max(300,Math.floor(3*s/5)),c=Math.max(1.2,Math.floor(8*o)/10);Pv.ONLINE&&(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c),mE.on(Ov.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===Pv.ONLINE?(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c):(this.retryConfig.timeout=s,this.retryConfig.timeoutFactor=o))}))}getConnection(){return this.websocket||void 0}init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this.forceCloseTimeout=t;const i=(t,i)=>{this.urls=e;const n=this.urls[this.currentURLIndex];this.state="connecting",this.createWebSocketConnection(n).then(t).catch(i),this.once(G_.CLOSED,(()=>i(new Ef(yf.WS_DISCONNECT)))),this.once(G_.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new yh(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void Pf.warning("[".concat(this.name,"] can not reconnect, no websocket"));var i;void 0!==e&&(this.reconnectMode=e),Pf.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinChannelServiceRecordIndex&&(null===(i=this.store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinChannelServiceRecordIndex));const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Ef(yf.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new Ef(yf.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e,t){return this.connectionID+=1,this.connectionID,this.joinChannelServiceRecordIndex=void 0,new yh(((i,n)=>{var r;const s=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),Pf.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},o=async e=>{if(Pf.debug("[".concat(this.name,"] websocket close ").concat(this.websocket&&this.websocket.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount<this.retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=Xb(this,G_.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,r=await this.reconnectWithAction(t);if("closed"===this.state)return void Pf.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!r)return n(new Ef(yf.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),void this.close(!0);i()}else n(new Ef(yf.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close()},a=e=>{this.emit(G_.ON_MESSAGE,e)};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Kf("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=Kf("GATEWAY_WSS_ADDRESS")),Pf.debug("[".concat(this.name,"] start connect, url: ").concat(e));const c=null===(r=this.store)||void 0===r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});this.chooseBestWebsocketConnection(e,!!t,c).then((e=>{var t;this.websocket=e,s&&s(e.url),e.onclose=o,e.onmessage=a,null===(t=this.store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinChannelServiceRecordIndex=c})).catch((e=>{var t;if(null===(t=this.store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:e instanceof Ef&&e.code===yf.WS_ABORT?"aborted":"error",errors:[e]},c),"closed"!==this.state){if(e instanceof Ef&&e.code===yf.WS_ERR){const t=new Ef(yf.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return Pf.error("[".concat(this.name,"]").concat(t)),void n(t)}o&&o(e)}else n(new Ef(yf.WS_DISCONNECT,"websocket is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(!this.urls)return!1;if("closed"===this.state)return!1;this.onlineReconnectListener||mE.networkState!==Pv.OFFLINE||(this.onlineReconnectListener=mE.onlineWaiter&&mE.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>{i=!1},t){const t=bf(this.reconnectCount,this.retryConfig);Pf.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await yh.race([Bb(t),this.onlineReconnectListener||new yh((()=>{}))])}if("closed"===this.state||!i)return!1;this.reconnectCount+=1;const n=async(e,t)=>{this.emit(G_.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e){const t=this.urls[this.currentURLIndex];this.emit(G_.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return await this.reconnectWithAction("recover",!1);Pf.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex));const t=this.urls[this.currentURLIndex];this.emit(G_.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else if("recover"===e){Pf.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(G_.RECONNECT_WAITTING_FINISH,e),this.urls=await Jb(this,G_.REQUEST_NEW_URLS),this.currentURLIndex=0;const t=this.urls[this.currentURLIndex];await n(t,e)}return!0}catch(i){var r;return Pf.error("[".concat(this.name,"] reconnect failed"),i.toString()),null!=i&&null!==(r=i.data)&&void 0!==r&&r.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(G_.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}async chooseBestWebsocketConnection(e,t,i){return new yh(((n,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{Pf.debug("[choose-best-ws] close establishing websockets"),o.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),r(new Ef(yf.WS_ABORT,"choose best websocket aborted"))};const a=Kf("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),l=a.find((t=>-1!==d?e.includes(t,d):e.includes(t)));Pf.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let h=!this.tryDoubleDomain||t||!l;if(!h&&l){var u;const t=Date.now();try{a.forEach((t=>{const i=-1===d?e.replace(l,t):e.substr(0,d)+e.substr(d).replace(l,t),n=new WebSocket(i);n.binaryType="arraybuffer",o.push(n),Pf.debug("[choose-best-ws] ws is connecting:",n.url)}))}catch(e){for(Pf.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((e=>e.close()));o.length;)o.pop();h=!0}null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},i),o.forEach((e=>{e.onopen=()=>{if(s)return;const i=Date.now()-t;Pf.debug("[choose-best-ws] ws open cost ".concat(i,"ms")),o.filter((t=>t!==e)).forEach((e=>{Pf.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),s=!0,n(e)},e.onclose=e=>{c=e,s||o.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(Pf.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c))},e.onmessage=t=>{Pf.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))}})),Bb(this.forceCloseTimeout).then((()=>{o.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(h){var p;let t;Pf.debug("[choose-best-ws] use single url: ",e),null===(p=this.store)||void 0===p||p.recordJoinChannelService({urls:[e],service:"gateway"},i);try{t=new WebSocket(e),o.push(t),t.binaryType="arraybuffer"}catch(e){const i=new Ef(yf.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return Pf.error("[".concat(this.name,"]").concat(i)),void r(i)}t.onopen=()=>{n(t)},t.onclose=e=>{r(e)},t.onmessage=e=>{Pf.debug("[choose-best-ws]".concat(t.url," onmessage: ").concat(e.data))},Bb(this.forceCloseTimeout).then((()=>{t&&t.readyState!==WebSocket.OPEN&&t.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class gw{constructor(e){fp(this,"input",[]),fp(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return 0===this.input.length?0:$i(e=this.input).call(e,((e,t)=>e+t))/this.input.length}}class _w extends _f{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===A_.CONNECTED?this.emit(P_.WS_CONNECTED):e===A_.RECONNECTING?this.emit(P_.WS_RECONNECTING,this._websocketReconnectReason):e===A_.CLOSED&&this.emit(P_.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),fp(this,"_disconnectedReason",void 0),fp(this,"_websocketReconnectReason",void 0),fp(this,"_connectionState",A_.CLOSED),fp(this,"reconnectToken",void 0),fp(this,"websocket",void 0),fp(this,"openConnectionTime",void 0),fp(this,"clientId",void 0),fp(this,"lastMsgTime",Date.now()),fp(this,"uploadCache",[]),fp(this,"uploadCacheInterval",void 0),fp(this,"rttRolling",new gw(5)),fp(this,"pingpongTimer",void 0),fp(this,"wsInflateDataTimer",void 0),fp(this,"pingpongTimeoutCount",0),fp(this,"joinResponse",void 0),fp(this,"multiIpOption",void 0),fp(this,"initError",void 0),fp(this,"spec",void 0),fp(this,"store",void 0),fp(this,"onWebsocketMessage",(e=>{if(e.data instanceof ArrayBuffer)return void this.emit(P_.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===D_.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===D_.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(C_.UID_BANNED);break;case 15:this.close(C_.IP_BANNED);break;case 16:this.close(C_.CHANNEL_BANNED)}if(t._type===D_.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case w_.ERR_LICENSE_MISSING:this.close(C_.LICENSE_MISSING);break;case w_.ERR_LICENSE_EXPIRED:this.close(C_.LICENSE_EXPIRED);break;case w_.ERR_LICENSE_MINUTES_EXCEEDED:this.close(C_.LICENSE_MINUTES_EXCEEDED);break;case w_.ERR_LICENSE_PERIOD_INVALID:this.close(C_.LICENSE_PERIOD_INVALID);break;case w_.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(C_.LICENSE_MULTIPLE_SDK_SERVICE);break;case w_.ERR_LICENSE_ILLEGAL:this.close(C_.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new fw("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===A_.CONNECTED&&this.reconnect("retry",I_.OFFLINE)}))}async request(e,t,i,n){const r=Wb(6,""),s={_id:r,_type:e,_message:t},o=this.websocket.connectionID,a=()=>new yh(((t,i)=>{if(this.connectionState===A_.CONNECTED)return t();const n=()=>{this.off(P_.WS_CLOSED,r),t()},r=()=>{this.off(P_.WS_CONNECTED,n),i(new Ef(yf.WS_ABORT))};this.once(P_.WS_CONNECTED,n),this.once(P_.WS_CLOSED,r),e!==O_.PUBLISH&&e!==O_.SUBSCRIBE&&e!==O_.UNSUBSCRIBE&&e!==O_.UNPUBLISH&&e!==O_.CONTROL&&e!==O_.RESTART_ICE||this.once(P_.DISCONNECT_P2P,(()=>{i(new Ef(yf.DISCONNECT_P2P))})),e!==O_.PUBLISH&&e!==O_.RESTART_ICE||this.once(P_.ABORT_P2P_EXECUTION,(()=>{i(new Ef(yf.DISCONNECT_P2P))}))}));if(this.connectionState!==A_.CONNECTING&&this.connectionState!==A_.RECONNECTING||e===O_.JOIN||e===O_.REJOIN||await a(),this.websocket.sendMessage(s,!0),n)return;const c=new yh(((i,n)=>{let s=!1;const a=(n,r)=>{s=!0,i({isSuccess:"success"===n,message:r||{}}),this.off(P_.WS_CLOSED,c),this.off(P_.WS_RECONNECTING,c),this.emit(P_.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{n(new Ef(yf.WS_ABORT,"type: ".concat(e))),this.off(P_.WS_CLOSED,c),this.off(P_.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(P_.WS_CLOSED,c),this.once(P_.WS_RECONNECTING,c),Bb(Kf("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==o||s||(Pf.warning("ws request timeout, type: ".concat(e)),this.emit(P_.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===A_.CLOSED||e===O_.LEAVE)throw new Ef(yf.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():e===O_.JOIN||e===O_.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=pw(l),u=new Ef(yf.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:(Pf.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===w_.ERR_TOO_MANY_BROADCASTERS?e===O_.JOIN||e===O_.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===w_.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,Pf.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",I_.MULTI_IP)):this.reconnect(h.action,I_.SERVER_ERROR),e===O_.JOIN||e===O_.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new yh((i=>{const n=r=>{(!t||t(r))&&(this.off(e,n),i(r))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=Kf("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==A_.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Kf("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new yh(((i,n)=>{this.once(P_.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(P_.WS_CLOSED,(()=>n(this.initError||new Ef(yf.WS_ABORT)))),this.connectionState=A_.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4),setTimeout((()=>{t&&void 0===this.openConnectionTime&&(Pf.debug("[".concat(this.clientId,"] init websocket timeout while join with fallback to proxy")),n(new Ef(yf.INIT_WEBSOCKET_TIMEOUT)))}),Kf("JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||C_.LEAVE,this.connectionState=A_.CLOSED,Pf.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===C_.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new fw("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(P_.ABORT_P2P_EXECUTION);const e=await Jb(this,P_.REQUEST_JOIN_INFO),t=await this.request(O_.JOIN,e);if(!t)return this.emit(P_.REPORT_JOIN_GATEWAY,yf.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(P_.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=A_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ef(yf.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=$b(this,P_.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(O_.REJOIN,e);return!!t&&(this.connectionState=A_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(D_.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(D_.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(D_.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(D_.MUTE_AUDIO,{uid:e.uid}):this.emit(D_.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(D_.MUTE_VIDEO,{uid:e.uid}):this.emit(D_.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(D_.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(D_.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(D_.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(D_.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(D_.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){Pf.debug("[".concat(this.clientId,"] receive notification: "),e);const t=pw(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(C_.UID_BANNED),void this.close()):void this.reconnect(t.action,I_.SERVER_ERROR);Pf.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Kf("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(Pf.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Kf("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",I_.TIMEOUT):this.request(O_.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Kf("REPORT_STATS")&&this.send(O_.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(N_.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(G_.RECONNECT_WAITTING_FINISH,(e=>{this.emit(P_.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(G_.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(P_.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(G_.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(G_.CLOSED,(()=>{this.connectionState=A_.CLOSED})),this.websocket.on(G_.FAILED,(()=>{this._disconnectedReason=C_.NETWORK_ERROR,this.connectionState=A_.CLOSED})),this.websocket.on(G_.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===A_.CONNECTED?this.connectionState=A_.RECONNECTING:this.connectionState=A_.CONNECTING})),this.websocket.on(G_.WILL_RECONNECT,((e,t)=>{if($b(this,P_.IS_P2P_DISCONNECTED)&&"retry"===e)return Pf.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(P_.NEED_RENEW_SESSION),this.emit(P_.DISCONNECT_P2P),t("tryNext");"retry"!==e&&(Pf.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(P_.NEED_RENEW_SESSION),this.emit(P_.DISCONNECT_P2P)),t(e)})),this.websocket.on(G_.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{Pf.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",I_.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(P_.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Ef&&e.code===yf.UNEXPECTED_RESPONSE&&e.data.code===w_.ERR_NO_AUTHORIZED)return Pf.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",I_.SERVER_ERROR);Pf.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",I_.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(G_.REQUEST_NEW_URLS,((e,t)=>{Jb(this,P_.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(G_.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(D_.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}function vw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class yw extends _f{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(Fv.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Fv.CONNECTED):"closed"===this._state?this.emit(Fv.CLOSED):"failed"===this._state&&this.emit(Fv.FAILED))}constructor(e,t,i,n){super(),fp(this,"connectionID",0),fp(this,"currentURLIndex",0),fp(this,"reconnectReason",void 0),fp(this,"_reconnectMode","tryNext"),fp(this,"_initMutex",void 0),fp(this,"_name",void 0),fp(this,"_state","closed"),fp(this,"_reconnectInterrupter",void 0),fp(this,"_url",void 0),fp(this,"_retryConfig",void 0),fp(this,"_reconnectCount",0),fp(this,"_forceCloseTimeout",5e3),fp(this,"_onlineReconnectListener",void 0),fp(this,"_closeEstablishingTransmitter",(()=>{})),fp(this,"_store",void 0),fp(this,"_joinChannelServiceRecordIndex",void 0),fp(this,"_transmitter",void 0),fp(this,"_useCompress",void 0),fp(this,"_inflateLength",0),fp(this,"_deflateLength",0),this._store=n,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?vw(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):vw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this._useCompress=i}resetReconnectCount(e){Pf.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void Pf.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;void 0!==e&&(this.reconnectMode=e),Pf.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(i=this._store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));const n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}function Ew(e,t,i){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,i);const n=e.getUint32(t,i),r=e.getUint32(t+4,i),s=Number(!!i),o=Number(!i);return BigInt(n*o+r*s)<<BigInt(32)|BigInt(n*s+r*o)}function Sw(e,t,i,n){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,i,n);const r=Number(i>>BigInt(32)),s=Number(i&BigInt(4294967295));n?(e.setUint32(t+4,r,n),e.setUint32(t,s,n)):(e.setUint32(t,r,n),e.setUint32(t+4,s,n))}let bw;!function(e){e[e.Default=0]="Default",e[e.Ack=1]="Ack"}(bw||(bw={}));class ww{constructor(e,t,i){fp(this,"version",1),fp(this,"initialRTO",void 0),fp(this,"maxBatchAckCount",void 0),fp(this,"maxRTO",void 0),fp(this,"initialRTT",void 0),fp(this,"ID",void 0),fp(this,"rtt",void 0),fp(this,"packetNumber",1),fp(this,"rtoRatioMap",new Map),fp(this,"timeoutMap",new Map),fp(this,"unorderedPacketQueue",[]),fp(this,"batchAckPacketQueue",[]),fp(this,"lastOrderedPacketNumber",0),fp(this,"batchAckTimer",void 0),fp(this,"sendImpl",void 0),fp(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=t,this.ID=Wb(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:Kf("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Kf("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Kf("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:Kf("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:Kf("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:bw.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case bw.Default:{let t;t="string"==typeof e.payload?(new TextEncoder).encode(e.payload):e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),Sw(n,7,BigInt(e.sendTs)),new Uint8Array(n.buffer).set(t,15),i}case bw.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),Sw(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const t=new DataView(e),i=t.getUint16(0),n=t.getUint8(2);switch(n){case bw.Default:{const r=t.getUint32(3),s=Ew(t,7),o=e.slice(15),a=(new TextDecoder).decode(o);return{version:i,type:n,packetNumber:r,sendTs:Number(s),payload:a}}case bw.Ack:{const e=t.getUint32(3),r=t.getUint8(7),s=Ew(t,8);return{version:i,type:n,maxAckPacketNumber:e,shift:r,ackSendTs:Number(s)}}default:throw Pf.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===bw.Default?this.ack(t):t.type===bw.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:bw.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:bw.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:bw.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===bw.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class Tw extends yw{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),fp(this,"_initMutex",void 0),fp(this,"_reconnectInterrupter",void 0),fp(this,"_url",void 0),fp(this,"_transmitter",void 0),fp(this,"_addresses",void 0),fp(this,"_reliableTransmission",void 0),this._initMutex=new AE("datachannel");const{timeout:i,timeoutFactor:n}=t,r=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*n)/10);Pv.ONLINE&&(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=s),mE.on(Ov.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===Pv.ONLINE?(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||Kf("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(Fv.CLOSED,(()=>i(new Ef(yf.WS_DISCONNECT)))),this.once(Fv.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new yh(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Ef(yf.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new Ef(yf.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new yh(((t,i)=>{var n;const r=()=>{Pf.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),t()},s=async e=>{var n;if(null===(n=this._closeEstablishingTransmitter)||void 0===n||n.call(this),Pf.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const n=Xb(this,Fv.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,r=await this.reconnectWithAction(n);if("closed"===this.state)return void Pf.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!r)return i(new Ef(yf.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);t()}else i(new Ef(yf.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},o=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),Pf.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const a=null===(n=this._store)||void 0===n?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();Jb(this,Fv.TO_CONNECT_DATACHANNEL,e).then((e=>{var t,i;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:n,close:d}=e;this._transmitter=n,null===(t=this._store)||void 0===t||t.signalChannelOpen();const l=Date.now()-c;Pf.debug("[choose dc] dc open cost ".concat(l,"ms")),this._reliableTransmission=new ww((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(Fv.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,d()},r&&r(),n.onclose=s,n.onmessage=o,null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((e=>{var t;if(null===(t=this._store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:e instanceof Ef&&e.code===yf.WS_ABORT?"aborted":"error",errors:[e]},a),"closed"!==this.state){if(e instanceof Ef&&e.code===yf.WS_ERR){const t=new Ef(yf.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return Pf.error("[".concat(this._name,"]").concat(t)),void i(t)}s&&s(e)}else i(new Ef(yf.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||mE.networkState!==Pv.OFFLINE||(this._onlineReconnectListener=mE.onlineWaiter&&mE.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},t){const t=bf(this._reconnectCount,this._retryConfig);Pf.debug("[".concat(this._name,"] wait ").concat(t,"ms to reconnect datachannel, mode: ").concat(e)),await yh.race([Bb(t),this._onlineReconnectListener||new yh((()=>{}))])}if("closed"===this.state||!i)return!1;this._reconnectCount+=1;const n=async(e,t)=>{this.emit(Fv.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(Fv.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||Kf("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return Pf.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);Pf.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const t=this._addresses[this.currentURLIndex];this.emit(Fv.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else"recover"===e&&(Pf.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Fv.RECONNECT_WAITTING_FINISH,e),this.emit(Fv.FAILBACK));return!0}catch(i){var r;return Pf.error("[".concat(this._name,"] reconnect failed"),i.toString()),null!=i&&null!==(r=i.data)&&void 0!==r&&r.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(Fv.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class Cw extends _f{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===A_.CONNECTED?this.emit(P_.WS_CONNECTED):e===A_.RECONNECTING?this.emit(P_.WS_RECONNECTING,this._websocketReconnectReason):e===A_.CLOSED&&this.emit(P_.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),fp(this,"_disconnectedReason",void 0),fp(this,"_websocketReconnectReason",void 0),fp(this,"_connectionState",A_.CLOSED),fp(this,"reconnectToken",void 0),fp(this,"websocket",void 0),fp(this,"openConnectionTime",void 0),fp(this,"clientId",void 0),fp(this,"lastMsgTime",Date.now()),fp(this,"uploadCache",[]),fp(this,"uploadCacheInterval",void 0),fp(this,"rttRolling",new gw(5)),fp(this,"pingpongTimer",void 0),fp(this,"inflateDataTimer",void 0),fp(this,"pingpongTimeoutCount",0),fp(this,"joinResponse",void 0),fp(this,"multiIpOption",void 0),fp(this,"initError",void 0),fp(this,"spec",void 0),fp(this,"store",void 0),fp(this,"onWebsocketMessage",(e=>{if(e instanceof ArrayBuffer)return void this.emit(P_.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===D_.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===D_.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(C_.UID_BANNED);break;case 15:this.close(C_.IP_BANNED);break;case 16:this.close(C_.CHANNEL_BANNED)}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new Tw("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===A_.CONNECTED&&this.reconnect("retry",Mv.OFFLINE)}))}async request(e,t,i,n){const r=Wb(6,""),s={_id:r,_type:e,_message:t},o=this.websocket.connectionID,a=()=>new yh(((t,i)=>{if(this.connectionState===A_.CONNECTED)return t();const n=()=>{this.off(P_.WS_CLOSED,r),t()},r=()=>{this.off(P_.WS_CONNECTED,n),i(new Ef(yf.WS_ABORT))};this.once(P_.WS_CONNECTED,n),this.once(P_.WS_CLOSED,r),e!==O_.PUBLISH&&e!==O_.SUBSCRIBE&&e!==O_.UNSUBSCRIBE&&e!==O_.UNPUBLISH&&e!==O_.CONTROL&&e!==O_.RESTART_ICE||this.once(P_.DISCONNECT_P2P,(()=>{i(new Ef(yf.DISCONNECT_P2P))})),e!==O_.PUBLISH&&e!==O_.RESTART_ICE||this.once(P_.ABORT_P2P_EXECUTION,(()=>{i(new Ef(yf.DISCONNECT_P2P))}))}));if(this.connectionState!==A_.CONNECTING&&this.connectionState!==A_.RECONNECTING||e===O_.JOIN||e===O_.REJOIN||await a(),e===O_.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(s,!0,!1),n)return;const c=new yh(((i,n)=>{let s=!1;const a=(n,r)=>{s=!0,i({isSuccess:"success"===n,message:r||{}}),this.off(P_.WS_CLOSED,c),this.off(P_.WS_RECONNECTING,c),this.emit(P_.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{n(new Ef(yf.WS_ABORT,"type: ".concat(e))),this.off(P_.WS_CLOSED,c),this.off(P_.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(P_.WS_CLOSED,c),this.once(P_.WS_RECONNECTING,c),Bb(Kf("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==o||s||(Pf.warning("dc request timeout, type: ".concat(e)),this.emit(P_.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===A_.CLOSED||e===O_.LEAVE)throw new Ef(yf.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():e===O_.JOIN||e===O_.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=pw(l),u=new Ef(yf.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:(Pf.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===w_.ERR_TOO_MANY_BROADCASTERS?e===O_.JOIN||e===O_.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===w_.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,Pf.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Mv.MULTI_IP)):this.reconnect(h.action,Mv.SERVER_ERROR),e===O_.JOIN||e===O_.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new yh((i=>{const n=r=>{(!t||t(r))&&(this.off(e,n),i(r))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=Kf("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==A_.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Kf("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new yh(((i,n)=>{this.once(P_.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(P_.WS_CLOSED,(()=>n(this.initError||new Ef(yf.WS_ABORT)))),this.connectionState=A_.CONNECTING,this.websocket.init(e).catch(n),this.websocket.once(Fv.FAILBACK,(()=>{void 0===this.openConnectionTime&&n(new Ef(yf.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{t&&void 0===this.openConnectionTime&&(Pf.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new Ef(yf.INIT_DATACHANNEL_TIMEOUT)))}),Kf("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||C_.LEAVE,this.connectionState=A_.CLOSED,Pf.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===C_.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Tw("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(P_.ABORT_P2P_EXECUTION);const e=await Jb(this,P_.DATACHANNEL_CONNECTING),t=await this.request(O_.JOIN,e);if(!t)return this.emit(P_.REPORT_JOIN_GATEWAY,yf.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(P_.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=A_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ef(yf.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=$b(this,P_.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(O_.REJOIN,e);return!!t&&(this.connectionState=A_.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(D_.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(D_.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(D_.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(D_.MUTE_AUDIO,{uid:e.uid}):this.emit(D_.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(D_.MUTE_VIDEO,{uid:e.uid}):this.emit(D_.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(D_.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(D_.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(D_.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(D_.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(D_.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){Pf.debug("[".concat(this.clientId,"] receive notification: "),e);const t=pw(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(C_.UID_BANNED),void this.close()):void this.reconnect(t.action,Mv.SERVER_ERROR);Pf.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Kf("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(Pf.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Kf("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Mv.TIMEOUT):this.request(O_.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Kf("REPORT_STATS")&&this.send(O_.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(N_.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Fv.RECONNECT_WAITTING_FINISH,(e=>{this.emit(P_.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(Fv.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(P_.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Fv.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Fv.CLOSED,(()=>{this.connectionState=A_.CLOSED})),this.websocket.on(Fv.FAILED,(()=>{this._disconnectedReason=C_.NETWORK_ERROR,this.connectionState=A_.CLOSED})),this.websocket.on(Fv.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===A_.CONNECTED?this.connectionState=A_.RECONNECTING:this.connectionState=A_.CONNECTING})),this.websocket.on(Fv.WILL_RECONNECT,((e,t)=>{if($b(this,P_.IS_P2P_DISCONNECTED)&&"retry"===e)return Pf.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(P_.NEED_RENEW_SESSION),this.emit(P_.DISCONNECT_P2P),t("tryNext");"retry"!==e&&(Pf.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(P_.NEED_RENEW_SESSION),this.emit(P_.DISCONNECT_P2P)),t(e)})),this.websocket.on(Fv.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{Pf.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Mv.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(P_.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Ef&&e.code===yf.UNEXPECTED_RESPONSE&&e.data.code===w_.ERR_NO_AUTHORIZED)return Pf.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Mv.SERVER_ERROR);Pf.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Mv.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(Fv.REQUEST_NEW_URLS,((e,t)=>{Jb(this,P_.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(Fv.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(D_.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(Fv.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>Jb(this,P_.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(Fv.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(P_.DATACHANNEL_FAILBACK)}))}}function Rw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Iw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Rw(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Rw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Aw=new Map;class Pw extends _f{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(cv.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(cv.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){Pf.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),fp(this,"store",void 0),fp(this,"joinInfo",void 0),fp(this,"key",void 0),fp(this,"signal",void 0),fp(this,"role",void 0),fp(this,"inChannelInfo",{joinAt:null,duration:0}),fp(this,"spec",void 0),fp(this,"_state","DISCONNECTED"),fp(this,"_statsCollector",void 0),fp(this,"_disconnectedReason",void 0),fp(this,"isSignalRecover",!1),fp(this,"hasChangeBGPAddress",!1),fp(this,"trafficStatsInterval",void 0),fp(this,"networkQualityInterval",void 0),fp(this,"_joinGatewayStartTime",0),fp(this,"_signalTimeout",!1),fp(this,"_clientRoleOptions",void 0),fp(this,"_isProactiveJoin",!1),this.store=e,this.spec=t,this.signal=this.store.useDataChannel?new Cw(Iw(Iw({},t),{},{retryConfig:t.websocketRetryConfig}),e):new _w(Iw(Iw({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,t,i){if(this.signal instanceof Cw){let t=!1;"disabled"!==e.cloudProxyServer?(Pf.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),t=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(Pf.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),t=!0):e.apResponse.addresses.some((e=>e.fingerprint))||Kf("FINGERPRINT")||(Pf.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),t=!0),t&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const n=Date.now();let r=Aw.get(e.cname);if(r||(r=new Map,Aw.set(e.cname,r)),this._isProactiveJoin=!0,r.has(e.uid)){const t=new Ef(yf.UID_CONFLICT);throw TE.joinGateway(e.sid,{lts:n,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Cw?"1":"0"}),this._isProactiveJoin=!1,t}r.set(e.uid,!0),this.joinInfo=e,this.key=t;let s=0;this.joinGatewayStartTime=n;const o=e.proxyServer;try{let t;if(Pf.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Cw?"datachannel":"websocket"," join uid ").concat(s)),this.signal instanceof Cw)t=await this.signal.init(e.apResponse.addresses,i);else{const n=e.proxyServer,r=n?e.gatewayAddrs.map((e=>{const t=e.address.split(":");return"wss://".concat(n,"/ws/?h=").concat(t[0],"&p=").concat(t[1])})):e.gatewayAddrs.map((e=>"wss://".concat(e.address)));t=await this.signal.init(r,i)}s=t.uid,Pf.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Cw?"datachannel":"websocket"," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(t){if(t&&t.code===yf.INIT_WEBSOCKET_TIMEOUT)throw Pf.warning("[".concat(this.store.clientId,"] User join failed"),t.toString()),t;if(t&&t.code===yf.INIT_DATACHANNEL_TIMEOUT)throw Pf.warning("[".concat(this.store.clientId,"] User join datachannel failed"),t.toString()),this.resetSignal(),t;throw Pf.error("[".concat(this.store.clientId,"] User join failed"),t.toString()),TE.joinGateway(e.sid,{lts:n,succ:!1,ec:t.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!o,signalChannel:this.signal instanceof Cw?"1":"0"}),this._isProactiveJoin=!1,r.delete(e.uid),this.signal.close(),t}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),Pf.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{Pf.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(cv.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(cv.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(cv.NETWORK_QUALITY,{uplinkNetworkQuality:kb(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:kb(this._statsCollector.trafficStats.B_dnq)}):this.emit(cv.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){t!==C_.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==A_.CONNECTED||await function(e,t){return t===1/0?e:yh.race([e,Hb(t)])}(this.signal.request(O_.LEAVE,void 0,!0),3e3)}catch(e){Pf.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(t),t!==C_.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ef(yf.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const n={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:Kf("PUB_EXTEND"),twcc:!!Kf("PUBLISH_TWCC")};try{return(await this.signal.request(O_.PUBLISH,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===w_.ERR_PUBLISH_REQUEST_INVALID)return Pf.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),n.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw n}}async unpublish(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ef(yf.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(O_.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(e){Pf.warning("unpublish warning: ",e)}}async subscribe(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ef(yf.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const n={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Kf("SUBSCRIBE_TWCC"),extend:Kf("SUB_EXTEND"),ssrcId:t.ssrcId};try{return(await this.signal.request(O_.SUBSCRIBE,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===w_.ERR_SUBSCRIBE_REQUEST_INVALID)return Pf.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),n.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw n}}async subscribeAll(e,t){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ef(yf.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:e,dtx:!1};try{return await this.signal.request(O_.SUBSCRIBE_STREAMS,i,!0)}catch(i){if(t&&i.data&&i.data.code===w_.ERR_SUBSCRIBE_REQUEST_INVALID)return Pf.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw i}}async setVideoProfile(e){const t=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,r=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(r=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(r=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(r=!1)),r?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(t)return this.signal.request(O_.SET_VIDEO_PROFILE,t);Pf.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(O_.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(e){Pf.warning("unsubscribe warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(O_.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){Pf.warning("unsubscribeAll warning: ",e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(O_.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(O_.GATEWAY_INFO)}renewToken(e){return this.signal.request(O_.RENEW_TOKEN,e)}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i;i="audience"===e?this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:0,await this.signal.request(O_.SET_CLIENT_ROLE,{role:e,level:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(O_.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(O_.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(O_.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(O_.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Iw({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(O_.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=Aw.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:xf.username,password:xf.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(Iw(Iw({},xf),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(O_.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&ew((()=>{this.emit(cv.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new Ef(yf.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=Kf("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=Iw({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Nf,browser:navigator.userAgent,process_id:Kf("PROCESS_ID"),mode:this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:Kf("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:Kf("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Kf("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof Kf("SUBSCRIBE_AUDIO_FILTER_TOPN")?Kf("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof Kf("ENABLE_PUBLISH_AUDIO_FILTER")?Kf("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof Kf("ENABLE_USER_LICENSE_CHECK")?Kf("ENABLE_USER_LICENSE_CHECK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,Kf("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new Ef(yf.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(P_.WS_RECONNECT_WAITTING_FINISH,(e=>{["tryNext","recover"].includes(e)&&this.joinInfo&&TE.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(P_.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(P_.WS_RECONNECTING,(e=>{this.joinInfo&&TE.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||I_.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",TE.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(P_.WS_CLOSED,(e=>{let t;switch(e){case C_.LEAVE:t=I_.LEAVE;break;case C_.UID_BANNED:case C_.IP_BANNED:case C_.CHANNEL_BANNED:case C_.SERVER_ERROR:t=I_.SERVER_ERROR;break;case C_.FALLBACK:t=I_.FALLBACK;break;case C_.LICENSE_MISSING:case C_.LICENSE_EXPIRED:case C_.LICENSE_MINUTES_EXCEEDED:case C_.LICENSE_PERIOD_INVALID:case C_.LICENSE_MULTIPLE_SDK_SERVICE:case C_.LICENSE_ILLEGAL:t=e;break;default:t=I_.NETWORK_ERROR}Pf.debug("[signal] websocket closed, reason: ".concat(t||"undefined -> "+I_.NETWORK_ERROR)),this.joinInfo&&TE.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===C_.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==C_.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(P_.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&this._clientRoleOptions.level&&(Pf.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions&&this._clientRoleOptions.level)),this.setClientRole(this.role,this._clientRoleOptions)),TE.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Cw?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void Pf.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Wf("EVENT_REPORT_DOMAIN",e[1]),Wf("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Wf("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(D_.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(P_.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new Ef(yf.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Jb(this,cv.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(P_.REQUEST_JOIN_INFO,(async e=>{var t;this.updateTurnConfigFromSignal();const{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}=await Jb(this,cv.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:r,version:"2"}}))})),this.signal.on(P_.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(P_.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(TE.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Cw?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(P_.IS_P2P_DISCONNECTED,(e=>{e($b(this,cv.IS_P2P_DISCONNECTED))})),this.signal.on(P_.DISCONNECT_P2P,(()=>{this.emit(cv.DISCONNECT_P2P)})),this.signal.on(P_.NEED_RENEW_SESSION,(()=>{this.emit(cv.NEED_RENEW_SESSION)})),this.signal.on(P_.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(P_.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(P_.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(cv.JOIN_RESPONSE,e,t)})),this.signal.on(P_.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return Jb(this,cv.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on(P_.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await Jb(this,cv.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(P_.DATACHANNEL_FAILBACK,(()=>{Pf.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(cv.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,t){try{await this.signal.request(O_.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(e){throw Pf.warning("unsubscribe warning",e),e}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(O_.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(e){throw Pf.warning("unpublish warning: ",e),e}}async tryMassUnsubBeforeResub(e){const t={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(O_.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){throw Pf.warning("massUnsubscribe warning",e),e}}async muteLocal(e,t){const i={action:e.find((e=>e.stream_type===av.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(O_.CONTROL,i,!0,!0)}catch(e){throw Pf.warning("gateway unmuteLocal warning: ",e),e}}async unmuteLocal(e,t){const i={action:e.find((e=>e.stream_type===av.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(O_.CONTROL,i,!0,!0)}catch(e){throw Pf.warning("gateway muteLocal warning: ",e),e}}uploadStats(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(O_.RESTART_ICE,t,!0)}catch(e){throw Pf.warning("P2PChannel.restartICE warning: ",e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,I_.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!Kf("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(O_.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(C_.FALLBACK)),this.store.useDataChannel=!1,this.signal=new _w(Iw(Iw({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(cv.RESET_SIGNAL,lv.websocket)}}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */!function(){var e;function i(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}var n,r="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,i){return e==Array.prototype||e==Object.prototype||(e[t]=i.value),e},s=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof t&&t];for(var i=0;i<e.length;++i){var n=e[i];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);function o(e,t){if(t)e:{var i=s;e=e.split(".");for(var n=0;n<e.length-1;n++){var o=e[n];if(!(o in i))break e;i=i[o]}(t=t(n=i[e=e[e.length-1]]))!=n&&null!=t&&r(i,e,{configurable:!0,writable:!0,value:t})}}function a(e){return(e={next:e})[Symbol.iterator]=function(){return this},e}function c(e){var t="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return t?t.call(e):{next:i(e)}}if(o("Symbol",(function(e){function t(e,t){this.A=e,r(this,"description",{configurable:!0,writable:!0,value:t})}if(e)return e;t.prototype.toString=function(){return this.A};var i="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",n=0;return function e(r){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t(i+(r||"")+"_"+n++,r)}})),o("Symbol.iterator",(function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var t="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),n=0;n<t.length;n++){var o=s[t[n]];"function"==typeof o&&"function"!=typeof o.prototype[e]&&r(o.prototype,e,{configurable:!0,writable:!0,value:function(){return a(i(this))}})}return e})),"function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var d;e:{var l={};try{l.__proto__={a:!0},d=l.a;break e}catch(e){}d=!1}n=d?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var h=n;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(e){if(e.m)throw new TypeError("Generator is already running");e.m=!0}function m(e,t){return e.h=3,{value:t}}function f(e){this.g=new u,this.G=e}function g(e,t,i,n){try{var r=t.call(e.g.j,i);if(!(r instanceof Object))throw new TypeError("Iterator result "+r+" is not an object");if(!r.done)return e.g.m=!1,r;var s=r.value}catch(t){return e.g.j=null,e.g.s(t),_(e)}return e.g.j=null,n.call(e.g,s),_(e)}function _(e){for(;e.g.h;)try{var t=e.G(e.g);if(t)return e.g.m=!1,{value:t.value,done:!1}}catch(t){e.g.v=void 0,e.g.s(t)}if(e.g.m=!1,e.g.l){if(t=e.g.l,e.g.l=null,t.F)throw t.D;return{value:t.return,done:!0}}return{value:void 0,done:!0}}function v(e){this.next=function(t){return e.o(t)},this.throw=function(t){return e.s(t)},this.return=function(t){return function(e,t){p(e.g);var i=e.g.j;return i?g(e,"return"in i?i.return:function(e){return{value:e,done:!0}},t,e.g.return):(e.g.return(t),_(e))}(e,t)},this[Symbol.iterator]=function(){return this}}function y(e,t){return t=new v(new f(t)),h&&e.prototype&&h(t,e.prototype),t}if(u.prototype.o=function(e){this.v=e},u.prototype.s=function(e){this.l={D:e,F:!0},this.h=this.C||this.u},u.prototype.return=function(e){this.l={return:e},this.h=this.u},f.prototype.o=function(e){return p(this.g),this.g.j?g(this,this.g.j.next,e,this.g.o):(this.g.o(e),_(this))},f.prototype.s=function(e){return p(this.g),this.g.j?g(this,this.g.j.throw,e,this.g.o):(this.g.s(e),_(this))},o("Array.prototype.entries",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var i=0,n=!1,r={next:function(){if(!n&&i<e.length){var r=i++;return{value:t(r,e[r]),done:!1}}return n=!0,{done:!0,value:void 0}}};return r[Symbol.iterator]=function(){return r},r}(this,(function(e,t){return[e,t]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var E=function(e,t){for(var i=0;i<e.length;i++)t(e[i])},S=function(e){return e.replace(/\r?\n|\r/g,"\r\n")},b=function(e,t,i){return t instanceof Blob?(i=void 0!==i?String(i+""):"string"==typeof t.name?t.name:"blob",t.name===i&&"[object Blob]"!==Object.prototype.toString.call(t)||(t=new File([t],i)),[String(e),t]):[String(e),String(t)]},w=function(e,t){if(e.length<t)throw new TypeError(t+" argument required, but only "+e.length+" present.")},T="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,C=T.FormData,R=T.XMLHttpRequest&&T.XMLHttpRequest.prototype.send,I=T.Request&&T.fetch,A=T.navigator&&T.navigator.sendBeacon,P=T.Element&&T.Element.prototype,O=T.Symbol&&Symbol.toStringTag;O&&(Blob.prototype[O]||(Blob.prototype[O]="Blob"),"File"in T&&!File.prototype[O]&&(File.prototype[O]="File"));try{new File([],"")}catch(e){T.File=function(e,t,i){return e=new Blob(e,i||{}),Object.defineProperties(e,{name:{value:t},lastModified:{value:+(i&&void 0!==i.lastModified?new Date(i.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),O&&Object.defineProperty(e,O,{value:"File"}),e}}var N=function(e){return e.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},D=function(e){this.i=[];var t=this;e&&E(e.elements,(function(e){if(e.name&&!e.disabled&&"submit"!==e.type&&"button"!==e.type&&!e.matches("form fieldset[disabled] *"))if("file"===e.type){var i=e.files&&e.files.length?e.files:[new File([],"",{type:"application/octet-stream"})];E(i,(function(i){t.append(e.name,i)}))}else"select-multiple"===e.type||"select-one"===e.type?E(e.options,(function(i){!i.disabled&&i.selected&&t.append(e.name,i.value)})):"checkbox"===e.type||"radio"===e.type?e.checked&&t.append(e.name,e.value):(i="textarea"===e.type?S(e.value):e.value,t.append(e.name,i))}))};if((e=D.prototype).append=function(e,t,i){w(arguments,2),this.i.push(b(e,t,i))},e.delete=function(e){w(arguments,1);var t=[];e=String(e),E(this.i,(function(i){i[0]!==e&&t.push(i)})),this.i=t},e.entries=function e(){var t,i=this;return y(e,(function(e){if(1==e.h&&(t=0),3!=e.h)return t<i.i.length?e=m(e,i.i[t]):(e.h=0,e=void 0),e;t++,e.h=2}))},e.forEach=function(e,t){w(arguments,1);for(var i=c(this),n=i.next();!n.done;n=i.next()){var r=c(n.value);n=r.next().value,r=r.next().value,e.call(t,r,n,this)}},e.get=function(e){w(arguments,1);var t=this.i;e=String(e);for(var i=0;i<t.length;i++)if(t[i][0]===e)return t[i][1];return null},e.getAll=function(e){w(arguments,1);var t=[];return e=String(e),E(this.i,(function(i){i[0]===e&&t.push(i[1])})),t},e.has=function(e){w(arguments,1),e=String(e);for(var t=0;t<this.i.length;t++)if(this.i[t][0]===e)return!0;return!1},e.keys=function e(){var t,i,n,r,s=this;return y(e,(function(e){if(1==e.h&&(t=c(s),i=t.next()),3!=e.h)return i.done?void(e.h=0):(n=i.value,r=c(n),m(e,r.next().value));i=t.next(),e.h=2}))},e.set=function(e,t,i){w(arguments,2),e=String(e);var n=[],r=b(e,t,i),s=!0;E(this.i,(function(t){t[0]===e?s&&(s=!n.push(r)):n.push(t)})),s&&n.push(r),this.i=n},e.values=function e(){var t,i,n,r,s=this;return y(e,(function(e){if(1==e.h&&(t=c(s),i=t.next()),3!=e.h)return i.done?void(e.h=0):(n=i.value,(r=c(n)).next(),m(e,r.next().value));i=t.next(),e.h=2}))},D.prototype._asNative=function(){for(var e=new C,t=c(this),i=t.next();!i.done;i=t.next()){var n=c(i.value);i=n.next().value,n=n.next().value,e.append(i,n)}return e},D.prototype._blob=function(){var e="----formdata-polyfill-"+Math.random(),t=[],i="--"+e+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(e,n){return"string"==typeof e?t.push(i+N(S(n))+'"\r\n\r\n'+S(e)+"\r\n"):t.push(i+N(S(n))+'"; filename="'+N(e.name)+'"\r\nContent-Type: '+(e.type||"application/octet-stream")+"\r\n\r\n",e,"\r\n")})),t.push("--"+e+"--"),new Blob(t,{type:"multipart/form-data; boundary="+e})},D.prototype[Symbol.iterator]=function(){return this.entries()},D.prototype.toString=function(){return"[object FormData]"},P&&!P.matches&&(P.matches=P.matchesSelector||P.mozMatchesSelector||P.msMatchesSelector||P.oMatchesSelector||P.webkitMatchesSelector||function(e){for(var t=(e=(this.document||this.ownerDocument).querySelectorAll(e)).length;0<=--t&&e.item(t)!==this;);return-1<t}),O&&(D.prototype[O]="FormData"),R){var k=T.XMLHttpRequest.prototype.setRequestHeader;T.XMLHttpRequest.prototype.setRequestHeader=function(e,t){k.call(this,e,t),"content-type"===e.toLowerCase()&&(this.B=!0)},T.XMLHttpRequest.prototype.send=function(e){e instanceof D?(e=e._blob(),this.B||this.setRequestHeader("Content-Type",e.type),R.call(this,e)):R.call(this,e)}}I&&(T.fetch=function(e,t){return t&&t.body&&t.body instanceof D&&(t.body=t.body._blob()),I.call(this,e,t)}),A&&(T.navigator.sendBeacon=function(e,t){return t instanceof D&&(t=t._asNative()),A.call(this,e,t)}),T.FormData=D}}();const Ow=()=>{const e=Kf("AREAS");return 0===e.length&&e.push(_v.GLOBAL),$i(e).call(e,((e,t,i)=>{const n=Nw(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},Nw=e=>e===_v.OVERSEA?"".concat(Sv.ASIA,",").concat(Sv.EUROPE,",").concat(Sv.AFRICA,",").concat(Sv.NORTH_AMERICA,",").concat(Sv.SOUTH_AMERICA,",").concat(Sv.OCEANIA):Sv[e],Dw=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=bv[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},kw={GLOBAL:{ASIA:[_v.CHINA,_v.JAPAN,_v.INDIA,_v.KOREA,_v.HKMC],EUROPE:[],NORTH_AMERICA:[_v.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},xw=Object.keys(kw[_v.GLOBAL]),Lw=[_v.CHINA,_v.NORTH_AMERICA,_v.EUROPE,_v.ASIA,_v.JAPAN,_v.INDIA,_v.OCEANIA,_v.SOUTH_AMERICA,_v.AFRICA,_v.KOREA,_v.HKMC,_v.US],Mw=function(e,t){let i=[];if(e.includes(_v.GLOBAL)){const s=[_v.GLOBAL,_v.OVERSEA],o=Object.keys(bv);if(t===_v.GLOBAL)throw new Ef(yf.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===_v.CHINA)i=[_v.OVERSEA];else if(r=t,xw.includes(r)){const e=(n=t,kw[_v.GLOBAL][n]||[]),r=[...s,t,...e];i=o.filter((e=>!r.includes(e)))}else if(function(e){let t=!1;return xw.forEach((i=>{kw[_v.GLOBAL][i].includes(e)&&(t=!0)})),t}(t)){const e=function(e){let t;return xw.forEach((i=>{kw[_v.GLOBAL][i].includes(e)&&(t=i)})),t}(t),n=[...s,e,t];i=o.filter((e=>!n.includes(e)))}else i=e;i=function(e){const t=[];return Lw.forEach((i=>{e.includes(i)&&t.push(i)})),t.concat(e.filter((e=>!Lw.includes(e))))}(i)}else i=e;var n,r;return i};function Fw(e){if(!e&&Kf("AREAS").includes(_v.EXTENSIONS))return Pf.debug("update area from ap : reset"),void Uw(kf,!0);if(!Kf("AREAS").includes(_v.GLOBAL)||!e)return;let t=bv.EXTENSIONS;t&&(t={CODE:Nw(_v.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},Pf.debug("update area from ap success: ".concat(e,",config is "),t),Wf("AREAS",[_v.EXTENSIONS],!0),Object.keys(t).map((e=>{Wf(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?t[e][0]:t[e])})))}function Uw(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=TE.reportApiInvoke(null,{name:f_.SET_AREA,options:e,tag:g_.TRACER});try{let n=[];if("string"==typeof e&&(n=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!Ev.includes(e))throw new Ef(yf.INVALID_PARAMS,"invalid area code")})),n=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:i}=e;if(!t)throw new Ef(yf.INVALID_PARAMS,"area code is needed");let r=t;"string"==typeof t&&(r=[t]),n=i?Mw(r,i):r}if(!t){if(qf.AREAS){const e=new Ef(yf.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(e),void Pf.warning("setArea is prohibited because of config-distribute")}if(n.includes(_v.GLOBAL)&&Kf("AREAS")===_v.EXTENSIONS){const e=new Ef(yf.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(e),void Pf.warning("setArea is prohibited because of ap extensions")}}Wf("AREAS",n,t);const r=Dw(n);Object.keys(r).map((e=>{Wf(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?r[e][0]:r[e])})),Pf.debug("set area success:",n.join(","))}catch(e){throw i.onError(e),e}i.onSuccess()}function jw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Vw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jw(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let Bw=1;function Hw(e,t,i,n,r){Bw+=1;const s={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:Bw,requestId:Bw,version:Nf,cname:i.cname},o={service_name:t,json_body:JSON.stringify(s)};let a,c,d=e[0];return wf((async()=>{a=Date.now();const e=await uE(d,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==e.code){const t=new Ef(yf.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:c});throw Pf.error(t.toString()),t}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new Ef(yf.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:c});throw Pf.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new Ef(yf.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:c});throw Pf.error(e.toString()),e}const r=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Kf("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,t);return Kf("LIVE_STREAMING_ADDRESS")&&(r.addressList=Kf("LIVE_STREAMING_ADDRESS")instanceof Array?Kf("LIVE_STREAMING_ADDRESS"):[Kf("LIVE_STREAMING_ADDRESS")]),Vw(Vw({},r),{},{responseTime:c})}),((n,r)=>(TE.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(n.addressList),firstSuccess:0===r,responseTime:c,serverIp:e[r%e.length]}),!1)),((n,r)=>(TE.apworkerEvent(i.sid,{success:!1,sc:n.data&&n.data.code||200,serviceName:t,responseTime:c,serverIp:e[r%e.length]}),!!(n.code!==yf.OPERATION_ABORTED&&n.code!==yf.UNEXPECTED_RESPONSE||n.data&&n.data.retry)&&(d=e[(r+1)%e.length],!0))),r)}let Ww=1;function Kw(e,t,i,n){let{url:r,areaCode:s}=e;const o=Date.now();let a;const[c,d]=Yw(t,s,[Bv.CHOOSE_SERVER]);let l=mE.networkState;return wf((async()=>{l&&mE.networkState===Pv.OFFLINE&&mE.onlineWaiter&&await yh.race([mE.onlineWaiter,Bb(n&&n.maxRetryTimeout||Sf.maxRetryTimeout)]),l=mE.networkState;const{data:e,headers:s}=await uE(r,{data:c,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===s.http3?1:-1,TE.reportResourceTiming(r,t.sid),qw(e,r,t,o,[Bv.CHOOSE_SERVER],a);const d=xb(e,Bv.CHOOSE_SERVER);return zw(d),Pb(d,r)}),(e=>(e&&TE.joinChooseServer(t.sid,{lts:o,succ:!0,csAddr:r,opid:d,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[Bv.CHOOSE_SERVER].toString(),isHttp3:a}),!1)),(e=>e.code!==yf.OPERATION_ABORTED&&(e.code===yf.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(TE.joinChooseServer(t.sid,{lts:o,succ:!1,csAddr:r,serverList:null,opid:d,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[Bv.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:l}),isHttp3:a}),Pf.warning("[".concat(t.clientId,"] Choose server network error, retry"),e),!0))),n)}function Gw(e,t,i,n){let r,{url:s,areaCode:o,serviceIds:a}=e;const c=Date.now(),[d,l]=Yw(t,o,a);let h;return wf((async()=>{h&&mE.networkState===Pv.OFFLINE&&mE.onlineWaiter&&await yh.race([mE.onlineWaiter,Bb(n&&n.maxRetryTimeout||Sf.maxRetryTimeout)]),h=mE.networkState;const{data:e,headers:o}=await uE(s,{data:d,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r="1"===o.http3?1:-1,TE.reportResourceTiming(s,t.sid),qw(e,s,t,c,a,r);const l=xb(e,Bv.CHOOSE_SERVER),u=xb(e,"proxy5"===t.cloudProxyServer?Bv.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?Bv.CLOUD_PROXY:Bv.CLOUD_PROXY_FALLBACK);return zw(l),{gatewayInfo:Pb(l,s),proxyInfo:u,url:s}}),(e=>(e.gatewayInfo&&TE.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:s,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:l,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),e.proxyInfo&&TE.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(e=>e.code!==yf.OPERATION_ABORTED&&(e.code===yf.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(TE.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:e.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),Pf.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),e),!0))),n)}const qw=(e,t,i,n,r,s)=>{const o=[],a=o=>{4096===o.flag?TE.joinChooseServer(i.sid,{lts:n,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:o.error.message,csIp:o.error.data&&o.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s}):1048576!==o.flag&&4194304!==o.flag&&4194310!==o.flag||TE.joinWebProxyAP(i.sid,{lts:n,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:o.error.code,eventType:i.cloudProxyServer,unilbsServerIds:r.toString()})};if(e.response_body.forEach((t=>{const i=t.buffer.code;if(23===t.uri&&0===i&&!t.buffer.edges_services)if(4194310===t.buffer.flag)Pf.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),t.buffer.edges_services=[];else{const i={error:new Ef(yf.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:t.buffer.flag};o.push(i),a(i)}if(0!==i){const n=hw(i),r={error:new Ef(yf.CAN_NOT_GET_GATEWAY_SERVER,n.desc,{desc:n.desc,retry:n.retry,csIp:e.detail[502]}),flag:t.buffer.flag};4194310===t.buffer.flag?Pf.warning(r.error.toString()):o.push(r),a(r)}})),o.length)throw Pf.warning("[".concat(i.clientId,"] multi unilbs ").concat(t," failed, ").concat(o.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new Ef(yf.CAN_NOT_GET_GATEWAY_SERVER,o.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!o.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(o.map((e=>{var t,i;return null==e||null===(t=e.error)||void 0===t||null===(i=t.data)||void 0===i?void 0:i.desc})).filter((e=>!!e)))]})},zw=e=>{var t,i,n,r;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new Ef(yf.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(null!==(t=e.detail)&&void 0!==t&&t[23]&&"string"==typeof(null===(i=e.detail)||void 0===i?void 0:i[23])?Fw(e.detail[23].toLowerCase()):Fw(),null!==(n=e.detail)&&void 0!==n&&n[19]&&"string"==typeof(null===(r=e.detail)||void 0===r?void 0:r[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let n=0;n<i.length;n++){var s;const t=_u(s=i[n]).call(s);e.addresses[n]&&i&&(e.addresses[n].fingerprint=t)}}if(Kf("GATEWAY_ADDRESS")&&Kf("GATEWAY_ADDRESS").length>0){Pf.debug("assign gateway address to",Kf("GATEWAY_ADDRESS"));const t=Kf("GATEWAY_ADDRESS").map((t=>{var i,n;const r=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:r}}));e.addresses=t}},Jw=(e,t)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=hw(t.buffer.code);throw new Ef(yf.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw Pf.debug("update ticket request received ap response without response body:",t),new Ef(yf.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Yw=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),r={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:{6:e.stringUid,11:t,12:Kf("USE_NEW_TOKEN")?"1":void 0,22:t},key:e.token,service_ids:i,uid:e.uid||0}}]};r.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const s=new FormData;return s.append("request",JSON.stringify(r)),[s,n]},Xw=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(n)),[r,i]};let $w=0;async function Qw(e,t,i,n){const r=async function(e,t,i,n){let r=null;const s=[],o=async()=>{const r=Kf("WEBCS_DOMAIN").slice(0,Kf("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Ow()}))),o=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),a=await cw({fragementLength:Kf("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>(Pf.debug("[".concat(e.clientId,"] Connect to choose_server:"),n.url),Kw(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},o),e[0]},promisesCollector:s});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},o),a},a=async()=>{if(await Bb(1e3),null!==r)return r;const o=Kf("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Ow()}))),a=n.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await cw({fragementLength:Kf("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:n=>(Pf.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),n.url),Kw(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:s});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return r=await zb([o(),a()]),s.length&&s.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),r}catch(e){throw e[0]}}(e,t,i,n);return{gatewayInfo:await r}}async function Zw(e,t,i,n,r){const s=e.cloudProxyServer;if("disabled"===s){if(!n)return;if(e.useLocalAccessPoint)return await Qw(e,t,i,r);if(Kf("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:n,proxyInfo:s}=await iT(e,t,i,r);return e.turnServer&&"auto"!==e.turnServer.mode||(e.turnServer={mode:"manual",servers:s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||xf.tcpport,udpport:e.udpport||xf.udpport,username:e.username||xf.username,password:e.password||xf.password,forceturn:!1,security:!0})))}),{gatewayInfo:n}}return await Qw(e,t,i,r)}const{proxyInfo:o,gatewayInfo:a}=await iT(e,t,i,r),c={gatewayInfo:a};return e.turnServer={mode:"manual",servers:o.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===s?void 0:e.tcpport?e.tcpport:xf.tcpport,udpport:"proxy4"===s?void 0:e.udpport?e.udpport:xf.udpport,username:e.username||xf.username,password:e.password||xf.password,forceturn:"proxy4"!==s,security:"proxy5"===s})))},Pf.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(s)),c}async function eT(e,t,i,n,r){const s=Kf("ACCOUNT_REGISTER").slice(0,Kf("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?s.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):s.map((e=>"https://".concat(e,"/api/v1")));const a=null==r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const s=await async function(e,t,i,n,r){const s=Date.now(),o={sid:i.sid,opid:10,appid:i.appId,string_uid:t};let a=e[0];const c=await wf((()=>uE(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((i,n)=>{if(0===i.code){if(i.uid<=0||i.uid>=Math.pow(2,32))throw Pf.error("Invalid Uint Uid ".concat(t," => ").concat(i.uid),i),TE.reqUserAccount(o.sid,{lts:s,success:!1,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:yf.INVALID_UINT_UID_FROM_STRING_UID,extend:o}),new Ef(yf.INVALID_UINT_UID_FROM_STRING_UID);return TE.reqUserAccount(o.sid,{lts:s,success:!0,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:null,extend:o}),!1}const r=hw(i.code);return r.retry&&(a=e[(n+1)%e.length]),TE.reqUserAccount(o.sid,{lts:s,success:!1,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:r.desc,extend:o}),r.retry}),((t,i)=>t.code!==yf.OPERATION_ABORTED&&(TE.reqUserAccount(o.sid,{lts:s,success:!1,serverAddr:a,stringUid:o.string_uid,uid:null,errorCode:t.code,extend:o}),a=e[(i+1)%e.length],!0)),r);if(0!==c.code){const e=hw(c.code);throw new Ef(yf.UNEXPECTED_RESPONSE,e.desc)}return c}(o,e,t,i,n);return null==r||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),s.uid}catch(e){throw null==r||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},a),e}}async function tT(e,t,i){const n=Kf("CDS_AP").slice(0,Kf("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((n=>function(e,t,i,n){const r=Mu(),s={flag:64,cipher_method:0,features:{device:r.name,system:r.os,system_general:navigator.userAgent,vendor:t.appId,version:Nf,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return wf((()=>uE(e,{data:s,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==yf.OPERATION_ABORTED),n)}(n,e,t,i)));let r=null,s=null,o={};try{r=await zb(n)}catch(e){if(e.code===yf.OPERATION_ABORTED)throw e;s=e}if(n.forEach((e=>e.cancel())),TE.reportApiInvoke(e.sid,{name:f_.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:r}}).onSuccess(),r&&r.test_tags)try{o=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{var i;const r=_u(i=e.slice(4)).call(i),s=JSON.parse(t[e])[1];n[r]=s})),n}(r)}catch(e){}return o}async function iT(e,t,i,n){const r=Kf("PROXY_SERVER_TYPE3"),s=(e,t,i)=>{let n=i||r;return Array.isArray(n)&&(n=t%2==0?r[1]:r[0]),"https://".concat(n,"/ap/?url=").concat(e)};let o=null;const a=[],c=async()=>{const r=Kf("WEBCS_DOMAIN").slice(0,Kf("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?s("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):s("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Ow(),serviceIds:[Bv.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?Bv.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?Bv.CLOUD_PROXY:Bv.CLOUD_PROXY_FALLBACK]}})),o=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),c=await cw({fragementLength:Kf("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>(Pf.debug("[".concat(e.clientId,"] Connect to choose_server:"),n.url),Gw(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},o),e[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},o),c},d=async()=>{if(await Bb(1e3),null!==o)return o;const r=Kf("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?s("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):s("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Ow(),serviceIds:[Bv.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?Bv.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?Bv.CLOUD_PROXY:Bv.CLOUD_PROXY_FALLBACK]}})),c=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),d=await cw({fragementLength:Kf("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>(Pf.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),n.url),Gw(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};let l,h,u;try{({gatewayInfo:l,proxyInfo:h,url:u}=await zb([c(),d()]))}catch(e){throw e[0]}if(a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!l||!h)throw new Ef(yf.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=u,"disabled"!==e.cloudProxyServer&&Array.isArray(r)&&u){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(u)[1];r.includes(t)&&(e.proxyServer=t,Pf.setProxyServer(t),TE.setProxyServer(t))}return o={gatewayInfo:l,proxyInfo:await Lb(h,l.uid)},o}async function nT(e,t,i,n){const r=Kf("UAP_AP").slice(0,Kf("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await Hw(r,e,t,i,n)}async function rT(e,t,i){const n=Kf("UAP_AP").slice(0,Kf("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((n=>function(e,t,i,n){const r={command:"convergeAllocateEdge",sid:t.sid,appId:t.appId,token:t.token,ts:Date.now(),version:Nf,cname:t.cname,uid:t.uid.toString(),requestId:Ww,seq:Ww};Ww+=1;const s={service_name:"tele_channel",json_body:JSON.stringify(r)};return wf((async()=>{const t=await uE(e,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==t.code){const e=new Ef(yf.UNEXPECTED_RESPONSE,"cross channel ap error, code"+t.code,{retry:!0});throw Pf.error(e.toString()),e}const n=JSON.parse(t.json_body);if(200!==n.code){const e=new Ef(yf.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(n.code,", reason: ").concat(n.reason));throw Pf.error(e.toString()),e}if(!n.servers||0===n.servers.length){const e=new Ef(yf.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw Pf.error(e.toString()),e}return{vid:n.vid,workerToken:n.workerToken,addressList:(Kf("CHANNEL_MEDIA_RELAY_SERVERS")||n.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Kf("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==yf.OPERATION_ABORTED&&e.code!==yf.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),n)}(n,e,t,i)));try{const e=await zb(n);return n.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function sT(e,t,i){let n=null;const r=[],s=async s=>{const o=Kf(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return s&&(await Bb(1e3),null!==n)?n:await cw({fragementLength:Kf("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:n=>(Pf.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),n),function(e,t,i,n){const[r]=Xw(t,[Bv.CHOOSE_SERVER]);let s=mE.networkState;return wf((async()=>{s&&mE.networkState===Pv.OFFLINE&&mE.onlineWaiter&&await yh.race([mE.onlineWaiter,Bb(n&&n.maxRetryTimeout||Sf.maxRetryTimeout)]),s=mE.networkState;const t=await uE(e,{data:r,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0);return Jw(t,e)}),(()=>!1),(e=>e.code!==yf.OPERATION_ABORTED&&(e.code===yf.UPDATE_TICKET_FAILED?e.data.retry:(Pf.warning("[".concat(t.clientId,"] update ticket network error, retry"),e),!0))),n)}(n,e,t,i)),allFailedhandler:e=>{throw e[0]},promisesCollector:r})};try{return n=await zb([s(!1),s(!0)]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),n}catch(e){throw e[0]}}function oT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function aT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oT(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class cT extends _f{constructor(){super(),fp(this,"configs",void 0),fp(this,"joinInfo",void 0),fp(this,"cancelToken",void 0),fp(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),fp(this,"interval",void 0),fp(this,"mutex",new AE("config-distribute")),fp(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),Kf("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),Kf("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,TE.reportApiInvoke(null,{options:void 0,name:f_.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:g_.TRACER}).onSuccess(JSON.stringify(qf))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void Pf.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const t=await this.mutex.lock();try{e=await tT(this.joinInfo,this.cancelToken,this.retryConfig),Pf.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const t=new Ef(yf.NETWORK_RESPONSE_ERROR,e);Pf.warning("[config-distribute] ".concat(t.toString()))}finally{t()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(wv.UPDATE_BITRATE_LIMIT,e):this.emit(wv.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&aT({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var t;const i=qg(t=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(t);for(let r=0;r<i.length;r++)for(let t=i.length-1;t>r;t--){const n=i[t];if("number"==typeof e[n].__priority){const r=e[n].__priority,s=i[t-1];if("number"==typeof e[s].__priority){if(!(r>e[s].__priority))continue;{const e=n;i[t]=i[t-1],i[t-1]=e}}else{const e=n;i[t]=i[t-1],i[t-1]=e}}}const n={};i.forEach((t=>{const i=e[t],r=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(n,e)||(n[e]=aT({value:i[e]},r&&{expires:r}))}))}));try{const e=JSON.stringify(n),t=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",t),Pf.debug("Caching global parameters ".concat(e))}catch(e){Pf.error("Error caching global parameters:",e.message)}}}function dT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function lT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?dT(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):dT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class hT extends _f{constructor(e,t,i,n){super(),fp(this,"spec",void 0),fp(this,"token",void 0),fp(this,"websocket",void 0),fp(this,"pingpongTimer",void 0),fp(this,"reconnectMode","retry"),fp(this,"serviceMode",void 0),fp(this,"reqId",0),fp(this,"commandReqId",0),fp(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),fp(this,"handleWebSocketMessage",(e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===q_.INJECT?this.emit(Z_.INJECT_STREAM_STATUS,t):(TE.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===q_.TRANSCODE?1:2}),this.emit(Z_.PUBLISH_STREAM_STATUS,t))})),this.spec=t,this.token=e,this.serviceMode=n,this.websocket=new fw("live-streaming",i),this.websocket.on(G_.CONNECTED,this.handleWebSocketOpen),this.websocket.on(G_.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(G_.REQUEST_NEW_URLS,((e,t)=>{Jb(this,Z_.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(G_.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,i,n){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const r=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new Ef(yf.UNEXPECTED_ERROR);const o=lT({command:e,sdkVersion:"4.17.2"===Nf?"0.0.1":Nf,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new Ef(yf.WS_DISCONNECT);const a=()=>new yh(((e,t)=>{this.websocket.once(G_.CLOSED,(()=>t(new Ef(yf.WS_ABORT)))),this.websocket.once(G_.CONNECTED,e)}));"connected"!==this.websocket.state&&await a(),o.clientRequest&&(o.clientRequest.workerToken=this.token);const c=new yh(((e,t)=>{const i=()=>{t(new Ef(yf.WS_ABORT))};this.websocket.once(G_.RECONNECTING,i),this.websocket.once(G_.CLOSED,i),this.once("@".concat(s,"-").concat(this.spec.sid),(t=>{e(t)}))}));n&&TE.workerEvent(this.spec.sid,lT(lT({},n),{},{requestId:r,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const d=Date.now();this.websocket.sendMessage(o);let l=null;try{l=await c}catch(n){if("closed"===this.websocket.state)throw n;return await a(),await this.request(e,t,i)}return n&&TE.workerEvent(this.spec.sid,lT(lT({},n),{},{requestId:r,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:200===l.code,responseTime:Date.now()-d})),200!==l.code&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.17.2"===Nf?"0.0.1":Nf;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case tv.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void Pf.warning("live stream response already exists stream");case tv.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case tv.LIVE_STREAM_RESPONSE_BAD_STREAM:case tv.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Ef(yf.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case tv.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case tv.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Ef(yf.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case tv.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new Ef(yf.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Z_.WARNING,t,e.serverResponse.url)}case tv.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new Ef(yf.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Z_.WARNING,t,e.serverResponse.url)}case tv.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case tv.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Ef(yf.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case tv.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new Ef(yf.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Z_.WARNING,t,e.serverResponse.url)}case tv.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case tv.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case tv.LIVE_STREAM_RESPONSE_WORKER_LOST:case tv.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case tv.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case tv.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Ef(yf.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(Gb)}),6e3)}}function uT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function pT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?uT(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):uT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class mT extends _f{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Sf,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sf;super(),fp(this,"onLiveStreamWarning",void 0),fp(this,"onLiveStreamError",void 0),fp(this,"onInjectStatusChange",void 0),fp(this,"spec",void 0),fp(this,"retryTimeout",1e4),fp(this,"connection",void 0),fp(this,"httpRetryConfig",void 0),fp(this,"wsRetryConfig",void 0),fp(this,"streamingTasks",new Map),fp(this,"isStartingStreamingTask",!1),fp(this,"taskMutex",new AE("live-streaming")),fp(this,"cancelToken",ff.CancelToken.source()),fp(this,"transcodingConfig",void 0),fp(this,"injectConfig",pT({},Q_)),fp(this,"injectLoopTimes",0),fp(this,"uapResponse",void 0),fp(this,"lastTaskId",1),fp(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){const t=pT(pT({},$_),e);66!==t.videoCodecProfile&&77!==t.videoCodecProfile&&100!==t.videoCodecProfile&&(Pf.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map((e=>pT(pT(pT({},J_),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){t_(e.width)||Yg(e.width,"config.width",0,1e4),t_(e.height)||Yg(e.height,"config.height",0,1e4),t_(e.videoBitrate)||Yg(e.videoBitrate,"config.videoBitrate",1,1e6),t_(e.videoFrameRate)||Yg(e.videoFrameRate,"config.videoFrameRate"),t_(e.lowLatency)||zg(e.lowLatency,"config.lowLatency"),t_(e.audioSampleRate)||Jg(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),t_(e.audioBitrate)||Yg(e.audioBitrate,"config.audioBitrate",1,128),t_(e.audioChannels)||Jg(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),t_(e.videoGop)||Yg(e.videoGop,"config.videoGop"),t_(e.videoCodecProfile)||Jg(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),t_(e.userCount)||Yg(e.userCount,"config.userCount",0,17),t_(e.backgroundColor)||Yg(e.backgroundColor,"config.backgroundColor",0,16777215),t_(e.userConfigExtraInfo)||$g(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!t_(e.transcodingUsers)&&(Qg(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{e_(e.uid),t_(e.x)||Yg(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),t_(e.y)||Yg(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),t_(e.width)||Yg(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),t_(e.height)||Yg(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),t_(e.zOrder)||Yg(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),t_(e.alpha)||Yg(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),t_(e.watermark)||X_(e.watermark,"watermark"),t_(e.backgroundImage)||X_(e.backgroundImage,"backgroundImage"),e.images&&!t_(e.images)&&(Qg(e.images,"config.images"),e.images.forEach(((e,t)=>{X_(e,"images[".concat(t,"]"))})))}(t);const i=[];t.images&&i.push(...t.images.map((e=>pT(pT(pT({},Y_),e),{},{zOrder:255})))),t.backgroundImage&&(i.push(pT(pT(pT({},Y_),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(i.push(pT(pT(pT({},Y_),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=i,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map((e=>pT({},e))),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);const n=(t.userConfigs||[]).map((e=>"number"==typeof e.uid?yh.resolve(e.uid):eT(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await yh.all(n)).forEach(((e,i)=>{t.userConfigs&&t.userConfigs[i]&&(t.userConfigs[i].uid=e)})),this.transcodingConfig=t,this.connection)try{var r;const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(mS(r=this.streamingTasks).call(r)).map((e=>e.taskId)).join("#")});Pf.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((t=>{Pf.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",t.url),this.startLiveStreamingTask(t.url,t.mode,e).then((()=>{Pf.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(t.url," success"))})).catch((e=>{Pf.error("[".concat(this.spec.clientId,"] live streaming republish failed"),t.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,t,i){var n;if(Array.from(mS(n=this.streamingTasks).call(n)).find((e=>e.mode===q_.INJECT))&&t===q_.INJECT)return new Ef(yf.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&t===q_.TRANSCODE)throw new Ef(yf.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};Pf.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));const s=await this.taskMutex.lock();if(!this.connection&&i)return void s();if(this.streamingTasks.get(e)&&!i)return s(),new Ef(yf.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(e){throw s(),e}switch(t){case q_.TRANSCODE:r.transcodingConfig=pT({},this.transcodingConfig);break;case q_.RAW:break;case q_.INJECT:r={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const n=new yh(((t,n)=>{Bb(this.retryTimeout).then((()=>{if(i)return n(i);const t=this.statusError.get(e);return t?(this.statusError.delete(e),n(t)):void 0}))})),a=await yh.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:t===q_.TRANSCODE?1:2,requestByUser:!i,tid:o.toString()}),n]);this.isStartingStreamingTask=!1,Pf.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(a.code)),this.streamingTasks.set(e,{clientRequest:r,mode:t,url:e,taskId:o}),s()}catch(n){if(s(),this.isStartingStreamingTask=!1,!n.data||!n.data.retry||i)throw n;return n.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,n)):await this.startLiveStreamingTask(e,t,n)}}stopLiveStreamingTask(e){return new yh(((t,i)=>{const n=this.streamingTasks.get(e);if(!n||!this.connection)return new Ef(yf.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const r=n.mode;n.abortTask=()=>{Pf.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:r===q_.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:e,command:"UnPublishStream",workerType:r===q_.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((i=>{Pf.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(i.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&r!==q_.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),t(),r===q_.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(i)}))}async controlInjectStream(e,t,i,n){const r=this.streamingTasks.get(e);if(!r||!this.connection||r.mode!==q_.INJECT)throw new Ef(yf.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var e;const t=Array.from(mS(e=this.streamingTasks).call(e));this.terminate();for(const i of t)this.startLiveStreamingTask(i.url,i.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ff.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new Ef(yf.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await Jb(this,ev.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new hT(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Z_.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(Z_.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(Z_.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(Z_.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new Ef(yf.UNEXPECTED_ERROR,"can not get new live streaming address list"));Jb(this,ev.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const t=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(t),n=e.reason;switch(e.code){case tv.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case tv.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const n=new Ef(yf.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return Pf.error(n.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,n);if(!this.isStartingStreamingTask)return;this.statusError.set(t,n)}case tv.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new Ef(yf.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e)}case tv.LIVE_STREAM_RESPONSE_WORKER_LOST:case tv.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var r;if(!this.connection)return;this.connection.tryNextAddress();const t=Array.from(mS(r=this.streamingTasks).call(r));for(const i of t)i.abortTask?i.abortTask():(Pf.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,new Ef(yf.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{Pf.debug("[".concat(this.spec.clientId,"] republish live stream success"),i.url)})).catch((e=>{Pf.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,e)})));return}}}handleInjectStreamServerStatus(e){const t=Number(e.uid),i=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_START_SUCCESS,t,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,t,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_START_UNAUTHORIZED,t,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_BROKEN,t,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(z_.INJECT_STREAM_STATUS_START_TIMEOUT,t,i),void this.streamingTasks.delete(i);default:return void Pf.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class fT{constructor(){fp(this,"destChannelMediaInfos",new Map),fp(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){vv(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){vv(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Zg(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function gT(e){if(!(e instanceof fT))return new Ef(yf.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();return t?0===i.size?new Ef(yf.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new Ef(yf.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class _T extends _f{constructor(e,t,i){super(),fp(this,"ws",void 0),fp(this,"requestId",1),fp(this,"heartBeatTimer",void 0),fp(this,"joinInfo",void 0),fp(this,"clientId",void 0),fp(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),fp(this,"onClose",(e=>{this.emit("close"),this.dispose()})),fp(this,"onMessage",(e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)})),this.joinInfo=e,this.clientId=t,this.ws=new fw("cross-channel-".concat(this.clientId),i),this.ws.on(G_.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(G_.CONNECTED,this.onOpen),this.ws.on(G_.ON_MESSAGE,this.onMessage),this.ws.on(G_.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new yh(((t,i)=>{const n=window.setTimeout((()=>{i(new Ef(yf.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(r=>{window.clearTimeout(n),r.state&&0!==r.state?i(new Ef(yf.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new Ef(yf.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new Ef(yf.WS_DISCONNECT);const t=()=>new yh(((e,t)=>{this.ws.once(G_.CLOSED,(()=>t(new Ef(yf.WS_ABORT)))),this.ws.once(G_.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const i=this.sendMessage(e),n=new yh(((e,t)=>{const n=()=>{t(new Ef(yf.WS_ABORT))};this.ws.once(G_.RECONNECTING,n),this.ws.once(G_.CLOSED,n),this.once("req_".concat(i),e),Bb(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(G_.RECONNECTING,n),this.ws.off(G_.CLOSED,n),t(new Ef(yf.TIMEOUT,"cross channel ws request timeout"))}))})),r=await n;if(!r||200!==r.code)throw new Ef(yf.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(r)));return r}async connect(e){this.ws.removeAllListeners(G_.REQUEST_NEW_URLS),this.ws.on(G_.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class vT extends _f{set state(e){e!==this._state&&(e!==sv.RELAY_STATE_FAILURE&&(this.errorCode=ov.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,i,n){super(),fp(this,"joinInfo",void 0),fp(this,"sid",void 0),fp(this,"clientId",void 0),fp(this,"cancelToken",ff.CancelToken.source()),fp(this,"workerToken",void 0),fp(this,"requestId",0),fp(this,"signal",void 0),fp(this,"prevChannelMediaConfig",void 0),fp(this,"httpRetryConfig",void 0),fp(this,"_state",sv.RELAY_STATE_IDLE),fp(this,"errorCode",ov.RELAY_OK),fp(this,"onStatus",(e=>{Pf.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",rv.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",rv.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=ov.SRC_TOKEN_EXPIRED,this.state=sv.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=ov.DEST_TOKEN_EXPIRED,this.state=sv.RELAY_STATE_FAILURE))})),fp(this,"onReconnect",(async()=>{Pf.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",rv.NETWORK_DISCONNECTED),this.state=sv.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==sv.RELAY_STATE_IDLE&&(Pf.error("auto restart channel media relay failed",e.toString()),this.errorCode=ov.SERVER_CONNECTION_LOST,this.state=sv.RELAY_STATE_FAILURE)}))})),this.joinInfo=e,this.clientId=t,this.sid=Kb(),this.signal=new _T(this.joinInfo,this.clientId,i),this.httpRetryConfig=n}async startChannelMediaRelay(e){if(this.state!==sv.RELAY_STATE_IDLE)throw new Ef(yf.INVALID_OPERATION);this.state=sv.RELAY_STATE_CONNECTING,await this.connect(),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new Ef(yf.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new Ef(yf.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new Ef(yf.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==sv.RELAY_STATE_RUNNING)throw new Ef(yf.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),Pf.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=sv.RELAY_STATE_IDLE,this.dispose()}dispose(){Pf.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ff.CancelToken.source(),this.state=sv.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await rT(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",rv.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const t=this.genMessage(nv.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(nv.SetSdkProfile,e);await this.signal.request(i),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const n=this.genMessage(nv.SetSourceChannel,e);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",rv.PACKET_JOINED_SRC_CHANNEL),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(nv.SetSourceUserId,e);await this.signal.request(r),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(nv.SetDestChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",rv.PACKET_JOINED_DEST_CHANNEL),Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(nv.StartPacketTransfer,e);await this.signal.request(o),this.emit("event",rv.PACKET_SENT_TO_DEST_CHANNEL),this.state=sv.RELAY_STATE_RUNNING,Pf.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success"))}async sendUpdateMessage(e){const t=this.genMessage(nv.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",rv.PACKET_UPDATE_DEST_CHANNEL),Pf.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(nv.StopPacketTransfer);await this.signal.request(e),Pf.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],r=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Nf,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.17.2"===s.sdkVersion&&(s.sdkVersion="0.0.1");let o=null,a=null;switch(e){case nv.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case nv.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new Ef(yf.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},s;case nv.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new Ef(yf.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:a.uid+""},s;case nv.SetDestChannel:if(o=t&&t.getDestChannelMediaInfo(),!o)throw new Ef(yf.UNEXPECTED_ERROR,"can not find dest config");return o.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),s.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:r},s;case nv.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case nv.Reconnect:return s.clientRequest={command:"Reconnect"},s;case nv.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case nv.UpdateDestChannel:if(o=t&&t.getDestChannelMediaInfo(),!o)throw new Ef(yf.UNEXPECTED_ERROR,"can not find dest config");return o.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:r},s}return s}}const yT=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new yh(((i,n)=>{t.toBlob((async e=>{if(t.remove(),e){const n=await ET(e);i({buffer:n,width:t.width,height:t.height})}else n(new Ef(yf.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},ET=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};function ST(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function bT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ST(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ST(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class wT{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(Pf.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}constructor(e){fp(this,"trackId",void 0),fp(this,"config",void 0),fp(this,"onFirstVideoFrameDecoded",void 0),fp(this,"freezeTimeCounterList",[]),fp(this,"renderFreezeAccTime",0),fp(this,"timeUpdatedCount",0),fp(this,"freezeTime",0),fp(this,"playbackTime",0),fp(this,"lastTimeUpdatedTime",0),fp(this,"autoplayFailed",!1),fp(this,"videoTrack",void 0),fp(this,"videoElement",void 0),fp(this,"cacheVideoElement",void 0),fp(this,"videoElementCheckInterval",void 0),fp(this,"_videoElementStatus",a_.NONE),fp(this,"isGettingVideoDimensions",!1),fp(this,"startGetVideoDimensions",(()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return Pf.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()})),fp(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===xE.curState&&(tp()?(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.2")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):ep()?(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.1")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):Zu()&&(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.0")),this.videoElement.pause(),this.videoElement.play()))})),fp(this,"handleVideoEvents",(e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=a_.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.remove()}catch(e){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=a_.CANPLAY;break;case"stalled":this.videoElementStatus=a_.STALLED;break;case"suspend":this.videoElementStatus=a_.SUSPEND;break;case"pause":this.videoElementStatus=a_.PAUSED,qu()||ip()||Ku()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=a_.WAITING;break;case"abort":this.videoElementStatus=a_.ABORT;break;case"ended":this.videoElementStatus=a_.ENDED;break;case"emptied":this.videoElementStatus=a_.EMPTIED;break;case"error":{this.videoElementStatus=a_.ERROR;const e=this.videoElement.error;e&&Pf.error("[".concat(this.trackId,"] media error, code: ").concat(e.code,", message: ").concat(e.message));break}case"timeupdate":{const e=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=e);const t=e-this.lastTimeUpdatedTime,i=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=e,Cb.lastVisibleTime<Cb.lastHiddenTime||i<Cb.lastHiddenTime||i<Cb.lastVisibleTime)return;for(t>Kf("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=t),this.playbackTime+=t;this.playbackTime>=6e3;){this.playbackTime-=6e3;const e=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(e),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),fp(this,"autoResumeAfterInterruptionOnIOS15",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(tp()?(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.2")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):ep()?(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.1")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):Zu()&&(Pf.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.0")),this.videoElement.pause(),this.videoElement.play()))})),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),xE.on(RE.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),xE.on(RE.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return null!==(e=this.videoElement.parentElement)&&void 0!==e?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const t=this.videoElement.play();t&&t.catch&&t.catch((t=>{e&&TE.autoplayFailed(e,"video",t.message,this.trackId),"NotAllowedError"===t.name?(Pf.warning("detected video element autoplay failed",t),this.autoplayFailed=!0,this.handleAutoPlayFailed()):Pf.warning("[".concat(this.trackId,"] play warning: "),t)}));const i=Mu();if(("Safari"===i.name&&15===Number(i.version)||Qu())&&t&&t.then&&t.catch){const e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(e).catch(e)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const t=e.getContext("2d");if(!t)return Pf.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);const i=t.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const n=i.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,i.width,i.height),new yh(((n,r)=>{i.toBlob((async e=>{if(i.remove(),e){const t=await ET(e);n({buffer:t,width:i.width,height:i.height})}else r(new Ef(yf.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,t<0?.1:t>1?1:t)}))):await yT(e)}destroy(){xE.off(RE.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),xE.off(RE.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=a_.INIT,!this.videoElementCheckInterval&&(TT.forEach((e=>{this.videoElement.addEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(e){return e!==document.body&&document.body.contains(e)})(this.videoElement)||(this.videoElementStatus=a_.DESTROYED)}),1e3),Kf("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let i;const n=(e,t)=>{if(this.videoElementStatus===a_.PLAYING){if(i){const e=t.presentationTime-i.presentationTime;e>Kf("VIDEO_FREEZE_DURATION")&&Cb.lastVisibleTime>=Cb.lastHiddenTime&&i.timestamp>Cb.lastVisibleTime&&i.timestamp>Cb.lastHiddenTime&&(this.renderFreezeAccTime+=e)}i=bT(bT({},t),{},{timestamp:e})}var r,s;Kf("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(r=(s=this.videoElement).requestVideoFrameCallback)||void 0===r||r.call(s,n))};null===(e=(t=this.videoElement).requestVideoFrameCallback)||void 0===e||e.call(t,n)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),op()&&(this.videoElement.poster="noposter");const i=Mu();"Safari"===i.name&&15===Number(i.version)||Qu()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Gu()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Gu()&&this.videoElement.load());const n=this.videoElement.play();void 0!==n&&n.catch((e=>{Pf.debug("[".concat(this.trackId,"] playback interrupted"),e.toString())}))}resetVideoElement(){TT.forEach((e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=a_.NONE}handleAutoPlayFailed(){const e=t=>{t.preventDefault(),this.videoElement.play().then((()=>{Pf.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((e=>{Pf.error(e)})),this.autoplayFailed=!1,ap()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};ap()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),_E()}}const TT=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class CT extends wT{constructor(e){super(e),fp(this,"container",void 0),fp(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const t=e.element;t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await yT(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(e){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Kf("KEEP_LAST_FRAME")&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if(null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(e){}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function RT(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const i=Uf(e.encoderConfig);return t.width=i.width,t.height=i.height,!rp()&&i.frameRate&&(t.frameRate=i.frameRate),Mu().name===Nu.EDGE&&"object"==typeof t.frameRate&&(t.frameRate.max=60),Gu()&&(t.frameRate={ideal:30,max:30}),t}function IT(e){const t={};e.screenSourceType&&(t.mediaSource=e.screenSourceType),e.extensionId&&Wu()&&(t.extensionId=e.extensionId);const{displaySurface:i,selfBrowserSurface:n,surfaceSwitching:r,systemAudio:s}=e;(zu(107)||Ju(107)||Yu(93))&&(i&&(Jg(i,"displaySurface",["browser","window","monitor"]),t.displaySurface=i),n?(Jg(n,"selfBrowserSurface",["exclude","include"]),t.selfBrowserSurface=n):t.selfBrowserSurface="include",r&&(Jg(r,"surfaceSwitching",["exclude","include"]),t.surfaceSwitching=r)),(zu(105)||Ju(105)||Yu(91))&&s&&(Jg(s,"systemAudio",["exclude","include"]),t.systemAudio=s),e.electronScreenSourceId&&(t.sourceId=e.electronScreenSourceId);const o=e.encoderConfig?jf(e.encoderConfig):null;return t.mandatory={chromeMediaSource:"desktop",maxWidth:o?o.width:void 0,maxHeight:o?o.height:void 0},o&&(o.frameRate&&("number"==typeof o.frameRate?(t.mandatory.maxFrameRate=o.frameRate,t.mandatory.minFrameRate=o.frameRate):(t.mandatory.maxFrameRate=o.frameRate.max||o.frameRate.ideal||o.frameRate.exact||void 0,t.mandatory.minFrameRate=o.frameRate.min||o.frameRate.ideal||o.frameRate.exact||void 0),t.frameRate=o.frameRate),o.width&&(t.width=o.width),o.height&&(t.height=o.height)),t}function AT(e){const t={};if(rp()||(void 0!==e.AGC&&(t.autoGainControl=e.AGC),void 0!==e.AEC&&(t.echoCancellation=e.AEC),void 0!==e.ANS&&(t.noiseSuppression=e.ANS,Wu()&&e.ANS&&(t.googHighpassFilter=e.ANS))),e.encoderConfig){const i=Hf(e.encoderConfig);t.channelCount=i.stereo?2:1,t.sampleRate=i.sampleRate,t.sampleSize=i.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),op()&&(t.sampleRate=void 0),t}var PT,OT;!function(e){e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE"}(PT||(PT={})),function(e){e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(OT||(OT={}));var NT,DT,kT,xT,LT,MT,FT,UT,jT,VT,BT,HT,WT,KT,GT,qT,zT,JT,YT,XT,$T,QT,ZT,eC,tC,iC,nC,rC,sC,oC,aC,cC,dC,lC,hC=new class{constructor(){fp(this,"_clientSize",null),fp(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),fp(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),fp(this,"getStyle",(e=>window.getComputedStyle(e,null))),fp(this,"checkCssVisibleProperty",(e=>{let t=!0;const i=this.getStyle(e),{display:n,visibility:r,opacity:s,filter:o}=i;return("none"===n||["hidden","collapse"].includes(r)||Number(s)<.1)&&(t=!1),!!t&&(o&&o.split(" ").filter((e=>{const t=e.split("(")[0];return["brightness","blur","opacity"].includes(t)})).map((e=>{const[t,i]=e.split(/\(|\)/);return[t,Number(i.match(/^[0-9\.]+/))]})).forEach((e=>{const[i,n]=e;switch(i){case"brightness":(n<.1||n>3)&&(t=!1);break;case"blur":n>3&&(t=!1);break;case"opacity":n<.1&&(t=!1)}})),t)})),fp(this,"checkPropertyUpToAllParentNodes",((e,t)=>{let i=!0,n=!0;const r=e=>t(e);let s=e;for(;s&&n;)r(s)||(i=!1,n=!1),s=s.parentElement,s||(n=!1);return i})),fp(this,"checkActualCssVisibleIncludeInherit",(e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty))),fp(this,"getSizeAboutClient",(e=>{const{width:t,height:i,left:n,right:r,top:s,bottom:o}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:i,left:n,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),fp(this,"checkActualSize",(()=>{const{width:e,height:t,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(e,t,i)})),fp(this,"elementFromPoint",((e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null)),fp(this,"checkCoverForAPoint",((e,t,i)=>{const n=this.elementFromPoint(e,t);return null!==n&&n!==i})),fp(this,"getPointPositionList",(()=>{const{width:e,height:t,left:i,top:n}=this._clientSize,r=e/6,s=t/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let e=0;e<5;e++){const t=(i*a+(0===c?.1:4===c?(r*c*a-1e5)/a:r*c)*a)/a,d=(n*a+(0===e?.1:4===e?(s*e*a-1e5)/a:s*e)*a)/a;o.push({x:t,y:d})}return[...o]})),fp(this,"checkElementCover",(e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((e=>!!e)).length>6)),fp(this,"checkSizeIsVisible",((e,t,i)=>(e>50||i/e<=10)&&(t>50||i/t<=10))),fp(this,"checkSizeOfPartInClient",(()=>{const{left:e,right:t,top:i,bottom:n,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,d,l;if(e<0)a=0;else{if(!(e<s))return!1;a=e}if(t<0)return!1;if(c=t<s?t:s,i<0)d=0;else{if(!(i<r))return!1;d=i}if(n<0)return!1;l=n<r?n:r;const h=c-a,u=l-d;return this.checkSizeIsVisible(h,u,o)})),fp(this,"returnHiddenResult",(e=>(this._clientSize=null,{visible:!1,reason:e}))),fp(this,"checkOneElementVisible",(e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(PT.COVERED);{const e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(PT.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(PT.SIZE)}}return this.returnHiddenResult(PT.STYLE)}return this.returnHiddenResult(OT.UNMOUNTED)}return this.returnHiddenResult(OT.INVALID_HTML_ELEMENT)})),fp(this,"checkElementIsMountedOnDom",(e=>this.checkPropertyUpToAllParentNodes(e,(e=>"HTML"!==e.nodeName.toUpperCase()?null!==e.parentElement:!!document.documentElement))))}};function uC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function pC(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?uC(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):uC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let mC=(NT=wE({argsMap:(e,t,i)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),DT=oS(),kT=wE({argsMap:e=>[e.getTrackId()]}),xT=PE("LocalVideoTrack","_enabledMutex"),LT=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),MT=oS(),FT=PE("LocalVideoTrack","_enabledMutex"),UT=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),jT=oS(),VT=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),BT=oS(),HT=oS(),WT=wE({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),KT=oS(),GT=oS(),qT=oS(),zT=oS(),JT=oS(),YT=oS(),XT=oS(),$T=wE({argsMap:(e,t)=>[e.getTrackId(),t.name]}),QT=wE({argsMap:e=>[e.getTrackId()]}),ZT=wE({argsMap:e=>[e.getTrackId()]}),eC=wE({argsMap:(e,t,i)=>[e.getTrackId(),t.label,i]}),Zy((tC=class e extends OE{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==a_.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,i,n,r,s){if(super(e,r),fp(this,"trackMediaType","video"),fp(this,"_player",void 0),fp(this,"_videoVisibleTimer",null),fp(this,"_previousVideoVisibleStatus",void 0),fp(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),fp(this,"_encoderConfig",void 0),fp(this,"_scalabiltyMode",{numSpatialLayers:1,numTemporalLayers:1}),fp(this,"_optimizationMode",void 0),fp(this,"_videoHeight",void 0),fp(this,"_videoWidth",void 0),fp(this,"_forceBitrateLimit",void 0),fp(this,"_enabled",!0),fp(this,"processorDestination",void 0),fp(this,"_processorContext",void 0),Ku()){const{width:t,height:i}=e.getSettings();this._videoWidth=t,this._videoHeight=i}else this.updateMediaStreamTrackResolution();this._encoderConfig=t,this._scalabiltyMode=i,this._optimizationMode=n,this._hints=s||[],-1===this._hints.indexOf(uv.SCREEN_TRACK)&&this.updateBitrateFromProfile(),t&&-1!==this._hints.indexOf(uv.CUSTOM_TRACK)&&this.setEncoderConfiguration(t),this.processorContext=new vS(this.getTrackId(),"local"),this.processorDestination=new _S(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(Pf.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}Pf.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const i=pC(pC(pC({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new wT(i):this._player=new CT(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.emit(fv.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Kf("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Pf.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Pf.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Yb(this,hv.NEED_DISABLE_TRACK,this)}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}return t||(this._enabled=!1),void Pf.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Yb(this,hv.NEED_ENABLE_TRACK,this)}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,Pf.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Yb(this,hv.NEED_MUTE_TRACK,this):await Yb(this,hv.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Ef(yf.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=Uf(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const t=RT({encoderConfig:e});(Ku()||qu()||ip())&&(t.deviceId=void 0),Pf.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(t));try{await this._originMediaStreamTrack.applyConstraints(t),this.updateMediaStreamTrackResolution()}catch(e){const t=new Ef(yf.UNEXPECTED_ERROR,e.toString());throw Pf.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}}this._encoderConfig=e,-1===this._hints.indexOf(uv.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await Yb(this,hv.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw()}}getStats(){nw((()=>{Pf.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning");const e=Xb(this,hv.GET_STATS);return e||pC({},B_)}async setBeautyEffect(e){Pf.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await yT(e)}clone(t,i,n,r){const s=this._mediaStreamTrack.clone();return new e(s,t,i,n,r)}async setBitrateLimit(e){if(Pf.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await Yb(this,hv.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw()}}}async setOptimizationMode(e){if("motion"!==e&&"detail"!==e&&"balanced"!==e)return void Pf.error(yf.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const t=this._optimizationMode;try{this._optimizationMode=e,await Yb(this,hv.SET_OPTIMIZATION_MODE,this)}catch(e){throw this._optimizationMode=t,Pf.error("[".concat(this.getTrackId(),"] set optimization mode failed"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(1===e.numSpatialLayers&&1!==e.numTemporalLayers)return Pf.error(yf.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabiltyMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabiltyMode=e,Pf.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){qb(this._originMediaStreamTrack).then((e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t})).catch(Gb)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:t,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!t||!i)return;const[n,r]=function(e,t,i){const n=Kf("BITRATE_ADAPTER_TYPE");let r;const s=200*Math.pow(i/15,.6)*Math.pow(e*t/640/360,.75),o=s;if("STANDARD_BITRATE"===n)r=4*s;else{if("COMPATIABLE_BITRATE"!==n)return;r=2*s}return[Math.floor(r),Math.floor(o)]}(e,t,i)||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=r,this._encoderConfig.bitrateMax=n,Pf.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(i,"] => [brMax: ").concat(n,", brMin: ").concat(r,"]")))}getVideoElementVisibleStatus(){try{var e,t;const i=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),n={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:r,slot:s}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const e=hC.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new Ef(yf.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new Ef(yf.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new Ef(yf.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==e.kind)throw new Ef(yf.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}bindProcessorDestinationEvents(){this.processorDestination.on(Nv.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Yb(this,hv.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Yb(this,hv.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Nv.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Dv.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Dv.REQUEST_CONSTRAINTS)}}).prototype,"play",[NT,DT],Object.getOwnPropertyDescriptor(tC.prototype,"play"),tC.prototype),Zy(tC.prototype,"stop",[kT],Object.getOwnPropertyDescriptor(tC.prototype,"stop"),tC.prototype),Zy(tC.prototype,"setEnabled",[xT,LT,MT],Object.getOwnPropertyDescriptor(tC.prototype,"setEnabled"),tC.prototype),Zy(tC.prototype,"setMuted",[FT,UT,jT],Object.getOwnPropertyDescriptor(tC.prototype,"setMuted"),tC.prototype),Zy(tC.prototype,"setEncoderConfiguration",[VT,BT],Object.getOwnPropertyDescriptor(tC.prototype,"setEncoderConfiguration"),tC.prototype),Zy(tC.prototype,"getStats",[HT],Object.getOwnPropertyDescriptor(tC.prototype,"getStats"),tC.prototype),Zy(tC.prototype,"setBeautyEffect",[WT,KT],Object.getOwnPropertyDescriptor(tC.prototype,"setBeautyEffect"),tC.prototype),Zy(tC.prototype,"getCurrentFrameData",[GT],Object.getOwnPropertyDescriptor(tC.prototype,"getCurrentFrameData"),tC.prototype),Zy(tC.prototype,"getCurrentFrameImage",[qT],Object.getOwnPropertyDescriptor(tC.prototype,"getCurrentFrameImage"),tC.prototype),Zy(tC.prototype,"setBitrateLimit",[zT],Object.getOwnPropertyDescriptor(tC.prototype,"setBitrateLimit"),tC.prototype),Zy(tC.prototype,"setOptimizationMode",[JT],Object.getOwnPropertyDescriptor(tC.prototype,"setOptimizationMode"),tC.prototype),Zy(tC.prototype,"setScalabiltyMode",[YT],Object.getOwnPropertyDescriptor(tC.prototype,"setScalabiltyMode"),tC.prototype),Zy(tC.prototype,"updateMediaStreamTrackResolution",[XT],Object.getOwnPropertyDescriptor(tC.prototype,"updateMediaStreamTrackResolution"),tC.prototype),Zy(tC.prototype,"pipe",[$T],Object.getOwnPropertyDescriptor(tC.prototype,"pipe"),tC.prototype),Zy(tC.prototype,"unpipe",[QT],Object.getOwnPropertyDescriptor(tC.prototype,"unpipe"),tC.prototype),Zy(tC.prototype,"close",[ZT],Object.getOwnPropertyDescriptor(tC.prototype,"close"),tC.prototype),Zy(tC.prototype,"replaceTrack",[eC],Object.getOwnPropertyDescriptor(tC.prototype,"replaceTrack"),tC.prototype),tC),fC=(iC=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),nC=oS(),rC=PE("CameraVideoTrack","_enabledMutex"),sC=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),oC=oS(),aC=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),cC=oS(),dC=wE({argsMap:e=>[e.getTrackId()]}),Zy((lC=class extends mC{get __className__(){return"CameraVideoTrack"}constructor(e,t,i,n,r,s){super(e,Uf(t.encoderConfig),n,r,s),fp(this,"_config",void 0),fp(this,"_originalConstraints",void 0),fp(this,"_constraints",void 0),fp(this,"_enabled",!0),fp(this,"_deviceName","default"),fp(this,"tryResumeVideoForIOS15WeChat",(async()=>{Qu()&&!tp()&&np()&&this._enabled&&!this._isClosed&&(Pf.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=t,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=Uf(this._config.encoderConfig),xE.on(RE.IOS_15_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),xE.on(RE.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),this.bindProcessorContextEvents()}async setDevice(e){if(Pf.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const t=await nS.getDeviceById(e),i={};i.video=pC({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await ZE(i,this.getTrackId())}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),n=await ZE({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await nS.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] setDevice success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Pf.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const e=await ZE({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1)}await Yb(this,hv.NEED_ENABLE_TRACK,this)}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setEnabled true error"),e.toString()),e}this.updateMediaStreamTrackResolution(),Pf.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await Yb(this,hv.NEED_DISABLE_TRACK,this)}catch(e){throw Pf.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}Pf.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Ef(yf.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=Uf(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);const i=tw(this._config);i.encoderConfig=e;const n=RT(i);(Ku()||qu()||ip())&&(n.deviceId=void 0),Pf.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(e){const t=new Ef(yf.UNEXPECTED_ERROR,e.toString());throw Pf.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}this._config=i,this._constraints=n,this._originalConstraints=n,this._encoderConfig=e,-1===this._hints.indexOf(uv.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await Yb(this,hv.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw()}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((qu()||ip())&&this._enabled&&!this._isClosed&&xE.duringInterruption){const e=async()=>{xE.off(RE.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Pf.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};xE.on(RE.IOS_INTERRUPTION_END,e)}else Pf.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(fv.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,i=nS.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId={exact:i}),this._enabled){const e=await ZE({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),xE.off(RE.IOS_15_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),xE.off(RE.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat)}bindProcessorContextEvents(){this.processorContext.on(Dv.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,i)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),t()}catch(e){i(e)}})),this.processorContext.on(Dv.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}}).prototype,"setDevice",[iC,nC],Object.getOwnPropertyDescriptor(lC.prototype,"setDevice"),lC.prototype),Zy(lC.prototype,"setEnabled",[rC,sC,oC],Object.getOwnPropertyDescriptor(lC.prototype,"setEnabled"),lC.prototype),Zy(lC.prototype,"setEncoderConfiguration",[aC,cC],Object.getOwnPropertyDescriptor(lC.prototype,"setEncoderConfiguration"),lC.prototype),Zy(lC.prototype,"close",[dC],Object.getOwnPropertyDescriptor(lC.prototype,"close"),lC.prototype),lC);class gC{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}constructor(e,t){fp(this,"uid",void 0),fp(this,"_uintid",void 0),fp(this,"_trust_in_room_",!0),fp(this,"_trust_audio_enabled_state_",!0),fp(this,"_trust_video_enabled_state_",!0),fp(this,"_trust_audio_mute_state_",!0),fp(this,"_trust_video_mute_state_",!0),fp(this,"_audio_muted_",!1),fp(this,"_video_muted_",!1),fp(this,"_audio_enabled_",!0),fp(this,"_video_enabled_",!0),fp(this,"_audio_added_",!1),fp(this,"_video_added_",!1),fp(this,"_trust_video_stream_added_state_",!0),fp(this,"_trust_audio_stream_added_state_",!0),fp(this,"_audioTrack",void 0),fp(this,"_videoTrack",void 0),fp(this,"_audioSSRC",void 0),fp(this,"_videoSSRC",void 0),fp(this,"_audioOrtc",void 0),fp(this,"_videoOrtc",void 0),fp(this,"_cname",void 0),fp(this,"_rtxSsrcId",void 0),this.uid=e,this._uintid=t}}var _C=vh,vC=md,yC=bd;wi({target:"Promise",stat:!0},{try:function(e){var t=vC.f(this),i=yC(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var EC=_C,SC=wi,bC=p,wC=n,TC=Wv,CC=J,RC=Ve,IC=Oi,AC=rg,PC=$v,OC=Dy,NC=ce,DC=st("isConcatSpreadable"),kC=9007199254740991,xC="Maximum allowed index exceeded",LC=bC.TypeError,MC=NC>=51||!wC((function(){var e=[];return e[DC]=!1,e.concat()[0]!==e})),FC=OC("concat"),UC=function(e){if(!CC(e))return!1;var t=e[DC];return void 0!==t?!!t:TC(e)};SC({target:"Array",proto:!0,forced:!MC||!FC},{concat:function(e){var t,i,n,r,s,o=RC(this),a=PC(o,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(UC(s=-1===t?o:arguments[t])){if(c+(r=IC(s))>kC)throw LC(xC);for(i=0;i<r;i++,c++)i in s&&AC(a,c,s[i])}else{if(c>=kC)throw LC(xC);AC(a,c++,s)}return a.length=c,a}});var jC={},VC=L,BC=q,HC=kn.f,WC=lg,KC="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];jC.f=function(e){return KC&&"Window"==VC(e)?function(e){try{return HC(e)}catch(e){return WC(KC)}}(e):HC(BC(e))};var GC={},qC=st;GC.f=qC;var zC=Y,JC=We,YC=GC,XC=Gt.f,$C=function(e){var t=zC.Symbol||(zC.Symbol={});JC(t,e)||XC(t,e,{value:YC.f(e)})},QC=wi,ZC=p,eR=ee,tR=v,iR=T,nR=l,rR=S,sR=he,oR=n,aR=We,cR=Wv,dR=y,lR=J,hR=h,uR=ve,pR=$t,mR=Ve,fR=q,gR=gt,_R=Os,vR=N,yR=kr,ER=pr,SR=kn,bR=jC,wR=Zn,TR=E,CR=Gt,RR=lr,IR=C,AR=mc,PR=Uo,OR=Ne.exports,NR=Wn,DR=Je,kR=st,xR=GC,LR=$C,MR=ia,FR=Oo,UR=sy.forEach,jR=mn("hidden"),VR="Symbol",BR=kR("toPrimitive"),HR=FR.set,WR=FR.getterFor(VR),KR=Object.prototype,GR=ZC.Symbol,qR=GR&&GR.prototype,zR=ZC.TypeError,JR=ZC.QObject,YR=eR("JSON","stringify"),XR=TR.f,$R=CR.f,QR=bR.f,ZR=IR.f,eI=nR([].push),tI=OR("symbols"),iI=OR("op-symbols"),nI=OR("string-to-symbol-registry"),rI=OR("symbol-to-string-registry"),sI=OR("wks"),oI=!JR||!JR.prototype||!JR.prototype.findChild,aI=rR&&oR((function(){return 7!=yR($R({},"a",{get:function(){return $R(this,"a",{value:7}).a}})).a}))?function(e,t,i){var n=XR(KR,t);n&&delete KR[t],$R(e,t,i),n&&e!==KR&&$R(KR,t,n)}:$R,cI=function(e,t){var i=tI[e]=yR(qR);return HR(i,{type:VR,tag:e,description:t}),rR||(i.description=t),i},dI=function(e,t,i){e===KR&&dI(iI,t,i),pR(e);var n=gR(t);return pR(i),aR(tI,n)?(i.enumerable?(aR(e,jR)&&e[jR][n]&&(e[jR][n]=!1),i=yR(i,{enumerable:vR(0,!1)})):(aR(e,jR)||$R(e,jR,vR(1,{})),e[jR][n]=!0),aI(e,n,i)):$R(e,n,i)},lI=function(e,t){pR(e);var i=fR(t),n=ER(i).concat(mI(i));return UR(n,(function(t){rR&&!iR(hI,i,t)||dI(e,t,i[t])})),e},hI=function(e){var t=gR(e),i=iR(ZR,this,t);return!(this===KR&&aR(tI,t)&&!aR(iI,t))&&(!(i||!aR(this,t)||!aR(tI,t)||aR(this,jR)&&this[jR][t])||i)},uI=function(e,t){var i=fR(e),n=gR(t);if(i!==KR||!aR(tI,n)||aR(iI,n)){var r=XR(i,n);return!r||!aR(tI,n)||aR(i,jR)&&i[jR][n]||(r.enumerable=!0),r}},pI=function(e){var t=QR(fR(e)),i=[];return UR(t,(function(e){aR(tI,e)||aR(NR,e)||eI(i,e)})),i},mI=function(e){var t=e===KR,i=QR(t?iI:fR(e)),n=[];return UR(i,(function(e){!aR(tI,e)||t&&!aR(KR,e)||eI(n,tI[e])})),n};if(sR||(PR(qR=(GR=function(){if(hR(qR,this))throw zR("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?_R(arguments[0]):void 0,t=DR(e),i=function(e){this===KR&&iR(i,iI,e),aR(this,jR)&&aR(this[jR],t)&&(this[jR][t]=!1),aI(this,t,vR(1,e))};return rR&&oI&&aI(KR,t,{configurable:!0,set:i}),cI(t,e)}).prototype,"toString",(function(){return WR(this).tag})),PR(GR,"withoutSetter",(function(e){return cI(DR(e),e)})),IR.f=hI,CR.f=dI,RR.f=lI,TR.f=uI,SR.f=bR.f=pI,wR.f=mI,xR.f=function(e){return cI(kR(e),e)},rR&&$R(qR,"description",{configurable:!0,get:function(){return WR(this).description}})),QC({global:!0,wrap:!0,forced:!sR,sham:!sR},{Symbol:GR}),UR(ER(sI),(function(e){LR(e)})),QC({target:VR,stat:!0,forced:!sR},{for:function(e){var t=_R(e);if(aR(nI,t))return nI[t];var i=GR(t);return nI[t]=i,rI[i]=t,i},keyFor:function(e){if(!uR(e))throw zR(e+" is not a symbol");if(aR(rI,e))return rI[e]},useSetter:function(){oI=!0},useSimple:function(){oI=!1}}),QC({target:"Object",stat:!0,forced:!sR,sham:!rR},{create:function(e,t){return void 0===t?yR(e):lI(yR(e),t)},defineProperty:dI,defineProperties:lI,getOwnPropertyDescriptor:uI}),QC({target:"Object",stat:!0,forced:!sR},{getOwnPropertyNames:pI,getOwnPropertySymbols:mI}),QC({target:"Object",stat:!0,forced:oR((function(){wR.f(1)}))},{getOwnPropertySymbols:function(e){return wR.f(mR(e))}}),YR&&QC({target:"JSON",stat:!0,forced:!sR||oR((function(){var e=GR();return"[null]"!=YR([e])||"{}"!=YR({a:e})||"{}"!=YR(Object(e))}))},{stringify:function(e,t,i){var n=AR(arguments),r=t;if((lR(t)||void 0!==e)&&!uR(e))return cR(t)||(t=function(e,t){if(dR(r)&&(t=iR(r,this,e,t)),!uR(t))return t}),n[1]=t,tR(YR,null,n)}}),!qR[BR]){var fI=qR.valueOf;PR(qR,BR,(function(e){return iR(fI,this)}))}MR(GR,VR),NR[jR]=!0,$C("asyncIterator"),$C("hasInstance"),$C("isConcatSpreadable"),$C("iterator"),$C("match"),$C("matchAll"),$C("replace"),$C("search"),$C("species"),$C("split"),$C("toPrimitive"),$C("toStringTag"),$C("unscopables"),ia(p.JSON,"JSON",!0);var gI=Y.Symbol;$C("asyncDispose"),$C("dispose"),$C("matcher"),$C("metadata"),$C("observable"),$C("patternMatch"),$C("replaceAll");var _I=gI,vI=GC.f("asyncIterator"),yI=vI;function EI(e){this.wrapped=e}function SI(e){var t,i;function n(t,i){try{var s=e[t](i),o=s.value,a=o instanceof EI;EC.resolve(a?o.wrapped:o).then((function(e){a?n("return"===t?"return":"next",e):r(s.done?"return":"normal",e)}),(function(e){n("throw",e)}))}catch(e){r("throw",e)}}function r(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,r){return new EC((function(s,o){var a={key:e,arg:r,resolve:s,reject:o,next:null};i?i=i.next=a:(t=i=a,n(e,r))}))},"function"!=typeof e.return&&(this.return=void 0)}function bI(e){return function(){return new SI(e.apply(this,arguments))}}function wI(e){return new EI(e)}SI.prototype["function"==typeof _I&&yI||"@@asyncIterator"]=function(){return this},SI.prototype.next=function(e){return this._invoke("next",e)},SI.prototype.throw=function(e){return this._invoke("throw",e)},SI.prototype.return=function(e){return this._invoke("return",e)};var TI=GC.f("iterator");function CI(e,t){var i={},n=!1;function r(i,r){return n=!0,r=new EC((function(t){t(e[i](r))})),{done:!1,value:t(r)}}return i[void 0!==_I&&TI||"@@iterator"]=function(){return this},i.next=function(e){return n?(n=!1,e):r("next",e)},"function"==typeof e.throw&&(i.throw=function(e){if(n)throw n=!1,e;return r("throw",e)}),"function"==typeof e.return&&(i.return=function(e){return n?(n=!1,e):r("return",e)}),i}var RI=vI,II={exports:{}};function AI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function PI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?AI(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):AI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function OI(e,t,i,n,r,s,o){let a=[],c=[],d=[],l=[],h=!1,u=!1;if(II.exports.parse(e).mediaDescriptions.forEach((e=>{o&&o!==e.attributes.direction||("video"!==e.media.mediaType||h||(c=e.attributes.payloads,l=e.attributes.extmaps,h=!0),"audio"!==e.media.mediaType||u||(a=e.attributes.payloads,d=e.attributes.extmaps,u=!0))})),!l||0===c.length)throw new Error("Cannot get video capabilities from SDP.");if(!d||0===a.length)throw new Error("Cannot get audio capabilities from SDP.");return c.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate))})),a.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate))})),t&&(a=a.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),c=c.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),i&&(c=c.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),n&&(a=a.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(null==r?void 0:r.length)>0&&(a=a.filter((e=>{var t;return r.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),s&&(null==s?void 0:s.length)>0&&(c=c.filter((e=>{var t;return s.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),{audioCodecs:a,videoCodecs:c,audioExtensions:d,videoExtensions:l}}function NI(e){const t=II.exports.parse(e);let i,n;for(const r of t.mediaDescriptions){if(!i){const e=r.attributes.iceUfrag,t=r.attributes.icePwd;if(!e||!t)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:e,icePwd:t}}if(!n){const e=r.attributes.fingerprints;e.length>0&&(n={fingerprints:e})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function DI(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),r=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),s=e.attributes.ssrcs;if(r)r.ssrcIds.forEach((e=>{var r;const s=null===(r=n.find((t=>t.ssrcIds[0]===e)))||void 0===r?void 0:r.ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],r=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?r:void 0})}else{if(0===s.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:s[0].ssrcId})}return i}function kI(e,t){const{cname:i}=e;let n;t&&t.ip&&"number"==typeof t.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],Pf.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),Pf.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):n=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const r={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},s={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let o;switch(e.dtlsParameters.role){case"server":o="passive";break;case"client":o="active";break;case"auto":o="actpass"}return{dtlsParameters:r,iceParameters:s,candidates:n,rtpCapabilities:WI(e.rtpCapabilities),setup:o,cname:i}}function xI(e,t,i){const n=[],r=[];return e.forEach((e=>{let{ssrcId:s,rtx:o}=e;const a=Wb(8,"track-"),c={ssrcId:s,attributes:PI({label:a,mslabel:i=i||Wb(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(n.push(c),void 0!==o){const e={ssrcId:o,attributes:PI({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};n.push(e),r.push({semantic:"FID",ssrcIds:[s,o]})}})),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:r}}function LI(e,t){t instanceof fb&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const r=t._encoderConfig;r&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(r.bitrate&&!Gu()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*r.bitrate))),r.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(r.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(r.sampleRate)),r.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function MI(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function FI(e,t){if(!(t instanceof mC&&t._encoderConfig&&-1===t._hints.indexOf(uv.SCREEN_TRACK)))return;const i=t._encoderConfig;Vv().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),Vv().supportMinBitrate&&!t._hints.includes(uv.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(Kf("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function UI(e){if("video"!==e.media.mediaType)return;const t=Mu();if(t.name!==Nu.SAFARI&&t.os!==Ou.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function jI(e,t,i){if(!t)return;let n,r;if("video"===e.media.mediaType?(n=i.videoExtensions,r=i.videoCodecs):(n=i.audioExtensions,r=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&(e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(r,e.attributes.payloads).forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})})))}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));t&&(e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(r,e.attributes.payloads).forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})})))}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function VI(e,t,i){if(Gu())return;if("video"!==e.media.mediaType)return;if(!(t instanceof mC))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!Kf("SIMULCAST"))return;if(void 0===t._scalabiltyMode||t._scalabiltyMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabiltyMode.numSpatialLayers,r=e.attributes.ssrcs[0],s=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===r.ssrcId)),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<n;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:tw(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(e.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:tw(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(o)}async function BI(e,t,i,n,r){const s=new RTCPeerConnection;s.addTransceiver("video",{direction:"sendonly"}),s.addTransceiver("audio",{direction:"sendonly"}),s.addTransceiver("video",{direction:"recvonly"}),s.addTransceiver("audio",{direction:"recvonly"});const o=(await s.createOffer()).sdp,a=OI(o,e,t,i,n,r,"sendonly"),c=OI(o,e,t,i,n,r,"recvonly"),d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(HI(a,c,"videoExtensions",d,l,h),HI(a,c,"videoCodecs",d,l,h),HI(a,c,"audioExtensions",d,l,h),HI(a,c,"audioCodecs",d,l,h),Kf("RAISE_H264_BASELINE_PRIORITY")){const e=h.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const t=h.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(t<e){Pf.debug("raising H264 baseline profile priority");const i=h.videoCodecs[e];h.videoCodecs.splice(e,1),h.videoCodecs.splice(t,0,i)}-1!==t&&(l.videoCodecs=l.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==t&&Kf("FILTER_SEND_H264_BASELINE")&&(d.videoCodecs=d.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}try{s.close()}catch(e){}return{send:d,recv:l,sendrecv:h}}function HI(e,t,i,n,r,s){if("videoExtensions"===i||"audioExtensions"===i){const o=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return o.push(i),!0}))?s[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===o.indexOf(t)&&r[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const o=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return o.push(i),!0}))?s[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===o.indexOf(t)&&r[i].push(e)}))}}function WI(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let r,s;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...n.audioCodecs],r.videoCodecs=[...t.videoCodecs,...n.videoCodecs],r.audioExtensions=[...t.audioExtensions,...n.audioExtensions],r.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):r=n,i?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...i.audioCodecs,...n.audioCodecs],s.videoCodecs=[...i.videoCodecs,...n.videoCodecs],s.audioExtensions=[...i.audioExtensions,...n.audioExtensions],s.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):s=n,{send:r,recv:s}}function KI(e){"audio"===e.media.mediaType&&e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}!function(e,t){e.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>b,Printer:()=>I,parse:()=>N,print:()=>D});const n="\n",r="".concat("\r").concat(n),s=" ";let o;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="Â"&&e<="Ã¿"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function m(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"Ã¿"}function f(e){return u(e)||a(e)||"+"===e||"/"===e}function g(e){return a(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function _(e){return u(e)||a(e)||"+"===e||"/"===e}function v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function y(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?v(Object(i),!0).forEach((function(t){E(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function E(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(o||(o={}));class S{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,s)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===s)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let n=0;n<4;n++)if(i=this.consumeDecimalUChar(e,i),3!==n){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let r=0;r<3&&a(e[i]);r++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;a(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),r=parseInt(n);if(r<224||r>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let s=0;s<3;s++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&a(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);a(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,s)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,a),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class b extends S{constructor(){super(),E(this,"records",[]),E(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),r=this.parseSessionName(),s=this.parseInformation(),o=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),m=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:r,information:s,uri:o,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:m}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?r:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new T;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==o.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,m)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new C(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==o.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,m)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===o.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===o.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const r=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:r,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==o.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,a);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==o.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==o.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const r=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:r,addrtype:s,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===o.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==o.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===o.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===o.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const r=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:r}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===o.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===o.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),r=this.parseBandWidth(),s=this.parseKey(),o=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:r,key:s,attributes:o})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===o.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t,...i){const n=t.call(this,e.value,e.cur,...i),r=e.value.slice(e.cur,n);return e.cur=n,r}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==s)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class w extends S{constructor(...e){super(...e),E(this,"attributes",void 0),E(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),r=e.attValue.slice(e._cur,n),[s,o]=i||[];if("number"==typeof s&&r.length<s)throw new Error("error in length, should be more or equal than ".concat(s," characters."));if("number"==typeof o&&r.length>o)throw new Error("error in length, should be less or equal than ".concat(o," characters."));return e._cur=n,r}consumeAttributeSpace(e){if(e.attValue[e._cur]!==s)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t,...i){if(!e.attValue)throw new Error("Nothing to extract from attValue.");const n=t.call(this,e.attValue,e._cur,...i),r=e.attValue.slice(e._cur,n);return e._cur=n,r}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,f,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,f,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,f));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,s),r=y(y({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===s&&(this.consumeAttributeSpace(e),r.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(r)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class T extends w{constructor(...e){super(...e),E(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===s;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,g)}parseIdentity(e){const t=this.extractOneOrMore(e,_),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===s;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==s&&m(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===s&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,s);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class C extends w{constructor(e){super(),E(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,f,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const r=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const o=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:r,connectionAddress:o,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===s;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:r});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const r=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));r?r.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,s);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const r="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=r)}));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,s),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,s);let n;switch(i){case"trr-int":n={type:i,interval:this.extract(e,this.consumeTill)};break;case"ack":case"nack":default:{const t={type:i};this.peekChar(e)===s&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===s&&(t.additional=this.extract(e,this.consumeTill))),n=t}}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===s&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===s&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===s){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===s&&this.extract(e,this.consume,s)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}case"max-width":case"height-width":case"max-fps":case"max-fs":case"max-br":case"max-pps":case"max-bpp":default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class I{constructor(){R(this,"eol",r)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new P(this.eol).print(e)}printMediaAttributes(e){return new O(this.eol).print(e)}}class A{constructor(e){R(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(s)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(s).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(s).concat(e.extensionName).concat(e.extensionAttributes?"".concat(s).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class P extends A{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(s).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(s).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(s,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(s).concat(e)))),t+this.eol}}class O extends A{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(s).concat(e.componentId).concat(s).concat(e.transport).concat(s).concat(e.priority).concat(s).concat(e.connectionAddress).concat(s).concat(e.port).concat(s,"typ").concat(s).concat(e.type).concat(e.relAddr?"".concat(s,"raddr").concat(s).concat(e.relAddr):"").concat(e.relPort?"".concat(s,"rport").concat(s).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(s).concat(t).concat(s).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(s)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const n of t)i+=this.printRtpMap(n.payloadType,n.rtpMap),i+=this.printFmtp(n.payloadType,n.fmtp),i+=n.rtcpFeedbacks.map((e=>this.printRTCPFeedback(n.payloadType,e))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(s).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(s).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(s).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(s),n=t;switch(n.type){case"trr-int":i+="ttr-int".concat(s).concat(n.interval);break;case"ack":case"nack":default:i+="".concat(n.type),n.parameter&&(i+="".concat(s).concat(n.parameter),n.additional&&(i+="".concat(s).concat(n.additional)))}return i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(s).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(s).concat(e.netType)),e.addressType&&(t+="".concat(s).concat(e.addressType)),e.address&&(t+="".concat(s).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(s).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(s).concat(e.direction);return e.payloads&&(t+="".concat(s,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(s).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(s).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function N(e){return(new b).parse(e)}function D(e,t){return(new I).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})()}(II);class GI{constructor(e){fp(this,"sessionDesc",void 0),fp(this,"localCapabilities",void 0),fp(this,"rtpCapabilities",void 0),fp(this,"candidates",void 0),fp(this,"iceParameters",void 0),fp(this,"dtlsParameters",void 0),fp(this,"setup",void 0),fp(this,"currentMidIndex",void 0),fp(this,"cname",void 0),e=tw(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,remoteSetup:s,localCapabilities:o,sdkCodec:a,cname:c}=e,d=II.exports.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=r,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=s,this.localCapabilities=o,this.cname=c;for(let l=0;l<d.mediaDescriptions.length;l++){const e=d.mediaDescriptions[l];if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=s,"video"===e.media.mediaType){e.media.fmts=r.videoCodecs.map((e=>e.payloadType.toString(10)));const t=r.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes(a)}));if(0===t.length)throw new Error("Codec ".concat(a," not supported by remote SDP."));e.attributes.payloads=t,e.attributes.extmaps=r.videoExtensions}"audio"===e.media.mediaType&&(e.media.fmts=r.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=r.audioCodecs,e.attributes.extmaps=r.audioExtensions),d.mediaDescriptions[l]=this.mungMediaDesc(e)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return II.exports.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:r}=xI(t,this.cname),s=this.sessionDesc.mediaDescriptions.find((t=>e===Cv.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),o=n[0].attributes.label,a=n[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(n),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(r),{id:o,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],r=[];t.attributes.ssrcs.forEach((t=>{e.includes(t.attributes.label||"")?r.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{r.map((e=>e.ssrcId)).includes(e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=r}))}stopReceiving(e){}restartICE(e){e=tw(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=tw(e);return LI(i,t),FI(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===Cv.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var r;e&&(e.attributes.label=i,null===(r=e.attributes.msid)||void 0===r||r.replace(t,i))}}mungMediaDesc(e){const t=tw(e);return MI(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}function qI(e){if(Array.isArray(e))return e.map((e=>e));if(!zI(e))return e;const t={};for(const i in e)zI(e[i])||Array.isArray(e[i])?t[i]=qI(e[i]):t[i]=e[i];return t}function zI(e){return!("object"!=typeof e||Array.isArray(e)||!e)}function JI(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}function YI(e){return!!window.RTCStatsReport&&e.getStats()instanceof yh}class XI{constructor(e){fp(this,"input",[]),fp(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const $I={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},QI={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:$I,remoteCandidate:$I}},ZI={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},eA={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,qpSumPerFrame:0},tA={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0},iA={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class nA{constructor(e,t){fp(this,"onFirstVideoReceived",void 0),fp(this,"onFirstVideoDecoded",void 0),fp(this,"onFirstAudioReceived",void 0),fp(this,"onFirstVideoDecodedTimeout",void 0),fp(this,"onFirstAudioDecoded",void 0),fp(this,"onSelectedLocalCandidateChanged",void 0),fp(this,"onSelectedRemoteCandidateChanged",void 0),fp(this,"videoIsReady",!1),fp(this,"videoIsReady2",{}),fp(this,"pc",void 0),fp(this,"options",void 0),fp(this,"intervalTimer",void 0),fp(this,"stats",qI(QI)),fp(this,"isFirstVideoReceived",{}),fp(this,"isFirstVideoDecoded",{}),fp(this,"isFirstAudioReceived",{}),fp(this,"isFirstAudioDecoded",{}),fp(this,"isFirstVideoDecodedTimeout",{}),fp(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,r=0,s=0,o=0;for(const a of i)e[a].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[t-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[t-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,s+=d):(r+=c,o+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||s<=0?0:s/(n+s),e.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}}function rA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function sA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?rA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):rA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class oA extends nA{constructor(){super(...arguments),fp(this,"_stats",QI),fp(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=qI(QI);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{const t=e.id.includes("send");switch("".concat(e.mediaType,"_").concat(t?"send":"recv")){case"video_send":{const t=qI(eA);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=qI(ZI),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,r=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=r,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:sA({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=qI(iA);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=qI(tA);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new yh(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}function aA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function cA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class dA extends nA{constructor(){super(...arguments),fp(this,"_stats",QI),fp(this,"report",void 0),fp(this,"lastDecodeVideoReceiverStats",new Map),fp(this,"lastVideoFramesRecv",new Map),fp(this,"lastVideoFramesSent",new Map),fp(this,"lastVideoFramesDecode",new Map),fp(this,"lastVideoJBDelay",new Map),fp(this,"lastAudioJBDelay",new Map),fp(this,"mediaBytesSent",new Map),fp(this,"mediaBytesRetransmit",new Map),fp(this,"mediaBytesTargetEncode",new Map),fp(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=qI(QI),this.report.forEach((e=>{switch(e.type){case xu.OUTBOUND:"audio"===e.mediaType?this.processAudioOutboundStats(e):"video"===e.mediaType&&this.processVideoOutboundStats(e);break;case xu.INBOUND:"audio"===e.mediaType?this.processAudioInboundStats(e):"video"===e.mediaType&&this.processVideoInboundStats(e);break;case xu.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case xu.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===xu.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===xu.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===xu.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(cA({},t),cA({},this.stats.selectedCandidatePair.localCandidate)),e.type===xu.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(cA({},t),cA({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=qI(iA),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=qI(ZI),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),r=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,s=r-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&s>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&r-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((r-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:r,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:r,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:cA({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=qI(eA),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new XI(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new XI(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new XI(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,r=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*r/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,xu.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=qI(tA),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,xu.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){var i;const n=Array.from(mS(i=this.report).call(i)).find((i=>i.type===t&&i.ssrc===e));return n?n.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,r,s;const o=t?this.report.get(t):void 0,a=null!==(n=null==o?void 0:o.framesSent)&&void 0!==n?n:e.framesSent;let c=null!==(r=null==o?void 0:o.frameWidth)&&void 0!==r?r:e.frameWidth,d=null!==(s=null==o?void 0:o.frameHeight)&&void 0!==s?s:e.frameHeight;if("number"!=typeof a)return;0!==a||"number"==typeof c&&"number"==typeof d||(c=0,d=0);let l=0;const h=Date.now(),u=this.lastVideoFramesSent.get(i.ssrc);u&&h-u.lts>=800?(l=Math.round((a-u.count)/((h-u.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:l})):u?l=u.rate:this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:0}),i.sentFrame={width:c,height:d,frameRate:Math.max(0,l)}}processVideoTrackReceiverStats(e,t,i){var n,r,s,o,a;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(r=null==c?void 0:c.frameWidth)&&void 0!==r?r:e.frameWidth,h=null!==(s=null==c?void 0:c.frameHeight)&&void 0!==s?s:e.frameHeight,u=null!==(o=null==c?void 0:c.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){let e=this.lastVideoJBDelay.get(i.ssrc);this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p}),e||(e={jitterBufferDelay:0,jitterBufferEmittedCount:0});const t=1e3*(u-e.jitterBufferDelay)/(p-e.jitterBufferEmittedCount);i.jitterBufferMs=t,i.currentDelayMs=Math.round(t)}}processAudioTrackSenderStats(e,t,i){var n,r,s,o;const a=t?this.report.get(t):void 0,c=null!==(n=null!==(r=null==a?void 0:a.echoReturnLoss)&&void 0!==r?r:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(s=null!==(o=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==o?o:e.echoReturnLossEnhancement)&&void 0!==s?s:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,r,s,o,a,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(r=null==l?void 0:l.totalSamplesReceived)&&void 0!==r?r:e.totalSamplesReceived,p=null!==(s=null==l?void 0:l.jitterBufferDelay)&&void 0!==s?s:e.jitterBufferDelay,m=null!==(o=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==o?o:e.jitterBufferEmittedCount,f=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,g=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,_=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&m){let e=this.lastAudioJBDelay.get(i.ssrc);this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:m}),e||(e={jitterBufferDelay:0,jitterBufferEmittedCount:0});const t=1e3*(p-e.jitterBufferDelay)/(m-e.jitterBufferEmittedCount);i.jitterBufferMs=Math.round(t)}i.outputLevel=f;let v=1920;g&&u&&(v=u/g/50,i.receivedFrames=Math.round(u/v)),_&&(i.droppedFrames=Math.round(_/v))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class lA extends nA{updateStats(){return yh.resolve()}}function hA(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const s=JI();return s?s<76?new oA(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new dA(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):YI(e)?new dA(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new lA(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r})}var uA;function pA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function mA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?pA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let fA=(Zy((uA=class e extends Uv{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(t,i){super(t,i),fp(this,"store",void 0),fp(this,"peerConnection",void 0),fp(this,"remoteSDP",void 0),fp(this,"initialOffer",void 0),fp(this,"statsFilter",void 0),fp(this,"useRTX",!1),fp(this,"localCapabilities",void 0),fp(this,"localCandidateCount",0),fp(this,"allCandidatesReceived",!1),fp(this,"establishPromise",void 0),fp(this,"mutex",new AE("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=hA(this.peerConnection,void 0,void 0,Gu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=NI(e.sdp),i=OI(e.sdp,!this.useRTX,Kf("FILTER_VIDEO_FEC"),Kf("FILTER_AUDIO_FEC"),["opus"]);return this.localCapabilities=i,this.initialOffer=e,mA(mA({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new Ef(yf.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,r,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new GI({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:r,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:s});const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t){var i=this;return bI((function*(){const n=yield wI(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const n=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),r=yield wI(i.peerConnection.createOffer()),s=II.exports.parse(r.sdp),o=e.map((e=>{const t=e._mediaStreamTrack,n=s.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),r=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(r&&n.length>1){const e=r.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let a;try{a=yield o}catch(e){throw n.forEach((e=>{Ku()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const c=i.mungSendOfferSDP(r.sdp,e);i.remoteSDP.receive(e,t,a);const d=i.remoteSDP.toString();return yield wI(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield wI(i.applySendEncodings(n,e)),yield wI(i.peerConnection.setRemoteDescription({type:"answer",sdp:d})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:o[t],id:i}}))}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{Ku()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:r}=this.remoteSDP.send(e,t,n),s=new yh(((t,n)=>{const s=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),o=n=>{const a=Mu();if(("Safari"===a.name&&11===Number(a.version)||qu())&&n.track.id!==i&&n.streams[0].id===r){var c;const r=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",o),clearTimeout(s),void t(r)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",o),clearTimeout(s),void t(n.track)};this.peerConnection.addEventListener("track",o)})),o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await s,id:i}}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(Ku()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(Ku()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(){var e=this;return bI((function*(){const t=yield wI(e.mutex.lock("From P2PConnection.restartICE"));try{const t=yield wI(e.peerConnection.createOffer({iceRestart:!0}));if(!t.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=NI(t.sdp),{remoteIceParameters:n}=yield i.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(n);const r=e.remoteSDP.toString();yield wI(e.peerConnection.setLocalDescription(t)),yield wI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){Pf.warning("restart ICE failed, abort operation",e)}finally{t()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Kf("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(F_(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Kf("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,t){try{if(!Vv().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){var i;const r=e[n],s=t[n];if(!s)continue;const o={},a={};if(s instanceof mC)switch(s._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(Kf("DSCP_TYPE")&&sp()){const e=Kf("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(a.networkPriority=e)}const c=r.getParameters(),d=null===(i=c.encodings)||void 0===i?void 0:i[0];d&&Object.assign(d,a),Object.assign(c,o),await r.setParameters(c)}}catch(e){Pf.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t){const i=II.exports.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,r=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));r&&LI(r,e)})),II.exports.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:r}=t;const{kind:s}=e[i];return new yh(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),o=t=>{const a=Mu();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==n&&t.streams[0].id===r){var c;const r=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(s,n,t.track.id),this.peerConnection.removeEventListener("track",o),clearTimeout(i),void e({track:r,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",o),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",o)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await yh.all(t)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(Vv().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"connect"),uA.prototype),Zy(uA.prototype,"stopSending",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"stopSending"),uA.prototype),Zy(uA.prototype,"receive",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"receive"),uA.prototype),Zy(uA.prototype,"stopReceiving",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"stopReceiving"),uA.prototype),Zy(uA.prototype,"muteRemote",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"muteRemote"),uA.prototype),Zy(uA.prototype,"unmuteRemote",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"unmuteRemote"),uA.prototype),Zy(uA.prototype,"muteLocal",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"muteLocal"),uA.prototype),Zy(uA.prototype,"unmuteLocal",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"unmuteLocal"),uA.prototype),Zy(uA.prototype,"close",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"close"),uA.prototype),Zy(uA.prototype,"updateEncoderConfig",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"updateEncoderConfig"),uA.prototype),Zy(uA.prototype,"updateSendParameters",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"updateSendParameters"),uA.prototype),Zy(uA.prototype,"replaceTrack",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"replaceTrack"),uA.prototype),Zy(uA.prototype,"getRemoteSSRC",[gA],Object.getOwnPropertyDescriptor(uA.prototype,"getRemoteSSRC"),uA.prototype),uA);function gA(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await n.apply(this,s)}finally{i()}},i}const _A="9",vA=4e4;class yA{get localCapabilities(){return tw(this._localCapabilities)}get rtpCapabilities(){return tw(this._rtpCapabilities)}get candidates(){return tw(this._candidates)}get iceParameters(){return tw(this._iceParameters)}get dtlsParameters(){return tw(this._dtlsParameters)}constructor(e){fp(this,"sessionDesc",void 0),fp(this,"_localCapabilities",void 0),fp(this,"_rtpCapabilities",void 0),fp(this,"_candidates",void 0),fp(this,"_iceParameters",void 0),fp(this,"_dtlsParameters",void 0),fp(this,"setup",void 0),fp(this,"currentMidIndex",void 0),fp(this,"cname",void 0),fp(this,"firefoxSsrcMidMap",new Map),e=tw(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,remoteSetup:s,localCapabilities:o,cname:a}=e,c=II.exports.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=r,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o,this.setup=s,this.cname=a;const d=this.rtpCapabilities.send;for(const l of c.mediaDescriptions){if(l.attributes.iceUfrag=t.iceUfrag,l.attributes.icePwd=t.icePwd,l.attributes.fingerprints=i.fingerprints,l.attributes.candidates=n,l.attributes.setup=s,"video"===l.media.mediaType&&(l.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.videoCodecs,l.attributes.extmaps=d.videoExtensions,Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:vA,rtx:Kf("USE_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}if("audio"===l.media.mediaType&&(l.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.audioCodecs,l.attributes.extmaps=d.audioExtensions,KI(l),Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:2e4}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=Kf("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,r=this.rtpCapabilities.send;for(let s=1;s<e;s++){const e=2*s+2e4,o=2*s+vA,{ssrcs:a,ssrcGroups:c}=xI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=xI([{ssrcId:o,rtx:Kf("USE_RTX")?o+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:_A,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:_A,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return II.exports.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:r,ssrcGroups:s}=xI(t,this.cname,Kf("SYNC_GROUP")?i:void 0),o=this.findPreloadMediaDesc(r);if(o){if(Gu()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let i;return-1===t||1===t&&(Ku()||Xu())||$u()?(i=this.createOrRecycleSendMedia(e,r,s,"sendonly",n),this.updateBundleMids()):(i=tw(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=r,i.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),Gu()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||Gu()||$u()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}restartICE(e){e=tw(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(Gu()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,t,i,n,r,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=this.localCapabilities.send;let d=[];if(o===Cv.VIDEO){var l,h;if(Kf("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(d=a.videoCodecs.filter((e=>{var t,i;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(n)&&(null==e||null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])===Kf("H264_PROFILE_LEVEL_ID")}))),!d||0===(null===(l=d)||void 0===l?void 0:l.length)){const e=c.videoCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(n)}));0!==e.length&&(d=a.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(Kf("USE_RTX")){const e=d.map((e=>e.payloadType.toString())),t=a.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&e.includes((null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));d=[...d,...t]}0===d.length&&(Pf.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(h=a.videoCodecs[0].rtpMap)||void 0===h?void 0:h.encodingName)),d=a.videoCodecs)}else d=a.audioCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(r)})),0===d.length&&(Pf.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),d=a.audioCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes("opus")})));const u=o===Cv.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let m={media:{mediaType:o,port:_A,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};m=this.mungRecvMediaDsec(m,e,s);const f=this.findFirstClosedMedia(o);if(f){const e=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[e]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(e,t,i,n,r){const s=this.rtpCapabilities.send,o=e===Cv.VIDEO?s.videoCodecs:s.audioCodecs,a=e===Cv.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:_A,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=tw(e);return MI(n),LI(n,t),FI(n,t),UI(n),jI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=tw(e);return jI(i,t,this.localCapabilities.recv),KI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Gu()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i,n;return(null===(i=t.attributes)||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var EA;function SA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function bA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?SA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):SA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let wA=(Zy((EA=class e extends Uv{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(t,i){super(t,i),fp(this,"store",void 0),fp(this,"peerConnection",void 0),fp(this,"remoteSDP",void 0),fp(this,"initialOffer",void 0),fp(this,"transportEventReceiver",void 0),fp(this,"statsFilter",void 0),fp(this,"useRTX",Kf("USE_RTX")),fp(this,"localCapabilities",void 0),fp(this,"localCandidateCount",0),fp(this,"allCandidatesReceived",!1),fp(this,"establishPromise",void 0),fp(this,"mutex",new AE("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=hA(this.peerConnection,void 0,void 0,Gu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=NI(e.sdp),i=await BI(!this.useRTX,Kf("FILTER_VIDEO_FEC"),Kf("FILTER_AUDIO_FEC"));return this.localCapabilities=WI(i),this.initialOffer=e,bA(bA({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new Ef(yf.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,r,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new yA({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:r,localCapabilities:this.localCapabilities,cname:s});const o=this.remoteSDP.toString(),a=II.exports.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&KI(c);const d=II.exports.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});const h=this.peerConnection.getTransceivers()[0];if(null!=h&&h.receiver&&this.tryBindTransportEvents(h.receiver),Kf("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return bI((function*(){const r=yield wI(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t)})),Gu()&&!0===Kf("SIMULCAST")&&(yield wI(n.applySimulcastForFirefox(s,e)));const o=yield wI(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(o.sdp,e,a),d=II.exports.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return DI(t,n.useRTX)}));let h;try{h=yield l}catch(r){h=[],n.remoteSDP.receive(e,t,i,h);const s=n.remoteSDP.toString();throw yield wI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield wI(n.peerConnection.setRemoteDescription({type:"answer",sdp:s})),yield wI(n.stopSending(a,!0)),r}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield wI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield wI(n.applySimulcastEncodings(s,e)),yield wI(n.applySendEncodings(s,e)),null==p||p(u),yield wI(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),s.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof Ef?e:new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,n);if(s){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),s=this.mungReceiveAnswerSDP(n.sdp,r,e);null==i||i(s||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:s}),Pf.debug("[P2PConnection] receive ".concat(e," by exchanging SDP."))}else Pf.debug("[P2PConnection] receive ".concat(e," no need to exchange SDP."));const o=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();null==t||t(i.sdp||""),await this.peerConnection.setLocalDescription(i),Pf.debug("[P2PConnection] batchReceive by exchanging SDP.")}else Pf.debug("[P2PConnection] batchReceive no need to exchange SDP.");return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(){var e=this;return bI((function*(){const t=yield wI(e.mutex.lock("From P2PConnection.restartICE"));try{const t=yield wI(e.peerConnection.createOffer({iceRestart:!0}));if(!t.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=NI(t.sdp),{remoteIceParameters:n}=yield i.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(n);const r=e.remoteSDP.toString(),s=e.logSDPExchange(t.sdp||"","offer","local","restartICE");yield wI(e.peerConnection.setLocalDescription(t)),null==s||s(r),yield wI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){Pf.warning("restart ICE failed, abort operation",e)}finally{t()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),s=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==s||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?Gu()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Kf("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(F_(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Kf("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Kf("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ab(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Kf("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){e.transport&&(this.transportEventReceiver=e,e.transport.onstatechange=()=>{var t,i;null!==(t=e.transport)&&void 0!==t&&t.state&&(null===(i=this.onDTLSTransportStateChange)||void 0===i||i.call(this,e.transport.state))},e.transport.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,e.error)},e.transport.iceTransport&&(e.transport.iceTransport.onstatechange=()=>{var t;const i=null===(t=e.transport)||void 0===t?void 0:t.iceTransport.state;var n;i&&(null===(n=this.onICETransportStateChange)||void 0===n||n.call(this,i))}))}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async applySendEncodings(e,t){try{if(!Vv().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let c=0;c<e.length;c++){const d=e[c],l=t[c];if(l&&l instanceof mC){var i,n;if(this.isVP8Simulcast(l))continue;const e={},t={};switch(l._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var r,s,o,a;if(null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(t.maxBitrate=1e3*(null===(r=l._encoderConfig)||void 0===r?void 0:r.bitrateMax)),l._hints.includes(uv.LOW_STREAM)&&(null!==(s=l._encoderConfig)&&void 0!==s&&s.frameRate&&(t.maxFramerate=Ob(l._encoderConfig.frameRate)),null!==(o=l._encoderConfig)&&void 0!==o&&o.scaleResolutionDownBy&&(null===(a=l._encoderConfig)||void 0===a?void 0:a.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=l._encoderConfig.scaleResolutionDownBy)),Kf("DSCP_TYPE")&&sp()){const e=Kf("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(t.networkPriority=e)}const c=d.sender.getParameters(),h=null===(n=c.encodings)||void 0===n?void 0:n[0];Gu()&&!h&&(e.encodings=[t]),h&&Object.assign(h,t),Object.assign(c,e),await d.sender.setParameters(c)}}}catch(e){Pf.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=II.exports.parse(e);return t.forEach(((e,t)=>{const r=i[t],s=n.mediaDescriptions.find((e=>e.attributes.mid===r));s&&(LI(s,e),VI(s,e,this.store.codec))})),II.exports.print(n)}mungReceiveAnswerSDP(e,t,i){const n=II.exports.parse(e),r=n.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&i===Cv.AUDIO&&"audio"===r.media.mediaType&&KI(r),II.exports.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let o=0;o<e.length;o++){var i,n,r,s;const a=e[o],c=t[o];if(c instanceof mC&&!c._hints.includes(uv.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(r=c._scalabiltyMode)&&void 0!==r&&r.numSpatialLayers&&(null===(s=c._scalabiltyMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!Gu()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof mC&&this.isVP8Simulcast(n)){const t=e[i],r={},s={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:s.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:s.medium,scaleResolutionDownBy:4}];const o=t.sender.getParameters();await t.sender.setParameters(Object.assign(o,r))}}}isVP8Simulcast(e){var t,i,n,r;return!!(e instanceof mC&&Kf("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(uv.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabiltyMode)&&void 0!==n&&n.numSpatialLayers&&(null===(r=e._scalabiltyMode)||void 0===r?void 0:r.numSpatialLayers)>1)}logSDPExchange(e,t,i,n){if(Kf("SDP_LOGGING"))return Pf.upload("exchanging ".concat(i," ").concat(t," SDP during P2PConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(Vv().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"connect"),EA.prototype),Zy(EA.prototype,"receive",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"receive"),EA.prototype),Zy(EA.prototype,"batchReceive",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"batchReceive"),EA.prototype),Zy(EA.prototype,"stopReceiving",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"stopReceiving"),EA.prototype),Zy(EA.prototype,"muteRemote",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"muteRemote"),EA.prototype),Zy(EA.prototype,"unmuteRemote",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"unmuteRemote"),EA.prototype),Zy(EA.prototype,"muteLocal",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"muteLocal"),EA.prototype),Zy(EA.prototype,"unmuteLocal",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"unmuteLocal"),EA.prototype),Zy(EA.prototype,"close",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"close"),EA.prototype),Zy(EA.prototype,"updateEncoderConfig",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"updateEncoderConfig"),EA.prototype),Zy(EA.prototype,"updateSendParameters",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"updateSendParameters"),EA.prototype),Zy(EA.prototype,"replaceTrack",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"replaceTrack"),EA.prototype),Zy(EA.prototype,"getRemoteSSRC",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"getRemoteSSRC"),EA.prototype),EA);function TA(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await n.apply(this,s)}finally{i()}},i}function CA(e,t){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=Ob(t.width),n.height=Ob(t.height);const r=Ob(t.framerate||15);document.body.append(i),document.body.append(n);let s=e._mediaStreamTrack;i.srcObject=new MediaStream([s]),i.play();const o=n.getContext("2d");if(!o)throw new Ef(yf.UNEXPECTED_ERROR,"can not get canvas context");const a=Vv(),c=n.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0],d=VE((()=>(()=>{if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const e=i.videoWidth,t=i.videoHeight/e,r=n.width*t;Math.abs(r-n.height)>=2&&(Pf.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(r)),n.height=r)}o.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),s!==e._mediaStreamTrack&&(s=e._mediaStreamTrack,i.srcObject=new MediaStream([s]))})()),r),l=c.stop;return c.stop=()=>{l.call(c),d(),i&&(i.remove(),i=null),n&&(n.width=0,n.remove(),n=null),Pf.debug("clean low stream renderer")},c}var RA,IA,AA,PA,OA,NA,DA,kA,xA,LA,MA,FA;function UA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function jA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?UA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):UA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class VA extends CE{getUserId(){return this._userId}constructor(e,t,i,n){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(n.clientId,"_").concat(Wb(5,""))),fp(this,"_userId",void 0),fp(this,"_uintId",void 0),fp(this,"_isDestroyed",!1),fp(this,"store",void 0),fp(this,"processor",void 0),fp(this,"processorContext",void 0),this._userId=t,this._uintId=i,this.store=n}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,Pf.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let BA=(RA=wE({argsMap:(e,t,i)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),IA=wE({argsMap:e=>[e.getTrackId()]}),AA=wE({argsMap:(e,t)=>[e.getTrackId(),t.name]}),PA=wE({argsMap:e=>[e.getTrackId()]}),Zy((OA=class extends VA{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==a_.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,i,n){super(e,t,i,n),fp(this,"_videoVisibleTimer",null),fp(this,"_previousVideoVisibleStatus",void 0),fp(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),fp(this,"trackMediaType","video"),fp(this,"_videoWidth",void 0),fp(this,"_videoHeight",void 0),fp(this,"_player",void 0),fp(this,"processorDestination",void 0),fp(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new vS(this.getTrackId(),"remote"),this.processorDestination=new _S(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return nw((()=>{Pf.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),Xb(this,hv.GET_STATS)||jA({},K_)}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(Pf.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}Pf.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const i=jA(jA({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new wT(i):this._player=new CT(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.emit(gv.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.emit(gv.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Kf("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Pf.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){qb(this._originMediaStreamTrack).then((e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t})).catch(Gb)}_updatePlayerSource(){Pf.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const i=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),n={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:r,slot:s}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const e=hC.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new Ef(yf.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new Ef(yf.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Nv.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Nv.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}).prototype,"play",[RA],Object.getOwnPropertyDescriptor(OA.prototype,"play"),OA.prototype),Zy(OA.prototype,"stop",[IA],Object.getOwnPropertyDescriptor(OA.prototype,"stop"),OA.prototype),Zy(OA.prototype,"pipe",[AA],Object.getOwnPropertyDescriptor(OA.prototype,"pipe"),OA.prototype),Zy(OA.prototype,"unpipe",[PA],Object.getOwnPropertyDescriptor(OA.prototype,"unpipe"),OA.prototype),OA),HA=(NA=wE({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),DA=wE({argsMap:(e,t)=>[e.getTrackId(),t]}),kA=wE({argsMap:e=>[e.getTrackId()]}),xA=wE({argsMap:e=>[e.getTrackId()]}),LA=wE({argsMap:(e,t)=>[e.getTrackId(),t.name]}),MA=wE({argsMap:e=>[e.getTrackId()]}),Zy((FA=class extends VA{get isPlaying(){return this._useAudioElement?sS.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,i,n){super(e,t,i,n),fp(this,"trackMediaType","audio"),fp(this,"_source",void 0),fp(this,"_useAudioElement",!0),fp(this,"_volume",100),fp(this,"processorContext",void 0),fp(this,"processorDestination",void 0),fp(this,"_played",!1),fp(this,"_bypassWebAudio",!1),Kf("DISABLE_WEBAUDIO")?(this._source=new SS,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new WE(e,!0),Kf("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(x_.RECEIVE_TRACK_BUFFER,(()=>{this.emit(gv.FIRST_FRAME_DECODED)})),this.processorContext=new ES(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new yS(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(x_.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(x_.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(x_.ON_AUDIO_BUFFER),this._source.on(x_.ON_AUDIO_BUFFER,(t=>e(t)))}setVolume(e){this._volume=e,this._useAudioElement?sS.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement)throw new Ef(yf.NOT_SUPPORTED,"your browser does not support setting the audio output device");await sS.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return nw((()=>{Pf.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),Xb(this,hv.GET_STATS)||jA({},H_)}play(){Pf.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(Pf.debug("[".concat(this.getTrackId(),"] use audio element to play")),sS.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){Pf.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?sS.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Pf.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&sS.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new Ef(yf.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new Ef(yf.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new Ef(yf.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Nv.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(Nv.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Nv.ON_TRACK),this.processorDestination.removeAllListeners(Nv.ON_NODE)}}).prototype,"setVolume",[NA],Object.getOwnPropertyDescriptor(FA.prototype,"setVolume"),FA.prototype),Zy(FA.prototype,"setPlaybackDevice",[DA],Object.getOwnPropertyDescriptor(FA.prototype,"setPlaybackDevice"),FA.prototype),Zy(FA.prototype,"play",[kA],Object.getOwnPropertyDescriptor(FA.prototype,"play"),FA.prototype),Zy(FA.prototype,"stop",[xA],Object.getOwnPropertyDescriptor(FA.prototype,"stop"),FA.prototype),Zy(FA.prototype,"pipe",[LA],Object.getOwnPropertyDescriptor(FA.prototype,"pipe"),FA.prototype),Zy(FA.prototype,"unpipe",[MA],Object.getOwnPropertyDescriptor(FA.prototype,"unpipe"),FA.prototype),FA);function WA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function KA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?WA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):WA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class GA extends _f{constructor(){super(),fp(this,"uplinkStatsUploadInterval",void 0),fp(this,"uplinkStatsUploadSlowInterval",void 0),fp(this,"uplinkRelatedStatsUploadInterval",void 0),fp(this,"uplinkDenoiserStatsUploadInterval",void 0),fp(this,"transportStatsUploadInterval",void 0),fp(this,"uplinkExtensionStatsUploadInterval",void 0),fp(this,"downlinkExtensionStatsUploadInterval",void 0),fp(this,"extensionUsageStatsUploadInterval",void 0),fp(this,"downlinkStatsUploadInterval",void 0),fp(this,"downlinkStatsUploadSlowInterval",void 0),fp(this,"downlinkRelatedStatsUploadInterval",void 0),fp(this,"lastStats",void 0),fp(this,"uploadUnplinkStarted",!1),fp(this,"uploadDownlinkStarted",!1),fp(this,"uploadTransportStarted",!1),fp(this,"uploadExtensionUsageStarted",!1),fp(this,"requestStats",void 0),fp(this,"requestLocalMedia",void 0),fp(this,"requestRemoteMedia",void 0),fp(this,"requestAllTracks",void 0),fp(this,"requestVideoIsReady",void 0),fp(this,"requestUpload",void 0)}startUploadTransportStats(){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadTransportStats(t)}),1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const e=new Map;this.extensionUsageStatsUploadInterval=window.setInterval((async()=>{var t,i,n;const r=Date.now(),s={connectionInterval:Kf("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:r};let o=[];const a=(null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this))||[];for(const e of a)!e.muted&&e.enabled&&(o=o.concat(await e.getProcessorUsage()));const c=(null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[];for(const[e,h]of c)h.has(Cv.VIDEO)&&e.videoTrack&&(o=o.concat(await e.videoTrack.getProcessorUsage())),h.has(Cv.AUDIO)&&e.audioTrack&&(o=o.concat(await e.audioTrack.getProcessorUsage()));if(0===o.length)return;s.details=function(e,t){const i={};for(const{id:o,value:a,level:c,direction:d}of e){var n;const e=null!==(n=t.get(o))&&void 0!==n?n:0,l=2===a?e+Kf("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var r,s;t.set(o,l),i[o]?(2===a&&(i[o].value=a),c>i[o].level&&(i[o].level=c),"remote"===d&&(i[o].remoteUidCount+=1),i[o].totalTs=null!==(r=t.get(o))&&void 0!==r?r:0):i[o]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(s=t.get(o))&&void 0!==s?s:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:r}=i[e];return{id:e,level:t,value:n,totalTs:r}}))}(o,e);const d=Date.now(),l=d>r?d:r+1;null===(n=this.requestUpload)||void 0===n||n.call(this,N_.EXTENSION_USAGE_STATS,{usageStats:s,sendTs:l})}),Kf("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&(this.uploadUplinkStats(t),this.lastStats=t)}),3e3),this.uplinkStatsUploadSlowInterval&&window.clearInterval(this.uplinkStatsUploadSlowInterval),this.uplinkStatsUploadSlowInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadSlowUplinkStats(t)}),6e4),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadRelatedUplinkStats(t,this.lastStats),this.lastStats=t}),1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadDenoiserStats(t)}),2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadExtensionStats(t)}),2e3))}uploadTransportStats(e){ew((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,N_.TRANSPORT_STATS,function(e){const t={connectionType:100,googRtt:e.rtt};if("relay"===e.selectedCandidatePair.localCandidate.candidateType){const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t.connectionType=101),"tcp"===i&&(t.connectionType=103),"tls"===i&&(t.connectionType=104)}return t}(e))}))}uploadUplinkStats(e){var t;((null===(t=this.requestLocalMedia)||void 0===t?void 0:t.call(this))||[]).forEach((t=>{let[i,{track:n,ssrcs:r}]=t;switch(i){case Rv.LocalVideoLowTrack:case Rv.LocalVideoTrack:{const t=function(e,t,i){var n;const r=t.videoSend.find((t=>t.ssrc===e));if(!r)return null;const s={id:Wb(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:r.ssrc.toString()};switch(s.A_vstd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",r.sentFrame&&(s.A_fhs=r.sentFrame.height.toString(),s.A_frs=r.sentFrame.frameRate.toString(),s.A_fws=r.sentFrame.width.toString()),r.adaptionChangeReason){case"none":s.A_ac="0";break;case"cpu":s.A_ac="1";break;case"bandwidth":s.A_ac="2";break;case"other":s.A_ac="3"}return s.A_lvps=c_[i._player?i._player.videoElementStatus:"uninit"].toString(),s.A_nr=null===(n=r.nacksCount)||void 0===n?void 0:n.toString(),r.avgEncodeMs&&(s.A_aem=r.avgEncodeMs.toFixed(0).toString()),s}(r[0].ssrcId,e,n),s=i===Rv.LocalVideoTrack?Db(r[0].ssrcId,e,n):null;t&&ew((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.PUBLISH_STATS,{stream_type:i===Rv.LocalVideoLowTrack?"low":"high",stats:KA(KA({},t),s)})}));const o=function(e){const t={id:"bweforvideo",timestamp:new Date(e.timestamp).toISOString(),type:"VideoBwe"};return e.bitrate.retransmit&&(t.A_rb=e.bitrate.retransmit.toString()),e.bitrate.targetEncoded&&(t.A_teb=e.bitrate.targetEncoded.toString()),t.A_aeb=e.bitrate.actualEncoded.toString(),t.A_tb=e.bitrate.transmit.toString(),void 0!==e.sendBandwidth&&(t.A_asb=e.sendBandwidth.toString()),t}(e);o&&setTimeout((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.PUBLISH_STATS,{stream_type:i===Rv.LocalVideoLowTrack?"low":"high",stats:o})}),1e3);break}case Rv.LocalAudioTrack:{const t=function(e,t,i){const n=t.audioSend.find((t=>t.ssrc===e));if(!n)return null;const r={id:Wb(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:n.ssrc.toString()};return r.A_astd=i._originMediaStreamTrack.enabled&&i._mediaStreamTrack.enabled?"0":"1",n.inputLevel?r.A_ail=Math.round(100*n.inputLevel).toString():r.A_ail=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),r.A_apil=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),n.aecReturnLoss&&(r.A_ecrl=Math.round(n.aecReturnLoss).toString()),n.aecReturnLossEnhancement&&(r.A_ecrle=Math.round(n.aecReturnLossEnhancement).toString()),r}(r[0].ssrcId,e,n);t&&ew((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.PUBLISH_STATS,{stream_type:"high",stats:t})}));break}}}))}uploadSlowUplinkStats(e){var t;((null===(t=this.requestLocalMedia)||void 0===t?void 0:t.call(this))||[]).filter((e=>{let[t]=e;return t===Rv.LocalVideoLowTrack||t===Rv.LocalVideoTrack})).forEach((t=>{let[i,{ssrcs:n}]=t;const r=Db(n[0].ssrcId,e);r&&ew((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.PUBLISH_STATS,{stream_type:i===Rv.LocalVideoLowTrack?"low":"high",stats:r})}))}))}uploadRelatedUplinkStats(e,t){var i;((null===(i=this.requestLocalMedia)||void 0===i?void 0:i.call(this))||[]).filter((e=>{let[t]=e;return t===Rv.LocalVideoLowTrack||t===Rv.LocalVideoTrack})).forEach((t=>{let[i,{ssrcs:n}]=t;const r=function(e,t){const i=t.videoSend.find((t=>t.ssrc===e));return i?{mediaType:"video",isVideoMute:!1,frameRateInput:i.inputFrame&&i.inputFrame.frameRate.toString(),frameRateSent:i.sentFrame&&i.sentFrame.frameRate.toString(),googRtt:i.rttMs.toString(),qpSumPerFrame:Math.floor(i.qpSumPerFrame).toString()}:null}(n[0].ssrcId,e);r&&ew((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,N_.PUBLISH_RELATED_STATS,{stream_type:i===Rv.LocalVideoLowTrack?"low":"high",stats:r})}))}))}uploadDenoiserStats(e){for(let r=0;r<e.length;r++){const s=e[r];if(s instanceof gb){var t,i,n;const e=null===(t=(i=s._external).getDenoiserStats)||void 0===t?void 0:t.call(i);return void(e&&(null===(n=this.requestUpload)||void 0===n||n.call(this,N_.DENOISER_STATS,e)))}}}uploadExtensionStats(e){for(let t=0;t<e.length;t++)e[t].getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let e;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=!1;this.downlinkStatsUploadInterval=window.setInterval((()=>{var i;const n=null===(i=this.requestStats)||void 0===i?void 0:i.call(this);n&&(this.uploadDownlinkStats(n,t,e),e=n),t=!t}),3e3),this.downlinkStatsUploadSlowInterval&&window.clearInterval(this.downlinkStatsUploadSlowInterval),this.downlinkStatsUploadSlowInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadSlowDownlinkStats(t)}),6e4),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&(this.uploadRelatedDownlinkStats(t,this.lastStats),this.lastStats=t)}),1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestRemoteMedia)||void 0===e?void 0:e.call(this);t&&this.uploadDownlinkExtensionStats(t)}),2e3)}uploadDownlinkStats(e,t,i){var n;((null===(n=this.requestRemoteMedia)||void 0===n?void 0:n.call(this))||[]).forEach((n=>{let[r,s]=n;if(s.has(Cv.VIDEO)&&r.videoTrack){const n=r.videoTrack?function(e,t,i,n,r){const s=t.videoRecv.find((t=>t.ssrc===e));if(!s)return null;const o={id:Wb(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:s.ssrc.toString()};var a,c;if(o.bytesReceived=s.bytes.toString(),o.packetsLost=s.packetsLost.toString(),o.packetsReceived=s.packets.toString(),s.framesRateFirefox&&(o.A_frr=s.framesRateFirefox.toString()),s.receivedFrame?(o.A_frr=s.receivedFrame.frameRate.toString(),o.A_fhr=s.receivedFrame.height.toString(),o.A_fwr=s.receivedFrame.width.toString()):(o.A_fhr=null===(a=n._videoHeight)||void 0===a?void 0:a.toString(),o.A_fwr=null===(c=n._videoWidth)||void 0===c?void 0:c.toString()),o.A_frd=s.decodeFrameRate.toString(),s.outputFrame&&(o.A_fro=s.outputFrame.frameRate.toString()),void 0!==s.jitterBufferMs&&(o.A_jbm=Math.floor(s.jitterBufferMs).toString()),void 0!==s.currentDelayMs&&(o.A_cdm=Math.floor(s.currentDelayMs).toString()),o.A_fs=s.firsCount.toString(),o.A_ns=s.nacksCount.toString(),o.A_ps=s.plisCount.toString(),n&&(o.A_vrtd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),n._player&&n._player.freezeTimeCounterList.length>0&&(o.A_vrft=Math.round(n._player.freezeTimeCounterList.splice(0,1)[0]).toString()),r&&n._player&&"visible"===Cb.visibility){const e=Math.min(6e3,n._player.renderFreezeAccTime);o.A_vrrft=Math.round(e).toString(),n._player.renderFreezeAccTime=Math.max(0,n._player.renderFreezeAccTime-e)}if(o.A_rvps=c_[n._player?n._player.videoElementStatus:"uninit"].toString(),i){const t=i.videoRecv.find((t=>t.ssrc===e));if(t&&void 0!==s.totalInterFrameDelay&&void 0!==s.totalSquaredInterFrameDelay&&void 0!==t.totalInterFrameDelay&&void 0!==t.totalSquaredInterFrameDelay){const e=s.totalInterFrameDelay-t.totalInterFrameDelay,i=s.totalSquaredInterFrameDelay-t.totalSquaredInterFrameDelay,n=s.framesDecodeCount-t.framesDecodeCount,r=e/n*1e3,a=Math.round(1e3*Math.sqrt((i-Math.pow(e,2)/n)/n));!isNaN(a)&&r+a>Math.max(3*r,r+150)&&(o.A_ifdsd=a.toString())}}return o}(r._videoSSRC,e,i,r.videoTrack,t):void 0;n&&ew((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.SUBSCRIBE_STATS,{stream_id:r.uid,stats:n})}))}if(s.has(Cv.AUDIO)&&r.audioTrack){const t=r.audioTrack?function(e,t,i,n){const r=t.audioRecv.find((t=>t.ssrc===e));if(!r)return null;const s={id:Wb(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:r.ssrc.toString()};if(s.bytesReceived=r.bytes.toString(),s.packetsLost=r.packetsLost.toString(),s.packetsReceived=r.packets.toString(),r.outputLevel?s.A_aol=Math.round(100*r.outputLevel).toString():s.A_aol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),s.A_apol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),n&&(s.A_artd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),s.A_jr=r.jitterMs.toString(),s.A_jbm=Math.floor(r.jitterBufferMs).toString(),s.A_cdm=Math.floor(r.jitterBufferMs).toString(),s.A_raps=c_[sS.getPlayerState(n.getTrackId())].toString(),i){const t=i.audioRecv.find((t=>t.ssrc===e));if(t){const e=r.concealedSamples-t.concealedSamples;e>0&&(s.A_cs=Math.round(e).toString())}}return s}(r._audioSSRC,e,i,r.audioTrack):void 0;t&&ew((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,N_.SUBSCRIBE_STATS,{stream_id:r.uid,stats:t})}))}}))}uploadSlowDownlinkStats(e){}uploadRelatedDownlinkStats(e,t){var i;((null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[]).forEach((i=>{let[n,r]=i;if(r.has(Cv.VIDEO)&&n.videoTrack){var s;const i=!0===(n._videoSSRC&&(null===(s=this.requestVideoIsReady)||void 0===s?void 0:s.call(this,n._videoSSRC))||!1),r=function(e,t,i,n,r,s){const o=i.videoRecv.find((t=>t.ssrc===e)),a=r?r.videoRecv.find((t=>t.ssrc===e)):void 0;if(!o)return null;const c=Tb.isRemoteVideoFreeze(s,o,a)&&t,d={mediaType:"video",isVideoMute:!1,peerId:n,frameRateReceived:o.receivedFrame&&o.receivedFrame.frameRate.toString(),frameRateDecoded:o.decodedFrame&&o.decodedFrame.frameRate.toString(),isFreeze:c,bytesReceived:o.bytes.toString(),packetsReceived:o.packets.toString(),packetsLost:o.packetsLost.toString(),qpSumPerFrame:Math.floor(o.qpSumPerFrame).toString()};return o.framesRateFirefox&&(d.frameRateDecoded=o.framesRateFirefox.toString(),d.frameRateReceived=o.framesRateFirefox.toString()),d}(n._videoSSRC,i,e,n.uid,t,n.videoTrack);r&&ew((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,N_.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:r})}))}if(r.has(Cv.AUDIO)&&n.audioTrack){const t=function(e,t,i,n){const r=t.audioRecv.find((t=>t.ssrc===e));if(!r)return null;const s=Tb.isRemoteAudioFreeze(n);return{mediaType:"audio",isAudioMute:!1,peerId:i,googJitterReceived:r.jitterMs.toString(),isFreeze:s,bytesReceived:r.bytes.toString(),packetsReceived:r.packets.toString(),packetsLost:r.packetsLost.toString(),frameReceived:r.receivedFrames.toString(),frameDropped:r.droppedFrames.toString()}}(n._audioSSRC,e,n.uid,n.audioTrack);t&&ew((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,N_.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:t})}))}}))}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(e){e.forEach((e=>{let[t,i]=e;i.has(Cv.VIDEO)&&t.videoTrack&&t.videoTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)})),i.has(Cv.AUDIO)&&t.audioTrack&&t.audioTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}))}}const qA="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",zA="9",JA=2e4,YA=4e4;class XA{get localCapabilities(){return tw(this._localCapabilities)}get rtpCapabilities(){return tw(this._rtpCapabilities)}get candidates(){return tw(this._candidates)}get iceParameters(){return tw(this._iceParameters)}get dtlsParameters(){return tw(this._dtlsParameters)}constructor(e){fp(this,"sessionDesc",void 0),fp(this,"_localCapabilities",void 0),fp(this,"_rtpCapabilities",void 0),fp(this,"_candidates",void 0),fp(this,"_iceParameters",void 0),fp(this,"_dtlsParameters",void 0),fp(this,"setup",void 0),fp(this,"currentMidIndex",void 0),fp(this,"cname",void 0),fp(this,"firefoxSsrcMidMap",new Map),e=tw(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,remoteSetup:s,localCapabilities:o,cname:a}=e,c=II.exports.parse(qA);this._rtpCapabilities=r,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o,this.setup=s,this.cname=a;const d=this.rtpCapabilities.send;for(const l of c.mediaDescriptions){if(l.attributes.iceUfrag=t.iceUfrag,l.attributes.icePwd=t.icePwd,l.attributes.fingerprints=i.fingerprints,l.attributes.candidates=n,l.attributes.setup=s,"application"===l.media.mediaType&&(l.attributes.sctpPort="5000"),"video"===l.media.mediaType&&(l.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.videoCodecs,l.attributes.extmaps=d.videoExtensions,Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:YA,rtx:Kf("USE_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}if("audio"===l.media.mediaType&&(l.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),l.attributes.payloads=d.audioCodecs,l.attributes.extmaps=d.audioExtensions,KI(l),Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:JA}],this.cname);l.attributes.ssrcs=e,l.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=II.exports.parse(qA);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const n of t.mediaDescriptions){if(n.attributes.iceUfrag=this._iceParameters.iceUfrag,n.attributes.icePwd=this._iceParameters.icePwd,n.attributes.fingerprints=this._dtlsParameters.fingerprints,n.attributes.candidates=this._candidates,n.attributes.setup=this.setup,"application"===n.media.mediaType&&(n.attributes.sctpPort="5000"),"video"===n.media.mediaType&&(n.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),n.attributes.payloads=i.videoCodecs,n.attributes.extmaps=i.videoExtensions,Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:YA,rtx:Kf("USE_RTX")?40001:void 0}],this.cname);n.attributes.ssrcs=e,n.attributes.ssrcGroups=t}if("audio"===n.media.mediaType&&(n.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),n.attributes.payloads=i.audioCodecs,n.attributes.extmaps=i.audioExtensions,Kf("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=xI([{ssrcId:JA}],this.cname);n.attributes.ssrcs=e,n.attributes.ssrcGroups=t}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,r=this.rtpCapabilities.send;for(let s=1;s<e;s++){const e=2*s+JA,o=2*s+YA,{ssrcs:a,ssrcGroups:c}=xI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=xI([{ssrcId:o,rtx:Kf("USE_RTX")?o+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:zA,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:zA,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return II.exports.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:r,ssrcGroups:s}=xI(t,this.cname,Kf("SYNC_GROUP")?i:void 0),o=this.findPreloadMediaDesc(r);if(o){if(Gu()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let i;return-1===t||Ku()||qu()||Xu()?(i=this.createOrRecycleSendMedia(e,r,s,"sendonly",n),this.updateBundleMids()):(i=tw(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=r,i.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),Gu()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||Gu()||Ku()||qu()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}restartICE(e){e=tw(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(Gu()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,t,i,n,r,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=this.localCapabilities.send;let d=[];if(o===Cv.VIDEO){var l,h;if(Kf("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(d=a.videoCodecs.filter((e=>{var t,i;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(n)&&(null==e||null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])===Kf("H264_PROFILE_LEVEL_ID")}))),!d||0===(null===(l=d)||void 0===l?void 0:l.length)){const e=c.videoCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(n)}));0!==e.length&&(d=a.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(Kf("USE_RTX")){const e=d.map((e=>e.payloadType.toString())),t=a.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&e.includes((null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));d=[...d,...t]}0===d.length&&(Pf.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(h=a.videoCodecs[0].rtpMap)||void 0===h?void 0:h.encodingName)),d=a.videoCodecs)}else d=a.audioCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes(r)})),0===d.length&&(Pf.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),d=a.audioCodecs.filter((e=>{var t;return((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"").includes("opus")})));const u=o===Cv.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let m={media:{mediaType:o,port:zA,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};m=this.mungRecvMediaDsec(m,e,s);const f=this.findFirstClosedMedia(o);if(f){const e=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[e]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(e,t,i,n,r){const s=this.rtpCapabilities.send,o=e===Cv.VIDEO?s.videoCodecs:s.audioCodecs,a=e===Cv.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:zA,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=tw(e);return MI(n),LI(n,t),FI(n,t),UI(n),jI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=tw(e);return jI(i,t,this.localCapabilities.recv),KI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Gu()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i,n;return(null===(i=t.attributes)||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var $A;function QA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ZA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?QA(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):QA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let eP=(Zy(($A=class e extends Uv{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t,i){super(e,t),fp(this,"store",void 0),fp(this,"peerConnection",void 0),fp(this,"remoteSDP",void 0),fp(this,"initialOffer",void 0),fp(this,"transportEventReceiver",void 0),fp(this,"statsFilter",void 0),fp(this,"useRTX",Kf("USE_RTX")),fp(this,"localCapabilities",void 0),fp(this,"localCandidateCount",0),fp(this,"allCandidatesReceived",!1),fp(this,"establishPromise",void 0),fp(this,"mutex",new AE("NVExtentionsConnection-mutex")),fp(this,"rtcMedia",void 0),this.store=t,this.peerConnection=i,this.statsFilter=hA(this.peerConnection,void 0,void 0,Gu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=NI(e.sdp),i=await BI(!this.useRTX,Kf("FILTER_VIDEO_FEC"),Kf("FILTER_AUDIO_FEC"));return this.localCapabilities=i,this.initialOffer=e,ZA(ZA({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new Ef(yf.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,r,s){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new XA({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:r,localCapabilities:WI(this.localCapabilities),cname:s});const o=this.remoteSDP.toString(),a=II.exports.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&KI(c);const d=II.exports.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteConnect(e){var t,i,n;null===(t=this.remoteSDP)||void 0===t||t.updateRemoteRTPCapabilities(e),null===(i=this.remoteSDP)||void 0===i||i.preloadRemoteMedia(2);const r=null===(n=this.remoteSDP)||void 0===n?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),Pf.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return bI((function*(){const r=yield wI(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t)})),Gu()&&!0===Kf("SIMULCAST")&&(yield wI(n.applySimulcastForFirefox(s,e)));const o=yield wI(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(o.sdp,e,a),d=II.exports.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return DI(t,n.useRTX)}));let h;try{h=yield l}catch(r){h=[],n.remoteSDP.receive(e,t,i,h);const s=n.remoteSDP.toString();throw yield wI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield wI(n.peerConnection.setRemoteDescription({type:"answer",sdp:s})),yield wI(n.stopSending(a,!0)),r}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield wI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield wI(n.applySimulcastEncodings(s,e)),yield wI(n.applySendEncodings(s,e)),null==p||p(u),yield wI(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),s.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof Ef?e:new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:s}=this.remoteSDP.send(e,t,i,n);if(s){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),s=this.mungReceiveAnswerSDP(n.sdp,r,e);null==i||i(s||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:s}),Pf.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else Pf.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const o=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();null==t||t(i.sdp||""),await this.peerConnection.setLocalDescription(i),Pf.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else Pf.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==n||n(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(){var e=this;return bI((function*(){const t=yield wI(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{const t=yield wI(e.peerConnection.createOffer({iceRestart:!0}));if(!t.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=NI(t.sdp),{remoteIceParameters:n}=yield i.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(n);const r=e.remoteSDP.toString(),s=e.logSDPExchange(t.sdp||"","offer","local","restartICE");yield wI(e.peerConnection.setLocalDescription(t)),null==s||s(r),yield wI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){Pf.warning("restart ICE failed, abort operation",e)}finally{t()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),s=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==s||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new Ef(yf.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?Gu()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return ZA(ZA({},NI(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Pf.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Kf("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(F_(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Kf("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Kf("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ab(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Kf("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,t){try{if(!Vv().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let c=0;c<e.length;c++){const d=e[c],l=t[c];if(l&&l instanceof mC){var i,n;if(this.isVP8Simulcast(l))continue;const e={},t={};switch(l._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var r,s,o,a;if(null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(t.maxBitrate=1e3*(null===(r=l._encoderConfig)||void 0===r?void 0:r.bitrateMax)),l._hints.includes(uv.LOW_STREAM)&&(null!==(s=l._encoderConfig)&&void 0!==s&&s.frameRate&&(t.maxFramerate=Ob(l._encoderConfig.frameRate)),null!==(o=l._encoderConfig)&&void 0!==o&&o.scaleResolutionDownBy&&(null===(a=l._encoderConfig)||void 0===a?void 0:a.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=l._encoderConfig.scaleResolutionDownBy)),Kf("DSCP_TYPE")&&sp()){const e=Kf("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(t.networkPriority=e)}const c=d.sender.getParameters(),h=null===(n=c.encodings)||void 0===n?void 0:n[0];Gu()&&!h&&(e.encodings=[t]),h&&Object.assign(h,t),Object.assign(c,e),await d.sender.setParameters(c)}}}catch(e){Pf.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=II.exports.parse(e);return t.forEach(((e,t)=>{const r=i[t],s=n.mediaDescriptions.find((e=>e.attributes.mid===r));s&&(LI(s,e),VI(s,e,this.store.codec))})),II.exports.print(n)}mungReceiveAnswerSDP(e,t,i){const n=II.exports.parse(e),r=n.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&i===Cv.AUDIO&&"audio"===r.media.mediaType&&KI(r),II.exports.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let o=0;o<e.length;o++){var i,n,r,s;const a=e[o],c=t[o];if(c instanceof mC&&!c._hints.includes(uv.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(r=c._scalabiltyMode)&&void 0!==r&&r.numSpatialLayers&&(null===(s=c._scalabiltyMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!Gu()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof mC&&this.isVP8Simulcast(n)){const t=e[i],r={},s={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:s.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:s.medium,scaleResolutionDownBy:4}];const o=t.sender.getParameters();await t.sender.setParameters(Object.assign(o,r))}}}isVP8Simulcast(e){var t,i,n,r;return!!(e instanceof mC&&Kf("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(uv.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabiltyMode)&&void 0!==n&&n.numSpatialLayers&&(null===(r=e._scalabiltyMode)||void 0===r?void 0:r.numSpatialLayers)>1)}logSDPExchange(e,t,i,n){if(Kf("SDP_LOGGING"))return Pf.upload("exchanging ".concat(i," ").concat(t," SDP during NVExtentionsConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(Vv().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[tP],Object.getOwnPropertyDescriptor($A.prototype,"connect"),$A.prototype),Zy($A.prototype,"updateRemoteConnect",[tP],Object.getOwnPropertyDescriptor($A.prototype,"updateRemoteConnect"),$A.prototype),Zy($A.prototype,"receive",[tP],Object.getOwnPropertyDescriptor($A.prototype,"receive"),$A.prototype),Zy($A.prototype,"batchReceive",[tP],Object.getOwnPropertyDescriptor($A.prototype,"batchReceive"),$A.prototype),Zy($A.prototype,"stopReceiving",[tP],Object.getOwnPropertyDescriptor($A.prototype,"stopReceiving"),$A.prototype),Zy($A.prototype,"muteRemote",[tP],Object.getOwnPropertyDescriptor($A.prototype,"muteRemote"),$A.prototype),Zy($A.prototype,"unmuteRemote",[tP],Object.getOwnPropertyDescriptor($A.prototype,"unmuteRemote"),$A.prototype),Zy($A.prototype,"muteLocal",[tP],Object.getOwnPropertyDescriptor($A.prototype,"muteLocal"),$A.prototype),Zy($A.prototype,"unmuteLocal",[tP],Object.getOwnPropertyDescriptor($A.prototype,"unmuteLocal"),$A.prototype),Zy($A.prototype,"close",[tP],Object.getOwnPropertyDescriptor($A.prototype,"close"),$A.prototype),Zy($A.prototype,"updateEncoderConfig",[tP],Object.getOwnPropertyDescriptor($A.prototype,"updateEncoderConfig"),$A.prototype),Zy($A.prototype,"updateSendParameters",[tP],Object.getOwnPropertyDescriptor($A.prototype,"updateSendParameters"),$A.prototype),Zy($A.prototype,"replaceTrack",[tP],Object.getOwnPropertyDescriptor($A.prototype,"replaceTrack"),$A.prototype),Zy($A.prototype,"getRemoteSSRC",[tP],Object.getOwnPropertyDescriptor($A.prototype,"getRemoteSSRC"),$A.prototype),$A);function tP(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await n.apply(this,s)}finally{i()}},i}var iP;function nP(e){var t,i,n,r=2;for("undefined"!=typeof Symbol&&(i=RI,n=Symbol.iterator);r--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new rP(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function rP(e){function t(e){if(Object(e)!==e)return yh.reject(new TypeError(e+" is not an object."));var t=e.done;return yh.resolve(e.value).then((function(e){return{value:e,done:t}}))}return(rP=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?yh.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?yh.reject(e):t(i.apply(this.s,arguments))}},new rP(e)}let sP=(Zy((iP=class e extends Uv{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(t,i){super(t,i),fp(this,"store",void 0),fp(this,"peerConnection",void 0),fp(this,"cname",void 0),fp(this,"mutex",new AE("DataChannelConnection-mutex")),fp(this,"dataChannel",void 0),fp(this,"_p2pConnection",void 0),fp(this,"establishPromise",void 0),fp(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new eP(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,r,s){return this.cname=s,await this._p2pConnection.connect(e,t,i,n,r,s),await new yh(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new Ef(yf.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}send(e,t,i){var n=this;return bI((function*(){const r=yield wI(n.mutex.lock("From DataChannelConnection.send"));try{return yield*CI(nP(n._p2pConnection.send(e,t,i)),wI)}finally{r()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async receive(e,t,i,n){return this._nvMedia?(Pf.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(Pf.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,i,n))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(){var e=this;return bI((function*(){return yield*CI(nP(e._p2pConnection.restartICE()),wI)}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,i,n){if(Kf("SDP_LOGGING"))return Pf.upload("exchanging ".concat(i," ").concat(t," SDP during DataChannelConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(F_(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Kf("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Kf("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ab(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Kf("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}).prototype,"connect",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"connect"),iP.prototype),Zy(iP.prototype,"receive",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"receive"),iP.prototype),Zy(iP.prototype,"stopReceiving",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"stopReceiving"),iP.prototype),Zy(iP.prototype,"muteRemote",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"muteRemote"),iP.prototype),Zy(iP.prototype,"unmuteRemote",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"unmuteRemote"),iP.prototype),Zy(iP.prototype,"muteLocal",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"muteLocal"),iP.prototype),Zy(iP.prototype,"unmuteLocal",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"unmuteLocal"),iP.prototype),Zy(iP.prototype,"close",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"close"),iP.prototype),Zy(iP.prototype,"updateEncoderConfig",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"updateEncoderConfig"),iP.prototype),Zy(iP.prototype,"updateSendParameters",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"updateSendParameters"),iP.prototype),Zy(iP.prototype,"replaceTrack",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"replaceTrack"),iP.prototype),Zy(iP.prototype,"getRemoteSSRC",[oP],Object.getOwnPropertyDescriptor(iP.prototype,"getRemoteSSRC"),iP.prototype),iP);function oP(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await n.apply(this,s)}finally{i()}},i}var aP;function cP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function dP(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?cP(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):cP(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function lP(e){var t,i,n,r=2;for("undefined"!=typeof Symbol&&(i=RI,n=Symbol.iterator);r--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new hP(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function hP(e){function t(e){if(Object(e)!==e)return yh.reject(new TypeError(e+" is not an object."));var t=e.done;return yh.resolve(e.value).then((function(e){return{value:e,done:t}}))}return(hP=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?yh.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?yh.reject(e):t(i.apply(this.s,arguments))}},new hP(e)}let uP=(Zy((aP=class extends _f{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Av.StateChange,t,this._state)}constructor(e,t){super(),fp(this,"store",void 0),fp(this,"statsUploader",void 0),fp(this,"connection",void 0),fp(this,"localTrackMap",new Map),fp(this,"remoteUserMap",new Map),fp(this,"pendingLocalTracks",[]),fp(this,"pendingRemoteTracks",[]),fp(this,"statsCollector",void 0),fp(this,"isPlanB",!1),fp(this,"shouldForwardP2PCreation",void 0),fp(this,"iceFailedCount",0),fp(this,"dtlsFailedCount",0),fp(this,"mutex",new AE("P2PChannel-mutex")),fp(this,"_state",Iv.Disconnected),fp(this,"handleMuteLocalTrack",(async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Iv.Connected)return void i(new Ef(yf.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const n=this.filterTobeMutedTracks(e);if(0===n.length)return void t();const r=n.find((e=>"videoLowTrack"===e[0]));r&&r[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const s=this.createMuteMessage(n);await Yb(this,Av.RequestMuteLocal,s),t()}catch(e){i(e)}finally{n()}})),fp(this,"handleUnmuteLocalTrack",(async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Iv.Connected)return void i(new Ef(yf.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const n=this.filterTobeUnmutedTracks(e);if(0===n.length)return void t();const r=n.find((e=>"videoLowTrack"===e[0]));if(r){const t=r[1];if(t.track._originMediaStreamTrack.stop(),Vv().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=CA(e,$b(this,Av.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new yh(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const s=this.createUnmuteMessage(n);await Yb(this,Av.RequestUnmuteLocal,s),t()}catch(e){i(e)}finally{n()}})),fp(this,"handleUpdateVideoEncoder",(async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Rv.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Iv.Connected)return void t();const{id:n,track:r}=i;await this.connection.updateSendParameters(n,r),await this.connection.updateEncoderConfig(n,r),this.emit(Av.UpdateVideoEncoder,r),t()}catch(e){i(e)}finally{n()}})),fp(this,"handleSetOptimizationMode",(async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(Rv.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Iv.Connected)return;const{id:n,track:r}=i;await this.connection.updateSendParameters(n,r),t()}catch(e){i(e)}finally{n()}})),fp(this,"handleReplaceTrack",(async(e,t,i,n)=>{let r;Pf.debug("P2PChannel handleReplaceTrack for [track-id-".concat(e.getTrackId(),"]")),"boolean"==typeof n&&n||(r=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var s;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!i||this.state!==Iv.Connected)return void t();if(await(null===(s=this.connection)||void 0===s?void 0:s.replaceTrack(e,i[1].id)),this.isPlanB){const t=i[1];t.id=e._mediaStreamTrack.id,this.localTrackMap.set(i[0],t)}if(i[0]===Rv.LocalVideoTrack&&Vv().supportDualStreamEncoding){const t=this.localTrackMap.get(Rv.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new yh(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}t()}catch(e){i(e)}finally{var o;null===(o=r)||void 0===o||o()}})),fp(this,"handleGetLocalVideoStats",(e=>{e(this.statsCollector.getLocalVideoTrackStats())})),fp(this,"handleGetLocalAudioStats",(e=>{e(this.statsCollector.getLocalAudioTrackStats())})),fp(this,"handleGetRemoteVideoStats",(e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid])),fp(this,"handleGetRemoteAudioStats",(e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new GA,this.bindStatsUploaderEvents(),this.isPlanB=!Vv().supportUnifiedPlan||Kf("CHROME_FORCE_PLAN_B")&&sp(),this.shouldForwardP2PCreation=Kf("FORWARD_P2P_CREATION")&&Vv().supportPCSetConfiguration,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new sP({},this.store):this.isPlanB?new fA({},this.store):new wA({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){if(this.state=Iv.New,this.shouldForwardP2PCreation||(this.connection=this.store.useDataChannel?new sP(e,this.store):this.isPlanB?new fA(e,this.store):new wA(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new Ef(yf.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,n,r,s){if(!this.connection)throw new Ef(yf.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof sP?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,r,s),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Iv.Connected)}async preConnect(e,t,i,n,r,s){if(!this.connection)throw new Ef(yf.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const o=await this.connection.connect(e,t,i,n,r,s);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Iv.Connected,o}getEstablishParams(){if(this.connection instanceof sP)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}publish(e,t,i){var n=this;return bI((function*(){const r=yield wI(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==Iv.Connected){if(n.state===Iv.Disconnected)throw new Ef(yf.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,Sb.markPublishStart(n.store.clientId,n.store.pubId);const r=n.filterTobePublishedTracks(e,t,i);if(0===r.length)return void(yield wI(n.tryToUnmuteAudio(e)));yield*CI(lP(n.doPublish(n.connection,r)),wI)}finally{r()}}))()}doPublish(e,t){var i=this;return bI((function*(){t.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===Rv.LocalAudioTrack?"audio":"video",r)})),i.bindLocalTrackEvents(t);const n=yield wI(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),r=(yield wI(n.next())).value,s=i.createGatewayPublishMessage(t,r);let o;try{o=yield s}catch(e){throw n.throw(e),(null==e?void 0:e.code)===yf.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const a=i.mapPubResToRemoteConfig(s,o),c=(yield wI(n.next(a))).value;t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,c),i.statsUploader.startUploadUplinkStats(),t.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===Rv.LocalAudioTrack?"audio":"video",void 0,r)}))}))()}publishLowStream(e){var t=this;return bI((function*(){if(!t.connection||t.state!==Iv.Connected)return;const i=yield wI(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=t.localTrackMap.get(Rv.LocalVideoTrack);if(!i)throw new Ef(yf.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(Rv.LocalVideoLowTrack))throw new Ef(yf.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const r=[{track:t.getLowVideoTrack(i.track,e),type:Rv.LocalVideoLowTrack}];if(yield*CI(lP(t.doPublish(t.connection,r)),wI),i.track.muted||!i.track.enabled){var n;const e=null===(n=t.localTrackMap.get(Rv.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield wI(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(Pf.debug("Emit P2PChannelEvents.RequestRePublish to republish tracks."),await Jb(this,Av.RequestRePublish,this.pendingLocalTracks),this.emit(Av.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:e,kind:i}=this.pendingRemoteTracks[t];(i!==Cv.AUDIO||e._audio_added_&&e._audioSSRC)&&(i!==Cv.VIDEO||e._video_added_&&e._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await Jb(this,Av.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:i}of this.pendingRemoteTracks)await this.subscribe(t,i,i===Cv.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(Av.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Iv.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));return i&&i[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishLowStream(){if(!this.connection||this.state!==Iv.Connected)return;const e=this.localTrackMap.get(Rv.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[Rv.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats(),i}async subscribe(e,t,i,n,r){var s;if(!this.connection||this.state!==Iv.Connected)throw new Ef(yf.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(s=this.remoteUserMap.get(e))&&void 0!==s&&s.has(t))return;let o,a;if(r){const i=r.find((e=>{let{stream_type:i}=e;return i===t}));if(!i)throw new Ef(yf.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const n=await this.connection.receive(t,i.ssrcs,String(e._uintid),i.attributes);o=n.track,a=n.id}else{const r=await this.connection.receive(t,[{ssrcId:i,rtx:n}],String(e._uintid),void 0);o=r.track,a=r.id}t===Cv.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new HA(o,e.uid,e._uintid,this.store),Pf.info("[".concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new BA(o,e.uid,e._uintid,this.store),Pf.info("[".concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadDownlinkStats();const d=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:r}=i;return n.uid===e.uid&&t===r}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(Av.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Iv.Connected)throw new Ef(yf.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const t=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:r}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:r}],mslabel:String(t._uintid)}})));e.forEach(((e,i)=>{let{user:n,mediaType:r}=e;const{track:s,id:o}=t[i];r===Cv.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(s):(n._audioTrack=new HA(s,n.uid,n._uintid,this.store),Pf.info("[".concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(s):(n._videoTrack=new BA(s,n.uid,n._uintid,this.store),Pf.info("[".concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(n,n._videoTrack));const a=this.remoteUserMap.get(n);a?a.set(r,o):this.remoteUserMap.set(n,new Map([[r,o]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadDownlinkStats();const c=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===n.uid&&r===i}));-1!==c&&(this.pendingRemoteTracks.splice(c,1),this.emit(Av.MediaReconnectEnd,n.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:r}=i;return void 0!==t?n.uid===e.uid&&t===r:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===Iv.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Cv.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Cv.VIDEO){var r;null===(r=e._videoTrack)||void 0===r||r._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==Iv.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(0===r.length)return;await this.connection.stopReceiving(r.map((e=>{let[,{id:t}]=e;return t})));const s=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),r.forEach((e=>{let[t,{kind:n}]=e;var r,s;if(n===Cv.VIDEO&&t._videoSSRC&&(null===(r=this.connection)||void 0===r||r.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),n===Cv.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0);else if(n===Cv.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),i||(null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0)}})),s}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:s}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:i}=e;return void 0!==s?t.uid===r.uid&&s===i:t.uid===r.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==Iv.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===Cv.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===Cv.VIDEO){var r;null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0}}));const i=$i(e).call(e,((e,t)=>{let{user:i,mediaType:n}=t;const r=this.filterTobeUnSubscribedTracks(i,n);return e.concat(r)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,r;if(i===Cv.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===Cv.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0;else if(i===Cv.AUDIO){var s;this.unbindRemoteTrackEvents(t._audioTrack),null===(s=t._audioTrack)||void 0===s||s._destroy(),t._audioTrack=void 0}})),n}async muteRemote(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);if(!i)return void Pf.warning("P2PChannel.muteRemote has no remote user ".concat(e.uid,"."));if(!i.get(t))return void Pf.warning("P2PChannel.muteRemote has no remote user ".concat(e.uid," media type ").concat(t,"."));const n=t===Cv.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==n&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);i?i.get(t)||Pf.warning("P2PChannel.unmuteRemote has no remote user ".concat(e.uid," media type ").concat(t,".")):Pf.warning("P2PChannel.unmuteRemote has no remote user ".concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(Rv.LocalAudioTrack);if((null==t?void 0:t.track)instanceof vb){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Rv.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Rv.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Rv.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,i,n,r){if(e){const i=this.localTrackMap.get(Rv.LocalAudioTrack),s=n?this.localTrackMap.get(Rv.LocalVideoLowTrack):this.localTrackMap.get(Rv.LocalVideoTrack);TE.publish(this.store.sessionId,{eventElapse:Sb.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==s?void 0:s.track.getTrackLabel(),screenshare:-1!==(null==s?void 0:s.track._hints.indexOf(uv.SCREEN_TRACK)),audio:!!i,video:!!s,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;i||(i=[]);const o=i.find((e=>e instanceof fb)),a=n?null===(s=this.localTrackMap.get(Rv.LocalVideoTrack))||void 0===s?void 0:s.track:i.find((e=>e instanceof mC));TE.publish(this.store.sessionId,{eventElapse:Sb.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==o?void 0:o.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(uv.SCREEN_TRACK)),audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,i,n){const r=n===Cv.VIDEO?i._videoSSRC:i._audioSSRC;r&&TE.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===Cv.VIDEO,audio:n===Cv.AUDIO,peerid:i.uid,subscribeRequestid:n===Cv.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:Sb.measureFromSubscribeStart(this.store.clientId,r)})}reset(){Pf.debug("P2PChannel.reset"),this.mutex=new AE("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new sP({},this.store):this.isPlanB?new fA({},this.store):new wA({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=Iv.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Rv.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Rv.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof mC||t&&t.track instanceof fb?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(aE(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Rv.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=qg(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(Pf.debug("P2PChannel.disconnectForReconnect closing P2PConnection"),this.state=Iv.Reconnecting,Kf("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{var t,i,n,r;let[s]=e;null===(t=s._videoTrack)||void 0===t||null===(i=t._player)||void 0===i||null===(n=i.getVideoElement())||void 0===n||n.pause(),null===(r=s._videoTrack)||void 0===r||r._originMediaStreamTrack.stop()})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new sP({},this.store):this.isPlanB?new fA({},this.store):new wA({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case Rv.LocalVideoTrack:i._hints.includes(uv.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case Rv.LocalAudioTrack:i instanceof vb?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);break;case Rv.LocalVideoLowTrack:}})),this.emit(Av.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(aE(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Av.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),Pf.debug("P2PChannel disconnected, waiting to reconnect."))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:r}=i;if((e instanceof gC?e.uid:e)===n.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(){var e=this;return bI((function*(){if(!e.connection||e.state!==Iv.Connected||e.connection instanceof sP)return;const t=yield wI(e.mutex.lock("From P2PChannel.restartICE"));try{yield*CI(lP(e.connection.restartICE()),wI)}finally{t()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(Rv.LocalVideoTrack),i=this.localTrackMap.get(Rv.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),r=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!r)return 1;const s=Xb(this,Av.NeedSignalRTT),o=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(uv.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return $f[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const r=n._audioSSRC,s=n._videoSSRC,o=e.audioRecv.find((e=>e.ssrc===r)),a=e.videoRecv.find((e=>e.ssrc===s));if(!o&&!a)return void(t+=1);const c=Xb(this,Av.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=o?o.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new yh(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],r=Vv(),s=this.getAllTracks();e=Zb(e=e.filter((e=>-1===s.indexOf(e))));let o=!1,a=!1;for(const c of e){if(c instanceof mC&&(this.localTrackMap.has(Rv.LocalVideoTrack)||o?new Ef(yf.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:Rv.LocalVideoTrack}),o=!0),t)){const e=this.getLowVideoTrack(c,i);n.push({track:e,type:Rv.LocalVideoLowTrack})}if(c instanceof fb){const e=this.localTrackMap.get(Rv.LocalAudioTrack);if(e){if(!(e.track instanceof vb))throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===Rv.LocalAudioTrack}));if(!(e.track instanceof vb))throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof vb||c._bypassWebAudio)n.push({track:c,type:Rv.LocalAudioTrack});else{const e=new vb;e.addAudioTrack(c),n.push({track:e,type:Rv.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=Zb(e=e.filter((e=>-1!==i.indexOf(e))));for(const n of e){if(n instanceof fb){const e=this.localTrackMap.get(Rv.LocalAudioTrack);if(!e)continue;e.track instanceof vb?(e.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),0===e.track.trackList.length&&(t.push([Rv.LocalAudioTrack,e]),e.track.close())):t.push([Rv.LocalAudioTrack,e])}if(n instanceof mC){const e=this.localTrackMap.get(Rv.LocalVideoTrack);if(!e)continue;t.push([Rv.LocalVideoTrack,e]);const i=this.localTrackMap.get(Rv.LocalVideoLowTrack);i&&t.push([Rv.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Rv.LocalVideoTrack:t.addListener(hv.GET_STATS,this.handleGetLocalVideoStats),t.addListener(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(hv.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(hv.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(hv.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Rv.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);break;case Rv.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof vb?e.trackList.forEach((e=>{e.addListener(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(hv.GET_STATS,this.handleGetLocalAudioStats),e.addListener(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(hv.GET_STATS,this.handleGetLocalAudioStats),e.addListener(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(hv.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Rv.LocalVideoTrack:t.off(hv.GET_STATS,this.handleGetLocalVideoStats),t.off(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(hv.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(hv.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(hv.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Rv.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);break;case Rv.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof vb?e.trackList.forEach((e=>{e.off(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(hv.GET_STATS,this.handleGetLocalAudioStats),e.off(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(hv.GET_STATS,this.handleGetLocalAudioStats),e.off(hv.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(hv.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(hv.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(hv.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(hv.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof BA&&t.addListener(hv.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof HA&&t.addListener(hv.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(hv.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Cv.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Cv.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,r,{track:s,type:o}=e;switch(o){case Rv.LocalAudioTrack:n=av.Audio,r={dtx:s instanceof gb&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Rv.LocalVideoTrack:n=s._hints.includes(uv.SCREEN_TRACK)?av.Screen:av.High,r=dP(dP({},Nb(s)),{},{codec:this.store.codec});break;case Rv.LocalVideoLowTrack:n=av.Low,r=dP(dP({},Nb(s)),{},{codec:this.store.codec})}return{stream_type:n,attributes:r,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:r,id:s}]=e;switch(i){case Rv.LocalVideoTrack:t=n._hints.includes(uv.SCREEN_TRACK)?av.Screen:av.High;break;case Rv.LocalAudioTrack:t=av.Audio;break;case Rv.LocalVideoLowTrack:t=av.Low}return{stream_type:t,ssrcs:r,mid:s}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:r}=e;this.localTrackMap.set(r,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(Av.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"disconnected"===t&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{"disconnected"===e.iceConnectionState&&Kf("ICE_RESTART")&&"CONNECTED"===Xb(this,Av.QueryClientConnectionState)&&this.emit(Av.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(Pf.debug("P2PConnection disconnected timeout 4000ms, force reconnect"),setTimeout((()=>this.emit(Av.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===t&&(Pf.debug("P2PConnection state failed, force reconnect"),setTimeout((()=>this.emit(Av.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),TE.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:g_.TRACER}).onSuccess(),this.emit(Av.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const i=Array.from(aE(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var n;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(n=i.audioTrack)||void 0===n||n.emit(gv.FIRST_FRAME_DECODED),TE.firstRemoteFrame(this.store.sessionId,h_.FIRST_AUDIO_DECODE,u_.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Sb.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const i=Array.from(aE(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));i&&TE.firstRemoteFrame(this.store.sessionId,h_.FIRST_AUDIO_RECEIVED,u_.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Sb.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{var t;const i=Array.from(aE(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));i&&TE.firstRemoteFrame(this.store.sessionId,h_.FIRST_VIDEO_RECEIVED,u_.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Sb.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const i="relay"===e.candidateType,n="relay"===t.candidateType;"unknown"!==t.candidateType&&i===n||this.emit(Av.ConnectionTypeChange,i),Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Fb(t))," -> ").concat(JSON.stringify(Fb(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{Pf.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Fb(t))," -> ").concat(JSON.stringify(Fb(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Rv.LocalAudioTrack);if(e instanceof fb&&(null==i?void 0:i.track)instanceof vb)return i.track.isActive||t.push([Rv.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Rv.LocalVideoTrack)){const e=this.localTrackMap.get(Rv.LocalVideoLowTrack);e&&t.push([Rv.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Rv.LocalAudioTrack);if(e instanceof fb&&(null==i?void 0:i.track)instanceof vb)return i.track.isActive&&t.push([Rv.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Rv.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Rv.LocalVideoLowTrack);e&&t.push([Rv.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:r,id:s}]=e;switch(i){case Rv.LocalAudioTrack:t=av.Audio;break;case Rv.LocalVideoTrack:t=n._hints.includes(uv.SCREEN_TRACK)?av.Screen:av.High;break;case Rv.LocalVideoLowTrack:t=av.Low}return{stream_type:t,ssrcs:r,mid:s}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:r,id:s}]=e;switch(i){case Rv.LocalAudioTrack:t=av.Audio;break;case Rv.LocalVideoTrack:t=n._hints.includes(uv.SCREEN_TRACK)?av.Screen:av.High;break;case Rv.LocalVideoLowTrack:t=av.Low}return{stream_type:t,ssrcs:r,mid:s}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const r=n.get(t);if(!r)return i;i.push([e,{kind:t,id:r}])}else Array.from(n.entries()).forEach((t=>{let[n,r]=t;i.push([e,{kind:n,id:r}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:r}]=e;switch(n){case Cv.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Cv.VIDEO,ssrcId:i._videoSSRC}));case Cv.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Cv.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===Cv.VIDEO?e|=dv.Video:e|=dv.Audio,t.set(i,e)}else n===Cv.VIDEO?t.set(i,dv.Video):t.set(i,dv.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Rv.LocalVideoTrack),i=this.localTrackMap.get(Rv.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:r}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return r===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof fb){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const r=this.createUnmuteMessage(n);return void await Yb(this,Av.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Av.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Bb(bf(this.dtlsFailedCount,Sf)),this.emit(Av.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await Jb(this,Av.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Av.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Rv.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof mC))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof mC)).length>1)throw new Ef(yf.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof fb)).length>1&&(e.some((e=>e instanceof fb&&e._bypassWebAudio))||!Vv().webAudioMediaStreamDest))throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof mC&&this.pendingLocalTracks.some((e=>e instanceof mC)))throw new Ef(yf.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof fb&&this.pendingLocalTracks.some((e=>e instanceof fb))&&(!Vv().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof fb&&e._bypassWebAudio))))throw new Ef(yf.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=Vv().supportDualStreamEncoding,n=dP(dP({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=i?e._mediaStreamTrack.clone():CA(e,n);const s=Wb(8,"track-low-"),o=new mC(r,dP(dP({},i&&{scaleResolutionDownBy:Mb(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,s);return o._hints.push(uv.LOW_STREAM),e.addListener(hv.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}reportVideoFirstFrameDecoded(e,t,i,n){var r;const s=Array.from(aE(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(s){n||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,o=r.subscribe.find((e=>e.userId===s.uid&&"video"===e.type));TE.firstRemoteVideoDecode(this.store.sessionId,h_.FIRST_VIDEO_DECODE,u_.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:i,subscribeElapse:Sb.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==o?void 0:o.subscribeEnd)||0,subscriberStart:(null==o?void 0:o.subscribeStart)||0,videoAddNotify:(null==o?void 0:o.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const r=n.get(t);if(!r)return!1;const s=await this.connection.getRemoteSSRC(r);return void 0!==s&&s!==i}resetConnection(e){Pf.debug("[P2PChannel] reset connection to ".concat(e)),this.state===Iv.Connected?(Pf.debug("[P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first"),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===lv.datachannel?new sP({},this.store):this.isPlanB?new fA({},this.store):new wA({},this.store),this.bindConnectionEvents(this.connection)))}}).prototype,"startP2PConnection",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"startP2PConnection"),aP.prototype),Zy(aP.prototype,"connect",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"connect"),aP.prototype),Zy(aP.prototype,"preConnect",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"preConnect"),aP.prototype),Zy(aP.prototype,"unpublish",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"unpublish"),aP.prototype),Zy(aP.prototype,"unpublishLowStream",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"unpublishLowStream"),aP.prototype),Zy(aP.prototype,"subscribe",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"subscribe"),aP.prototype),Zy(aP.prototype,"massSubscribe",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"massSubscribe"),aP.prototype),Zy(aP.prototype,"unsubscribe",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"unsubscribe"),aP.prototype),Zy(aP.prototype,"massUnsubscribe",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"massUnsubscribe"),aP.prototype),Zy(aP.prototype,"muteRemote",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"muteRemote"),aP.prototype),Zy(aP.prototype,"unmuteRemote",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"unmuteRemote"),aP.prototype),Zy(aP.prototype,"hasRemoteMediaWithLock",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"hasRemoteMediaWithLock"),aP.prototype),Zy(aP.prototype,"disconnectForReconnect",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"disconnectForReconnect"),aP.prototype),Zy(aP.prototype,"updateBitrateLimit",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"updateBitrateLimit"),aP.prototype),Zy(aP.prototype,"remoteMediaSsrcChanged",[pP],Object.getOwnPropertyDescriptor(aP.prototype,"remoteMediaSsrcChanged"),aP.prototype),aP);function pP(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await n.apply(this,s)}finally{i()}},i}function mP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fP(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?mP(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):mP(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var gP;!function(e){e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL"}(gP||(gP={}));class _P{constructor(e,t,i,n){fp(this,"state",void 0),this.state={codec:e,audioCodec:t,mode:i,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1}}dispatch(e){this.state=function(e,t){switch(t.type){case gP.SET_SESSION_ID:return fP(fP({},e),{},{sessionId:t.sessionId});case gP.SET_P2P_ID:return fP(fP({},e),{},{p2pId:t.p2pId});case gP.SET_UID:return fP(fP({},e),{},{uid:t.uid});case gP.SET_PUB_ID:return fP(fP({},e),{},{pubId:t.pubId});case gP.KEY_METRIC_CLIENT_CREATED:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{clientCreated:t.metric})});case gP.KEY_METRIC_JOIN_START:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{joinStart:t.metric})});case gP.AVOID_JOIN_START:return fP(fP({},e),{},{avoidJoinStart:t.avoidJoinStart});case gP.KEY_METRIC_JOIN_END:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{joinEnd:t.metric})});case gP.KEY_METRIC_REQUEST_AP_START:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{requestAPStart:t.metric})});case gP.KEY_METRIC_REQUEST_AP_END:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{requestAPEnd:t.metric})});case gP.KEY_METRIC_JOIN_GATEWAY_START:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{joinGatewayStart:t.metric})});case gP.KEY_METRIC_JOIN_GATEWAY_END:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{joinGatewayEnd:t.metric})});case gP.KEY_METRIC_PEER_CONNECTION_START:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{peerConnectionStart:t.metric})});case gP.KEY_METRIC_PEER_CONNECTION_END:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{peerConnectionEnd:t.metric})});case gP.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{signalChannelOpen:t.metric})});case gP.KEY_METRIC_ICE_CONNECTION_END:return fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{iceConnectionEnd:t.metric})});case gP.KEY_METRIC_PUBLISH:{const i=e.keyMetrics.publish,n=i.findIndex((e=>e.trackId===t.metric.trackId));return-1!==n?(i[n]=fP(fP({},i[n]),t.metric),fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{publish:[...i]})})):fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,t.metric]})})}case gP.KEY_METRIC_SUBSCRIBE:{const i=e.keyMetrics.subscribe,n=i.findIndex((e=>e.userId===t.metric.userId&&e.type===t.metric.type));return-1!==n?(i[n]=fP(fP({},i[n]),t.metric),fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{subscribe:[...i]})})):fP(fP({},e),{},{keyMetrics:fP(fP({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,t.metric]})})}case gP.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=t.mode,e;case gP.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof t.index?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,t.record]:(e.joinChannelServiceRecords[t.index]=fP(fP({},e.joinChannelServiceRecords[t.index]),t.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case gP.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case gP.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case gP.SET_USE_DATACHANNEL:return fP(fP({},e),{},{useDataChannel:t.val});default:return e}}(this.state,e)}set sessionId(e){this.dispatch({type:gP.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}get codec(){return this.state.codec}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:gP.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:gP.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:gP.SET_UID,uid:e})}get uid(){return this.state.uid}set pubId(e){this.dispatch({type:gP.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:gP.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:gP.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}clientCreated(){this.dispatch({type:gP.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:gP.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:gP.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:gP.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:gP.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:gP.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:gP.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:gP.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:gP.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:gP.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:gP.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,t,i,n){this.dispatch({type:gP.KEY_METRIC_PUBLISH,metric:fP(fP({trackId:e,type:t},i&&{publishStart:i}),n&&{publishEnd:n})})}subscribe(e,t,i,n,r,s,o){this.dispatch({type:gP.KEY_METRIC_SUBSCRIBE,metric:fP(fP(fP(fP(fP({userId:e,type:t},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),r&&{firstFrame:r}),s&&{streamAdded:s}),o&&{firstDecoded:o})})}massSubscribe(e,t,i,n){e.forEach((e=>{this.dispatch({type:gP.KEY_METRIC_SUBSCRIBE,metric:fP(fP(fP({userId:e.userId,type:e.type},t&&{subscribeStart:t}),i&&{subscribeEnd:i}),n&&{firstFrame:n})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,t){"gateway"===e.service&&Array.isArray(e.urls)&&(e.urls=e.urls.map((e=>e.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof t?(this.dispatch({type:gP.RECORD_JOIN_CHANNEL_SERVICE,record:fP(fP({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(t<0||t>=this.state.joinChannelServiceRecords.length||this.dispatch({type:gP.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:t}),t)}catch(e){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:gP.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:gP.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(e){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:gP.AVOID_JOIN_START,avoidJoinStart:e})}}let vP;const yP=()=>"HTTPS"===(vP||vP||(vP=(window.location.protocol.split(":")[0]||"").toUpperCase(),vP)),EP=()=>void 0!==window.isSecureContext;function SP(e){let t=DP();return function(e,t){let i=e.appId;void 0!==i&&(qP(t,10),jP(t,i));let n=e.cid;void 0!==n&&(qP(t,16),qP(t,n));let r=e.cname;void 0!==r&&(qP(t,26),jP(t,r));let s=e.deviceId;void 0!==s&&(qP(t,34),jP(t,s));let o=e.elapse;void 0!==o&&(qP(t,40),zP(t,o));let a=e.fileSize;void 0!==a&&(qP(t,48),zP(t,OP(a)));let c=e.height;void 0!==c&&(qP(t,56),zP(t,OP(c)));let d=e.jpg;void 0!==d&&(qP(t,66),qP(t,d.length),function(e,t){let i=MP(e,t.length);e.bytes.set(t,i)}(t,d));let l=e.networkType;void 0!==l&&(qP(t,72),zP(t,OP(l)));let h=e.osType;void 0!==h&&(qP(t,80),zP(t,OP(h)));let u=e.requestId;void 0!==u&&(qP(t,90),jP(t,u));let p=e.sdkVersion;void 0!==p&&(qP(t,98),jP(t,p));let m=e.sequence;void 0!==m&&(qP(t,104),zP(t,OP(m)));let f=e.sid;void 0!==f&&(qP(t,114),jP(t,f));let g=e.timestamp;void 0!==g&&(qP(t,120),zP(t,g));let _=e.uid;void 0!==_&&(qP(t,128),qP(t,_));let v=e.vid;void 0!==v&&(qP(t,136),qP(t,v));let y=e.width;void 0!==y&&(qP(t,144),zP(t,OP(y)));let E=e.service;void 0!==E&&(qP(t,152),qP(t,E));let S=e.callbackData;void 0!==S&&(qP(t,162),jP(t,S));let b=e.jpgEncryption;void 0!==b&&(qP(t,168),qP(t,b));let w=e.requestType;void 0!==w&&(qP(t,176),qP(t,w));let T=e.scorePorn;void 0!==T&&(qP(t,185),KP(t,T));let C=e.scoreSexy;void 0!==C&&(qP(t,193),KP(t,C));let R=e.scoreNeutral;void 0!==R&&(qP(t,201),KP(t,R));let I=e.scene;void 0!==I&&(qP(t,208),qP(t,I));let A=e.ossFilePrefix;void 0!==A&&(qP(t,218),jP(t,A));let P=e.serviceVendor;if(void 0!==P)for(let O of P){qP(t,226);let e=DP();TP(O,e),qP(t,e.limit),VP(t,e),kP(e)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function bP(e){return function(e){let t={};e:for(;!LP(e);){let i=GP(e);switch(i>>>3){case 0:break e;case 1:t.code=GP(e);break;case 2:t.msg=UP(e,GP(e));break;case 3:{let i=CP(e);t.data=wP(e),e.limit=i;break}default:RP(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function wP(e){let t={};e:for(;!LP(e);){let i=GP(e);switch(i>>>3){case 0:break e;case 1:t.requestId=UP(e,GP(e));break;case 2:t.requestType=GP(e)>>>0;break;case 3:t.scorePorn=WP(e);break;case 4:t.scoreSexy=WP(e);break;case 5:t.scoreNeutral=WP(e);break;case 6:t.requestScene=GP(e)>>>0;break;case 7:t.scene=GP(e)>>>0;break;default:RP(e,7&i)}}return t}function TP(e,t){let i=e.service;void 0!==i&&(qP(t,8),qP(t,i));let n=e.vendor;void 0!==n&&(qP(t,16),qP(t,n));let r=e.token;void 0!==r&&(qP(t,26),jP(t,r));let s=e.callbackUrl;void 0!==s&&(qP(t,34),jP(t,s))}function CP(e){let t=GP(e),i=e.limit;return e.limit=e.offset+t,i}function RP(e,t){switch(t){case 0:for(;128&BP(e););break;case 2:xP(e,GP(e));break;case 5:xP(e,4);break;case 1:xP(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let IP=new Float32Array(1);new Uint8Array(IP.buffer);let AP=new Float64Array(1),PP=new Uint8Array(AP.buffer);function OP(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let NP=[];function DP(){const e=NP.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function kP(e){NP.push(e)}function xP(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function LP(e){return e.offset>=e.limit}function MP(e,t){let i=e.bytes,n=e.offset,r=e.limit,s=n+t;if(s>i.length){let t=new Uint8Array(2*s);t.set(i),e.bytes=t}return e.offset=s,s>r&&(e.limit=s),n}function FP(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function UP(e,t){let i=FP(e,t),n=String.fromCharCode,r=e.bytes,s="ï¿½",o="";for(let a=0;a<t;a++){let e,c,d,l,h=r[a+i];0==(128&h)?o+=n(h):192==(224&h)?a+1>=t?o+=s:(e=r[a+i+1],128!=(192&e)?o+=s:(l=(31&h)<<6|63&e,l<128?o+=s:(o+=n(l),a++))):224==(240&h)?a+2>=t?o+=s:(e=r[a+i+1],c=r[a+i+2],32896!=(49344&(e|c<<8))?o+=s:(l=(15&h)<<12|(63&e)<<6|63&c,l<2048||l>=55296&&l<=57343?o+=s:(o+=n(l),a+=2))):240==(248&h)?a+3>=t?o+=s:(e=r[a+i+1],c=r[a+i+2],d=r[a+i+3],8421504!=(12632256&(e|c<<8|d<<16))?o+=s:(l=(7&h)<<18|(63&e)<<12|(63&c)<<6|63&d,l<65536||l>1114111?o+=s:(l-=65536,o+=n(55296+(l>>10),56320+(1023&l)),a+=3))):o+=s}return o}function jP(e,t){let i=t.length,n=0;for(let o=0;o<i;o++){let e=t.charCodeAt(o);e>=55296&&e<=56319&&o+1<i&&(e=(e<<10)+t.charCodeAt(++o)-56613888),n+=e<128?1:e<2048?2:e<65536?3:4}qP(e,n);let r=MP(e,n),s=e.bytes;for(let o=0;o<i;o++){let e=t.charCodeAt(o);e>=55296&&e<=56319&&o+1<i&&(e=(e<<10)+t.charCodeAt(++o)-56613888),e<128?s[r++]=e:(e<2048?s[r++]=e>>6&31|192:(e<65536?s[r++]=e>>12&15|224:(s[r++]=e>>18&7|240,s[r++]=e>>12&63|128),s[r++]=e>>6&63|128),s[r++]=63&e|128)}}function VP(e,t){let i=MP(e,t.limit),n=e.bytes,r=t.bytes;for(let s=0,o=t.limit;s<o;s++)n[s+i]=r[s]}function BP(e){return e.bytes[FP(e,1)]}function HP(e,t){let i=MP(e,1);e.bytes[i]=t}function WP(e){let t=FP(e,8),i=e.bytes;return PP[0]=i[t++],PP[1]=i[t++],PP[2]=i[t++],PP[3]=i[t++],PP[4]=i[t++],PP[5]=i[t++],PP[6]=i[t++],PP[7]=i[t++],AP[0]}function KP(e,t){let i=MP(e,8),n=e.bytes;AP[0]=t,n[i++]=PP[0],n[i++]=PP[1],n[i++]=PP[2],n[i++]=PP[3],n[i++]=PP[4],n[i++]=PP[5],n[i++]=PP[6],n[i++]=PP[7]}function GP(e){let t,i=0,n=0;do{t=BP(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function qP(e,t){for(t>>>=0;t>=128;)HP(e,127&t|128),t>>>=7;HP(e,t)}function zP(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=0===r?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,o=MP(e,s),a=e.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=9!==s?128|r:127&r;case 8:a[o+7]=8!==s?n>>>21|128:n>>>21&127;case 7:a[o+6]=7!==s?n>>>14|128:n>>>14&127;case 6:a[o+5]=6!==s?n>>>7|128:n>>>7&127;case 5:a[o+4]=5!==s?128|n:127&n;case 4:a[o+3]=4!==s?i>>>21|128:i>>>21&127;case 3:a[o+2]=3!==s?i>>>14|128:i>>>14&127;case 2:a[o+1]=2!==s?i>>>7|128:i>>>7&127;case 1:a[o]=1!==s?128|i:127&i}}const JP=async(e,t,i)=>{const n=function(e){const t=[];for(let i=0;i<e.length;i+=2)t.push(parseInt(e.slice(i,i+2),16));return Uint8Array.from(t)}(function(e){const t="0123456789abcdef";function i(e){let i,n="";for(i=0;i<=3;i++)n+=t.charAt(e>>8*i+4&15)+t.charAt(e>>8*i&15);return n}function n(e,t){const i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function r(e,t,i,r,s,o){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(r,o)),s),i)}function s(e,t,i,n,s,o,a){return r(t&i|~t&n,e,t,s,o,a)}function o(e,t,i,n,s,o,a){return r(t&n|i&~n,e,t,s,o,a)}function a(e,t,i,n,s,o,a){return r(t^i^n,e,t,s,o,a)}function c(e,t,i,n,s,o,a){return r(i^(t|~n),e,t,s,o,a)}const d=function(e){let t;const i=1+(e.length+8>>6),n=new Array(16*i);for(t=0;t<16*i;t++)n[t]=0;for(t=0;t<e.length;t++)n[t>>2]|=e.charCodeAt(t)<<t%4*8;return n[t>>2]|=128<<t%4*8,n[16*i-2]=8*e.length,n}(e);let l,h,u,p,m,f=1732584193,g=-271733879,_=-1732584194,v=271733878;for(l=0;l<d.length;l+=16)h=f,u=g,p=_,m=v,f=s(f,g,_,v,d[l+0],7,-680876936),v=s(v,f,g,_,d[l+1],12,-389564586),_=s(_,v,f,g,d[l+2],17,606105819),g=s(g,_,v,f,d[l+3],22,-1044525330),f=s(f,g,_,v,d[l+4],7,-176418897),v=s(v,f,g,_,d[l+5],12,1200080426),_=s(_,v,f,g,d[l+6],17,-1473231341),g=s(g,_,v,f,d[l+7],22,-45705983),f=s(f,g,_,v,d[l+8],7,1770035416),v=s(v,f,g,_,d[l+9],12,-1958414417),_=s(_,v,f,g,d[l+10],17,-42063),g=s(g,_,v,f,d[l+11],22,-1990404162),f=s(f,g,_,v,d[l+12],7,1804603682),v=s(v,f,g,_,d[l+13],12,-40341101),_=s(_,v,f,g,d[l+14],17,-1502002290),g=s(g,_,v,f,d[l+15],22,1236535329),f=o(f,g,_,v,d[l+1],5,-165796510),v=o(v,f,g,_,d[l+6],9,-1069501632),_=o(_,v,f,g,d[l+11],14,643717713),g=o(g,_,v,f,d[l+0],20,-373897302),f=o(f,g,_,v,d[l+5],5,-701558691),v=o(v,f,g,_,d[l+10],9,38016083),_=o(_,v,f,g,d[l+15],14,-660478335),g=o(g,_,v,f,d[l+4],20,-405537848),f=o(f,g,_,v,d[l+9],5,568446438),v=o(v,f,g,_,d[l+14],9,-1019803690),_=o(_,v,f,g,d[l+3],14,-187363961),g=o(g,_,v,f,d[l+8],20,1163531501),f=o(f,g,_,v,d[l+13],5,-1444681467),v=o(v,f,g,_,d[l+2],9,-51403784),_=o(_,v,f,g,d[l+7],14,1735328473),g=o(g,_,v,f,d[l+12],20,-1926607734),f=a(f,g,_,v,d[l+5],4,-378558),v=a(v,f,g,_,d[l+8],11,-2022574463),_=a(_,v,f,g,d[l+11],16,1839030562),g=a(g,_,v,f,d[l+14],23,-35309556),f=a(f,g,_,v,d[l+1],4,-1530992060),v=a(v,f,g,_,d[l+4],11,1272893353),_=a(_,v,f,g,d[l+7],16,-155497632),g=a(g,_,v,f,d[l+10],23,-1094730640),f=a(f,g,_,v,d[l+13],4,681279174),v=a(v,f,g,_,d[l+0],11,-358537222),_=a(_,v,f,g,d[l+3],16,-722521979),g=a(g,_,v,f,d[l+6],23,76029189),f=a(f,g,_,v,d[l+9],4,-640364487),v=a(v,f,g,_,d[l+12],11,-421815835),_=a(_,v,f,g,d[l+15],16,530742520),g=a(g,_,v,f,d[l+2],23,-995338651),f=c(f,g,_,v,d[l+0],6,-198630844),v=c(v,f,g,_,d[l+7],10,1126891415),_=c(_,v,f,g,d[l+14],15,-1416354905),g=c(g,_,v,f,d[l+5],21,-57434055),f=c(f,g,_,v,d[l+12],6,1700485571),v=c(v,f,g,_,d[l+3],10,-1894986606),_=c(_,v,f,g,d[l+10],15,-1051523),g=c(g,_,v,f,d[l+1],21,-2054922799),f=c(f,g,_,v,d[l+8],6,1873313359),v=c(v,f,g,_,d[l+15],10,-30611744),_=c(_,v,f,g,d[l+6],15,-1560198380),g=c(g,_,v,f,d[l+13],21,1309151649),f=c(f,g,_,v,d[l+4],6,-145523070),v=c(v,f,g,_,d[l+11],10,-1120210379),_=c(_,v,f,g,d[l+2],15,718787259),g=c(g,_,v,f,d[l+9],21,-343485551),f=n(f,h),g=n(g,u),_=n(_,p),v=n(v,m);return i(f)+i(g)+i(_)+i(v)}(""+t+i)).slice(0,16),r=n.slice(0,12),s=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},s,e))};function YP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const XP=new Map([["moderation",1],["supervise",2]]);class $P extends _f{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(Lv.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=$i(t=e.map((e=>XP.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),fp(this,"name","AgoraRTCVideoContentInspect"),fp(this,"_connectionState",kv.CONNECTING),fp(this,"_innerConnectionState",void 0),fp(this,"sequence",0),fp(this,"inspectStartTime",void 0),fp(this,"workerManagerConnection",void 0),fp(this,"workerConnection",void 0),fp(this,"workerMessageLengthLimit",void 0),fp(this,"inspectIntervalMinimum",void 0),fp(this,"qualityRatio",void 0),fp(this,"_connectInfo",void 0),fp(this,"_cancelTokenSource",ff.CancelToken.source()),fp(this,"_retryConfig",void 0),fp(this,"wmSequence",0),fp(this,"inspectInterval",void 0),fp(this,"inspectTimer",null),fp(this,"ossFilePrefix",void 0),fp(this,"extraInfo",void 0),fp(this,"_inspectType",void 0),fp(this,"_inspectMode",void 0),fp(this,"_quality",1),fp(this,"qualityTimer",null),fp(this,"_inspectId",void 0),fp(this,"_needWorkUrlOnly",!1),fp(this,"inspectImage",(()=>{if(this.connectionState!==kv.CONNECTED)throw new Ef(yf.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===kv.CONNECTED?this.requestToInspectImage():Pf.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=Wb(5,"inspect-"),this.workerMessageLengthLimit=Kf("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Kf("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Kf("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new fw("worker-manager-"+this._inspectId,Sf),this.on(Lv.STATE_CHANGE,((e,t)=>{this._innerConnectionState=e,Pf.debug("[".concat(this._inspectId,"] Inspect operation :").concat(xv[e]," ").concat(t||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new fw("worker-"+this._inspectId,Sf),this.handleWorkerEvents()}async init(e,t){this.emit(Lv.STATE_CHANGE,xv.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new yh(((n,r)=>{this.on(Lv.CONNECTION_STATE_CHANGE,((e,t)=>{t===kv.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{r(e)}))}))}async requestAP(e,t,i){const n=Kf("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,t,i,n){let{appId:r,areaCode:s,cname:o,sid:a,token:c,uid:d}=t;$w++;const l="image_moderation_api",h={service_name:l,json_body:JSON.stringify({appId:r,areaCode:s,cname:o,command:"allocateEdge",requestId:$w,seq:$w,sid:a,token:c,ts:Date.now(),uid:d+""})};let u,p,m=e[0];return wf((async()=>{u=Date.now();const e=await uE(m,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==e.code){const t=new Ef(yf.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:p});throw Pf.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new Ef(yf.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw Pf.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new Ef(yf.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:t.code,responseTime:p});throw Pf.error(e.toString()),e}const n=Kf("VIDEO_INSPECT_WORKER_MANAGER_HOST"),r=Kf("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:t.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(r||i)})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,responseTime:p}}),((t,i)=>(TE.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===i,responseTime:p,serverIp:e[i%e.length]}),!1)),((t,i)=>(TE.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:l,responseTime:p,serverIp:e[i%e.length]}),!!(t.code!==yf.OPERATION_ABORTED&&t.code!==yf.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(m=e[(i+1)%e.length],!0))),n)}(n,e,t,i);this.emit(Lv.STATE_CHANGE,xv.AP_CONNECTED);const{addressList:s}=r;return this.wmSequence++,s}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(Lv.STATE_CHANGE,xv.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(G_.CONNECTED,(async()=>{this.emit(Lv.STATE_CHANGE,xv.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.17.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(G_.CLOSED,(()=>{this._innerConnectionState<xv.GET_WORKER_MANAGER_RESPONSE&&Pf.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(G_.FAILED,(()=>{this._innerConnectionState<xv.GET_WORKER_MANAGER_RESPONSE&&Pf.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(G_.RECONNECTING,(()=>{this._innerConnectionState<xv.GET_WORKER_MANAGER_RESPONSE&&Pf.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(G_.ON_MESSAGE,(async e=>{this.emit(Lv.STATE_CHANGE,xv.GET_WORKER_MANAGER_RESPONSE);const t=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(e.data);if(200!==i.code)throw Pf.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new Ef(yf.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&t))throw Pf.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new Ef(yf.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const e=Kf("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,n=t.replace(/:\d+\/?$/,":".concat(e));this.emit(Lv.STATE_CHANGE,xv.CONNECT_WORKER,n),this._needWorkUrlOnly?this.emit(Lv.REQUEST_NEW_WORKER_URL,n):await this.connectWorker(n)}})),this.workerManagerConnection.on(G_.WILL_RECONNECT,((e,t)=>{t(e)})),this.workerManagerConnection.on(G_.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(G_.CONNECTED,(async()=>{this.emit(Lv.STATE_CHANGE,xv.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=kv.CONNECTED})),this.workerConnection.on(G_.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const i=bP(new Uint8Array(e.data));if(Kf("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&Pf.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),200===i.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(Lv.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var t;const e={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},n=$i(t=Object.keys(e)).call(t,((t,i)=>e[t]>e[i]?t:i),"porn"),r=Object.keys(e).find((e=>e===n));this.emit(Lv.INSPECT_RESULT,r)}else this.emit(Lv.INSPECT_RESULT,void 0,new Ef(yf.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(Lv.INSPECT_RESULT,void 0,new Ef(yf.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else Pf.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Lv.INSPECT_RESULT,void 0,new Ef(yf.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(G_.CLOSED,(()=>{this.connectionState=kv.CLOSED})),this.workerConnection.on(G_.FAILED,(()=>{this.connectionState=kv.CLOSED})),this.workerConnection.on(G_.RECONNECTING,(()=>{this.connectionState=this.connectionState===kv.CONNECTED?kv.RECONNECTING:kv.CONNECTING})),this.workerConnection.on(G_.WILL_RECONNECT,((e,t)=>{"recover"===e&&t(e),t("tryNext")})),this.workerConnection.on(G_.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(Lv.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=Xb(this,Lv.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Lv.INSPECT_RESULT,void 0,new Ef(yf.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Lv.INSPECT_RESULT,void 0,new Ef(yf.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:i,cname:n,cid:r,vid:s,sid:o,uid:a}=t;const c=Date.now(),d=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await(async(e,t,i)=>await JP(e.buffer,t,i))(d,i,n),h=this.sequence+"-"+r+"-"+a+"-"+c+"-"+Wb(12,""),u={appId:i,cid:r,cname:n,deviceId:"",elapse:$P.intToLong(Number(c-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:h,sdkVersion:"4.17.2",sequence:this.sequence,sid:o,timestamp:$P.intToLong(c),uid:a,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete u.callbackData,void 0===this.ossFilePrefix&&delete u.ossFilePrefix;const p=SP(u);if(p.byteLength<this.workerMessageLengthLimit){if(Kf("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?YP(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):YP(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},u);delete e.jpg,Pf.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return p}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:i,cname:n,cid:r,vid:s,sid:o,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ff.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=kv.CLOSED,this.emit(Lv.STATE_CHANGE,xv.CLOSED)}}var QP,ZP,eO,tO,iO,nO,rO,sO,oO,aO,cO,dO,lO,hO,uO,pO,mO,fO,gO,_O,vO,yO,EO,SO,bO,wO,TO,CO,RO,IO,AO,PO,OO,NO,DO,kO,xO,LO,MO;function FO(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function UO(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?FO(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):FO(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let jO=(QP=wE(),ZP=wE({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),t.map((e=>e?Object(e).toString():"null")))}),eO=wE({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId())))}),tO=wE({argsMap:(e,t,i)=>[t.uid,i]}),iO=wE({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),nO=wE({argsMap:(e,t,i)=>[t.uid,i]}),rO=wE({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),sO=wE(),oO=wE(),aO=wE(),cO=wE(),dO=wE(),lO=wE(),hO=wE(),uO=wE(),pO=wE(),mO=wE(),fO=wE(),gO=wE(),_O=wE(),vO=wE(),yO=wE({argsMap:(e,t)=>[t]}),EO=wE(),SO=wE(),bO=wE(),wO=wE(),TO=wE(),CO=wE(),RO=wE(),IO=wE(),AO=wE(),PO=wE(),OO=wE({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),NO=wE(),DO=wE(),kO=wE(),xO=wE({reportResult:!0}),LO=wE(),Zy((MO=class extends _f{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),fp(this,"store",void 0),fp(this,"_uid",void 0),fp(this,"_channelName",void 0),fp(this,"_uintUid",void 0),fp(this,"_users",[]),fp(this,"_codec",void 0),fp(this,"_mode",void 0),fp(this,"_config",void 0),fp(this,"_clientId",void 0),fp(this,"_appId",void 0),fp(this,"_sessionId",null),fp(this,"_key",void 0),fp(this,"_joinInfo",void 0),fp(this,"_gateway",void 0),fp(this,"_statsCollector",void 0),fp(this,"_configDistribute",void 0),fp(this,"_leaveMutex",new AE("client-leave")),fp(this,"_publishMutex",new AE("client-publish")),fp(this,"_renewTokenMutex",new AE("client-renewtoken")),fp(this,"_subscribeMutex",new AE("client-subscribe")),fp(this,"_encryptionMode","none"),fp(this,"_encryptionSecret",null),fp(this,"_encryptionSalt",null),fp(this,"_proxyServer",void 0),fp(this,"_turnServer",{servers:[],mode:"auto"}),fp(this,"_cloudProxyServerMode","disabled"),fp(this,"_isDualStreamEnabled",!1),fp(this,"_defaultStreamFallbackType",void 0),fp(this,"_lowStreamParameter",void 0),fp(this,"_streamFallbackTypeCacheMap",new Map),fp(this,"_remoteStreamTypeCacheMap",new Map),fp(this,"_axiosCancelSource",ff.CancelToken.source()),fp(this,"_audioVolumeIndicationInterval",void 0),fp(this,"_networkQualityInterval",void 0),fp(this,"_userOfflineTimeout",void 0),fp(this,"_streamRemovedTimeout",void 0),fp(this,"_injectStreamingClient",void 0),fp(this,"_liveTranscodeStreamingClient",void 0),fp(this,"_liveRawStreamingClient",void 0),fp(this,"_channelMediaRelayClient",void 0),fp(this,"_networkQualitySensitivity","normal"),fp(this,"_p2pChannel",void 0),fp(this,"_useLocalAccessPoint",!1),fp(this,"_setLocalAPVersion",void 0),fp(this,"_joinAndNotLeaveYet",!1),fp(this,"_numberOfJoinCount",0),fp(this,"_remoteDefaultVideoStreamType",void 0),fp(this,"_inspect",void 0),fp(this,"_license",void 0),fp(this,"_handleLocalTrackEnable",((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),fp(this,"_handleLocalTrackDisable",((e,t,i)=>{this.unpublish(e).then(t).catch(i)})),fp(this,"_handleUserOnline",(e=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(e.uid,this.channelName))return void Pf.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&Pf.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const t=this._users.find((t=>t.uid===e.uid));if(t)t._trust_in_room_=!0;else{const t=new gC(e.uid,e.uint_id||e.uid);this._users.push(t),Pf.debug("[".concat(this._clientId,"] user online"),e.uid),this.emit(R_.USER_JOINED,t)}})),fp(this,"_handleUserOffline",(e=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));t&&(this._handleRemoveStream(e),Qb(this._users,t),this._remoteStreamTypeCacheMap.delete(t.uid),this._streamFallbackTypeCacheMap.delete(t.uid),Pf.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.emit(R_.USER_LEAVED,t,e.reason))})),fp(this,"_handleAddAudioOrVideoStream",((e,t,i,n,r,s,o)=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(t,this.channelName))return;const a=this._users.find((e=>e.uid===t));if(!a)return void Pf.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Pf.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(a.uid,e,void 0,void 0,void 0,Date.now());const c="audio"===e?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=r||t),"audio"===e?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===e?(a._audio_added_=!0,void 0!==i&&(a._audioSSRC=i),void 0!==n&&(a._cname=n),s&&(a._audioOrtc=s)):(a._video_added_=!0,void 0!==i&&(a._videoSSRC=i),void 0!==n&&(a._cname=n),void 0!==o&&(a._rtxSsrcId=o),s&&(a._videoOrtc=s)),("audio"===e?a.hasAudio:a.hasVideo)&&!c&&(Pf.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(e)),this.emit(R_.USER_PUBLISHED,a,e)),"video"===e?TE.onGatewayStream(this._sessionId,h_.ON_ADD_VIDEO_STREAM,u_.ON_ADD_VIDEO_STREAM,{peer:r||t}):TE.onGatewayStream(this._sessionId,h_.ON_ADD_AUDIO_STREAM,u_.ON_ADD_AUDIO_STREAM,{peer:r||t}),this._p2pChannel.remoteMediaSsrcChanged(a,e,i).then((t=>{if(t)return Pf.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel.unsubscribe(a,e,!0).then((()=>this._subscribe(a,e,!0).catch((e=>{Pf.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,e)&&(Pf.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,e,!0).catch((e=>{Pf.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))})),fp(this,"_handleRemoveStream",(e=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));if(!t)return void Pf.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));Pf.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let i=()=>{};t.hasAudio&&t.hasVideo?i=()=>{Pf.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.emit(R_.USER_UNPUBLISHED,t,"audio"),Pf.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.emit(R_.USER_UNPUBLISHED,t,"video")}:t.hasVideo?i=()=>{Pf.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.emit(R_.USER_UNPUBLISHED,t,"video")}:t.hasAudio&&(i=()=>{Pf.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.emit(R_.USER_UNPUBLISHED,t,"audio")}),t._trust_audio_stream_added_state_=!0,t._trust_video_stream_added_state_=!0,t._audio_added_=!1,t._video_added_=!1,this._p2pChannel.unsubscribe(t).then((e=>{if(e)return this._gateway.unsubscribe(e,t.uid)})),t._audioSSRC=void 0,t._videoSSRC=void 0,t._audioOrtc=void 0,t._videoOrtc=void 0,t._rtxSsrcId=void 0,TE.onGatewayStream(this._sessionId,h_.ON_REMOVE_STREAM,u_.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),i()})),fp(this,"_handleSetStreamLocalEnable",((e,t,i)=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(t,this.channelName))return;const n=this._users.find((e=>e.uid===t));if(!n)return void Pf.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));Pf.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(i?"enabled":"disabled"," with uid ").concat(t));const r="audio"===e?n.hasAudio:n.hasVideo;if("audio"===e){n._trust_audio_enabled_state_=!0;const e=n._audio_enabled_;if(n._audio_enabled_=i,n._audio_enabled_===e)return;{const e=n._audio_enabled_?"enable-local-audio":"disable-local-audio";Pf.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(t,", msg: ").concat(e)),this.emit(R_.USER_INFO_UPDATED,t,e)}}else{n._trust_video_enabled_state_=!0;const e=n._video_enabled_;if(n._video_enabled_=i,n._video_enabled_===e)return;{const e=n._video_enabled_?"enable-local-video":"disable-local-video";Pf.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.emit(R_.USER_INFO_UPDATED,t,e)}}const s="audio"===e?n.hasAudio:n.hasVideo;return r!==s?!r&&s?(Pf.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.emit(R_.USER_PUBLISHED,n,e)):("video"===e&&n._videoTrack&&n._videoTrack._destroy(),"audio"===e&&n._audioTrack,this._p2pChannel.muteRemote(n,e),Pf.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),void this.emit(R_.USER_UNPUBLISHED,n,e)):void 0})),fp(this,"_handleMuteStream",((e,t,i)=>{if(Kf("BLOCK_LOCAL_CLIENT")&&eg(e,this.channelName))return;Pf.debug("[".concat(this._clientId,"] receive mute message"),e,t,i);const n=this._users.find((t=>t.uid===e));if(!n)return void Pf.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const r="audio"===t?n.hasAudio:n.hasVideo;if("audio"===t){n._trust_audio_mute_state_=!0;const t=n._audio_muted_;if(n._audio_muted_=i,n._audio_muted_===t)return;{const t=n._audio_muted_?"mute-audio":"unmute-audio";Pf.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.emit(R_.USER_INFO_UPDATED,e,t)}}else{n._trust_video_mute_state_=!0;const t=n._video_muted_;if(n._video_muted_=i,n._video_muted_===t)return;{const t=n._video_muted_?"mute-video":"unmute-video";Pf.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.emit(R_.USER_INFO_UPDATED,e,t)}}const s="audio"===t?n.hasAudio:n.hasVideo;if(r!==s){if(!r&&s)return("audio"===t?n._audioSSRC:n._videoSSRC)?(Pf.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.emit(R_.USER_PUBLISHED,n,t)):void Pf.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(t," unmute message  before add stream message, ").concat(t," SSRC doesn't exist yet."));"video"===t&&n._videoTrack&&n._videoTrack._destroy(),"audio"===t&&n._audioTrack,this._p2pChannel.muteRemote(n,t),Pf.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),this.emit(R_.USER_UNPUBLISHED,n,t)}})),fp(this,"_handleP2PLost",(async e=>{Pf.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():Pf.warning("P2PLost stream not found",e)})),fp(this,"_handleTokenWillExpire",(()=>{Pf.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.emit(R_.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),fp(this,"_handleBeforeUnload",(e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),Pf.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),fp(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.emit(R_.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.emit(R_.NETWORK_QUALITY,e)})),this._codec=e.codec,this._mode=e.mode,this._clientId=Wb(5,"client-"),this.store=new _P(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),Pf.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Nf," build: ").concat(Of,", mode: ").concat(this._mode,", codec: ").concat(this._codec)),e.clientRoleOptions)try{j_(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(e){Pf.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new Tb(this.store),this._statsCollector.onStatsException=(e,t,i)=>{Pf.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(t,", uid: ").concat(i)),this.emit(R_.EXCEPTION,{code:e,msg:t,uid:i})},this._statsCollector.onUploadPublishDuration=(e,t,i,n)=>{const r=this._users.find((t=>t.uid===e));r&&TE.peerPublishStatus(this._sessionId,{subscribeElapse:n,audioPublishDuration:t,videoPublishDuration:i,peer:r._uintid})},this.store.useDataChannel=Vv().supportDataChannel&&Kf("SIGNAL_CHANNEL"),this._gateway=new Pw(this.store,{clientId:this._clientId,mode:this._mode,codec:this._codec,websocketRetryConfig:e.websocketRetryConfig||Sf,httpRetryConfig:e.httpRetryConfig||Sf,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._config=e,this._configDistribute=new cT,this._p2pChannel=new uP(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async join(e,t,i,n,r){const s=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const o=yP(),a=EP()?window.isSecureContext:"Browser Not Support";if(!EP()&&!o||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";Pf.warning(e)}const c=Kb();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),Pf.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const d=TE.reportApiInvoke(c,{name:f_.JOIN,options:[e,t,i,n],states:{isHttps:o,isSecureContext:a},tag:g_.TRACER});TE.setAppId(e);try{if(!i&&null!==i)throw new Ef(yf.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&$g(i,"token",1,2047),$g(e,"appid",1,2047),Zg(t),n&&e_(n),r&&$g(r,"optionalInfo",1,2047)}catch(e){throw d.onError(e),e}if(Pf.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(s)),this._leaveMutex.isLocked&&(Pf.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),Pf.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(e),e}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=UO({clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:"string"!=typeof n?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof n&&(l.stringUid=n,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await(async e=>{const t=rw("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),i=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),n=vE(e),r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,n);return sw(new Uint8Array(r))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:t,appId:e});const h=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&h===this._sessionId&&TE.joinChannelTimeout(this._sessionId,5)}),5e3);try{let n;const r=l.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(r)){const e=Kf("PROXY_SERVER_TYPE3");Array.isArray(e)?l.proxyServer=e[0]:l.proxyServer=e}if(TE.setProxyServer(l.proxyServer),Pf.setProxyServer(l.proxyServer),this.store.requestAPStart(),l.stringUid&&!l.uid){const e=await eT(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||Sf,this.store);Pf.debug("getUserAccount Success ".concat(l.stringUid," => ").concat(e)),l.uid=e,n=await Zw(l,this._axiosCancelSource.token,this._config.httpRetryConfig||Sf,!0,this.store)}else n=await Zw(l,this._axiosCancelSource.token,this._config.httpRetryConfig||Sf,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(wv.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=i||e;const s=n.gatewayInfo;this._joinInfo=UO(UO({},l),{},{cid:s.cid,uid:l.uid?l.uid:s.uid,vid:s.vid,apResponse:s.res,uni_lbs_ip:s.uni_lbs_ip,gatewayAddrs:s.gatewayAddrs});const o=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(o),this._appId=e,this._channelName=l.cname,this._uid=o,this.store.uid=o,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Ku()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const a=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return Pf.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(a)),setTimeout((()=>{Pf.startUpload()}),5e3),this.store.joinEnd(),u=this,Qf.includes(u)||Qf.push(u),o}catch(e){const t=Array.isArray(e)?e[0]:e;throw Pf.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),t),t.code!==yf.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(t),t}var u}_joinGateway(){if(!this._joinInfo||!this._key)throw new Ef(yf.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!Kf("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===yf.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,C_.FALLBACK),e;if(e.code===yf.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,C_.FALLBACK),e;throw e})).then((e=>{if(e instanceof Ef){if(e.code===yf.INIT_WEBSOCKET_TIMEOUT){if(Pf.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Ef(yf.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=Kf("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&e.includes(i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const t=Kf("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return t&&t[1]&&"443"!==t[1]&&Pf.setProxyServer(this._joinInfo.proxyServer),"443"!==Kf("STATS_COLLECTOR_PORT").toString()&&TE.setProxyServer(this._joinInfo.proxyServer),TE.reportApiInvoke(this._sessionId,{name:f_.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:g_.TRACER}).onSuccess(),this.emit(R_.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Kf("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(Pf.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Ef(yf.INVALID_OPERATION);return TE.reportApiInvoke(this._sessionId,{name:f_.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:g_.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){Pf.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Ku()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Qf.indexOf(e);-1!==t&&Qf.splice(t,1)}(this);const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return Pf.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),Pf.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Array.isArray(e)||(e=[e]),0===e.length)throw new Ef(yf.INVALID_PARAMS,"track list is empty");if("audience"===this._gateway.role)throw new Ef(yf.INVALID_OPERATION,"audience can not publish stream");for(const n of e){if(!(n instanceof OE))throw new Ef(yf.INVALID_PARAMS,"parameter is not local track");if(!n._enabled&&t)throw new Ef(yf.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(n.getTrackId()))}Pf.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(e.map((e=>"".concat(e.getTrackId()," "))))),await this._configDistribute.awaitConfigDistributeComplete(),t&&e.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof mC&&t&&e.setBitrateLimit(t.uplink)}));const i=await this._publishMutex.lock();try{await this._publishHighStream(e),Pf.info("[".concat(this._clientId,"] Publish success, id ").concat(e.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw Pf.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{i()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new Ef(yf.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");e?Array.isArray(e)||(e=[e]):e=this._p2pChannel.getAllTracks(!0),Pf.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map((e=>"".concat(e.getTrackId()," ")))," "));const t=await this._publishMutex.lock();try{const t=await this._p2pChannel.unpublish(e);t&&await this._gateway.unpublish(t,this._uid),Pf.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map((e=>"".concat(e.getTrackId())))))}catch(e){throw Pf.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{t&&t()}}async subscribe(e,t){return this._subscribe(e,t)}async _subscribe(e,t,i){if(Jg(t,"mediaType",["audio","video"]),!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const t=new Ef(yf.INVALID_REMOTE_USER,"user is not in the channel");throw Pf.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new Ef(yf.INVALID_REMOTE_USER,"user is not published");throw Pf.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!(i||("audio"!==t||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==t||e.hasVideo&&void 0!==e._videoSSRC))){const i=new Ef(yf.REMOTE_USER_IS_NOT_PUBLISHED);throw Pf.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),i}const n="audio"===t?e._audioSSRC:e._videoSSRC,r="audio"===t?e._audioOrtc:e._videoOrtc,s="video"===t?e._rtxSsrcId:void 0,o={stream_type:"audio"===t?Cv.AUDIO:Cv.VIDEO,ssrcId:n},a=await this._subscribeMutex.lock();Pf.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{Sb.markSubscribeStart(this.store.clientId,n),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,n,s,r);try{await this._gateway.subscribe(e.uid,o,!0)}catch(i){if((null==i?void 0:i.code)!==yf.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),i;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(i){throw this._p2pChannel.reportSubscribeEvent(!1,null==i?void 0:i.code,e,t),i}Pf.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{Pf.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const a="audio"===t?e._audioTrack:e._videoTrack;if(!a)throw new Ef(yf.UNEXPECTED_ERROR,"can not find remote track in user object");return a}catch(t){throw Pf.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{a()}}async massSubscribe(e){if(Qg(e,"subscribeList"),!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),i=new Map,n=await this._subscribeMutex.lock();Pf.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const r=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),s=await this._p2pChannel.globalLock();try{var o;for(let t=e.length-1;t>=0;t--){const n=e[t],{user:s,mediaType:o}=n;if(Jg(o,"mediaType",["audio","video"]),!s){const e=new Ef(yf.INVALID_PARAMS,"user property does not exist in subscribeList item");throw Pf.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===s))){const i=new Ef(yf.INVALID_REMOTE_USER,"user is not in the channel");Pf.error("[".concat(this._clientId,"] can not massSubscribe ").concat(s.uid,", this user is not in the channel")),r[t].error=i,e.splice(t,1);continue}if("audio"===o&&(!s.hasAudio||void 0===s._audioSSRC)||"video"===o&&(!s.hasVideo||void 0===s._videoSSRC)){const i=new Ef(yf.REMOTE_USER_IS_NOT_PUBLISHED);Pf.error("[".concat(this._clientId,"] can not subscribe ").concat(s.uid," with mediaType ").concat(o,", remote user is not published")),r[t].error=i,e.splice(t,1);continue}const a=dv.Video|dv.LwoVideo,c=i.get(s);if(c){if("video"===o?c&a:c&dv.Audio){e.splice(t,1),Pf.warning("repeat massSubscribe user:".concat(s.uid,", mediaType:").concat(o," twice"));continue}i.set(s,c|("video"===o?a:dv.Audio))}else i.set(s,"video"===o?a:dv.Audio)}for(let t=e.length-1;t>=0;t--){const n=e[t],{user:r,mediaType:s}=n,o=dv.Video|dv.LwoVideo;if(this._p2pChannel.hasRemoteMedia(r,s)){await this._p2pChannel.unmuteRemoteNoLock(r,s);const n=i.get(r);i.set(r,"video"===s?n^o:n^dv.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),t);const n=$i(o=Array.from(i.entries())).call(o,((e,t)=>{let[i,n]=t;if(0===n)return e;const r={stream_id:i.uid,stream_type:n};return n&dv.Audio&&(r.audio_ssrc=i._audioSSRC),n&dv.Video&&(r.video_ssrc=i._videoSSRC),e.push(r),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===Cv.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:t._rtxSsrcId}})));const i=new Map;if(n.length>0){const e=await this._gateway.subscribeAll(n,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:n,audio_error_code:r,error_code:s}=e;(n||r||s)&&i.set(t,{video_error_code:n,audio_error_code:r,error_code:s})}))}if(Array.from(i.entries()).length>0){const e=Array.from(i.entries()).map((e=>{let t,[i,n]=e;return n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=Cv.VIDEO:n.audio_error_code&&(t=Cv.AUDIO),{user:this.remoteUsers.find((e=>e.uid===i)),mediaType:t}}));await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of r){const t=i.get(e.user.uid);if(t){const i=t.error_code||"audio"===e.mediaType&&t.audio_error_code||"video"===e.mediaType&&t.video_error_code;if(i){const t=pw(i);Pf.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(t.desc)),e.error=new Ef(yf.SUBSCRIBE_FAILED,"code ".concat(i,": ").concat(t.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(r.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),r.forEach((e=>{var i;TE.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(i=e.error)||void 0===i?void 0:i.code)||null,video:e.mediaType===Cv.VIDEO,audio:e.mediaType===Cv.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===Cv.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)})),Pf.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),r}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{s(),n()}}async unsubscribe(e,t){if(t&&Jg(t,"mediaType",["audio","video"]),!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const t=new Ef(yf.INVALID_REMOTE_USER,"user is not in the channel");throw Pf.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}Pf.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));try{const i=await this._p2pChannel.unsubscribe(e,t);i&&await this._gateway.unsubscribe(i,e.uid),Pf.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}catch(t){if(t.code===yf.DISCONNECT_P2P)return void Pf.warning("disconnecting p2p, abort unsubscribe request.");throw Pf.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}}async massUnsubscribe(e){if(Qg(e,"unsubscribeList"),!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");Pf.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const t=new Map;for(let i=e.length-1;i>=0;i--){const{user:n,mediaType:r}=e[i];if(!n){const e=new Ef(yf.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw Pf.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}if(Jg(r,"mediaType",["video","audio",void 0]),!this._users.find((e=>e===n))){Pf.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),e.splice(i,1);continue}const s=dv.Video|dv.LwoVideo;if(t.has(n)){const o=t.get(n);let a;switch(r){case"video":a=o&s;break;case"audio":a=o&dv.Audio;break;default:a=o&(dv.Audio|s)}if(a){Pf.warning("repeat massUnsubscribe user:".concat(n.uid,",mediaType:").concat(r," twice.")),e.splice(i,1);continue}r?"audio"===r?t.set(n,o|dv.Audio):"video"===r&&t.set(n,o|s):t.set(n,o|dv.Audio|s)}else r?"audio"===r?t.set(n,dv.Audio):"video"===r&&t.set(n,s):t.set(n,dv.Audio|s)}try{const t=await this._p2pChannel.massUnsubscribe(e);t&&await this._gateway.massUnsubscribe(t),Pf.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===yf.DISCONNECT_P2P)return void Pf.warning("disconnecting p2p, abort unsubscribe request.");throw Pf.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}setLowStreamParameter(e){!function(e){if(!e)throw new Ef(yf.INVALID_PARAMS);t_(e.width)||Xg(e.width,"streamParameter.width"),t_(e.height)||Xg(e.height,"streamParameter.height"),t_(e.framerate)||Xg(e.framerate,"streamParameter.framerate"),t_(e.bitrate)||Yg(e.bitrate,"streamParameter.bitrate")}(e),(!e.width&&e.height||e.width&&!e.height)&&Pf.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),Pf.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e}async enableDualStream(){if(!Vv().supportDualStream)throw TE.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Ef(yf.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Ef(yf.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw TE.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,TE.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),Pf.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Rv.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw TE.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,TE.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),Pf.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(e){Jg(e,"role",["audience","host"])}(e),t&&j_(t),"rtc"===this._mode)throw Pf.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new Ef(yf.INVALID_OPERATION,"rtc mode can not use setClientRole");if(t&&t.level&&"host"===e)throw new Ef(yf.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new Ef(yf.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),Pf.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}setProxyServer(e,t){if($g(e,"proxyServer"),!t){if("DISCONNECTED"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ef(yf.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,TE.setProxyServer(this._proxyServer),Pf.setProxyServer(this._proxyServer),Pf.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if("DISCONNECTED"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ef(yf.INVALID_OPERATION,"You have already set the proxy")}if(F_(e))return this._turnServer={servers:e,mode:"original-manual"},void Pf.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>U_(e))),this._turnServer={servers:e,mode:"manual"},Pf.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"you should set license before join channel");if($g(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new Ef(yf.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,Pf.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new Ef(yf.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let i;switch(void 0===e&&(e=3),e){case 1:case 2:throw new Ef(yf.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new Ef(yf.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,Pf.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"Stop proxy server after leave channel");TE.setProxyServer(),Pf.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",Pf.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new Ef(yf.INVALID_PARAMS,"accessPoints is required.");Qg(e.accessPoints.serverList,"accessPoints.serverList"),$g(e.accessPoints.domain,"accessPoints.domain");const t=(e,t)=>{Yg(e,t,0,65535,!0)};let i=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),i=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ef(yf.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Kf("CLOSE_AFB_FOR_LOCAL_AP")&&(Wf("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Wf("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,s=e.accessPoints.serverList.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(r):e)),o=s.map((e=>"".concat(e,":").concat(i)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Wf("WEBCS_DOMAIN",o),Wf("WEBCS_DOMAIN_BACKUP_LIST",o),Wf("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Qg(e.report.hostname,"report.hostname"),Wf("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Wf("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Wf("EVENT_REPORT_DOMAIN",s[0]),Wf("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),Wf("STATS_COLLECTOR_PORT",a),e.report?Wf("ENABLE_EVENT_REPORT",!0):Wf("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Qg(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=s[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),Wf("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Qg(e.cds.hostname,"cds.hostname"),l=e.cds.hostname):l=s;let h=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),h=e.cds.port),Wf("CDS_AP",l.map((e=>"".concat(e,":").concat(h)))),e.cds?Wf("ENABLE_CONFIG_DISTRIBUTE",!0):Wf("ENABLE_CONFIG_DISTRIBUTE",!1),Pf.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Qg(e,"serverList"),$g(t,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ef(yf.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>i.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(t):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Wf("WEBCS_DOMAIN",e),Wf("WEBCS_DOMAIN_BACKUP_LIST",e),Wf("GATEWAY_DOMAINS",[t]),Wf("EVENT_REPORT_DOMAIN",e[0]),Wf("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Wf("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),Pf.info("set local access point success")}async setRemoteDefaultVideoStreamType(e){if(Jg(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw Pf.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else Pf.debug("haven't joined yet, cache remoteDefaultVideoStreamType ".concat(e))}async setRemoteVideoStreamType(e,t){Jg(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw Pf.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}Pf.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Jg(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(e){throw Pf.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}Pf.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,i){if(function(e){Jg(e,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(e),$g(t,"secret"),["aes-128-gcm2","aes-256-gcm2"].includes(e)){if(!i||!(i instanceof Uint8Array&&32===i.length))throw new Ef(yf.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new Ef(yf.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(t)||Pf.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=t,i&&(this._encryptionSalt=sw(i))}async renewToken(e){if($g(e,"token",1,2047),!this._key||!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const i=await this._renewTokenMutex.lock();try{if(Kf("USE_NEW_TOKEN")){Pf.debug("start renew token with ticket from unilbs");const t=await sT(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sf);Pf.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:t})}else Pf.debug("start renew token without ticket"),await this._gateway.renewToken({token:e});Pf.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=t,this._joinInfo.token=t,Pf.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?Pf.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.emit(R_.VOLUME_INDICATOR,e)}),Kf("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this._codec)throw new Ef(yf.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Ef(yf.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new Ef(yf.LIVE_STREAMING_TASK_CONFLICT);const i=t?q_.TRANSCODE:q_.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(q_.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new Ef(yf.INVALID_PARAMS,"can not find live streaming url to stop");await yh.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(q_.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,q_.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(q_.INJECT),i=Array.from(mS(e=t.streamingTasks).call(e)).find((e=>e.mode===q_.INJECT));if(!this._joinInfo||!i)throw new Ef(yf.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(e){gT(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){gT(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay()}sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"can not send data stream, not joined");if("string"==typeof e&&(e=(new TextEncoder).encode(e)),new Blob([e]).size>1024)throw new Ef(yf.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(O_.DATA_STREAM,{payload:sw(e)},!t)}sendMetadata(e){if(!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new Ef(yf.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(O_.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:sw(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(d_),!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"can not send custom report, not joined");await TE.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){Jg(t.spatialLayer,"spatialLayer",[0,1,2,3]),Jg(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(e){throw Pf.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}_reset(){if(Pf.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=ff.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy()})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new AE("client-publish"),this._subscribeMutex=new AE("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}}_startSession(e,t){const i=e||Kb();e?Pf.debug("[".concat(this._clientId,"] new Session ").concat(i)):Pf.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i)),this._sessionId=i,this.store.sessionId=i,t?TE.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:t.channel,appid:t.appId,mode:this._mode}):this._joinInfo?TE.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this._mode}):this._gateway.joinInfo&&TE.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this._mode}),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new Ef(yf.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Kf("FORCE_TURN")&&!Kf("TURN_ENABLE_TCP")&&!Kf("TURN_ENABLE_UDP"))throw new Ef(yf.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");Pf.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter),n=(await i.next()).value;if(n){var t;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==yf.DISCONNECT_P2P)throw i.throw(e),e}await i.next((null===(t=r)||void 0===t?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof mC&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===yf.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new Ef(yf.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ef(yf.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));Pf.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await e.next()).value;if(i){var t;let n;try{n=await this._gateway.publish(this._uid,i,!0)}catch(t){if(t.code!==yf.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(t=n)||void 0===t?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===yf.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new Ef(yf.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const t=()=>new mT(this._joinInfo,this._config.websocketRetryConfig||Sf,this._config.httpRetryConfig||Sf),i=e=>{e.onLiveStreamError=(e,t)=>{TE.reportApiInvoke(this._sessionId,{name:f_.ON_LIVE_STREAM_ERROR,options:[e,t],tag:g_.TRACER}).onSuccess(),this.emit(R_.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{TE.reportApiInvoke(this._sessionId,{name:f_.ON_LIVE_STREAM_WARNING,options:[e,t],tag:g_.TRACER}).onSuccess(),this.emit(R_.LIVE_STREAMING_WARNING,e,t)},e.on(ev.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Ef(yf.INVALID_OPERATION,"can not find join info to get worker manager"));nT(e,this._joinInfo,this._axiosCancelSource.token,Sf).then(t).catch(i)}))};switch(e){case q_.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case q_.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case q_.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(ev.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Ef(yf.INVALID_OPERATION,"can not find join info to get worker manager"));nT(e,this._joinInfo,this._axiosCancelSource.token,Sf).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.emit(R_.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){return this._joinInfo?(this._channelMediaRelayClient||(this._channelMediaRelayClient=new vT(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Sf,this._config.httpRetryConfig||Sf),this._channelMediaRelayClient.on("state",(e=>{e===sv.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.emit(R_.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.emit(R_.CHANNEL_MEDIA_RELAY_EVENT,e)}))),this._channelMediaRelayClient):new Ef(yf.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}_handleGatewayEvents(){this._gateway.on(cv.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(cv.CONNECTION_STATE_CHANGE,((e,t,i)=>{var n;if(i===C_.FALLBACK)return;const r=()=>{this.emit(R_.CONNECTION_STATE_CHANGE,e,t,i)};if(TE.reportApiInvoke(this._sessionId||(null===(n=this._gateway.joinInfo)||void 0===n?void 0:n.sid)||null,{name:f_.CONNECTION_STATE_CHANGE,options:[e,t,i],tag:g_.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:i})),Pf.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void r();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._audioSSRC=void 0,e._videoSSRC=void 0,e._videoOrtc=void 0,e._audioOrtc=void 0,e._cname=void 0,e._rtxSsrcId=void 0})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var s;this._streamFallbackTypeCacheMap.forEach(((e,t)=>{this._gateway.setStreamFallbackOption(t,e).catch((e=>{Pf.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,t)=>{this._gateway.setRemoteVideoStreamType(t,e).catch((e=>{Pf.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(s=this._joinInfo)||void 0===s?void 0:s.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{Pf.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{Pf.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{Pf.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,"audio",!1)),e._trust_video_mute_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,"video",!1)),e._trust_audio_enabled_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(Pf.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(Pf.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3)}r()})),this._gateway.on(cv.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new Ef(yf.UNEXPECTED_ERROR,"can not recover, no join info"));Qw(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sf,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip),e(t.gatewayInfo.gatewayAddrs.map((e=>{if(this._joinInfo&&this._joinInfo.proxyServer){const t=e.address.split(":");return"wss://".concat(this._joinInfo.proxyServer,"/ws/?h=").concat(t[0],"&p=").concat(t[1])}return"wss://".concat(e.address)})))})).catch(t)})),this._gateway.on(cv.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.emit(R_.NETWORK_QUALITY,e)})),this._gateway.on(cv.STREAM_TYPE_CHANGE,((e,t)=>{this.emit(R_.STREAM_TYPE_CHANGED,e,t),TE.reportApiInvoke(this._sessionId,{name:f_.STREAM_TYPE_CHANGE,options:[e,t],tag:g_.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(cv.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(cv.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(cv.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(cv.JOIN_RESPONSE,((e,t)=>{const{dtlsParameters:i,iceParameters:n,candidates:r,rtpCapabilities:s,setup:o,cname:a}=kI(e.ortc,t);this._p2pChannel.connect(n,i,r,s,o,a)})),this._gateway.on(cv.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(cv.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(cv.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(cv.DATACHANNEL_PRECONNECT,(async(e,t,i,n)=>{var r,s,o,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:null===(r=this._joinInfo)||void 0===r?void 0:r.turnServer},!0);const l=function(e,t){let i;return t&&t.ip&&"number"==typeof t.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],Pf.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),Pf.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],i}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(s=this._joinInfo)||void 0===s?void 0:s.apResponse.cid,"_").concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(d=Kf("FINGERPRINT"))&&void 0!==d?d:e.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(n)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(D_.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(D_.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(D_.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(D_.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(D_.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(D_.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(D_.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,"audio",!0))),this._gateway.signal.on(D_.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,"audio",!1))),this._gateway.signal.on(D_.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,"video",!0))),this._gateway.signal.on(D_.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,"video",!1))),this._gateway.signal.on(D_.RECEIVE_METADATA,(e=>{const t=rw(e.metadata);this.emit(R_.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(D_.ON_DATA_STREAM,(e=>{e.seq&&delete e.seq,e.payload=rw(e.payload),this.emit(R_.STREAM_MESSAGE,e.uid,e.payload),this.onStreamMessage&&this.onStreamMessage(e)})),this._gateway.signal.on(D_.ON_CRYPT_ERROR,(()=>{nw((()=>{Pf.warning("[".concat(this._clientId,"] on crypt error")),this.emit(R_.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(D_.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(D_.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{Pf.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0),this.emit(R_.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(D_.ON_STREAM_FALLBACK_UPDATE,(e=>{Pf.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.emit(R_.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(D_.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),Pf.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(D_.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(D_.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(P_.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case O_.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var i,n,r,s;const o=e.some((e=>{let{stream_type:t}=e;return t===av.Audio})),a=e.some((e=>{let{stream_type:t}=e;return t!==av.Audio})),c=e.some((e=>{let{stream_type:t}=e;return t===av.Screen||t===av.ScreenLow}));"offer"===t.state&&TE.publish(this._joinInfo.sid,{eventElapse:Sb.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:yf.TIMEOUT,audio:o,video:a,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:o?null===(i=e.find((e=>{let{stream_type:t}=e;return t===av.Audio})))||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:a?null===(r=e.find((e=>{let{stream_type:t}=e;return t!==av.Audio})))||void 0===r||null===(s=r.ssrcs[0])||void 0===s?void 0:s.ssrcId.toString():void 0})}break}case O_.SUBSCRIBE:t&&TE.subscribe(this._joinInfo.sid,{succ:!1,ec:yf.TIMEOUT,audio:t.stream_type===Cv.AUDIO,video:t.stream_type===Cv.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Sb.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(D_.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(D_.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;Kf("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!eg(e.audio_ssrc,this.channelName))));const t=[],i=[];for(const n of e.users){let e=this._users.find((e=>e.uid===n.stream_id));e?e._trust_in_room_=!0:(e=new gC(n.stream_id,n.stream_id),this._users.push(e),0===this.getListeners(R_.PUBLISHED_USER_LIST).length&&(Pf.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.emit(R_.USER_JOINED,e)));const r=dv.Audio&n.stream_type,s=(dv.Video|dv.LwoVideo)&n.stream_type,o=r&&e.hasAudio,a=s&&e.hasVideo;s&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=n.video_ssrc),r&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=n.audio_ssrc),r&&!o&&0===this.getListeners(R_.PUBLISHED_USER_LIST).length&&(Pf.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.emit(R_.USER_PUBLISHED,e,"audio")),s&&!a&&0===this.getListeners(R_.PUBLISHED_USER_LIST).length&&(Pf.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.emit(R_.USER_PUBLISHED,e,"video")),(r&&!o||s&&!a)&&t.push(e),s&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&i.push({user:e,mediaType:"video"}),r&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&i.push({user:e,mediaType:"audio"})}i.length>0&&(Pf.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(i).catch((e=>{Pf.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(R_.PUBLISHED_USER_LIST).length>0?(Pf.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((e=>e.uid)).join(", "))),this.emit(R_.PUBLISHED_USER_LIST,t)):Pf.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((e=>e.uid)).join(", ")))}))}_handleP2PChannelEvents(){this._p2pChannel.on(Av.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yf.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Av.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yf.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Av.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(Av.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===Cv.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(Av.RequestUploadStats,((e,t)=>{this._gateway.uploadStats(e,t)})),this._p2pChannel.on(Av.MediaReconnectStart,(e=>{this.emit(R_.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(Av.MediaReconnectEnd,(e=>{this.emit(R_.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(Av.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(Av.RequestRestartICE,(async()=>{const e=await this._p2pChannel.restartICE(),t=await e.next();if(t.done)return;const i=t.value;let n;try{n=await this._gateway.restartICE({iceParameters:i})}catch(t){return void e.throw(t)}const{iceParameters:r}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(n);await e.next({remoteIceParameters:r})})),this._p2pChannel.on(Av.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Av.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:o,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=kI(r,s);await this._p2pChannel.connect(a,o,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Av.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(Av.P2PLost,(()=>{this.emit(R_.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Av.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(Av.ConnectionTypeChange,(e=>{this.emit(R_.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(Av.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Av.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new Ef(yf.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new Ef(yf.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{if(!["supervise","moderation"].includes(e))throw new Ef(yf.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new Ef(yf.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new $P(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Sf)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new Ef(yf.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}handleVideoInspectEvents(e){e.on(Lv.CONNECTION_STATE_CHANGE,((t,i)=>{switch(this.emit(R_.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i){case kv.CONNECTED:if("CONNECTED"!==this.connectionState)return void this.emit(R_.CONTENT_INSPECT_ERROR,new Ef(yf.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(Lv.INSPECT_RESULT,((e,t)=>{var i;if((null==t?void 0:t.code)===yf.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return Pf.debug("Stop inspect content because that has left channel"),null==this||null===(i=this._inspect)||void 0===i||i.close(),void(this._inspect=void 0);this.emit(R_.CONTENT_INSPECT_RESULT,e,t)})),e.on(Lv.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return Pf.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){zg(e,"enabled"),Wf("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}).prototype,"leave",[QP],Object.getOwnPropertyDescriptor(MO.prototype,"leave"),MO.prototype),Zy(MO.prototype,"publish",[ZP],Object.getOwnPropertyDescriptor(MO.prototype,"publish"),MO.prototype),Zy(MO.prototype,"unpublish",[eO],Object.getOwnPropertyDescriptor(MO.prototype,"unpublish"),MO.prototype),Zy(MO.prototype,"subscribe",[tO],Object.getOwnPropertyDescriptor(MO.prototype,"subscribe"),MO.prototype),Zy(MO.prototype,"massSubscribe",[iO],Object.getOwnPropertyDescriptor(MO.prototype,"massSubscribe"),MO.prototype),Zy(MO.prototype,"unsubscribe",[nO],Object.getOwnPropertyDescriptor(MO.prototype,"unsubscribe"),MO.prototype),Zy(MO.prototype,"massUnsubscribe",[rO],Object.getOwnPropertyDescriptor(MO.prototype,"massUnsubscribe"),MO.prototype),Zy(MO.prototype,"setLowStreamParameter",[sO],Object.getOwnPropertyDescriptor(MO.prototype,"setLowStreamParameter"),MO.prototype),Zy(MO.prototype,"enableDualStream",[oO],Object.getOwnPropertyDescriptor(MO.prototype,"enableDualStream"),MO.prototype),Zy(MO.prototype,"disableDualStream",[aO],Object.getOwnPropertyDescriptor(MO.prototype,"disableDualStream"),MO.prototype),Zy(MO.prototype,"setClientRole",[cO],Object.getOwnPropertyDescriptor(MO.prototype,"setClientRole"),MO.prototype),Zy(MO.prototype,"setProxyServer",[dO],Object.getOwnPropertyDescriptor(MO.prototype,"setProxyServer"),MO.prototype),Zy(MO.prototype,"setTurnServer",[lO],Object.getOwnPropertyDescriptor(MO.prototype,"setTurnServer"),MO.prototype),Zy(MO.prototype,"setLicense",[hO],Object.getOwnPropertyDescriptor(MO.prototype,"setLicense"),MO.prototype),Zy(MO.prototype,"startProxyServer",[uO],Object.getOwnPropertyDescriptor(MO.prototype,"startProxyServer"),MO.prototype),Zy(MO.prototype,"stopProxyServer",[pO],Object.getOwnPropertyDescriptor(MO.prototype,"stopProxyServer"),MO.prototype),Zy(MO.prototype,"setLocalAccessPointsV2",[mO],Object.getOwnPropertyDescriptor(MO.prototype,"setLocalAccessPointsV2"),MO.prototype),Zy(MO.prototype,"setLocalAccessPoints",[fO],Object.getOwnPropertyDescriptor(MO.prototype,"setLocalAccessPoints"),MO.prototype),Zy(MO.prototype,"setRemoteDefaultVideoStreamType",[gO],Object.getOwnPropertyDescriptor(MO.prototype,"setRemoteDefaultVideoStreamType"),MO.prototype),Zy(MO.prototype,"setRemoteVideoStreamType",[_O],Object.getOwnPropertyDescriptor(MO.prototype,"setRemoteVideoStreamType"),MO.prototype),Zy(MO.prototype,"setStreamFallbackOption",[vO],Object.getOwnPropertyDescriptor(MO.prototype,"setStreamFallbackOption"),MO.prototype),Zy(MO.prototype,"setEncryptionConfig",[yO],Object.getOwnPropertyDescriptor(MO.prototype,"setEncryptionConfig"),MO.prototype),Zy(MO.prototype,"renewToken",[EO],Object.getOwnPropertyDescriptor(MO.prototype,"renewToken"),MO.prototype),Zy(MO.prototype,"enableAudioVolumeIndicator",[SO],Object.getOwnPropertyDescriptor(MO.prototype,"enableAudioVolumeIndicator"),MO.prototype),Zy(MO.prototype,"startLiveStreaming",[bO],Object.getOwnPropertyDescriptor(MO.prototype,"startLiveStreaming"),MO.prototype),Zy(MO.prototype,"setLiveTranscoding",[wO],Object.getOwnPropertyDescriptor(MO.prototype,"setLiveTranscoding"),MO.prototype),Zy(MO.prototype,"stopLiveStreaming",[TO],Object.getOwnPropertyDescriptor(MO.prototype,"stopLiveStreaming"),MO.prototype),Zy(MO.prototype,"addInjectStreamUrl",[CO],Object.getOwnPropertyDescriptor(MO.prototype,"addInjectStreamUrl"),MO.prototype),Zy(MO.prototype,"removeInjectStreamUrl",[RO],Object.getOwnPropertyDescriptor(MO.prototype,"removeInjectStreamUrl"),MO.prototype),Zy(MO.prototype,"startChannelMediaRelay",[IO],Object.getOwnPropertyDescriptor(MO.prototype,"startChannelMediaRelay"),MO.prototype),Zy(MO.prototype,"updateChannelMediaRelay",[AO],Object.getOwnPropertyDescriptor(MO.prototype,"updateChannelMediaRelay"),MO.prototype),Zy(MO.prototype,"stopChannelMediaRelay",[PO],Object.getOwnPropertyDescriptor(MO.prototype,"stopChannelMediaRelay"),MO.prototype),Zy(MO.prototype,"sendCustomReportMessage",[OO],Object.getOwnPropertyDescriptor(MO.prototype,"sendCustomReportMessage"),MO.prototype),Zy(MO.prototype,"pickSVCLayer",[NO],Object.getOwnPropertyDescriptor(MO.prototype,"pickSVCLayer"),MO.prototype),Zy(MO.prototype,"enableContentInspect",[DO],Object.getOwnPropertyDescriptor(MO.prototype,"enableContentInspect"),MO.prototype),Zy(MO.prototype,"disableContentInspect",[kO],Object.getOwnPropertyDescriptor(MO.prototype,"disableContentInspect"),MO.prototype),Zy(MO.prototype,"getJoinChannelServiceRecords",[xO],Object.getOwnPropertyDescriptor(MO.prototype,"getJoinChannelServiceRecords"),MO.prototype),Zy(MO.prototype,"setPublishAudioFilterEnabled",[LO],Object.getOwnPropertyDescriptor(MO.prototype,"setPublishAudioFilterEnabled"),MO.prototype),MO);class VO extends HE{set currentState(e){e!==this._currentState&&(this._currentState=e,this.emit(x_.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),fp(this,"audioBuffer",void 0),fp(this,"sourceNode",void 0),fp(this,"startPlayTime",0),fp(this,"startPlayOffset",0),fp(this,"pausePlayTime",0),fp(this,"options",void 0),fp(this,"currentLoopCount",0),fp(this,"_currentState","stopped"),this.audioBuffer=e,this.options=t,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer.duration}get currentTime(){return"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:(this.context.currentTime-this.startPlayTime+this.startPlayOffset)%this.audioBuffer.duration}updateOptions(e){"stopped"===this.currentState?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):Pf.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=e,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(e){}this.reset()}}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const BO=new Map;async function HO(e,t){let i=null;if("string"==typeof e){const t=BO.get(e);if(t)return Pf.debug("use cached audio resource: ",e),t;try{i=(await wf((()=>ff.get(e,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(e){throw new Ef(yf.FETCH_AUDIO_FILE_FAILED,e.toString())}}else{const t=new yh(((t,i)=>{const n=new FileReader;n.onload=e=>{e.target?t(e.target.result):i(new Ef(yf.READ_LOCAL_AUDIO_FILE_ERROR))},n.onerror=()=>{i(new Ef(yf.READ_LOCAL_AUDIO_FILE_ERROR))},n.readAsArrayBuffer(e)}));i=await t}const n=await function(e){const t=ME();return new yh(((i,n)=>{t.decodeAudioData(e,(e=>{i(e)}),(e=>{n(new Ef(yf.DECODE_AUDIO_FILE_FAILED,e.toString()))}))}))}(i);return"string"==typeof e&&t&&BO.set(e,n),n}function WO(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function KO(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?WO(Object(i),!0).forEach((function(t){fp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):WO(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function GO(e,t,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=KO(KO({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),"motion"!==i.optimizationMode&&"detail"!==i.optimizationMode||(t.contentHint=i.optimizationMode,t.contentHint===i.optimizationMode?Pf.debug("[".concat(e,"] set content hint to"),i.optimizationMode):Pf.debug("[".concat(e,"] set content hint failed")))):Pf.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}const qO=Mu().name;function zO(e,t,i,n){let r,s=0,o=null;return new yh(((a,c)=>{setTimeout((()=>{r&&(r(),a(s))}),t),r=VE((()=>{!function(){s>n&&r&&(r(),a(s));const t=i.getContext("2d");if(!t){const e=new Ef(yf.UNEXPECTED_ERROR,"can not get canvas 2d context.");return Pf.error(e.toString()),void c(e)}t.drawImage(e,0,0,160,120);const d=t.getImageData(0,0,i.width,i.height),l=Math.floor(d.data.length/3);if(o){for(let e=0;e<l;e+=3)if(d.data[e]!==o[e])return s+=1,void(o=d.data);o=d.data}else o=d.data}()}),30)}))}class JO{constructor(e,t){fp(this,"id",0),fp(this,"element",void 0),fp(this,"peerPair",void 0),fp(this,"context",void 0),fp(this,"audioPlayerElement",void 0),fp(this,"audioTrack",void 0),JO.count+=1,this.id=JO.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new yh((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new Ef(yf.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(e){throw new Ef(yf.LOCAL_AEC_ERROR,e.toString()).print()}if(!t)throw new Ef(yf.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){Pf.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var YO,XO;fp(JO,"count",0);const $O=window.AudioContext||window.webkitAudioContext,QO=new(YO=wE({report:TE}),Zy((XO=class{constructor(){fp(this,"units",[]),fp(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return Pf.debug("the system does not need to process local aec"),-1;this.context||(this.context=new $O);let t=this.units.find((t=>t&&t.getElement()===e));return t||(t=new JO(e,this.context),this.units.push(t)),t.startEchoCancellation(),Pf.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return Mu().name!==Nu.SAFARI}}).prototype,"processExternalMediaAEC",[YO],Object.getOwnPropertyDescriptor(XO.prototype,"processExternalMediaAEC"),XO.prototype),XO);Wf("PROCESS_ID","process-".concat(Wb(8,""),"-").concat(Wb(4,""),"-").concat(Wb(4,""),"-").concat(Wb(4,""),"-").concat(Wb(12,""))),function(){const e=Mu();jv.getDisplayMedia=function(e){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)}(),jv.getStreamFromExtension=e.name===Nu.CHROME&&Number(e.version)>34,jv.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let t=!1;try{e.addTransceiver("audio"),t=!0}catch(e){}return e.close(),t}(),jv.supportMinBitrate=e.name===Nu.CHROME||e.name===Nu.EDGE,jv.supportSetRtpSenderParameters=function(){const e=Mu();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!sp()||!(!Ku()&&!Vu())||e.name===Nu.FIREFOX&&Number(e.version)>=64)}(),e.name===Nu.SAFARI&&(Number(e.version)>=14?jv.supportDualStream=!0:jv.supportDualStream=!1),jv.webAudioMediaStreamDest=function(){const e=Mu();return!(e.name===Nu.SAFARI&&Number(e.version)<12)}(),jv.supportReplaceTrack=function(){return!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack}(),jv.supportWebGL="undefined"!=typeof WebGLRenderingContext,jv.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,sp()||(jv.webAudioWithAEC=!0),jv.supportShareAudio=function(){const e=Mu();return(e.os===Ou.WIN_10||e.os===Ou.WIN_81||e.os===Ou.WIN_7||e.os===Ou.LINUX||e.os===Ou.MAC_OS)&&e.name===Nu.CHROME&&Number(e.version)>=74}(),jv.supportDualStreamEncoding=function(){const e=Mu();return!!Kf("DISABLE_WEBAUDIO")||("Safari"===e.name&&Number(e.version)>=14||!!("Chrome"===e.name&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&Kf("CHROME_DUAL_STREAM_USE_ENCODING")))}(),jv.supportDataChannel=function(){return!!(zu(76)||function(e){const t=Mu();return!(t.name!==Nu.FIREFOX||!t.osVersion)&&Number(t.version)>=e}(68)||function(e){const t=Mu();return!(t.name!==Nu.SAFARI||!t.osVersion)&&Number(t.version)>=e}(14))}(),jv.supportPCSetConfiguration=!Gu()&&!!RTCPeerConnection.prototype.setConfiguration,Pf.info("browser compatibility",JSON.stringify(jv),JSON.stringify(e))}(),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void Pf.error("Error loading sdk config",e.message)}if(e)try{const t=JSON.parse(window.atob(e)),i=Date.now();Pf.debug("Loading global parameters from cache",t),Object.keys(t).forEach((e=>{if(Object.prototype.hasOwnProperty.call(Gf,e)){const{value:n,expires:r}=t[e];if(r&&r<=i)return;qf[e]=n,Gf[e]=n}}))}catch(t){Pf.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(qf.AREAS)&&qf.AREAS.length>0&&Uw(qf.AREAS,!0);const ZO={__CLIENT_LIST__:Qf,__TRACK_LIST__:Zf,VERSION:Nf,BUILD:Of,setParameter:(e,t,i)=>{Pf.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),Wf(e,t,i)},getParameter:Kf,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const i=(await t.createOffer()).sdp;if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new Ef(yf.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e},checkSystemRequirements:function(){const e=TE.reportApiInvoke(null,{name:f_.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:g_.TRACER});let t=!1;try{const e=window.RTCPeerConnection,i=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,n=window.WebSocket;t=!!(e&&i&&n)}catch(e){return Pf.error("check system requirement failed: ",e),!1}let i=!1;const n=Mu();n.name===Nu.CHROME&&Number(n.version)>=58&&(!Hu()||Bu())&&(i=!0),n.name===Nu.FIREFOX&&Number(n.version)>=56&&(i=!0),n.name===Nu.OPERA&&Number(n.version)>=45&&(i=!0),n.name===Nu.SAFARI&&Number(n.version)>=11&&(i=!0),(np()||Mu().name===Nu.QQ)&&(i=!0),Pf.debug("checkSystemRequirements, api:",t,"browser",i);const r=t&&i;return e.onSuccess(r),r},getDevices:function(e){return nS.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return nS.getRecordingDevices(e)},getCameras:function(e){return nS.getCamerasDevices(e)},getElectronScreenSources:qE,getPlaybackDevices:function(e){return nS.getSpeakers(e)},createClient:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const t=TE.reportApiInvoke(null,{name:f_.CREATE_CLIENT,options:[e],tag:g_.TRACER});try{M_(e)}catch(e){throw t.onError(e),e}return void 0===e.audioCodec&&(e.audioCodec="opus"),t.onSuccess(),new jO(UO(UO({forceWaitGatewayResponse:!0},e),{},{role:"rtc"===e.mode?"host":e.role}))},createCameraVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_CAM_VIDEO_TRACK,options:[KO({},e)]}),i=RT(e),n=Wb(8,"track-cam-");let r=null;Pf.info("start create camera video track with config",JSON.stringify(e),"trackId",n);try{r=(await ZE({video:i},n)).getVideoTracks()[0]||null}catch(e){throw t.onError(e),e}if(!r){const e=new Ef(yf.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(e),e.throw()}e.optimizationMode&&GO(n,r,e,Uf(e.encoderConfig));const s=new fC(r,e,i,e.scalabiltyMode?Vf(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n);return t.onSuccess(s.getTrackId()),Pf.info("create camera video success, trackId:",n),s},createCustomVideoTrack:function(e){const t=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_CUSTOM_VIDEO_TRACK,options:[e]}),i=new mC(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Vf(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,Wb(8,"track-cus-"),[uv.CUSTOM_TRACK]);return t.onSuccess(i.getTrackId()),Pf.info("create custom video track success with config",e,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const i=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_SCREEN_VIDEO_TRACK,options:[KO({},e),t]});e.encoderConfig?"string"==typeof e.encoderConfig||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const n=IT(e),r=Wb(8,"track-scr-v-");let s=null,o=null;const a=Vv();if(!a.supportShareAudio&&"enable"===t){const e=new Ef(yf.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(e),e.throw()}Pf.info("start create screen video track with config",e,"withAudio",t,"trackId",r);try{const e=await ZE({screen:n,screenAudio:"auto"===t?a.supportShareAudio:"enable"===t},r);s=e.getVideoTracks()[0]||null,o=e.getAudioTracks()[0]||null}catch(e){throw i.onError(e),e}if(!s){const e=new Ef(yf.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(e),e.throw()}if(!o&&"enable"===t){s&&s.stop();const e=new Ef(yf.SHARE_AUDIO_NOT_ALLOWED);return i.onError(e),e.throw()}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(GO(r,s,e,e.encoderConfig&&jf(e.encoderConfig)),e.encoderConfig&&"string"!=typeof e.encoderConfig&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const c=new mC(s,e.encoderConfig?jf(e.encoderConfig):{},e.scalabiltyMode?Vf(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r,[uv.SCREEN_TRACK]);if(!o)return i.onSuccess(c.getTrackId()),Pf.info("create screen video track success","video:",c.getTrackId()),c;const d=new fb(o,void 0,Wb(8,"track-scr-a-"),!1,!0);return i.onSuccess([c.getTrackId(),d.getTrackId()]),Pf.info("create screen video track success","video:",c.getTrackId(),"audio:",d.getTrackId()),[c,d]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_MIC_AND_CAM_TRACKS,options:[e,t]}),n=RT(t),r=AT(e),s=Wb(8,"track-mic-"),o=Wb(8,"track-cam-");let a=null,c=null;Pf.info("start create camera video track(".concat(o,") and microphone audio track(").concat(s,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const e=await ZE({audio:r,video:n},"".concat(s,"-").concat(o));a=e.getAudioTracks()[0],c=e.getVideoTracks()[0]}catch(e){throw i.onError(e),e}if(!a||!c){const e=new Ef(yf.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(e),e.throw()}t.optimizationMode&&GO(o,c,t,Uf(t.encoderConfig));const d=new gb(a,e,r,s),l=new fC(c,t,n,t.scalabiltyMode?Vf(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,o);return i.onSuccess([d.getTrackId(),l.getTrackId()]),Pf.info("create camera video track(".concat(o,") and microphone audio track(").concat(s,") success")),[d,l]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_MIC_AUDIO_TRACK,options:[e]}),i=AT(e),n=Wb(8,"track-mic-");let r=null;Pf.info("start create microphone audio track with config",JSON.stringify(e),"trackId",n);try{r=(await ZE({audio:i},n)).getAudioTracks()[0]||null}catch(e){throw t.onError(e),e}if(!r){const e=new Ef(yf.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(e),e.throw()}const s=new gb(r,e,i,n);return t.onSuccess(s.getTrackId()),Pf.info("create microphone audio track success, trackId:",n),s},createCustomAudioTrack:function(e){const t=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),i=new fb(e.mediaStreamTrack,e.encoderConfig?Hf(e.encoderConfig):{},Wb(8,"track-cus-"),!1,!0);return Pf.info("create custom audio track success with config",e,"trackId",i.getTrackId()),t.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(e){const t=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CREATE_BUFFER_AUDIO_TRACK,options:[e]});if(Kf("DISABLE_WEBAUDIO"))throw new Ef(yf.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const i=Wb(8,"track-buf-");Pf.info("start create buffer source audio track with config",JSON.stringify(e),"trackId",i);const n=e.source;if(!(e.source instanceof AudioBuffer))try{e.source=await HO(e.source,e.cacheOnlineFile)}catch(e){return t.onError(e),e.throw()}const r=new VO(e.source),s=new _b(n,r,e.encoderConfig?Hf(e.encoderConfig):{},i);return Pf.info("create buffer source audio track success, trackId:",i),t.onSuccess(s.getTrackId()),s},setAppType:function(e){if(Pf.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw Pf.debug("Invalid appType"),new Ef(yf.INVALID_PARAMS,"invalid app type",e);Wf("APP_TYPE",Math.floor(e))},setLogLevel:function(e){Pf.setLogLevel(e)},enableLogUpload:function(){Kf("USE_NEW_LOG")?Wf("UPLOAD_LOG",!0):Pf.enableLogUpload()},disableLogUpload:function(){Kf("USE_NEW_LOG")?Wf("UPLOAD_LOG",!1):Pf.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new fT},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof fb||e instanceof HA)){const e=new Ef(yf.INVALID_TRACK,"the parameter is not a audio track");return i.onError(e),e.throw()}t&&t<1e3&&(t=1e3);const n=e instanceof fb?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let s=r,o=r;const a=Date.now();return new yh((r=>{const c=setInterval((()=>{const d=e.getVolumeLevel();s=d>s?d:s,o=d<o?d:o;const l=s-o>1e-4,h=Date.now()-a;if(l||h>t){clearInterval(c);const t=l,o={duration:h,deviceLabel:n,maxVolumeLevel:s,result:t};Pf.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(o))),i.onSuccess(o),r(t)}}),200)}))},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=TE.reportApiInvoke(null,{tag:g_.TRACER,name:f_.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof mC||e instanceof BA)){const e=new Ef(yf.INVALID_TRACK,"the parameter is not a video track");return i.onError(e),e.throw()}const n=4;t&&t<1e3&&(t=1e3);const r=e instanceof mC?e.getTrackLabel():"remote_track",s=e.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Ku()||Vu())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([s]),o.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{const e=Date.now();c=await zO(o,t,a,n),d=Date.now()-e}catch(e){throw i.onError(e),e}qO===Nu.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const l=c>n,h={duration:d,changedPicNum:c,deviceLabel:r,result:l};return Pf.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(h))),i.onSuccess(h),l},setArea:Uw,audioElementPlayCenter:sS,processExternalMediaAEC:function(e){QO.processExternalMediaAEC(e)},registerExtensions:function(e){e.forEach((e=>{const t=e;t.__registered__=!0,t.logger.hookLog=Pf.extLog,t.reporter.hookApiInvoke=TE.extApiInvoke,t.parameters&&Object.keys(t.parameters).forEach((e=>{t.parameters[e]=Kf(e)}))}))},ChannelMediaRelayError:ov,ChannelMediaRelayEvent:rv,ChannelMediaRelayState:sv,RemoteStreamFallbackType:mv,RemoteStreamType:pv,ConnectionDisconnectedReason:C_,AudienceLatencyLevelType:T_,AREAS:_v},eN=window||document;return Object.defineProperties(ZO,{onAudioAutoplayFailed:{get:()=>gE.onAudioAutoplayFailed,set:e=>{gE.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>gE.onAutoplayFailed,set:e=>{gE.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>ZO._onSecurityPolicyViolation,set(e){if(ZO._onSecurityPolicyViolation=e,!eN)return;const t=e=>{if(!(e&&e.blockedURI&&ZO.onSecurityPolicyViolation))return;const t=e.blockedURI;Kf("CSP_DETECTED_HOSTNAME_LIST").some((e=>t.includes(e)))&&ZO.onSecurityPolicyViolation&&"function"==typeof ZO.onSecurityPolicyViolation&&ZO.onSecurityPolicyViolation(e)},i=ZO._cspEventHandlerPointer;i&&eN.removeEventListener("securitypolicyviolation",i),e&&"function"==typeof e&&eN.addEventListener("securitypolicyviolation",t),ZO._cspEventHandlerPointer=t}}}),nS.on(v_.CAMERA_DEVICE_CHANGED,(e=>{Pf.info("camera device changed",JSON.stringify(e)),ZO.onCameraChanged&&ZO.onCameraChanged(e)})),nS.on(v_.RECORDING_DEVICE_CHANGED,(e=>{Pf.info("microphone device changed",JSON.stringify(e)),ZO.onMicrophoneChanged&&ZO.onMicrophoneChanged(e)})),nS.on(v_.PLAYOUT_DEVICE_CHANGED,(e=>{Pf.debug("playout device changed",JSON.stringify(e)),ZO.onPlaybackDeviceChanged&&ZO.onPlaybackDeviceChanged(e)})),sS.onAutoplayFailed=()=>{Pf.info("detect audio element autoplay failed"),gE.onAudioAutoplayFailed&&gE.onAudioAutoplayFailed()},xE.on("autoplay-failed",(()=>{Pf.info("detect webaudio autoplay failed"),gE.onAudioAutoplayFailed&&gE.onAudioAutoplayFailed()})),window&&(window.__ARTC__=ZO),ZO}))},8578:function(e,t,i){"use strict";i.d(t,{fT:function(){return Wn},EI:function(){return zn},e7:function(){return Mn},ZX:function(){return Fn},X6:function(){return Un},ns:function(){return jn},f0:function(){return Jn},DQ:function(){return Hn},MB:function(){return Kn},RI:function(){return Gn}});i(7658);var n=i(7130),r=i(223),s=i(7077),o=i(5168);function a(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(i[n[r]]=e[n[r]])}return i}Object.create;Object.create;var c=i(7142);function d(){return{["dependent-sdk-initialized-before-auth"]:"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}const l=d,h=new r.LL("auth","Firebase",d()),u=new o.Yd("@firebase/auth");function p(e,...t){u.logLevel<=o["in"].ERROR&&u.error(`Auth (${s.Jn}): ${e}`,...t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function m(e,...t){throw v(e,...t)}function f(e,...t){return v(e,...t)}function g(e,t,i){const n=Object.assign(Object.assign({},l()),{[t]:i}),s=new r.LL("auth","Firebase",n);return s.create(t,{appName:e.name})}function _(e,t,i){const n=i;if(!(t instanceof n))throw n.name!==t.constructor.name&&m(e,"argument-error"),g(e,"argument-error",`Type of ${t.constructor.name} does not match expected instance.Did you pass a reference from a different Auth SDK?`)}function v(e,...t){if("string"!==typeof e){const i=t[0],n=[...t.slice(1)];return n[0]&&(n[0].appName=e.name),e._errorFactory.create(i,...n)}return h.create(e,...t)}function y(e,t,...i){if(!e)throw v(t,...i)}function E(e){const t="INTERNAL ASSERTION FAILED: "+e;throw p(t),new Error(t)}function S(e,t){e||E(t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const b=new Map;function w(e){S(e instanceof Function,"Expected a class definition");let t=b.get(e);return t?(S(t instanceof e,"Instance stored in cache mismatched with class"),t):(t=new e,b.set(e,t),t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function T(e,t){const i=(0,s.qX)(e,"auth");if(i.isInitialized()){const e=i.getImmediate(),n=i.getOptions();if((0,r.vZ)(n,null!==t&&void 0!==t?t:{}))return e;m(e,"already-initialized")}const n=i.initialize({options:t});return n}function C(e,t){const i=(null===t||void 0===t?void 0:t.persistence)||[],n=(Array.isArray(i)?i:[i]).map(w);(null===t||void 0===t?void 0:t.errorMap)&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(n,null===t||void 0===t?void 0:t.popupRedirectResolver)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function R(){var e;return"undefined"!==typeof self&&(null===(e=self.location)||void 0===e?void 0:e.href)||""}function I(){return"http:"===A()||"https:"===A()}function A(){var e;return"undefined"!==typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function P(){return!("undefined"!==typeof navigator&&navigator&&"onLine"in navigator&&"boolean"===typeof navigator.onLine&&(I()||(0,r.ru)()||"connection"in navigator))||navigator.onLine}function O(){if("undefined"===typeof navigator)return null;const e=navigator;return e.languages&&e.languages[0]||e.language||null}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class N{constructor(e,t){this.shortDelay=e,this.longDelay=t,S(t>e,"Short delay should be less than long delay!"),this.isMobile=(0,r.uI)()||(0,r.b$)()}get(){return P()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function D(e,t){S(e.emulator,"Emulator should always be set here");const{url:i}=e.emulator;return t?`${i}${t.startsWith("/")?t.slice(1):t}`:i}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class k{static initialize(e,t,i){this.fetchImpl=e,t&&(this.headersImpl=t),i&&(this.responseImpl=i)}static fetch(){return this.fetchImpl?this.fetchImpl:"undefined"!==typeof self&&"fetch"in self?self.fetch:void E("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){return this.headersImpl?this.headersImpl:"undefined"!==typeof self&&"Headers"in self?self.Headers:void E("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){return this.responseImpl?this.responseImpl:"undefined"!==typeof self&&"Response"in self?self.Response:void E("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const x={["CREDENTIAL_MISMATCH"]:"custom-token-mismatch",["MISSING_CUSTOM_TOKEN"]:"internal-error",["INVALID_IDENTIFIER"]:"invalid-email",["MISSING_CONTINUE_URI"]:"internal-error",["INVALID_PASSWORD"]:"wrong-password",["MISSING_PASSWORD"]:"missing-password",["EMAIL_EXISTS"]:"email-already-in-use",["PASSWORD_LOGIN_DISABLED"]:"operation-not-allowed",["INVALID_IDP_RESPONSE"]:"invalid-credential",["INVALID_PENDING_TOKEN"]:"invalid-credential",["FEDERATED_USER_ID_ALREADY_LINKED"]:"credential-already-in-use",["MISSING_REQ_TYPE"]:"internal-error",["EMAIL_NOT_FOUND"]:"user-not-found",["RESET_PASSWORD_EXCEED_LIMIT"]:"too-many-requests",["EXPIRED_OOB_CODE"]:"expired-action-code",["INVALID_OOB_CODE"]:"invalid-action-code",["MISSING_OOB_CODE"]:"internal-error",["CREDENTIAL_TOO_OLD_LOGIN_AGAIN"]:"requires-recent-login",["INVALID_ID_TOKEN"]:"invalid-user-token",["TOKEN_EXPIRED"]:"user-token-expired",["USER_NOT_FOUND"]:"user-token-expired",["TOO_MANY_ATTEMPTS_TRY_LATER"]:"too-many-requests",["INVALID_CODE"]:"invalid-verification-code",["INVALID_SESSION_INFO"]:"invalid-verification-id",["INVALID_TEMPORARY_PROOF"]:"invalid-credential",["MISSING_SESSION_INFO"]:"missing-verification-id",["SESSION_EXPIRED"]:"code-expired",["MISSING_ANDROID_PACKAGE_NAME"]:"missing-android-pkg-name",["UNAUTHORIZED_DOMAIN"]:"unauthorized-continue-uri",["INVALID_OAUTH_CLIENT_ID"]:"invalid-oauth-client-id",["ADMIN_ONLY_OPERATION"]:"admin-restricted-operation",["INVALID_MFA_PENDING_CREDENTIAL"]:"invalid-multi-factor-session",["MFA_ENROLLMENT_NOT_FOUND"]:"multi-factor-info-not-found",["MISSING_MFA_ENROLLMENT_ID"]:"missing-multi-factor-info",["MISSING_MFA_PENDING_CREDENTIAL"]:"missing-multi-factor-session",["SECOND_FACTOR_EXISTS"]:"second-factor-already-in-use",["SECOND_FACTOR_LIMIT_EXCEEDED"]:"maximum-second-factor-count-exceeded",["BLOCKING_FUNCTION_ERROR_RESPONSE"]:"internal-error"},L=new N(3e4,6e4);
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function M(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function F(e,t,i,n,s={}){return U(e,s,(async()=>{let s={},o={};n&&("GET"===t?o=n:s={body:JSON.stringify(n)});const a=(0,r.xO)(Object.assign({key:e.config.apiKey},o)).slice(1),c=await e._getAdditionalHeaders();return c["Content-Type"]="application/json",e.languageCode&&(c["X-Firebase-Locale"]=e.languageCode),k.fetch()(V(e,e.config.apiHost,i,a),Object.assign({method:t,headers:c,referrerPolicy:"no-referrer"},s))}))}async function U(e,t,i){e._canInitEmulator=!1;const n=Object.assign(Object.assign({},x),t);try{const t=new B(e),r=await Promise.race([i(),t.promise]);t.clearNetworkTimeout();const s=await r.json();if("needConfirmation"in s)throw H(e,"account-exists-with-different-credential",s);if(r.ok&&!("errorMessage"in s))return s;{const t=r.ok?s.errorMessage:s.error.message,[i,o]=t.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===i)throw H(e,"credential-already-in-use",s);if("EMAIL_EXISTS"===i)throw H(e,"email-already-in-use",s);if("USER_DISABLED"===i)throw H(e,"user-disabled",s);const a=n[i]||i.toLowerCase().replace(/[_\s]+/g,"-");if(o)throw g(e,a,o);m(e,a)}}catch(s){if(s instanceof r.ZR)throw s;m(e,"network-request-failed",{message:String(s)})}}async function j(e,t,i,n,r={}){const s=await F(e,t,i,n,r);return"mfaPendingCredential"in s&&m(e,"multi-factor-auth-required",{_serverResponse:s}),s}function V(e,t,i,n){const r=`${t}${i}?${n}`;return e.config.emulator?D(e.config,r):`${e.config.apiScheme}://${r}`}class B{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise(((e,t)=>{this.timer=setTimeout((()=>t(f(this.auth,"network-request-failed"))),L.get())}))}clearNetworkTimeout(){clearTimeout(this.timer)}}function H(e,t,i){const n={appName:e.name};i.email&&(n.email=i.email),i.phoneNumber&&(n.phoneNumber=i.phoneNumber);const r=f(e,t,n);return r.customData._tokenResponse=i,r}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function W(e,t){return F(e,"POST","/v1/accounts:delete",t)}async function K(e,t){return F(e,"POST","/v1/accounts:lookup",t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function G(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(t){}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function q(e,t=!1){const i=(0,r.m9)(e),n=await i.getIdToken(t),s=J(n);y(s&&s.exp&&s.auth_time&&s.iat,i.auth,"internal-error");const o="object"===typeof s.firebase?s.firebase:void 0,a=null===o||void 0===o?void 0:o["sign_in_provider"];return{claims:s,token:n,authTime:G(z(s.auth_time)),issuedAtTime:G(z(s.iat)),expirationTime:G(z(s.exp)),signInProvider:a||null,signInSecondFactor:(null===o||void 0===o?void 0:o["sign_in_second_factor"])||null}}function z(e){return 1e3*Number(e)}function J(e){const[t,i,n]=e.split(".");if(void 0===t||void 0===i||void 0===n)return p("JWT malformed, contained fewer than 3 sections"),null;try{const e=(0,r.tV)(i);return e?JSON.parse(e):(p("Failed to decode base64 JWT payload"),null)}catch(s){return p("Caught error parsing JWT payload as JSON",null===s||void 0===s?void 0:s.toString()),null}}function Y(e){const t=J(e);return y(t,"internal-error"),y("undefined"!==typeof t.exp,"internal-error"),y("undefined"!==typeof t.iat,"internal-error"),Number(t.exp)-Number(t.iat)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function X(e,t,i=!1){if(i)return t;try{return await t}catch(n){throw n instanceof r.ZR&&$(n)&&e.auth.currentUser===e&&await e.auth.signOut(),n}}function $({code:e}){return"auth/user-disabled"===e||"auth/user-token-expired"===e}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Q{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){var t;if(e){const e=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),e}{this.errorBackoff=3e4;const e=null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0,i=e-Date.now()-3e5;return Math.max(0,i)}}schedule(e=!1){if(!this.isRunning)return;const t=this.getInterval(e);this.timerId=setTimeout((async()=>{await this.iteration()}),t)}async iteration(){try{await this.user.getIdToken(!0)}catch(e){return void("auth/network-request-failed"===(null===e||void 0===e?void 0:e.code)&&this.schedule(!0))}this.schedule()}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Z{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=G(this.lastLoginAt),this.creationTime=G(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ee(e){var t;const i=e.auth,n=await e.getIdToken(),r=await X(e,K(i,{idToken:n}));y(null===r||void 0===r?void 0:r.users.length,i,"internal-error");const s=r.users[0];e._notifyReloadListener(s);const o=(null===(t=s.providerUserInfo)||void 0===t?void 0:t.length)?ne(s.providerUserInfo):[],a=ie(e.providerData,o),c=e.isAnonymous,d=!(e.email&&s.passwordHash)&&!(null===a||void 0===a?void 0:a.length),l=!!c&&d,h={uid:s.localId,displayName:s.displayName||null,photoURL:s.photoUrl||null,email:s.email||null,emailVerified:s.emailVerified||!1,phoneNumber:s.phoneNumber||null,tenantId:s.tenantId||null,providerData:a,metadata:new Z(s.createdAt,s.lastLoginAt),isAnonymous:l};Object.assign(e,h)}async function te(e){const t=(0,r.m9)(e);await ee(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}function ie(e,t){const i=e.filter((e=>!t.some((t=>t.providerId===e.providerId))));return[...i,...t]}function ne(e){return e.map((e=>{var{providerId:t}=e,i=a(e,["providerId"]);return{providerId:t,uid:i.rawId||"",displayName:i.displayName||null,email:i.email||null,phoneNumber:i.phoneNumber||null,photoURL:i.photoUrl||null}}))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function re(e,t){const i=await U(e,{},(async()=>{const i=(0,r.xO)({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:n,apiKey:s}=e.config,o=V(e,n,"/v1/token",`key=${s}`),a=await e._getAdditionalHeaders();return a["Content-Type"]="application/x-www-form-urlencoded",k.fetch()(o,{method:"POST",headers:a,body:i})}));return{accessToken:i.access_token,expiresIn:i.expires_in,refreshToken:i.refresh_token}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class se{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){y(e.idToken,"internal-error"),y("undefined"!==typeof e.idToken,"internal-error"),y("undefined"!==typeof e.refreshToken,"internal-error");const t="expiresIn"in e&&"undefined"!==typeof e.expiresIn?Number(e.expiresIn):Y(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,t)}async getToken(e,t=!1){return y(!this.accessToken||this.refreshToken,e,"user-token-expired"),t||!this.accessToken||this.isExpired?this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null:this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){const{accessToken:i,refreshToken:n,expiresIn:r}=await re(e,t);this.updateTokensAndExpiration(i,n,Number(r))}updateTokensAndExpiration(e,t,i){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*i}static fromJSON(e,t){const{refreshToken:i,accessToken:n,expirationTime:r}=t,s=new se;return i&&(y("string"===typeof i,"internal-error",{appName:e}),s.refreshToken=i),n&&(y("string"===typeof n,"internal-error",{appName:e}),s.accessToken=n),r&&(y("number"===typeof r,"internal-error",{appName:e}),s.expirationTime=r),s}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new se,this.toJSON())}_performRefresh(){return E("not implemented")}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oe(e,t){y("string"===typeof e||"undefined"===typeof e,"internal-error",{appName:t})}class ae{constructor(e){var{uid:t,auth:i,stsTokenManager:n}=e,r=a(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new Q(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=i,this.stsTokenManager=n,this.accessToken=n.accessToken,this.displayName=r.displayName||null,this.email=r.email||null,this.emailVerified=r.emailVerified||!1,this.phoneNumber=r.phoneNumber||null,this.photoURL=r.photoURL||null,this.isAnonymous=r.isAnonymous||!1,this.tenantId=r.tenantId||null,this.providerData=r.providerData?[...r.providerData]:[],this.metadata=new Z(r.createdAt||void 0,r.lastLoginAt||void 0)}async getIdToken(e){const t=await X(this,this.stsTokenManager.getToken(this.auth,e));return y(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return q(this,e)}reload(){return te(this)}_assign(e){this!==e&&(y(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map((e=>Object.assign({},e))),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new ae(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){y(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,t=!1){let i=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),i=!0),t&&await ee(this),await this.auth._persistUserIfCurrent(this),i&&this.auth._notifyListenersIfCurrent(this)}async delete(){const e=await this.getIdToken();return await X(this,W(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map((e=>Object.assign({},e))),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var i,n,r,s,o,a,c,d;const l=null!==(i=t.displayName)&&void 0!==i?i:void 0,h=null!==(n=t.email)&&void 0!==n?n:void 0,u=null!==(r=t.phoneNumber)&&void 0!==r?r:void 0,p=null!==(s=t.photoURL)&&void 0!==s?s:void 0,m=null!==(o=t.tenantId)&&void 0!==o?o:void 0,f=null!==(a=t._redirectEventId)&&void 0!==a?a:void 0,g=null!==(c=t.createdAt)&&void 0!==c?c:void 0,_=null!==(d=t.lastLoginAt)&&void 0!==d?d:void 0,{uid:v,emailVerified:E,isAnonymous:S,providerData:b,stsTokenManager:w}=t;y(v&&w,e,"internal-error");const T=se.fromJSON(this.name,w);y("string"===typeof v,e,"internal-error"),oe(l,e.name),oe(h,e.name),y("boolean"===typeof E,e,"internal-error"),y("boolean"===typeof S,e,"internal-error"),oe(u,e.name),oe(p,e.name),oe(m,e.name),oe(f,e.name),oe(g,e.name),oe(_,e.name);const C=new ae({uid:v,auth:e,email:h,emailVerified:E,displayName:l,isAnonymous:S,photoURL:p,phoneNumber:u,tenantId:m,stsTokenManager:T,createdAt:g,lastLoginAt:_});return b&&Array.isArray(b)&&(C.providerData=b.map((e=>Object.assign({},e)))),f&&(C._redirectEventId=f),C}static async _fromIdTokenResponse(e,t,i=!1){const n=new se;n.updateFromServerResponse(t);const r=new ae({uid:t.localId,auth:e,stsTokenManager:n,isAnonymous:i});return await ee(r),r}}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ce{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){const t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}ce.type="NONE";const de=ce;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function le(e,t,i){return`firebase:${e}:${t}:${i}`}class he{constructor(e,t,i){this.persistence=e,this.auth=t,this.userKey=i;const{config:n,name:r}=this.auth;this.fullUserKey=le(this.userKey,n.apiKey,r),this.fullPersistenceKey=le("persistence",n.apiKey,r),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?ae._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t,i="authUser"){if(!t.length)return new he(w(de),e,i);const n=(await Promise.all(t.map((async e=>{if(await e._isAvailable())return e})))).filter((e=>e));let r=n[0]||w(de);const s=le(i,e.config.apiKey,e.name);let o=null;for(const d of t)try{const t=await d._get(s);if(t){const i=ae._fromJSON(e,t);d!==r&&(o=i),r=d;break}}catch(c){}const a=n.filter((e=>e._shouldAllowMigration));return r._shouldAllowMigration&&a.length?(r=a[0],o&&await r._set(s,o.toJSON()),await Promise.all(t.map((async e=>{if(e!==r)try{await e._remove(s)}catch(c){}}))),new he(r,e,i)):new he(r,e,i)}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ue(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(ge(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(pe(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(ve(t))return"Blackberry";if(ye(t))return"Webos";if(me(t))return"Safari";if((t.includes("chrome/")||fe(t))&&!t.includes("edge/"))return"Chrome";if(_e(t))return"Android";{const t=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,i=e.match(t);if(2===(null===i||void 0===i?void 0:i.length))return i[1]}return"Other"}function pe(e=(0,r.z$)()){return/firefox\//i.test(e)}function me(e=(0,r.z$)()){const t=e.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function fe(e=(0,r.z$)()){return/crios\//i.test(e)}function ge(e=(0,r.z$)()){return/iemobile/i.test(e)}function _e(e=(0,r.z$)()){return/android/i.test(e)}function ve(e=(0,r.z$)()){return/blackberry/i.test(e)}function ye(e=(0,r.z$)()){return/webos/i.test(e)}function Ee(e=(0,r.z$)()){return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function Se(e=(0,r.z$)()){var t;return Ee(e)&&!!(null===(t=window.navigator)||void 0===t?void 0:t.standalone)}function be(){return(0,r.w1)()&&10===document.documentMode}function we(e=(0,r.z$)()){return Ee(e)||_e(e)||ye(e)||ve(e)||/windows phone/i.test(e)||ge(e)}function Te(){try{return!(!window||window===window.top)}catch(e){return!1}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ce(e,t=[]){let i;switch(e){case"Browser":i=ue((0,r.z$)());break;case"Worker":i=`${ue((0,r.z$)())}-${e}`;break;default:i=e}const n=t.length?t.join(","):"FirebaseCore-web";return`${i}/JsCore/${s.Jn}/${n}`}
/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Re{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,t){const i=t=>new Promise(((i,n)=>{try{const n=e(t);i(n)}catch(r){n(r)}}));i.onAbort=t,this.queue.push(i);const n=this.queue.length-1;return()=>{this.queue[n]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const t=[];try{for(const i of this.queue)await i(e),i.onAbort&&t.push(i.onAbort)}catch(i){t.reverse();for(const e of t)try{e()}catch(n){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null===i||void 0===i?void 0:i.message})}}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ie{constructor(e,t,i){this.app=e,this.heartbeatServiceProvider=t,this.config=i,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new Pe(this),this.idTokenSubscription=new Pe(this),this.beforeStateQueue=new Re(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=h,this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=i.sdkClientVersion}_initializeWithPersistence(e,t){return t&&(this._popupRedirectResolver=w(t)),this._initializationPromise=this.queue((async()=>{var i,n;if(!this._deleted&&(this.persistenceManager=await he.create(this,e),!this._deleted)){if(null===(i=this._popupRedirectResolver)||void 0===i?void 0:i._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(r){}await this.initializeCurrentUser(t),this.lastNotifiedUid=(null===(n=this.currentUser)||void 0===n?void 0:n.uid)||null,this._deleted||(this._isInitialized=!0)}})),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();return this.currentUser||e?this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0):void 0}async initializeCurrentUser(e){var t;const i=await this.assertedPersistence.getCurrentUser();let n=i,r=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const i=null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId,s=null===n||void 0===n?void 0:n._redirectEventId,o=await this.tryRedirectSignIn(e);i&&i!==s||!(null===o||void 0===o?void 0:o.user)||(n=o.user,r=!0)}if(!n)return this.directlySetCurrentUser(null);if(!n._redirectEventId){if(r)try{await this.beforeStateQueue.runMiddleware(n)}catch(s){n=i,this._popupRedirectResolver._overrideRedirectResult(this,(()=>Promise.reject(s)))}return n?this.reloadAndSetCurrentUserOrClear(n):this.directlySetCurrentUser(null)}return y(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===n._redirectEventId?this.directlySetCurrentUser(n):this.reloadAndSetCurrentUserOrClear(n)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(i){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await ee(e)}catch(t){if("auth/network-request-failed"!==(null===t||void 0===t?void 0:t.code))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=O()}async _delete(){this._deleted=!0}async updateCurrentUser(e){const t=e?(0,r.m9)(e):null;return t&&y(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e,t=!1){if(!this._deleted)return e&&y(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue((async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()}))}async signOut(){return await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0)}setPersistence(e){return this.queue((async()=>{await this.assertedPersistence.setPersistence(w(e))}))}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new r.LL("auth","Firebase",e())}onAuthStateChanged(e,t,i){return this.registerStateListener(this.authStateSubscription,e,t,i)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,i){return this.registerStateListener(this.idTokenSubscription,e,t,i)}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const i=await this.getOrInitRedirectPersistenceManager(t);return null===e?i.removeCurrentUser():i.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const t=e&&w(e)||this._popupRedirectResolver;y(t,this,"argument-error"),this.redirectPersistenceManager=await he.create(this,[w(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var t,i;return this._isInitialized&&await this.queue((async()=>{})),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(i=this.redirectUser)||void 0===i?void 0:i._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue((async()=>this.directlySetCurrentUser(e)))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,t;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const i=null!==(t=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==t?t:null;this.lastNotifiedUid!==i&&(this.lastNotifiedUid=i,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,t,i,n){if(this._deleted)return()=>{};const r="function"===typeof t?t:t.next.bind(t),s=this._isInitialized?Promise.resolve():this._initializationPromise;return y(s,this,"internal-error"),s.then((()=>r(this.currentUser))),"function"===typeof t?e.addObserver(t,i,n):e.addObserver(t)}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return y(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=Ce(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const t={["X-Client-Version"]:this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);const i=await(null===(e=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getHeartbeatsHeader());return i&&(t["X-Firebase-Client"]=i),t}}function Ae(e){return(0,r.m9)(e)}class Pe{constructor(e){this.auth=e,this.observer=null,this.addObserver=(0,r.ne)((e=>this.observer=e))}get next(){return y(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}function Oe(e,t,i){const n=Ae(e);y(n._canInitEmulator,n,"emulator-config-failed"),y(/^https?:\/\//.test(t),n,"invalid-emulator-scheme");const r=!!(null===i||void 0===i?void 0:i.disableWarnings),s=Ne(t),{host:o,port:a}=De(t),c=null===a?"":`:${a}`;n.config.emulator={url:`${s}//${o}${c}/`},n.settings.appVerificationDisabledForTesting=!0,n.emulatorConfig=Object.freeze({host:o,port:a,protocol:s.replace(":",""),options:Object.freeze({disableWarnings:r})}),r||xe()}function Ne(e){const t=e.indexOf(":");return t<0?"":e.substr(0,t+1)}function De(e){const t=Ne(e),i=/(\/\/)?([^?#/]+)/.exec(e.substr(t.length));if(!i)return{host:"",port:null};const n=i[2].split("@").pop()||"",r=/^(\[[^\]]+\])(:|$)/.exec(n);if(r){const e=r[1];return{host:e,port:ke(n.substr(e.length+1))}}{const[e,t]=n.split(":");return{host:e,port:ke(t)}}}function ke(e){if(!e)return null;const t=Number(e);return isNaN(t)?null:t}function xe(){function e(){const e=document.createElement("p"),t=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",t.position="fixed",t.width="100%",t.backgroundColor="#ffffff",t.border=".1em solid #000000",t.color="#b50000",t.bottom="0px",t.left="0px",t.margin="0px",t.zIndex="10000",t.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}"undefined"!==typeof console&&"function"===typeof console.info&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),"undefined"!==typeof window&&"undefined"!==typeof document&&("loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e())}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Le{constructor(e,t){this.providerId=e,this.signInMethod=t}toJSON(){return E("not implemented")}_getIdTokenResponse(e){return E("not implemented")}_linkToIdToken(e,t){return E("not implemented")}_getReauthenticationResolver(e){return E("not implemented")}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Me(e,t){return F(e,"POST","/v1/accounts:update",t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function Fe(e,t){return j(e,"POST","/v1/accounts:signInWithPassword",M(e,t))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function Ue(e,t){return j(e,"POST","/v1/accounts:signInWithEmailLink",M(e,t))}async function je(e,t){return j(e,"POST","/v1/accounts:signInWithEmailLink",M(e,t))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ve extends Le{constructor(e,t,i,n=null){super("password",i),this._email=e,this._password=t,this._tenantId=n}static _fromEmailAndPassword(e,t){return new Ve(e,t,"password")}static _fromEmailAndCode(e,t,i=null){return new Ve(e,t,"emailLink",i)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){const t="string"===typeof e?JSON.parse(e):e;if((null===t||void 0===t?void 0:t.email)&&(null===t||void 0===t?void 0:t.password)){if("password"===t.signInMethod)return this._fromEmailAndPassword(t.email,t.password);if("emailLink"===t.signInMethod)return this._fromEmailAndCode(t.email,t.password,t.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":return Fe(e,{returnSecureToken:!0,email:this._email,password:this._password});case"emailLink":return Ue(e,{email:this._email,oobCode:this._password});default:m(e,"internal-error")}}async _linkToIdToken(e,t){switch(this.signInMethod){case"password":return Me(e,{idToken:t,returnSecureToken:!0,email:this._email,password:this._password});case"emailLink":return je(e,{idToken:t,email:this._email,oobCode:this._password});default:m(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Be(e,t){return j(e,"POST","/v1/accounts:signInWithIdp",M(e,t))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const He="http://localhost";class We extends Le{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const t=new We(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(t.idToken=e.idToken),e.accessToken&&(t.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(t.nonce=e.nonce),e.pendingToken&&(t.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(t.accessToken=e.oauthToken,t.secret=e.oauthTokenSecret):m("argument-error"),t}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){const t="string"===typeof e?JSON.parse(e):e,{providerId:i,signInMethod:n}=t,r=a(t,["providerId","signInMethod"]);if(!i||!n)return null;const s=new We(i,n);return s.idToken=r.idToken||void 0,s.accessToken=r.accessToken||void 0,s.secret=r.secret,s.nonce=r.nonce,s.pendingToken=r.pendingToken||null,s}_getIdTokenResponse(e){const t=this.buildRequest();return Be(e,t)}_linkToIdToken(e,t){const i=this.buildRequest();return i.idToken=t,Be(e,i)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,Be(e,t)}buildRequest(){const e={requestUri:He,returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const t={};this.idToken&&(t["id_token"]=this.idToken),this.accessToken&&(t["access_token"]=this.accessToken),this.secret&&(t["oauth_token_secret"]=this.secret),t["providerId"]=this.providerId,this.nonce&&!this.pendingToken&&(t["nonce"]=this.nonce),e.postBody=(0,r.xO)(t)}return e}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Ke(e,t){return F(e,"POST","/v1/accounts:sendVerificationCode",M(e,t))}async function Ge(e,t){return j(e,"POST","/v1/accounts:signInWithPhoneNumber",M(e,t))}async function qe(e,t){const i=await j(e,"POST","/v1/accounts:signInWithPhoneNumber",M(e,t));if(i.temporaryProof)throw H(e,"account-exists-with-different-credential",i);return i}const ze={["USER_NOT_FOUND"]:"user-not-found"};async function Je(e,t){const i=Object.assign(Object.assign({},t),{operation:"REAUTH"});return j(e,"POST","/v1/accounts:signInWithPhoneNumber",M(e,i),ze)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ye extends Le{constructor(e){super("phone","phone"),this.params=e}static _fromVerification(e,t){return new Ye({verificationId:e,verificationCode:t})}static _fromTokenResponse(e,t){return new Ye({phoneNumber:e,temporaryProof:t})}_getIdTokenResponse(e){return Ge(e,this._makeVerificationRequest())}_linkToIdToken(e,t){return qe(e,Object.assign({idToken:t},this._makeVerificationRequest()))}_getReauthenticationResolver(e){return Je(e,this._makeVerificationRequest())}_makeVerificationRequest(){const{temporaryProof:e,phoneNumber:t,verificationId:i,verificationCode:n}=this.params;return e&&t?{temporaryProof:e,phoneNumber:t}:{sessionInfo:i,code:n}}toJSON(){const e={providerId:this.providerId};return this.params.phoneNumber&&(e.phoneNumber=this.params.phoneNumber),this.params.temporaryProof&&(e.temporaryProof=this.params.temporaryProof),this.params.verificationCode&&(e.verificationCode=this.params.verificationCode),this.params.verificationId&&(e.verificationId=this.params.verificationId),e}static fromJSON(e){"string"===typeof e&&(e=JSON.parse(e));const{verificationId:t,verificationCode:i,phoneNumber:n,temporaryProof:r}=e;return i||t||n||r?new Ye({verificationId:t,verificationCode:i,phoneNumber:n,temporaryProof:r}):null}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Xe(e){switch(e){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}function $e(e){const t=(0,r.zd)((0,r.pd)(e))["link"],i=t?(0,r.zd)((0,r.pd)(t))["deep_link_id"]:null,n=(0,r.zd)((0,r.pd)(e))["deep_link_id"],s=n?(0,r.zd)((0,r.pd)(n))["link"]:null;return s||n||i||t||e}class Qe{constructor(e){var t,i,n,s,o,a;const c=(0,r.zd)((0,r.pd)(e)),d=null!==(t=c["apiKey"])&&void 0!==t?t:null,l=null!==(i=c["oobCode"])&&void 0!==i?i:null,h=Xe(null!==(n=c["mode"])&&void 0!==n?n:null);y(d&&l&&h,"argument-error"),this.apiKey=d,this.operation=h,this.code=l,this.continueUrl=null!==(s=c["continueUrl"])&&void 0!==s?s:null,this.languageCode=null!==(o=c["languageCode"])&&void 0!==o?o:null,this.tenantId=null!==(a=c["tenantId"])&&void 0!==a?a:null}static parseLink(e){const t=$e(e);try{return new Qe(t)}catch(i){return null}}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Ze{constructor(){this.providerId=Ze.PROVIDER_ID}static credential(e,t){return Ve._fromEmailAndPassword(e,t)}static credentialWithLink(e,t){const i=Qe.parseLink(t);return y(i,"argument-error"),Ve._fromEmailAndCode(e,i.code,i.tenantId)}}Ze.PROVIDER_ID="password",Ze.EMAIL_PASSWORD_SIGN_IN_METHOD="password",Ze.EMAIL_LINK_SIGN_IN_METHOD="emailLink";
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class et{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tt extends et{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class it extends tt{constructor(){super("facebook.com")}static credential(e){return We._fromParams({providerId:it.PROVIDER_ID,signInMethod:it.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return it.credentialFromTaggedObject(e)}static credentialFromError(e){return it.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return it.credential(e.oauthAccessToken)}catch(t){return null}}}it.FACEBOOK_SIGN_IN_METHOD="facebook.com",it.PROVIDER_ID="facebook.com";
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class nt extends tt{constructor(){super("google.com"),this.addScope("profile")}static credential(e,t){return We._fromParams({providerId:nt.PROVIDER_ID,signInMethod:nt.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:t})}static credentialFromResult(e){return nt.credentialFromTaggedObject(e)}static credentialFromError(e){return nt.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthIdToken:t,oauthAccessToken:i}=e;if(!t&&!i)return null;try{return nt.credential(t,i)}catch(n){return null}}}nt.GOOGLE_SIGN_IN_METHOD="google.com",nt.PROVIDER_ID="google.com";
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class rt extends tt{constructor(){super("github.com")}static credential(e){return We._fromParams({providerId:rt.PROVIDER_ID,signInMethod:rt.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return rt.credentialFromTaggedObject(e)}static credentialFromError(e){return rt.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return rt.credential(e.oauthAccessToken)}catch(t){return null}}}rt.GITHUB_SIGN_IN_METHOD="github.com",rt.PROVIDER_ID="github.com";
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class st extends tt{constructor(){super("twitter.com")}static credential(e,t){return We._fromParams({providerId:st.PROVIDER_ID,signInMethod:st.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:t})}static credentialFromResult(e){return st.credentialFromTaggedObject(e)}static credentialFromError(e){return st.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthAccessToken:t,oauthTokenSecret:i}=e;if(!t||!i)return null;try{return st.credential(t,i)}catch(n){return null}}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function ot(e,t){return j(e,"POST","/v1/accounts:signUp",M(e,t))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */st.TWITTER_SIGN_IN_METHOD="twitter.com",st.PROVIDER_ID="twitter.com";class at{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,i,n=!1){const r=await ae._fromIdTokenResponse(e,i,n),s=ct(i),o=new at({user:r,providerId:s,_tokenResponse:i,operationType:t});return o}static async _forOperation(e,t,i){await e._updateTokensIfNecessary(i,!0);const n=ct(i);return new at({user:e,providerId:n,_tokenResponse:i,operationType:t})}}function ct(e){return e.providerId?e.providerId:"phoneNumber"in e?"phone":null}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function dt(e){var t;const i=Ae(e);if(await i._initializationPromise,null===(t=i.currentUser)||void 0===t?void 0:t.isAnonymous)return new at({user:i.currentUser,providerId:null,operationType:"signIn"});const n=await ot(i,{returnSecureToken:!0}),r=await at._fromIdTokenResponse(i,"signIn",n,!0);return await i._updateCurrentUser(r.user),r}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lt extends r.ZR{constructor(e,t,i,n){var r;super(t.code,t.message),this.operationType=i,this.user=n,Object.setPrototypeOf(this,lt.prototype),this.customData={appName:e.name,tenantId:null!==(r=e.tenantId)&&void 0!==r?r:void 0,_serverResponse:t.customData._serverResponse,operationType:i}}static _fromErrorAndOperation(e,t,i,n){return new lt(e,t,i,n)}}function ht(e,t,i,n){const r="reauthenticate"===t?i._getReauthenticationResolver(e):i._getIdTokenResponse(e);return r.catch((i=>{if("auth/multi-factor-auth-required"===i.code)throw lt._fromErrorAndOperation(e,i,t,n);throw i}))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ut(e,t,i=!1){const n=await X(e,t._linkToIdToken(e.auth,await e.getIdToken()),i);return at._forOperation(e,"link",n)}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function pt(e,t,i=!1){const{auth:n}=e,r="reauthenticate";try{const s=await X(e,ht(n,r,t,e),i);y(s.idToken,n,"internal-error");const o=J(s.idToken);y(o,n,"internal-error");const{sub:a}=o;return y(e.uid===a,n,"user-mismatch"),at._forOperation(e,r,s)}catch(s){throw"auth/user-not-found"===(null===s||void 0===s?void 0:s.code)&&m(n,"user-mismatch"),s}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function mt(e,t,i=!1){const n="signIn",r=await ht(e,n,t),s=await at._fromIdTokenResponse(e,n,r);return i||await e._updateCurrentUser(s.user),s}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function ft(e,t){return(0,r.m9)(e).setPersistence(t)}function gt(e,t,i,n){return(0,r.m9)(e).onIdTokenChanged(t,i,n)}function _t(e,t,i){return(0,r.m9)(e).beforeAuthStateChanged(t,i)}function vt(e,t,i,n){return(0,r.m9)(e).onAuthStateChanged(t,i,n)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function yt(e,t){return F(e,"POST","/v2/accounts/mfaEnrollment:start",M(e,t))}function Et(e,t){return F(e,"POST","/v2/accounts/mfaEnrollment:finalize",M(e,t))}function St(e,t){return F(e,"POST","/v2/accounts/mfaEnrollment:start",M(e,t))}function bt(e,t){return F(e,"POST","/v2/accounts/mfaEnrollment:finalize",M(e,t))}new WeakMap;const wt="__sak";
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tt{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(wt,"1"),this.storage.removeItem(wt),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){const t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ct(){const e=(0,r.z$)();return me(e)||Ee(e)}const Rt=1e3,It=10;class At extends Tt{constructor(){super((()=>window.localStorage),"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=Ct()&&Te(),this.fallbackToPolling=we(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const t of Object.keys(this.listeners)){const i=this.storage.getItem(t),n=this.localCache[t];i!==n&&e(t,n,i)}}onStorageEvent(e,t=!1){if(!e.key)return void this.forAllChangedKeys(((e,t,i)=>{this.notifyListeners(e,i)}));const i=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const n=this.storage.getItem(i);if(e.newValue!==n)null!==e.newValue?this.storage.setItem(i,e.newValue):this.storage.removeItem(i);else if(this.localCache[i]===e.newValue&&!t)return}const n=()=>{const e=this.storage.getItem(i);(t||this.localCache[i]!==e)&&this.notifyListeners(i,e)},r=this.storage.getItem(i);be()&&r!==e.newValue&&e.newValue!==e.oldValue?setTimeout(n,It):n()}notifyListeners(e,t){this.localCache[e]=t;const i=this.listeners[e];if(i)for(const n of Array.from(i))n(t?JSON.parse(t):t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((()=>{this.forAllChangedKeys(((e,t,i)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:i}),!0)}))}),Rt)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){const t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}At.type="LOCAL";const Pt=At;
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ot extends Tt{constructor(){super((()=>window.sessionStorage),"SESSION")}_addListener(e,t){}_removeListener(e,t){}}Ot.type="SESSION";const Nt=Ot;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Dt(e){return Promise.all(e.map((async e=>{try{const t=await e;return{fulfilled:!0,value:t}}catch(t){return{fulfilled:!1,reason:t}}})))}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kt{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){const t=this.receivers.find((t=>t.isListeningto(e)));if(t)return t;const i=new kt(e);return this.receivers.push(i),i}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const t=e,{eventId:i,eventType:n,data:r}=t.data,s=this.handlersMap[n];if(!(null===s||void 0===s?void 0:s.size))return;t.ports[0].postMessage({status:"ack",eventId:i,eventType:n});const o=Array.from(s).map((async e=>e(t.origin,r))),a=await Dt(o);t.ports[0].postMessage({status:"done",eventId:i,eventType:n,response:a})}_subscribe(e,t){0===Object.keys(this.handlersMap).length&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(t)}_unsubscribe(e,t){this.handlersMap[e]&&t&&this.handlersMap[e].delete(t),t&&0!==this.handlersMap[e].size||delete this.handlersMap[e],0===Object.keys(this.handlersMap).length&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function xt(e="",t=10){let i="";for(let n=0;n<t;n++)i+=Math.floor(10*Math.random());return e+i}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */kt.receivers=[];class Lt{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,t,i=50){const n="undefined"!==typeof MessageChannel?new MessageChannel:null;if(!n)throw new Error("connection_unavailable");let r,s;return new Promise(((o,a)=>{const c=xt("",20);n.port1.start();const d=setTimeout((()=>{a(new Error("unsupported_event"))}),i);s={messageChannel:n,onMessage(e){const t=e;if(t.data.eventId===c)switch(t.data.status){case"ack":clearTimeout(d),r=setTimeout((()=>{a(new Error("timeout"))}),3e3);break;case"done":clearTimeout(r),o(t.data.response);break;default:clearTimeout(d),clearTimeout(r),a(new Error("invalid_response"));break}}},this.handlers.add(s),n.port1.addEventListener("message",s.onMessage),this.target.postMessage({eventType:e,eventId:c,data:t},[n.port2])})).finally((()=>{s&&this.removeMessageHandler(s)}))}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mt(){return window}function Ft(e){Mt().location.href=e}
/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ut(){return"undefined"!==typeof Mt()["WorkerGlobalScope"]&&"function"===typeof Mt()["importScripts"]}async function jt(){if(!(null===navigator||void 0===navigator?void 0:navigator.serviceWorker))return null;try{const e=await navigator.serviceWorker.ready;return e.active}catch(e){return null}}function Vt(){var e;return(null===(e=null===navigator||void 0===navigator?void 0:navigator.serviceWorker)||void 0===e?void 0:e.controller)||null}function Bt(){return Ut()?self:null}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ht="firebaseLocalStorageDb",Wt=1,Kt="firebaseLocalStorage",Gt="fbase_key";class qt{constructor(e){this.request=e}toPromise(){return new Promise(((e,t)=>{this.request.addEventListener("success",(()=>{e(this.request.result)})),this.request.addEventListener("error",(()=>{t(this.request.error)}))}))}}function zt(e,t){return e.transaction([Kt],t?"readwrite":"readonly").objectStore(Kt)}function Jt(){const e=indexedDB.deleteDatabase(Ht);return new qt(e).toPromise()}function Yt(){const e=indexedDB.open(Ht,Wt);return new Promise(((t,i)=>{e.addEventListener("error",(()=>{i(e.error)})),e.addEventListener("upgradeneeded",(()=>{const t=e.result;try{t.createObjectStore(Kt,{keyPath:Gt})}catch(n){i(n)}})),e.addEventListener("success",(async()=>{const i=e.result;i.objectStoreNames.contains(Kt)?t(i):(i.close(),await Jt(),t(await Yt()))}))}))}async function Xt(e,t,i){const n=zt(e,!0).put({[Gt]:t,value:i});return new qt(n).toPromise()}async function $t(e,t){const i=zt(e,!1).get(t),n=await new qt(i).toPromise();return void 0===n?null:n.value}function Qt(e,t){const i=zt(e,!0).delete(t);return new qt(i).toPromise()}const Zt=800,ei=3;class ti{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then((()=>{}),(()=>{}))}async _openDb(){return this.db||(this.db=await Yt()),this.db}async _withRetries(e){let t=0;while(1)try{const t=await this._openDb();return await e(t)}catch(i){if(t++>ei)throw i;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return Ut()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=kt._getInstance(Bt()),this.receiver._subscribe("keyChanged",(async(e,t)=>{const i=await this._poll();return{keyProcessed:i.includes(t.key)}})),this.receiver._subscribe("ping",(async(e,t)=>["keyChanged"]))}async initializeSender(){var e,t;if(this.activeServiceWorker=await jt(),!this.activeServiceWorker)return;this.sender=new Lt(this.activeServiceWorker);const i=await this.sender._send("ping",{},800);i&&(null===(e=i[0])||void 0===e?void 0:e.fulfilled)&&(null===(t=i[0])||void 0===t?void 0:t.value.includes("keyChanged"))&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(e){if(this.sender&&this.activeServiceWorker&&Vt()===this.activeServiceWorker)try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch(t){}}async _isAvailable(){try{if(!indexedDB)return!1;const e=await Yt();return await Xt(e,wt,"1"),await Qt(e,wt),!0}catch(e){}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(e,t){return this._withPendingWrite((async()=>(await this._withRetries((i=>Xt(i,e,t))),this.localCache[e]=t,this.notifyServiceWorker(e))))}async _get(e){const t=await this._withRetries((t=>$t(t,e)));return this.localCache[e]=t,t}async _remove(e){return this._withPendingWrite((async()=>(await this._withRetries((t=>Qt(t,e))),delete this.localCache[e],this.notifyServiceWorker(e))))}async _poll(){const e=await this._withRetries((e=>{const t=zt(e,!1).getAll();return new qt(t).toPromise()}));if(!e)return[];if(0!==this.pendingWrites)return[];const t=[],i=new Set;for(const{fbase_key:n,value:r}of e)i.add(n),JSON.stringify(this.localCache[n])!==JSON.stringify(r)&&(this.notifyListeners(n,r),t.push(n));for(const n of Object.keys(this.localCache))this.localCache[n]&&!i.has(n)&&(this.notifyListeners(n,null),t.push(n));return t}notifyListeners(e,t){this.localCache[e]=t;const i=this.listeners[e];if(i)for(const n of Array.from(i))n(t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((async()=>this._poll()),Zt)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,t){0===Object.keys(this.listeners).length&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&this.stopPolling()}}ti.type="LOCAL";const ii=ti;
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ni(e,t){return F(e,"POST","/v2/accounts/mfaSignIn:start",M(e,t))}function ri(e,t){return F(e,"POST","/v2/accounts/mfaSignIn:finalize",M(e,t))}function si(e,t){return F(e,"POST","/v2/accounts/mfaSignIn:finalize",M(e,t))}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function oi(){var e,t;return null!==(t=null===(e=document.getElementsByTagName("head"))||void 0===e?void 0:e[0])&&void 0!==t?t:document}function ai(e){return new Promise(((t,i)=>{const n=document.createElement("script");n.setAttribute("src",e),n.onload=t,n.onerror=e=>{const t=f("internal-error");t.customData=e,i(t)},n.type="text/javascript",n.charset="UTF-8",oi().appendChild(n)}))}function ci(e){return`__${e}${Math.floor(1e6*Math.random())}`}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
ci("rcb"),new N(3e4,6e4);
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const di="recaptcha";async function li(e,t,i){var n;const r=await i.verify();try{let s;if(y("string"===typeof r,e,"argument-error"),y(i.type===di,e,"argument-error"),s="string"===typeof t?{phoneNumber:t}:t,"session"in s){const t=s.session;if("phoneNumber"in s){y("enroll"===t.type,e,"internal-error");const i=await yt(e,{idToken:t.credential,phoneEnrollmentInfo:{phoneNumber:s.phoneNumber,recaptchaToken:r}});return i.phoneSessionInfo.sessionInfo}{y("signin"===t.type,e,"internal-error");const i=(null===(n=s.multiFactorHint)||void 0===n?void 0:n.uid)||s.multiFactorUid;y(i,e,"missing-multi-factor-info");const o=await ni(e,{mfaPendingCredential:t.credential,mfaEnrollmentId:i,phoneSignInInfo:{recaptchaToken:r}});return o.phoneResponseInfo.sessionInfo}}{const{sessionInfo:t}=await Ke(e,{phoneNumber:s.phoneNumber,recaptchaToken:r});return t}}finally{i._reset()}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class hi{constructor(e){this.providerId=hi.PROVIDER_ID,this.auth=Ae(e)}verifyPhoneNumber(e,t){return li(this.auth,e,(0,r.m9)(t))}static credential(e,t){return Ye._fromVerification(e,t)}static credentialFromResult(e){const t=e;return hi.credentialFromTaggedObject(t)}static credentialFromError(e){return hi.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{phoneNumber:t,temporaryProof:i}=e;return t&&i?Ye._fromTokenResponse(t,i):null}}
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function ui(e,t){return t?w(t):(y(e._popupRedirectResolver,e,"argument-error"),e._popupRedirectResolver)}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */hi.PROVIDER_ID="phone",hi.PHONE_SIGN_IN_METHOD="phone";class pi extends Le{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return Be(e,this._buildIdpRequest())}_linkToIdToken(e,t){return Be(e,this._buildIdpRequest(t))}_getReauthenticationResolver(e){return Be(e,this._buildIdpRequest())}_buildIdpRequest(e){const t={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(t.idToken=e),t}}function mi(e){return mt(e.auth,new pi(e),e.bypassAuthState)}function fi(e){const{auth:t,user:i}=e;return y(i,t,"internal-error"),pt(i,new pi(e),e.bypassAuthState)}async function gi(e){const{auth:t,user:i}=e;return y(i,t,"internal-error"),ut(i,new pi(e),e.bypassAuthState)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _i{constructor(e,t,i,n,r=!1){this.auth=e,this.resolver=i,this.user=n,this.bypassAuthState=r,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(t)?t:[t]}execute(){return new Promise((async(e,t)=>{this.pendingPromise={resolve:e,reject:t};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(i){this.reject(i)}}))}async onAuthEvent(e){const{urlResponse:t,sessionId:i,postBody:n,tenantId:r,error:s,type:o}=e;if(s)return void this.reject(s);const a={auth:this.auth,requestUri:t,sessionId:i,tenantId:r||void 0,postBody:n||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(o)(a))}catch(c){this.reject(c)}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return mi;case"linkViaPopup":case"linkViaRedirect":return gi;case"reauthViaPopup":case"reauthViaRedirect":return fi;default:m(this.auth,"internal-error")}}resolve(e){S(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){S(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vi=new N(2e3,1e4);class yi extends _i{constructor(e,t,i,n,r){super(e,t,n,r),this.provider=i,this.authWindow=null,this.pollId=null,yi.currentPopupAction&&yi.currentPopupAction.cancel(),yi.currentPopupAction=this}async executeNotNull(){const e=await this.execute();return y(e,this.auth,"internal-error"),e}async onExecution(){S(1===this.filter.length,"Popup operations only handle one event");const e=xt();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch((e=>{this.reject(e)})),this.resolver._isIframeWebStorageSupported(this.auth,(e=>{e||this.reject(f(this.auth,"web-storage-unsupported"))})),this.pollUserCancellation()}get eventId(){var e;return(null===(e=this.authWindow)||void 0===e?void 0:e.associatedEvent)||null}cancel(){this.reject(f(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,yi.currentPopupAction=null}pollUserCancellation(){const e=()=>{var t,i;(null===(i=null===(t=this.authWindow)||void 0===t?void 0:t.window)||void 0===i?void 0:i.closed)?this.pollId=window.setTimeout((()=>{this.pollId=null,this.reject(f(this.auth,"popup-closed-by-user"))}),2e3):this.pollId=window.setTimeout(e,vi.get())};e()}}yi.currentPopupAction=null;
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Ei="pendingRedirect",Si=new Map;class bi extends _i{constructor(e,t,i=!1){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],t,void 0,i),this.eventId=null}async execute(){let e=Si.get(this.auth._key());if(!e){try{const t=await wi(this.resolver,this.auth),i=t?await super.execute():null;e=()=>Promise.resolve(i)}catch(t){e=()=>Promise.reject(t)}Si.set(this.auth._key(),e)}return this.bypassAuthState||Si.set(this.auth._key(),(()=>Promise.resolve(null))),e()}async onAuthEvent(e){if("signInViaRedirect"===e.type)return super.onAuthEvent(e);if("unknown"!==e.type){if(e.eventId){const t=await this.auth._redirectUserForId(e.eventId);if(t)return this.user=t,super.onAuthEvent(e);this.resolve(null)}}else this.resolve(null)}async onExecution(){}cleanUp(){}}async function wi(e,t){const i=Ii(t),n=Ri(e);if(!await n._isAvailable())return!1;const r="true"===await n._get(i);return await n._remove(i),r}async function Ti(e,t){return Ri(e)._set(Ii(t),"true")}function Ci(e,t){Si.set(e._key(),t)}function Ri(e){return w(e._redirectPersistence)}function Ii(e){return le(Ei,e.config.apiKey,e.name)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ai(e,t,i){return Pi(e,t,i)}async function Pi(e,t,i){const n=Ae(e);_(e,t,et),await n._initializationPromise;const r=ui(n,i);return await Ti(r,n),r._openRedirect(n,t,"signInViaRedirect")}async function Oi(e,t){return await Ae(e)._initializationPromise,Ni(e,t,!1)}async function Ni(e,t,i=!1){const n=Ae(e),r=ui(n,t),s=new bi(n,r,i),o=await s.execute();return o&&!i&&(delete o.user._redirectEventId,await n._persistUserIfCurrent(o.user),await n._setRedirectUser(null,t)),o}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Di=6e5;class ki{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(e){if(this.hasEventBeenHandled(e))return!1;let t=!1;return this.consumers.forEach((i=>{this.isEventForConsumer(e,i)&&(t=!0,this.sendToConsumer(e,i),this.saveEventToCache(e))})),this.hasHandledPotentialRedirect||!Mi(e)||(this.hasHandledPotentialRedirect=!0,t||(this.queuedRedirectEvent=e,t=!0)),t}sendToConsumer(e,t){var i;if(e.error&&!Li(e)){const n=(null===(i=e.error.code)||void 0===i?void 0:i.split("auth/")[1])||"internal-error";t.onError(f(this.auth,n))}else t.onAuthEvent(e)}isEventForConsumer(e,t){const i=null===t.eventId||!!e.eventId&&e.eventId===t.eventId;return t.filter.includes(e.type)&&i}hasEventBeenHandled(e){return Date.now()-this.lastProcessedEventTime>=Di&&this.cachedEventUids.clear(),this.cachedEventUids.has(xi(e))}saveEventToCache(e){this.cachedEventUids.add(xi(e)),this.lastProcessedEventTime=Date.now()}}function xi(e){return[e.type,e.eventId,e.sessionId,e.tenantId].filter((e=>e)).join("-")}function Li({type:e,error:t}){return"unknown"===e&&"auth/no-auth-event"===(null===t||void 0===t?void 0:t.code)}function Mi(e){switch(e.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return Li(e);default:return!1}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Fi(e,t={}){return F(e,"GET","/v1/projects",t)}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ui=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,ji=/^https?/;async function Vi(e){if(e.config.emulator)return;const{authorizedDomains:t}=await Fi(e);for(const n of t)try{if(Bi(n))return}catch(i){}m(e,"unauthorized-domain")}function Bi(e){const t=R(),{protocol:i,hostname:n}=new URL(t);if(e.startsWith("chrome-extension://")){const r=new URL(e);return""===r.hostname&&""===n?"chrome-extension:"===i&&e.replace("chrome-extension://","")===t.replace("chrome-extension://",""):"chrome-extension:"===i&&r.hostname===n}if(!ji.test(i))return!1;if(Ui.test(e))return n===e;const r=e.replace(/\./g,"\\."),s=new RegExp("^(.+\\."+r+"|"+r+")$","i");return s.test(n)}
/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hi=new N(3e4,6e4);function Wi(){const e=Mt().___jsl;if(null===e||void 0===e?void 0:e.H)for(const t of Object.keys(e.H))if(e.H[t].r=e.H[t].r||[],e.H[t].L=e.H[t].L||[],e.H[t].r=[...e.H[t].L],e.CP)for(let i=0;i<e.CP.length;i++)e.CP[i]=null}function Ki(e){return new Promise(((t,i)=>{var n,r,s;function o(){Wi(),gapi.load("gapi.iframes",{callback:()=>{t(gapi.iframes.getContext())},ontimeout:()=>{Wi(),i(f(e,"network-request-failed"))},timeout:Hi.get()})}if(null===(r=null===(n=Mt().gapi)||void 0===n?void 0:n.iframes)||void 0===r?void 0:r.Iframe)t(gapi.iframes.getContext());else{if(!(null===(s=Mt().gapi)||void 0===s?void 0:s.load)){const t=ci("iframefcb");return Mt()[t]=()=>{gapi.load?o():i(f(e,"network-request-failed"))},ai(`https://apis.google.com/js/api.js?onload=${t}`).catch((e=>i(e)))}o()}})).catch((e=>{throw Gi=null,e}))}let Gi=null;function qi(e){return Gi=Gi||Ki(e),Gi}
/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zi=new N(5e3,15e3),Ji="__/auth/iframe",Yi="emulator/auth/iframe",Xi={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},$i=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function Qi(e){const t=e.config;y(t.authDomain,e,"auth-domain-config-required");const i=t.emulator?D(t,Yi):`https://${e.config.authDomain}/${Ji}`,n={apiKey:t.apiKey,appName:e.name,v:s.Jn},o=$i.get(e.config.apiHost);o&&(n.eid=o);const a=e._getFrameworks();return a.length&&(n.fw=a.join(",")),`${i}?${(0,r.xO)(n).slice(1)}`}async function Zi(e){const t=await qi(e),i=Mt().gapi;return y(i,e,"internal-error"),t.open({where:document.body,url:Qi(e),messageHandlersFilter:i.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:Xi,dontclear:!0},(t=>new Promise((async(i,n)=>{await t.restyle({setHideOnLeave:!1});const r=f(e,"network-request-failed"),s=Mt().setTimeout((()=>{n(r)}),zi.get());function o(){Mt().clearTimeout(s),i(t)}t.ping(o).then(o,(()=>{n(r)}))}))))}
/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const en={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"},tn=500,nn=600,rn="_blank",sn="http://localhost";class on{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch(e){}}}function an(e,t,i,n=tn,s=nn){const o=Math.max((window.screen.availHeight-s)/2,0).toString(),a=Math.max((window.screen.availWidth-n)/2,0).toString();let c="";const d=Object.assign(Object.assign({},en),{width:n.toString(),height:s.toString(),top:o,left:a}),l=(0,r.z$)().toLowerCase();i&&(c=fe(l)?rn:i),pe(l)&&(t=t||sn,d.scrollbars="yes");const h=Object.entries(d).reduce(((e,[t,i])=>`${e}${t}=${i},`),"");if(Se(l)&&"_self"!==c)return cn(t||"",c),new on(null);const u=window.open(t||"",c,h);y(u,e,"popup-blocked");try{u.focus()}catch(p){}return new on(u)}function cn(e,t){const i=document.createElement("a");i.href=e,i.target=t;const n=document.createEvent("MouseEvent");n.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),i.dispatchEvent(n)}
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dn="__/auth/handler",ln="emulator/auth/handler";function hn(e,t,i,n,o,a){y(e.config.authDomain,e,"auth-domain-config-required"),y(e.config.apiKey,e,"invalid-api-key");const c={apiKey:e.config.apiKey,appName:e.name,authType:i,redirectUrl:n,v:s.Jn,eventId:o};if(t instanceof et){t.setDefaultLanguage(e.languageCode),c.providerId=t.providerId||"",(0,r.xb)(t.getCustomParameters())||(c.customParameters=JSON.stringify(t.getCustomParameters()));for(const[e,t]of Object.entries(a||{}))c[e]=t}if(t instanceof tt){const e=t.getScopes().filter((e=>""!==e));e.length>0&&(c.scopes=e.join(","))}e.tenantId&&(c.tid=e.tenantId);const d=c;for(const r of Object.keys(d))void 0===d[r]&&delete d[r];return`${un(e)}?${(0,r.xO)(d).slice(1)}`}function un({config:e}){return e.emulator?D(e,ln):`https://${e.authDomain}/${dn}`}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pn="webStorageSupport";class mn{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=Nt,this._completeRedirectFn=Ni,this._overrideRedirectResult=Ci}async _openPopup(e,t,i,n){var r;S(null===(r=this.eventManagers[e._key()])||void 0===r?void 0:r.manager,"_initialize() not called before _openPopup()");const s=hn(e,t,i,R(),n);return an(e,s,xt())}async _openRedirect(e,t,i,n){return await this._originValidation(e),Ft(hn(e,t,i,R(),n)),new Promise((()=>{}))}_initialize(e){const t=e._key();if(this.eventManagers[t]){const{manager:e,promise:i}=this.eventManagers[t];return e?Promise.resolve(e):(S(i,"If manager is not set, promise should be"),i)}const i=this.initAndGetManager(e);return this.eventManagers[t]={promise:i},i.catch((()=>{delete this.eventManagers[t]})),i}async initAndGetManager(e){const t=await Zi(e),i=new ki(e);return t.register("authEvent",(t=>{y(null===t||void 0===t?void 0:t.authEvent,e,"invalid-auth-event");const n=i.onEvent(t.authEvent);return{status:n?"ACK":"ERROR"}}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[e._key()]={manager:i},this.iframes[e._key()]=t,i}_isIframeWebStorageSupported(e,t){const i=this.iframes[e._key()];i.send(pn,{type:pn},(i=>{var n;const r=null===(n=null===i||void 0===i?void 0:i[0])||void 0===n?void 0:n[pn];void 0!==r&&t(!!r),m(e,"internal-error")}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){const t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=Vi(e)),this.originValidationPromises[t]}get _shouldInitProactively(){return we()||me()||Ee()}}const fn=mn;class gn{constructor(e){this.factorId=e}_process(e,t,i){switch(t.type){case"enroll":return this._finalizeEnroll(e,t.credential,i);case"signin":return this._finalizeSignIn(e,t.credential);default:return E("unexpected MultiFactorSessionType")}}}class _n extends gn{constructor(e){super("phone"),this.credential=e}static _fromCredential(e){return new _n(e)}_finalizeEnroll(e,t,i){return Et(e,{idToken:t,displayName:i,phoneVerificationInfo:this.credential._makeVerificationRequest()})}_finalizeSignIn(e,t){return ri(e,{mfaPendingCredential:t,phoneVerificationInfo:this.credential._makeVerificationRequest()})}}class vn{constructor(){}static assertion(e){return _n._fromCredential(e)}}vn.FACTOR_ID="phone";class yn{static assertionForEnrollment(e,t){return En._fromSecret(e,t)}static assertionForSignIn(e,t){return En._fromEnrollmentId(e,t)}static async generateSecret(e){const t=e;y("undefined"!==typeof t.auth,"internal-error");const i=await St(t.auth,{idToken:t.credential,totpEnrollmentInfo:{}});return Sn._fromStartTotpMfaEnrollmentResponse(i,t.auth)}}yn.FACTOR_ID="totp";class En extends gn{constructor(e,t,i){super("totp"),this.otp=e,this.enrollmentId=t,this.secret=i}static _fromSecret(e,t){return new En(t,void 0,e)}static _fromEnrollmentId(e,t){return new En(t,e)}async _finalizeEnroll(e,t,i){return y("undefined"!==typeof this.secret,e,"argument-error"),bt(e,{idToken:t,displayName:i,totpVerificationInfo:this.secret._makeTotpVerificationInfo(this.otp)})}async _finalizeSignIn(e,t){y(void 0!==this.enrollmentId&&void 0!==this.otp,e,"argument-error");const i={verificationCode:this.otp};return si(e,{mfaPendingCredential:t,mfaEnrollmentId:this.enrollmentId,totpVerificationInfo:i})}}class Sn{constructor(e,t,i,n,r,s,o){this.sessionInfo=s,this.auth=o,this.secretKey=e,this.hashingAlgorithm=t,this.codeLength=i,this.codeIntervalSeconds=n,this.enrollmentCompletionDeadline=r}static _fromStartTotpMfaEnrollmentResponse(e,t){return new Sn(e.totpSessionInfo.sharedSecretKey,e.totpSessionInfo.hashingAlgorithm,e.totpSessionInfo.verificationCodeLength,e.totpSessionInfo.periodSec,new Date(e.totpSessionInfo.finalizeEnrollmentTime).toUTCString(),e.totpSessionInfo.sessionInfo,t)}_makeTotpVerificationInfo(e){return{sessionInfo:this.sessionInfo,verificationCode:e}}generateQrCodeUrl(e,t){var i;let n=!1;return(bn(e)||bn(t))&&(n=!0),n&&(bn(e)&&(e=(null===(i=this.auth.currentUser)||void 0===i?void 0:i.email)||"unknownuser"),bn(t)&&(t=this.auth.name)),`otpauth://totp/${t}:${e}?secret=${this.secretKey}&issuer=${t}&algorithm=${this.hashingAlgorithm}&digits=${this.codeLength}`}}function bn(e){return"undefined"===typeof e||0===(null===e||void 0===e?void 0:e.length)}var wn="@firebase/auth",Tn="0.22.0";
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Cn{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){if(this.assertAuthConfigured(),await this.auth._initializationPromise,!this.auth.currentUser)return null;const t=await this.auth.currentUser.getIdToken(e);return{accessToken:t}}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const t=this.auth.onIdTokenChanged((t=>{e((null===t||void 0===t?void 0:t.stsTokenManager.accessToken)||null)}));this.internalListeners.set(e,t),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){y(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Rn(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";default:return}}function In(e){(0,s.Xd)(new c.wA("auth",((t,{options:i})=>{const n=t.getProvider("app").getImmediate(),r=t.getProvider("heartbeat"),{apiKey:s,authDomain:o}=n.options;return((t,n)=>{y(s&&!s.includes(":"),"invalid-api-key",{appName:t.name}),y(!(null===o||void 0===o?void 0:o.includes(":")),"argument-error",{appName:t.name});const r={apiKey:s,authDomain:o,clientPlatform:e,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:Ce(e)},a=new Ie(t,n,r);return C(a,i),a})(n,r)}),"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback(((e,t,i)=>{const n=e.getProvider("auth-internal");n.initialize()}))),(0,s.Xd)(new c.wA("auth-internal",(e=>{const t=Ae(e.getProvider("auth").getImmediate());return(e=>new Cn(e))(t)}),"PRIVATE").setInstantiationMode("EXPLICIT")),(0,s.KN)(wn,Tn,Rn(e)),(0,s.KN)(wn,Tn,"esm2017")}
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const An=300,Pn=(0,r.Pz)("authIdTokenMaxAge")||An;let On=null;const Nn=e=>async t=>{const i=t&&await t.getIdTokenResult(),n=i&&((new Date).getTime()-Date.parse(i.issuedAtTime))/1e3;if(n&&n>Pn)return;const r=null===i||void 0===i?void 0:i.token;On!==r&&(On=r,await fetch(e,{method:r?"POST":"DELETE",headers:r?{Authorization:`Bearer ${r}`}:{}}))};function Dn(e=(0,s.Mq)()){const t=(0,s.qX)(e,"auth");if(t.isInitialized())return t.getImmediate();const i=T(e,{popupRedirectResolver:fn,persistence:[ii,Pt,Nt]}),n=(0,r.Pz)("authTokenSyncURL");if(n){const e=Nn(n);_t(i,e,(()=>e(i.currentUser))),gt(i,(t=>e(t)))}const o=(0,r.q4)("auth");return o&&Oe(i,`http://${o}`),i}In("Browser");var kn=i(1022);let xn,Ln;async function Mn(){const e=Dn();dt(e).then((()=>{console.log("[googleå¿åèªè¨¼å®è¡]")})).catch((e=>{console.log(e.message)})),vt(e,(e=>{}))}async function Fn(){const e=Dn();if(await Oi(e).then((e=>{const t=nt.credentialFromResult(e),i=t.accessToken,n=e.user;console.log(`ã­ã°ã¤ã³æå ±ï¼${n} ${i}`),console.log(n),console.log(n.displayName),Ln=!0})).catch((e=>{const t=e.code,i=e.message,n=nt.credentialFromError(e);console.log(`Error!! ${t}${i}${n}`)})),console.log(`ã­ã°ã¤ã³æ¸ï¼${Ln}`),Ln)return;const t=new nt;Ai(e,t).then((e=>{const t=nt.credentialFromResult(e),i=t.accessToken;xn=e.user,console.log(`sined in by google ${xn} ${i}`)})).catch((e=>{const t=e.code,i=e.message,n=e.customData.email,r=nt.credentialFromError(e);console.log(`Error!! ${t}${i}${n}${r}`)}))}async function Un(){const e=Dn(),t=new st;console.log(`ã­ã°ã¤ã³æå ±ï¼${xn}`),console.log(`ã­ã°ã¤ã³æ¸ï¼${Ln}`),Ln||ft(e,Pt).then((()=>{Ai(e,t).then((()=>{Oi(e).then((e=>{xn=e.user,console.log(xn),console.log(xn.displayName)}))}))}))}async function jn(e,t){try{const i=await(0,n.VF)((0,n.iH)((0,n.N8)(),e),t);return i.key}catch(i){console.error(i)}}async function Vn(e){try{await(0,n.Od)((0,n.iH)((0,n.N8)(),e)).then((()=>{console.log("[åé¤ãå®äºãã¾ãã]"+e)})).catch((e=>{console.error("åé¤ä¸­ã«ã¨ã©ã¼ãçºçãã¾ãã",e)}))}catch(t){console.error(t)}}async function Bn(e){let t=[];try{const i=await(0,n.N8)();await(0,n.U2)((0,n.iH)(i,e)).then((i=>{i.exists()?i.forEach((function(e){var i=e.val();t.push(i)})):console.log("ãã¼ã¿ãå­å¨ãã¾ãã "+e)})).catch((e=>{console.error("ãã¼ã¿ã®åå¾ä¸­ã«ã¨ã©ã¼ãçºçãã¾ãã",e)}))}catch(i){console.error(i)}return t}async function Hn(e,t){try{const i=await(0,n.iH)((0,n.N8)(),e);(0,n.jM)(i,t)}catch(i){console.error(i)}}function Wn(e,t){try{const i=`${kn.t.FB_TABLE_ROOM_CHATS}/${e}`;jn(i,t)}catch(i){console.error(i)}}function Kn(e,t){try{const i=`${kn.t.FB_TABLE_ROOM_CHATS}/${e}`;console.log("[FirebaseDB Chatsã­ã¼]"+i),Hn(i,(e=>{var i=[];e.forEach((function(e){var t=e.val();i.push(t)})),i.reverse(),console.log("[chatsãã¼ã¿ç£è¦]"),t(i)}))}catch(i){console.error(i)}}async function Gn(e,t){try{const i=`${kn.t.FB_TABLE_ROOM_LISTNERS}/${e}`;console.log("[FirebaseDB Listnersã­ã¼]"+i),await Hn(i,(e=>{var i=[];e.forEach((function(e){var t=e.val();i.push(t)})),console.log("[listnersãã¼ã¿ç£è¦]"),t(i)}))}catch(i){console.error(i)}}async function qn(e){let t=[];try{const i=`${kn.t.FB_TABLE_ROOM_LISTNERS}/${e}`;console.log("[FirebaseDB Listnersã­ã¼]"+i),t=await Bn(i)}catch(i){console.error(i)}return t}async function zn(e,t){try{const i=`${kn.t.FB_TABLE_ROOM_LISTNERS}/${e}`,n=await Yn(e,t.userId);if(n)return void console.log("[å¥å®¤æ¸ã¿ãªã®ã§Listnerãã¼ã¿ç»é²ã¹ã­ãã]");const r=await jn(i,t);return console.log(r),r}catch(i){console.error(i)}}async function Jn(e,t){try{const i=`${kn.t.FB_TABLE_ROOM_LISTNERS}/${e}/${t}`;console.log(`[Lisnerãã¼ã¿ãfirebaseããåé¤] ${i}`),await Vn(i)}catch(i){console.error(i)}}async function Yn(e,t){let i=!1;try{const n=await qn(e);n.forEach((function(e){e.userId===t&&(console.log("[å¥å®¤æ¸]"+t),i=!0)}))}catch(n){console.error(n)}return i}},4702:function(e,t,i){"use strict";i.d(t,{uX:function(){return Hd},j8:function(){return Qd},r0:function(){return Xd},JW:function(){return Gd},uD:function(){return Yd},$9:function(){return $d},mg:function(){return Jd}});i(7658),i(3767),i(8585),i(8696),i(541),i(2801);var n,r=Object.create,s=Object.defineProperty,o=Object.defineProperties,a=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertyNames,l=Object.getOwnPropertySymbols,h=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,m=Math.pow,f=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,g=(e,t)=>{for(var i in t||(t={}))u.call(t,i)&&f(e,i,t[i]);if(l)for(var i of l(t))p.call(t,i)&&f(e,i,t[i]);return e},_=(e,t)=>o(e,c(t)),v=(e,t)=>function(){return e&&(t=(0,e[d(e)[0]])(e=0)),t},y=(e,t)=>function(){return t||(0,e[d(e)[0]])((t={exports:{}}).exports,t),t.exports},E=(e,t,i,n)=>{if(t&&"object"===typeof t||"function"===typeof t)for(let r of d(t))u.call(e,r)||r===i||s(e,r,{get:()=>t[r],enumerable:!(n=a(t,r))||n.enumerable});return e},S=(e,t,i)=>(i=null!=e?r(h(e)):{},E(!t&&e&&e.__esModule?i:s(i,"default",{value:e,enumerable:!0}),e)),b=(e,t,i)=>new Promise(((n,r)=>{var s=e=>{try{a(i.next(e))}catch(t){r(t)}},o=e=>{try{a(i.throw(e))}catch(t){r(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,o);a((i=i.apply(e,t)).next())})),w=v({"shims/process.js"(){n=void 0}}),T=y({"../../node_modules/form-data/lib/browser.js"(e,t){w(),t.exports="object"==typeof self?self.FormData:window.FormData}}),C=y({"../../node_modules/bowser/es5.js"(e,t){w(),function(i,n){"object"==typeof e&&"object"==typeof t?t.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof e?e.bowser=n():i.bowser=n()}(e,(function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=90)}({17:function(e,t,i){t.__esModule=!0,t.default=void 0;var n=i(18),r=function(){function e(){}return e.getFirstMatch=function(e,t){var i=t.match(e);return i&&i.length>0&&i[1]||""},e.getSecondMatch=function(e,t){var i=t.match(e);return i&&i.length>1&&i[2]||""},e.matchAndReturnConst=function(e,t,i){if(e.test(t))return i},e.getWindowsVersionName=function(e){switch(e){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,i,n){void 0===n&&(n=!1);var r=e.getVersionPrecision(t),s=e.getVersionPrecision(i),o=Math.max(r,s),a=0,c=e.map([t,i],(function(t){var i=o-e.getVersionPrecision(t),n=t+new Array(i+1).join(".0");return e.map(n.split("."),(function(e){return new Array(20-e.length).join("0")+e})).reverse()}));for(n&&(a=o-Math.min(r,s)),o-=1;o>=a;){if(c[0][o]>c[1][o])return 1;if(c[0][o]===c[1][o]){if(o===a)return 0;o-=1}else if(c[0][o]<c[1][o])return-1}},e.map=function(e,t){var i,n=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(i=0;i<e.length;i+=1)n.push(t(e[i]));return n},e.find=function(e,t){var i,n;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(i=0,n=e.length;i<n;i+=1){var r=e[i];if(t(r,i))return r}},e.assign=function(e){for(var t,i,n=e,r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];if(Object.assign)return Object.assign.apply(Object,[e].concat(s));var a=function(){var e=s[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach((function(t){n[t]=e[t]}))};for(t=0,i=s.length;t<i;t+=1)a();return e},e.getBrowserAlias=function(e){return n.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return n.BROWSER_MAP[e]||""},e}();t.default=r,e.exports=t.default},18:function(e,t,i){t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0,t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e,t,i){t.__esModule=!0,t.default=void 0;var n,r=(n=i(91))&&n.__esModule?n:{default:n},s=i(18);function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(){}var t,i,n;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw new Error("UserAgent should be a string");return new r.default(e,t)},e.parse=function(e){return new r.default(e).getResult()},t=e,n=[{key:"BROWSER_MAP",get:function(){return s.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return s.ENGINE_MAP}},{key:"OS_MAP",get:function(){return s.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return s.PLATFORMS_MAP}}],(i=null)&&o(t.prototype,i),n&&o(t,n),e}();t.default=a,e.exports=t.default},91:function(e,t,i){t.__esModule=!0,t.default=void 0;var n=c(i(92)),r=c(i(93)),s=c(i(94)),o=c(i(95)),a=c(i(17));function c(e){return e&&e.__esModule?e:{default:e}}var d=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e=this;this.parsedResult.browser={};var t=a.default.find(n.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e=this;this.parsedResult.os={};var t=a.default.find(r.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?String(t).toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?String(t).toLowerCase()||"":t||""},t.parsePlatform=function(){var e=this;this.parsedResult.platform={};var t=a.default.find(s.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e=this;this.parsedResult.engine={};var t=a.default.find(o.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return a.default.assign({},this.parsedResult)},t.satisfies=function(e){var t=this,i={},n=0,r={},s=0;if(Object.keys(e).forEach((function(t){var o=e[t];"string"==typeof o?(r[t]=o,s+=1):"object"==typeof o&&(i[t]=o,n+=1)})),n>0){var o=Object.keys(i),c=a.default.find(o,(function(e){return t.isOS(e)}));if(c){var d=this.satisfies(i[c]);if(void 0!==d)return d}var l=a.default.find(o,(function(e){return t.isPlatform(e)}));if(l){var h=this.satisfies(i[l]);if(void 0!==h)return h}}if(s>0){var u=Object.keys(r),p=a.default.find(u,(function(e){return t.isBrowser(e,!0)}));if(void 0!==p)return this.compareVersion(r[p])}},t.isBrowser=function(e,t){void 0===t&&(t=!1);var i=this.getBrowserName().toLowerCase(),n=e.toLowerCase(),r=a.default.getBrowserTypeByAlias(n);return t&&r&&(n=r.toLowerCase()),n===i},t.compareVersion=function(e){var t=[0],i=e,n=!1,r=this.getBrowserVersion();if("string"==typeof r)return">"===e[0]||"<"===e[0]?(i=e.substr(1),"="===e[1]?(n=!0,i=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?i=e.substr(1):"~"===e[0]&&(n=!0,i=e.substr(1)),t.indexOf(a.default.compareVersions(r,i,n))>-1},t.isOS=function(e){return this.getOSName(!0)===String(e).toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===String(e).toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===String(e).toLowerCase()},t.is=function(e,t){return void 0===t&&(t=!1),this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some((function(e){return t.is(e)}))},e}();t.default=d,e.exports=t.default},92:function(e,t,i){t.__esModule=!0,t.default=void 0;var n,r=(n=i(17))&&n.__esModule?n:{default:n},s=/version\/(\d+(\.?_?\d+)+)/i,o=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},i=r.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},i=r.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},i=r.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},i=r.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},i=r.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e){var t={name:"Opera Touch"},i=r.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},i=r.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},i=r.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},i=r.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},i=r.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},i=r.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},i=r.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},i=r.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},i=r.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},i=r.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return i&&(t.version=i),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},i=r.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},i=r.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},i=r.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},i=r.default.getFirstMatch(s,e)||r.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},i=r.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},i=r.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},i=r.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},i=r.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},i=r.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/MiuiBrowser/i],describe:function(e){var t={name:"Miui"},i=r.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},i=r.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},i=r.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},i=r.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t={name:"Android Browser"},i=r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},i=r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},i=r.default.getFirstMatch(s,e);return i&&(t.version=i),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:r.default.getFirstMatch(t,e),version:r.default.getSecondMatch(t,e)}}}];t.default=o,e.exports=t.default},93:function(e,t,i){t.__esModule=!0,t.default=void 0;var n,r=(n=i(17))&&n.__esModule?n:{default:n},s=i(18),o=[{test:[/Roku\/DVP/],describe:function(e){var t=r.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:s.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=r.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=r.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),i=r.default.getWindowsVersionName(t);return{name:s.OS_MAP.Windows,version:t,versionName:i}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e){var t={name:s.OS_MAP.iOS},i=r.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return i&&(t.version=i),t}},{test:[/macintosh/i],describe:function(e){var t=r.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),i=r.default.getMacOSVersionName(t),n={name:s.OS_MAP.MacOS,version:t};return i&&(n.versionName=i),n}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=r.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:s.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),i=e.test(/android/i);return t&&i},describe:function(e){var t=r.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),i=r.default.getAndroidVersionName(t),n={name:s.OS_MAP.Android,version:t};return i&&(n.versionName=i),n}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=r.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),i={name:s.OS_MAP.WebOS};return t&&t.length&&(i.version=t),i}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=r.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||r.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||r.default.getFirstMatch(/\bbb(\d+)/i,e);return{name:s.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=r.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=r.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return{name:s.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:s.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=r.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return{name:s.OS_MAP.PlayStation4,version:t}}}];t.default=o,e.exports=t.default},94:function(e,t,i){t.__esModule=!0,t.default=void 0;var n,r=(n=i(17))&&n.__esModule?n:{default:n},s=i(18),o=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=r.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",i={type:s.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(i.model=t),i}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),i=e.test(/like (ipod|iphone)/i);return t&&!i},describe:function(e){var t=r.default.getFirstMatch(/(ipod|iphone)/i,e);return{type:s.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"blackberry"===e.getBrowserName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return"bada"===e.getBrowserName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"windows phone"===e.getBrowserName()},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=Number(String(e.getOSVersion()).split(".")[0]);return"android"===e.getOSName(!0)&&t>=3},describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(e){return"android"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return"macos"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return"windows"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return"linux"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return"playstation 4"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.tv}}},{test:function(e){return"roku"===e.getOSName(!0)},describe:function(){return{type:s.PLATFORMS_MAP.tv}}}];t.default=o,e.exports=t.default},95:function(e,t,i){t.__esModule=!0,t.default=void 0;var n,r=(n=i(17))&&n.__esModule?n:{default:n},s=i(18),o=[{test:function(e){return"microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return{name:s.ENGINE_MAP.Blink};var t=r.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:s.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:s.ENGINE_MAP.Trident},i=r.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:s.ENGINE_MAP.Presto},i=r.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:function(e){var t=e.test(/gecko/i),i=e.test(/like gecko/i);return t&&!i},describe:function(e){var t={name:s.ENGINE_MAP.Gecko},i=r.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:s.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:s.ENGINE_MAP.WebKit},i=r.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return i&&(t.version=i),t}}];t.default=o,e.exports=t.default}})}))}}),R=y({"../../node_modules/sdp-transform/lib/grammar.js"(e,t){w();var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){var t=i[e];t.forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))}}),I=y({"../../node_modules/sdp-transform/lib/parser.js"(e){w();var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(i[n[s]]=t(e[s+1]))},n=function(e,t,n){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var s=e.push?{}:r?t[e.name]:t;i(n.match(e.reg),s,e.names,e.name),e.push&&t[e.push].push(s)},r=R(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},i=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),o=i[i.length-1]);for(var a=0;a<(r[t]||[]).length;a+=1){var c=r[t][a];if(c.reg.test(s))return n(c,o,s)}})),t.media=i,t};var o=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}}}),A=y({"../../node_modules/sdp-transform/lib/writer.js"(e,t){w();var i=R(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},s=function(e,t,i){var n=t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format,s=[e+"="+n];if(t.names)for(var o=0;o<t.names.length;o+=1){var a=t.names[o];t.name?s.push(i[t.name][a]):s.push(i[t.names[o]])}else s.push(i[t.name]);return r.apply(null,s)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||o,r=t.innerOrder||a,c=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))})),e.media.forEach((function(e){c.push(s("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(s(t,i,e))}))}))}))})),c.join("\r\n")+"\r\n"}}}),P=y({"../../node_modules/sdp-transform/lib/index.js"(e){w();var t=I(),i=A();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList}}),O=y({"../../node_modules/isomorphic-ws/browser.js"(e,t){w();var i=null;"undefined"!==typeof WebSocket?i=WebSocket:"undefined"!==typeof MozWebSocket?i=MozWebSocket:"undefined"!==typeof global?i=global.WebSocket||global.MozWebSocket:"undefined"!==typeof window?i=window.WebSocket||window.MozWebSocket:"undefined"!==typeof self&&(i=self.WebSocket||self.MozWebSocket),t.exports=i}}),N=y({"../../node_modules/deepmerge/dist/cjs.js"(e,t){w();var i=function(e){return n(e)&&!r(e)};function n(e){return!!e&&"object"===typeof e}function r(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||a(e)}var s="function"===typeof Symbol&&Symbol.for,o=s?Symbol.for("react.element"):60103;function a(e){return e.$$typeof===o}function c(e){return Array.isArray(e)?[]:{}}function d(e,t){return!1!==t.clone&&t.isMergeableObject(e)?_(c(e),e,t):e}function l(e,t,i){return e.concat(t).map((function(e){return d(e,i)}))}function h(e,t){if(!t.customMerge)return _;var i=t.customMerge(e);return"function"===typeof i?i:_}function u(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return e.propertyIsEnumerable(t)})):[]}function p(e){return Object.keys(e).concat(u(e))}function m(e,t){try{return t in e}catch(i){return!1}}function f(e,t){return m(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))}function g(e,t,i){var n={};return i.isMergeableObject(e)&&p(e).forEach((function(t){n[t]=d(e[t],i)})),p(t).forEach((function(r){f(e,r)||(m(e,r)&&i.isMergeableObject(t[r])?n[r]=h(r,i)(e[r],t[r],i):n[r]=d(t[r],i))})),n}function _(e,t,n){n=n||{},n.arrayMerge=n.arrayMerge||l,n.isMergeableObject=n.isMergeableObject||i,n.cloneUnlessOtherwiseSpecified=d;var r=Array.isArray(t),s=Array.isArray(e),o=r===s;return o?r?n.arrayMerge(e,t,n):g(e,t,n):d(t,n)}_.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,i){return _(e,i,t)}),{})};var v=_;t.exports=v}}),D=y({"../../node_modules/jsrsasign/lib/jsrsasign.js"(e){w();var t={userAgent:!1},i={},n=n||function(e,t){var i={},n=i.lib={},r=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var i=new e;return t&&i.mixIn(t),i.hasOwnProperty("init")||(i.init=function(){i.$super.init.apply(this,arguments)}),i.init.prototype=i,i.$super=this,i},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=n.WordArray=r.extend({init:function(e,i){e=this.words=e||[],this.sigBytes=i!=t?i:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,i=e.words,n=this.sigBytes,r=e.sigBytes;if(this.clamp(),n%4)for(var s=0;s<r;s++){var o=i[s>>>2]>>>24-s%4*8&255;t[n+s>>>2]|=o<<24-(n+s)%4*8}else for(s=0;s<r;s+=4)t[n+s>>>2]=i[s>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=r.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var i=[],n=0;n<t;n+=4)i.push(4294967296*e.random()|0);return new s.init(i,t)}}),o=i.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],r=0;r<i;r++){var s=t[r>>>2]>>>24-r%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n+=2)i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(i,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],r=0;r<i;r++){var s=t[r>>>2]>>>24-r%4*8&255;n.push(String.fromCharCode(s))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n++)i[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(i,t)}},d=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},l=n.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i=this._data,n=i.words,r=i.sigBytes,o=this.blockSize,a=4*o,c=r/a;c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0);var d=c*o,l=e.min(4*d,r);if(d){for(var h=0;h<d;h+=o)this._doProcessBlock(n,h);var u=n.splice(0,d);i.sigBytes-=l}return new s.init(u,l)},clone:function(){var e=r.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),h=(n.Hasher=l.extend({cfg:r.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var t=this._doFinalize();return t},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new h.HMAC.init(e,i).finalize(t)}}}),i.algo={});return i}(Math);(function(e){var t=n,i=t.lib,r=i.Base,s=i.WordArray;t=t.x64={};t.Word=r.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=r.extend({init:function(t,i){t=this.words=t||[],this.sigBytes=i!=e?i:8*t.length},toX32:function(){for(var e=this.words,t=e.length,i=[],n=0;n<t;n++){var r=e[n];i.push(r.high),i.push(r.low)}return s.create(i,this.sigBytes)},clone:function(){for(var e=r.clone.call(this),t=e.words=this.words.slice(0),i=t.length,n=0;n<i;n++)t[n]=t[n].clone();return e}})})(),n.lib.Cipher||function(e){var t=n,i=t.lib,r=i.Base,s=i.WordArray,o=i.BufferedBlockAlgorithm,a=t.enc.Base64,c=t.algo.EvpKDF,d=i.Cipher=o.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,i){this.cfg=this.cfg.extend(i),this._xformMode=e,this._key=t,this.reset()},reset:function(){o.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,i,n){return("string"==typeof i?f:m).encrypt(e,t,i,n)},decrypt:function(t,i,n){return("string"==typeof i?f:m).decrypt(e,t,i,n)}}}});i.StreamCipher=d.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var l=t.mode={},h=function(t,i,n){var r=this._iv;r?this._iv=e:r=this._prevBlock;for(var s=0;s<n;s++)t[i+s]^=r[s]},u=(i.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();u.Encryptor=u.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize;h.call(this,e,t,n),i.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),u.Decryptor=u.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize,r=e.slice(t,t+n);i.decryptBlock(e,t),h.call(this,e,t,n),this._prevBlock=r}}),l=l.CBC=u,u=(t.pad={}).Pkcs7={pad:function(e,t){for(var i=4*t,n=(i=i-e.sigBytes%i,i<<24|i<<16|i<<8|i),r=[],o=0;o<i;o+=4)r.push(n);i=s.create(r,i),e.concat(i)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},i.BlockCipher=d.extend({cfg:d.cfg.extend({mode:l,padding:u}),reset:function(){d.reset.call(this);var e=this.cfg,t=e.iv;e=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var i=e.createEncryptor;else i=e.createDecryptor,this._minBufferSize=1;this._mode=i.call(e,this,t&&t.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var p=i.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),m=(l=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return e=e.salt,(e?s.create([1398893684,1701076831]).concat(e).concat(t):t).toString(a)},parse:function(e){e=a.parse(e);var t=e.words;if(1398893684==t[0]&&1701076831==t[1]){var i=s.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return p.create({ciphertext:e,salt:i})}},i.SerializableCipher=r.extend({cfg:r.extend({format:l}),encrypt:function(e,t,i,n){n=this.cfg.extend(n);var r=e.createEncryptor(i,n);return t=r.finalize(t),r=r.cfg,p.create({ciphertext:t,key:i,iv:r.iv,algorithm:e,mode:r.mode,padding:r.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,i,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(i,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),f=(t=(t.kdf={}).OpenSSL={execute:function(e,t,i,n){return n||(n=s.random(8)),e=c.create({keySize:t+i}).compute(e,n),i=s.create(e.words.slice(t),4*i),e.sigBytes=4*t,p.create({key:e,iv:i,salt:n})}},i.PasswordBasedCipher=m.extend({cfg:m.cfg.extend({kdf:t}),encrypt:function(e,t,i,n){return n=this.cfg.extend(n),i=n.kdf.execute(i,e.keySize,e.ivSize),n.iv=i.iv,e=m.encrypt.call(this,e,t,i.key,n),e.mixIn(i),e},decrypt:function(e,t,i,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),i=n.kdf.execute(i,e.keySize,e.ivSize,t.salt),n.iv=i.iv,m.decrypt.call(this,e,t,i.key,n)}}))}(),function(){for(var e=n,t=e.lib.BlockCipher,i=e.algo,r=[],s=[],o=[],a=[],c=[],d=[],l=[],h=[],u=[],p=[],m=[],f=0;256>f;f++)m[f]=128>f?f<<1:f<<1^283;var g=0,_=0;for(f=0;256>f;f++){var v=_^_<<1^_<<2^_<<3^_<<4;v=v>>>8^255&v^99;r[g]=v,s[v]=g;var y=m[g],E=m[y],S=m[E],b=257*m[v]^16843008*v;o[g]=b<<24|b>>>8,a[g]=b<<16|b>>>16,c[g]=b<<8|b>>>24,d[g]=b,b=16843009*S^65537*E^257*y^16843008*g,l[v]=b<<24|b>>>8,h[v]=b<<16|b>>>16,u[v]=b<<8|b>>>24,p[v]=b,g?(g=y^m[m[m[S^y]]],_^=m[m[_]]):g=_=1}var w=[0,1,2,4,8,16,32,64,128,27,54];i=i.AES=t.extend({_doReset:function(){for(var e=this._key,t=e.words,i=e.sigBytes/4,n=(e=4*((this._nRounds=i+6)+1),this._keySchedule=[]),s=0;s<e;s++)if(s<i)n[s]=t[s];else{var o=n[s-1];s%i?6<i&&4==s%i&&(o=r[o>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o]):(o=o<<8|o>>>24,o=r[o>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o],o^=w[s/i|0]<<24),n[s]=n[s-i]^o}for(t=this._invKeySchedule=[],i=0;i<e;i++)s=e-i,o=i%4?n[s]:n[s-4],t[i]=4>i||4>=s?o:l[r[o>>>24]]^h[r[o>>>16&255]]^u[r[o>>>8&255]]^p[r[255&o]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,d,r)},decryptBlock:function(e,t){var i=e[t+1];e[t+1]=e[t+3],e[t+3]=i,this._doCryptBlock(e,t,this._invKeySchedule,l,h,u,p,s),i=e[t+1],e[t+1]=e[t+3],e[t+3]=i},_doCryptBlock:function(e,t,i,n,r,s,o,a){for(var c=this._nRounds,d=e[t]^i[0],l=e[t+1]^i[1],h=e[t+2]^i[2],u=e[t+3]^i[3],p=4,m=1;m<c;m++){var f=n[d>>>24]^r[l>>>16&255]^s[h>>>8&255]^o[255&u]^i[p++],g=n[l>>>24]^r[h>>>16&255]^s[u>>>8&255]^o[255&d]^i[p++],_=n[h>>>24]^r[u>>>16&255]^s[d>>>8&255]^o[255&l]^i[p++];u=n[u>>>24]^r[d>>>16&255]^s[l>>>8&255]^o[255&h]^i[p++],d=f,l=g,h=_}f=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[h>>>8&255]<<8|a[255&u])^i[p++],g=(a[l>>>24]<<24|a[h>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^i[p++],_=(a[h>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^i[p++],u=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&h])^i[p++],e[t]=f,e[t+1]=g,e[t+2]=_,e[t+3]=u},keySize:8});e.AES=t._createHelper(i)}(),function(){function e(e,t){var i=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=i,this._lBlock^=i<<e}function t(e,t){var i=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=i,this._rBlock^=i<<e}var i=n,r=i.lib,s=r.WordArray,o=(r=r.BlockCipher,i.algo),a=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],c=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],d=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],h=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],u=o.DES=r.extend({_doReset:function(){for(var e=this._key.words,t=[],i=0;56>i;i++){var n=a[i]-1;t[i]=e[n>>>5]>>>31-n%32&1}for(e=this._subKeys=[],n=0;16>n;n++){var r=e[n]=[],s=d[n];for(i=0;24>i;i++)r[i/6|0]|=t[(c[i]-1+s)%28]<<31-i%6,r[4+(i/6|0)]|=t[28+(c[i+24]-1+s)%28]<<31-i%6;for(r[0]=r[0]<<1|r[0]>>>31,i=1;7>i;i++)r[i]>>>=4*(i-1)+3;r[7]=r[7]<<5|r[7]>>>27}for(t=this._invSubKeys=[],i=0;16>i;i++)t[i]=e[15-i]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(i,n,r){this._lBlock=i[n],this._rBlock=i[n+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var s=0;16>s;s++){for(var o=r[s],a=this._lBlock,c=this._rBlock,d=0,u=0;8>u;u++)d|=l[u][((c^o[u])&h[u])>>>0];this._lBlock=c,this._rBlock=a^d}r=this._lBlock,this._lBlock=this._rBlock,this._rBlock=r,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),i[n]=this._lBlock,i[n+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});i.DES=r._createHelper(u),o=o.TripleDES=r.extend({_doReset:function(){var e=this._key.words;this._des1=u.createEncryptor(s.create(e.slice(0,2))),this._des2=u.createEncryptor(s.create(e.slice(2,4))),this._des3=u.createEncryptor(s.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),i.TripleDES=r._createHelper(o)}(),function(){var e=n,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,i=e.sigBytes,n=this._map;e.clamp(),e=[];for(var r=0;r<i;r+=3)for(var s=(t[r>>>2]>>>24-r%4*8&255)<<16|(t[r+1>>>2]>>>24-(r+1)%4*8&255)<<8|t[r+2>>>2]>>>24-(r+2)%4*8&255,o=0;4>o&&r+.75*o<i;o++)e.push(n.charAt(s>>>6*(3-o)&63));if(t=n.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var i=e.length,n=this._map,r=n.charAt(64);r&&(r=e.indexOf(r),-1!=r&&(i=r));r=[];for(var s=0,o=0;o<i;o++)if(o%4){var a=n.indexOf(e.charAt(o-1))<<o%4*2,c=n.indexOf(e.charAt(o))>>>6-o%4*2;r[s>>>2]|=(a|c)<<24-s%4*8,s++}return t.create(r,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,i,n,r,s,o){return e=e+(t&i|~t&n)+r+o,(e<<s|e>>>32-s)+t}function i(e,t,i,n,r,s,o){return e=e+(t&n|i&~n)+r+o,(e<<s|e>>>32-s)+t}function r(e,t,i,n,r,s,o){return e=e+(t^i^n)+r+o,(e<<s|e>>>32-s)+t}function s(e,t,i,n,r,s,o){return e=e+(i^(t|~n))+r+o,(e<<s|e>>>32-s)+t}for(var o=n,a=o.lib,c=a.WordArray,d=a.Hasher,l=(a=o.algo,[]),h=0;64>h;h++)l[h]=4294967296*e.abs(e.sin(h+1))|0;a=a.MD5=d.extend({_doReset:function(){this._hash=new c.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,n){for(var o=0;16>o;o++){var a=n+o,c=e[a];e[a]=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8)}o=this._hash.words,a=e[n+0],c=e[n+1];var d=e[n+2],h=e[n+3],u=e[n+4],p=e[n+5],m=e[n+6],f=e[n+7],g=e[n+8],_=e[n+9],v=e[n+10],y=e[n+11],E=e[n+12],S=e[n+13],b=e[n+14],w=e[n+15],T=o[0],C=o[1],R=o[2],I=o[3];T=t(T,C,R,I,a,7,l[0]),I=t(I,T,C,R,c,12,l[1]),R=t(R,I,T,C,d,17,l[2]),C=t(C,R,I,T,h,22,l[3]),T=t(T,C,R,I,u,7,l[4]),I=t(I,T,C,R,p,12,l[5]),R=t(R,I,T,C,m,17,l[6]),C=t(C,R,I,T,f,22,l[7]),T=t(T,C,R,I,g,7,l[8]),I=t(I,T,C,R,_,12,l[9]),R=t(R,I,T,C,v,17,l[10]),C=t(C,R,I,T,y,22,l[11]),T=t(T,C,R,I,E,7,l[12]),I=t(I,T,C,R,S,12,l[13]),R=t(R,I,T,C,b,17,l[14]),C=t(C,R,I,T,w,22,l[15]),T=i(T,C,R,I,c,5,l[16]),I=i(I,T,C,R,m,9,l[17]),R=i(R,I,T,C,y,14,l[18]),C=i(C,R,I,T,a,20,l[19]),T=i(T,C,R,I,p,5,l[20]),I=i(I,T,C,R,v,9,l[21]),R=i(R,I,T,C,w,14,l[22]),C=i(C,R,I,T,u,20,l[23]),T=i(T,C,R,I,_,5,l[24]),I=i(I,T,C,R,b,9,l[25]),R=i(R,I,T,C,h,14,l[26]),C=i(C,R,I,T,g,20,l[27]),T=i(T,C,R,I,S,5,l[28]),I=i(I,T,C,R,d,9,l[29]),R=i(R,I,T,C,f,14,l[30]),C=i(C,R,I,T,E,20,l[31]),T=r(T,C,R,I,p,4,l[32]),I=r(I,T,C,R,g,11,l[33]),R=r(R,I,T,C,y,16,l[34]),C=r(C,R,I,T,b,23,l[35]),T=r(T,C,R,I,c,4,l[36]),I=r(I,T,C,R,u,11,l[37]),R=r(R,I,T,C,f,16,l[38]),C=r(C,R,I,T,v,23,l[39]),T=r(T,C,R,I,S,4,l[40]),I=r(I,T,C,R,a,11,l[41]),R=r(R,I,T,C,h,16,l[42]),C=r(C,R,I,T,m,23,l[43]),T=r(T,C,R,I,_,4,l[44]),I=r(I,T,C,R,E,11,l[45]),R=r(R,I,T,C,w,16,l[46]),C=r(C,R,I,T,d,23,l[47]),T=s(T,C,R,I,a,6,l[48]),I=s(I,T,C,R,f,10,l[49]),R=s(R,I,T,C,b,15,l[50]),C=s(C,R,I,T,p,21,l[51]),T=s(T,C,R,I,E,6,l[52]),I=s(I,T,C,R,h,10,l[53]),R=s(R,I,T,C,v,15,l[54]),C=s(C,R,I,T,c,21,l[55]),T=s(T,C,R,I,g,6,l[56]),I=s(I,T,C,R,w,10,l[57]),R=s(R,I,T,C,m,15,l[58]),C=s(C,R,I,T,S,21,l[59]),T=s(T,C,R,I,u,6,l[60]),I=s(I,T,C,R,y,10,l[61]),R=s(R,I,T,C,d,15,l[62]),C=s(C,R,I,T,_,21,l[63]);o[0]=o[0]+T|0,o[1]=o[1]+C|0,o[2]=o[2]+R|0,o[3]=o[3]+I|0},_doFinalize:function(){var t=this._data,i=t.words,n=8*this._nDataBytes,r=8*t.sigBytes;i[r>>>5]|=128<<24-r%32;var s=e.floor(n/4294967296);for(i[15+(r+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),i[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(i.length+1),this._process(),t=this._hash,i=t.words,n=0;4>n;n++)r=i[n],i[n]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8);return t},clone:function(){var e=d.clone.call(this);return e._hash=this._hash.clone(),e}}),o.MD5=d._createHelper(a),o.HmacMD5=d._createHmacHelper(a)}(Math),function(){var e=n,t=e.lib,i=t.WordArray,r=t.Hasher,s=[];t=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],r=i[1],o=i[2],a=i[3],c=i[4],d=0;80>d;d++){if(16>d)s[d]=0|e[t+d];else{var l=s[d-3]^s[d-8]^s[d-14]^s[d-16];s[d]=l<<1|l>>>31}l=(n<<5|n>>>27)+c+s[d],l=20>d?l+(1518500249+(r&o|~r&a)):40>d?l+(1859775393+(r^o^a)):60>d?l+((r&o|r&a|o&a)-1894007588):l+((r^o^a)-899497514),c=a,a=o,o=r<<30|r>>>2,r=n,n=l}i[0]=i[0]+n|0,i[1]=i[1]+r|0,i[2]=i[2]+o|0,i[3]=i[3]+a|0,i[4]=i[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(i/4294967296),t[15+(n+64>>>9<<4)]=i,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(t),e.HmacSHA1=r._createHmacHelper(t)}(),function(e){for(var t=n,i=t.lib,r=i.WordArray,s=i.Hasher,o=(i=t.algo,[]),a=[],c=function(e){return 4294967296*(e-(0|e))|0},d=2,l=0;64>l;){var h;e:{h=d;for(var u=e.sqrt(h),p=2;p<=u;p++)if(!(h%p)){h=!1;break e}h=!0}h&&(8>l&&(o[l]=c(e.pow(d,.5))),a[l]=c(e.pow(d,1/3)),l++),d++}var m=[];i=i.SHA256=s.extend({_doReset:function(){this._hash=new r.init(o.slice(0))},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],r=i[1],s=i[2],o=i[3],c=i[4],d=i[5],l=i[6],h=i[7],u=0;64>u;u++){if(16>u)m[u]=0|e[t+u];else{var p=m[u-15],f=m[u-2];m[u]=((p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3)+m[u-7]+((f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10)+m[u-16]}p=h+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&d^~c&l)+a[u]+m[u],f=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&r^n&s^r&s),h=l,l=d,d=c,c=o+p|0,o=s,s=r,r=n,n=p+f|0}i[0]=i[0]+n|0,i[1]=i[1]+r|0,i[2]=i[2]+s|0,i[3]=i[3]+o|0,i[4]=i[4]+c|0,i[5]=i[5]+d|0,i[6]=i[6]+l|0,i[7]=i[7]+h|0},_doFinalize:function(){var t=this._data,i=t.words,n=8*this._nDataBytes,r=8*t.sigBytes;return i[r>>>5]|=128<<24-r%32,i[14+(r+64>>>9<<4)]=e.floor(n/4294967296),i[15+(r+64>>>9<<4)]=n,t.sigBytes=4*i.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=s._createHelper(i),t.HmacSHA256=s._createHmacHelper(i)}(Math),function(){var e=n,t=e.lib.WordArray,i=e.algo,r=i.SHA256;i=i.SHA224=r.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=r._createHelper(i),e.HmacSHA224=r._createHmacHelper(i)}(),function(){function e(){return s.create.apply(s,arguments)}for(var t=n,i=t.lib.Hasher,r=t.x64,s=r.Word,o=r.WordArray,a=(r=t.algo,[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)]),c=[],d=0;80>d;d++)c[d]=e();r=r.SHA512=i.extend({_doReset:function(){this._hash=new o.init([new s.init(1779033703,4089235720),new s.init(3144134277,2227873595),new s.init(1013904242,4271175723),new s.init(2773480762,1595750129),new s.init(1359893119,2917565137),new s.init(2600822924,725511199),new s.init(528734635,4215389547),new s.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],r=i[1],s=i[2],o=i[3],d=i[4],l=i[5],h=i[6],u=(i=i[7],n.high),p=n.low,m=r.high,f=r.low,g=s.high,_=s.low,v=o.high,y=o.low,E=d.high,S=d.low,b=l.high,w=l.low,T=h.high,C=h.low,R=i.high,I=i.low,A=u,P=p,O=m,N=f,D=g,k=_,x=v,L=y,M=E,F=S,U=b,j=w,V=T,B=C,H=R,W=I,K=0;80>K;K++){var G=c[K];if(16>K)var q=G.high=0|e[t+2*K],z=G.low=0|e[t+2*K+1];else{q=c[K-15],z=q.high;var J=q.low,Y=(q=(z>>>1|J<<31)^(z>>>8|J<<24)^z>>>7,J=(J>>>1|z<<31)^(J>>>8|z<<24)^(J>>>7|z<<25),c[K-2]),X=(z=Y.high,Y.low),$=(Y=(z>>>19|X<<13)^(z<<3|X>>>29)^z>>>6,X=(X>>>19|z<<13)^(X<<3|z>>>29)^(X>>>6|z<<26),z=c[K-7],z.high),Q=c[K-16],Z=Q.high;Q=Q.low,z=J+z.low,q=q+$+(z>>>0<J>>>0?1:0),z=z+X,q=q+Y+(z>>>0<X>>>0?1:0),z=z+Q,q=q+Z+(z>>>0<Q>>>0?1:0);G.high=q,G.low=z}$=M&U^~M&V,Q=F&j^~F&B,G=A&O^A&D^O&D;var ee=P&N^P&k^N&k,te=(J=(A>>>28|P<<4)^(A<<30|P>>>2)^(A<<25|P>>>7),Y=(P>>>28|A<<4)^(P<<30|A>>>2)^(P<<25|A>>>7),X=a[K],X.high),ie=X.low;X=W+((F>>>14|M<<18)^(F>>>18|M<<14)^(F<<23|M>>>9)),Z=H+((M>>>14|F<<18)^(M>>>18|F<<14)^(M<<23|F>>>9))+(X>>>0<W>>>0?1:0),X=X+Q,Z=Z+$+(X>>>0<Q>>>0?1:0),X=X+ie,Z=Z+te+(X>>>0<ie>>>0?1:0),X=X+z,Z=Z+q+(X>>>0<z>>>0?1:0),z=Y+ee,G=J+G+(z>>>0<Y>>>0?1:0),H=V,W=B,V=U,B=j,U=M,j=F,F=L+X|0,M=x+Z+(F>>>0<L>>>0?1:0)|0,x=D,L=k,D=O,k=N,O=A,N=P,P=X+z|0,A=Z+G+(P>>>0<X>>>0?1:0)|0}p=n.low=p+P,n.high=u+A+(p>>>0<P>>>0?1:0),f=r.low=f+N,r.high=m+O+(f>>>0<N>>>0?1:0),_=s.low=_+k,s.high=g+D+(_>>>0<k>>>0?1:0),y=o.low=y+L,o.high=v+x+(y>>>0<L>>>0?1:0),S=d.low=S+F,d.high=E+M+(S>>>0<F>>>0?1:0),w=l.low=w+j,l.high=b+U+(w>>>0<j>>>0?1:0),C=h.low=C+B,h.high=T+V+(C>>>0<B>>>0?1:0),I=i.low=I+W,i.high=R+H+(I>>>0<W>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(i/4294967296),t[31+(n+128>>>10<<5)]=i,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=i._createHelper(r),t.HmacSHA512=i._createHmacHelper(r)}(),function(){var e=n,t=e.x64,i=t.Word,r=t.WordArray,s=(t=e.algo,t.SHA512);t=t.SHA384=s.extend({_doReset:function(){this._hash=new r.init([new i.init(3418070365,3238371032),new i.init(1654270250,914150663),new i.init(2438529370,812702999),new i.init(355462360,4144912697),new i.init(1731405415,4290775857),new i.init(2394180231,1750603025),new i.init(3675008525,1694076839),new i.init(1203062813,3204075428)])},_doFinalize:function(){var e=s._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=s._createHelper(t),e.HmacSHA384=s._createHmacHelper(t)}(),function(){var e=n,t=e.lib,i=t.WordArray,r=t.Hasher,s=(t=e.algo,i.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13])),o=i.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),a=i.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),c=i.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),d=i.create([0,1518500249,1859775393,2400959708,2840853838]),l=i.create([1352829926,1548603684,1836072691,2053994217,0]);t=t.RIPEMD160=r.extend({_doReset:function(){this._hash=i.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=0;16>i;i++){var n=t+i,r=e[n];e[n]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}n=this._hash.words,r=d.words;var h,u,p,m,f,g,_,v,y,E,S=l.words,b=s.words,w=o.words,T=a.words,C=c.words;g=h=n[0],_=u=n[1],v=p=n[2],y=m=n[3],E=f=n[4];var R;for(i=0;80>i;i+=1)R=h+e[t+b[i]]|0,R=16>i?R+((u^p^m)+r[0]):32>i?R+((u&p|~u&m)+r[1]):48>i?R+(((u|~p)^m)+r[2]):64>i?R+((u&m|p&~m)+r[3]):R+((u^(p|~m))+r[4]),R|=0,R=R<<T[i]|R>>>32-T[i],R=R+f|0,h=f,f=m,m=p<<10|p>>>22,p=u,u=R,R=g+e[t+w[i]]|0,R=16>i?R+((_^(v|~y))+S[0]):32>i?R+((_&y|v&~y)+S[1]):48>i?R+(((_|~v)^y)+S[2]):64>i?R+((_&v|~_&y)+S[3]):R+((_^v^y)+S[4]),R|=0,R=R<<C[i]|R>>>32-C[i],R=R+E|0,g=E,E=y,y=v<<10|v>>>22,v=_,_=R;R=n[1]+p+y|0,n[1]=n[2]+m+E|0,n[2]=n[3]+f+g|0,n[3]=n[4]+h+_|0,n[4]=n[0]+u+v|0,n[0]=R},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;for(t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),e.sigBytes=4*(t.length+1),this._process(),e=this._hash,t=e.words,i=0;5>i;i++)n=t[i],t[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8);return e},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=r._createHelper(t),e.HmacRIPEMD160=r._createHmacHelper(t)}(Math),function(){var e=n,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,i){e=this._hasher=new e.init,"string"==typeof i&&(i=t.parse(i));var n=e.blockSize,r=4*n;i.sigBytes>r&&(i=e.finalize(i)),i.clamp();for(var s=this._oKey=i.clone(),o=this._iKey=i.clone(),a=s.words,c=o.words,d=0;d<n;d++)a[d]^=1549556828,c[d]^=909522486;s.sigBytes=o.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e=n,t=e.lib,i=t.Base,r=t.WordArray,s=(t=e.algo,t.HMAC),o=t.PBKDF2=i.extend({cfg:i.extend({keySize:4,hasher:t.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var i=this.cfg,n=s.create(i.hasher,e),o=r.create(),a=r.create([1]),c=o.words,d=a.words,l=i.keySize;for(i=i.iterations;c.length<l;){var h=n.update(t).finalize(a);n.reset();for(var u=h.words,p=u.length,m=h,f=1;f<i;f++){m=n.finalize(m),n.reset();for(var g=m.words,_=0;_<p;_++)u[_]^=g[_]}o.concat(h),d[0]++}return o.sigBytes=4*l,o}});e.PBKDF2=function(e,t,i){return o.create(i).compute(e,t)}}();var r,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="=";function a(e){var t,i,n="";for(t=0;t+3<=e.length;t+=3)i=parseInt(e.substring(t,t+3),16),n+=s.charAt(i>>6)+s.charAt(63&i);if(t+1==e.length?(i=parseInt(e.substring(t,t+1),16),n+=s.charAt(i<<2)):t+2==e.length&&(i=parseInt(e.substring(t,t+2),16),n+=s.charAt(i>>2)+s.charAt((3&i)<<4)),o)while((3&n.length)>0)n+=o;return n}function c(e){var t,i,n,r="",a=0;for(t=0;t<e.length;++t){if(e.charAt(t)==o)break;n=s.indexOf(e.charAt(t)),n<0||(0==a?(r+=b(n>>2),i=3&n,a=1):1==a?(r+=b(i<<2|n>>4),i=15&n,a=2):2==a?(r+=b(i),r+=b(n>>2),i=3&n,a=3):(r+=b(i<<2|n>>4),r+=b(15&n),a=0))}return 1==a&&(r+=b(i<<2)),r}function d(e){var t,i=c(e),n=new Array;for(t=0;2*t<i.length;++t)n[t]=parseInt(i.substring(2*t,2*t+2),16);return n}var l=0xdeadbeefcafe,h=15715070==(16777215&l);function u(e,t,i){null!=e&&("number"==typeof e?this.fromNumber(e,t,i):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function p(){return new u(null)}function m(e,t,i,n,r,s){while(--s>=0){var o=t*this[e++]+i[n]+r;r=Math.floor(o/67108864),i[n++]=67108863&o}return r}function f(e,t,i,n,r,s){var o=32767&t,a=t>>15;while(--s>=0){var c=32767&this[e],d=this[e++]>>15,l=a*c+d*o;c=o*c+((32767&l)<<15)+i[n]+(1073741823&r),r=(c>>>30)+(l>>>15)+a*d+(r>>>30),i[n++]=1073741823&c}return r}function g(e,t,i,n,r,s){var o=16383&t,a=t>>14;while(--s>=0){var c=16383&this[e],d=this[e++]>>14,l=a*c+d*o;c=o*c+((16383&l)<<14)+i[n]+r,r=(c>>28)+(l>>14)+a*d,i[n++]=268435455&c}return r}h&&"Microsoft Internet Explorer"==t.appName?(u.prototype.am=f,r=30):h&&"Netscape"!=t.appName?(u.prototype.am=m,r=26):(u.prototype.am=g,r=28),u.prototype.DB=r,u.prototype.DM=(1<<r)-1,u.prototype.DV=1<<r;var _=52;u.prototype.FV=Math.pow(2,_),u.prototype.F1=_-r,u.prototype.F2=2*r-_;var v,y,E="0123456789abcdefghijklmnopqrstuvwxyz",S=new Array;for(v="0".charCodeAt(0),y=0;y<=9;++y)S[v++]=y;for(v="a".charCodeAt(0),y=10;y<36;++y)S[v++]=y;for(v="A".charCodeAt(0),y=10;y<36;++y)S[v++]=y;function b(e){return E.charAt(e)}function T(e,t){var i=S[e.charCodeAt(t)];return null==i?-1:i}function C(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function R(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0}function I(e){var t=p();return t.fromInt(e),t}function A(e,t){var i;if(16==t)i=4;else if(8==t)i=3;else if(256==t)i=8;else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return void this.fromRadix(e,t);i=2}this.t=0,this.s=0;var n=e.length,r=!1,s=0;while(--n>=0){var o=8==i?255&e[n]:T(e,n);o<0?"-"==e.charAt(n)&&(r=!0):(r=!1,0==s?this[this.t++]=o:s+i>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,s+=i,s>=this.DB&&(s-=this.DB))}8==i&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),r&&u.ZERO.subTo(this,this)}function P(){var e=this.s&this.DM;while(this.t>0&&this[this.t-1]==e)--this.t}function O(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var i,n=(1<<t)-1,r=!1,s="",o=this.t,a=this.DB-o*this.DB%t;if(o-- >0){a<this.DB&&(i=this[o]>>a)>0&&(r=!0,s=b(i));while(o>=0)a<t?(i=(this[o]&(1<<a)-1)<<t-a,i|=this[--o]>>(a+=this.DB-t)):(i=this[o]>>(a-=t)&n,a<=0&&(a+=this.DB,--o)),i>0&&(r=!0),r&&(s+=b(i))}return r?s:"0"}function N(){var e=p();return u.ZERO.subTo(this,e),e}function D(){return this.s<0?this.negate():this}function k(e){var t=this.s-e.s;if(0!=t)return t;var i=this.t;if(t=i-e.t,0!=t)return this.s<0?-t:t;while(--i>=0)if(0!=(t=this[i]-e[i]))return t;return 0}function x(e){var t,i=1;return 0!=(t=e>>>16)&&(e=t,i+=16),0!=(t=e>>8)&&(e=t,i+=8),0!=(t=e>>4)&&(e=t,i+=4),0!=(t=e>>2)&&(e=t,i+=2),0!=(t=e>>1)&&(e=t,i+=1),i}function L(){return this.t<=0?0:this.DB*(this.t-1)+x(this[this.t-1]^this.s&this.DM)}function M(e,t){var i;for(i=this.t-1;i>=0;--i)t[i+e]=this[i];for(i=e-1;i>=0;--i)t[i]=0;t.t=this.t+e,t.s=this.s}function F(e,t){for(var i=e;i<this.t;++i)t[i-e]=this[i];t.t=Math.max(this.t-e,0),t.s=this.s}function U(e,t){var i,n=e%this.DB,r=this.DB-n,s=(1<<r)-1,o=Math.floor(e/this.DB),a=this.s<<n&this.DM;for(i=this.t-1;i>=0;--i)t[i+o+1]=this[i]>>r|a,a=(this[i]&s)<<n;for(i=o-1;i>=0;--i)t[i]=0;t[o]=a,t.t=this.t+o+1,t.s=this.s,t.clamp()}function j(e,t){t.s=this.s;var i=Math.floor(e/this.DB);if(i>=this.t)t.t=0;else{var n=e%this.DB,r=this.DB-n,s=(1<<n)-1;t[0]=this[i]>>n;for(var o=i+1;o<this.t;++o)t[o-i-1]|=(this[o]&s)<<r,t[o-i]=this[o]>>n;n>0&&(t[this.t-i-1]|=(this.s&s)<<r),t.t=this.t-i,t.clamp()}}function V(e,t){var i=0,n=0,r=Math.min(e.t,this.t);while(i<r)n+=this[i]-e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){n-=e.s;while(i<this.t)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{n+=this.s;while(i<e.t)n-=e[i],t[i++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[i++]=this.DV+n:n>0&&(t[i++]=n),t.t=i,t.clamp()}function B(e,t){var i=this.abs(),n=e.abs(),r=i.t;t.t=r+n.t;while(--r>=0)t[r]=0;for(r=0;r<n.t;++r)t[r+i.t]=i.am(0,n[r],t,r,0,i.t);t.s=0,t.clamp(),this.s!=e.s&&u.ZERO.subTo(t,t)}function H(e){var t=this.abs(),i=e.t=2*t.t;while(--i>=0)e[i]=0;for(i=0;i<t.t-1;++i){var n=t.am(i,t[i],e,2*i,0,1);(e[i+t.t]+=t.am(i+1,2*t[i],e,2*i+1,n,t.t-i-1))>=t.DV&&(e[i+t.t]-=t.DV,e[i+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(i,t[i],e,2*i,0,1)),e.s=0,e.clamp()}function W(e,t,i){var n=e.abs();if(!(n.t<=0)){var r=this.abs();if(r.t<n.t)return null!=t&&t.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=p());var s=p(),o=this.s,a=e.s,c=this.DB-x(n[n.t-1]);c>0?(n.lShiftTo(c,s),r.lShiftTo(c,i)):(n.copyTo(s),r.copyTo(i));var d=s.t,l=s[d-1];if(0!=l){var h=l*(1<<this.F1)+(d>1?s[d-2]>>this.F2:0),m=this.FV/h,f=(1<<this.F1)/h,g=1<<this.F2,_=i.t,v=_-d,y=null==t?p():t;s.dlShiftTo(v,y),i.compareTo(y)>=0&&(i[i.t++]=1,i.subTo(y,i)),u.ONE.dlShiftTo(d,y),y.subTo(s,s);while(s.t<d)s[s.t++]=0;while(--v>=0){var E=i[--_]==l?this.DM:Math.floor(i[_]*m+(i[_-1]+g)*f);if((i[_]+=s.am(0,E,i,v,0,d))<E){s.dlShiftTo(v,y),i.subTo(y,i);while(i[_]<--E)i.subTo(y,i)}}null!=t&&(i.drShiftTo(d,t),o!=a&&u.ZERO.subTo(t,t)),i.t=d,i.clamp(),c>0&&i.rShiftTo(c,i),o<0&&u.ZERO.subTo(i,i)}}}function K(e){var t=p();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(u.ZERO)>0&&e.subTo(t,t),t}function G(e){this.m=e}function q(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function z(e){return e}function J(e){e.divRemTo(this.m,null,e)}function Y(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function X(e,t){e.squareTo(t),this.reduce(t)}function $(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return t=t*(2-(15&e)*t)&15,t=t*(2-(255&e)*t)&255,t=t*(2-((65535&e)*t&65535))&65535,t=t*(2-e*t%this.DV)%this.DV,t>0?this.DV-t:-t}function Q(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function Z(e){var t=p();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(u.ZERO)>0&&this.m.subTo(t,t),t}function ee(e){var t=p();return e.copyTo(t),this.reduce(t),t}function te(e){while(e.t<=this.mt2)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var i=32767&e[t],n=i*this.mpl+((i*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;i=t+this.m.t,e[i]+=this.m.am(0,n,e,t,0,this.m.t);while(e[i]>=e.DV)e[i]-=e.DV,e[++i]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function ie(e,t){e.squareTo(t),this.reduce(t)}function ne(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function re(){return 0==(this.t>0?1&this[0]:this.s)}function se(e,t){if(e>4294967295||e<1)return u.ONE;var i=p(),n=p(),r=t.convert(this),s=x(e)-1;r.copyTo(i);while(--s>=0)if(t.sqrTo(i,n),(e&1<<s)>0)t.mulTo(n,r,i);else{var o=i;i=n,n=o}return t.revert(i)}function oe(e,t){var i;return i=e<256||t.isEven()?new G(t):new Q(t),this.exp(e,i)}function ae(){var e=p();return this.copyTo(e),e}function ce(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function de(){return 0==this.t?this.s:this[0]<<24>>24}function le(){return 0==this.t?this.s:this[0]<<16>>16}function he(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function ue(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function pe(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),i=Math.pow(e,t),n=I(i),r=p(),s=p(),o="";this.divRemTo(n,r,s);while(r.signum()>0)o=(i+s.intValue()).toString(e).substr(1)+o,r.divRemTo(n,r,s);return s.intValue().toString(e)+o}function me(e,t){this.fromInt(0),null==t&&(t=10);for(var i=this.chunkSize(t),n=Math.pow(t,i),r=!1,s=0,o=0,a=0;a<e.length;++a){var c=T(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(r=!0):(o=t*o+c,++s>=i&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),r&&u.ZERO.subTo(this,this)}function fe(e,t,i){if("number"==typeof t)if(e<2)this.fromInt(1);else{this.fromNumber(e,i),this.testBit(e-1)||this.bitwiseTo(u.ONE.shiftLeft(e-1),we,this),this.isEven()&&this.dAddOffset(1,0);while(!this.isProbablePrime(t))this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(u.ONE.shiftLeft(e-1),this)}else{var n=new Array,r=7&e;n.length=1+(e>>3),t.nextBytes(n),r>0?n[0]&=(1<<r)-1:n[0]=0,this.fromString(n,256)}}function ge(){var e=this.t,t=new Array;t[0]=this.s;var i,n=this.DB-e*this.DB%8,r=0;if(e-- >0){n<this.DB&&(i=this[e]>>n)!=(this.s&this.DM)>>n&&(t[r++]=i|this.s<<this.DB-n);while(e>=0)n<8?(i=(this[e]&(1<<n)-1)<<8-n,i|=this[--e]>>(n+=this.DB-8)):(i=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),0!=(128&i)&&(i|=-256),0==r&&(128&this.s)!=(128&i)&&++r,(r>0||i!=this.s)&&(t[r++]=i)}return t}function _e(e){return 0==this.compareTo(e)}function ve(e){return this.compareTo(e)<0?this:e}function ye(e){return this.compareTo(e)>0?this:e}function Ee(e,t,i){var n,r,s=Math.min(e.t,this.t);for(n=0;n<s;++n)i[n]=t(this[n],e[n]);if(e.t<this.t){for(r=e.s&this.DM,n=s;n<this.t;++n)i[n]=t(this[n],r);i.t=this.t}else{for(r=this.s&this.DM,n=s;n<e.t;++n)i[n]=t(r,e[n]);i.t=e.t}i.s=t(this.s,e.s),i.clamp()}function Se(e,t){return e&t}function be(e){var t=p();return this.bitwiseTo(e,Se,t),t}function we(e,t){return e|t}function Te(e){var t=p();return this.bitwiseTo(e,we,t),t}function Ce(e,t){return e^t}function Re(e){var t=p();return this.bitwiseTo(e,Ce,t),t}function Ie(e,t){return e&~t}function Ae(e){var t=p();return this.bitwiseTo(e,Ie,t),t}function Pe(){for(var e=p(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e}function Oe(e){var t=p();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function Ne(e){var t=p();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function De(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function ke(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+De(this[e]);return this.s<0?this.t*this.DB:-1}function xe(e){var t=0;while(0!=e)e&=e-1,++t;return t}function Le(){for(var e=0,t=this.s&this.DM,i=0;i<this.t;++i)e+=xe(this[i]^t);return e}function Me(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)}function Fe(e,t){var i=u.ONE.shiftLeft(e);return this.bitwiseTo(i,t,i),i}function Ue(e){return this.changeBit(e,we)}function je(e){return this.changeBit(e,Ie)}function Ve(e){return this.changeBit(e,Ce)}function Be(e,t){var i=0,n=0,r=Math.min(e.t,this.t);while(i<r)n+=this[i]+e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){n+=e.s;while(i<this.t)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{n+=this.s;while(i<e.t)n+=e[i],t[i++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[i++]=n:n<-1&&(t[i++]=this.DV+n),t.t=i,t.clamp()}function He(e){var t=p();return this.addTo(e,t),t}function We(e){var t=p();return this.subTo(e,t),t}function Ke(e){var t=p();return this.multiplyTo(e,t),t}function Ge(){var e=p();return this.squareTo(e),e}function qe(e){var t=p();return this.divRemTo(e,t,null),t}function ze(e){var t=p();return this.divRemTo(e,null,t),t}function Je(e){var t=p(),i=p();return this.divRemTo(e,t,i),new Array(t,i)}function Ye(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function Xe(e,t){if(0!=e){while(this.t<=t)this[this.t++]=0;this[t]+=e;while(this[t]>=this.DV)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}}function $e(){}function Qe(e){return e}function Ze(e,t,i){e.multiplyTo(t,i)}function et(e,t){e.squareTo(t)}function tt(e){return this.exp(e,new $e)}function it(e,t,i){var n,r=Math.min(this.t+e.t,t);i.s=0,i.t=r;while(r>0)i[--r]=0;for(n=i.t-this.t;r<n;++r)i[r+this.t]=this.am(0,e[r],i,r,0,this.t);for(n=Math.min(e.t,t);r<n;++r)this.am(0,e[r],i,r,0,t-r);i.clamp()}function nt(e,t,i){--t;var n=i.t=this.t+e.t-t;i.s=0;while(--n>=0)i[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)i[this.t+n-t]=this.am(t-n,e[n],i,0,0,this.t+n-t);i.clamp(),i.drShiftTo(1,i)}function rt(e){this.r2=p(),this.q3=p(),u.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function st(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=p();return e.copyTo(t),this.reduce(t),t}function ot(e){return e}function at(e){e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);while(e.compareTo(this.r2)<0)e.dAddOffset(1,this.m.t+1);e.subTo(this.r2,e);while(e.compareTo(this.m)>=0)e.subTo(this.m,e)}function ct(e,t){e.squareTo(t),this.reduce(t)}function dt(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function lt(e,t){var i,n,r=e.bitLength(),s=I(1);if(r<=0)return s;i=r<18?1:r<48?3:r<144?4:r<768?5:6,n=r<8?new G(t):t.isEven()?new rt(t):new Q(t);var o=new Array,a=3,c=i-1,d=(1<<i)-1;if(o[1]=n.convert(this),i>1){var l=p();n.sqrTo(o[1],l);while(a<=d)o[a]=p(),n.mulTo(l,o[a-2],o[a]),a+=2}var h,u,m=e.t-1,f=!0,g=p();r=x(e[m])-1;while(m>=0){r>=c?h=e[m]>>r-c&d:(h=(e[m]&(1<<r+1)-1)<<c-r,m>0&&(h|=e[m-1]>>this.DB+r-c)),a=i;while(0==(1&h))h>>=1,--a;if((r-=a)<0&&(r+=this.DB,--m),f)o[h].copyTo(s),f=!1;else{while(a>1)n.sqrTo(s,g),n.sqrTo(g,s),a-=2;a>0?n.sqrTo(s,g):(u=s,s=g,g=u),n.mulTo(g,o[h],s)}while(m>=0&&0==(e[m]&1<<r))n.sqrTo(s,g),u=s,s=g,g=u,--r<0&&(r=this.DB-1,--m)}return n.revert(s)}function ht(e){var t=this.s<0?this.negate():this.clone(),i=e.s<0?e.negate():e.clone();if(t.compareTo(i)<0){var n=t;t=i,i=n}var r=t.getLowestSetBit(),s=i.getLowestSetBit();if(s<0)return t;r<s&&(s=r),s>0&&(t.rShiftTo(s,t),i.rShiftTo(s,i));while(t.signum()>0)(r=t.getLowestSetBit())>0&&t.rShiftTo(r,t),(r=i.getLowestSetBit())>0&&i.rShiftTo(r,i),t.compareTo(i)>=0?(t.subTo(i,t),t.rShiftTo(1,t)):(i.subTo(t,i),i.rShiftTo(1,i));return s>0&&i.lShiftTo(s,i),i}function ut(e){if(e<=0)return 0;var t=this.DV%e,i=this.s<0?e-1:0;if(this.t>0)if(0==t)i=this[0]%e;else for(var n=this.t-1;n>=0;--n)i=(t*i+this[n])%e;return i}function pt(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return u.ZERO;var i=e.clone(),n=this.clone(),r=I(1),s=I(0),o=I(0),a=I(1);while(0!=i.signum()){while(i.isEven())i.rShiftTo(1,i),t?(r.isEven()&&s.isEven()||(r.addTo(this,r),s.subTo(e,s)),r.rShiftTo(1,r)):s.isEven()||s.subTo(e,s),s.rShiftTo(1,s);while(n.isEven())n.rShiftTo(1,n),t?(o.isEven()&&a.isEven()||(o.addTo(this,o),a.subTo(e,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);i.compareTo(n)>=0?(i.subTo(n,i),t&&r.subTo(o,r),s.subTo(a,s)):(n.subTo(i,n),t&&o.subTo(r,o),a.subTo(s,a))}return 0!=n.compareTo(u.ONE)?u.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a}G.prototype.convert=q,G.prototype.revert=z,G.prototype.reduce=J,G.prototype.mulTo=Y,G.prototype.sqrTo=X,Q.prototype.convert=Z,Q.prototype.revert=ee,Q.prototype.reduce=te,Q.prototype.mulTo=ne,Q.prototype.sqrTo=ie,u.prototype.copyTo=C,u.prototype.fromInt=R,u.prototype.fromString=A,u.prototype.clamp=P,u.prototype.dlShiftTo=M,u.prototype.drShiftTo=F,u.prototype.lShiftTo=U,u.prototype.rShiftTo=j,u.prototype.subTo=V,u.prototype.multiplyTo=B,u.prototype.squareTo=H,u.prototype.divRemTo=W,u.prototype.invDigit=$,u.prototype.isEven=re,u.prototype.exp=se,u.prototype.toString=O,u.prototype.negate=N,u.prototype.abs=D,u.prototype.compareTo=k,u.prototype.bitLength=L,u.prototype.mod=K,u.prototype.modPowInt=oe,u.ZERO=I(0),u.ONE=I(1),$e.prototype.convert=Qe,$e.prototype.revert=Qe,$e.prototype.mulTo=Ze,$e.prototype.sqrTo=et,rt.prototype.convert=st,rt.prototype.revert=ot,rt.prototype.reduce=at,rt.prototype.mulTo=dt,rt.prototype.sqrTo=ct;var mt=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],ft=(1<<26)/mt[mt.length-1];function gt(e){var t,i=this.abs();if(1==i.t&&i[0]<=mt[mt.length-1]){for(t=0;t<mt.length;++t)if(i[0]==mt[t])return!0;return!1}if(i.isEven())return!1;t=1;while(t<mt.length){var n=mt[t],r=t+1;while(r<mt.length&&n<ft)n*=mt[r++];n=i.modInt(n);while(t<r)if(n%mt[t++]==0)return!1}return i.millerRabin(e)}function _t(e){var t=this.subtract(u.ONE),i=t.getLowestSetBit();if(i<=0)return!1;var n=t.shiftRight(i);e=e+1>>1,e>mt.length&&(e=mt.length);for(var r=p(),s=0;s<e;++s){r.fromInt(mt[Math.floor(Math.random()*mt.length)]);var o=r.modPow(n,this);if(0!=o.compareTo(u.ONE)&&0!=o.compareTo(t)){var a=1;while(a++<i&&0!=o.compareTo(t))if(o=o.modPowInt(2,this),0==o.compareTo(u.ONE))return!1;if(0!=o.compareTo(t))return!1}}return!0}function vt(){this.i=0,this.j=0,this.S=new Array}function yt(e){var t,i,n;for(t=0;t<256;++t)this.S[t]=t;for(i=0,t=0;t<256;++t)i=i+this.S[t]+e[t%e.length]&255,n=this.S[t],this.S[t]=this.S[i],this.S[i]=n;this.i=0,this.j=0}function Et(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}function St(){return new vt}u.prototype.chunkSize=he,u.prototype.toRadix=pe,u.prototype.fromRadix=me,u.prototype.fromNumber=fe,u.prototype.bitwiseTo=Ee,u.prototype.changeBit=Fe,u.prototype.addTo=Be,u.prototype.dMultiply=Ye,u.prototype.dAddOffset=Xe,u.prototype.multiplyLowerTo=it,u.prototype.multiplyUpperTo=nt,u.prototype.modInt=ut,u.prototype.millerRabin=_t,u.prototype.clone=ae,u.prototype.intValue=ce,u.prototype.byteValue=de,u.prototype.shortValue=le,u.prototype.signum=ue,u.prototype.toByteArray=ge,u.prototype.equals=_e,u.prototype.min=ve,u.prototype.max=ye,u.prototype.and=be,u.prototype.or=Te,u.prototype.xor=Re,u.prototype.andNot=Ae,u.prototype.not=Pe,u.prototype.shiftLeft=Oe,u.prototype.shiftRight=Ne,u.prototype.getLowestSetBit=ke,u.prototype.bitCount=Le,u.prototype.testBit=Me,u.prototype.setBit=Ue,u.prototype.clearBit=je,u.prototype.flipBit=Ve,u.prototype.add=He,u.prototype.subtract=We,u.prototype.multiply=Ke,u.prototype.divide=qe,u.prototype.remainder=ze,u.prototype.divideAndRemainder=Je,u.prototype.modPow=lt,u.prototype.modInverse=pt,u.prototype.pow=tt,u.prototype.gcd=ht,u.prototype.isProbablePrime=gt,u.prototype.square=Ge,vt.prototype.init=yt,vt.prototype.next=Et;var bt,wt,Tt,Ct,Rt,It,At,Pt=256;function Ot(e){wt[Tt++]^=255&e,wt[Tt++]^=e>>8&255,wt[Tt++]^=e>>16&255,wt[Tt++]^=e>>24&255,Tt>=Pt&&(Tt-=Pt)}function Nt(){Ot((new Date).getTime())}if(null==wt){if(wt=new Array,Tt=0,void 0!==i&&(void 0!==i.crypto||void 0!==i.msCrypto))if(Rt=i.crypto||i.msCrypto,Rt.getRandomValues)for(It=new Uint8Array(32),Rt.getRandomValues(It),Ct=0;Ct<32;++Ct)wt[Tt++]=It[Ct];else if("Netscape"==t.appName&&t.appVersion<"5")for(At=i.crypto.random(32),Ct=0;Ct<At.length;++Ct)wt[Tt++]=255&At.charCodeAt(Ct);while(Tt<Pt)Ct=Math.floor(65536*Math.random()),wt[Tt++]=Ct>>>8,wt[Tt++]=255&Ct;Tt=0,Nt()}function Dt(){if(null==bt){for(Nt(),bt=St(),bt.init(wt),Tt=0;Tt<wt.length;++Tt)wt[Tt]=0;Tt=0}return bt.next()}function kt(e){var t;for(t=0;t<e.length;++t)e[t]=Dt()}function xt(){}function Lt(e,t){return new u(e,t)}function Mt(e,t){if(t<e.length+11)throw"Message too long for RSA";var i=new Array,n=e.length-1;while(n>=0&&t>0){var r=e.charCodeAt(n--);r<128?i[--t]=r:r>127&&r<2048?(i[--t]=63&r|128,i[--t]=r>>6|192):(i[--t]=63&r|128,i[--t]=r>>6&63|128,i[--t]=r>>12|224)}i[--t]=0;var s=new xt,o=new Array;while(t>2){o[0]=0;while(0==o[0])s.nextBytes(o);i[--t]=o[0]}return i[--t]=2,i[--t]=0,new u(i)}function Ft(e,t,i){var n="",r=0;while(n.length<t)n+=i(String.fromCharCode.apply(String,e.concat([(4278190080&r)>>24,(16711680&r)>>16,(65280&r)>>8,255&r]))),r+=1;return n}function Ut(e,t,i,n){var r=Ii.crypto.MessageDigest,s=Ii.crypto.Util,o=null;if(i||(i="sha1"),"string"===typeof i&&(o=r.getCanonicalAlgName(i),n=r.getHashLength(o),i=function(e){return Ji(s.hashHex(Yi(e),o))}),e.length+2*n+2>t)throw"Message too long for RSA";var a,c="";for(a=0;a<t-e.length-2*n-2;a+=1)c+="\0";var d=i("")+c+""+e,l=new Array(n);(new xt).nextBytes(l);var h=Ft(l,d.length,i),p=[];for(a=0;a<d.length;a+=1)p[a]=d.charCodeAt(a)^h.charCodeAt(a);var m=Ft(p,l.length,i),f=[0];for(a=0;a<l.length;a+=1)f[a+1]=l[a]^m.charCodeAt(a);return new u(f.concat(p))}function jt(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function Vt(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!==typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=Lt(e,16),this.e=parseInt(t,16)}}function Bt(e){return e.modPowInt(this.e,this.n)}function Ht(e){var t=Mt(e,this.n.bitLength()+7>>3);if(null==t)return null;var i=this.doPublic(t);if(null==i)return null;var n=i.toString(16);return 0==(1&n.length)?n:"0"+n}function Wt(e,t,i){var n=Ut(e,this.n.bitLength()+7>>3,t,i);if(null==n)return null;var r=this.doPublic(n);if(null==r)return null;var s=r.toString(16);return 0==(1&s.length)?s:"0"+s}function Kt(e,t){var i=e.toByteArray(),n=0;while(n<i.length&&0==i[n])++n;if(i.length-n!=t-1||2!=i[n])return null;++n;while(0!=i[n])if(++n>=i.length)return null;var r="";while(++n<i.length){var s=255&i[n];s<128?r+=String.fromCharCode(s):s>191&&s<224?(r+=String.fromCharCode((31&s)<<6|63&i[n+1]),++n):(r+=String.fromCharCode((15&s)<<12|(63&i[n+1])<<6|63&i[n+2]),n+=2)}return r}function Gt(e,t,i){var n="",r=0;while(n.length<t)n+=i(e+String.fromCharCode.apply(String,[(4278190080&r)>>24,(16711680&r)>>16,(65280&r)>>8,255&r])),r+=1;return n}function qt(e,t,i,n){var r=Ii.crypto.MessageDigest,s=Ii.crypto.Util,o=null;for(i||(i="sha1"),"string"===typeof i&&(o=r.getCanonicalAlgName(i),n=r.getHashLength(o),i=function(e){return Ji(s.hashHex(Yi(e),o))}),e=e.toByteArray(),a=0;a<e.length;a+=1)e[a]&=255;while(e.length<t)e.unshift(0);if(e=String.fromCharCode.apply(String,e),e.length<2*n+2)throw"Cipher too short";var a,c=e.substr(1,n),d=e.substr(n+1),l=Gt(d,n,i),h=[];for(a=0;a<c.length;a+=1)h[a]=c.charCodeAt(a)^l.charCodeAt(a);var u=Gt(String.fromCharCode.apply(String,h),e.length-n,i),p=[];for(a=0;a<d.length;a+=1)p[a]=d.charCodeAt(a)^u.charCodeAt(a);if(p=String.fromCharCode.apply(String,p),p.substr(0,n)!==i(""))throw"Hash mismatch";p=p.substr(n);var m=p.indexOf(""),f=-1!=m?p.substr(0,m).lastIndexOf("\0"):-1;if(f+1!=m)throw"Malformed data";return p.substr(m+1)}function zt(e,t,i){if(this.isPrivate=!0,"string"!==typeof e)this.n=e,this.e=t,this.d=i;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=Lt(e,16),this.e=parseInt(t,16),this.d=Lt(i,16)}}function Jt(e,t,i,n,r,s,o,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=Lt(e,16),this.e=parseInt(t,16),this.d=Lt(i,16),this.p=Lt(n,16),this.q=Lt(r,16),this.dmp1=Lt(s,16),this.dmq1=Lt(o,16),this.coeff=Lt(a,16)}function Yt(e,t){var i=new xt,n=e>>1;this.e=parseInt(t,16);for(var r=new u(t,16),s=e/2-100,o=u.ONE.shiftLeft(s);;){for(;;)if(this.p=new u(e-n,1,i),0==this.p.subtract(u.ONE).gcd(r).compareTo(u.ONE)&&this.p.isProbablePrime(10))break;for(;;)if(this.q=new u(n,1,i),0==this.q.subtract(u.ONE).gcd(r).compareTo(u.ONE)&&this.q.isProbablePrime(10))break;if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<s||c.compareTo(o)<=0)){var d=this.p.subtract(u.ONE),l=this.q.subtract(u.ONE),h=d.multiply(l);if(0==h.gcd(r).compareTo(u.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=r.modInverse(h),this.dmp1=this.d.mod(d),this.dmq1=this.d.mod(l),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0}function Xt(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var t=e.mod(this.p).modPow(this.dmp1,this.p),i=e.mod(this.q).modPow(this.dmq1,this.q);while(t.compareTo(i)<0)t=t.add(this.p);return t.subtract(i).multiply(this.coeff).mod(this.p).multiply(this.q).add(i)}function $t(e){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var t=Lt(e,16),i=this.doPrivate(t);return null==i?null:Kt(i,this.n.bitLength()+7>>3)}function Qt(e,t,i){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var n=Lt(e,16),r=this.doPrivate(n);return null==r?null:qt(r,this.n.bitLength()+7>>3,t,i)}function Zt(e,t){this.x=t,this.q=e}function ei(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)}function ti(){return this.x}function ii(){return new Zt(this.q,this.x.negate().mod(this.q))}function ni(e){return new Zt(this.q,this.x.add(e.toBigInteger()).mod(this.q))}function ri(e){return new Zt(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))}function si(e){return new Zt(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))}function oi(){return new Zt(this.q,this.x.square().mod(this.q))}function ai(e){return new Zt(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))}function ci(e,t,i,n){this.curve=e,this.x=t,this.y=i,this.z=null==n?u.ONE:n,this.zinv=null}function di(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function li(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function hi(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():(t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),!!t.equals(u.ZERO)&&(i=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q),i.equals(u.ZERO))));var t,i}function ui(){return null==this.x&&null==this.y||this.z.equals(u.ZERO)&&!this.y.toBigInteger().equals(u.ZERO)}function pi(){return new ci(this.curve,this.x,this.y.negate(),this.z)}function mi(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),i=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(u.ZERO.equals(i))return u.ZERO.equals(t)?this.twice():this.curve.getInfinity();var n=new u("3"),r=this.x.toBigInteger(),s=this.y.toBigInteger(),o=(e.x.toBigInteger(),e.y.toBigInteger(),i.square()),a=o.multiply(i),c=r.multiply(o),d=t.square().multiply(this.z),l=d.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(i).mod(this.curve.q),h=c.multiply(n).multiply(t).subtract(s.multiply(a)).subtract(d.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),p=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new ci(this.curve,this.curve.fromBigInteger(l),this.curve.fromBigInteger(h),p)}function fi(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new u("3"),t=this.x.toBigInteger(),i=this.y.toBigInteger(),n=i.multiply(this.z),r=n.multiply(i).mod(this.curve.q),s=this.curve.a.toBigInteger(),o=t.square().multiply(e);u.ZERO.equals(s)||(o=o.add(this.z.square().multiply(s))),o=o.mod(this.curve.q);var a=o.square().subtract(t.shiftLeft(3).multiply(r)).shiftLeft(1).multiply(n).mod(this.curve.q),c=o.multiply(e).multiply(t).subtract(r.shiftLeft(1)).shiftLeft(2).multiply(r).subtract(o.square().multiply(o)).mod(this.curve.q),d=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new ci(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),d)}function gi(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,i=e,n=i.multiply(new u("3")),r=this.negate(),s=this,o=this.curve.q.subtract(e),a=o.multiply(new u("3")),c=new ci(this.curve,this.x,this.y),d=c.negate();for(t=n.bitLength()-2;t>0;--t){s=s.twice();var l=n.testBit(t),h=i.testBit(t);l!=h&&(s=s.add(l?this:r))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var p=a.testBit(t),m=o.testBit(t);p!=m&&(c=c.add(p?c:d))}return s}function _i(e,t,i){var n;n=e.bitLength()>i.bitLength()?e.bitLength()-1:i.bitLength()-1;var r=this.curve.getInfinity(),s=this.add(t);while(n>=0)r=r.twice(),e.testBit(n)?r=i.testBit(n)?r.add(s):r.add(this):i.testBit(n)&&(r=r.add(t)),--n;return r}function vi(e,t,i){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(i),this.infinity=new ci(this,null,null)}function yi(){return this.q}function Ei(){return this.a}function Si(){return this.b}function bi(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)}function wi(){return this.infinity}function Ti(e){return new Zt(this.q,e)}function Ci(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2),i=(e.substr(2),this.fromBigInteger(new u(c,16))),n=this.getA(),r=this.getB(),s=i.square().add(n).multiply(i).add(r),o=s.sqrt();return"03"==t&&(o=o.negate()),new ci(this,i,o);case 4:case 6:case 7:var a=(e.length-2)/2,c=e.substr(2,a),d=e.substr(a+2,a);return new ci(this,this.fromBigInteger(new u(c,16)),this.fromBigInteger(new u(d,16)));default:return null}}xt.prototype.nextBytes=kt,jt.prototype.doPublic=Bt,jt.prototype.setPublic=Vt,jt.prototype.encrypt=Ht,jt.prototype.encryptOAEP=Wt,jt.prototype.type="RSA",jt.prototype.doPrivate=Xt,jt.prototype.setPrivate=zt,jt.prototype.setPrivateEx=Jt,jt.prototype.generate=Yt,jt.prototype.decrypt=$t,jt.prototype.decryptOAEP=Qt,Zt.prototype.equals=ei,Zt.prototype.toBigInteger=ti,Zt.prototype.negate=ii,Zt.prototype.add=ni,Zt.prototype.subtract=ri,Zt.prototype.multiply=si,Zt.prototype.square=oi,Zt.prototype.divide=ai,Zt.prototype.sqrt=function(){return new Zt(this.q,this.x.sqrt().mod(this.q))},ci.prototype.getX=di,ci.prototype.getY=li,ci.prototype.equals=hi,ci.prototype.isInfinity=ui,ci.prototype.negate=pi,ci.prototype.add=mi,ci.prototype.twice=fi,ci.prototype.multiply=gi,ci.prototype.multiplyTwo=_i,vi.prototype.getQ=yi,vi.prototype.getA=Ei,vi.prototype.getB=Si,vi.prototype.equals=bi,vi.prototype.getInfinity=wi,vi.prototype.fromBigInteger=Ti,vi.prototype.decodePointHex=Ci,Zt.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ci.prototype.getEncoded=function(e){var t=function(e,t){var i=e.toByteArrayUnsigned();if(t<i.length)i=i.slice(i.length-t);else while(t>i.length)i.unshift(0);return i},i=this.getX().toBigInteger(),n=this.getY().toBigInteger(),r=t(i,32);return e?n.isEven()?r.unshift(2):r.unshift(3):(r.unshift(4),r=r.concat(t(n,32))),r},ci.decodeFrom=function(e,t){t[0];var i=t.length-1,n=t.slice(1,1+i/2),r=t.slice(1+i/2,1+i);n.unshift(0),r.unshift(0);var s=new u(n),o=new u(r);return new ci(e,e.fromBigInteger(s),e.fromBigInteger(o))},ci.decodeFromHex=function(e,t){t.substr(0,2);var i=t.length-2,n=t.substr(2,i/2),r=t.substr(2+i/2,i/2),s=new u(n,16),o=new u(r,16);return new ci(e,e.fromBigInteger(s),e.fromBigInteger(o))},ci.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),i=e.y.subtract(this.y),n=i.divide(t),r=n.square().subtract(this.x).subtract(e.x),s=n.multiply(this.x.subtract(r)).subtract(this.y);return new ci(this.curve,r,s)},ci.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(u.valueOf(2)),t=this.curve.fromBigInteger(u.valueOf(3)),i=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),n=i.square().subtract(this.x.multiply(e)),r=i.multiply(this.x.subtract(n)).subtract(this.y);return new ci(this.curve,n,r)},ci.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,i=e,n=i.multiply(new u("3")),r=this.negate(),s=this;for(t=n.bitLength()-2;t>0;--t){s=s.twice();var o=n.testBit(t),a=i.testBit(t);o!=a&&(s=s.add2D(o?this:r))}return s},ci.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),i=this.curve.getA().toBigInteger(),n=this.curve.getB().toBigInteger(),r=this.curve.getQ(),s=t.multiply(t).mod(r),o=e.multiply(e).multiply(e).add(i.multiply(e)).add(n).mod(r);return s.equals(o)},ci.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ci.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),i=this.getY().toBigInteger();if(t.compareTo(u.ONE)<0||t.compareTo(e.subtract(u.ONE))>0)throw new Error("x coordinate out of bounds");if(i.compareTo(u.ONE)<0||i.compareTo(e.subtract(u.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};var Ri=function(){var e="(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)",t='(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))',i='(?:"'+t+'*")',n=new RegExp("(?:false|true|null|[\\{\\}\\[\\]]|"+e+"|"+i+")","g"),r=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),s={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function o(e,t,i){return t?s[t]:String.fromCharCode(parseInt(i,16))}var a=new String(""),c="\\",d=Object.hasOwnProperty;return function(e,t){var i,s,l=e.match(n),h=l[0],u=!1;"{"===h?i={}:"["===h?i=[]:(i=[],u=!0);for(var p=[i],m=1-u,f=l.length;m<f;++m){var g;switch(h=l[m],h.charCodeAt(0)){default:g=p[0],g[s||g.length]=+h,s=void 0;break;case 34:if(h=h.substring(1,h.length-1),-1!==h.indexOf(c)&&(h=h.replace(r,o)),g=p[0],!s){if(!(g instanceof Array)){s=h||a;break}s=g.length}g[s]=h,s=void 0;break;case 91:g=p[0],p.unshift(g[s||g.length]=[]),s=void 0;break;case 93:p.shift();break;case 102:g=p[0],g[s||g.length]=!1,s=void 0;break;case 110:g=p[0],g[s||g.length]=null,s=void 0;break;case 116:g=p[0],g[s||g.length]=!0,s=void 0;break;case 123:g=p[0],p.unshift(g[s||g.length]={}),s=void 0;break;case 125:p.shift();break}}if(u){if(1!==p.length)throw new Error;i=i[0]}else if(p.length)throw new Error;if(t){var _=function(e,i){var n=e[i];if(n&&"object"===typeof n){var r=null;for(var s in n)if(d.call(n,s)&&n!==e){var o=_(n,s);void 0!==o?n[s]=o:(r||(r=[]),r.push(s))}if(r)for(var a=r.length;--a>=0;)delete n[r[a]]}return t.call(e,i,n)};i=_({"":i},"")}return i}}();"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),Ii.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){var t=e.toString(16);if("-"!=t.substr(0,1))t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t);else{var i=t.substr(1),n=i.length;n%2==1?n+=1:t.match(/^[0-7]/)||(n+=2);for(var r="",s=0;s<n;s++)r+="f";var o=new u(r,16),a=o.xor(e).add(u.ONE);t=a.toString(16).replace(/^-/,"")}return t},this.getPEMStringFromHex=function(e,t){return Zi(e,t)},this.newObject=function(e){var t=Ii,i=t.asn1,n=i.ASN1Object,r=i.DERBoolean,s=i.DERInteger,o=i.DERBitString,a=i.DEROctetString,c=i.DERNull,d=i.DERObjectIdentifier,l=i.DEREnumerated,h=i.DERUTF8String,u=i.DERNumericString,p=i.DERPrintableString,m=i.DERTeletexString,f=i.DERIA5String,g=i.DERUTCTime,_=i.DERGeneralizedTime,v=i.DERVisibleString,y=i.DERBMPString,E=i.DERSequence,S=i.DERSet,b=i.DERTaggedObject,w=i.ASN1Util.newObject;if(e instanceof i.ASN1Object)return e;var T=Object.keys(e);if(1!=T.length)throw new Error("key of param shall be only one.");var C=T[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+C+":"))throw new Error("undefined key: "+C);if("bool"==C)return new r(e[C]);if("int"==C)return new s(e[C]);if("bitstr"==C)return new o(e[C]);if("octstr"==C)return new a(e[C]);if("null"==C)return new c(e[C]);if("oid"==C)return new d(e[C]);if("enum"==C)return new l(e[C]);if("utf8str"==C)return new h(e[C]);if("numstr"==C)return new u(e[C]);if("prnstr"==C)return new p(e[C]);if("telstr"==C)return new m(e[C]);if("ia5str"==C)return new f(e[C]);if("utctime"==C)return new g(e[C]);if("gentime"==C)return new _(e[C]);if("visstr"==C)return new v(e[C]);if("bmpstr"==C)return new y(e[C]);if("asn1"==C)return new n(e[C]);if("seq"==C){for(var R=e[C],I=[],A=0;A<R.length;A++){var P=w(R[A]);I.push(P)}return new E({array:I})}if("set"==C){for(R=e[C],I=[],A=0;A<R.length;A++){P=w(R[A]);I.push(P)}return new S({array:I})}if("tag"==C){var O=e[C];if("[object Array]"===Object.prototype.toString.call(O)&&3==O.length){var N=w(O[2]);return new b({tag:O[0],explicit:O[1],obj:N})}return new b(O)}},this.jsonToASN1HEX=function(e){var t=this.newObject(e);return t.tohex()}},Ii.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",i=parseInt(e.substr(0,2),16),n=Math.floor(i/40),r=i%40,s=(t=n+"."+r,""),o=2;o<e.length;o+=2){var a=parseInt(e.substr(o,2),16),c=("00000000"+a.toString(2)).slice(-8);if(s+=c.substr(1,7),"0"==c.substr(0,1)){var d=new u(s,2);t=t+"."+d.toString(10),s=""}}return t},Ii.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},i=function(e){var i="",n=new u(e,10),r=n.toString(2),s=7-r.length%7;7==s&&(s=0);for(var o="",a=0;a<s;a++)o+="0";r=o+r;for(a=0;a<r.length-1;a+=7){var c=r.substr(a,7);a!=r.length-7&&(c="1"+c),i+=t(parseInt(c,2))}return i};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var n="",r=e.split("."),s=40*parseInt(r[0])+parseInt(r[1]);n+=t(s),r.splice(0,2);for(var o=0;o<r.length;o++)n+=i(r[o]);return n},Ii.asn1.ASN1Object=function(e){var t="";this.params=null,this.getLengthHexFromValue=function(){if("undefined"==typeof this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n="+t.length+",v="+this.hV);var e=this.hV.length/2,i=e.toString(16);if(i.length%2==1&&(i="0"+i),e<128)return i;var n=i.length/2;if(n>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));var r=128+n;return r.toString(16)+i},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},void 0!=e&&void 0!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},Ii.asn1.DERAbstractString=function(e){Ii.asn1.DERAbstractString.superclass.constructor.call(this);this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=Ki(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("string"==typeof e?this.setString(e):"undefined"!=typeof e.str?this.setString(e.str):"undefined"!=typeof e.hex&&this.setStringHex(e.hex))},kn(Ii.asn1.DERAbstractString,Ii.asn1.ASN1Object),Ii.asn1.DERAbstractTime=function(e){Ii.asn1.DERAbstractTime.superclass.constructor.call(this);this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset(),i=new Date(t);return i},this.formatDate=function(e,t,i){var n=this.zeroPadding,r=this.localDateToUTC(e),s=String(r.getFullYear());"utc"==t&&(s=s.substr(2,2));var o=n(String(r.getMonth()+1),2),a=n(String(r.getDate()),2),c=n(String(r.getHours()),2),d=n(String(r.getMinutes()),2),l=n(String(r.getSeconds()),2),h=s+o+a+c+d+l;if(!0===i){var u=r.getMilliseconds();if(0!=u){var p=n(String(u),3);p=p.replace(/[0]+$/,""),h=h+"."+p}}return h+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,void 0==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,void 0==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,i,n,r,s){var o=new Date(Date.UTC(e,t-1,i,n,r,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},kn(Ii.asn1.DERAbstractTime,Ii.asn1.ASN1Object),Ii.asn1.DERAbstractStructured=function(e){Ii.asn1.DERAbstractString.superclass.constructor.call(this);this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,"undefined"!=typeof e&&"undefined"!=typeof e.array&&(this.asn1Array=e.array)},kn(Ii.asn1.DERAbstractStructured,Ii.asn1.ASN1Object),Ii.asn1.DERBoolean=function(e){Ii.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},kn(Ii.asn1.DERBoolean,Ii.asn1.ASN1Object),Ii.asn1.DERInteger=function(e){Ii.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=Ii.asn1.ASN1Util.bigIntToMinTwosComplementsHex(e)},this.setByInteger=function(e){var t=new u(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("undefined"!=typeof e.bigint?this.setByBigInteger(e.bigint):"undefined"!=typeof e["int"]?this.setByInteger(e["int"]):"number"==typeof e?this.setByInteger(e):"undefined"!=typeof e.hex&&this.setValueHex(e.hex))},kn(Ii.asn1.DERInteger,Ii.asn1.ASN1Object),Ii.asn1.DERBitString=function(e){if(void 0!==e&&"undefined"!==typeof e.obj){var t=Ii.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}Ii.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var i="0"+e;this.hTLV=null,this.isModified=!0,this.hV=i+t},this.setByBinaryString=function(e){e=e.replace(/0+$/,"");var t=8-e.length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var i="",n=0;n<e.length-1;n+=8){var r=e.substr(n,8),s=parseInt(r,2).toString(16);1==s.length&&(s="0"+s),i+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+t+i},this.setByBooleanArray=function(e){for(var t="",i=0;i<e.length;i++)1==e[i]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),i=0;i<e;i++)t[i]=!1;return t},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):"undefined"!=typeof e.hex?this.setHexValueIncludingUnusedBits(e.hex):"undefined"!=typeof e.bin?this.setByBinaryString(e.bin):"undefined"!=typeof e.array&&this.setByBooleanArray(e.array))},kn(Ii.asn1.DERBitString,Ii.asn1.ASN1Object),Ii.asn1.DEROctetString=function(e){if(void 0!==e&&"undefined"!==typeof e.obj){var t=Ii.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}Ii.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},kn(Ii.asn1.DEROctetString,Ii.asn1.DERAbstractString),Ii.asn1.DERNull=function(){Ii.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},kn(Ii.asn1.DERNull,Ii.asn1.ASN1Object),Ii.asn1.DERObjectIdentifier=function(e){Ii.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=Cn(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=Ii.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"===typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.DERObjectIdentifier,Ii.asn1.ASN1Object),Ii.asn1.DEREnumerated=function(e){Ii.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=Ii.asn1.ASN1Util.bigIntToMinTwosComplementsHex(e)},this.setByInteger=function(e){var t=new u(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("undefined"!=typeof e["int"]?this.setByInteger(e["int"]):"number"==typeof e?this.setByInteger(e):"undefined"!=typeof e.hex&&this.setValueHex(e.hex))},kn(Ii.asn1.DEREnumerated,Ii.asn1.ASN1Object),Ii.asn1.DERUTF8String=function(e){Ii.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},kn(Ii.asn1.DERUTF8String,Ii.asn1.DERAbstractString),Ii.asn1.DERNumericString=function(e){Ii.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},kn(Ii.asn1.DERNumericString,Ii.asn1.DERAbstractString),Ii.asn1.DERPrintableString=function(e){Ii.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},kn(Ii.asn1.DERPrintableString,Ii.asn1.DERAbstractString),Ii.asn1.DERTeletexString=function(e){Ii.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},kn(Ii.asn1.DERTeletexString,Ii.asn1.DERAbstractString),Ii.asn1.DERIA5String=function(e){Ii.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},kn(Ii.asn1.DERIA5String,Ii.asn1.DERAbstractString),Ii.asn1.DERVisibleString=function(e){Ii.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},kn(Ii.asn1.DERVisibleString,Ii.asn1.DERAbstractString),Ii.asn1.DERBMPString=function(e){Ii.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},kn(Ii.asn1.DERBMPString,Ii.asn1.DERAbstractString),Ii.asn1.DERUTCTime=function(e){Ii.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(void 0==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=xi(e)}else if(void 0!=e.str)this.hV=xi(e.str);else if(void 0==e.date&&1==e.millis){var t=new Date;this.hV=xi(this.formatDate(t,"utc",!0))}else if(void 0!=e.date&&e.date instanceof Date){var i=!0===e.millis;this.hV=xi(this.formatDate(e.date,"utc",i))}else e instanceof Date&&(this.hV=xi(this.formatDate(e,"utc")));if(void 0==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.DERUTCTime,Ii.asn1.DERAbstractTime),Ii.asn1.DERGeneralizedTime=function(e){Ii.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(void 0==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=xi(e)}else if(void 0!=e.str)this.hV=xi(e.str);else if(void 0==e.date&&1==e.millis){var t=new Date;this.hV=xi(this.formatDate(t,"gen",!0))}else if(void 0!=e.date&&e.date instanceof Date){var i=!0===e.millis;this.hV=xi(this.formatDate(e.date,"gen",i))}else e instanceof Date&&(this.hV=xi(this.formatDate(e,"gen")));if(void 0==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.DERGeneralizedTime,Ii.asn1.DERAbstractTime),Ii.asn1.DERSequence=function(e){Ii.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){var i=this.asn1Array[t];e+=i.tohex()}return this.hV=e,this.hV}},kn(Ii.asn1.DERSequence,Ii.asn1.DERAbstractStructured),Ii.asn1.DERSet=function(e){Ii.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var i=this.asn1Array[t];e.push(i.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},"undefined"!=typeof e&&"undefined"!=typeof e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},kn(Ii.asn1.DERSet,Ii.asn1.DERAbstractStructured),Ii.asn1.DERTaggedObject=function(e){Ii.asn1.DERTaggedObject.superclass.constructor.call(this);var t=Ii.asn1,i=Oi,n=i.getV,r=(i.isASN1HEX,t.ASN1Util.newObject);this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,i){this.params={tag:t,explicit:e,obj:i}},this.getFreshValueHex=function(){var e=this.params;if(void 0==e.explicit&&(e.explicit=!0),void 0!=e.tage&&(e.tag=e.tage,e.explicit=!0),void 0!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),void 0!=e.str)this.hV=Ki(e.str);else if(void 0!=e.hex)this.hV=e.hex;else{if(void 0==e.obj)throw new Error("str, hex nor obj not specified");var i;e.obj instanceof t.ASN1Object?i=e.obj.tohex():"object"==typeof e.obj&&(i=r(e.obj).tohex()),e.explicit?this.hV=i:this.hV=n(i,0)}return void 0==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.DERTaggedObject,Ii.asn1.ASN1Object);var Ii,Ai,Pi,Oi=new function(){};function Ni(e){for(var t=new Array,i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}function Di(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return t}function ki(e){for(var t="",i=0;i<e.length;i++){var n=e[i].toString(16);1==n.length&&(n="0"+n),t+=n}return t}function xi(e){return ki(Ni(e))}function Li(e){return a(xi(e))}function Mi(e){return Ui(a(xi(e)))}function Fi(e){return Di(d(ji(e)))}function Ui(e){return e=e.replace(/\=/g,""),e=e.replace(/\+/g,"-"),e=e.replace(/\//g,"_"),e}function ji(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=e.replace(/-/g,"+"),e=e.replace(/_/g,"/"),e}function Vi(e){return e.length%2==1&&(e="0"+e),Ui(a(e))}function Bi(e){return c(ji(e))}function Hi(e){return a(cn(_n(e)))}function Wi(e){return decodeURIComponent(dn(c(e)))}function Ki(e){return cn(_n(e)).toLowerCase()}function Gi(e){try{return decodeURIComponent(dn(e))}catch(t){return null}}function qi(e){return Gi(zi(e))}function zi(e){for(var t=e.match(/.{1,2}/g),i=[],n=0;n<t.length;n++){var r=parseInt(t[n],16);161<=r&&r<=191?(i.push("c2"),i.push(t[n])):192<=r&&r<=255?(i.push("c3"),i.push((r-64).toString(16))):i.push(t[n])}return i.join("")}function Ji(e){for(var t="",i=0;i<e.length-1;i+=2)t+=String.fromCharCode(parseInt(e.substr(i,2),16));return t}function Yi(e){for(var t="",i=0;i<e.length;i++)t+=("0"+e.charCodeAt(i).toString(16)).slice(-2);return t}function Xi(e){return a(e)}function $i(e){var t=Xi(e),i=t.replace(/(.{64})/g,"$1\r\n");return i=i.replace(/\r\n$/,""),i}function Qi(e){var t=e.replace(/[^0-9A-Za-z\/+=]*/g,""),i=c(t);return i}function Zi(e,t){var i=$i(e);return"-----BEGIN "+t+"-----\r\n"+i+"\r\n-----END "+t+"-----\r\n"}function en(e,t){if(-1==e.indexOf("-----BEGIN "))throw"can't find PEM header: "+t;return void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),""),e=e.replace(new RegExp("-----END "+t+"-----[^]*$"),"")):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,""),e=e.replace(/-----END [^-]+-----[^]*$/,"")),Qi(e)}function tn(e){if(e.length%2!=0)throw"input is not even length";if(null==e.match(/^[0-9A-Fa-f]+$/))throw"input is not hexadecimal";for(var t=new ArrayBuffer(e.length/2),i=new DataView(t),n=0;n<e.length/2;n++)i.setUint8(n,parseInt(e.substr(2*n,2),16));return t}function nn(e){for(var t="",i=new DataView(e),n=0;n<e.byteLength;n++)t+=("00"+i.getUint8(n).toString(16)).slice(-2);return t}function rn(e){var t,i,n,r,s,o,a,c,d,l,h;if(h=e.match(/^(\d{2}|\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/),h)return c=h[1],t=parseInt(c),2===c.length&&(50<=t&&t<100?t=1900+t:0<=t&&t<50&&(t=2e3+t)),i=parseInt(h[2])-1,n=parseInt(h[3]),r=parseInt(h[4]),s=parseInt(h[5]),o=parseInt(h[6]),a=0,d=h[7],""!==d&&(l=(d.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,i,n,r,s,o,a);throw new Error("unsupported zulu format: "+e)}function sn(e){return Math.round(rn(e)/1e3)}function on(e){return new Date(rn(e))}function an(e,t,i){var n,r=e.getUTCFullYear();if(t){if(r<1950||2049<r)throw"not proper year for UTCTime: "+r;n=(""+r).slice(-2)}else n=("000"+r).slice(-4);if(n+=("0"+(e.getUTCMonth()+1)).slice(-2),n+=("0"+e.getUTCDate()).slice(-2),n+=("0"+e.getUTCHours()).slice(-2),n+=("0"+e.getUTCMinutes()).slice(-2),n+=("0"+e.getUTCSeconds()).slice(-2),i){var s=e.getUTCMilliseconds();0!==s&&(s=("00"+s).slice(-3),s=s.replace(/0+$/g,""),n+="."+s)}return n+="Z",n}function cn(e){return e.replace(/%/g,"")}function dn(e){return e.replace(/(..)/g,"%$1")}function ln(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;e=e.toLowerCase();var i=e.split(":").length-1;if(i<2)throw t;var n=":".repeat(7-i+2);e=e.replace("::",n);var r=e.split(":");if(8!=r.length)throw t;for(var s=0;s<8;s++)r[s]=("0000"+r[s]).slice(-4);return r.join("")}function hn(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);e=e.toLowerCase();var t=e.match(/.{1,4}/g);t=t.map((function(e){return e.replace(/^0+/,"")})),t=t.map((function(e){return""==e?"0":e})),e=":"+t.join(":")+":";var i=e.match(/:(0:){2,}/g);if(null==i)return e.slice(1,-1);var n=i.sort().slice(-1)[0];return e=e.replace(n.substr(0,n.length-1),":"),"::"!=e.substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function un(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){var i;try{return i=parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16),i}catch(n){throw t}}else{if(16!=e.length){if(32==e.length)return hn(e);if(64==e.length){try{return hn(e.substr(0,32))+"/"+pn(e.substr(32))}catch(n){throw t}return}return e}try{return un(e.substr(0,8))+"/"+pn(e.substr(8))}catch(n){throw t}}}function pn(e){var t,i=new Error("malformed mask");try{t=new u(e,16).toString(2)}catch(n){throw i}if(!t.match(/^1*0*$/))throw i;return t.replace(/0+$/,"").length}function mn(e){var t=new Error("malformed IP address");if(e=e.toLowerCase(e),!e.match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){if(e.match(/^[0-9.]+\/[0-9]+$/)){var i=e.split("/");return mn(i[0])+fn(parseInt(i[1]),32)}if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return ln(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":")){i=e.split("/");return ln(i[0])+fn(parseInt(i[1]),128)}throw t}var n=e.split(".");if(4!==n.length)throw t;var r="";try{for(var s=0;s<4;s++){var o=parseInt(n[s]);r+=("0"+o.toString(16)).slice(-2)}return r}catch(a){throw t}}function fn(e,t){if(32==t&&0==e)return"00000000";if(128==t&&0==e)return"00000000000000000000000000000000";var i=Array(e+1).join("1")+Array(t-e+1).join("0");return new u(i,2).toString(16)}function gn(e){function t(e){var t=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2),16);if(0==t&i<128)return String.fromCharCode(i);if(t<8){var n=192|(7&t)<<3|(192&i)>>6,r=128|63&i;return Gi(n.toString(16)+r.toString(16))}n=224|(240&t)>>4,r=128|(15&t)<<2|(192&i)>>6;var s=128|63&i;return Gi(n.toString(16)+r.toString(16)+s.toString(16))}var i=e.match(/.{4}/g),n=i.map(t);return n.join("")}function _n(e){for(var t=encodeURIComponent(e),i="",n=0;n<t.length;n++)"%"==t[n]?(i+=t.substr(n,3),n+=2):i=i+"%"+xi(t[n]);return i}function vn(e){return e=e.replace(/\r\n/gm,"\n"),e}function yn(e){return e=e.replace(/\r\n/gm,"\n"),e=e.replace(/\n/gm,"\r\n"),e}function En(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function Sn(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function bn(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function wn(e){e=e.replace(/^\s*\[\s*/,""),e=e.replace(/\s*\]\s*$/,""),e=e.replace(/\s*/g,"");try{var t=e.split(/,/).map((function(e,t,i){var n=parseInt(e);if(n<0||255<n)throw"integer not in range 0-255";var r=("00"+n.toString(16)).slice(-2);return r})).join("");return t}catch(i){throw"malformed integer array string: "+i}}Oi.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var i=parseInt(e.substr(t+3,1));return 0==i?-1:0<i&&i<10?i+1:-2},Oi.getL=function(e,t){var i=Oi.getLblen(e,t);return i<1?"":e.substr(t+2,2*i)},Oi.getVblen=function(e,t){var i,n;return i=Oi.getL(e,t),""==i?-1:(n="8"===i.substr(0,1)?new u(i.substr(2),16):new u(i,16),n.intValue())},Oi.getVidx=function(e,t){var i=Oi.getLblen(e,t);return i<0?i:t+2*(i+1)},Oi.getV=function(e,t){var i=Oi.getVidx(e,t),n=Oi.getVblen(e,t);return e.substr(i,2*n)},Oi.getTLV=function(e,t){return e.substr(t,2)+Oi.getL(e,t)+Oi.getV(e,t)},Oi.getTLVblen=function(e,t){return 2+2*Oi.getLblen(e,t)+2*Oi.getVblen(e,t)},Oi.getNextSiblingIdx=function(e,t){var i=Oi.getVidx(e,t),n=Oi.getVblen(e,t);return i+2*n},Oi.getChildIdx=function(e,t){var i,n,r,s=Oi,o=[];i=s.getVidx(e,t),n=2*s.getVblen(e,t),"03"==e.substr(t,2)&&(i+=2,n-=2),r=0;var a=i;while(r<=n){var c=s.getTLVblen(e,a);if(r+=c,r<=n&&o.push(a),a+=c,r>=n)break}return o},Oi.getNthChildIdx=function(e,t,i){var n=Oi.getChildIdx(e,t);return n[i]},Oi.getIdxbyList=function(e,t,i,n){var r,s,o=Oi;return 0==i.length?void 0!==n&&e.substr(t,2)!==n?-1:t:(r=i.shift(),s=o.getChildIdx(e,t),r>=s.length?-1:o.getIdxbyList(e,s[r],i,n))},Oi.getIdxbyListEx=function(e,t,i,n){var r,s,o=Oi;if(0==i.length)return void 0!==n&&e.substr(t,2)!==n?-1:t;r=i.shift(),s=o.getChildIdx(e,t);for(var a=0,c=0;c<s.length;c++){var d=e.substr(s[c],2);if("number"==typeof r&&!o.isContextTag(d)&&a==r||"string"==typeof r&&o.isContextTag(d,r))return o.getIdxbyListEx(e,s[c],i,n);o.isContextTag(d)||a++}return-1},Oi.getTLVbyList=function(e,t,i,n){var r=Oi,s=r.getIdxbyList(e,t,i,n);return-1==s||s>=e.length?null:r.getTLV(e,s)},Oi.getTLVbyListEx=function(e,t,i,n){var r=Oi,s=r.getIdxbyListEx(e,t,i,n);return-1==s?null:r.getTLV(e,s)},Oi.getVbyList=function(e,t,i,n,r){var s,o,a=Oi;return s=a.getIdxbyList(e,t,i,n),-1==s||s>=e.length?null:(o=a.getV(e,s),!0===r&&(o=o.substr(2)),o)},Oi.getVbyListEx=function(e,t,i,n,r){var s,o,a=Oi;return s=a.getIdxbyListEx(e,t,i,n),-1==s?null:(o=a.getV(e,s),"03"==e.substr(s,2)&&!1!==r&&(o=o.substr(2)),o)},Oi.getInt=function(e,t,i){void 0==i&&(i=-1);try{var n=e.substr(t,2);if("02"!=n&&"03"!=n)return i;var r=Oi.getV(e,t);return"02"==n?parseInt(r,16):An(r)}catch(s){return i}},Oi.getOID=function(e,t,i){void 0==i&&(i=null);try{if("06"!=e.substr(t,2))return i;var n=Oi.getV(e,t);return Rn(n)}catch(r){return i}},Oi.getOIDName=function(e,t,i){void 0==i&&(i=null);try{var n=Oi.getOID(e,t,i);if(n==i)return i;var r=Ii.asn1.x509.OID.oid2name(n);return""==r?n:r}catch(s){return i}},Oi.getString=function(e,t,i){void 0==i&&(i=null);try{var n=Oi.getV(e,t);return Ji(n)}catch(r){return i}},Oi.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},i=[],n=e.substr(0,2),r=parseInt(n,16);i[0]=new String(Math.floor(r/40)),i[1]=new String(r%40);for(var s=e.substr(2),o=[],a=0;a<s.length/2;a++)o.push(parseInt(s.substr(2*a,2),16));var c=[],d="";for(a=0;a<o.length;a++)128&o[a]?d+=t((127&o[a]).toString(2),7):(d+=t((127&o[a]).toString(2),7),c.push(new String(parseInt(d,2))),d="");var l=i.join(".");return c.length>0&&(l=l+"."+c.join(".")),l},Oi.dump=function(e,t,i,n){var r=Oi,s=r.getV,o=r.dump,a=r.getChildIdx,c=e;e instanceof Ii.asn1.ASN1Object&&(c=e.tohex());var d=function(e,t){if(e.length<=2*t)return e;var i=e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t);return i};void 0===t&&(t={ommit_long_octet:32}),void 0===i&&(i=0),void 0===n&&(n="");var l=t.ommit_long_octet,h=c.substr(i,2);if("01"==h){var u=s(c,i);return"00"==u?n+"BOOLEAN FALSE\n":n+"BOOLEAN TRUE\n"}if("02"==h){u=s(c,i);return n+"INTEGER "+d(u,l)+"\n"}if("03"==h){u=s(c,i);if(r.isASN1HEX(u.substr(2))){var p=n+"BITSTRING, encapsulates\n";return p+=o(u.substr(2),t,0,n+"  "),p}return n+"BITSTRING "+d(u,l)+"\n"}if("04"==h){u=s(c,i);if(r.isASN1HEX(u)){p=n+"OCTETSTRING, encapsulates\n";return p+=o(u,t,0,n+"  "),p}return n+"OCTETSTRING "+d(u,l)+"\n"}if("05"==h)return n+"NULL\n";if("06"==h){var m=s(c,i),f=Ii.asn1.ASN1Util.oidHexToInt(m),g=Ii.asn1.x509.OID.oid2name(f),_=f.replace(/\./g," ");return""!=g?n+"ObjectIdentifier "+g+" ("+_+")\n":n+"ObjectIdentifier ("+_+")\n"}if("0a"==h)return n+"ENUMERATED "+parseInt(s(c,i))+"\n";if("0c"==h)return n+"UTF8String '"+Gi(s(c,i))+"'\n";if("13"==h)return n+"PrintableString '"+Gi(s(c,i))+"'\n";if("14"==h)return n+"TeletexString '"+Gi(s(c,i))+"'\n";if("16"==h)return n+"IA5String '"+Gi(s(c,i))+"'\n";if("17"==h)return n+"UTCTime "+Gi(s(c,i))+"\n";if("18"==h)return n+"GeneralizedTime "+Gi(s(c,i))+"\n";if("1a"==h)return n+"VisualString '"+Gi(s(c,i))+"'\n";if("1e"==h)return n+"BMPString '"+gn(s(c,i))+"'\n";if("30"==h){if("3000"==c.substr(i,4))return n+"SEQUENCE {}\n";p=n+"SEQUENCE\n";var v=a(c,i),y=t;if((2==v.length||3==v.length)&&"06"==c.substr(v[0],2)&&"04"==c.substr(v[v.length-1],2)){g=r.oidname(s(c,v[0]));var E=JSON.parse(JSON.stringify(t));E.x509ExtName=g,y=E}for(var S=0;S<v.length;S++)p+=o(c,y,v[S],n+"  ");return p}if("31"==h){for(p=n+"SET\n",v=a(c,i),S=0;S<v.length;S++)p+=o(c,t,v[S],n+"  ");return p}h=parseInt(h,16);if(0!=(128&h)){var b=31&h;if(0!=(32&h)){for(p=n+"["+b+"]\n",v=a(c,i),S=0;S<v.length;S++)p+=o(c,t,v[S],n+"  ");return p}u=s(c,i);if(Oi.isASN1HEX(u)){p=n+"["+b+"]\n";return p+=o(u,t,0,n+"  "),p}("68747470"==u.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==b)&&(u=Gi(u));p=n+"["+b+"] "+u+"\n";return p}return n+"UNKNOWN("+h+") "+s(c,i)+"\n"},Oi.parse=function(e){var t=Oi,i=t.parse,n=t.isASN1HEX,r=t.getV,s=t.getTLV,o=t.getChildIdx,a=Ii.asn1,c=a.ASN1Util.oidHexToInt,d=a.x509.OID.oid2name,l=Gi,h=gn,u=qi,p={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},m=function(e){for(var t=[],n=o(e,0),r=0;r<n.length;r++){var a=n[r],c=s(e,a),d=i(c);t.push(d)}return t},f=e.substr(0,2),g={},_=r(e,0);if("01"==f)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==f)return{int:{hex:_}};if("03"==f)try{if("00"!=_.substr(0,2))throw"not encap";var v=_.substr(2);if(!n(v))throw"not encap";return{bitstr:{obj:i(v)}}}catch(C){var y=null;return _.length<=10&&(y=On(_)),null==y?{bitstr:{hex:_}}:{bitstr:{bin:y}}}else if("04"==f)try{if(!n(_))throw"not encap";return{octstr:{obj:i(_)}}}catch(C){return{octstr:{hex:_}}}else{if("05"==f)return{null:""};if("06"==f){var E=c(_),S=d(E);return""==S?{oid:E}:{oid:S}}if("0a"==f)return _.length>4?{enum:{hex:_}}:{enum:parseInt(_,16)};if("30"==f||"31"==f)return g[p[f]]=m(e),g;if("14"==f){var b=u(_);return g[p[f]]={str:b},g}if("1e"==f){b=h(_);return g[p[f]]={str:b},g}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(f)){b=l(_);return g[p[f]]={str:b},g}if(f.match(/^8[0-9]$/)){b=l(_);return null==b|""==b||null!=b.match(/[\x00-\x1F\x7F-\x9F]/)||null!=b.match(/[\u0000-\u001F\u0080â\u009F]/)?{tag:{tag:f,explicit:!1,hex:_}}:{tag:{tag:f,explicit:!1,str:b}}}if(!f.match(/^a[0-9]$/)){var w=new Ii.asn1.ASN1Object;w.hV=_;var T=w.getLengthHexFromValue();return{asn1:{tlv:f+T+_}}}try{if(!n(_))throw new Error("not encap");return{tag:{tag:f,explicit:!0,obj:i(_)}}}catch(C){return{tag:{tag:f,explicit:!0,hex:_}}}}},Oi.isContextTag=function(e,t){var i,n;e=e.toLowerCase();try{i=parseInt(e,16)}catch(s){return-1}if(void 0===t)return 128==(192&i);try{var r=t.match(/^\[[0-9]+\]$/);return null!=r&&(n=parseInt(t.substr(1,t.length-1),10),!(n>31)&&(128==(192&i)&&(31&i)==n))}catch(s){return!1}},Oi.isASN1HEX=function(e){var t=Oi;if(e.length%2==1)return!1;var i=t.getVblen(e,0),n=e.substr(0,2),r=t.getL(e,0),s=e.length-n.length-r.length;return s==2*i},Oi.checkStrictDER=function(e,t,i,n,r){var s=Oi;if(void 0===i){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!Ii.lang.String.isHex(e))throw new Error("not hex string");i=e.length,n=e.length/2,r=n<128?1:Math.ceil(n.toString(16))+1}var o=s.getL(e,t);if(o.length>2*r)throw new Error("L of TLV too long: idx="+t);var a=s.getVblen(e,t);if(a>n)throw new Error("value of L too long than hex: idx="+t);var c=s.getTLV(e,t),d=c.length-2-s.getL(e,t).length;if(d!==2*a)throw new Error("V string length and L's value not the same:"+d+"/"+2*a);if(0===t&&e.length!=c.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+c.length);var l=e.substr(t,2);if("02"===l){var h=s.getVidx(e,t);if("00"==e.substr(h,2)&&e.charCodeAt(h+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var u=s.getVblen(e,t),p=0,m=s.getChildIdx(e,t),f=0;f<m.length;f++){var g=s.getTLV(e,m[f]);p+=g.length,s.checkStrictDER(e,m[f],i,n,r)}if(2*u!=p)throw new Error("sum of children's TLV length and L unmatch: "+2*u+"!="+p)}},Oi.oidname=function(e){var t=Ii.asn1;Ii.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var i=t.x509.OID.oid2name(e);return""===i&&(i=e),i},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),"undefined"!=typeof Ii.asn1.x509&&Ii.asn1.x509||(Ii.asn1.x509={}),Ii.asn1.x509.Certificate=function(e){Ii.asn1.x509.Certificate.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERBitString,r=i.DERSequence,s=i.x509,o=s.TBSCertificate,a=s.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;void 0!=e.sigalg.name&&(t=e.sigalg.name);var i=e.tbsobj.tohex(),n=new Ii.crypto.Signature({alg:t});n.init(e.cakey),n.updateHex(i),e.sighex=n.sign()},this.getPEM=function(){return Zi(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(void 0!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new o(e)),void 0==e.sighex&&void 0!=e.cakey&&this.sign(),void 0==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];t.push(e.tbsobj),t.push(new a({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex}));var i=new r({array:t});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.Certificate,Ii.asn1.ASN1Object),Ii.asn1.x509.TBSCertificate=function(e){Ii.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.x509,r=i.DERTaggedObject,s=i.DERInteger,o=i.DERSequence,a=n.AlgorithmIdentifier,c=n.Time,d=n.X500Name,l=n.Extensions,h=n.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(void 0!=t.version||1!=t.version){var i=2;void 0!=t.version&&(i=t.version-1);var n=new r({obj:new s({int:i})});e.push(n)}e.push(new s(t.serial)),e.push(new a({name:t.sigalg})),e.push(new d(t.issuer)),e.push(new o({array:[new c(t.notbefore),new c(t.notafter)]})),e.push(new d(t.subject)),e.push(new h(xn.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new r({tag:"a3",obj:new l(t.ext)}));var u=new Ii.asn1.DERSequence({array:e});return u.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.TBSCertificate,Ii.asn1.ASN1Object),Ii.asn1.x509.Extensions=function(e){Ii.asn1.x509.Extensions.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERSequence,r=i.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],s=i.extname,o=null;if(void 0!=i.extn)o=new r.PrivateExtension(i);else if("subjectKeyIdentifier"==s)o=new r.SubjectKeyIdentifier(i);else if("keyUsage"==s)o=new r.KeyUsage(i);else if("subjectAltName"==s)o=new r.SubjectAltName(i);else if("issuerAltName"==s)o=new r.IssuerAltName(i);else if("basicConstraints"==s)o=new r.BasicConstraints(i);else if("nameConstraints"==s)o=new r.NameConstraints(i);else if("cRLDistributionPoints"==s)o=new r.CRLDistributionPoints(i);else if("certificatePolicies"==s)o=new r.CertificatePolicies(i);else if("policyMappings"==s)o=new r.PolicyMappings(i);else if("policyConstraints"==s)o=new r.PolicyConstraints(i);else if("inhibitAnyPolicy"==s)o=new r.InhibitAnyPolicy(i);else if("authorityKeyIdentifier"==s)o=new r.AuthorityKeyIdentifier(i);else if("extKeyUsage"==s)o=new r.ExtKeyUsage(i);else if("authorityInfoAccess"==s)o=new r.AuthorityInfoAccess(i);else if("cRLNumber"==s)o=new r.CRLNumber(i);else if("cRLReason"==s)o=new r.CRLReason(i);else if("ocspNonce"==s)o=new r.OCSPNonce(i);else if("ocspNoCheck"==s)o=new r.OCSPNoCheck(i);else if("adobeTimeStamp"==s)o=new r.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=s)throw new Error("extension not supported:"+JSON.stringify(i));o=new r.SubjectDirectoryAttributes(i)}null!=o&&e.push(o)}var a=new n({array:e});return a.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.x509.Extensions,Ii.asn1.ASN1Object),Ii.asn1.x509.Extension=function(e){Ii.asn1.x509.Extension.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERObjectIdentifier,r=i.DEROctetString,s=(i.DERBitString,i.DERBoolean),o=i.DERSequence;this.tohex=function(){var e=new n({oid:this.oid}),t=new r({hex:this.getExtnValueHex()}),i=new Array;i.push(e),this.critical&&i.push(new s),i.push(t);var a=new o({array:i});return a.tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},kn(Ii.asn1.x509.Extension,Ii.asn1.ASN1Object),Ii.asn1.x509.KeyUsage=function(e){Ii.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,i={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new Ii.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(void 0!=e.names)return Dn(e.names,i);if(void 0!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.KeyUsage,Ii.asn1.x509.Extension),Ii.asn1.x509.BasicConstraints=function(e){Ii.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=Ii.asn1,i=t.DERBoolean,n=t.DERInteger,r=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new i),this.pathLen>-1&&e.push(new n({int:this.pathLen}));var t=new r({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},kn(Ii.asn1.x509.BasicConstraints,Ii.asn1.x509.Extension),Ii.asn1.x509.CRLDistributionPoints=function(e){Ii.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var t=[],r=0;r<e.length;r++)if(e[r]instanceof Ii.asn1.ASN1Object)t.push(e[r]);else{var s=new n.DistributionPoint(e[r]);t.push(s)}this.asn1ExtnValue=new i.DERSequence({array:t})},this.setByOneURI=function(e){var t=new n.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},kn(Ii.asn1.x509.CRLDistributionPoints,Ii.asn1.x509.Extension),Ii.asn1.x509.DistributionPoint=function(e){Ii.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.x509.DistributionPointName;this.tohex=function(){var e=new i.DERSequence;if(null!=this.asn1DP){var t=new i.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(t)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new n(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new n({full:[{uri:e.fulluri}]})))},kn(Ii.asn1.x509.DistributionPoint,Ii.asn1.ASN1Object),Ii.asn1.x509.DistributionPointName=function(e){Ii.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new n({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(i.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new i.x509.GeneralNames(e.full)}},kn(Ii.asn1.x509.DistributionPointName,Ii.asn1.ASN1Object),Ii.asn1.x509.CertificatePolicies=function(e){Ii.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.x509,r=i.DERSequence,s=n.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new s(this.params.array[t]));var i=new r({array:e});return this.asn1ExtnValue=i,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.CertificatePolicies,Ii.asn1.x509.Extension),Ii.asn1.x509.PolicyInformation=function(e){Ii.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=Ii.asn1,i=t.DERSequence,n=t.DERObjectIdentifier,r=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new n(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],s=0;s<this.params.array.length;s++)t.push(new r(this.params.array[s]));t.length>0&&e.push(new i({array:t}))}var o=new i({array:e});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.PolicyInformation,Ii.asn1.ASN1Object),Ii.asn1.x509.PolicyQualifierInfo=function(e){Ii.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=Ii.asn1,i=t.DERSequence,n=t.DERIA5String,r=t.DERObjectIdentifier,s=t.x509.UserNotice;this.params=null,this.tohex=function(){if(void 0!==this.params.cps){var e=new i({array:[new r({oid:"1.3.6.1.5.5.7.2.1"}),new n({str:this.params.cps})]});return e.tohex()}if(void 0!=this.params.unotice){e=new i({array:[new r({oid:"1.3.6.1.5.5.7.2.2"}),new s(this.params.unotice)]});return e.tohex()}},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.PolicyQualifierInfo,Ii.asn1.ASN1Object),Ii.asn1.x509.UserNotice=function(e){Ii.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=Ii.asn1.DERSequence,i=(Ii.asn1.DERInteger,Ii.asn1.x509.DisplayText),n=Ii.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];void 0!==this.params.noticeref&&e.push(new n(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new i(this.params.exptext));var r=new t({array:e});return r.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.UserNotice,Ii.asn1.ASN1Object),Ii.asn1.x509.NoticeReference=function(e){Ii.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=Ii.asn1.DERSequence,i=Ii.asn1.DERInteger,n=Ii.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new n(this.params.org)),void 0!==this.params.noticenum){for(var r=[],s=this.params.noticenum,o=0;o<s.length;o++)r.push(new i(s[o]));e.push(new t({array:r}))}if(0==e.length)throw new Error("parameter is empty");var a=new t({array:e});return a.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.NoticeReference,Ii.asn1.ASN1Object),Ii.asn1.x509.DisplayText=function(e){Ii.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},kn(Ii.asn1.x509.DisplayText,Ii.asn1.DERAbstractString),Ii.asn1.x509.PolicyMappings=function(e){Ii.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=(i.x509,i.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],i=0;i<e.array.length;i++){var r=e.array[i];t.push({seq:[{oid:r[0]},{oid:r[1]}]})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.PolicyMappings,Ii.asn1.x509.Extension),Ii.asn1.x509.PolicyConstraints=function(e){Ii.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=(i.x509,i.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return void 0!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),void 0!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.PolicyConstraints,Ii.asn1.x509.Extension),Ii.asn1.x509.InhibitAnyPolicy=function(e){Ii.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=(i.x509,i.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=n({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.InhibitAnyPolicy,Ii.asn1.x509.Extension),Ii.asn1.x509.NameConstraints=function(e){Ii.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.x509,r=i.ASN1Util.newObject,s=n.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(void 0!=e.permit&&void 0!=e.permit.length){for(var i=[],n=0;n<e.permit.length;n++)i.push(new s(e.permit[n]));t.push({tag:{tagi:"a0",obj:{seq:i}}})}if(void 0!=e.exclude&&void 0!=e.exclude.length){var o=[];for(n=0;n<e.exclude.length;n++)o.push(new s(e.exclude[n]));t.push({tag:{tagi:"a1",obj:{seq:o}}})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.NameConstraints,Ii.asn1.x509.Extension),Ii.asn1.x509.GeneralSubtree=function(e){Ii.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=Ii.asn1,i=t.x509,n=i.GeneralName,r=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new n(e)];void 0!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),void 0!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}});var i=r({seq:t});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.GeneralSubtree,Ii.asn1.ASN1Object),Ii.asn1.x509.ExtKeyUsage=function(e){Ii.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=Ii,i=t.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new i.DERSequence;for(var t=0;t<e.length;t++){var n=new i.DERObjectIdentifier(e[t]);this.asn1ExtnValue.appendASN1Object(n)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},kn(Ii.asn1.x509.ExtKeyUsage,Ii.asn1.x509.Extension),Ii.asn1.x509.AuthorityKeyIdentifier=function(e){Ii.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.DERTaggedObject,r=i.x509.GeneralNames;t.crypto.Util.isKey;this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new n({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new n({explicit:!1,tag:"a1",obj:new r([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new n({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new i.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new Ii.asn1.DEROctetString(e);else if("object"===typeof e&&Ii.crypto.Util.isKey(e)||"string"===typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"===typeof e&&(t=xn.getKey(e));var i=xn.getKeyID(t);this.asn1KID=new Ii.asn1.DEROctetString({hex:i})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new Ii.asn1.x509.X500Name(e):"string"===typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new Ii.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new Ii.asn1.DERInteger(e);else if("string"===typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new Un;t.readCertPEM(e);var i=t.getSerialNumberHex();this.asn1CertSN=new Ii.asn1.DERInteger({hex:i})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"===typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},kn(Ii.asn1.x509.AuthorityKeyIdentifier,Ii.asn1.x509.Extension),Ii.asn1.x509.SubjectKeyIdentifier=function(e){Ii.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new n(e);else if("object"===typeof e&&Ii.crypto.Util.isKey(e)||"string"===typeof e&&-1!=e.indexOf("BEGIN")){var t=e;"string"===typeof e&&(t=xn.getKey(e));var i=xn.getKeyID(t);this.asn1KID=new Ii.asn1.DEROctetString({hex:i})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},kn(Ii.asn1.x509.SubjectKeyIdentifier,Ii.asn1.x509.Extension),Ii.asn1.x509.AuthorityInfoAccess=function(e){Ii.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,i=Ii,n=i.asn1,r=n.DERSequence,s=n.DERObjectIdentifier,o=n.x509.GeneralName,a=0;a<e.length;a++){var c,d=e[a];if(void 0!==d.ocsp)c=new r({array:[new s({oid:"1.3.6.1.5.5.7.48.1"}),new o({uri:d.ocsp})]});else{if(void 0===d.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(d));c=new r({array:[new s({oid:"1.3.6.1.5.5.7.48.2"}),new o({uri:d.caissuer})]})}t.push(c)}this.asn1ExtnValue=new r({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},kn(Ii.asn1.x509.AuthorityInfoAccess,Ii.asn1.x509.Extension),Ii.asn1.x509.SubjectAltName=function(e){Ii.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new Ii.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},kn(Ii.asn1.x509.SubjectAltName,Ii.asn1.x509.Extension),Ii.asn1.x509.IssuerAltName=function(e){Ii.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new Ii.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},kn(Ii.asn1.x509.IssuerAltName,Ii.asn1.x509.Extension),Ii.asn1.x509.SubjectDirectoryAttributes=function(e){Ii.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=Ii.asn1,i=t.DERSequence,n=t.ASN1Util.newObject,r=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var s=this.params.array[t],o={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==s.attr)o.seq[0].oid=r(s.attr),o.seq[1].set[0]={gentime:s.str};else if("placeOfBirth"==s.attr)o.seq[0].oid=r(s.attr),o.seq[1].set[0]={utf8str:s.str};else if("gender"==s.attr)o.seq[0].oid=r(s.attr),o.seq[1].set[0]={prnstr:s.str};else if("countryOfCitizenship"==s.attr)o.seq[0].oid=r(s.attr),o.seq[1].set[0]={prnstr:s.str};else{if("countryOfResidence"!=s.attr)throw new Error("unsupported attribute: "+s.attr);o.seq[0].oid=r(s.attr),o.seq[1].set[0]={prnstr:s.str}}e.push(new n(o))}var a=new i({array:e});return this.asn1ExtnValue=a,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},kn(Ii.asn1.x509.SubjectDirectoryAttributes,Ii.asn1.x509.Extension),Ii.asn1.x509.PrivateExtension=function(e){Ii.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=Ii,i=t.lang.String.isHex,n=t.asn1,r=n.x509.OID.name2oid,s=n.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=r(e.extname),this.params=e},this.getExtnValueHex=function(){if(void 0==this.params.extname||void 0==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&i(e))return e;if("object"==typeof e)try{return s(e).tohex()}catch(t){}throw new Error("unsupported extn value")},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.x509.PrivateExtension,Ii.asn1.x509.Extension),Ii.asn1.x509.CRL=function(e){Ii.asn1.x509.CRL.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DERBitString,s=i.x509,o=s.AlgorithmIdentifier,a=s.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new a(this.params).tohex(),t=new Ii.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var i=t.sign();this.params.sighex=i},this.getPEM=function(){return Zi(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(void 0==e.tbsobj&&(e.tbsobj=new a(e)),void 0==e.sighex&&void 0!=e.cakey&&this.sign(),void 0==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex}));var i=new n({array:t});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.CRL,Ii.asn1.ASN1Object),Ii.asn1.x509.TBSCertList=function(e){Ii.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERInteger,r=i.DERSequence,s=i.DERTaggedObject,o=(i.DERObjectIdentifier,i.x509),a=o.AlgorithmIdentifier,c=o.Time,d=o.Extensions,l=o.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var s=[new n(t[i].sn),new c(t[i].date)];void 0!=t[i].ext&&s.push(new d(t[i].ext)),e.push(new r({array:s}))}return new r({array:e})},this.tohex=function(){var e=[],t=this.params;if(void 0!=t.version){var i=t.version-1,o=new n({int:i});e.push(o)}if(e.push(new a({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new c(t.thisupdate)),void 0!=t.nextupdate&&e.push(new c(t.nextupdate)),void 0!=t.revcert&&e.push(this.getRevCertSequence()),void 0!=t.ext){var h=new d(t.ext);e.push(new s({tag:"a0",explicit:!0,obj:h}))}var u=new r({array:e});return u.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.TBSCertList,Ii.asn1.ASN1Object),Ii.asn1.x509.CRLEntry=function(e){Ii.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=Ii,i=t.asn1;this.setCertSerial=function(e){this.sn=new i.DERInteger(e)},this.setRevocationDate=function(e){this.time=new i.x509.Time(e)},this.tohex=function(){var e=new i.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},kn(Ii.asn1.x509.CRLEntry,Ii.asn1.ASN1Object),Ii.asn1.x509.CRLNumber=function(e){Ii.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Ii.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.CRLNumber,Ii.asn1.x509.Extension),Ii.asn1.x509.CRLReason=function(e){Ii.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Ii.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.CRLReason,Ii.asn1.x509.Extension),Ii.asn1.x509.OCSPNonce=function(e){Ii.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Ii.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.OCSPNonce,Ii.asn1.x509.Extension),Ii.asn1.x509.OCSPNoCheck=function(e){Ii.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Ii.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",void 0!=e&&(this.params=e)},kn(Ii.asn1.x509.OCSPNoCheck,Ii.asn1.x509.Extension),Ii.asn1.x509.AdobeTimeStamp=function(e){Ii.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=Ii,i=t.asn1,n=i.DERInteger,r=i.DERBoolean,s=i.DERSequence,o=i.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new n(1)];return t.push(new o({uri:e.uri})),void 0!=e.reqauth&&t.push(new r(e.reqauth)),this.asn1ExtnValue=new s({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.AdobeTimeStamp,Ii.asn1.x509.Extension),Ii.asn1.x509.X500Name=function(e){Ii.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=Ii,i=t.asn1,n=i.x509,r=n.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var i=e.split("/");i.shift();for(var n=[],s=0;s<i.length;s++)if(i[s].match(/^[^=]+=.+$/))n.push(i[s]);else{var o=n.length-1;n[o]=n[o]+"/"+i[s]}for(s=0;s<n.length;s++)this.asn1Array.push(new r({str:n[s],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var i=n.X500Name.ldapToCompat(e);this.setByString(i,t)},this.setByObject=function(e,t){for(var i in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(i)){var n=new r({str:i+"="+e[i],rule:this.sRule});this.asn1Array?this.asn1Array.push(n):this.asn1Array=[n]}},this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)this.paramArray=e.array;else if(void 0!==e.str)this.setByString(e.str);else if(void 0!==e.ldapstr)this.setByLdapString(e.ldapstr);else if(void 0!==e.hex)this.hTLV=e.hex;else if(void 0!==e.certissuer){var t=new Un;t.readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()}else if(void 0!==e.certsubject){t=new Un;t.readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()}else"object"===typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var t={array:this.paramArray[e]};"utf8"!=this.sRule&&(t.rule=this.sRule);var n=new r(t);this.asn1Array.push(n)}var s=new i.DERSequence({array:this.asn1Array});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.X500Name,Ii.asn1.ASN1Object),Ii.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";e=e.substr(1);var t=e.split("/");return t.reverse(),t=t.map((function(e){return e.replace(/,/,"\\,")})),t.join(",")},Ii.asn1.x509.X500Name.onelineToLDAP=function(e){return Ii.asn1.x509.X500Name.compatToLDAP(e)},Ii.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),i=!1,n=[],r=0;t.length>0;r++){var s=t.shift();if(!0===i){var o=n.pop(),a=(o+","+s).replace(/\\,/g,",");n.push(a),i=!1}else n.push(s);"\\"===s.substr(-1,1)&&(i=!0)}return n=n.map((function(e){return e.replace("/","\\/")})),n.reverse(),"/"+n.join("/")},Ii.asn1.x509.X500Name.ldapToOneline=function(e){return Ii.asn1.x509.X500Name.ldapToCompat(e)},Ii.asn1.x509.RDN=function(e){Ii.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=Ii.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new Ii.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=Ii.asn1.x509.RDN.parseString(e),i=0;i<t.length;i++)this.addByString(t[i])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var i=this.paramArray[e];void 0!==i.rule&&"utf8"!=this.sRule&&(i.rule=this.sRule);var n=new t(i);this.asn1Array.push(n)}var r=new Ii.asn1.DERSet({array:this.asn1Array});return this.TLV=r.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.RDN,Ii.asn1.ASN1Object),Ii.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),i=!1,n=[],r=0;t.length>0;r++){var s=t.shift();if(!0===i){var o=n.pop(),a=(o+"+"+s).replace(/\\\+/g,"+");n.push(a),i=!1}else n.push(s);"\\"===s.substr(-1,1)&&(i=!0)}var c=!1,d=[];for(r=0;n.length>0;r++){s=n.shift();if(!0===c){var l=d.pop();if(s.match(/"$/)){a=(l+"+"+s).replace(/^([^=]+)="(.*)"$/,"$1=$2");d.push(a),c=!1}else d.push(l+"+"+s)}else d.push(s);s.match(/^[^=]+="/)&&(c=!0)}return d},Ii.asn1.x509.AttributeTypeAndValue=function(e){Ii.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DERUTF8String,s=i.DERPrintableString,o=i.DERTeletexString,a=i.DERIA5String,c=i.DERVisibleString,d=i.DERBMPString,l=t.lang.String.isMail,h=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str,i=t.match(/^([^=]+)=(.+)$/);if(!i)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=i[1],this.sValue=i[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var i=e.match(/^([^=]+)=(.+)$/);if(!i)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(i[1],i[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,i=this.sRule;return"prn"===i?"CN"==e&&l(t)?"ia5":h(t)?"prn":"utf8":"utf8"===i?"CN"==e&&l(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,i){void 0!==i&&(this.sRule=i),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new r({str:t});if("prn"==e)return new s({str:t});if("tel"==e)return new o({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new d({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=Ii.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),i=new n({array:[e,t]});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.AttributeTypeAndValue,Ii.asn1.ASN1Object),Ii.asn1.x509.SubjectPublicKeyInfo=function(e){Ii.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERInteger,r=i.DERBitString,s=i.DERObjectIdentifier,o=i.DERSequence,a=i.ASN1Util.newObject,c=i.x509,d=c.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA;this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";var e=new o({array:[this.asn1AlgId,this.asn1SubjPKey]});return e},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof jt){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}),i=t.tohex();this.asn1AlgId=new d({name:"rsaEncryption"}),this.asn1SubjPKey=new r({hex:"00"+i})}}catch(l){}try{if(e instanceof Ii.crypto.ECDSA){var o=new s({name:e.curveName});this.asn1AlgId=new d({name:"ecPublicKey",asn1params:o}),this.asn1SubjPKey=new r({hex:"00"+e.pubKeyHex})}}catch(l){}try{if(e instanceof Ii.crypto.DSA){o=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new d({name:"dsa",asn1params:o});var c=new n({bigint:e.y});this.asn1SubjPKey=new r({hex:"00"+c.tohex()})}}catch(l){}},void 0!==e&&this.setPubKey(e)},kn(Ii.asn1.x509.SubjectPublicKeyInfo,Ii.asn1.ASN1Object),Ii.asn1.x509.Time=function(e){Ii.asn1.x509.Time.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERUTCTime,r=i.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&void 0!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new n(e.str)),"gen"==e.type&&(t=new r(e.str))):t="gen"==this.type?new r:new n,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Ii.asn1.x509.Time_bak=function(e){Ii.asn1.x509.Time_bak.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERUTCTime,r=i.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new n(this.timeParams):new r(this.timeParams):"utc"==this.type?new n:new r,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},kn(Ii.asn1.x509.Time,Ii.asn1.ASN1Object),Ii.asn1.x509.AlgorithmIdentifier=function(e){Ii.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=Ii,i=t.asn1,n=i.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var t in n)t===this.nameAlg&&(e=n[t]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=i.x509.OID.name2obj(this.nameAlg));var r=[this.asn1Alg];null!==this.asn1Params&&r.push(this.asn1Params);var s=new i.DERSequence({array:r});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var r=this.nameAlg.toLowerCase();"withdsa"!==r.substr(-7,7)&&"withecdsa"!==r.substr(-9,9)&&(this.asn1Params=new i.DERNull)}},kn(Ii.asn1.x509.AlgorithmIdentifier,Ii.asn1.ASN1Object),Ii.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},Ii.asn1.x509.GeneralName=function(e){Ii.asn1.x509.GeneralName.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.x509,r=n.X500Name,s=n.OtherName,o=i.DERIA5String,a=(i.DERPrintableString,i.DEROctetString),c=i.DERTaggedObject,d=i.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,i=this.params,n=!1;if(void 0!==i.other)e="a0",t=new s(i.other);else if(void 0!==i.rfc822)e="81",t=new o({str:i.rfc822});else if(void 0!==i.dns)e="82",t=new o({str:i.dns});else if(void 0!==i.dn)e="a4",n=!0,t="string"===typeof i.dn?new r({str:i.dn}):i.dn instanceof Ii.asn1.x509.X500Name?i.dn:new r(i.dn);else if(void 0!==i.ldapdn)e="a4",n=!0,t=new r({ldapstr:i.ldapdn});else if(void 0!==i.certissuer||void 0!==i.certsubj){var h,u;e="a4",n=!0;var p=null;if(void 0!==i.certsubj?(h=!1,u=i.certsubj):(h=!0,u=i.certissuer),u.match(/^[0-9A-Fa-f]+$/),-1!=u.indexOf("-----BEGIN ")&&(p=en(u)),null==p)throw new Error("certsubj/certissuer not cert");var m,f=new Un;f.hex=p,m=h?f.getIssuerHex():f.getSubjectHex(),t=new d,t.hTLV=m}else if(void 0!==i.uri)e="86",t=new o({str:i.uri});else{if(void 0===i.ip)throw new l("improper params");var g;e="87";var _=i.ip;try{if(_.match(/^[0-9a-f]+$/)){var v=_.length;if(8!=v&&16!=v&&32!=v&&64!=v)throw"err";g=_}else g=mn(_)}catch(E){throw new l("malformed IP address: "+i.ip+":"+E.message)}t=new a({hex:g})}var y=new c({tag:e,explicit:n,obj:t});return y.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.GeneralName,Ii.asn1.ASN1Object),Ii.asn1.x509.GeneralNames=function(e){Ii.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=Ii,i=t.asn1;this.setByParamArray=function(e){for(var t=0;t<e.length;t++){var n=new i.x509.GeneralName(e[t]);this.asn1Array.push(n)}},this.tohex=function(){var e=new i.DERSequence({array:this.asn1Array});return e.tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,"undefined"!=typeof e&&this.setByParamArray(e)},kn(Ii.asn1.x509.GeneralNames,Ii.asn1.ASN1Object),Ii.asn1.x509.OtherName=function(e){Ii.asn1.x509.OtherName.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.DERObjectIdentifier,r=i.DERSequence,s=i.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(void 0==e.oid||void 0==e.value)throw new Error("oid or value not specified");var t=new n({oid:e.oid}),i=s({tag:{tag:"a0",explicit:!0,obj:e.value}}),o=new r({array:[t,i]});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.x509.OtherName,Ii.asn1.ASN1Object),Ii.asn1.x509.OID=new function(){var e=Ii.asn1.DERObjectIdentifier;this.name2oidList={sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if("undefined"!=typeof this.objCache[t])return this.objCache[t];if("undefined"==typeof this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var i=this.name2oidList[t],n=new e({oid:i});return this.objCache[t]=n,n},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var i;if(t.match(/^\d+\.\d+\.[0-9.]+$/))i=t;else if(void 0!==this.atype2oidList[t])i=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);i=this.name2oidList[t]}var n=new e({oid:i});return this.objCache[t]=n,n},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,i){var n=this[e];if(!n.match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(i){return!1}}},Ii.asn1.x509.OID.oid2name=function(e){var t=Ii.asn1.x509.OID.name2oidList;for(var i in t)if(t[i]==e)return i;return""},Ii.asn1.x509.OID.oid2atype=function(e){var t=Ii.asn1.x509.OID.atype2oidList;for(var i in t)if(t[i]==e)return i;return e},Ii.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=Ii.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},Ii.asn1.x509.X509Util={},Ii.asn1.x509.X509Util.newCertPEM=function(e){var t=Ii.asn1.x509,i=(t.TBSCertificate,t.Certificate),n=new i(e);return n.getPEM()},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),"undefined"!=typeof Ii.asn1.cms&&Ii.asn1.cms||(Ii.asn1.cms={}),Ii.asn1.cms.Attribute=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.DERSet,o=n.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new o({oid:this.typeOid}),t=new s({array:this.getValueArray()}),i=new r({array:[e,t]});return i.tohex()},this.getEncodedHex=function(){return this.tohex()}},kn(Ii.asn1.cms.Attribute,Ii.asn1.ASN1Object),Ii.asn1.cms.ContentType=function(e){var t=Ii,i=t.asn1;i.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){var e=new i.DERObjectIdentifier(this.params.type);return[e]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.ContentType,Ii.asn1.cms.Attribute),Ii.asn1.cms.MessageDigest=function(e){var t=Ii,i=t.asn1,n=i.DEROctetString,r=i.cms;r.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){var e=new n(this.params);return[e]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.MessageDigest,Ii.asn1.cms.Attribute),Ii.asn1.cms.SigningTime=function(e){var t=Ii,i=t.asn1;i.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){var e=new i.x509.Time(this.params);return[e]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SigningTime,Ii.asn1.cms.Attribute),Ii.asn1.cms.SigningCertificate=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.cms,o=s.ESSCertID;i.crypto;s.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||void 0==this.params||void 0==this.params.array)throw new t("parameter 'array' not specified");for(var i=this.params.array,n=[],s=0;s<i.length;s++){var a=i[s];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!Oi.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new o(a))}var c=new r({array:n}),d=new r({array:[c]});return[d]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SigningCertificate,Ii.asn1.cms.Attribute),Ii.asn1.cms.ESSCertID=function(e){Ii.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,i=Ii,n=i.asn1,r=n.DEROctetString,s=n.DERSequence,o=n.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,n){if(void 0!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!Oi.isASN1HEX(e))return e;var r,s,o;if("string"==typeof e)r=e;else{if(void 0==e.cert)throw new t("hash nor cert unspecified");r=e.cert}if(s=-1!=r.indexOf("-----BEGIN")?en(r):r,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?s=en(e):Oi.isASN1HEX(e)&&(s=e)),void 0!=e.alg)o=e.alg;else{if(void 0==n)throw new t("hash alg unspecified");o=n}return i.crypto.Util.hashHex(s,o)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),i=[];i.push(new r({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||void 0!=e.cert&&0!=e.hasis||void 0!=e.issuer&&void 0!=e.serial)&&i.push(new o(e));var n=new s({array:i});return n.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.ESSCertID,Ii.asn1.ASN1Object),Ii.asn1.cms.SigningCertificateV2=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=(n.x509,n.cms),o=s.ESSCertIDv2;i.crypto;s.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||void 0==this.params||void 0==this.params.array)throw new t("parameter 'array' not specified");for(var i=this.params.array,n=[],s=0;s<i.length;s++){var a=i[s];void 0==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!Oi.isASN1HEX(a)||(a={cert:a}),void 0==a.alg&&void 0!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new o(a))}var c=new r({array:n}),d=new r({array:[c]});return[d]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SigningCertificateV2,Ii.asn1.cms.Attribute),Ii.asn1.cms.ESSCertIDv2=function(e){Ii.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);Error;var t=Ii,i=t.asn1,n=i.DEROctetString,r=i.DERSequence,s=i.cms.IssuerSerial,o=i.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),i=[];void 0!=e.alg&&"sha256"!=e.alg&&i.push(new o({name:e.alg})),i.push(new n({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||void 0!=e.cert&&0!=e.hasis||void 0!=e.issuer&&void 0!=e.serial)&&i.push(new s(e));var a=new r({array:i});return a.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.ESSCertIDv2,Ii.asn1.cms.ESSCertID),Ii.asn1.cms.IssuerSerial=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERInteger,s=n.DERSequence,o=n.cms,a=n.x509,c=a.GeneralNames,d=Un;o.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,i,n=this.params;if("string"==typeof n&&-1!=n.indexOf("-----BEGIN")||void 0!=n.cert){var o;o=void 0!=n.cert?n.cert:n;var a=new d;a.readCertPEM(o),e=a.getIssuer(),i={hex:a.getSerialNumberHex()}}else{if(void 0==n.issuer||!n.serial)throw new t("cert or issuer and serial parameter not specified");e=n.issuer,i=n.serial}var l=new c([{dn:e}]),h=new r(i),u=new s({array:[l,h]});return u.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.IssuerSerial,Ii.asn1.ASN1Object),Ii.asn1.cms.SignerIdentifier=function(e){var t=Ii,i=t.asn1,n=(i.DERInteger,i.DERSequence,i.cms),r=n.IssuerAndSerialNumber,s=n.SubjectKeyIdentifier,o=i.x509;o.X500Name,Error;n.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type){var t=new r(e);return t.tohex()}if("skid"==e.type){var i=new s(e);return i.tohex()}throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SignerIdentifier,Ii.asn1.ASN1Object),Ii.asn1.cms.IssuerAndSerialNumber=function(e){var t=Ii,i=t.asn1,n=i.DERInteger,r=i.DERSequence,s=i.cms,o=i.x509,a=o.X500Name,c=Un,d=Error;s.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||void 0!=i.cert){var s;s=void 0!=i.cert?i.cert:i;var o=new c;o.readCertPEM(s),e=o.getIssuer(),t={hex:o.getSerialNumberHex()}}else{if(void 0==i.issuer||!i.serial)throw new d("cert or issuer and serial parameter not specified");e=i.issuer,t=i.serial}var l=new a(e),h=new n(t),u=new r({array:[l,h]});return u.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.IssuerAndSerialNumber,Ii.asn1.ASN1Object),Ii.asn1.cms.SubjectKeyIdentifier=function(e){var t=Ii,i=t.asn1,n=(i.DERInteger,i.DERSequence,i.ASN1Util.newObject),r=i.cms,s=(r.IssuerAndSerialName,r.SubjectKeyIdentifier,i.x509),o=(s.X500Name,Un),a=Error;r.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(void 0==t.cert&&void 0==t.skid)throw new a("property cert nor skid undefined");if(void 0!=t.cert){var i=new o(t.cert),r=i.getExtSubjectKeyIdentifier();e=r.kid.hex}else void 0!=t.skid&&(e=t.skid);var s=n({tag:{tage:"a0",obj:{octstr:{hex:e}}}});return s.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SubjectKeyIdentifier,Ii.asn1.ASN1Object),Ii.asn1.cms.AttributeList=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSet,s=n.cms;s.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var i=!0;void 0!=e.sortflag&&(i=e.sortflag);for(var n=e.array,o=[],a=0;a<n.length;a++){var c=n[a],d=c.attr;if("contentType"==d)o.push(new s.ContentType(c));else if("messageDigest"==d)o.push(new s.MessageDigest(c));else if("signingTime"==d)o.push(new s.SigningTime(c));else if("signingCertificate"==d)o.push(new s.SigningCertificate(c));else if("signingCertificateV2"==d)o.push(new s.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==d)o.push(new Ii.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=d&&"timeStampToken"!=d)throw new t("unknown attr: "+d);o.push(new Ii.asn1.cades.SignatureTimeStamp(c))}}var l=new r({array:o,sortflag:i});return this.hTLV=l.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.AttributeList,Ii.asn1.ASN1Object),Ii.asn1.cms.SignerInfo=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERInteger,s=n.DEROctetString,o=n.DERSequence,a=n.DERTaggedObject,c=n.cms,d=c.SignerIdentifier,l=c.AttributeList,h=(c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData,n.x509),u=h.AlgorithmIdentifier,p=i.crypto,m=xn;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,i=new l(e.sattrs).tohex(),n=m.getKey(e.signkey),r=new p.Signature({alg:t});r.init(n),r.updateHex(i);var s=r.sign();e.sighex=s},this.tohex=function(){var e=this.params,i=[];if(i.push(new r({int:e.version})),i.push(new d(e.id)),i.push(new u({name:e.hashalg})),void 0!=e.sattrs){var n=new l(e.sattrs);try{i.push(new a({tag:"a0",explicit:!1,obj:n}))}catch(h){throw new t("si sattr error: "+h)}}if(void 0!=e.sigalgfield?i.push(new u({name:e.sigalgfield})):i.push(new u({name:e.sigalg})),void 0==e.sighex&&void 0!=e.signkey&&this.sign(),i.push(new s({hex:e.sighex})),void 0!=e.uattrs){n=new l(e.uattrs);try{i.push(new a({tag:"a1",explicit:!1,obj:n}))}catch(h){throw new t("si uattr error: "+h)}}var c=new o({array:i});return c.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SignerInfo,Ii.asn1.ASN1Object),Ii.asn1.cms.EncapsulatedContentInfo=function(e){var t=Ii,i=t.asn1,n=i.DERTaggedObject,r=i.DERSequence,s=i.DERObjectIdentifier,o=i.DEROctetString,a=i.cms;a.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new s(e.type)),void 0!=e.content&&(void 0!=e.content.hex||void 0!=e.content.str)&&1!=e.isDetached){var i=new o(e.content),a=new n({tag:"a0",explicit:!0,obj:i});t.push(a)}var c=new r({array:t});return c.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.EncapsulatedContentInfo,Ii.asn1.ASN1Object),Ii.asn1.cms.ContentInfo=function(e){var t=Ii,i=t.asn1,n=i.DERTaggedObject,r=i.DERSequence,s=i.DERObjectIdentifier,o=i.x509;o.OID.name2obj;Ii.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new s(e.type));var i=new n({tag:"a0",explicit:!0,obj:e.obj});t.push(i);var o=new r({array:t});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.ContentInfo,Ii.asn1.ASN1Object),Ii.asn1.cms.SignedData=function(e){Error;var t=Ii,i=t.asn1,n=(i.ASN1Object,i.DERInteger),r=i.DERSet,s=i.DERSequence,o=(i.DERTaggedObject,i.cms),a=o.EncapsulatedContentInfo,c=o.SignerInfo,d=o.ContentInfo,l=o.CertificateSet,h=o.RevocationInfoChoices,u=i.x509,p=u.AlgorithmIdentifier;Ii.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},i=e.sinfos,n=0;n<i.length;n++){var r=i[n];t[r.hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,i=e.sinfos,n=0;n<i.length;n++){var r=i[n],s=this._getAttrParamByName(r,"contentType");s.type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent,i=(e.econtent.type,t.content.hex);void 0==i&&"data"==t.type&&void 0!=t.content.str&&(i=Yi(t.content.str));for(var n=e.sinfos,r=0;r<n.length;r++){var s=n[r],o=s.hashalg,a=this._getAttrParamByName(s,"messageDigest"),c=Ii.crypto.Util.hashHex(i,o);a.hex=c}},this._getAttrParamByName=function(e,t){for(var i=e.sattrs.array,n=0;n<i.length;n++)if(i[n].attr==t)return i[n]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,i=0;i<t.length;i++){var n=t[i],r=1;"skid"==n.id.type&&(r=3),n.version=r}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(void 0!=e.revinfos)for(var t=e.revinfos,i=0;i<t.length;i++){var n=t[i];if(void 0!=n.ocsp)return 5}var r=e.sinfos;for(i=0;i<r.length;i++){var s=e.sinfos[i];if(3==s.version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;void 0!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new n({int:e.version}));for(var i=[],o=0;o<e.hashalgs.length;o++){var d=e.hashalgs[o];i.push(new p({name:d}))}t.push(new r({array:i})),t.push(new a(e.econtent)),void 0!=e.certs&&t.push(new l(e.certs)),void 0!=e.revinfos&&t.push(new h(e.revinfos));var u=[];for(o=0;o<e.sinfos.length;o++){var m=e.sinfos[o];u.push(new c(m))}t.push(new r({array:u}));var f=new s({array:t});return f.tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){var e=new d({type:"signed-data",obj:this});return e},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.SignedData,Ii.asn1.ASN1Object),Ii.asn1.cms.CertificateSet=function(e){Ii.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,i=Ii.asn1,n=i.DERTaggedObject,r=i.DERSet,s=i.ASN1Object;this.params=null,this.tohex=function(){var e,i=this.params,o=[];if(i instanceof Array)e=i;else{if(void 0==i.array)throw new t("cert array not specified");e=i.array}for(var a=0;a<e.length;a++){var c=e[a],d=en(c),l=new s;l.hTLV=d,o.push(l)}var h={array:o};0==i.sortflag&&(h.sortflag=!1);var u=new r(h),p=new n({tag:"a0",explicit:!1,obj:u});return p.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.CertificateSet,Ii.asn1.ASN1Object),Ii.asn1.cms.RevocationInfoChoices=function(e){Ii.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],i=0;i<e.length;i++)t.push(new Ii.asn1.cms.RevocationInfoChoice(e[i]));var n=Ii.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}});return n.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.RevocationInfoChoices,Ii.asn1.ASN1Object),Ii.asn1.cms.RevocationInfoChoice=function(e){Ii.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(void 0!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=en(e.crl)),t}if(void 0!=e.ocsp){var i=Ii.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new Ii.asn1.cms.OtherRevocationFormat(e)}});return i.tohex()}throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.RevocationInfoChoice,Ii.asn1.ASN1Object),Ii.asn1.cms.OtherRevocationFormat=function(e){Ii.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,i=Ii,n=i.asn1,r=n.ASN1Util.newObject,s=i.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.ocsp)throw new t("property ocsp not specified");if(!s(e.ocsp)||!Oi.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");var i=r({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cms.OtherRevocationFormat,Ii.asn1.ASN1Object),Ii.asn1.cms.CMSUtil=new function(){},Ii.asn1.cms.CMSUtil.newSignedData=function(e){return new Ii.asn1.cms.SignedData(e)},Ii.asn1.cms.CMSUtil.verifySignedData=function(e){var t=Ii,i=t.asn1,n=i.cms,r=(n.SignerInfo,n.SignedData,n.SigningTime,n.SigningCertificate,n.SigningCertificateV2,i.cades),s=(r.SignaturePolicyIdentifier,t.lang.String.isHex),o=Oi,a=o.getVbyList,c=o.getTLVbyList,d=o.getIdxbyList,l=o.getChildIdx,h=o.getTLV,u=o.oidname,p=t.crypto.Util.hashHex;void 0===e.cms&&s(e.cms);var m=e.cms,f=function(e,t){for(var i,n=3;n<6;n++)if(i=d(e,0,[1,0,n]),void 0!==i){var r=e.substr(i,2);"a0"===r&&(t.certsIdx=i),"a1"===r&&(t.revinfosIdx=i),"31"===r&&(t.signerinfosIdx=i)}},g=function(e,t){var i=t.signerinfosIdx;if(void 0!==i){var n=l(e,i);t.signerInfoIdxList=n;for(var r=0;r<n.length;r++){var s=n[r],o={idx:s};_(e,o),t.signerInfos.push(o)}}},_=function(e,t){var i=t.idx;t.signerid_issuer1=c(e,i,[1,0],"30"),t.signerid_serial1=a(e,i,[1,1],"02"),t.hashalg=u(a(e,i,[2,0],"06"));var n=d(e,i,[3],"a0");t.idxSignedAttrs=n,v(e,t,n);var r=l(e,i),s=r.length;if(s<6)throw"malformed SignerInfo";t.sigalg=u(a(e,i,[s-2,0],"06")),t.sigval=a(e,i,[s-1],"04")},v=function(e,t,i){var n=l(e,i);t.signedAttrIdxList=n;for(var r=0;r<n.length;r++){var s,o=n[r],c=a(e,o,[0],"06");"2a864886f70d010905"===c?(s=Gi(a(e,o,[1,0])),t.saSigningTime=s):"2a864886f70d010904"===c&&(s=a(e,o,[1,0],"04"),t.saMessageDigest=s)}},y=function(e,t){if("2a864886f70d010702"!==a(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=a(e,0,[1,0,2,1,0]),f(e,t),t.signerInfos=[],g(e,t)},E=function(e,t){for(var i=t.parse.signerInfos,n=i.length,r=!0,s=0;s<n;s++){var o=i[s];b(e,t,o,s),o.isValid||(r=!1)}t.isValid=r},S=function(e,t,i,n){var r,s=t.parse.certsIdx;if(void 0===t.certs){r=[],t.certkeys=[];for(var o=l(e,s),a=0;a<o.length;a++){var c=h(e,o[a]),d=new Un;d.readCertHex(c),r[a]=d,t.certkeys[a]=d.getPublicKey()}t.certs=r}else r=t.certs;t.cccc=r.length,t.cccci=o.length;for(a=0;a<r.length;a++){var u=d.getIssuerHex(),p=d.getSerialNumberHex();i.signerid_issuer1===u&&i.signerid_serial1===p&&(i.certkey_idx=a)}},b=function(e,t,i,n){i.verifyDetail={};var r=i.verifyDetail,s=t.parse.econtent,o=i.hashalg,a=i.saMessageDigest;r.validMessageDigest=!1,p(s,o)===a&&(r.validMessageDigest=!0),S(e,t,i,n),r.validSignatureValue=!1;var c=i.sigalg,d="31"+h(e,i.idxSignedAttrs).substr(2);i.signedattrshex=d;var l=t.certs[i.certkey_idx].getPublicKey(),u=new Ii.crypto.Signature({alg:c});u.init(l),u.updateHex(d);var m=u.verify(i.sigval);r.validSignatureValue_isValid=m,!0===m&&(r.validSignatureValue=!0),i.isValid=!1,r.validMessageDigest&&r.validSignatureValue&&(i.isValid=!0)},w={isValid:!1,parse:{}};return y(m,w.parse),E(m,w),w},Ii.asn1.cms.CMSParser=function(){var e=Error,t=Un,i=new t,n=Oi,r=n.getV,s=n.getTLV,o=(n.getIdxbyList,n.getTLVbyList),a=n.getTLVbyListEx,c=n.getVbyList,d=n.getVbyListEx,l=n.getChildIdx;this.getCMSSignedData=function(e){var t=o(e,0,[1,0]),i=this.getSignedData(t);return i},this.getSignedData=function(e){var t=l(e,0),i={},n=r(e,t[0]),o=parseInt(n,16);i.version=o;var c=s(e,t[1]);i.hashalgs=this.getHashAlgArray(c);var d=s(e,t[2]);i.econtent=this.getEContent(d);var h=a(e,0,["[0]"]);null!=h&&(i.certs=this.getCertificateSet(h));a(e,0,["[1]"]);var u=a(e,0,[3]);return i.sinfos=this.getSignerInfos(u),i},this.getHashAlgArray=function(e){for(var i=l(e,0),n=new t,r=[],o=0;o<i.length;o++){var a=s(e,i[o]),c=n.getAlgorithmIdentifierName(a);r.push(c)}return r},this.getEContent=function(e){var t={},i=c(e,0,[0]),n=c(e,0,[1,0]);return t.type=Ii.asn1.x509.OID.oid2name(Oi.hextooidstr(i)),t.content={hex:n},t},this.getSignerInfos=function(e){for(var t=[],i=l(e,0),n=0;n<i.length;n++){var r=s(e,i[n]),o=this.getSignerInfo(r);t.push(o)}return t},this.getSignerInfo=function(e){var t={},r=l(e,0),o=n.getInt(e,r[0],-1);-1!=o&&(t.version=o);var c=s(e,r[1]),h=this.getIssuerAndSerialNumber(c);t.id=h;var u=s(e,r[2]),p=i.getAlgorithmIdentifierName(u);t.hashalg=p;var m=a(e,0,["[0]"]);if(null!=m){var f=this.getAttributeList(m);t.sattrs=f}var g=a(e,0,[3]),_=i.getAlgorithmIdentifierName(g);t.sigalg=_;var v=d(e,0,[4]);t.sighex=v;var y=a(e,0,["[1]"]);if(null!=y){var E=this.getAttributeList(y);t.uattrs=E}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},n=l(e,0),o=s(e,n[0]);t.issuer=i.getX500Name(o);var a=r(e,n[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],i=l(e,0),n=0;n<i.length;n++){var r=s(e,i[n]),o=this.getAttribute(r);t.push(o)}return{array:t}},this.getAttribute=function(e){var t={},i=l(e,0),r=n.getOID(e,i[0]),o=Ii.asn1.x509.OID.oid2name(r);t.attr=o;var a=s(e,i[1]),c=l(a,0);if(1==c.length)t.valhex=s(a,c[0]);else{for(var d=[],h=0;h<c.length;h++)d.push(s(a,c[h]));t.valhex=d}return"contentType"==o?this.setContentType(t):"messageDigest"==o?this.setMessageDigest(t):"signingTime"==o?this.setSigningTime(t):"signingCertificate"==o?this.setSigningCertificate(t):"signingCertificateV2"==o?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==o&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=n.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=r(e.valhex,0),i=Gi(t);e.str=i,delete e.valhex},this.setMessageDigest=function(e){var t=r(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=l(e.valhex,0);if(t.length>0){for(var i=s(e.valhex,t[0]),n=l(i,0),r=[],o=0;o<n.length;o++){var a=s(i,n[o]),c=this.getESSCertID(a);r.push(c)}e.array=r}if(t.length>1){var d=s(e.valhex,t[1]);e.polhex=d}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var i=l(e.valhex,0);if(i.length>0){var o=n.getOID(e.valhex,i[0]);e.oid=o}if(i.length>1){var a=new t,c=l(e.valhex,i[1]),d=s(e.valhex,c[0]),h=a.getAlgorithmIdentifierName(d);e.alg=h;var u=r(e.valhex,c[1]);e.hash=u}delete e.valhex},this.setSigningCertificateV2=function(e){var t=l(e.valhex,0);if(t.length>0){for(var i=s(e.valhex,t[0]),n=l(i,0),r=[],o=0;o<n.length;o++){var a=s(i,n[o]),c=this.getESSCertIDv2(a);r.push(c)}e.array=r}if(t.length>1){var d=s(e.valhex,t[1]);e.polhex=d}delete e.valhex},this.getESSCertID=function(e){var t={},i=l(e,0);if(i.length>0){var n=r(e,i[0]);t.hash=n}if(i.length>1){var o=s(e,i[1]),a=this.getIssuerSerial(o);void 0!=a.serial&&(t.serial=a.serial),void 0!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var n={},o=l(t,0);if(o.length<1||3<o.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(o[0],2)){var c=s(t,o[0]);n.alg=i.getAlgorithmIdentifierName(c),a++}else n.alg="sha256";var d=r(t,o[a]);if(n.hash=d,o.length>a+1){var h=s(t,o[a+1]),u=this.getIssuerSerial(h);n.issuer=u.issuer,n.serial=u.serial}return n},this.getIssuerSerial=function(e){var t={},n=l(e,0),o=s(e,n[0]),a=i.getGeneralNames(o),c=a[0].dn;t.issuer=c;var d=r(e,n[1]);return t.serial={hex:d},t},this.getCertificateSet=function(e){for(var t=l(e,0),i=[],n=0;n<t.length;n++){var r=s(e,t[n]);if("30"==r.substr(0,2)){var o=Zi(r,"CERTIFICATE");i.push(o)}}return{array:i,sortflag:!1}}},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),"undefined"!=typeof Ii.asn1.tsp&&Ii.asn1.tsp||(Ii.asn1.tsp={}),Ii.asn1.tsp.TimeStampToken=function(e){var t=Ii,i=t.asn1,n=i.tsp;n.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new n.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.TimeStampToken,Ii.asn1.cms.SignedData),Ii.asn1.tsp.TSTInfo=function(e){Error;var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DERInteger,s=i.DERBoolean,o=i.DERGeneralizedTime,a=i.DERObjectIdentifier,c=i.DERTaggedObject,d=i.tsp,l=d.MessageImprint,h=d.Accuracy,u=(i.x509.X500Name,i.x509.GeneralName);if(d.TSTInfo.superclass.constructor.call(this),this.dVersion=new r({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new a({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new r(e.serial)),void 0!==e.genTime&&(this.dGenTime=new o(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new h(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new s),void 0!==e.nonce&&(this.dNonce=new r(e.nonce)),void 0!==e.tsa&&(this.dTsa=new c({tag:"a0",explicit:!0,obj:new u({dn:e.tsa})}))}},kn(Ii.asn1.tsp.TSTInfo,Ii.asn1.ASN1Object),Ii.asn1.tsp.Accuracy=function(e){var t=Ii,i=t.asn1,n=i.ASN1Util.newObject;i.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return void 0!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),void 0!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),void 0!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.Accuracy,Ii.asn1.ASN1Object),Ii.asn1.tsp.MessageImprint=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DEROctetString,s=i.x509,o=s.AlgorithmIdentifier;i.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new o({name:e.alg}),i=new r({hex:e.hash}),s=new n({array:[t,i]});return s.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.tsp.MessageImprint,Ii.asn1.ASN1Object),Ii.asn1.tsp.TimeStampReq=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DERInteger,s=i.DERBoolean,o=(i.ASN1Object,i.DERObjectIdentifier),a=i.tsp,c=a.MessageImprint;a.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new r({int:1})),e.messageImprint instanceof Ii.asn1.ASN1Object?t.push(e.messageImprint):t.push(new c(e.messageImprint)),void 0!=e.policy&&t.push(new o(e.policy)),void 0!=e.nonce&&t.push(new r(e.nonce)),1==e.certreq&&t.push(new s);var i=new n({array:t});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.TimeStampReq,Ii.asn1.ASN1Object),Ii.asn1.tsp.TimeStampResp=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=(i.ASN1Object,i.tsp),s=r.PKIStatusInfo;r.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(void 0!=e.econtent||void 0!=e.tst)if(void 0!=e.statusinfo?t.push(new s(e.statusinfo)):t.push(new s("granted")),void 0!=e.econtent)t.push(new r.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof i.ASN1Object))throw new Error("improper member tst value");t.push(e.tst)}else{if(void 0==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");t.push(new s(e.statusinfo))}var o=new n({array:t});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.TimeStampResp,Ii.asn1.ASN1Object),Ii.asn1.tsp.PKIStatusInfo=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.tsp,o=s.PKIStatus,a=s.PKIFreeText,c=s.PKIFailureInfo;s.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,i=[];if("string"==typeof e)i.push(new o(e));else{if(void 0==e.status)throw new t("property 'status' unspecified");i.push(new o(e.status)),void 0!=e.statusstr&&i.push(new a(e.statusstr)),void 0!=e.failinfo&&i.push(new c(e.failinfo))}var n=new r({array:i});return n.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.PKIStatusInfo,Ii.asn1.ASN1Object),Ii.asn1.tsp.PKIStatus=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERInteger,s=n.tsp;s.PKIStatus.superclass.constructor.call(this);var o={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,i=this.params;if("string"==typeof i)try{e=o[i]}catch(Hs){throw new t("undefined name: "+i)}else{if("number"!=typeof i)throw new t("unsupported params");e=i}return new r({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.PKIStatus,Ii.asn1.ASN1Object),Ii.asn1.tsp.PKIFreeText=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.DERUTF8String,o=n.tsp;o.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var i=[],n=0;n<e.length;n++)i.push(new s({str:e[n]}));var o=new r({array:i});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.PKIFreeText,Ii.asn1.ASN1Object),Ii.asn1.tsp.PKIFailureInfo=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERBitString,s=n.tsp,o=s.PKIFailureInfo,a={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};o.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,i=0;if("number"==typeof e&&0<=e&&e<=25){i|=1<<e;for(var n=i.toString(2),r="",s=n.length-1;s>=0;s--)r+=n[s];return r}if("string"==typeof e&&void 0!=a[e])return Dn([e],a);if("object"==typeof e&&void 0!=e.length)return Dn(e,a);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new r({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.tsp.PKIFailureInfo,Ii.asn1.ASN1Object),Ii.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},Ii.asn1.tsp.SimpleTSAAdapter=function(e){var t=Ii,i=t.asn1,n=i.tsp,r=t.crypto.Util.hashHex;n.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var i=r(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i},this.params.econtent.content.serial={int:this.serial++};var s=Math.floor(1e9*Math.random());this.params.econtent.content.nonce={int:s};var o=new n.TimeStampToken(this.params);return o.getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.tsp.SimpleTSAAdapter,Ii.asn1.tsp.AbstractTSAAdapter),Ii.asn1.tsp.FixedTSAAdapter=function(e){var t=Ii,i=t.asn1,n=i.tsp,r=t.crypto.Util.hashHex;n.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var i=r(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i};var s=new n.TimeStampToken(this.params);return s.getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},kn(Ii.asn1.tsp.FixedTSAAdapter,Ii.asn1.tsp.AbstractTSAAdapter),Ii.asn1.tsp.TSPUtil=new function(){},Ii.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new Ii.asn1.tsp.TimeStampToken(e)},Ii.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){var t=new Ii.asn1.tsp.TSPParser;return t.getTimeStampReq(e)},Ii.asn1.tsp.TSPUtil.parseMessageImprint=function(e){var t=new Ii.asn1.tsp.TSPParser;return t.getMessageImprint(e)},Ii.asn1.tsp.TSPParser=function(){Error;var e=Un,t=new e,i=Oi,n=i.getV,r=i.getTLV,s=i.getIdxbyList,o=(i.getTLVbyListEx,i.getChildIdx),a=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],c={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=o(e,0);if(1==t.length)return this.getPKIStatusInfo(r(e,t[0]));if(t.length>1){var i=this.getPKIStatusInfo(r(e,t[0])),n=r(e,t[1]),s=this.getToken(n);return s.statusinfo=i,s}},this.getToken=function(e){var t=new Ii.asn1.cms.CMSParser,i=t.getCMSSignedData(e);return this.setTSTInfo(i),i},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var i=t.content.hex,n=this.getTSTInfo(i);t.content=n}},this.getTSTInfo=function(e){var i={},s=o(e,0),a=n(e,s[1]);i.policy=Rn(a);var c=r(e,s[2]);i.messageImprint=this.getMessageImprint(c);var d=n(e,s[3]);i.serial={hex:d};var l=n(e,s[4]);i.genTime={str:Gi(l)};var h=0;if(s.length>5&&"30"==e.substr(s[5],2)){var u=r(e,s[5]);i.accuracy=this.getAccuracy(u),h++}if(s.length>5+h&&"01"==e.substr(s[5+h],2)){var p=n(e,s[5+h]);"ff"==p&&(i.ordering=!0),h++}if(s.length>5+h&&"02"==e.substr(s[5+h],2)){var m=n(e,s[5+h]);i.nonce={hex:m},h++}if(s.length>5+h&&"a0"==e.substr(s[5+h],2)){var f=r(e,s[5+h]);f="30"+f.substr(2),pGeneralNames=t.getGeneralNames(f);var g=pGeneralNames[0].dn;i.tsa=g,h++}if(s.length>5+h&&"a1"==e.substr(s[5+h],2)){var _=r(e,s[5+h]);_="30"+_.substr(2);var v=t.getExtParamArray(_);i.ext=v,h++}return i},this.getAccuracy=function(e){for(var t={},i=o(e,0),r=0;r<i.length;r++){var s=e.substr(i[r],2),a=n(e,i[r]),c=parseInt(a,16);"02"==s?t.seconds=c:"80"==s?t.millis=c:"81"==s&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var t={},r=(o(e,0),s(e,0,[0,0])),a=n(e,r),c=i.hextooidstr(a),d=Ii.asn1.x509.OID.oid2name(c);if(""==d)throw new Error("hashAlg name undefined: "+c);var l=d,h=s(e,0,[1]);return t.alg=l,t.hash=n(e,h),t},this.getPKIStatusInfo=function(e){var t={},i=o(e,0),s=0;try{var c=n(e,i[0]),d=parseInt(c,16);t.status=a[d]}catch(u){}if(i.length>1&&"30"==e.substr(i[1],2)){var l=r(e,i[1]);t.statusstr=this.getPKIFreeText(l),s++}if(i.length>s&&"03"==e.substr(i[1+s],2)){var h=r(e,i[1+s]);t.failinfo=this.getPKIFailureInfo(h)}return t},this.getPKIFreeText=function(e){for(var t=[],n=o(e,0),r=0;r<n.length;r++)t.push(i.getString(e,n[r]));return t},this.getPKIFailureInfo=function(e){var t=i.getInt(e,0);return void 0!=c[t]?c[t]:t},this.getTimeStampReq=function(e){var t={certreq:!1},s=o(e,0);if(s.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=r(e,s[1]);t.messageImprint=Ii.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<s.length;c++){var d=s[c],l=e.substr(d,2);if("06"==l){var h=n(e,d);t.policy=i.hextooidstr(h)}"02"==l&&(t.nonce=n(e,d)),"01"==l&&(t.certreq=!0)}return t}},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),"undefined"!=typeof Ii.asn1.cades&&Ii.asn1.cades||(Ii.asn1.cades={}),Ii.asn1.cades.SignaturePolicyIdentifier=function(e){var t=Ii,i=t.asn1,n=i.cades,r=n.SignaturePolicyId;n.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new r(this.params)]},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.SignaturePolicyIdentifier,Ii.asn1.cms.Attribute),Ii.asn1.cades.SignaturePolicyId=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.DERObjectIdentifier,s=i.x509,o=(s.AlgorithmIdentifier,i.cades),a=o.SignaturePolicyId,c=o.OtherHashAlgAndValue;a.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new r(e.oid)),t.push(new c(e));var i=new n({array:t});return i.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.SignaturePolicyId,Ii.asn1.ASN1Object),Ii.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.DEROctetString,o=n.x509,a=o.AlgorithmIdentifier,c=n.cades,d=c.OtherHashAlgAndValue;d.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.alg)throw new t("property 'alg' not specified");if(void 0==e.hash&&void 0==e.cert)throw new t("property 'hash' nor 'cert' not specified");var i=null;if(void 0!=e.hash)i=e.hash;else if(void 0!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var n=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(n=en(e.cert)),i=Ii.crypto.Util.hashHex(n,e.alg)}var o=[];o.push(new a({name:e.alg})),o.push(new s({hex:i}));var c=new r({array:o});return c.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.OtherHashAlgAndValue,Ii.asn1.ASN1Object),Ii.asn1.cades.OtherHashValue=function(e){Ii.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,i=Ii,n=(i.lang.String.isHex,i.asn1),r=n.DEROctetString;i.crypto.Util.hashHex;this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.hash&&void 0==e.cert)throw new t("hash or cert not specified");var i=null;if(void 0!=e.hash)i=e.hash;else if(void 0!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var n=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(n=en(e.cert)),i=Ii.crypto.Util.hashHex(n,"sha1")}return new r({hex:i}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.OtherHashValue,Ii.asn1.ASN1Object),Ii.asn1.cades.SignatureTimeStamp=function(e){var t=Error,i=Ii,n=i.lang.String.isHex,r=i.asn1,s=r.ASN1Object,o=(r.x509,r.cades);o.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(void 0!=e.tst){if(n(e.tst)){var i=new s;return i.hTLV=e.tst,[i]}if(e.tst instanceof s)return[e.tst];throw new t("params.tst has wrong value")}if(void 0!=e.res){var r=e.res;if(r instanceof s&&(r=r.tohex()),"string"!=typeof r||!n(r))throw new t("params.res has wrong value");Oi.getTLVbyList(r,0,[1]),i=new s;return i.hTLV=e.tst,[i]}},null!=e&&this.setByParam(e)},kn(Ii.asn1.cades.SignatureTimeStamp,Ii.asn1.cms.Attribute),Ii.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.cades,o=s.OtherCertID,a=i.lang.String.isHex;s.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,i=[],n=0;n<e.array.length;n++){var s=e.array[n];if("string"==typeof s)if(-1!=s.indexOf("-----BEGIN"))s={cert:s};else{if(!a(s))throw new t("unsupported value: "+s);s={hash:s}}void 0!=e.alg&&void 0==s.alg&&(s.alg=e.alg),void 0!=e.hasis&&void 0==s.hasis&&(s.hasis=e.hasis);var c=new o(s);i.push(c)}var d=new r({array:i});return[d]},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.CompleteCertificateRefs,Ii.asn1.cms.Attribute),Ii.asn1.cades.OtherCertID=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.cms,s=r.IssuerSerial,o=i.cades,a=o.OtherHashValue,c=o.OtherHashAlgAndValue;o.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],i=null;if(i=void 0!=e.alg?new c(e):new a(e),t.push(i),void 0!=e.cert&&1==e.hasis||void 0!=e.issuer&&void 0!=e.serial){var r=new s(e);t.push(r)}var o=new n({array:t});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.OtherCertID,Ii.asn1.ASN1Object),Ii.asn1.cades.OtherHash=function(e){Error;var t=Ii,i=t.asn1,n=(i.cms,i.cades),r=n.OtherHashAlgAndValue,s=n.OtherHashValue,o=(t.crypto.Util.hashHex,t.lang.String.isHex);n.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:o(e)&&(e={hash:e}));var t=null;return t=void 0!=e.alg?new r(e):new s(e),t.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.cades.OtherHash,Ii.asn1.ASN1Object),Ii.asn1.cades.CAdESUtil=new function(){},Ii.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){var t=new Ii.asn1.cms.CMSParser,i=t.getCMSSignedData(e);return i},Ii.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,i){var n=Oi,r=n.getChildIdx,s=n.getTLV,o=n.getV,a=Ii,c=a.asn1,d=c.ASN1Object,l=c.cms,h=l.AttributeList,u=l.SignerInfo,p={},m=r(e,t);if(6!=m.length)throw"not supported items for SignerInfo (!=6)";var f=m.shift();p.version=s(e,f);var g=m.shift();p.si=s(e,g);var _=m.shift();p.digalg=s(e,_);var v=m.shift();p.sattrs=s(e,v);var y=m.shift();p.sigalg=s(e,y);var E=m.shift();p.sig=s(e,E),p.sigval=o(e,E);var S=null;return p.obj=new u,S=new d,S.hTLV=p.version,p.obj.dCMSVersion=S,S=new d,S.hTLV=p.si,p.obj.dSignerIdentifier=S,S=new d,S.hTLV=p.digalg,p.obj.dDigestAlgorithm=S,S=new d,S.hTLV=p.sattrs,p.obj.dSignedAttrs=S,S=new d,S.hTLV=p.sigalg,p.obj.dSigAlg=S,S=new d,S.hTLV=p.sig,p.obj.dSig=S,p.obj.dUnsignedAttrs=new h,p},"undefined"!=typeof Ii.asn1.csr&&Ii.asn1.csr||(Ii.asn1.csr={}),Ii.asn1.csr.CertificationRequest=function(e){var t=Ii,i=t.asn1,n=i.DERBitString,r=i.DERSequence,s=i.csr,o=(i.x509,s.CertificationRequestInfo);s.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new Ii.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var i=t.sign();this.params.sighex=i},this.getPEM=function(){return Zi(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new Ii.asn1.csr.CertificationRequestInfo(this.params),i=new Ii.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(void 0==e.sighex&&void 0!=e.sbjprvkey&&this.sign(),void 0==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var s=new n({hex:"00"+e.sighex}),o=new r({array:[t,i,s]});return o.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.csr.CertificationRequest,Ii.asn1.ASN1Object),Ii.asn1.csr.CertificationRequestInfo=function(e){var t=Ii,i=t.asn1,n=(i.DERBitString,i.DERSequence),r=i.DERInteger,s=i.DERUTF8String,o=i.DERTaggedObject,a=i.ASN1Util.newObject,c=i.csr,d=i.x509,l=d.X500Name,h=d.Extensions,u=d.SubjectPublicKeyInfo;c.AttributeList;function p(e){for(var t=Error,i=Ii.asn1.x509.Extensions,n=[],r=0;r<e.length;r++){var s=e[r],o=s.attr;if("extensionRequest"==o){var a=new i(s.ext),c={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[a]}]};n.push(c)}else if("unstructuredName"==o){c={seq:[{oid:"1.2.840.113549.1.9.2"},{set:s.names}]};n.push(c)}else{if("challengePassword"!=o)throw new t("unknown CSR attribute");c={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:s.password}]}]};n.push(c)}}return{set:n}}c.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){void 0!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new r({int:0})),t.push(new l(e.subject)),t.push(new u(xn.getKey(e.sbjpubkey))),void 0!=e.attrs){var i=p(e.attrs),c=a({tag:{tage:"a0",obj:i}});t.push(c)}else if(void 0!=e.extreq){var d=new h(e.extreq);c=a({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[d]}]}}});t.push(c)}else t.push(new o({tag:"a0",explicit:!1,obj:new s({str:""})}));var m=new n({array:t});return m.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},kn(Ii.asn1.csr.CertificationRequestInfo,Ii.asn1.ASN1Object),Ii.asn1.csr.AttributeList=function(e){},kn(Ii.asn1.csr.AttributeList,Ii.asn1.ASN1Object),Ii.asn1.csr.CSRUtil=new function(){},Ii.asn1.csr.CSRUtil.newCSRPEM=function(e){var t=Ii.asn1.csr,i=new t.CertificationRequest(e),n=i.getPEM();return n},Ii.asn1.csr.CSRUtil.getParam=function(e,t){var i=Oi,n=i.getV,r=i.getIdxbyList,s=i.getTLVbyList,o=i.getTLVbyListEx,a=i.getVbyListEx,c=function(e){var t=r(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=n(e,t)?null:s(e,0,[0,3,0,1,0],"30")},d={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=en(e,"CERTIFICATE REQUEST");t&&(d.tbs=s(l,0,[0]));try{var h=o(l,0,[0,1]);if("3000"==h)d.subject={};else{var u=new Un;d.subject=u.getX500Name(h)}}catch(v){}var p=o(l,0,[0,2]),m=xn.getKey(p,null,"pkcs8pub");d.sbjpubkey=xn.getPEM(m,"PKCS8PUB");var f=c(l);u=new Un;null!=f&&(d.extreq=u.getExtParamArray(f));try{var g=o(l,0,[1],"30");u=new Un;d.sigalg=u.getAlgorithmIdentifierName(g)}catch(v){}try{var _=a(l,0,[2]);d.sighex=_}catch(v){}return d},Ii.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=Ii.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&void 0!=e.sbjpubkey&&void 0!=e.sigalg&&void 0!=e.sighex&&void 0!=e.tbs&&(t=e),null==t)return!1;var i=new Ii.crypto.Signature({alg:t.sigalg});return i.init(t.sbjpubkey),i.updateHex(t.tbs),i.verify(t.sighex)}catch(n){return alert(n),!1}},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.asn1&&Ii.asn1||(Ii.asn1={}),"undefined"!=typeof Ii.asn1.ocsp&&Ii.asn1.ocsp||(Ii.asn1.ocsp={}),Ii.asn1.ocsp.DEFAULT_HASH="sha1",Ii.asn1.ocsp.OCSPResponse=function(e){Ii.asn1.ocsp.OCSPResponse.superclass.constructor.call(this);Ii.asn1.DEREnumerated;var t=Ii.asn1.ASN1Util.newObject,i=Ii.asn1.ocsp.ResponseBytes,n=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:n.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,n=this._getStatusCode();if(-1==n)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=n)return t({seq:[{enum:{int:n}}]}).tohex();var r=new i(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:r}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.OCSPResponse,Ii.asn1.ASN1Object),Ii.asn1.ocsp.ResponseBytes=function(e){Ii.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=Ii.asn1,i=t.DERSequence,n=t.DERObjectIdentifier,r=t.DEROctetString,s=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new s(e),o=[];o.push(new n({name:"ocspBasic"})),o.push(new r({hex:t.tohex()}));var a=new i({array:o});return a.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.ResponseBytes,Ii.asn1.ASN1Object),Ii.asn1.ocsp.BasicOCSPResponse=function(e){Ii.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,i=Ii.asn1,n=i.ASN1Object,r=i.DERSequence,s=(i.DERGeneralizedTime,i.DERTaggedObject),o=i.DERBitString,a=(i.x509.Extensions,i.x509.AlgorithmIdentifier),c=i.ocsp;c.ResponderID;_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),i=new Ii.crypto.Signature({alg:e.sigalg});i.init(e.reskey),i.updateHex(t),e.sighex=i.sign()},this.tohex=function(){var e=this.params;void 0==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),void 0==e.sighex&&void 0!=e.reskey&&this.sign();var i=[];if(i.push(e.tbsresp),i.push(new a({name:e.sigalg})),i.push(new o({hex:"00"+e.sighex})),void 0!=e.certs&&void 0!=e.certs.length){for(var c=[],d=0;d<e.certs.length;d++){var l=e.certs[d],h=null;if(Oi.isASN1HEX(l))h=l;else{if(!l.match(/-----BEGIN/))throw new t("certs["+d+"] not hex or PEM");h=en(l)}c.push(new n({tlv:h}))}var u=new r({array:c});i.push(new s({tag:"a0",explicit:!0,obj:u}))}var p=new r({array:i});return p.tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.BasicOCSPResponse,Ii.asn1.ASN1Object),Ii.asn1.ocsp.ResponseData=function(e){Ii.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=Error,i=Ii.asn1,n=i.DERSequence,r=i.DERGeneralizedTime,s=i.DERTaggedObject,o=i.x509.Extensions,a=i.ocsp,c=a.ResponderID;_SingleResponseList=a.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;void 0!=e.respid&&new t("respid not specified"),void 0!=e.prodat&&new t("prodat not specified"),void 0!=e.array&&new t("array not specified");var i=[];if(i.push(new c(e.respid)),i.push(new r(e.prodat)),i.push(new _SingleResponseList(e.array)),void 0!=e.ext){var a=new o(e.ext);i.push(new s({tag:"a1",explicit:!0,obj:a}))}var d=new n({array:i});return d.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.ResponseData,Ii.asn1.ASN1Object),Ii.asn1.ocsp.ResponderID=function(e){Ii.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=Ii,i=t.asn1,n=i.ASN1Util.newObject,r=i.x509.X500Name,s=t.lang.String.isHex,o=Error;this.params=null,this.tohex=function(){var e=this.params;if(void 0!=e.key){var t=null;if("string"==typeof e.key){if(s(e.key)&&(t=e.key),e.key.match(/-----BEGIN CERTIFICATE/)){var i=new Un(e.key),a=i.getExtSubjectKeyIdentifier();null!=a&&(t=a.kid.hex)}}else if(e.key instanceof Un){a=e.key.getExtSubjectKeyIdentifier();null!=a&&(t=a.kid.hex)}if(null==t)throw new o("wrong key member value");var c=n({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:t}}}});return c.tohex()}if(void 0!=e.name){var d=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/)){i=new Un(e.name);d=i.getSubject()}else e.name instanceof Un?d=e.name.getSubject():"object"!=typeof e.name||void 0==e.name.array&&void 0==e.name.str||(d=e.name);if(null==d)throw new o("wrong name member value");c=n({tag:{tag:"a1",explicit:!0,obj:new r(d)}});return c.tohex()}throw new o("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.ResponderID,Ii.asn1.ASN1Object),Ii.asn1.ocsp.SingleResponseList=function(e){Ii.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=Ii.asn1,i=t.DERSequence,n=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||void 0==e.length)throw new Error("params not specified properly");for(var t=[],r=0;r<e.length;r++)t.push(new n(e[r]));var s=new i({array:t});return s.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.SingleResponseList,Ii.asn1.ASN1Object),Ii.asn1.ocsp.SingleResponse=function(e){var t=Error,i=Ii,n=i.asn1,r=n.DERSequence,s=n.DERGeneralizedTime,o=n.DERTaggedObject,a=n.ocsp,c=a.CertID,d=a.CertStatus,l=n.x509,h=l.Extensions;a.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,i=[];if(void 0==e.certid)throw new t("certid unspecified");if(void 0==e.status)throw new t("status unspecified");if(void 0==e.thisupdate)throw new t("thisupdate unspecified");if(i.push(new c(e.certid)),i.push(new d(e.status)),i.push(new s(e.thisupdate)),void 0!=e.nextupdate){var n=new s(e.nextupdate);i.push(new o({tag:"a0",explicit:!0,obj:n}))}if(void 0!=e.ext){var a=new h(e.ext);i.push(new o({tag:"a1",explicit:!0,obj:a}))}var l=new r({array:i});return l.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.SingleResponse,Ii.asn1.ASN1Object),Ii.asn1.ocsp.CertID=function(e){var t=Ii,i=t.asn1,n=i.DEROctetString,r=i.DERInteger,s=i.DERSequence,o=i.x509,a=o.AlgorithmIdentifier,c=i.ocsp,d=(c.DEFAULT_HASH,t.crypto),l=d.Util.hashHex,h=Un,u=Oi,p=u.getVbyList;c.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,i,n){void 0==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issname:e,isskey:t,sbjsn:i}},this.setByCert=function(e,t,i){void 0==i&&(i=this.DEFAULT_HASH),this.params={alg:i,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,i){void 0==i&&(i=this.DEFAULT_HASH);var n=new h(e),r=new h(t),s=l(n.getSubjectHex(),i),o=n.getPublicKeyHex(),a=l(p(o,0,[1],"03",!0),i),c=r.getSerialNumberHex(),d={alg:i,issname:s,isskey:a,sbjsn:c};return d},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,i,o,c=this.params;if(o=void 0==c.alg?this.DEFAULT_HASH:c.alg,void 0!=c.issuerCert&&void 0!=c.subjectCert){var d=this.getParamByCerts(c.issuerCert,c.subjectCert,o);e=d.issname,t=d.isskey,i=d.sbjsn}else{if(void 0==c.issname||void 0==c.isskey||void 0==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,i=c.sbjsn}var l=new a({name:o}),h=new n({hex:e}),u=new n({hex:t}),p=new r({hex:i}),m=new s({array:[l,h,u,p]});return this.hTLV=m.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.CertID,Ii.asn1.ASN1Object),Ii.asn1.ocsp.CertStatus=function(e){Ii.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];void 0!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var i={tag:"a1",explicit:!1,obj:{seq:t}};return Ii.asn1.ASN1Util.newObject({tag:i}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},kn(Ii.asn1.ocsp.CertStatus,Ii.asn1.ASN1Object),Ii.asn1.ocsp.Request=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.ocsp;if(r.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},"undefined"!==typeof e){var s=new r.CertID(e);this.dReqCert=s}},kn(Ii.asn1.ocsp.Request,Ii.asn1.ASN1Object),Ii.asn1.ocsp.TBSRequest=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.ocsp;r.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],i=0;i<e.length;i++){var n=new r.Request(e[0]);t.push(n)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new n({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var i=new n({array:e});return this.hTLV=i.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},kn(Ii.asn1.ocsp.TBSRequest,Ii.asn1.ASN1Object),Ii.asn1.ocsp.OCSPRequest=function(e){var t=Ii,i=t.asn1,n=i.DERSequence,r=i.ocsp;if(r.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var s=new r.TBSRequest(e);this.dTbsRequest=s}},kn(Ii.asn1.ocsp.OCSPRequest,Ii.asn1.ASN1Object),Ii.asn1.ocsp.OCSPUtil={},Ii.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,i){var n=Ii,r=n.asn1,s=r.ocsp;void 0===i&&(i=s.DEFAULT_HASH);var o={alg:i,issuerCert:e,subjectCert:t},a=new s.OCSPRequest({reqList:[o]});return a.tohex()},Ii.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=Oi,i=t.getVbyList,n=t.getVbyListEx,r=t.getIdxbyList,s=(t.getIdxbyListEx,t.getV),o={};try{var a=n(e,0,[0],"0a");o.responseStatus=parseInt(a,16)}catch(h){}if(0!==o.responseStatus)return o;try{var c=r(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?o.certStatus="good":"a1"===e.substr(c,2)?(o.certStatus="revoked",o.revocationTime=Gi(i(e,c,[0]))):"82"===e.substr(c,2)&&(o.certStatus="unknown")}catch(h){}try{var d=r(e,0,[1,0,1,0,0,2,0,2]);o.thisUpdate=Gi(s(e,d))}catch(h){}try{var l=r(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(l,2)&&(o.nextUpdate=Gi(i(e,l,[0])))}catch(h){}return o},Ii.asn1.ocsp.OCSPParser=function(){var e=Error,t=Un,i=new t,n=Oi,r=n.getV,s=n.getTLV,o=n.getIdxbyList,a=n.getVbyList,c=n.getTLVbyList,d=n.getVbyListEx,l=n.getTLVbyListEx,h=n.getChildIdx;this.getOCSPRequest=function(t){var i=h(t,0);if(1!=i.length&&2!=i.length)throw new e("wrong number elements: "+i.length);var n=this.getTBSRequest(s(t,i[0]));return n},this.getTBSRequest=function(e){var t={},n=l(e,0,[0],"30");t.array=this.getRequestList(n);var r=l(e,0,["[2]",0],"30");return null!=r&&(t.ext=i.getExtParamArray(r)),t},this.getRequestList=function(e){for(var t=[],i=h(e,0),n=0;n<i.length;n++){e=s(e,i[n]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var n=h(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);var r=this.getCertID(s(t,n[0]));if(2==n.length){var a=o(t,0,[1,0]);r.ext=i.getExtParamArray(s(t,a))}return r},this.getCertID=function(i){var n=h(i,0);if(4!=n.length)throw new e("wrong number elements: "+n.length);var o=new t,a={};return a.alg=o.getAlgorithmIdentifierName(s(i,n[0])),a.issname=r(i,n[1]),a.isskey=r(i,n[2]),a.sbjsn=r(i,n[3]),a},this.getOCSPResponse=function(e){var t,i=h(e,0),n=r(e,i[0]),s=parseInt(n);if(1==i.length)return{resstatus:s};var o=c(e,0,[1,0]);return t=this.getResponseBytes(o),t.resstatus=s,t},this.getResponseBytes=function(e){var t,i=h(e,0),n=c(e,0,[1,0]);t=this.getBasicOCSPResponse(n);var s=r(e,i[0]);return t.restype=Ii.asn1.x509.OID.oid2name(Rn(s)),t},this.getBasicOCSPResponse=function(e){var t,i=h(e,0);t=this.getResponseData(s(e,i[0]));var n=new Un;t.alg=n.getAlgorithmIdentifierName(s(e,i[1]));var o=r(e,i[2]);t.sighex=o.substr(2);var a=d(e,0,["[0]"]);if(null!=a){for(var c=h(a,0),l=[],u=0;u<c.length;u++){var p=s(a,c[u]);l.push(p)}t.certs=l}return t},this.getResponseData=function(e){var t=h(e,0),i=t.length,n={},o=0;"a0"==e.substr(t[0],2)&&o++,n.respid=this.getResponderID(s(e,t[o++]));var a=r(e,t[o++]);if(n.prodat=Gi(a),n.array=this.getSingleResponseList(s(e,t[o++])),"a1"==e.substr(t[i-1],2)){var d=c(e,t[i-1],[0]),l=new Un;n.ext=l.getExtParamArray(d)}return n},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var i=a(e,0,[0]);t.key=i}if("a1"==e.substr(0,2)){var n=c(e,0,[0]),r=new Un;t.name=r.getX500Name(n)}return t},this.getSingleResponseList=function(e){for(var t=h(e,0),i=[],n=0;n<t.length;n++){var r=this.getSingleResponse(s(e,t[n]));i.push(r)}return i},this.getSingleResponse=function(e){var t=h(e,0),i={},n=this.getCertID(s(e,t[0]));i.certid=n;var o=this.getCertStatus(s(e,t[1]));if(i.status=o,"18"==e.substr(t[2],2)){var d=r(e,t[2]);i.thisupdate=Gi(d)}for(var l=3;l<t.length;l++){if("a0"==e.substr(t[l],2)){var u=a(e,t[l],[0],"18");i.nextupdate=Gi(u)}if("a1"==e.substr(t[l],2)){var p=new Un,m=c(e,0,[l,0]);i.ext=p.getExtParamArray(m)}}return i},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var i=a(e,0,[0]),n=Gi(i);t.time=n}return t}},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.lang&&Ii.lang||(Ii.lang={}),Ii.lang.String=function(){},"function"===typeof Buffer?(Ai=function(e){return Ui(Buffer.from(e,"utf8").toString("base64"))},Pi=function(e){return Buffer.from(ji(e),"base64").toString("utf8")}):(Ai=function(e){return Vi(cn(_n(e)))},Pi=function(e){return decodeURIComponent(dn(Bi(e)))}),Ii.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},Ii.lang.String.isHex=function(e){return En(e)},Ii.lang.String.isBase64=function(e){return e=e.replace(/\s+/g,""),!(!e.match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},Ii.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=ji(e),Ii.lang.String.isBase64(e))},Ii.lang.String.isIntegerArray=function(e){return e=e.replace(/\s+/g,""),!!e.match(/^\[[0-9,]+\]$/)},Ii.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},Ii.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},Ii.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var Tn=function(e,t){var i=e.length;e.length>t.length&&(i=t.length);for(var n=0;n<i;n++)if(e.charCodeAt(n)!=t.charCodeAt(n))return n;return e.length!=t.length?i:-1};function Cn(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},i=function(e){var i="",n=parseInt(e,10),r=n.toString(2),s=7-r.length%7;7==s&&(s=0);for(var o="",a=0;a<s;a++)o+="0";r=o+r;for(a=0;a<r.length-1;a+=7){var c=r.substr(a,7);a!=r.length-7&&(c="1"+c),i+=t(parseInt(c,2))}return i};try{if(!e.match(/^[0-9.]+$/))return null;var n="",r=e.split("."),s=40*parseInt(r[0],10)+parseInt(r[1],10);n+=t(s),r.splice(0,2);for(var o=0;o<r.length;o++)n+=i(r[o]);return n}catch(a){return null}}function Rn(e){if(!En(e))return null;try{var t=[],i=e.substr(0,2),n=parseInt(i,16);t[0]=new String(Math.floor(n/40)),t[1]=new String(n%40);for(var r=e.substr(2),s=[],o=0;o<r.length/2;o++)s.push(parseInt(r.substr(2*o,2),16));var a=[],c="";for(o=0;o<s.length;o++)128&s[o]?c+=In((127&s[o]).toString(2),7):(c+=In((127&s[o]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var d=t.join(".");return a.length>0&&(d=d+"."+a.join(".")),d}catch(l){return null}}var In=function(e,t,i){return void 0==i&&(i="0"),e.length>=t?e:new Array(t-e.length+1).join(i)+e};function An(e){if(e.length%2!=0)return-1;if(e=e.toLowerCase(),null==e.match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var i=parseInt(t,16);if(i>7)return-1;var n=e.substr(2),r=parseInt(n,16).toString(2);"0"==r&&(r="00000000"),r=r.slice(0,0-i);var s=parseInt(r,2);return NaN==s?-1:s}catch(o){return-1}}function Pn(e){if("number"!=typeof e)return null;if(e<0)return null;var t=Number(e).toString(2),i=8-t.length%8;8==i&&(i=0),t+=In("",i,"0");var n=parseInt(t,2).toString(16);n.length%2==1&&(n="0"+n);var r="0"+i;return r+n}function On(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var i=e.substr(2),n="",r=0;r<i.length;r+=2){var s=i.substr(r,2),o=parseInt(s,16).toString(2);o=("0000000"+o).slice(-8),n+=o}return n.substr(0,n.length-t)}catch(a){return null}}function Nn(e){if("string"!=typeof e)return null;if(null==e.match(/^[01]+$/))return null;try{var t=parseInt(e,2);return Pn(t)}catch(i){return null}}function Dn(e,t){for(var i=0,n=0;n<e.length;n++)i|=1<<t[e[n]];var r=i.toString(2),s="";for(n=r.length-1;n>=0;n--)s+=r[n];return s}function kn(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.crypto&&Ii.crypto||(Ii.crypto={}),Ii.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:n.algo.MD5,sha1:n.algo.SHA1,sha224:n.algo.SHA224,sha256:n.algo.SHA256,sha384:n.algo.SHA384,sha512:n.algo.SHA512,ripemd160:n.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if("undefined"==typeof this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,i){var n=this.getDigestInfoHex(e,t),r=i/4;if(n.length+22>r)throw"key is too short for SigAlg: keylen="+i+","+t;for(var s="0001",o="00"+n,a="",c=r-s.length-o.length,d=0;d<c;d+=2)a+="ff";var l=s+a+o;return l},this.hashString=function(e,t){var i=new Ii.crypto.MessageDigest({alg:t});return i.digestString(e)},this.hashHex=function(e,t){var i=new Ii.crypto.MessageDigest({alg:t});return i.digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof jt||e instanceof Ii.crypto.DSA||e instanceof Ii.crypto.ECDSA}},Ii.crypto.Util.md5=function(e){var t=new Ii.crypto.MessageDigest({alg:"md5",prov:"cryptojs"});return t.digestString(e)},Ii.crypto.Util.ripemd160=function(e){var t=new Ii.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"});return t.digestString(e)},Ii.crypto.Util.SECURERANDOMGEN=new xt,Ii.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return Ii.crypto.Util.SECURERANDOMGEN.nextBytes(t),ki(t)},Ii.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new u(Ii.crypto.Util.getRandomHexOfNbytes(e),16)},Ii.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,i=(e-t)/8,n=new Array(i+1);return Ii.crypto.Util.SECURERANDOMGEN.nextBytes(n),n[0]=(255<<t&255^255)&n[0],ki(n)},Ii.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new u(Ii.crypto.Util.getRandomHexOfNbits(e),16)},Ii.crypto.Util.getRandomBigIntegerZeroToMax=function(e){var t=e.bitLength();while(1){var i=Ii.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(i))return i}},Ii.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var i=e.compareTo(t);if(1==i)throw"biMin is greater than biMax";if(0==i)return e;var n=t.subtract(e),r=Ii.crypto.Util.getRandomBigIntegerZeroToMax(n);return r.add(e)},Ii.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(e=Ii.crypto.MessageDigest.getCanonicalAlgName(e),null!==e&&void 0===t&&(t=Ii.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=Ii.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(i){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+i}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=n.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return e.toString(n.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(i){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+i}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=Ii.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},Ii.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"===typeof e&&(e=e.toLowerCase(),e=e.replace(/-/,"")),e},Ii.crypto.MessageDigest.getHashLength=function(e){var t=Ii.crypto.MessageDigest,i=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[i])throw"not supported algorithm: "+e;return t.HASHLENGTH[i]},Ii.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},Ii.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(e=e.toLowerCase(),null==e&&(e="hmacsha1"),e=e.toLowerCase(),"hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=Ii.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var i=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(i)&&"cryptojs"==t){try{var r=Ii.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[i];this.mac=n.algo.HMAC.create(r,this.pass)}catch(s){throw"setAlgAndProvider hash alg set fail hashAlg="+i+"/"+s}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=n.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){var e=this.mac.finalize();return e.toString(n.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=Yi(e)),void(this.pass=n.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=Ki(e.utf8)),void 0!==e.rstr&&(t=Yi(e.rstr)),void 0!==e.b64&&(t=c(e.b64)),void 0!==e.b64u&&(t=Bi(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=n.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=Ii.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},Ii.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var i="",n=t/4-e.length,r=0;r<n;r++)i+="0";return i+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new Ii.crypto.MessageDigest({alg:this.mdAlgName})}catch(i){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+i)}this.init=function(e,t){var i=null;try{i=void 0===t?xn.getKey(e):xn.getKey(e,t)}catch(n){throw"init failed:"+n}if(!0===i.isPrivate)this.prvKey=i,this.state="SIGN";else{if(!0!==i.isPublic)throw"init failed.:"+i;this.pubKey=i,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==Ii.crypto.ECDSA&&(this.prvKey=new Ii.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof jt&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof jt&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof Ii.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof Ii.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==Ii.crypto.ECDSA&&(this.pubKey=new Ii.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof jt&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof jt&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==Ii.crypto.ECDSA&&this.pubKey instanceof Ii.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==Ii.crypto.DSA&&this.pubKey instanceof Ii.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=Ii.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=xn.getKey(e.prvkeypem);this.init(t)}catch(i){throw"fatal error to load pem private key: "+i}}},Ii.crypto.Cipher=function(e){},Ii.crypto.Cipher.encrypt=function(e,t,i){if(t instanceof jt&&t.isPublic){var n=Ii.crypto.Cipher.getAlgByKeyAndName(t,i);if("RSA"===n)return t.encrypt(e);if("RSAOAEP"===n)return t.encryptOAEP(e,"sha1");var r=n.match(/^RSAOAEP(\d+)$/);if(null!==r)return t.encryptOAEP(e,"sha"+r[1]);throw"Cipher.encrypt: unsupported algorithm for RSAKey: "+i}throw"Cipher.encrypt: unsupported key or algorithm"},Ii.crypto.Cipher.decrypt=function(e,t,i){if(t instanceof jt&&t.isPrivate){var n=Ii.crypto.Cipher.getAlgByKeyAndName(t,i);if("RSA"===n)return t.decrypt(e);if("RSAOAEP"===n)return t.decryptOAEP(e,"sha1");var r=n.match(/^RSAOAEP(\d+)$/);if(null!==r)return t.decryptOAEP(e,"sha"+r[1]);throw"Cipher.decrypt: unsupported algorithm for RSAKey: "+i}throw"Cipher.decrypt: unsupported key or algorithm"},Ii.crypto.Cipher.getAlgByKeyAndName=function(e,t){if(e instanceof jt){if(-1!=":RSA:RSAOAEP:RSAOAEP224:RSAOAEP256:RSAOAEP384:RSAOAEP512:".indexOf(t))return t;if(null===t||void 0===t)return"RSA";throw"getAlgByKeyAndName: not supported algorithm name for RSAKey: "+t}throw"getAlgByKeyAndName: not supported algorithm name: "+t},Ii.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.crypto&&Ii.crypto||(Ii.crypto={}),Ii.crypto.ECDSA=function(e){var t="secp256r1",i=Error,n=u,r=ci,s=Ii.crypto.ECDSA,o=Ii.crypto.ECParameterDB,a=s.getName,c=Oi,d=c.getVbyListEx,l=c.isASN1HEX,h=new xt;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new n(e.bitLength(),h).mod(e.subtract(n.ONE)).add(n.ONE)},this.setNamedCurve=function(e){this.ecparams=o.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var i={};return i.x=e.substr(2,t),i.y=e.substr(2+t),i},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),i=this.ecparams.keycharlen,n=("0000000000"+t.toString(16)).slice(-i);this.setPrivateKeyHex(n);var r=this.generatePublicKeyHex();return{ecprvhex:n,ecpubhex:r}},this.generatePublicKeyHex=function(){var e=new n(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),i=t.getX().toBigInteger(),r=t.getY().toBigInteger(),s=this.ecparams.keycharlen,o=("0000000000"+i.toString(16)).slice(-s),a=("0000000000"+r.toString(16)).slice(-s),c="04"+o+a;return this.setPublicKeyHex(c),c},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var i=new n(t,16),r=this.ecparams.n,o=new n(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(r),c=this.ecparams.G,d=c.multiply(a),l=d.getX().toBigInteger().mod(r)}while(l.compareTo(n.ZERO)<=0);var h=a.modInverse(r).multiply(o.add(i.multiply(l))).mod(r);return s.biRSSigToASN1Sig(l,h)},this.sign=function(e,t){var i=t,r=this.ecparams.n,s=n.fromByteArrayUnsigned(e);do{var o=this.getBigRandom(r),a=this.ecparams.G,c=a.multiply(o),d=c.getX().toBigInteger().mod(r)}while(d.compareTo(u.ZERO)<=0);var l=o.modInverse(r).multiply(s.add(i.multiply(d))).mod(r);return this.serializeSig(d,l)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,i){try{var o,a,c=s.parseSigHex(t);o=c.r,a=c.s;var d=r.decodeFromHex(this.ecparams.curve,i),l=new n(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(l,o,a,d)}catch(h){return!1}},this.verify=function(e,t,i){var s,o,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);s=c.r,o=c.s}else{if("object"!==typeof t||!t.r||!t.s)throw"Invalid value for signature";s=t.r,o=t.s}if(i instanceof ci)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=r.decodeFrom(this.ecparams.curve,i)}var d=n.fromByteArrayUnsigned(e);return this.verifyRaw(d,s,o,a)},this.verifyRaw=function(e,t,i,r){var s=this.ecparams.n,o=this.ecparams.G;if(t.compareTo(n.ONE)<0||t.compareTo(s)>=0)return!1;if(i.compareTo(n.ONE)<0||i.compareTo(s)>=0)return!1;var a=i.modInverse(s),c=e.multiply(a).mod(s),d=t.multiply(a).mod(s),l=o.multiply(c).add(r.multiply(d)),h=l.getX().toBigInteger().mod(s);return h.equals(t)},this.serializeSig=function(e,t){var i=e.toByteArraySigned(),n=t.toByteArraySigned(),r=[];return r.push(2),r.push(i.length),r=r.concat(i),r.push(2),r.push(n.length),r=r.concat(n),r.unshift(r.length),r.unshift(48),r},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(t=2,2!=e[t])throw new Error("First element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);if(t+=2+e[t+1],2!=e[t])throw new Error("Second element in signature must be a DERInteger");var r=e.slice(t+2,t+2+e[t+1]);t+=2+e[t+1];var s=n.fromByteArrayUnsigned(i),o=n.fromByteArrayUnsigned(r);return{r:s,s:o}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var i=this.ecparams.n,r=n.fromByteArrayUnsigned(e.slice(1,33)).mod(i),s=n.fromByteArrayUnsigned(e.slice(33,65)).mod(i);return{r:r,s:s,i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,i,n;try{t=d(e,0,["[0]",0],"06"),i=d(e,0,[1],"04");try{n=d(e,0,["[1]",0],"03")}catch(r){}}catch(r){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=a(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(n),this.setPrivateKeyHex(i),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new i("not ASN.1 hex string");var t,n,r;try{d(e,0,[1,0],"06"),t=d(e,0,[1,1],"06"),n=d(e,0,[2,0,1],"04");try{r=d(e,0,[2,0,"[1]",0],"03")}catch(s){}}catch(s){throw new i("malformed PKCS#8 plain ECC private key")}if(this.curveName=a(t),void 0===this.curveName)throw new i("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(r),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new i("not ASN.1 hex string");var t,n;try{d(e,0,[0,0],"06"),t=d(e,0,[0,1],"06"),n=d(e,0,[1],"03")}catch(r){throw new i("malformed PKCS#8 ECC public key")}if(this.curveName=a(t),null===this.curveName)throw new i("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(n)},this.readCertPubKeyHex=function(e,t){if(!1===l(e))throw new i("not ASN.1 hex string");var n,r;try{n=d(e,0,[0,5,0,1],"06"),r=d(e,0,[0,5,1],"03")}catch(s){throw new i("malformed X.509 certificate ECC public key")}if(this.curveName=a(n),null===this.curveName)throw new i("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(r)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName=t),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},Ii.crypto.ECDSA.parseSigHex=function(e){var t=Ii.crypto.ECDSA.parseSigHexInHexRS(e),i=new u(t.r,16),n=new u(t.s,16);return{r:i,s:n}},Ii.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=Oi,i=t.getChildIdx,n=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var r=i(e,0);if(2!=r.length)throw new Error("signature shall have two elements");var s=r[0],o=r[1];if("02"!=e.substr(s,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(o,2))throw new Error("2nd item not ASN.1 integer");var a=n(e,s),c=n(e,o);return{r:a,s:c}},Ii.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=Ii.crypto.ECDSA.parseSigHexInHexRS(e),i=t.r,n=t.s;if(i.length>=130&&i.length<=134){if(i.length%2!=0)throw Error("unknown ECDSA sig r length error");if(n.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==i.substr(0,2)&&(i=i.substr(2)),"00"==n.substr(0,2)&&(n=n.substr(2));var r=Math.max(i.length,n.length);return i=("000000"+i).slice(-r),n=("000000"+n).slice(-r),i+n}if("00"==i.substr(0,2)&&i.length%32==2&&(i=i.substr(2)),"00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),i.length%32==30&&(i="00"+i),n.length%32==30&&(n="00"+n),i.length%32!=0)throw Error("unknown ECDSA sig r length error");if(n.length%32!=0)throw Error("unknown ECDSA sig s length error");return i+n},Ii.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),i=e.substr(e.length/2);return Ii.crypto.ECDSA.hexRSSigToASN1Sig(t,i)},Ii.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var i=new u(e,16),n=new u(t,16);return Ii.crypto.ECDSA.biRSSigToASN1Sig(i,n)},Ii.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var i=Ii.asn1,n=new i.DERInteger({bigint:e}),r=new i.DERInteger({bigint:t}),s=new i.DERSequence({array:[n,r]});return s.tohex()},Ii.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.crypto&&Ii.crypto||(Ii.crypto={}),Ii.crypto.ECParameterDB=new function(){var e={},t={};function i(e){return new u(e,16)}this.getByName=function(i){var n=i;if("undefined"!=typeof t[n]&&(n=t[i]),"undefined"!=typeof e[n])return e[n];throw"unregistered EC curve name: "+n},this.regist=function(n,r,s,o,a,c,d,l,h,u,p,m){e[n]={};var f=i(s),g=i(o),_=i(a),v=i(c),y=i(d),E=new vi(f,g,_),S=E.decodePointHex("04"+l+h);e[n]["name"]=n,e[n]["keylen"]=r,e[n]["keycharlen"]=2*Math.ceil(r/8),e[n]["curve"]=E,e[n]["G"]=S,e[n]["n"]=v,e[n]["h"]=y,e[n]["oid"]=p,e[n]["info"]=m;for(var b=0;b<u.length;b++)t[u[b]]=n}},Ii.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),Ii.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),Ii.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),Ii.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),Ii.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),Ii.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),Ii.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),Ii.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),Ii.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),Ii.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.crypto&&Ii.crypto||(Ii.crypto={}),Ii.crypto.DSA=function(){var e=Oi,t=(e.getVbyList,e.getVbyListEx),i=e.isASN1HEX,n=u;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,i,n,r){this.isPrivate=!0,this.p=e,this.q=t,this.g=i,this.y=n,this.x=r},this.setPrivateHex=function(e,t,i,n,r){var s,o,a,c,d;s=new u(e,16),o=new u(t,16),a=new u(i,16),c="string"===typeof n&&n.length>1?new u(n,16):null,d=new u(r,16),this.setPrivate(s,o,a,c,d)},this.setPublic=function(e,t,i,n){this.isPublic=!0,this.p=e,this.q=t,this.g=i,this.y=n,this.x=null},this.setPublicHex=function(e,t,i,n){var r,s,o,a;r=new u(e,16),s=new u(t,16),o=new u(i,16),a=new u(n,16),this.setPublic(r,s,o,a)},this.signWithMessageHash=function(e){var t=this.p,i=this.q,n=this.g,r=(this.y,this.x),s=Ii.crypto.Util.getRandomBigIntegerMinToMax(u.ONE.add(u.ONE),i.subtract(u.ONE)),o=e.substr(0,i.bitLength()/4),a=new u(o,16),c=n.modPow(s,t).mod(i),d=s.modInverse(i).multiply(a.add(r.multiply(c))).mod(i),l=Ii.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:c}},{int:{bigint:d}}]});return l},this.verifyWithMessageHash=function(e,t){var i=this.p,n=this.q,r=this.g,s=this.y,o=this.parseASN1Signature(t),a=o[0],c=o[1],d=e.substr(0,n.bitLength()/4),l=new u(d,16);if(u.ZERO.compareTo(a)>0||a.compareTo(n)>0)throw"invalid DSA signature";if(u.ZERO.compareTo(c)>=0||c.compareTo(n)>0)throw"invalid DSA signature";var h=c.modInverse(n),p=l.multiply(h).mod(n),m=a.multiply(h).mod(n),f=r.modPow(p,i).multiply(s.modPow(m,i)).mod(i).mod(n);return 0==f.compareTo(a)},this.parseASN1Signature=function(e){try{var i=new n(t(e,0,[0],"02"),16),r=new n(t(e,0,[1],"02"),16);return[i,r]}catch(s){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var n,r,s,o,a;if(!1===i(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1],"02"),r=t(e,0,[2],"02"),s=t(e,0,[3],"02"),o=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(c){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(n,r,s,o,a)},this.readPKCS8PrvKeyHex=function(e){var n,r,s,o;if(!1===i(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1,1,0],"02"),r=t(e,0,[1,1,1],"02"),s=t(e,0,[1,1,2],"02"),o=t(e,0,[2,0],"02")}catch(a){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(n,r,s,null,o)},this.readPKCS8PubKeyHex=function(e){var n,r,s,o;if(!1===i(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[0,1,0],"02"),r=t(e,0,[0,1,1],"02"),s=t(e,0,[0,1,2],"02"),o=t(e,0,[1,0],"02")}catch(a){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(n,r,s,o)},this.readCertPubKeyHex=function(e,n){var r,s,o,a;if(!1===i(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[0,5,0,1,0],"02"),s=t(e,0,[0,5,0,1,1],"02"),o=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(c){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(r,s,o,a)}};var xn=function(){var e=function(e,t,i){return r(n.AES,e,t,i)},t=function(e,t,i){return r(n.TripleDES,e,t,i)},i=function(e,t,i){return r(n.DES,e,t,i)},r=function(e,t,i,r){var s=n.enc.Hex.parse(t),o=n.enc.Hex.parse(i),a=n.enc.Hex.parse(r),c={};c.key=o,c.iv=a,c.ciphertext=s;var d=e.decrypt(c,o,{iv:a});return n.enc.Hex.stringify(d)},s=function(e,t,i){return c(n.AES,e,t,i)},o=function(e,t,i){return c(n.TripleDES,e,t,i)},a=function(e,t,i){return c(n.DES,e,t,i)},c=function(e,t,i,r){var s=n.enc.Hex.parse(t),o=n.enc.Hex.parse(i),a=n.enc.Hex.parse(r),c=e.encrypt(s,o,{iv:a}),d=n.enc.Hex.parse(c.toString()),l=n.enc.Base64.stringify(d);return l},d={"AES-256-CBC":{proc:e,eproc:s,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:s,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:s,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:t,eproc:o,keylen:24,ivlen:8},"DES-CBC":{proc:i,eproc:a,keylen:8,ivlen:8}},l=function(e){var t=n.lib.WordArray.random(e),i=n.enc.Hex.stringify(t);return i},h=function(e){var t={},i=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));i&&(t.cipher=i[1],t.ivsalt=i[2]);var n=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));n&&(t.type=n[1]);var r=-1,s=0;-1!=e.indexOf("\r\n\r\n")&&(r=e.indexOf("\r\n\r\n"),s=2),-1!=e.indexOf("\n\n")&&(r=e.indexOf("\n\n"),s=1);var o=e.indexOf("-----END");if(-1!=r&&-1!=o){var a=e.substring(r+2*s,o-s);a=a.replace(/\s+/g,""),t.data=a}return t},u=function(e,t,i){for(var r=i.substring(0,16),s=n.enc.Hex.parse(r),o=n.enc.Utf8.parse(t),a=d[e]["keylen"]+d[e]["ivlen"],c="",l=null;;){var h=n.algo.MD5.create();if(null!=l&&h.update(l),h.update(o),h.update(s),l=h.finalize(),c+=n.enc.Hex.stringify(l),c.length>=2*a)break}var u={};return u.keyhex=c.substr(0,2*d[e]["keylen"]),u.ivhex=c.substr(2*d[e]["keylen"],2*d[e]["ivlen"]),u},p=function(e,t,i,r){var s=n.enc.Base64.parse(e),o=n.enc.Hex.stringify(s),a=d[t]["proc"],c=a(o,i,r);return c},m=function(e,t,i,n){var r=d[t]["eproc"],s=r(e,i,n);return s};return{version:"1.0.0",parsePKCS5PEM:function(e){return h(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,i){return u(e,t,i)},decryptKeyB64:function(e,t,i,n){return p(e,t,i,n)},getDecryptedKeyHex:function(e,t){var i=h(e),n=(i.type,i.cipher),r=i.ivsalt,s=i.data,o=u(n,t,r),a=o.keyhex,c=p(s,n,a,r);return c},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,i,n,r){var s="";if("undefined"!=typeof n&&null!=n||(n="AES-256-CBC"),"undefined"==typeof d[n])throw new Error("KEYUTIL unsupported algorithm: "+n);if("undefined"==typeof r||null==r){var o=d[n]["ivlen"],a=l(o);r=a.toUpperCase()}var c=u(n,i,r),h=c.keyhex,p=m(t,n,h,r),f=p.replace(/(.{64})/g,"$1\r\n");s="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return s+="Proc-Type: 4,ENCRYPTED\r\n",s+="DEK-Info: "+n+","+r+"\r\n",s+="\r\n",s+=f,s+="\r\n-----END "+e+" PRIVATE KEY-----\r\n",s},parseHexOfEncryptedPKCS8:function(e){var t=Oi,i=t.getChildIdx,n=t.getV,r={},s=i(e,0);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+s.length);r.ciphertext=n(e,s[1]);var o=i(e,s[0]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+o.length);if("2a864886f70d01050d"!=n(e,o[0]))throw new Error("this only supports pkcs5PBES2");var a=i(e,o[1]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=i(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=n(e,c[0]))throw"this only supports TripleDES";r.encryptionSchemeAlg="TripleDES",r.encryptionSchemeIV=n(e,c[1]);var d=i(e,a[0]);if(2!=d.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+d.length);if("2a864886f70d01050c"!=n(e,d[0]))throw new Error("this only supports pkcs5PBKDF2");var l=i(e,d[1]);if(l.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+l.length);r.pbkdf2Salt=n(e,l[0]);var h=n(e,l[1]);try{r.pbkdf2Iter=parseInt(h,16)}catch(u){throw new Error("malformed format pbkdf2Iter: "+h)}return r},getPBKDF2KeyHexFromParam:function(e,t){var i=n.enc.Hex.parse(e.pbkdf2Salt),r=e.pbkdf2Iter,s=n.PBKDF2(t,i,{keySize:6,iterations:r}),o=n.enc.Hex.stringify(s);return o},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var i=en(e,"ENCRYPTED PRIVATE KEY"),r=this.parseHexOfEncryptedPKCS8(i),s=xn.getPBKDF2KeyHexFromParam(r,t),o={};o.ciphertext=n.enc.Hex.parse(r.ciphertext);var a=n.enc.Hex.parse(s),c=n.enc.Hex.parse(r.encryptionSchemeIV),d=n.TripleDES.decrypt(o,a,{iv:c}),l=n.enc.Hex.stringify(d);return l},getKeyFromEncryptedPKCS8PEM:function(e,t){var i=this._getPlainPKCS8HexFromEncryptedPKCS8PEM(e,t),n=this.getKeyFromPlainPrivatePKCS8Hex(i);return n},parsePlainPrivatePKCS8Hex:function(e){var t=Oi,i=t.getChildIdx,n=t.getV,r={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var s=i(e,0);if(s.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(s[1],2))throw new Error("malformed PKCS8 private key(code:003)");var o=i(e,s[1]);if(2!=o.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(o[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(r.algoid=n(e,o[0]),"06"==e.substr(o[1],2)&&(r.algparam=n(e,o[1])),"04"!=e.substr(s[2],2))throw new Error("malformed PKCS8 private key(code:006)");return r.keyidx=t.getVidx(e,s[2]),r},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=en(e,"PRIVATE KEY"),i=this.getKeyFromPlainPrivatePKCS8Hex(t);return i},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,i=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==i.algoid)t=new jt;else if("2a8648ce380401"==i.algoid)t=new Ii.crypto.DSA;else{if("2a8648ce3d0201"!=i.algoid)throw new Error("unsupported private key algorithm");t=new Ii.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,i=Oi.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===i)t=new jt;else if("2a8648ce380401"===i)t=new Ii.crypto.DSA;else{if("2a8648ce3d0201"!==i)throw new Error("unsupported PKCS#8 public key hex");t=new Ii.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=Oi,i=t.getChildIdx,n=t.getV,r={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var s=i(e,0);if(2!=s.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(s[0],2))throw new Error("malformed RSA key(code:003)");if(r.n=n(e,s[0]),"02"!=e.substr(s[1],2))throw new Error("malformed RSA key(code:004)");return r.e=n(e,s[1]),r},parsePublicPKCS8Hex:function(e){var t=Oi,i=t.getChildIdx,n=t.getV,r={algparam:null},s=i(e,0);if(2!=s.length)throw new Error("outer DERSequence shall have 2 elements: "+s.length);var o=s[0];if("30"!=e.substr(o,2))throw new Error("malformed PKCS8 public key(code:001)");var a=i(e,o);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(r.algoid=n(e,a[0]),"06"==e.substr(a[1],2)?r.algparam=n(e,a[1]):"30"==e.substr(a[1],2)&&(r.algparam={},r.algparam.p=t.getVbyList(e,a[1],[0],"02"),r.algparam.q=t.getVbyList(e,a[1],[1],"02"),r.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(s[1],2))throw new Error("malformed PKCS8 public key(code:004)");return r.key=n(e,s[1]).substr(2),r}}}();xn.getKey=function(e,t,i){var n=Oi,r=n.getChildIdx,s=(n.getV,n.getVbyList),o=Ii.crypto,a=o.ECDSA,c=o.DSA,d=jt,l=en,h=xn;if("undefined"!=typeof d&&e instanceof d)return e;if("undefined"!=typeof a&&e instanceof a)return e;if("undefined"!=typeof c&&e instanceof c)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new a({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new a({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d){var p=new d;return p.setPublic(e.n,e.e),p}if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi){p=new d;return p.setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),p}if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p){p=new d;return p.setPrivate(e.n,e.e,e.d),p}if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x){p=new c;return p.setPublic(e.p,e.q,e.g,e.y),p}if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x){p=new c;return p.setPrivate(e.p,e.q,e.g,e.y,e.x),p}if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d){p=new d;return p.setPublic(Bi(e.n),Bi(e.e)),p}if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi){p=new d;return p.setPrivateEx(Bi(e.n),Bi(e.e),Bi(e.d),Bi(e.p),Bi(e.q),Bi(e.dp),Bi(e.dq),Bi(e.qi)),p}if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d){p=new d;return p.setPrivate(Bi(e.n),Bi(e.e),Bi(e.d)),p}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var m=new a({curve:e.crv}),f=m.ecparams.keycharlen,g=("0000000000"+Bi(e.x)).slice(-f),_=("0000000000"+Bi(e.y)).slice(-f),v="04"+g+_;return m.setPublicKeyHex(v),m}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){m=new a({curve:e.crv}),f=m.ecparams.keycharlen,g=("0000000000"+Bi(e.x)).slice(-f),_=("0000000000"+Bi(e.y)).slice(-f),v="04"+g+_;var y=("0000000000"+Bi(e.d)).slice(-f);return m.setPublicKeyHex(v),m.setPrivateKeyHex(y),m}if("pkcs5prv"===i){var E,S=e;n=Oi;if(E=r(S,0),9===E.length)p=new d,p.readPKCS5PrvKeyHex(S);else if(6===E.length)p=new c,p.readPKCS5PrvKeyHex(S);else{if(!(E.length>2&&"04"===S.substr(E[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");p=new a,p.readPKCS5PrvKeyHex(S)}return p}if("pkcs8prv"===i){p=h.getKeyFromPlainPrivatePKCS8Hex(e);return p}if("pkcs8pub"===i)return h._getKeyFromPublicPKCS8Hex(e);if("x509pub"===i)return Un.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return Un.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var b=en(e,"PUBLIC KEY");return h._getKeyFromPublicPKCS8Hex(b)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var w=l(e,"RSA PRIVATE KEY");return h.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var T=l(e,"DSA PRIVATE KEY"),C=s(T,0,[1],"02"),R=s(T,0,[2],"02"),I=s(T,0,[3],"02"),A=s(T,0,[4],"02"),P=s(T,0,[5],"02");p=new c;return p.setPrivate(new u(C,16),new u(R,16),new u(I,16),new u(A,16),new u(P,16)),p}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){w=l(e,"EC PRIVATE KEY");return h.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return h.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var O=h.getDecryptedKeyHex(e,t),N=new jt;return N.readPKCS5PrvKeyHex(O),N}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){T=h.getDecryptedKeyHex(e,t),p=s(T,0,[1],"04");var D=s(T,0,[2,0],"06"),k=s(T,0,[3,0],"03").substr(2),x="";if(void 0===Ii.crypto.OID.oidhex2name[D])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+D);x=Ii.crypto.OID.oidhex2name[D];m=new a({curve:x});return m.setPublicKeyHex(k),m.setPrivateKeyHex(p),m.isPublic=!1,m}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){T=h.getDecryptedKeyHex(e,t),C=s(T,0,[1],"02"),R=s(T,0,[2],"02"),I=s(T,0,[3],"02"),A=s(T,0,[4],"02"),P=s(T,0,[5],"02"),p=new c;return p.setPrivate(new u(C,16),new u(R,16),new u(I,16),new u(A,16),new u(P,16)),p}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return h.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},xn.generateKeypair=function(e,t){if("RSA"==e){var i=t,n=new jt;n.generate(i,"10001"),n.isPrivate=!0,n.isPublic=!0;var r=new jt,s=n.n.toString(16),o=n.e.toString(16);r.setPublic(s,o),r.isPrivate=!1,r.isPublic=!0;var a={};return a.prvKeyObj=n,a.pubKeyObj=r,a}if("EC"==e){var c=t,d=new Ii.crypto.ECDSA({curve:c}),l=d.generateKeyPairHex();n=new Ii.crypto.ECDSA({curve:c});n.setPublicKeyHex(l.ecpubhex),n.setPrivateKeyHex(l.ecprvhex),n.isPrivate=!0,n.isPublic=!1;r=new Ii.crypto.ECDSA({curve:c});r.setPublicKeyHex(l.ecpubhex),r.isPrivate=!1,r.isPublic=!0;a={};return a.prvKeyObj=n,a.pubKeyObj=r,a}throw new Error("unknown algorithm: "+e)},xn.getPEM=function(e,t,i,r,s,o){var a=Ii,c=a.asn1,d=c.DERObjectIdentifier,l=c.DERInteger,h=c.ASN1Util.newObject,u=c.x509,p=u.SubjectPublicKeyInfo,m=a.crypto,f=m.DSA,g=m.ECDSA,_=jt;function v(e){var t=h({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]});return t}function y(e){var t=h({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]});return t}function E(e){var t=h({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]});return t}if((void 0!==_&&e instanceof _||void 0!==f&&e instanceof f||void 0!==g&&e instanceof g)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t)){var S=new p(e),b=S.tohex();return Zi(b,"PUBLIC KEY")}if("PKCS1PRV"==t&&void 0!==_&&e instanceof _&&(void 0===i||null==i)&&1==e.isPrivate){S=v(e),b=S.tohex();return Zi(b,"RSA PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==g&&e instanceof g&&(void 0===i||null==i)&&1==e.isPrivate){var w=new d({name:e.curveName}),T=w.tohex(),C=y(e),R=C.tohex(),I="";return I+=Zi(T,"EC PARAMETERS"),I+=Zi(R,"EC PRIVATE KEY"),I}if("PKCS1PRV"==t&&void 0!==f&&e instanceof f&&(void 0===i||null==i)&&1==e.isPrivate){S=E(e),b=S.tohex();return Zi(b,"DSA PRIVATE KEY")}if("PKCS5PRV"==t&&void 0!==_&&e instanceof _&&void 0!==i&&null!=i&&1==e.isPrivate){S=v(e),b=S.tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",b,i,r,o)}if("PKCS5PRV"==t&&void 0!==g&&e instanceof g&&void 0!==i&&null!=i&&1==e.isPrivate){S=y(e),b=S.tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",b,i,r,o)}if("PKCS5PRV"==t&&void 0!==f&&e instanceof f&&void 0!==i&&null!=i&&1==e.isPrivate){S=E(e),b=S.tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",b,i,r,o)}var A=function(e,t){var i=P(e,t),n=new h({seq:[{seq:[{oid:{name:"pkcs5PBES2"}},{seq:[{seq:[{oid:{name:"pkcs5PBKDF2"}},{seq:[{octstr:{hex:i.pbkdf2Salt}},{int:i.pbkdf2Iter}]}]},{seq:[{oid:{name:"des-EDE3-CBC"}},{octstr:{hex:i.encryptionSchemeIV}}]}]}]},{octstr:{hex:i.ciphertext}}]});return n.tohex()},P=function(e,t){var i=100,r=n.lib.WordArray.random(8),s="DES-EDE3-CBC",o=n.lib.WordArray.random(8),a=n.PBKDF2(t,r,{keySize:6,iterations:i}),c=n.enc.Hex.parse(e),d=n.TripleDES.encrypt(c,a,{iv:o})+"",l={};return l.ciphertext=d,l.pbkdf2Salt=n.enc.Hex.stringify(r),l.pbkdf2Iter=i,l.encryptionSchemeAlg=s,l.encryptionSchemeIV=n.enc.Hex.stringify(o),l};if("PKCS8PRV"==t&&void 0!=_&&e instanceof _&&1==e.isPrivate){var O=v(e),N=O.tohex();S=h({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:N}}]}),b=S.tohex();if(void 0===i||null==i)return Zi(b,"PRIVATE KEY");R=A(b,i);return Zi(R,"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==t&&void 0!==g&&e instanceof g&&1==e.isPrivate){var D={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&D.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});O=new h(D),N=O.tohex(),S=h({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:N}}]}),b=S.tohex();if(void 0===i||null==i)return Zi(b,"PRIVATE KEY");R=A(b,i);return Zi(R,"ENCRYPTED PRIVATE KEY")}if("PKCS8PRV"==t&&void 0!==f&&e instanceof f&&1==e.isPrivate){O=new l({bigint:e.x}),N=O.tohex(),S=h({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:N}}]}),b=S.tohex();if(void 0===i||null==i)return Zi(b,"PRIVATE KEY");R=A(b,i);return Zi(R,"ENCRYPTED PRIVATE KEY")}throw new Error("unsupported object nor format")},xn.getKeyFromCSRPEM=function(e){var t=en(e,"CERTIFICATE REQUEST"),i=xn.getKeyFromCSRHex(t);return i},xn.getKeyFromCSRHex=function(e){var t=xn.parseCSRHex(e),i=xn.getKey(t.p8pubkeyhex,null,"pkcs8pub");return i},xn.parseCSRHex=function(e){var t=Oi,i=t.getChildIdx,n=t.getTLV,r={},s=e;if("30"!=s.substr(0,2))throw new Error("malformed CSR(code:001)");var o=i(s,0);if(o.length<1)throw new Error("malformed CSR(code:002)");if("30"!=s.substr(o[0],2))throw new Error("malformed CSR(code:003)");var a=i(s,o[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return r.p8pubkeyhex=n(s,a[2]),r},xn.getKeyID=function(e){var t=xn,i=Oi;"string"===typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var n=en(t.getPEM(e)),r=i.getIdxbyList(n,0,[1]),s=i.getV(n,r).substring(2);return Ii.crypto.Util.hashHex(s,"sha1")},xn.getJWK=function(e,t,i,n,r){var s,o,c={},d=Ii.crypto.Util.hashHex;if("string"==typeof e)s=xn.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(o=en(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof Un?(s=e.getPublicKey(),o=e.hex):s=e}if(s instanceof jt&&s.isPrivate)c.kty="RSA",c.n=Vi(s.n.toString(16)),c.e=Vi(s.e.toString(16)),c.d=Vi(s.d.toString(16)),c.p=Vi(s.p.toString(16)),c.q=Vi(s.q.toString(16)),c.dp=Vi(s.dmp1.toString(16)),c.dq=Vi(s.dmq1.toString(16)),c.qi=Vi(s.coeff.toString(16));else if(s instanceof jt&&s.isPublic)c.kty="RSA",c.n=Vi(s.n.toString(16)),c.e=Vi(s.e.toString(16));else if(s instanceof Ii.crypto.ECDSA&&s.isPrivate){var l=s.getShortNISTPCurveName();if("P-256"!==l&&"P-384"!==l&&"P-521"!==l)throw new Error("unsupported curve name for JWT: "+l);var h=s.getPublicKeyXYHex();c.kty="EC",c.crv=l,c.x=Vi(h.x),c.y=Vi(h.y),c.d=Vi(s.prvKeyHex)}else if(s instanceof Ii.crypto.ECDSA&&s.isPublic){l=s.getShortNISTPCurveName();if("P-256"!==l&&"P-384"!==l&&"P-521"!==l)throw new Error("unsupported curve name for JWT: "+l);h=s.getPublicKeyXYHex();c.kty="EC",c.crv=l,c.x=Vi(h.x),c.y=Vi(h.y)}if(void 0==c.kty)throw new Error("unsupported keyinfo");return s.isPrivate||1==t||(c.kid=Ii.jws.JWS.getJWKthumbprint(c)),void 0!=o&&1!=i&&(c.x5c=[a(o)]),void 0!=o&&1!=n&&(c.x5t=Ui(a(d(o,"sha1")))),void 0!=o&&1!=r&&(c["x5t#S256"]=Ui(a(d(o,"sha256")))),c},xn.getJWKFromKey=function(e){return xn.getJWK(e,!0,!0,!0,!0)},jt.getPosArrayOfChildrenFromHex=function(e){return Oi.getChildIdx(e,0)},jt.getHexValueArrayOfChildrenFromHex=function(e){var t=Oi,i=t.getV,n=jt.getPosArrayOfChildrenFromHex(e),r=i(e,n[0]),s=i(e,n[1]),o=i(e,n[2]),a=i(e,n[3]),c=i(e,n[4]),d=i(e,n[5]),l=i(e,n[6]),h=i(e,n[7]),u=i(e,n[8]);n=new Array;return n.push(r,s,o,a,c,d,l,h,u),n},jt.prototype.readPrivateKeyFromPEMString=function(e){var t=en(e),i=jt.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8])},jt.prototype.readPKCS5PrvKeyHex=function(e){var t=jt.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},jt.prototype.readPKCS8PrvKeyHex=function(e){var t,i,n,r,s,o,a,c,d=Oi,l=d.getVbyListEx;if(!1===d.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=l(e,0,[2,0,1],"02"),i=l(e,0,[2,0,2],"02"),n=l(e,0,[2,0,3],"02"),r=l(e,0,[2,0,4],"02"),s=l(e,0,[2,0,5],"02"),o=l(e,0,[2,0,6],"02"),a=l(e,0,[2,0,7],"02"),c=l(e,0,[2,0,8],"02")}catch(h){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,i,n,r,s,o,a,c)},jt.prototype.readPKCS5PubKeyHex=function(e){var t=Oi,i=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var n=t.getChildIdx(e,0);if(2!==n.length||"02"!==e.substr(n[0],2)||"02"!==e.substr(n[1],2))throw new Error("wrong hex for PKCS#5 public key");var r=i(e,n[0]),s=i(e,n[1]);this.setPublic(r,s)},jt.prototype.readPKCS8PubKeyHex=function(e){var t=Oi;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var i=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(i)},jt.prototype.readCertPubKeyHex=function(e,t){var i,n;i=new Un,i.readCertHex(e),n=i.getPublicKeyHex(),this.readPKCS8PubKeyHex(n)};new RegExp("[^0-9a-f]","gi");function Ln(e,t){for(var i="",n=t/4-e.length,r=0;r<n;r++)i+="0";return i+e}function Mn(e,t,i){var n="",r=0;while(n.length<t)n+=Ji(i(Yi(e+String.fromCharCode.apply(String,[(4278190080&r)>>24,(16711680&r)>>16,(65280&r)>>8,255&r])))),r+=1;return n}function Fn(e){for(var t in Ii.crypto.Util.DIGESTINFOHEAD){var i=Ii.crypto.Util.DIGESTINFOHEAD[t],n=i.length;if(e.substring(0,n)==i){var r=[t,e.substring(n)];return r}}return[]}function Un(e){var t,i=Oi,n=i.getChildIdx,r=i.getV,s=(i.dump,i.parse),o=i.getTLV,a=i.getVbyList,c=i.getVbyListEx,d=i.getTLVbyList,l=i.getTLVbyListEx,h=i.getIdxbyList,u=i.getIdxbyListEx,p=i.getVidx,m=i.getInt,f=i.oidname,g=i.hextooidstr,_=en,v=Error;try{t=Ii.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(b){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=d(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=d(e,0,[0]),i=m(t,0);if(i<0||2<i)throw new Error("malformed version field");return this.version=i+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=l(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var i in t)if(e===t[i])return i;return f(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return d(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){var e=this.getIssuer();return e.str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return d(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){var e=this.getSubject();return e.str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e),e},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e),e},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return d(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return h(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return h(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return xn.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=d(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),i=this.getSignatureValueHex(),n=d(this.hex,0,[0],"30"),r=new Ii.crypto.Signature({alg:t});return r.init(e),r.updateHex(n),r.verify(i)},this.parseExt=function(e){var t,s,o;if(void 0===e){if(o=this.hex,3!==this.version)return-1;t=h(o,0,[0,7,0],"30"),s=n(o,t)}else{o=en(e);var c=h(o,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=r(o,c))return void(this.aExtInfo=new Array);t=h(o,0,[0,3,0,1,0],"30"),s=n(o,t),this.hex=o}this.aExtInfo=new Array;for(var d=0;d<s.length;d++){var l={critical:!1},u=n(o,s[d]),m=0;3===u.length&&(l.critical=!0,m=1),l.oid=i.hextooidstr(a(o,s[d],[0],"06"));var f=h(o,s[d],[1+m]);l.vidx=p(o,f),this.aExtInfo.push(l)}},this.getExtInfo=function(e){var t=this.aExtInfo,i=e;if(e.match(/^[0-9.]+$/)||(i=Ii.asn1.x509.OID.name2oid(e)),""!==i)for(var n=0;n<t.length;n++)if(t[n].oid===i)return t[n]},this.getCriticalExtV=function(e,t,i){if(void 0!=t)return[t,i];var n=this.getExtInfo(e);return void 0==n?[null,null]:[o(this.hex,n.vidx),n.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("basicConstraints");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var n={extname:"basicConstraints"};if(t&&(n.critical=!0),"3000"===e)return n;if("30030101ff"===e)return n.cA=!0,n;if("30060101ff02"===e.substr(0,12)){var s=r(e,10),a=parseInt(s,16);return n.cA=!0,n.pathLen=a,n}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var i=this.getCriticalExtV("nameConstraints",e,t);if(e=i[0],t=i[1],null!=e){var r={extname:"nameConstraints"};t&&(r.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){for(var c=[],d=n(e,s[a]),l=0;l<d.length;l++){var h=o(e,d[l]),u=this.getGeneralSubtree(h);c.push(u)}var p=e.substr(s[a],2);"a0"==p?r.permit=c:"a1"==p&&(r.exclude=c)}return r}},this.getGeneralSubtree=function(e){var t=n(e,0),i=t.length;if(i<1||2<i)throw new Error("wrong num elements");for(var s=this.getGeneralName(o(e,t[0])),a=1;a<i;a++){var c=e.substr(t[a],2),d=r(e,t[a]),l=parseInt(d,16);"80"==c&&(s.min=l),"81"==c&&(s.max=l)}return s},this.getExtKeyUsage=function(e,t){var i=this.getCriticalExtV("keyUsage",e,t);if(e=i[0],t=i[1],null!=e){var n={extname:"keyUsage"};return t&&(n.critical=!0),n.names=this.getExtKeyUsageString(e).split(","),n}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=o(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var i="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(i=i.slice(-8)),10==e.length&&(i=i.slice(-16)),i=i.replace(/0+$/,""),""==i&&(i="0"),i},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),i=new Array,n=0;n<t.length;n++)"1"==t.substr(n,1)&&i.push(Un.KEYUSAGE_NAME[n]);return i.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("subjectKeyIdentifier");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var n={extname:"subjectKeyIdentifier"};t&&(n.critical=!0);var s=r(e,0);return n.kid={hex:s},n},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("authorityKeyIdentifier");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"authorityKeyIdentifier"};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++){var d=e.substr(a[c],2);if("80"===d&&(s.kid={hex:r(e,a[c])}),"a1"===d){var l=o(e,a[c]),h=this.getGeneralNames(l);s.issuer=h[0]["dn"]}"82"===d&&(s.sn={hex:r(e,a[c])})}return s},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("extKeyUsage");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"extKeyUsage",array:[]};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++)s.array.push(f(r(e,a[c])));return s},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,i=o(this.hex,e.vidx);if(""===i)return t;for(var s=n(i,0),a=0;a<s.length;a++)t.push(f(r(i,s[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("subjectAltName");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var n={extname:"subjectAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("issuerAltName");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var n={extname:"issuerAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getGeneralNames=function(e){for(var t=n(e,0),i=[],r=0;r<t.length;r++){var s=this.getGeneralName(o(e,t[r]));void 0!==s&&i.push(s)}return i},this.getGeneralName=function(e){var t=e.substr(0,2),i=r(e,0),n=Ji(i);return"81"==t?{rfc822:n}:"82"==t?{dns:n}:"86"==t?{uri:n}:"87"==t?{ip:un(i)}:"a4"==t?{dn:this.getX500Name(i)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,i,s=this.getExtInfo("subjectAltName");if(void 0===s)return s;for(var a=new Array,c=o(this.hex,s.vidx),d=n(c,0),l=0;l<d.length;l++)i=c.substr(d[l],2),e=r(c,d[l]),"81"===i&&(t=Gi(e),a.push(["MAIL",t])),"82"===i&&(t=Gi(e),a.push(["DNS",t])),"84"===i&&(t=Un.hex2dn(e,0),a.push(["DN",t])),"86"===i&&(t=Gi(e),a.push(["URI",t])),"87"===i&&(t=un(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("cRLDistributionPoints");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var r={extname:"cRLDistributionPoints",array:[]};t&&(r.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]);r.array.push(this.getDistributionPoint(c))}return r},this.getDistributionPoint=function(e){for(var t={},i=n(e,0),r=0;r<i.length;r++){var s=e.substr(i[r],2),a=o(e,i[r]);"a0"==s&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},i=n(e,0),r=0;r<i.length;r++){var s=e.substr(i[r],2),a=o(e,i[r]);"a0"==s&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(void 0==e)return e;for(var t=e.array,i=[],n=0;n<t.length;n++)try{void 0!=t[n].dpname.full[0].uri&&i.push(t[n].dpname.full[0].uri)}catch(r){}return i},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},i=n(this.hex,e.vidx),r=0;r<i.length;r++){var s=a(this.hex,i[r],[0],"06"),o=a(this.hex,i[r],[1],"86");"2b06010505073001"===s&&t.ocsp.push(Gi(o)),"2b06010505073002"===s&&t.caissuer.push(Gi(o))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("authorityInfoAccess");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var r={extname:"authorityInfoAccess",array:[]};t&&(r.critical=!0);for(var s=n(e,0),d=0;d<s.length;d++){var l=c(e,s[d],[0],"06"),h=a(e,s[d],[1],"86"),u=Gi(h);if("2b06010505073001"==l)r.array.push({ocsp:u});else{if("2b06010505073002"!=l)throw new Error("unknown method: "+l);r.array.push({caissuer:u})}}return r},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("certificatePolicies");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var r={extname:"certificatePolicies",array:[]};t&&(r.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]),d=this.getPolicyInformation(c);r.array.push(d)}return r},this.getPolicyInformation=function(e){var t={},i=a(e,0,[0],"06");t.policyoid=f(i);var r=u(e,0,[1],"30");if(-1!=r){t.array=[];for(var s=n(e,r),c=0;c<s.length;c++){var d=o(e,s[c]),l=this.getPolicyQualifierInfo(d);t.array.push(l)}}return t},this.getOtherName=function(e){var t={},i=n(e,0),r=a(e,i[0],[],"06"),o=a(e,i[1],[]);return t.oid=f(r),t.value=s(o),t},this.getPolicyQualifierInfo=function(e){var t={},i=a(e,0,[0],"06");if("2b06010505070201"===i){var n=c(e,0,[1],"16");t.cps=Ji(n)}else if("2b06010505070202"===i){var r=d(e,0,[1],"30");t.unotice=this.getUserNotice(r)}return t},this.getUserNotice=function(e){for(var t={},i=n(e,0),r=0;r<i.length;r++){var s=o(e,i[r]);"30"!=s.substr(0,2)&&(t.exptext=this.getDisplayText(s))}return t},this.getDisplayText=function(e){var t={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"},i={};return i.type=t[e.substr(0,2)],i.str=Ji(r(e,0)),i},this.getExtPolicyMappings=function(e,t){var i=this.getCriticalExtV("policyMappings",e,t);if(e=i[0],t=i[1],null!=e){var n={extname:"policyMappings"};t&&(n.critical=!0);try{for(var r=s(e),o=r.seq,a=[],c=0;c<o.length;c++){var d=o[c].seq;a.push([d[0].oid,d[1].oid])}n.array=a}catch(l){throw new v("malformed policyMappings")}return n}},this.getExtPolicyConstraints=function(e,t){var i=this.getCriticalExtV("policyConstraints",e,t);if(e=i[0],t=i[1],null!=e){var n={extname:"policyConstraints"};t&&(n.critical=!0);var r=s(e);try{for(var o=r.seq,a=0;a<o.length;a++){var c=o[a].tag;0==c.explicit&&("80"==c.tag&&(n.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(n.inhibit=parseInt(c.hex,16)))}}catch(d){return new v("malformed policyConstraints value")}return n}},this.getExtInhibitAnyPolicy=function(e,t){var i=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=i[0],t=i[1],null!=e){var n={extname:"inhibitAnyPolicy"};t&&(n.critical=!0);var r=m(e,0);return-1==r?new v("wrong value"):(n.skip=r,n)}},this.getExtCRLNumber=function(e,t){var i={extname:"cRLNumber"};if(t&&(i.critical=!0),"02"==e.substr(0,2))return i.num={hex:r(e,0)},i;throw new v("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var i={extname:"cRLReason"};if(t&&(i.critical=!0),"0a"==e.substr(0,2))return i.code=parseInt(r(e,0),16),i;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var i={extname:"ocspNonce"};t&&(i.critical=!0);var n=r(e,0);return i.hex=n,i},this.getExtOcspNoCheck=function(e,t){var i={extname:"ocspNoCheck"};return t&&(i.critical=!0),i},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("adobeTimeStamp");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var r={extname:"adobeTimeStamp"};t&&(r.critical=!0);var s=n(e,0);if(s.length>1){var a=o(e,s[1]),c=this.getGeneralName(a);void 0!=c.uri&&(r.uri=c.uri)}if(s.length>2){var d=o(e,s[2]);"0101ff"==d&&(r.reqauth=!0),"010100"==d&&(r.reqauth=!1)}return r};var y=function(e){var t={};try{var i=e.seq[0].oid,n=Ii.asn1.x509.OID.name2oid(i);t.type=Ii.asn1.x509.OID.oid2atype(n);var r=e.seq[1];if(void 0!=r.utf8str)t.ds="utf8",t.value=r.utf8str.str;else if(void 0!=r.numstr)t.ds="num",t.value=r.numstr.str;else if(void 0!=r.telstr)t.ds="tel",t.value=r.telstr.str;else if(void 0!=r.prnstr)t.ds="prn",t.value=r.prnstr.str;else if(void 0!=r.ia5str)t.ds="ia5",t.value=r.ia5str.str;else if(void 0!=r.visstr)t.ds="vis",t.value=r.visstr.str;else{if(void 0==r.bmpstr)throw"error";t.ds="bmp",t.value=r.bmpstr.str}return t}catch(s){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},E=function(e){try{return e.set.map((function(e){return y(e)}))}catch(t){throw new Error("improper ASN.1 parsed RDN: "+t)}},S=function(e){try{return e.seq.map((function(e){return E(e)}))}catch(t){throw new Error("improper ASN.1 parsed X500Name: "+t)}};this.getX500NameRule=function(e){for(var t=null,i=[],n=0;n<e.length;n++)for(var r=e[n],s=0;s<r.length;s++)i.push(r[s]);for(n=0;n<i.length;n++){var o=i[n],a=o.ds,c=o.value,d=o.type;if(":"+a,"prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=d)return"mixed";if(Ii.lang.String.isMail(c))continue;return"mixed"}if("C"==d){if("prn"==a)continue;return"mixed"}if(":"+a,null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=s(e);return y(t)},this.getRDN=function(e){var t=s(e);return E(t)},this.getX500NameArray=function(e){var t=s(e);return S(t)},this.getX500Name=function(e,t,i){var n=this.getX500NameArray(e),r=this.dnarraytostr(n),s={str:r};return s.array=n,1==i&&(s.hex=e),1==t&&(s.canon=this.c14nRDNArray(n)),s},this.readCertPEM=function(e){this.readCertHex(_(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{h(this.hex,0,[0,7],"a3"),this.parseExt()}catch(t){}},this.getParam=function(e){var t={};return void 0==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=Zi(this.getPublicKeyHex(),"PUBLIC KEY"),void 0!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=d(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){if(void 0==e){var t=u(this.hex,0,[0,"[3]"]);-1!=t&&(e=l(this.hex,0,[0,"[3]",0],"30"))}for(var i=[],r=n(e,0),s=0;s<r.length;s++){var a=o(e,r[s]),c=this.getExtParam(a);null!=c&&i.push(c)}return i},this.getExtParam=function(e){var t=n(e,0),i=t.length;if(2!=i&&3!=i)throw new Error("wrong number elements in Extension: "+i+" "+e);var r=g(a(e,0,[0],"06")),s=!1;3==i&&"0101ff"==d(e,0,[1])&&(s=!0);var o=d(e,0,[i-1,0]),c=void 0;if("2.5.29.14"==r?c=this.getExtSubjectKeyIdentifier(o,s):"2.5.29.15"==r?c=this.getExtKeyUsage(o,s):"2.5.29.17"==r?c=this.getExtSubjectAltName(o,s):"2.5.29.18"==r?c=this.getExtIssuerAltName(o,s):"2.5.29.19"==r?c=this.getExtBasicConstraints(o,s):"2.5.29.30"==r?c=this.getExtNameConstraints(o,s):"2.5.29.31"==r?c=this.getExtCRLDistributionPoints(o,s):"2.5.29.32"==r?c=this.getExtCertificatePolicies(o,s):"2.5.29.33"==r?c=this.getExtPolicyMappings(o,s):"2.5.29.35"==r?c=this.getExtAuthorityKeyIdentifier(o,s):"2.5.29.36"==r?c=this.getExtPolicyConstraints(o,s):"2.5.29.37"==r?c=this.getExtExtKeyUsage(o,s):"2.5.29.54"==r?c=this.getExtInhibitAnyPolicy(o,s):"1.3.6.1.5.5.7.1.1"==r?c=this.getExtAuthorityInfoAccess(o,s):"2.5.29.20"==r?c=this.getExtCRLNumber(o,s):"2.5.29.21"==r?c=this.getExtCRLReason(o,s):"1.3.6.1.5.5.7.48.1.2"==r?c=this.getExtOcspNonce(o,s):"1.3.6.1.5.5.7.48.1.5"==r?c=this.getExtOcspNoCheck(o,s):"1.2.840.113583.1.1.9.1"==r&&(c=this.getExtAdobeTimeStamp(o,s)),void 0!=c)return c;var l={extname:r,extn:o};return s&&(l.critical=!0),l},this.findExt=function(e,t){for(var i=0;i<e.length;i++)if(e[i].extname==t)return e[i];return null},this.updateExtCDPFullURI=function(e,t){var i=this.findExt(e,"cRLDistributionPoints");if(null!=i&&void 0!=i.array)for(var n=i.array,r=0;r<n.length;r++)if(void 0!=n[r].dpname&&void 0!=n[r].dpname.full)for(var s=n[r].dpname.full,o=0;o<s.length;o++){var a=s[r];void 0!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var i=this.findExt(e,"authorityInfoAccess");if(null!=i&&void 0!=i.array)for(var n=i.array,r=0;r<n.length;r++)void 0!=n[r].ocsp&&(n[r].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var i=this.findExt(e,"authorityInfoAccess");if(null!=i&&void 0!=i.array)for(var n=i.array,r=0;r<n.length;r++)void 0!=n[r].caissuer&&(n[r].caissuer=t)},this.dnarraytostr=function(e){function t(e){return e.map((function(e){return i(e).replace(/\+/,"\\+")})).join("+")}function i(e){return e.type+"="+e.value}return"/"+e.map((function(e){return t(e).replace(/\//,"\\/")})).join("/")},this.setCanonicalizedDN=function(e){var t;if(void 0!=e.str&&void 0==e.array){var i=new Ii.asn1.x509.X500Name({str:e.str}),n=i.tohex();t=this.getX500NameArray(n)}else t=e.array;void 0==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],i=0;i<e.length;i++){for(var n=e[i],r=[],s=0;s<n.length;s++){var o=n[s],a=o.value;a=a.replace(/^\s*/,""),a=a.replace(/\s*$/,""),a=a.replace(/\s+/g," "),a=a.toLowerCase(),r.push(o.type.toLowerCase()+"="+a)}t.push(r.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,i,n=function(e){for(var t="",i="    ",n="\n",r=e.array,s=0;s<r.length;s++){var o=r[s];if(void 0!=o.dn&&(t+=i+"dn: "+o.dn.str+n),void 0!=o.ip&&(t+=i+"ip: "+o.ip+n),void 0!=o.rfc822&&(t+=i+"rfc822: "+o.rfc822+n),void 0!=o.dns&&(t+=i+"dns: "+o.dns+n),void 0!=o.uri&&(t+=i+"uri: "+o.uri+n),void 0!=o.other){var a=o.other.oid,c=JSON.stringify(o.other.value).replace(/\"/g,"");t+=i+"other: "+a+"="+c+n}}return t=t.replace(/\n$/,""),t},r=function(e){for(var t="",i=e.array,n=0;n<i.length;n++){var r=i[n];if(t+="    policy oid: "+r.policyoid+"\n",void 0!==r.array)for(var s=0;s<r.array.length;s++){var o=r.array[s];void 0!==o.cps&&(t+="    cps: "+o.cps+"\n")}}return t},s=function(e){for(var t="",i=e.array,n=0;n<i.length;n++){var r=i[n];try{void 0!==r.dpname.full[0].uri&&(t+="    "+r.dpname.full[0].uri+"\n")}catch(s){}try{void 0!==r.dname.full[0].dn.hex&&(t+="    "+Un.hex2dn(r.dpname.full[0].dn.hex)+"\n")}catch(s){}}return t},o=function(e){for(var t="",i=e.array,n=0;n<i.length;n++){var r=i[n];void 0!==r.caissuer&&(t+="    caissuer: "+r.caissuer+"\n"),void 0!==r.ocsp&&(t+="    ocsp: "+r.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",t=this.getPublicKey(),e+="    key algorithm: "+t.type+"\n","RSA"===t.type&&(e+="    n="+bn(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+bn(t.e.toString(16))+"\n"),i=this.aExtInfo,void 0!==i&&null!==i){e+="X509v3 Extensions:\n";for(var a=0;a<i.length;a++){var c=i[a],d=Ii.asn1.x509.OID.oid2name(c.oid);""===d&&(d=c.oid);var l="";if(!0===c.critical&&(l="CRITICAL"),e+="  "+d+" "+l+":\n","basicConstraints"===d){var h=this.getExtBasicConstraints();void 0===h.cA?e+="    {}\n":(e+="    cA=true",void 0!==h.pathLen&&(e+=", pathLen="+h.pathLen),e+="\n")}else if("policyMappings"==d){var u=this.getExtPolicyMappings().array,p=u.map((function(e){var t=e;return t[0]+":"+t[1]})).join(", ");e+="    "+p+"\n"}else if("policyConstraints"==d){var m=this.getExtPolicyConstraints();e+="    ",void 0!=m.reqexp&&(e+=" reqexp="+m.reqexp),void 0!=m.inhibit&&(e+=" inhibit="+m.inhibit),e+="\n"}else if("inhibitAnyPolicy"==d){m=this.getExtInhibitAnyPolicy();e+="    skip="+m.skip+"\n"}else if("keyUsage"==d)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==d)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==d){var f=this.getExtAuthorityKeyIdentifier();void 0!==f.kid&&(e+="    kid="+f.kid.hex+"\n")}else if("extKeyUsage"==d){var g=this.getExtExtKeyUsage().array;e+="    "+g.join(", ")+"\n"}else if("subjectAltName"==d){var _=n(this.getExtSubjectAltName());e+=_+"\n"}else if("cRLDistributionPoints"==d){var v=this.getExtCRLDistributionPoints();e+=s(v)}else if("authorityInfoAccess"==d){var y=this.getExtAuthorityInfoAccess();e+=o(y)}else"certificatePolicies"==d&&(e+=r(this.getExtCertificatePolicies()))}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n",e},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):Ii.lang.String.isHex(e)&&this.readCertHex(e))}jt.prototype.sign=function(e,t){var i=function(e){return Ii.crypto.Util.hashString(e,t)},n=i(e);return this.signWithMessageHash(n,t)},jt.prototype.signWithMessageHash=function(e,t){var i=Ii.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),n=Lt(i,16),r=this.doPrivate(n),s=r.toString(16);return Ln(s,this.n.bitLength())},jt.prototype.signPSS=function(e,t,i){var n=function(e){return Ii.crypto.Util.hashHex(e,t)},r=n(Yi(e));return void 0===i&&(i=-1),this.signWithMessageHashPSS(r,t,i)},jt.prototype.signWithMessageHashPSS=function(e,t,i){var n,r=Ji(e),s=r.length,o=this.n.bitLength()-1,a=Math.ceil(o/8),c=function(e){return Ii.crypto.Util.hashHex(e,t)};if(-1===i||void 0===i)i=s;else if(-2===i)i=a-s-2;else if(i<-2)throw new Error("invalid salt length");if(a<s+i+2)throw new Error("data too long");var d="";i>0&&(d=new Array(i),(new xt).nextBytes(d),d=String.fromCharCode.apply(String,d));var l=Ji(c(Yi("\0\0\0\0\0\0\0\0"+r+d))),h=[];for(n=0;n<a-i-s-2;n+=1)h[n]=0;var p=String.fromCharCode.apply(String,h)+""+d,m=Mn(l,p.length,c),f=[];for(n=0;n<p.length;n+=1)f[n]=p.charCodeAt(n)^m.charCodeAt(n);var g=65280>>8*a-o&255;for(f[0]&=~g,n=0;n<s;n++)f.push(l.charCodeAt(n));return f.push(188),Ln(this.doPrivate(new u(f)).toString(16),this.n.bitLength())},jt.prototype.verify=function(e,t){if(t=t.toLowerCase(),null==t.match(/^[0-9a-f]+$/))return!1;var i=Lt(t,16),n=this.n.bitLength();if(i.bitLength()>n)return!1;var r=this.doPublic(i),s=r.toString(16);if(s.length+3!=n/4)return!1;var o=s.replace(/^1f+00/,""),a=Fn(o);if(0==a.length)return!1;var c=a[0],d=a[1],l=function(e){return Ii.crypto.Util.hashString(e,c)},h=l(e);return d==h},jt.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i=Lt(t,16);if(i.bitLength()>this.n.bitLength())return 0;var n=this.doPublic(i),r=n.toString(16).replace(/^1f+00/,""),s=Fn(r);if(0==s.length)return!1;s[0];var o=s[1];return o==e},jt.prototype.verifyPSS=function(e,t,i,n){var r=function(e){return Ii.crypto.Util.hashHex(e,i)},s=r(Yi(e));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(s,t,i,n)},jt.prototype.verifyWithMessageHashPSS=function(e,t,i,n){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var r,s=new u(t,16),o=function(e){return Ii.crypto.Util.hashHex(e,i)},a=Ji(e),c=a.length,d=this.n.bitLength()-1,l=Math.ceil(d/8);if(-1===n||void 0===n)n=c;else if(-2===n)n=l-c-2;else if(n<-2)throw new Error("invalid salt length");if(l<c+n+2)throw new Error("data too long");var h=this.doPublic(s).toByteArray();for(r=0;r<h.length;r+=1)h[r]&=255;while(h.length<l)h.unshift(0);if(188!==h[l-1])throw new Error("encoded message does not end in 0xbc");h=String.fromCharCode.apply(String,h);var p=h.substr(0,l-c-1),m=h.substr(p.length,c),f=65280>>8*l-d&255;if(0!==(p.charCodeAt(0)&f))throw new Error("bits beyond keysize not zero");var g=Mn(m,p.length,o),_=[];for(r=0;r<p.length;r+=1)_[r]=p.charCodeAt(r)^g.charCodeAt(r);_[0]&=~f;var v=l-c-n-2;for(r=0;r<v;r+=1)if(0!==_[r])throw new Error("leftmost octets not zero");if(1!==_[v])throw new Error("0x01 marker not found");return m===Ji(o(Yi("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,_.slice(-n)))))},jt.SALT_LEN_HLEN=-1,jt.SALT_LEN_MAX=-2,jt.SALT_LEN_RECOVER=-2,Un.hex2dn=function(e,t){void 0===t&&(t=0);var i=new Un,n=(Oi.getTLV(e,t),i.getX500Name(e));return n.str},Un.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var i=new Array,n=Oi.getChildIdx(e,t),r=0;r<n.length;r++)i.push(Un.hex2attrTypeValue(e,n[r]));return i=i.map((function(e){return e.replace("+","\\+")})),i.join("+")},Un.hex2attrTypeValue=function(e,t){var i=Oi,n=i.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var r=i.getChildIdx(e,t);2!==r.length||e.substr(r[0],2);var s=n(e,r[0]),o=Ii.asn1.ASN1Util.oidHexToInt(s),a=Ii.asn1.x509.OID.oid2atype(o),c=n(e,r[1]),d=Ji(c);return a+"="+d},Un.getPublicKeyFromCertHex=function(e){var t=new Un;return t.readCertHex(e),t.getPublicKey()},Un.getPublicKeyFromCertPEM=function(e){var t=new Un;return t.readCertPEM(e),t.getPublicKey()},Un.getPublicKeyInfoPropOfCertPEM=function(e){var t,i,n=Oi,r=n.getVbyList,s={};return s.algparam=null,t=new Un,t.readCertPEM(e),i=t.getPublicKeyHex(),s.keyhex=r(i,0,[1],"03").substr(2),s.algoid=r(i,0,[0,0],"06"),"2a8648ce3d0201"===s.algoid&&(s.algparam=r(i,0,[0,1],"06")),s},Un.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"];var jn=function(e){var t=Ii,i=t.lang.String.isHex,n=Oi,r=n.getV,s=n.getTLV,o=n.getVbyList,a=n.getTLVbyList,c=n.getTLVbyListEx,d=n.getIdxbyList,l=n.getIdxbyListEx,h=n.getChildIdx,u=new Un;this.hex=null,this.posSigAlg=null,this.posRevCert=null,this.parsed=null,this._setPos=function(){var e=d(this.hex,0,[0,0]),t=this.hex.substr(e,2);if("02"==t)this.posSigAlg=1;else{if("30"!=t)throw new Error("malformed 1st item of TBSCertList: "+t);this.posSigAlg=0}var i,n,r=d(this.hex,0,[0,this.posSigAlg+3]),s=this.hex.substr(r,2);if("17"==s||"18"==s)i=d(this.hex,0,[0,this.posSigAlg+4]),this.posRevCert=null,-1!=i&&(n=this.hex.substr(i,2),"30"==n&&(this.posRevCert=this.posSigAlg+4));else if("30"==s)this.posRevCert=this.posSigAlg+3;else{if("a0"!=s)throw new Error("malformed nextUpdate or revCert tag: "+s);this.posRevCert=null}},this.getVersion=function(){return 0==this.posSigAlg?null:parseInt(o(this.hex,0,[0,0],"02"),16)+1},this.getSignatureAlgorithmField=function(){var e=a(this.hex,0,[0,this.posSigAlg],"30");return u.getAlgorithmIdentifierName(e)},this.getIssuer=function(){return u.getX500Name(this.getIssuerHex())},this.getIssuerHex=function(){return a(this.hex,0,[0,this.posSigAlg+1],"30")},this.getThisUpdate=function(){var e=o(this.hex,0,[0,this.posSigAlg+2]);return result=Ji(e)},this.getNextUpdate=function(){var e=d(this.hex,0,[0,this.posSigAlg+3]),t=this.hex.substr(e,2);return"17"!=t&&"18"!=t?null:Ji(r(this.hex,e))},this.getRevCertArray=function(){if(null==this.posRevCert)return null;for(var e=[],t=d(this.hex,0,[0,this.posRevCert]),i=h(this.hex,t),n=0;n<i.length;n++){var r=s(this.hex,i[n]);e.push(this.getRevCert(r))}return e},this.getRevCert=function(e){var t={},i=h(e,0);return t.sn={hex:o(e,0,[0],"02")},t.date=Ji(o(e,0,[1])),3==i.length&&(t.ext=u.getExtParamArray(a(e,0,[2]))),t},this.findRevCert=function(e){var t=new Un(e),i=t.getSerialNumberHex();return this.findRevCertBySN(i)},this.findRevCertBySN=function(e){if(null==this.parsed&&this.getParam(),null==this.parsed.revcert)return null;for(var t=this.parsed.revcert,i=0;i<t.length;i++)if(e==t[i].sn.hex)return t[i];return null},this.getSignatureValueHex=function(){return o(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),i=this.getSignatureValueHex(),n=a(this.hex,0,[0],"30"),r=new Ii.crypto.Signature({alg:t});return r.init(e),r.updateHex(n),r.verify(i)},this.getParam=function(e){var t={},i=this.getVersion();null!=i&&(t.version=i),t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(),t.thisupdate=this.getThisUpdate();var n=this.getNextUpdate();null!=n&&(t.nextupdate=n);var r=this.getRevCertArray();null!=r&&(t.revcert=r);var s=l(this.hex,0,[0,"[0]"]);if(-1!=s){var o=c(this.hex,0,[0,"[0]",0]);t.ext=u.getExtParamArray(o)}return t.sighex=this.getSignatureValueHex(),this.parsed=t,"object"==typeof e&&(1==e.tbshex&&(t.tbshex=a(this.hex,0,[0])),1==e.nodnarray&&delete t.issuer.array),t},"string"==typeof e&&(i(e)?this.hex=e:e.match(/-----BEGIN X509 CRL/)&&(this.hex=en(e)),this._setPos())};"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.jws&&Ii.jws||(Ii.jws={}),Ii.jws.JWS=function(){var e=Ii,t=e.jws.JWS,i=t.isSafeJSONString;this.parseJWS=function(e,t){if(void 0===this.parsedJWS||!t&&void 0===this.parsedJWS.sigvalH){var n=e.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==n)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var r=n[1],s=n[2],o=n[3],a=r+"."+s;if(this.parsedJWS={},this.parsedJWS.headB64U=r,this.parsedJWS.payloadB64U=s,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=a,!t){var c=Bi(o),d=Lt(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=d}var l=Pi(r),h=Pi(s);if(this.parsedJWS.headS=l,this.parsedJWS.payloadS=h,!i(l,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+l}}},Ii.jws.JWS.sign=function(e,t,i,n,r){var s,o,a,c=Ii,d=c.jws,l=d.JWS,h=l.readSafeJSONString,u=l.isSafeJSONString,p=c.crypto,m=(p.ECDSA,p.Mac),f=p.Signature,g=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(o=t,s=g.stringify(o)),"string"==typeof t){if(s=t,!u(s))throw"JWS Head is not safe JSON string: "+s;o=h(s)}if(a=i,"object"==typeof i&&(a=g.stringify(i)),""!=e&&null!=e||void 0===o.alg||(e=o.alg),""!=e&&null!=e&&void 0===o.alg&&(o.alg=e,s=g.stringify(o)),e!==o.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+o.alg;var _=null;if(void 0===l.jwsalg2sigalg[e])throw"unsupported alg name: "+e;_=l.jwsalg2sigalg[e];var v=Ai(s),y=Ai(a),E=v+"."+y,S="";if("Hmac"==_.substr(0,4)){if(void 0===n)throw"mac key shall be specified for HS* alg";var b=new m({alg:_,prov:"cryptojs",pass:n});b.updateString(E),S=b.doFinal()}else if(-1!=_.indexOf("withECDSA")){var w=new f({alg:_});w.init(n,r),w.updateString(E);var T=w.sign();S=Ii.crypto.ECDSA.asn1SigToConcatSig(T)}else if("none"!=_){w=new f({alg:_});w.init(n,r),w.updateString(E),S=w.sign()}var C=Vi(S);return E+"."+C},Ii.jws.JWS.verify=function(e,t,i){var n,r=Ii,s=r.jws,o=s.JWS,a=o.readSafeJSONString,c=r.crypto,d=c.ECDSA,l=c.Mac,h=c.Signature;if(void 0!==typeof jt&&(n=jt),!Sn(e))return!1;var u=e.split(".");if(3!==u.length)return!1;var p=u[0],m=u[1],f=p+"."+m,g=Bi(u[2]),_=a(Pi(u[0])),v=null,y=null;if(void 0===_.alg)throw"algorithm not specified in header";if(v=_.alg,y=v.substr(0,2),null!=i&&"[object Array]"===Object.prototype.toString.call(i)&&i.length>0){var E=":"+i.join(":")+":";if(-1==E.indexOf(":"+v+":"))throw"algorithm '"+v+"' not accepted in the list"}if("none"!=v&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=xn.getKey(t)),("RS"==y||"PS"==y)&&!(t instanceof n))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==y&&!(t instanceof d))throw"key shall be a ECDSA obj for ES* algs";var S=null;if(void 0===o.jwsalg2sigalg[_.alg])throw"unsupported alg name: "+v;if(S=o.jwsalg2sigalg[v],"none"==S)throw"not supported";if("Hmac"==S.substr(0,4)){var b=null;if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var w=new l({alg:S,pass:t});return w.updateString(f),b=w.doFinal(),g==b}if(-1!=S.indexOf("withECDSA")){var T=null;try{T=d.concatSigToASN1Sig(g)}catch(R){return!1}var C=new h({alg:S});return C.init(t),C.updateString(f),C.verify(T)}C=new h({alg:S});return C.init(t),C.updateString(f),C.verify(g)},Ii.jws.JWS.parse=function(e){var t,i,n,r=e.split("."),s={};if(2!=r.length&&3!=r.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=r[0],i=r[1],3==r.length&&(n=r[2]),s.headerObj=Ii.jws.JWS.readSafeJSONString(Pi(t)),s.payloadObj=Ii.jws.JWS.readSafeJSONString(Pi(i)),s.headerPP=JSON.stringify(s.headerObj,null,"  "),null==s.payloadObj?s.payloadPP=Pi(i):s.payloadPP=JSON.stringify(s.payloadObj,null,"  "),void 0!==n&&(s.sigHex=Bi(n)),s},Ii.jws.JWS.verifyJWT=function(e,t,i){var n=Ii,r=n.jws,s=r.JWS,o=s.readSafeJSONString,a=s.inArray,c=s.includedArray;if(!Sn(e))return!1;var d=e.split(".");if(3!=d.length)return!1;var l=d[0],h=d[1],u=(Bi(d[2]),o(Pi(l))),p=o(Pi(h));if(void 0===u.alg)return!1;if(void 0===i.alg)throw"acceptField.alg shall be specified";if(!a(u.alg,i.alg))return!1;if(void 0!==p.iss&&"object"===typeof i.iss&&!a(p.iss,i.iss))return!1;if(void 0!==p.sub&&"object"===typeof i.sub&&!a(p.sub,i.sub))return!1;if(void 0!==p.aud&&"object"===typeof i.aud)if("string"==typeof p.aud){if(!a(p.aud,i.aud))return!1}else if("object"==typeof p.aud&&!c(p.aud,i.aud))return!1;var m=r.IntDate.getNow();return void 0!==i.verifyAt&&"number"===typeof i.verifyAt&&(m=i.verifyAt),void 0!==i.gracePeriod&&"number"===typeof i.gracePeriod||(i.gracePeriod=0),!(void 0!==p.exp&&"number"==typeof p.exp&&p.exp+i.gracePeriod<m)&&(!(void 0!==p.nbf&&"number"==typeof p.nbf&&m<p.nbf-i.gracePeriod)&&(!(void 0!==p.iat&&"number"==typeof p.iat&&m<p.iat-i.gracePeriod)&&((void 0===p.jti||void 0===i.jti||p.jti===i.jti)&&!!s.verify(e,t,i.alg))))},Ii.jws.JWS.includedArray=function(e,t){var i=Ii.jws.JWS.inArray;if(null===e)return!1;if("object"!==typeof e)return!1;if("number"!==typeof e.length)return!1;for(var n=0;n<e.length;n++)if(!i(e[n],t))return!1;return!0},Ii.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!==typeof t)return!1;if("number"!==typeof t.length)return!1;for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},Ii.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},Ii.jws.JWS.isSafeJSONString=function(e,t,i){var n=null;try{return n=Ri(e),"object"!=typeof n?0:n.constructor===Array?0:(t&&(t[i]=n),1)}catch(r){return 0}},Ii.jws.JWS.readSafeJSONString=function(e){var t=null;try{return t=Ri(e),"object"!=typeof t||t.constructor===Array?null:t}catch(i){return null}},Ii.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},Ii.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var i=Yi(t),n=Ii.crypto.Util.hashHex(i,"sha256"),r=Vi(n);return r},Ii.jws.IntDate={},Ii.jws.IntDate.get=function(e){var t=Ii.jws.IntDate,i=t.getNow,n=t.getZulu;if("now"==e)return i();if("now + 1hour"==e)return i()+3600;if("now + 1day"==e)return i()+86400;if("now + 1month"==e)return i()+2592e3;if("now + 1year"==e)return i()+31536e3;if(e.match(/Z$/))return n(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},Ii.jws.IntDate.getZulu=function(e){return sn(e)},Ii.jws.IntDate.getNow=function(){var e=~~(new Date/1e3);return e},Ii.jws.IntDate.intDate2UTCString=function(e){var t=new Date(1e3*e);return t.toUTCString()},Ii.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e),i=("0000"+t.getUTCFullYear()).slice(-4),n=("00"+(t.getUTCMonth()+1)).slice(-2),r=("00"+t.getUTCDate()).slice(-2),s=("00"+t.getUTCHours()).slice(-2),o=("00"+t.getUTCMinutes()).slice(-2),a=("00"+t.getUTCSeconds()).slice(-2);return i+n+r+s+o+a+"Z"},"undefined"!=typeof Ii&&Ii||(Ii={}),"undefined"!=typeof Ii.jws&&Ii.jws||(Ii.jws={}),Ii.jws.JWSJS=function(){var e=Ii,t=e.jws,i=t.JWS,n=i.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,i,n){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var r=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var s=Ii.jws.JWS.sign(e,t,this.sPayload,i,n),o=s.split(".");o[0],o[2];this.aHeader.push(o[0]),this.aSignature.push(o[2])}catch(Hs){throw this.aHeader.length>r&&this.aHeader.pop(),this.aSignature.length>r&&this.aSignature.pop(),"addSignature failed: "+Hs}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var i=e[t];if(2!==i.length)return!1;var n=this.verifyNth(t,i[0],i[1]);if(!1===n)return!1}return!0},this.verifyNth=function(e,t,n){if(this.aHeader.length<=e||this.aSignature.length<=e)return!1;var r=this.aHeader[e],s=this.aSignature[e],o=r+"."+this.sPayload+"."+s,a=!1;try{a=i.verify(o,t,n)}catch(Hs){return!1}return a},this.readJWSJS=function(e){if("string"===typeof e){var t=n(e);if(null==t)throw"argument is not safe JSON object string";this.aHeader=t.headers,this.sPayload=t.payload,this.aSignature=t.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!==typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(i){throw"malformed JWS-JS JSON object: "+i}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}},e.SecureRandom=xt,e.rng_seed_time=Nt,e.BigInteger=u,e.RSAKey=jt,e.ECDSA=Ii.crypto.ECDSA,e.DSA=Ii.crypto.DSA,e.Signature=Ii.crypto.Signature,e.MessageDigest=Ii.crypto.MessageDigest,e.Mac=Ii.crypto.Mac,e.Cipher=Ii.crypto.Cipher,e.KEYUTIL=xn,e.ASN1HEX=Oi,e.X509=Un,e.X509CRL=jn,e.CryptoJS=n,e.b64tohex=c,e.b64toBA=d,e.ECFieldElementFp=Zt,e.ECPointFp=ci,e.ECCurveFp=vi,e.stoBA=Ni,e.BAtos=Di,e.BAtohex=ki,e.stohex=xi,e.stob64=Li,e.stob64u=Mi,e.b64utos=Fi,e.b64tob64u=Ui,e.b64utob64=ji,e.hex2b64=a,e.hextob64u=Vi,e.b64utohex=Bi,e.utf8tob64u=Ai,e.b64utoutf8=Pi,e.utf8tob64=Hi,e.b64toutf8=Wi,e.utf8tohex=Ki,e.hextoutf8=Gi,e.hextorstr=Ji,e.rstrtohex=Yi,e.hextob64=Xi,e.hextob64nl=$i,e.b64nltohex=Qi,e.hextopem=Zi,e.pemtohex=en,e.hextoArrayBuffer=tn,e.ArrayBuffertohex=nn,e.zulutomsec=rn,e.zulutosec=sn,e.zulutodate=on,e.datetozulu=an,e.uricmptohex=cn,e.hextouricmp=dn,e.ipv6tohex=ln,e.hextoipv6=hn,e.hextoip=un,e.iptohex=mn,e.ucs2hextoutf8=gn,e.encodeURIComponentAll=_n,e.newline_toUnix=vn,e.newline_toDos=yn,e.hextoposhex=bn,e.intarystrtohex=wn,e.strdiffidx=Tn,e.oidtohex=Cn,e.hextooid=Rn,e.strpad=In,e.bitstrtoint=An,e.inttobitstr=Pn,e.bitstrtobinstr=On,e.binstrtobitstr=Nn,e.isBase64URLDot=Sn,e.namearraytobinstr=Dn,e.extendClass=kn,e.KJUR=Ii,e.crypto=Ii.crypto,e.asn1=Ii.asn1,e.jws=Ii.jws,e.lang=Ii.lang}}),k=y({"../../node_modules/lodash/_listCacheClear.js"(e,t){function i(){this.__data__=[],this.size=0}w(),t.exports=i}}),x=y({"../../node_modules/lodash/eq.js"(e,t){function i(e,t){return e===t||e!==e&&t!==t}w(),t.exports=i}}),L=y({"../../node_modules/lodash/_assocIndexOf.js"(e,t){w();var i=x();function n(e,t){var n=e.length;while(n--)if(i(e[n][0],t))return n;return-1}t.exports=n}}),M=y({"../../node_modules/lodash/_listCacheDelete.js"(e,t){w();var i=L(),n=Array.prototype,r=n.splice;function s(e){var t=this.__data__,n=i(t,e);if(n<0)return!1;var s=t.length-1;return n==s?t.pop():r.call(t,n,1),--this.size,!0}t.exports=s}}),F=y({"../../node_modules/lodash/_listCacheGet.js"(e,t){w();var i=L();function n(e){var t=this.__data__,n=i(t,e);return n<0?void 0:t[n][1]}t.exports=n}}),U=y({"../../node_modules/lodash/_listCacheHas.js"(e,t){w();var i=L();function n(e){return i(this.__data__,e)>-1}t.exports=n}}),j=y({"../../node_modules/lodash/_listCacheSet.js"(e,t){w();var i=L();function n(e,t){var n=this.__data__,r=i(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this}t.exports=n}}),V=y({"../../node_modules/lodash/_ListCache.js"(e,t){w();var i=k(),n=M(),r=F(),s=U(),o=j();function a(e){var t=-1,i=null==e?0:e.length;this.clear();while(++t<i){var n=e[t];this.set(n[0],n[1])}}a.prototype.clear=i,a.prototype["delete"]=n,a.prototype.get=r,a.prototype.has=s,a.prototype.set=o,t.exports=a}}),B=y({"../../node_modules/lodash/_stackClear.js"(e,t){w();var i=V();function n(){this.__data__=new i,this.size=0}t.exports=n}}),H=y({"../../node_modules/lodash/_stackDelete.js"(e,t){function i(e){var t=this.__data__,i=t["delete"](e);return this.size=t.size,i}w(),t.exports=i}}),W=y({"../../node_modules/lodash/_stackGet.js"(e,t){function i(e){return this.__data__.get(e)}w(),t.exports=i}}),K=y({"../../node_modules/lodash/_stackHas.js"(e,t){function i(e){return this.__data__.has(e)}w(),t.exports=i}}),G=y({"../../node_modules/lodash/_freeGlobal.js"(e,t){w();var i="object"==typeof global&&global&&global.Object===Object&&global;t.exports=i}}),q=y({"../../node_modules/lodash/_root.js"(e,t){w();var i=G(),n="object"==typeof self&&self&&self.Object===Object&&self,r=i||n||Function("return this")();t.exports=r}}),z=y({"../../node_modules/lodash/_Symbol.js"(e,t){w();var i=q(),n=i.Symbol;t.exports=n}}),J=y({"../../node_modules/lodash/_getRawTag.js"(e,t){w();var i=z(),n=Object.prototype,r=n.hasOwnProperty,s=n.toString,o=i?i.toStringTag:void 0;function a(e){var t=r.call(e,o),i=e[o];try{e[o]=void 0;var n=!0}catch(c){}var a=s.call(e);return n&&(t?e[o]=i:delete e[o]),a}t.exports=a}}),Y=y({"../../node_modules/lodash/_objectToString.js"(e,t){w();var i=Object.prototype,n=i.toString;function r(e){return n.call(e)}t.exports=r}}),X=y({"../../node_modules/lodash/_baseGetTag.js"(e,t){w();var i=z(),n=J(),r=Y(),s="[object Null]",o="[object Undefined]",a=i?i.toStringTag:void 0;function c(e){return null==e?void 0===e?o:s:a&&a in Object(e)?n(e):r(e)}t.exports=c}}),$=y({"../../node_modules/lodash/isObject.js"(e,t){function i(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}w(),t.exports=i}}),Q=y({"../../node_modules/lodash/isFunction.js"(e,t){w();var i=X(),n=$(),r="[object AsyncFunction]",s="[object Function]",o="[object GeneratorFunction]",a="[object Proxy]";function c(e){if(!n(e))return!1;var t=i(e);return t==s||t==o||t==r||t==a}t.exports=c}}),Z=y({"../../node_modules/lodash/_coreJsData.js"(e,t){w();var i=q(),n=i["__core-js_shared__"];t.exports=n}}),ee=y({"../../node_modules/lodash/_isMasked.js"(e,t){w();var i=Z(),n=function(){var e=/[^.]+$/.exec(i&&i.keys&&i.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function r(e){return!!n&&n in e}t.exports=r}}),te=y({"../../node_modules/lodash/_toSource.js"(e,t){w();var i=Function.prototype,n=i.toString;function r(e){if(null!=e){try{return n.call(e)}catch(t){}try{return e+""}catch(t){}}return""}t.exports=r}}),ie=y({"../../node_modules/lodash/_baseIsNative.js"(e,t){w();var i=Q(),n=ee(),r=$(),s=te(),o=/[\\^$.*+?()[\]{}|]/g,a=/^\[object .+?Constructor\]$/,c=Function.prototype,d=Object.prototype,l=c.toString,h=d.hasOwnProperty,u=RegExp("^"+l.call(h).replace(o,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function p(e){if(!r(e)||n(e))return!1;var t=i(e)?u:a;return t.test(s(e))}t.exports=p}}),ne=y({"../../node_modules/lodash/_getValue.js"(e,t){function i(e,t){return null==e?void 0:e[t]}w(),t.exports=i}}),re=y({"../../node_modules/lodash/_getNative.js"(e,t){w();var i=ie(),n=ne();function r(e,t){var r=n(e,t);return i(r)?r:void 0}t.exports=r}}),se=y({"../../node_modules/lodash/_Map.js"(e,t){w();var i=re(),n=q(),r=i(n,"Map");t.exports=r}}),oe=y({"../../node_modules/lodash/_nativeCreate.js"(e,t){w();var i=re(),n=i(Object,"create");t.exports=n}}),ae=y({"../../node_modules/lodash/_hashClear.js"(e,t){w();var i=oe();function n(){this.__data__=i?i(null):{},this.size=0}t.exports=n}}),ce=y({"../../node_modules/lodash/_hashDelete.js"(e,t){function i(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}w(),t.exports=i}}),de=y({"../../node_modules/lodash/_hashGet.js"(e,t){w();var i=oe(),n="__lodash_hash_undefined__",r=Object.prototype,s=r.hasOwnProperty;function o(e){var t=this.__data__;if(i){var r=t[e];return r===n?void 0:r}return s.call(t,e)?t[e]:void 0}t.exports=o}}),le=y({"../../node_modules/lodash/_hashHas.js"(e,t){w();var i=oe(),n=Object.prototype,r=n.hasOwnProperty;function s(e){var t=this.__data__;return i?void 0!==t[e]:r.call(t,e)}t.exports=s}}),he=y({"../../node_modules/lodash/_hashSet.js"(e,t){w();var i=oe(),n="__lodash_hash_undefined__";function r(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=i&&void 0===t?n:t,this}t.exports=r}}),ue=y({"../../node_modules/lodash/_Hash.js"(e,t){w();var i=ae(),n=ce(),r=de(),s=le(),o=he();function a(e){var t=-1,i=null==e?0:e.length;this.clear();while(++t<i){var n=e[t];this.set(n[0],n[1])}}a.prototype.clear=i,a.prototype["delete"]=n,a.prototype.get=r,a.prototype.has=s,a.prototype.set=o,t.exports=a}}),pe=y({"../../node_modules/lodash/_mapCacheClear.js"(e,t){w();var i=ue(),n=V(),r=se();function s(){this.size=0,this.__data__={hash:new i,map:new(r||n),string:new i}}t.exports=s}}),me=y({"../../node_modules/lodash/_isKeyable.js"(e,t){function i(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}w(),t.exports=i}}),fe=y({"../../node_modules/lodash/_getMapData.js"(e,t){w();var i=me();function n(e,t){var n=e.__data__;return i(t)?n["string"==typeof t?"string":"hash"]:n.map}t.exports=n}}),ge=y({"../../node_modules/lodash/_mapCacheDelete.js"(e,t){w();var i=fe();function n(e){var t=i(this,e)["delete"](e);return this.size-=t?1:0,t}t.exports=n}}),_e=y({"../../node_modules/lodash/_mapCacheGet.js"(e,t){w();var i=fe();function n(e){return i(this,e).get(e)}t.exports=n}}),ve=y({"../../node_modules/lodash/_mapCacheHas.js"(e,t){w();var i=fe();function n(e){return i(this,e).has(e)}t.exports=n}}),ye=y({"../../node_modules/lodash/_mapCacheSet.js"(e,t){w();var i=fe();function n(e,t){var n=i(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this}t.exports=n}}),Ee=y({"../../node_modules/lodash/_MapCache.js"(e,t){w();var i=pe(),n=ge(),r=_e(),s=ve(),o=ye();function a(e){var t=-1,i=null==e?0:e.length;this.clear();while(++t<i){var n=e[t];this.set(n[0],n[1])}}a.prototype.clear=i,a.prototype["delete"]=n,a.prototype.get=r,a.prototype.has=s,a.prototype.set=o,t.exports=a}}),Se=y({"../../node_modules/lodash/_stackSet.js"(e,t){w();var i=V(),n=se(),r=Ee(),s=200;function o(e,t){var o=this.__data__;if(o instanceof i){var a=o.__data__;if(!n||a.length<s-1)return a.push([e,t]),this.size=++o.size,this;o=this.__data__=new r(a)}return o.set(e,t),this.size=o.size,this}t.exports=o}}),be=y({"../../node_modules/lodash/_Stack.js"(e,t){w();var i=V(),n=B(),r=H(),s=W(),o=K(),a=Se();function c(e){var t=this.__data__=new i(e);this.size=t.size}c.prototype.clear=n,c.prototype["delete"]=r,c.prototype.get=s,c.prototype.has=o,c.prototype.set=a,t.exports=c}}),we=y({"../../node_modules/lodash/_setCacheAdd.js"(e,t){w();var i="__lodash_hash_undefined__";function n(e){return this.__data__.set(e,i),this}t.exports=n}}),Te=y({"../../node_modules/lodash/_setCacheHas.js"(e,t){function i(e){return this.__data__.has(e)}w(),t.exports=i}}),Ce=y({"../../node_modules/lodash/_SetCache.js"(e,t){w();var i=Ee(),n=we(),r=Te();function s(e){var t=-1,n=null==e?0:e.length;this.__data__=new i;while(++t<n)this.add(e[t])}s.prototype.add=s.prototype.push=n,s.prototype.has=r,t.exports=s}}),Re=y({"../../node_modules/lodash/_arraySome.js"(e,t){function i(e,t){var i=-1,n=null==e?0:e.length;while(++i<n)if(t(e[i],i,e))return!0;return!1}w(),t.exports=i}}),Ie=y({"../../node_modules/lodash/_cacheHas.js"(e,t){function i(e,t){return e.has(t)}w(),t.exports=i}}),Ae=y({"../../node_modules/lodash/_equalArrays.js"(e,t){w();var i=Ce(),n=Re(),r=Ie(),s=1,o=2;function a(e,t,a,c,d,l){var h=a&s,u=e.length,p=t.length;if(u!=p&&!(h&&p>u))return!1;var m=l.get(e),f=l.get(t);if(m&&f)return m==t&&f==e;var g=-1,_=!0,v=a&o?new i:void 0;l.set(e,t),l.set(t,e);while(++g<u){var y=e[g],E=t[g];if(c)var S=h?c(E,y,g,t,e,l):c(y,E,g,e,t,l);if(void 0!==S){if(S)continue;_=!1;break}if(v){if(!n(t,(function(e,t){if(!r(v,t)&&(y===e||d(y,e,a,c,l)))return v.push(t)}))){_=!1;break}}else if(y!==E&&!d(y,E,a,c,l)){_=!1;break}}return l["delete"](e),l["delete"](t),_}t.exports=a}}),Pe=y({"../../node_modules/lodash/_Uint8Array.js"(e,t){w();var i=q(),n=i.Uint8Array;t.exports=n}}),Oe=y({"../../node_modules/lodash/_mapToArray.js"(e,t){function i(e){var t=-1,i=Array(e.size);return e.forEach((function(e,n){i[++t]=[n,e]})),i}w(),t.exports=i}}),Ne=y({"../../node_modules/lodash/_setToArray.js"(e,t){function i(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e})),i}w(),t.exports=i}}),De=y({"../../node_modules/lodash/_equalByTag.js"(e,t){w();var i=z(),n=Pe(),r=x(),s=Ae(),o=Oe(),a=Ne(),c=1,d=2,l="[object Boolean]",h="[object Date]",u="[object Error]",p="[object Map]",m="[object Number]",f="[object RegExp]",g="[object Set]",_="[object String]",v="[object Symbol]",y="[object ArrayBuffer]",E="[object DataView]",S=i?i.prototype:void 0,b=S?S.valueOf:void 0;function T(e,t,i,S,w,T,C){switch(i){case E:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case y:return!(e.byteLength!=t.byteLength||!T(new n(e),new n(t)));case l:case h:case m:return r(+e,+t);case u:return e.name==t.name&&e.message==t.message;case f:case _:return e==t+"";case p:var R=o;case g:var I=S&c;if(R||(R=a),e.size!=t.size&&!I)return!1;var A=C.get(e);if(A)return A==t;S|=d,C.set(e,t);var P=s(R(e),R(t),S,w,T,C);return C["delete"](e),P;case v:if(b)return b.call(e)==b.call(t)}return!1}t.exports=T}}),ke=y({"../../node_modules/lodash/_arrayPush.js"(e,t){function i(e,t){var i=-1,n=t.length,r=e.length;while(++i<n)e[r+i]=t[i];return e}w(),t.exports=i}}),xe=y({"../../node_modules/lodash/isArray.js"(e,t){w();var i=Array.isArray;t.exports=i}}),Le=y({"../../node_modules/lodash/_baseGetAllKeys.js"(e,t){w();var i=ke(),n=xe();function r(e,t,r){var s=t(e);return n(e)?s:i(s,r(e))}t.exports=r}}),Me=y({"../../node_modules/lodash/_arrayFilter.js"(e,t){function i(e,t){var i=-1,n=null==e?0:e.length,r=0,s=[];while(++i<n){var o=e[i];t(o,i,e)&&(s[r++]=o)}return s}w(),t.exports=i}}),Fe=y({"../../node_modules/lodash/stubArray.js"(e,t){function i(){return[]}w(),t.exports=i}}),Ue=y({"../../node_modules/lodash/_getSymbols.js"(e,t){w();var i=Me(),n=Fe(),r=Object.prototype,s=r.propertyIsEnumerable,o=Object.getOwnPropertySymbols,a=o?function(e){return null==e?[]:(e=Object(e),i(o(e),(function(t){return s.call(e,t)})))}:n;t.exports=a}}),je=y({"../../node_modules/lodash/_baseTimes.js"(e,t){function i(e,t){var i=-1,n=Array(e);while(++i<e)n[i]=t(i);return n}w(),t.exports=i}}),Ve=y({"../../node_modules/lodash/isObjectLike.js"(e,t){function i(e){return null!=e&&"object"==typeof e}w(),t.exports=i}}),Be=y({"../../node_modules/lodash/_baseIsArguments.js"(e,t){w();var i=X(),n=Ve(),r="[object Arguments]";function s(e){return n(e)&&i(e)==r}t.exports=s}}),He=y({"../../node_modules/lodash/isArguments.js"(e,t){w();var i=Be(),n=Ve(),r=Object.prototype,s=r.hasOwnProperty,o=r.propertyIsEnumerable,a=i(function(){return arguments}())?i:function(e){return n(e)&&s.call(e,"callee")&&!o.call(e,"callee")};t.exports=a}}),We=y({"../../node_modules/lodash/stubFalse.js"(e,t){function i(){return!1}w(),t.exports=i}}),Ke=y({"../../node_modules/lodash/isBuffer.js"(e,t){w();var i=q(),n=We(),r="object"==typeof e&&e&&!e.nodeType&&e,s=r&&"object"==typeof t&&t&&!t.nodeType&&t,o=s&&s.exports===r,a=o?i.Buffer:void 0,c=a?a.isBuffer:void 0,d=c||n;t.exports=d}}),Ge=y({"../../node_modules/lodash/_isIndex.js"(e,t){w();var i=9007199254740991,n=/^(?:0|[1-9]\d*)$/;function r(e,t){var r=typeof e;return t=null==t?i:t,!!t&&("number"==r||"symbol"!=r&&n.test(e))&&e>-1&&e%1==0&&e<t}t.exports=r}}),qe=y({"../../node_modules/lodash/isLength.js"(e,t){w();var i=9007199254740991;function n(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=i}t.exports=n}}),ze=y({"../../node_modules/lodash/_baseIsTypedArray.js"(e,t){w();var i=X(),n=qe(),r=Ve(),s="[object Arguments]",o="[object Array]",a="[object Boolean]",c="[object Date]",d="[object Error]",l="[object Function]",h="[object Map]",u="[object Number]",p="[object Object]",m="[object RegExp]",f="[object Set]",g="[object String]",_="[object WeakMap]",v="[object ArrayBuffer]",y="[object DataView]",E="[object Float32Array]",S="[object Float64Array]",b="[object Int8Array]",T="[object Int16Array]",C="[object Int32Array]",R="[object Uint8Array]",I="[object Uint8ClampedArray]",A="[object Uint16Array]",P="[object Uint32Array]",O={};function N(e){return r(e)&&n(e.length)&&!!O[i(e)]}O[E]=O[S]=O[b]=O[T]=O[C]=O[R]=O[I]=O[A]=O[P]=!0,O[s]=O[o]=O[v]=O[a]=O[y]=O[c]=O[d]=O[l]=O[h]=O[u]=O[p]=O[m]=O[f]=O[g]=O[_]=!1,t.exports=N}}),Je=y({"../../node_modules/lodash/_baseUnary.js"(e,t){function i(e){return function(t){return e(t)}}w(),t.exports=i}}),Ye=y({"../../node_modules/lodash/_nodeUtil.js"(e,t){w();var i=G(),n="object"==typeof e&&e&&!e.nodeType&&e,r=n&&"object"==typeof t&&t&&!t.nodeType&&t,s=r&&r.exports===n,o=s&&i.process,a=function(){try{var e=r&&r.require&&r.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(t){}}();t.exports=a}}),Xe=y({"../../node_modules/lodash/isTypedArray.js"(e,t){w();var i=ze(),n=Je(),r=Ye(),s=r&&r.isTypedArray,o=s?n(s):i;t.exports=o}}),$e=y({"../../node_modules/lodash/_arrayLikeKeys.js"(e,t){w();var i=je(),n=He(),r=xe(),s=Ke(),o=Ge(),a=Xe(),c=Object.prototype,d=c.hasOwnProperty;function l(e,t){var c=r(e),l=!c&&n(e),h=!c&&!l&&s(e),u=!c&&!l&&!h&&a(e),p=c||l||h||u,m=p?i(e.length,String):[],f=m.length;for(var g in e)!t&&!d.call(e,g)||p&&("length"==g||h&&("offset"==g||"parent"==g)||u&&("buffer"==g||"byteLength"==g||"byteOffset"==g)||o(g,f))||m.push(g);return m}t.exports=l}}),Qe=y({"../../node_modules/lodash/_isPrototype.js"(e,t){w();var i=Object.prototype;function n(e){var t=e&&e.constructor,n="function"==typeof t&&t.prototype||i;return e===n}t.exports=n}}),Ze=y({"../../node_modules/lodash/_overArg.js"(e,t){function i(e,t){return function(i){return e(t(i))}}w(),t.exports=i}}),et=y({"../../node_modules/lodash/_nativeKeys.js"(e,t){w();var i=Ze(),n=i(Object.keys,Object);t.exports=n}}),tt=y({"../../node_modules/lodash/_baseKeys.js"(e,t){w();var i=Qe(),n=et(),r=Object.prototype,s=r.hasOwnProperty;function o(e){if(!i(e))return n(e);var t=[];for(var r in Object(e))s.call(e,r)&&"constructor"!=r&&t.push(r);return t}t.exports=o}}),it=y({"../../node_modules/lodash/isArrayLike.js"(e,t){w();var i=Q(),n=qe();function r(e){return null!=e&&n(e.length)&&!i(e)}t.exports=r}}),nt=y({"../../node_modules/lodash/keys.js"(e,t){w();var i=$e(),n=tt(),r=it();function s(e){return r(e)?i(e):n(e)}t.exports=s}}),rt=y({"../../node_modules/lodash/_getAllKeys.js"(e,t){w();var i=Le(),n=Ue(),r=nt();function s(e){return i(e,r,n)}t.exports=s}}),st=y({"../../node_modules/lodash/_equalObjects.js"(e,t){w();var i=rt(),n=1,r=Object.prototype,s=r.hasOwnProperty;function o(e,t,r,o,a,c){var d=r&n,l=i(e),h=l.length,u=i(t),p=u.length;if(h!=p&&!d)return!1;var m=h;while(m--){var f=l[m];if(!(d?f in t:s.call(t,f)))return!1}var g=c.get(e),_=c.get(t);if(g&&_)return g==t&&_==e;var v=!0;c.set(e,t),c.set(t,e);var y=d;while(++m<h){f=l[m];var E=e[f],S=t[f];if(o)var b=d?o(S,E,f,t,e,c):o(E,S,f,e,t,c);if(!(void 0===b?E===S||a(E,S,r,o,c):b)){v=!1;break}y||(y="constructor"==f)}if(v&&!y){var w=e.constructor,T=t.constructor;w==T||!("constructor"in e)||!("constructor"in t)||"function"==typeof w&&w instanceof w&&"function"==typeof T&&T instanceof T||(v=!1)}return c["delete"](e),c["delete"](t),v}t.exports=o}}),ot=y({"../../node_modules/lodash/_DataView.js"(e,t){w();var i=re(),n=q(),r=i(n,"DataView");t.exports=r}}),at=y({"../../node_modules/lodash/_Promise.js"(e,t){w();var i=re(),n=q(),r=i(n,"Promise");t.exports=r}}),ct=y({"../../node_modules/lodash/_Set.js"(e,t){w();var i=re(),n=q(),r=i(n,"Set");t.exports=r}}),dt=y({"../../node_modules/lodash/_WeakMap.js"(e,t){w();var i=re(),n=q(),r=i(n,"WeakMap");t.exports=r}}),lt=y({"../../node_modules/lodash/_getTag.js"(e,t){w();var i=ot(),n=se(),r=at(),s=ct(),o=dt(),a=X(),c=te(),d="[object Map]",l="[object Object]",h="[object Promise]",u="[object Set]",p="[object WeakMap]",m="[object DataView]",f=c(i),g=c(n),_=c(r),v=c(s),y=c(o),E=a;(i&&E(new i(new ArrayBuffer(1)))!=m||n&&E(new n)!=d||r&&E(r.resolve())!=h||s&&E(new s)!=u||o&&E(new o)!=p)&&(E=function(e){var t=a(e),i=t==l?e.constructor:void 0,n=i?c(i):"";if(n)switch(n){case f:return m;case g:return d;case _:return h;case v:return u;case y:return p}return t}),t.exports=E}}),ht=y({"../../node_modules/lodash/_baseIsEqualDeep.js"(e,t){w();var i=be(),n=Ae(),r=De(),s=st(),o=lt(),a=xe(),c=Ke(),d=Xe(),l=1,h="[object Arguments]",u="[object Array]",p="[object Object]",m=Object.prototype,f=m.hasOwnProperty;function g(e,t,m,g,_,v){var y=a(e),E=a(t),S=y?u:o(e),b=E?u:o(t);S=S==h?p:S,b=b==h?p:b;var w=S==p,T=b==p,C=S==b;if(C&&c(e)){if(!c(t))return!1;y=!0,w=!1}if(C&&!w)return v||(v=new i),y||d(e)?n(e,t,m,g,_,v):r(e,t,S,m,g,_,v);if(!(m&l)){var R=w&&f.call(e,"__wrapped__"),I=T&&f.call(t,"__wrapped__");if(R||I){var A=R?e.value():e,P=I?t.value():t;return v||(v=new i),_(A,P,m,g,v)}}return!!C&&(v||(v=new i),s(e,t,m,g,_,v))}t.exports=g}}),ut=y({"../../node_modules/lodash/_baseIsEqual.js"(e,t){w();var i=ht(),n=Ve();function r(e,t,s,o,a){return e===t||(null==e||null==t||!n(e)&&!n(t)?e!==e&&t!==t:i(e,t,s,o,r,a))}t.exports=r}}),pt=y({"../../node_modules/lodash/isEqual.js"(e,t){w();var i=ut();function n(e,t){return i(e,t)}t.exports=n}}),mt=y({"../../node_modules/ms/index.js"(e,t){w();var i=1e3,n=60*i,r=60*n,s=24*r,o=7*s,a=365.25*s;function c(e){if(e=String(e),!(e.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var c=parseFloat(t[1]),d=(t[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"yrs":case"yr":case"y":return c*a;case"weeks":case"week":case"w":return c*o;case"days":case"day":case"d":return c*s;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*n;case"seconds":case"second":case"secs":case"sec":case"s":return c*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}}}function d(e){var t=Math.abs(e);return t>=s?Math.round(e/s)+"d":t>=r?Math.round(e/r)+"h":t>=n?Math.round(e/n)+"m":t>=i?Math.round(e/i)+"s":e+"ms"}function l(e){var t=Math.abs(e);return t>=s?h(e,t,s,"day"):t>=r?h(e,t,r,"hour"):t>=n?h(e,t,n,"minute"):t>=i?h(e,t,i,"second"):e+" ms"}function h(e,t,i,n){var r=t>=1.5*i;return Math.round(e/i)+" "+n+(r?"s":"")}t.exports=function(e,t){t=t||{};var i=typeof e;if("string"===i&&e.length>0)return c(e);if("number"===i&&isFinite(e))return t.long?l(e):d(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}}}),ft=y({"../../node_modules/debug/src/common.js"(e,t){function i(e){function t(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return i.colors[Math.abs(t)%i.colors.length]}function i(e){let t,r,s,o=null;function a(...e){if(!a.enabled)return;const n=a,r=Number(new Date),s=r-(t||r);n.diff=s,n.prev=t,n.curr=r,t=r,e[0]=i.coerce(e[0]),"string"!==typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((t,r)=>{if("%%"===t)return"%";o++;const s=i.formatters[r];if("function"===typeof s){const i=e[o];t=s.call(n,i),e.splice(o,1),o--}return t})),i.formatArgs.call(n,e);const c=n.log||i.log;c.apply(n,e)}return a.namespace=e,a.useColors=i.useColors(),a.color=i.selectColor(e),a.extend=n,a.destroy=i.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(r!==i.namespaces&&(r=i.namespaces,s=i.enabled(e)),s),set:e=>{o=e}}),"function"===typeof i.init&&i.init(a),a}function n(e,t){const n=i(this.namespace+("undefined"===typeof t?":":t)+e);return n.log=this.log,n}function r(e){let t;i.save(e),i.namespaces=e,i.names=[],i.skips=[];const n=("string"===typeof e?e:"").split(/[\s,]+/),r=n.length;for(t=0;t<r;t++)n[t]&&(e=n[t].replace(/\*/g,".*?"),"-"===e[0]?i.skips.push(new RegExp("^"+e.slice(1)+"$")):i.names.push(new RegExp("^"+e+"$")))}function s(){const e=[...i.names.map(a),...i.skips.map(a).map((e=>"-"+e))].join(",");return i.enable(""),e}function o(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=i.skips.length;t<n;t++)if(i.skips[t].test(e))return!1;for(t=0,n=i.names.length;t<n;t++)if(i.names[t].test(e))return!0;return!1}function a(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}function c(e){return e instanceof Error?e.stack||e.message:e}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return i.debug=i,i.default=i,i.coerce=c,i.disable=s,i.enable=r,i.enabled=o,i.humanize=mt(),i.destroy=d,Object.keys(e).forEach((t=>{i[t]=e[t]})),i.names=[],i.skips=[],i.formatters={},i.selectColor=t,i.enable(i.load()),i}w(),t.exports=i}}),gt=y({"../../node_modules/debug/src/browser.js"(e,t){function i(){return!("undefined"===typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"===typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!==typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!==typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!==typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!==typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function r(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;e.splice(1,0,i,"color: inherit");let n=0,r=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(r=n))})),e.splice(r,0,i)}function s(t){try{t?e.storage.setItem("debug",t):e.storage.removeItem("debug")}catch(i){}}function o(){let t;try{t=e.storage.getItem("debug")}catch(i){}return!t&&"undefined"!==typeof n&&"env"in n&&(t=n.env.DEBUG),t}function a(){try{return localStorage}catch(e){}}w(),e.formatArgs=r,e.save=s,e.load=o,e.useColors=i,e.storage=a(),e.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=ft()(e);var{formatters:c}=t.exports;c.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}}),_t=y({"../../node_modules/mediasoup-client/lib/Logger.js"(e){w();var t=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;var i=t(gt()),n="mediasoup-client",r=class{constructor(e){e?(this._debug=(0,i.default)(`${n}:${e}`),this._warn=(0,i.default)(`${n}:WARN:${e}`),this._error=(0,i.default)(`${n}:ERROR:${e}`)):(this._debug=(0,i.default)(n),this._warn=(0,i.default)(`${n}:WARN`),this._error=(0,i.default)(`${n}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};e.Logger=r}}),vt=y({"../../node_modules/events/events.js"(e,t){w();var i,n="object"===typeof Reflect?Reflect:null,r=n&&"function"===typeof n.apply?n.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};function s(e){console&&console.warn&&console.warn(e)}i=n&&"function"===typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!==e};function a(){a.init.call(this)}t.exports=a,t.exports.once=y,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function d(e){if("function"!==typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function h(e,t,i,n){var r,o,a;if(d(i),o=e._events,void 0===o?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),a=o[t]),void 0===a)a=o[t]=i,++e._eventsCount;else if("function"===typeof a?a=o[t]=n?[i,a]:[a,i]:n?a.unshift(i):a.push(i),r=l(e),r>0&&a.length>r&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,s(c)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=u.bind(n);return r.listener=i,n.wrapFn=r,r}function m(e,t,i){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"===typeof r?i?[r.listener||r]:[r]:i?v(r):g(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"===typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}function _(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function v(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function y(e,t){return new Promise((function(i,n){function r(i){e.removeListener(t,s),n(i)}function s(){"function"===typeof e.removeListener&&e.removeListener("error",r),i([].slice.call(arguments))}S(e,t,s,{once:!0}),"error"!==t&&E(e,r,{once:!0})}))}function E(e,t,i){"function"===typeof e.on&&S(e,"error",t,i)}function S(e,t,i,n){if("function"===typeof e.on)n.once?e.once(t,i):e.on(t,i);else{if("function"!==typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(s){n.once&&e.removeEventListener(t,r),i(s)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!==typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!==typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,s=this._events;if(void 0!==s)n=n&&void 0===s.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(void 0===c)return!1;if("function"===typeof c)r(c,this,t);else{var d=c.length,l=g(c,d);for(i=0;i<d;++i)r(l[i],this,t)}return!0},a.prototype.addListener=function(e,t){return h(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return h(this,e,t,!0)},a.prototype.once=function(e,t){return d(t),this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var i,n,r,s,o;if(d(t),n=this._events,void 0===n)return this;if(i=n[e],void 0===i)return this;if(i===t||i.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!==typeof i){for(r=-1,s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){o=i[s].listener,r=s;break}if(r<0)return this;0===r?i.shift():_(i,r),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,i,n;if(i=this._events,void 0===i)return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,s=Object.keys(i);for(n=0;n<s.length;++n)r=s[n],"removeListener"!==r&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],"function"===typeof t)this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return m(this,e,!0)},a.prototype.rawListeners=function(e){return m(this,e,!1)},a.listenerCount=function(e,t){return"function"===typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},a.prototype.listenerCount=f,a.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]}}}),yt=y({"../../node_modules/mediasoup-client/lib/EnhancedEventEmitter.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.EnhancedEventEmitter=void 0;var t=vt(),i=_t(),n=new i.Logger("EnhancedEventEmitter"),r=class extends t.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){const i=super.listenerCount(e);try{return super.emit(e,...t)}catch(r){return n.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,r),Boolean(i)}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}};e.EnhancedEventEmitter=r}}),Et=y({"../../node_modules/mediasoup-client/lib/errors.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.InvalidStateError=e.UnsupportedError=void 0;var t=class extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,t):this.stack=new Error(e).stack}};e.UnsupportedError=t;var i=class extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,i):this.stack=new Error(e).stack}};e.InvalidStateError=i}}),St=y({"../../node_modules/mediasoup-client/lib/utils.js"(e){function t(e,t){return"undefined"===typeof e?t:JSON.parse(JSON.stringify(e))}function i(){return Math.round(1e7*Math.random())}w(),Object.defineProperty(e,"__esModule",{value:!0}),e.generateRandomNumber=e.clone=void 0,e.clone=t,e.generateRandomNumber=i}}),bt=y({"../../node_modules/h264-profile-level-id/index.js"(e){w();var t=gt()("h264-profile-level-id");t.log=console.info.bind(console);var i=1,n=2,r=3,s=4,o=5;e.ProfileConstrainedBaseline=i,e.ProfileBaseline=n,e.ProfileMain=r,e.ProfileConstrainedHigh=s,e.ProfileHigh=o;var a=0,c=10,d=11,l=12,h=13,u=20,p=21,m=22,f=30,g=31,_=32,v=40,y=41,E=42,S=50,b=51,T=52;e.Level1_b=a,e.Level1=c,e.Level1_1=d,e.Level1_2=l,e.Level1_3=h,e.Level2=u,e.Level2_1=p,e.Level2_2=m,e.Level3=f,e.Level3_1=g,e.Level3_2=_,e.Level4=v,e.Level4_1=y,e.Level4_2=E,e.Level5=S,e.Level5_1=b,e.Level5_2=T;var C=class{constructor(e,t){this.profile=e,this.level=t}};e.ProfileLevelId=C;var R=new C(i,g),I=16,A=class{constructor(e){this._mask=~N("x",e),this._maskedValue=N("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}},P=class{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i}},O=[new P(66,new A("x1xx0000"),i),new P(77,new A("1xxx0000"),i),new P(88,new A("11xx0000"),i),new P(66,new A("x0xx0000"),n),new P(88,new A("10xx0000"),n),new P(77,new A("0x0x0000"),r),new P(100,new A("00000000"),o),new P(100,new A("00001100"),s)];function N(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function D(e,t){return e===a?t!==c&&t!==a:t===a?e!==c:e<t}function k(e,t){return D(e,t)?e:t}function x(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}e.parseProfileLevelId=function(e){if("string"!==typeof e||6!==e.length)return null;const i=parseInt(e,16);if(0===i)return null;const n=255&i,r=i>>8&255,s=i>>16&255;let o;switch(n){case d:o=0!==(r&I)?a:d;break;case c:case l:case h:case u:case p:case m:case f:case g:case _:case v:case y:case E:case S:case b:case T:o=n;break;default:return t("parseProfileLevelId() | unrecognized level_idc:%s",n),null}for(const t of O)if(s===t.profile_idc&&t.profile_iop.isMatch(r))return new C(t.profile,o);return t("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},e.profileLevelIdToString=function(e){if(e.level==a)switch(e.profile){case i:return"42f00b";case n:return"42100b";case r:return"4d100b";default:return t("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let c;switch(e.profile){case i:c="42e0";break;case n:c="4200";break;case r:c="4d00";break;case s:c="640c";break;case o:c="6400";break;default:return t("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let d=e.level.toString(16);return 1===d.length&&(d=`0${d}`),`${c}${d}`},e.parseSdpProfileLevelId=function(t={}){const i=t["profile-level-id"];return i?e.parseProfileLevelId(i):R},e.isSameProfile=function(t={},i={}){const n=e.parseSdpProfileLevelId(t),r=e.parseSdpProfileLevelId(i);return Boolean(n&&r&&n.profile===r.profile)},e.generateProfileLevelIdForAnswer=function(i={},n={}){if(!i["profile-level-id"]&&!n["profile-level-id"])return t("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const r=e.parseSdpProfileLevelId(i),s=e.parseSdpProfileLevelId(n);if(!r)throw new TypeError("invalid local_profile_level_id");if(!s)throw new TypeError("invalid remote_profile_level_id");if(r.profile!==s.profile)throw new TypeError("H264 Profile mismatch");const o=x(i)&&x(n),a=r.level,c=s.level,d=k(a,c),l=o?a:d;return t("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",r.profile,l),e.profileLevelIdToString(new C(r.profile,l))}}}),wt=y({"../../node_modules/mediasoup-client/lib/ortc.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.canReceive=e.canSend=e.generateProbatorRtpParameters=e.reduceCodecs=e.getSendingRemoteRtpParameters=e.getSendingRtpParameters=e.getRecvRtpCapabilities=e.getExtendedRtpCapabilities=e.validateSctpStreamParameters=e.validateSctpParameters=e.validateNumSctpStreams=e.validateSctpCapabilities=e.validateRtcpParameters=e.validateRtpEncodingParameters=e.validateRtpHeaderExtensionParameters=e.validateRtpCodecParameters=e.validateRtpParameters=e.validateRtpHeaderExtension=e.validateRtcpFeedback=e.validateRtpCodecCapability=e.validateRtpCapabilities=void 0;var r=n(bt()),s=n(St()),o="probator",a=1234,c=127;function d(e){if("object"!==typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)l(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)u(t)}function l(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!==typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!==typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if(e.kind=i[1].toLowerCase(),e.preferredPayloadType&&"number"!==typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!==typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!==typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"===typeof e.parameters||(e.parameters={});for(const n of Object.keys(e.parameters)){let t=e.parameters[n];if(void 0===t&&(e.parameters[n]="",t=""),"string"!==typeof t&&"number"!==typeof t)throw new TypeError(`invalid codec parameter [key:${n}s, value:${t}]`);if("apt"===n&&"number"!==typeof t)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const n of e.rtcpFeedback)h(n)}function h(e){if("object"!==typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!==typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"===typeof e.parameter||(e.parameter="")}function u(e){if("object"!==typeof e)throw new TypeError("ext is not an object");if("audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!==typeof e.uri)throw new TypeError("missing ext.uri");if("number"!==typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!==typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!==typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function p(e){if("object"!==typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!==typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)m(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)f(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)g(t);if(e.rtcp&&"object"!==typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),_(e.rtcp)}function m(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!==typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!==typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if("number"!==typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!==typeof e.clockRate)throw new TypeError("missing codec.clockRate");const n=i[1].toLowerCase();"audio"===n?"number"!==typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"===typeof e.parameters||(e.parameters={});for(const r of Object.keys(e.parameters)){let t=e.parameters[r];if(void 0===t&&(e.parameters[r]="",t=""),"string"!==typeof t&&"number"!==typeof t)throw new TypeError(`invalid codec parameter [key:${r}s, value:${t}]`);if("apt"===r&&"number"!==typeof t)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const r of e.rtcpFeedback)h(r)}function f(e){if("object"!==typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!==typeof e.uri)throw new TypeError("missing ext.uri");if("number"!==typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!==typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"===typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!==typeof i&&"number"!==typeof i)throw new TypeError("invalid header extension parameter")}}function g(e){if("object"!==typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!==typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!==typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!==typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!==typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"===typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!==typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function _(e){if("object"!==typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!==typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"===typeof e.reducedSize||(e.reducedSize=!0)}function v(e){if("object"!==typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!==typeof e.numStreams)throw new TypeError("missing caps.numStreams");y(e.numStreams)}function y(e){if("object"!==typeof e)throw new TypeError("numStreams is not an object");if("number"!==typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!==typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function E(e){if("object"!==typeof e)throw new TypeError("params is not an object");if("number"!==typeof e.port)throw new TypeError("missing params.port");if("number"!==typeof e.OS)throw new TypeError("missing params.OS");if("number"!==typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!==typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")}function S(e){if("object"!==typeof e)throw new TypeError("params is not an object");if("number"!==typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"===typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!==typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!==typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.label&&"string"!==typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!==typeof e.protocol)throw new TypeError("invalid params.protocol")}function b(e,t){const i={codecs:[],headerExtensions:[]};for(const n of t.codecs||[]){if(N(n))continue;const t=(e.codecs||[]).find((e=>D(e,n,{strict:!0,modify:!0})));if(!t)continue;const r={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:n.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:n.parameters,rtcpFeedback:x(t,n)};i.codecs.push(r)}for(const n of i.codecs){const i=e.codecs.find((e=>N(e)&&e.parameters.apt===n.localPayloadType)),r=t.codecs.find((e=>N(e)&&e.parameters.apt===n.remotePayloadType));i&&r&&(n.localRtxPayloadType=i.preferredPayloadType,n.remoteRtxPayloadType=r.preferredPayloadType)}for(const n of t.headerExtensions){const t=e.headerExtensions.find((e=>k(e,n)));if(!t)continue;const r={kind:n.kind,uri:n.uri,sendId:t.preferredId,recvId:n.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(n.direction){case"sendrecv":r.direction="sendrecv";break;case"recvonly":r.direction="sendonly";break;case"sendonly":r.direction="recvonly";break;case"inactive":r.direction="inactive";break}i.headerExtensions.push(r)}return i}function T(e){const t={codecs:[],headerExtensions:[]};for(const i of e.codecs){const e={mimeType:i.mimeType,kind:i.kind,preferredPayloadType:i.remotePayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(e),!i.remoteRtxPayloadType)continue;const n={mimeType:`${i.kind}/rtx`,kind:i.kind,preferredPayloadType:i.remoteRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.remotePayloadType},rtcpFeedback:[]};t.codecs.push(n)}for(const i of e.headerExtensions){if("sendrecv"!==i.direction&&"recvonly"!==i.direction)continue;const e={kind:i.kind,uri:i.uri,preferredId:i.recvId,preferredEncrypt:i.encrypt,direction:i.direction};t.headerExtensions.push(e)}return t}function C(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const n of t.codecs){if(n.kind!==e)continue;const t={mimeType:n.mimeType,payloadType:n.localPayloadType,clockRate:n.clockRate,channels:n.channels,parameters:n.localParameters,rtcpFeedback:n.rtcpFeedback};if(i.codecs.push(t),n.localRtxPayloadType){const e={mimeType:`${n.kind}/rtx`,payloadType:n.localRtxPayloadType,clockRate:n.clockRate,parameters:{apt:n.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const n of t.headerExtensions){if(n.kind&&n.kind!==e||"sendrecv"!==n.direction&&"sendonly"!==n.direction)continue;const t={uri:n.uri,id:n.sendId,encrypt:n.encrypt,parameters:{}};i.headerExtensions.push(t)}return i}function R(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const n of t.codecs){if(n.kind!==e)continue;const t={mimeType:n.mimeType,payloadType:n.localPayloadType,clockRate:n.clockRate,channels:n.channels,parameters:n.remoteParameters,rtcpFeedback:n.rtcpFeedback};if(i.codecs.push(t),n.localRtxPayloadType){const e={mimeType:`${n.kind}/rtx`,payloadType:n.localRtxPayloadType,clockRate:n.clockRate,parameters:{apt:n.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const n of t.headerExtensions){if(n.kind&&n.kind!==e||"sendrecv"!==n.direction&&"sendonly"!==n.direction)continue;const t={uri:n.uri,id:n.sendId,encrypt:n.encrypt,parameters:{}};i.headerExtensions.push(t)}if(i.headerExtensions.some((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri)))for(const n of i.codecs)n.rtcpFeedback=(n.rtcpFeedback||[]).filter((e=>"goog-remb"!==e.type));else if(i.headerExtensions.some((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri)))for(const n of i.codecs)n.rtcpFeedback=(n.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type));else for(const n of i.codecs)n.rtcpFeedback=(n.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type&&"goog-remb"!==e.type));return i}function I(e,t){const i=[];if(t){for(let n=0;n<e.length;++n)if(D(e[n],t)){i.push(e[n]),N(e[n+1])&&i.push(e[n+1]);break}if(0===i.length)throw new TypeError("no matching codec found")}else i.push(e[0]),N(e[1])&&i.push(e[1]);return i}function A(e){e=s.clone(e,{}),p(e);const t={mid:o,codecs:[],headerExtensions:[],encodings:[{ssrc:a}],rtcp:{cname:"probator"}};return t.codecs.push(e.codecs[0]),t.codecs[0].payloadType=c,t.headerExtensions=e.headerExtensions,t}function P(e,t){return t.codecs.some((t=>t.kind===e))}function O(e,t){if(p(e),0===e.codecs.length)return!1;const i=e.codecs[0];return t.codecs.some((e=>e.remotePayloadType===i.payloadType))}function N(e){return!!e&&/.+\/rtx$/i.test(e.mimeType)}function D(e,t,{strict:i=!1,modify:n=!1}={}){const s=e.mimeType.toLowerCase(),o=t.mimeType.toLowerCase();if(s!==o)return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(s){case"video/h264":if(i){const i=e.parameters["packetization-mode"]||0,s=t.parameters["packetization-mode"]||0;if(i!==s)return!1;if(!r.isSameProfile(e.parameters,t.parameters))return!1;let o;try{o=r.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(a){return!1}n&&(o?(e.parameters["profile-level-id"]=o,t.parameters["profile-level-id"]=o):(delete e.parameters["profile-level-id"],delete t.parameters["profile-level-id"]))}break;case"video/vp9":if(i){const i=e.parameters["profile-id"]||0,n=t.parameters["profile-id"]||0;if(i!==n)return!1}break}return!0}function k(e,t){return(!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function x(e,t){const i=[];for(const n of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find((e=>e.type===n.type&&(e.parameter===n.parameter||!e.parameter&&!n.parameter)));e&&i.push(e)}return i}e.validateRtpCapabilities=d,e.validateRtpCodecCapability=l,e.validateRtcpFeedback=h,e.validateRtpHeaderExtension=u,e.validateRtpParameters=p,e.validateRtpCodecParameters=m,e.validateRtpHeaderExtensionParameters=f,e.validateRtpEncodingParameters=g,e.validateRtcpParameters=_,e.validateSctpCapabilities=v,e.validateNumSctpStreams=y,e.validateSctpParameters=E,e.validateSctpStreamParameters=S,e.getExtendedRtpCapabilities=b,e.getRecvRtpCapabilities=T,e.getSendingRtpParameters=C,e.getSendingRemoteRtpParameters=R,e.reduceCodecs=I,e.generateProbatorRtpParameters=A,e.canSend=P,e.canReceive=O}}),Tt=y({"../../node_modules/awaitqueue/lib/Logger.js"(e){w();var t=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;var i=t(gt()),n="awaitqueue",r=class{constructor(e){e?(this._debug=(0,i.default)(`${n}:${e}`),this._warn=(0,i.default)(`${n}:WARN:${e}`),this._error=(0,i.default)(`${n}:ERROR:${e}`)):(this._debug=(0,i.default)(n),this._warn=(0,i.default)(`${n}:WARN`),this._error=(0,i.default)(`${n}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};e.Logger=r}}),Ct=y({"../../node_modules/awaitqueue/lib/index.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.AwaitQueue=e.AwaitQueueRemovedTaskError=e.AwaitQueueStoppedError=void 0;var t=Tt(),i=new t.Logger,n=class extends Error{constructor(e){super(null!==e&&void 0!==e?e:"AwaitQueue stopped"),this.name="AwaitQueueStoppedError","function"===typeof Error.captureStackTrace&&Error.captureStackTrace(this,n)}};e.AwaitQueueStoppedError=n;var r=class extends Error{constructor(e){super(null!==e&&void 0!==e?e:"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError","function"===typeof Error.captureStackTrace&&Error.captureStackTrace(this,r)}};e.AwaitQueueRemovedTaskError=r;var s=class{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}push(e,t){return b(this,null,(function*(){if(t=null!==t&&void 0!==t?t:e.name,i.debug(`push() [name:${t}]`),"function"!==typeof e)throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch(n){}return new Promise(((n,r)=>{const s={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:e=>{if(s.completed)return;s.completed=!0,this.pendingTasks.delete(s.id),i.debug(`resolving task [name:${s.name}]`),n(e);const[t]=this.pendingTasks.values();t&&!t.executedAt&&this.execute(t)},reject:e=>{if(!s.completed&&(s.completed=!0,this.pendingTasks.delete(s.id),i.debug(`rejecting task [name:${s.name}]: %s`,String(e)),r(e),!this.stopping)){const[e]=this.pendingTasks.values();e&&!e.executedAt&&this.execute(e)}}};this.pendingTasks.set(s.id,s),1===this.pendingTasks.size&&this.execute(s)}))}))}stop(){i.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())i.debug(`stop() | stopping task [name:${e.name}]`),e.reject(new n);this.stopping=!1}remove(e){i.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];t?t.reject(new r):i.debug(`stop() | no task with given idx [taskIdx:${e}]`)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map((i=>({idx:t++,task:i.task,name:i.name,enqueuedTime:i.executedAt?i.executedAt-i.enqueuedAt:e-i.enqueuedAt,executionTime:i.executedAt?e-i.executedAt:0})))}execute(e){return b(this,null,(function*(){if(i.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=yield e.task();e.resolve(t)}catch(t){e.reject(t)}}))}};e.AwaitQueue=s}}),Rt=y({"../../node_modules/queue-microtask/index.js"(e,t){var i;w(),t.exports="function"===typeof queueMicrotask?queueMicrotask.bind("undefined"!==typeof window?window:global):e=>(i||(i=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))}}),It=y({"../../node_modules/mediasoup-client/lib/Producer.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.Producer=void 0;var t=_t(),i=yt(),n=Et(),r=new t.Logger("Producer"),s=class extends i.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:n,track:s,rtpParameters:o,stopTracks:a,disableTrackOnPause:c,zeroRtpOnPause:d,appData:l}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=n,this._track=s,this._kind=s.kind,this._rtpParameters=o,this._paused=!!c&&!s.enabled,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=c,this._zeroRtpOnPause=d,this._appData=l||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return b(this,null,(function*(){if(this._closed)throw new n.InvalidStateError("closed");return new Promise(((e,t)=>{this.safeEmit("@getstats",e,t)}))}))}pause(){r.debug("pause()"),this._closed?r.error("pause() | Producer closed"):(this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise(((e,t)=>{this.safeEmit("@pause",e,t)})).catch((()=>{})),this._observer.safeEmit("pause"))}resume(){r.debug("resume()"),this._closed?r.error("resume() | Producer closed"):(this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise(((e,t)=>{this.safeEmit("@resume",e,t)})).catch((()=>{})),this._observer.safeEmit("resume"))}replaceTrack(e){return b(this,arguments,(function*({track:e}){if(r.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch(t){}throw new n.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new n.InvalidStateError("track ended");e!==this._track?(yield new Promise(((t,i)=>{this.safeEmit("@replacetrack",e,t,i)})),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()):r.debug("replaceTrack() | same track, ignored")}))}setMaxSpatialLayer(e){return b(this,null,(function*(){if(this._closed)throw new n.InvalidStateError("closed");if("video"!==this._kind)throw new n.UnsupportedError("not a video Producer");if("number"!==typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(yield new Promise(((t,i)=>{this.safeEmit("@setmaxspatiallayer",e,t,i)})).catch((()=>{})),this._maxSpatialLayer=e)}))}setRtpEncodingParameters(e){return b(this,null,(function*(){if(this._closed)throw new n.InvalidStateError("closed");if("object"!==typeof e)throw new TypeError("invalid params");yield new Promise(((t,i)=>{this.safeEmit("@setrtpencodingparameters",e,t,i)}))}))}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch(e){}}};e.Producer=s}}),At=y({"../../node_modules/mediasoup-client/lib/Consumer.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.Consumer=void 0;var t=_t(),i=yt(),n=Et(),r=new t.Logger("Consumer"),s=class extends i.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:n,rtpReceiver:s,track:o,rtpParameters:a,appData:c}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=e,this._localId=t,this._producerId=n,this._rtpReceiver=s,this._track=o,this._rtpParameters=a,this._paused=!o.enabled,this._appData=c||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return b(this,null,(function*(){if(this._closed)throw new n.InvalidStateError("closed");return new Promise(((e,t)=>{this.safeEmit("@getstats",e,t)}))}))}pause(){r.debug("pause()"),this._closed?r.error("pause() | Consumer closed"):this._paused?r.debug("pause() | Consumer is already paused"):(this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause"))}resume(){r.debug("resume()"),this._closed?r.error("resume() | Consumer closed"):this._paused?(this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")):r.debug("resume() | Consumer is already resumed")}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch(e){}}};e.Consumer=s}}),Pt=y({"../../node_modules/mediasoup-client/lib/DataProducer.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.DataProducer=void 0;var t=_t(),i=yt(),n=Et(),r=new t.Logger("DataProducer"),s=class extends i.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:n,appData:s}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=n,this._appData=s||{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(r.debug("send()"),this._closed)throw new n.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",(()=>{this._closed||(r.debug('DataChannel "open" event'),this.safeEmit("open"))})),this._dataChannel.addEventListener("error",(e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?r.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):r.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)})),this._dataChannel.addEventListener("close",(()=>{this._closed||(r.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))})),this._dataChannel.addEventListener("message",(()=>{this._closed||r.warn('DataChannel "message" event in a DataProducer, message discarded')})),this._dataChannel.addEventListener("bufferedamountlow",(()=>{this._closed||this.safeEmit("bufferedamountlow")}))}};e.DataProducer=s}}),Ot=y({"../../node_modules/mediasoup-client/lib/DataConsumer.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.DataConsumer=void 0;var t=_t(),i=yt(),n=new t.Logger("DataConsumer"),r=class extends i.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:r,sctpStreamParameters:s,appData:o}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,n.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=r,this._sctpStreamParameters=s,this._appData=o||{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(n.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",(()=>{this._closed||(n.debug('DataChannel "open" event'),this.safeEmit("open"))})),this._dataChannel.addEventListener("error",(e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?n.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):n.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)})),this._dataChannel.addEventListener("close",(()=>{this._closed||(n.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))})),this._dataChannel.addEventListener("message",(e=>{this._closed||this.safeEmit("message",e.data)}))}};e.DataConsumer=r}}),Nt=y({"../../node_modules/mediasoup-client/lib/Transport.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n},r=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.Transport=void 0;var s=Ct(),o=r(Rt()),a=_t(),c=yt(),d=Et(),l=n(St()),h=n(wt()),u=It(),p=At(),m=Pt(),f=Ot(),g=new a.Logger("Transport"),_=class{constructor(e){this.consumerOptions=e,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}},v=class extends c.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:r,sctpParameters:o,iceServers:a,iceTransportPolicy:d,additionalSettings:h,proprietaryConstraints:u,appData:p,handlerFactory:m,extendedRtpCapabilities:f,canProduceByKind:_}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new s.AwaitQueue,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new c.EnhancedEventEmitter,g.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=f,this._canProduceByKind=_,this._maxSctpMessageSize=o?o.maxMessageSize:null,h=l.clone(h,{}),delete h.iceServers,delete h.iceTransportPolicy,delete h.bundlePolicy,delete h.rtcpMuxPolicy,delete h.sdpSemantics,this._handler=m(),this._handler.run({direction:e,iceParameters:i,iceCandidates:n,dtlsParameters:r,sctpParameters:o,iceServers:a,iceTransportPolicy:d,additionalSettings:h,proprietaryConstraints:u,extendedRtpCapabilities:f}),this._appData=p||{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){g.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}getStats(){return b(this,null,(function*(){if(this._closed)throw new d.InvalidStateError("closed");return this._handler.getTransportStats()}))}restartIce(e){return b(this,arguments,(function*({iceParameters:e}){if(g.debug("restartIce()"),this._closed)throw new d.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.restartIce(e)}))),"transport.restartIce()")}))}updateIceServers(){return b(this,arguments,(function*({iceServers:e}={}){if(g.debug("updateIceServers()"),this._closed)throw new d.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.updateIceServers(e)}))),"transport.updateIceServers()")}))}produce(){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n,stopTracks:r=!0,disableTrackOnPause:s=!0,zeroRtpOnPause:o=!1,appData:a={}}={}){if(g.debug("produce() [track:%o]",e),this._closed)throw new d.InvalidStateError("closed");if(!e)throw new TypeError("missing track");if("send"!==this._direction)throw new d.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new d.UnsupportedError(`cannot produce ${e.kind}`);if("ended"===e.readyState)throw new d.InvalidStateError("track ended");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(a&&"object"!==typeof a)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push((()=>b(this,null,(function*(){let c;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&0===t.length?c=void 0:t&&(c=t.map((e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"boolean"===typeof e.dtx&&(t.dtx=e.dtx),"string"===typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"===typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"===typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"===typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"===typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"===typeof e.priority&&(t.priority=e.priority),"string"===typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t})));const{localId:d,rtpParameters:l,rtpSender:p}=yield this._handler.send({track:e,encodings:c,codecOptions:i,codec:n});try{h.validateRtpParameters(l);const{id:t}=yield new Promise(((t,i)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:l,appData:a},t,i)})),i=new u.Producer({id:t,localId:d,rtpSender:p,track:e,rtpParameters:l,stopTracks:r,disableTrackOnPause:s,zeroRtpOnPause:o,appData:a});return this._producers.set(i.id,i),this.handleProducer(i),this._observer.safeEmit("newproducer",i),i}catch(m){throw this._handler.stopSending(d).catch((()=>{})),m}}))),"transport.produce()").catch((t=>{if(r)try{e.stop()}catch(i){}throw t}))}))}consume(e){return b(this,arguments,(function*({id:e,producerId:t,kind:i,rtpParameters:n,streamId:r,appData:s={}}){if(g.debug("consume()"),n=l.clone(n,void 0),this._closed)throw new d.InvalidStateError("closed");if("recv"!==this._direction)throw new d.UnsupportedError("not a receiving Transport");if("string"!==typeof e)throw new TypeError("missing id");if("string"!==typeof t)throw new TypeError("missing producerId");if("audio"!==i&&"video"!==i)throw new TypeError(`invalid kind '${i}'`);if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(s&&"object"!==typeof s)throw new TypeError("if given, appData must be an object");const a=h.canReceive(n,this._extendedRtpCapabilities);if(!a)throw new d.UnsupportedError("cannot consume this Producer");const c=new _({id:e,producerId:t,kind:i,rtpParameters:n,streamId:r,appData:s});return this._pendingConsumerTasks.push(c),(0,o.default)((()=>{if(this._closed)throw new d.InvalidStateError("closed");!1===this._consumerCreationInProgress&&this.createPendingConsumers()})),c.promise}))}produceData(){return b(this,arguments,(function*({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:i,label:n="",protocol:r="",appData:s={}}={}){if(g.debug("produceData()"),this._closed)throw new d.InvalidStateError("closed");if("send"!==this._direction)throw new d.UnsupportedError("not a sending Transport");if(!this._maxSctpMessageSize)throw new d.UnsupportedError("SCTP not enabled by remote Transport");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("producedata"))throw new TypeError('no "producedata" listener set into this transport');if(s&&"object"!==typeof s)throw new TypeError("if given, appData must be an object");return(t||i)&&(e=!1),this._awaitQueue.push((()=>b(this,null,(function*(){const{dataChannel:o,sctpStreamParameters:a}=yield this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:r});h.validateSctpStreamParameters(a);const{id:c}=yield new Promise(((e,t)=>{this.safeEmit("producedata",{sctpStreamParameters:a,label:n,protocol:r,appData:s},e,t)})),d=new m.DataProducer({id:c,dataChannel:o,sctpStreamParameters:a,appData:s});return this._dataProducers.set(d.id,d),this.handleDataProducer(d),this._observer.safeEmit("newdataproducer",d),d}))),"transport.produceData()")}))}consumeData(e){return b(this,arguments,(function*({id:e,dataProducerId:t,sctpStreamParameters:i,label:n="",protocol:r="",appData:s={}}){if(g.debug("consumeData()"),i=l.clone(i,void 0),this._closed)throw new d.InvalidStateError("closed");if("recv"!==this._direction)throw new d.UnsupportedError("not a receiving Transport");if(!this._maxSctpMessageSize)throw new d.UnsupportedError("SCTP not enabled by remote Transport");if("string"!==typeof e)throw new TypeError("missing id");if("string"!==typeof t)throw new TypeError("missing dataProducerId");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(s&&"object"!==typeof s)throw new TypeError("if given, appData must be an object");return h.validateSctpStreamParameters(i),this._awaitQueue.push((()=>b(this,null,(function*(){const{dataChannel:o}=yield this._handler.receiveDataChannel({sctpStreamParameters:i,label:n,protocol:r}),a=new f.DataConsumer({id:e,dataProducerId:t,dataChannel:o,sctpStreamParameters:i,appData:s});return this._dataConsumers.set(a.id,a),this.handleDataConsumer(a),this._observer.safeEmit("newdataconsumer",a),a}))),"transport.consumeData()")}))}createPendingConsumers(){return b(this,null,(function*(){this._consumerCreationInProgress=!0,this._awaitQueue.push((()=>b(this,null,(function*(){if(0===this._pendingConsumerTasks.length)return void g.debug("createPendingConsumers() | there is no Consumer to be created");const e=[...this._pendingConsumerTasks];let t;this._pendingConsumerTasks=[];const i=[];for(const r of e){const{id:e,kind:t,rtpParameters:n,streamId:s}=r.consumerOptions;i.push({trackId:e,kind:t,rtpParameters:n,streamId:s})}try{const n=yield this._handler.receive(i);for(let i=0;i<n.length;i++){const r=e[i],s=n[i],{id:o,producerId:a,kind:c,rtpParameters:d,appData:l}=r.consumerOptions,{localId:h,rtpReceiver:u,track:m}=s,f=new p.Consumer({id:o,localId:h,producerId:a,rtpReceiver:u,track:m,rtpParameters:d,appData:l});this._consumers.set(f.id,f),this.handleConsumer(f),this._probatorConsumerCreated||t||"video"!==c||(t=f),this._observer.safeEmit("newconsumer",f),r.resolve(f)}}catch(n){for(const t of e)t.reject(n)}if(t)try{const e=h.generateProbatorRtpParameters(t.rtpParameters);yield this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:e}]),g.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(n){g.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",n)}}))),"transport.createPendingConsumers()").then((()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()})).catch((()=>{}))}))}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push((()=>b(this,null,(function*(){if(0===this._pendingPauseConsumers.size)return void g.debug("pausePendingConsumers() | there is no Consumer to be paused");const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map((e=>e.localId));yield this._handler.pauseReceiving(t)}catch(t){g.error("pausePendingConsumers() | failed to pause Consumers:",t)}}))),"transport.pausePendingConsumers").then((()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()})).catch((()=>{}))}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push((()=>b(this,null,(function*(){if(0===this._pendingResumeConsumers.size)return void g.debug("resumePendingConsumers() | there is no Consumer to be resumed");const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map((e=>e.localId));yield this._handler.resumeReceiving(t)}catch(t){g.error("resumePendingConsumers() | failed to resume Consumers:",t)}}))),"transport.resumePendingConsumers").then((()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()})).catch((()=>{}))}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push((()=>b(this,null,(function*(){if(0===this._pendingCloseConsumers.size)return void g.debug("closePendingConsumers() | there is no Consumer to be closed");const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{yield this._handler.stopReceiving(e.map((e=>e.localId)))}catch(t){g.error("closePendingConsumers() | failed to close Consumers:",t)}}))),"transport.closePendingConsumers").then((()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()})).catch((()=>{}))}handleHandler(){const e=this._handler;e.on("@connect",(({dtlsParameters:e},t,i)=>{this._closed?i(new d.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,i)})),e.on("@connectionstatechange",(e=>{e!==this._connectionState&&(g.debug("connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))}))}handleProducer(e){e.on("@close",(()=>{this._producers.delete(e.id),this._closed||this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.stopSending(e.localId)}))),"producer @close event").catch((e=>g.warn("producer.close() failed:%o",e)))})),e.on("@pause",((t,i)=>{this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.pauseSending(e.localId)}))),"producer @pause event").then(t).catch(i)})),e.on("@resume",((t,i)=>{this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.resumeSending(e.localId)}))),"producer @resume event").then(t).catch(i)})),e.on("@replacetrack",((t,i,n)=>{this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.replaceTrack(e.localId,t)}))),"producer @replacetrack event").then(i).catch(n)})),e.on("@setmaxspatiallayer",((t,i,n)=>{this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.setMaxSpatialLayer(e.localId,t)}))),"producer @setmaxspatiallayer event").then(i).catch(n)})),e.on("@setrtpencodingparameters",((t,i,n)=>{this._awaitQueue.push((()=>b(this,null,(function*(){return this._handler.setRtpEncodingParameters(e.localId,t)}))),"producer @setrtpencodingparameters event").then(i).catch(n)})),e.on("@getstats",((t,i)=>{if(this._closed)return i(new d.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)}))}handleConsumer(e){e.on("@close",(()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),this._closed||(this._pendingCloseConsumers.set(e.id,e),!1===this._consumerCloseInProgress&&this.closePendingConsumers())})),e.on("@pause",(()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),(0,o.default)((()=>{this._closed||!1===this._consumerPauseInProgress&&this.pausePendingConsumers()}))})),e.on("@resume",(()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),(0,o.default)((()=>{this._closed||!1===this._consumerResumeInProgress&&this.resumePendingConsumers()}))})),e.on("@getstats",((t,i)=>{if(this._closed)return i(new d.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)}))}handleDataProducer(e){e.on("@close",(()=>{this._dataProducers.delete(e.id)}))}handleDataConsumer(e){e.on("@close",(()=>{this._dataConsumers.delete(e.id)}))}};e.Transport=v}}),Dt=y({"../../node_modules/mediasoup-client/lib/handlers/sdp/commonUtils.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.applyCodecParameters=e.getCname=e.extractDtlsParameters=e.extractRtpCapabilities=void 0;var r=n(P());function s({sdpObject:e}){const t=new Map,i=[];let n=!1,s=!1;for(const a of e.media){const e=a.type;switch(e){case"audio":if(n)continue;n=!0;break;case"video":if(s)continue;s=!0;break;default:continue}for(const i of a.rtp){const n={kind:e,mimeType:`${e}/${i.codec}`,preferredPayloadType:i.payload,clockRate:i.rate,channels:i.encoding,parameters:{},rtcpFeedback:[]};t.set(n.preferredPayloadType,n)}for(const i of a.fmtp||[]){const e=r.parseParams(i.config),n=t.get(i.payload);n&&(e&&e.hasOwnProperty("profile-level-id")&&(e["profile-level-id"]=String(e["profile-level-id"])),n.parameters=e)}for(const i of a.rtcpFb||[]){const n={type:i.type,parameter:i.subtype};if(n.parameter||delete n.parameter,"*"!==i.payload){const e=t.get(i.payload);if(!e)continue;e.rtcpFeedback.push(n)}else for(const i of t.values())i.kind!==e||/.+\/rtx$/i.test(i.mimeType)||i.rtcpFeedback.push(n)}for(const t of a.ext||[]){if(t["encrypt-uri"])continue;const n={kind:e,uri:t.uri,preferredId:t.value};i.push(n)}}const o={codecs:Array.from(t.values()),headerExtensions:i};return o}function o({sdpObject:e}){const t=(e.media||[]).find((e=>e.iceUfrag&&0!==e.port));if(!t)throw new Error("no active media section found");const i=t.fingerprint||e.fingerprint;let n;switch(t.setup){case"active":n="client";break;case"passive":n="server";break;case"actpass":n="auto";break}const r={role:n,fingerprints:[{algorithm:i.type,value:i.hash}]};return r}function a({offerMediaObject:e}){const t=(e.ssrcs||[]).find((e=>"cname"===e.attribute));return t?t.value:""}function c({offerRtpParameters:e,answerMediaObject:t}){for(const i of e.codecs){const e=i.mimeType.toLowerCase();if("audio/opus"!==e)continue;const n=(t.rtp||[]).find((e=>e.payload===i.payloadType));if(!n)continue;t.fmtp=t.fmtp||[];let s=t.fmtp.find((e=>e.payload===i.payloadType));s||(s={payload:i.payloadType,config:""},t.fmtp.push(s));const o=r.parseParams(s.config);switch(e){case"audio/opus":{const e=i.parameters["sprop-stereo"];void 0!==e&&(o.stereo=e?1:0);break}}s.config="";for(const t of Object.keys(o))s.config&&(s.config+=";"),s.config+=`${t}=${o[t]}`}}e.extractRtpCapabilities=s,e.extractDtlsParameters=o,e.getCname=a,e.applyCodecParameters=c}}),kt=y({"../../node_modules/mediasoup-client/lib/handlers/sdp/unifiedPlanUtils.js"(e){function t({offerMediaObject:e}){const t=new Set;for(const r of e.ssrcs||[]){const e=r.id;t.add(e)}if(0===t.size)throw new Error("no a=ssrc lines found");const i=new Map;for(const r of e.ssrcGroups||[]){if("FID"!==r.semantics)continue;let[e,n]=r.ssrcs.split(/\s+/);e=Number(e),n=Number(n),t.has(e)&&(t.delete(e),t.delete(n),i.set(e,n))}for(const r of t)i.set(r,null);const n=[];for(const[r,s]of i){const e={ssrc:r};s&&(e.rtx={ssrc:s}),n.push(e)}return n}function i({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const i=(e.ssrcs||[]).find((e=>"msid"===e.attribute));if(!i)throw new Error("a=ssrc line with msid information not found");const[n,r]=i.value.split(" "),s=i.id;let o;(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===s&&(o=Number(t[1]),!0)}));const a=e.ssrcs.find((e=>"cname"===e.attribute));if(!a)throw new Error("a=ssrc line with cname information not found");const c=a.value,d=[],l=[];for(let h=0;h<t;++h)d.push(s+h),o&&l.push(o+h);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let h=0;h<d.length;++h){const t=d[h];e.ssrcs.push({id:t,attribute:"cname",value:c}),e.ssrcs.push({id:t,attribute:"msid",value:`${n} ${r}`})}for(let h=0;h<l.length;++h){const t=d[h],i=l[h];e.ssrcs.push({id:i,attribute:"cname",value:c}),e.ssrcs.push({id:i,attribute:"msid",value:`${n} ${r}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`})}}w(),Object.defineProperty(e,"__esModule",{value:!0}),e.addLegacySimulcast=e.getRtpEncodings=void 0,e.getRtpEncodings=t,e.addLegacySimulcast=i}}),xt=y({"../../node_modules/mediasoup-client/lib/handlers/ortc/utils.js"(e){function t(e){var t;for(const i of e.codecs||[])"audio/opus"!==i.mimeType.toLowerCase()&&"audio/multiopus"!==i.mimeType.toLowerCase()||(null===(t=i.rtcpFeedback)||void 0===t?void 0:t.some((e=>"nack"===e.type&&!e.parameter)))||(i.rtcpFeedback||(i.rtcpFeedback=[]),i.rtcpFeedback.push({type:"nack"}))}w(),Object.defineProperty(e,"__esModule",{value:!0}),e.addNackSuppportForOpus=void 0,e.addNackSuppportForOpus=t}}),Lt=y({"../../node_modules/mediasoup-client/lib/handlers/HandlerInterface.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.HandlerInterface=void 0;var t=yt(),i=class extends t.EnhancedEventEmitter{constructor(){super()}};e.HandlerInterface=i}}),Mt=y({"../../node_modules/mediasoup-client/lib/handlers/sdp/MediaSection.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.OfferMediaSection=e.AnswerMediaSection=e.MediaSection=void 0;var r=n(P()),s=n(St()),o=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:n=!1}){if(this._mediaObject={},this._planB=n,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}i&&this.setDtlsRole(i.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return 0===this._mediaObject.port}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};e.MediaSection=o;var a=class extends o{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:r,planB:o=!1,offerMediaObject:a,offerRtpParameters:c,answerRtpParameters:l,codecOptions:h,extmapAllowMixed:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:o}),this._mediaObject.mid=String(a.mid),this._mediaObject.type=a.type,this._mediaObject.protocol=a.protocol,r?(this._mediaObject.connection={ip:r.ip,version:r.ipVersion},this._mediaObject.port=r.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),a.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i=s.clone(e.parameters,{});let n=s.clone(e.rtcpFeedback,[]);if(h){const{opusStereo:t,opusFec:r,opusDtx:s,opusMaxPlaybackRate:o,opusMaxAverageBitrate:a,opusPtime:d,opusNack:l,videoGoogleStartBitrate:u,videoGoogleMaxBitrate:p,videoGoogleMinBitrate:m}=h,f=c.codecs.find((t=>t.payloadType===e.payloadType));switch(e.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":void 0!==t&&(f.parameters["sprop-stereo"]=t?1:0,i.stereo=t?1:0),void 0!==r&&(f.parameters.useinbandfec=r?1:0,i.useinbandfec=r?1:0),void 0!==s&&(f.parameters.usedtx=s?1:0,i.usedtx=s?1:0),void 0!==o&&(i.maxplaybackrate=o),void 0!==a&&(i.maxaveragebitrate=a),void 0!==d&&(f.parameters.ptime=d,i.ptime=d),l||(f.rtcpFeedback=f.rtcpFeedback.filter((e=>"nack"!==e.type||e.parameter)),n=n.filter((e=>"nack"!==e.type||e.parameter)));break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==u&&(i["x-google-start-bitrate"]=u),void 0!==p&&(i["x-google-max-bitrate"]=p),void 0!==m&&(i["x-google-min-bitrate"]=m);break}}const r={payload:e.payloadType,config:""};for(const e of Object.keys(i))r.config&&(r.config+=";"),r.config+=`${e}=${i[e]}`;r.config&&this._mediaObject.fmtp.push(r);for(const s of n)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:s.type,subtype:s.parameter})}this._mediaObject.payloads=l.codecs.map((e=>e.payloadType)).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions){const t=(a.ext||[]).some((t=>t.uri===e.uri));t&&this._mediaObject.ext.push({uri:e.uri,value:e.id})}if(u&&"extmap-allow-mixed"===a.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),a.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:a.simulcast.list1},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(a.simulcast_03){this._mediaObject.simulcast_03={value:a.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"===typeof a.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize):a.sctpmap&&(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize});break}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";break}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(e){var t;if(!this._mediaObject.simulcast||!this._mediaObject.simulcast.list1)return;const i={};for(const r of e)r.rid&&(i[r.rid]=r);const n=this._mediaObject.simulcast.list1,s=r.parseSimulcastStreamList(n);for(const r of s)for(const e of r)e.paused=!(null===(t=i[e.scid])||void 0===t?void 0:t.active);this._mediaObject.simulcast.list1=s.map((e=>e.map((e=>`${e.paused?"~":""}${e.scid}`)).join(","))).join(";")}};e.AnswerMediaSection=a;var c=class extends o{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:r,planB:s=!1,mid:o,kind:a,offerRtpParameters:c,streamId:l,trackId:h,oldDataChannelSpec:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:s}),this._mediaObject.mid=String(o),this._mediaObject.type=a,r?(this._mediaObject.connection={ip:r.ip,version:r.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=r.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=n?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),a){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${h}`);for(const n of c.codecs){const e={payload:n.payloadType,codec:d(n),rate:n.clockRate};n.channels>1&&(e.encoding=n.channels),this._mediaObject.rtp.push(e);const t={payload:n.payloadType,config:""};for(const i of Object.keys(n.parameters))t.config&&(t.config+=";"),t.config+=`${i}=${n.parameters[i]}`;t.config&&this._mediaObject.fmtp.push(t);for(const i of n.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:n.payloadType,type:i.type,subtype:i.parameter})}this._mediaObject.payloads=c.codecs.map((e=>e.payloadType)).join(" "),this._mediaObject.ext=[];for(const n of c.headerExtensions)this._mediaObject.ext.push({uri:n.uri,value:n.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,i=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${h}`}),i&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${l||"-"} ${h}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`}));break}case"application":u?(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize);break}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){const n=e.encodings[0],r=n.ssrc,s=n.rtx&&n.rtx.ssrc?n.rtx.ssrc:void 0,o=this._mediaObject.payloads.split(" ");for(const a of e.codecs){if(o.includes(String(a.payloadType)))continue;const e={payload:a.payloadType,codec:d(a),rate:a.clockRate};a.channels>1&&(e.encoding=a.channels),this._mediaObject.rtp.push(e);const t={payload:a.payloadType,config:""};for(const i of Object.keys(a.parameters))t.config&&(t.config+=";"),t.config+=`${i}=${a.parameters[i]}`;t.config&&this._mediaObject.fmtp.push(t);for(const i of a.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:a.payloadType,type:i.type,subtype:i.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter((e=>!this._mediaObject.payloads.includes(e.payloadType))).map((e=>e.payloadType)).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:r,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:r,attribute:"msid",value:`${t||"-"} ${i}`}),s&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${r} ${s}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],i=t.ssrc,n=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter((e=>e.id!==i&&e.id!==n)),n&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter((e=>e.ssrcs!==`${i} ${n}`)))}};function d(e){const t=new RegExp("^(audio|video)/(.+)","i"),i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");return i[2]}e.OfferMediaSection=c}}),Ft=y({"../../node_modules/mediasoup-client/lib/handlers/sdp/RemoteSdp.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteSdp=void 0;var r=n(P()),s=_t(),o=Mt(),a=new s.Logger("RemoteSdp"),c=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:r,planB:s=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=n,this._plainRtpParameters=r,this._planB=s,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[e-1].algorithm,hash:i.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}r&&(this._sdpObject.origin.address=r.ip,this._sdpObject.origin.ipVer=r.ipVersion)}updateIceParameters(e){a.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){a.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r,extmapAllowMixed:s=!1}){const a=new o.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r,extmapAllowMixed:s});t?this._replaceMediaSection(a,t):this._midToIndex.has(a.mid)?this._replaceMediaSection(a):this._addMediaSection(a)}receive({mid:e,kind:t,offerRtpParameters:i,streamId:n,trackId:r}){const s=this._midToIndex.get(e);let a;if(void 0!==s&&(a=this._mediaSections[s]),a)a.planBReceive({offerRtpParameters:i,streamId:n,trackId:r}),this._replaceMediaSection(a);else{a=new o.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:n,trackId:r});const s=this._mediaSections.find((e=>e.closed));s?this._replaceMediaSection(a,s.mid):this._addMediaSection(a)}}pauseMediaSection(e){const t=this._findMediaSection(e);t.pause()}resumeSendingMediaSection(e){const t=this._findMediaSection(e);t.resume()}resumeReceivingMediaSection(e){const t=this._findMediaSection(e);t.resume()}disableMediaSection(e){const t=this._findMediaSection(e);t.disable()}closeMediaSection(e){const t=this._findMediaSection(e);return e===this._firstMid?(a.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e),!1):(t.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(e,t){const i=this._findMediaSection(e);i.muxSimulcastStreams(t),this._replaceMediaSection(i)}planBStopReceiving({mid:e,offerRtpParameters:t}){const i=this._findMediaSection(e);i.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(i)}sendSctpAssociation({offerMediaObject:e}){const t=new o.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new o.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,r.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if("string"===typeof t){const i=this._midToIndex.get(t);if(void 0===i)throw new Error(`no media section found for reuseMid '${t}'`);const n=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(n.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(e.mid);if(void 0===t)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject()}}_findMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter((e=>!e.closed)).map((e=>e.mid)).join(" "))}};e.RemoteSdp=c}}),Ut=y({"../../node_modules/mediasoup-client/lib/scalabilityModes.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0}),e.parse=void 0;var t=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function i(e){const i=t.exec(e||"");return i?{spatialLayers:Number(i[1]),temporalLayers:Number(i[2])}:{spatialLayers:1,temporalLayers:1}}e.parse=i}}),jt=y({"../../node_modules/mediasoup-client/lib/handlers/Chrome111.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome111=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(kt()),l=n(xt()),h=Lt(),u=Ft(),p=Ut(),m=new s.Logger("Chrome111"),f={OS:1024,MIS:1024},_=class extends h.HandlerInterface{static createFactory(){return()=>new _}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome111"}close(){if(m.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){m.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const i=yield e.createOffer();try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return l.addNackSuppportForOpus(s),s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return m.debug("getNativeSctpCapabilities()"),{numStreams:f}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){m.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):(m.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})))}updateIceServers(e){return b(this,null,(function*(){m.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(m.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});m.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();m.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;if(this.assertSendDirection(),m.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){t.forEach(((e,t)=>{e.rid=`r${t}`}));let e=1,i=1;for(const n of t){const e=n.scalabilityMode?(0,p.parse)(n.scalabilityMode).temporalLayers:3;e>i&&(i=e)}for(const n of t)n.rid="r"+e++,n.scalabilityMode=`L1T${i}`}const l=o.clone(this._sendingRtpParametersByKind[e.kind],{});l.codecs=a.reduceCodecs(l.codecs,n);const h=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});h.codecs=a.reduceCodecs(h.codecs,n);const u=this._remoteSdp.getNextMediaSectionIdx(),f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),g=yield this._pc.createOffer();let _=r.parse(g.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:_})),m.debug("send() | calling pc.setLocalDescription() [offer:%o]",g),yield this._pc.setLocalDescription(g);const v=f.mid;l.mid=v,_=r.parse(this._pc.localDescription.sdp);const y=_.media[u.idx];if(l.rtcp.cname=c.getCname({offerMediaObject:y}),t)if(1===t.length){const e=d.getRtpEncodings({offerMediaObject:y});Object.assign(e[0],t[0]),l.encodings=e}else l.encodings=t;else l.encodings=d.getRtpEncodings({offerMediaObject:y});this._remoteSdp.send({offerMediaObject:y,reuseMid:u.reuseMid,offerRtpParameters:l,answerRtpParameters:h,codecOptions:i,extmapAllowMixed:!0});const E={type:"answer",sdp:this._remoteSdp.getSdp()};return m.debug("send() | calling pc.setRemoteDescription() [answer:%o]",E),yield this._pc.setRemoteDescription(E),this._mapMidTransceiver.set(v,f),{localId:v,rtpParameters:l,rtpSender:f.sender}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender);const i=this._remoteSdp.closeMediaSection(t.mid);if(i)try{t.stop()}catch(s){}const n=yield this._pc.createOffer();m.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),yield this._pc.setLocalDescription(n);const r={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),yield this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=yield this._pc.createOffer();m.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}resumeSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=yield this._pc.createOffer();m.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?m.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):m.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};m.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%f.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),m.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:s}=r;m.debug("receive() [trackId:%s, kind:%s]",e,t);const o=i.mid||String(this._mapMidTransceiver.size);n.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:i,streamId:s||i.rtcp.cname,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const a=r.parse(o.sdp);for(const r of e){const{trackId:e,rtpParameters:t}=r,i=n.get(e),s=a.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:s})}o={type:"answer",sdp:r.write(a)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:a})),m.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{trackId:e}=r,t=n.get(e),s=this._pc.getTransceivers().find((e=>e.mid===t));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(t,s),i.push({localId:t,track:s.receiver.track,rtpReceiver:s.receiver})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("pauseReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}resumeReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("resumeReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};m.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Chrome111=_}}),Vt=y({"../../node_modules/mediasoup-client/lib/handlers/Chrome74.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome74=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(kt()),l=n(xt()),h=Lt(),u=Ft(),p=Ut(),m=new s.Logger("Chrome74"),f={OS:1024,MIS:1024},_=class extends h.HandlerInterface{static createFactory(){return()=>new _}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome74"}close(){if(m.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){m.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const i=yield e.createOffer();try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return l.addNackSuppportForOpus(s),s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return m.debug("getNativeSctpCapabilities()"),{numStreams:f}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){m.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):(m.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})))}updateIceServers(e){return b(this,null,(function*(){m.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(m.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});m.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();m.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),m.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach(((e,t)=>{e.rid=`r${t}`}));const l=o.clone(this._sendingRtpParametersByKind[e.kind],{});l.codecs=a.reduceCodecs(l.codecs,n);const h=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});h.codecs=a.reduceCodecs(h.codecs,n);const u=this._remoteSdp.getNextMediaSectionIdx(),f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let g,_=yield this._pc.createOffer(),v=r.parse(_.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:v}));let y=!1;const E=(0,p.parse)((t||[{}])[0].scalabilityMode);t&&1===t.length&&E.spatialLayers>1&&"video/vp9"===l.codecs[0].mimeType.toLowerCase()&&(m.debug("send() | enabling legacy simulcast for VP9 SVC"),y=!0,v=r.parse(_.sdp),g=v.media[u.idx],d.addLegacySimulcast({offerMediaObject:g,numStreams:E.spatialLayers}),_={type:"offer",sdp:r.write(v)}),m.debug("send() | calling pc.setLocalDescription() [offer:%o]",_),yield this._pc.setLocalDescription(_);const S=f.mid;if(l.mid=S,v=r.parse(this._pc.localDescription.sdp),g=v.media[u.idx],l.rtcp.cname=c.getCname({offerMediaObject:g}),t)if(1===t.length){let e=d.getRtpEncodings({offerMediaObject:g});Object.assign(e[0],t[0]),y&&(e=[e[0]]),l.encodings=e}else l.encodings=t;else l.encodings=d.getRtpEncodings({offerMediaObject:g});if(l.encodings.length>1&&("video/vp8"===l.codecs[0].mimeType.toLowerCase()||"video/h264"===l.codecs[0].mimeType.toLowerCase()))for(const r of l.encodings)r.scalabilityMode?r.scalabilityMode=`L1T${E.temporalLayers}`:r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:g,reuseMid:u.reuseMid,offerRtpParameters:l,answerRtpParameters:h,codecOptions:i,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return m.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),yield this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(S,f),{localId:S,rtpParameters:l,rtpSender:f.sender}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender);const i=this._remoteSdp.closeMediaSection(t.mid);if(i)try{t.stop()}catch(s){}const n=yield this._pc.createOffer();m.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),yield this._pc.setLocalDescription(n);const r={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),yield this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=yield this._pc.createOffer();m.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}resumeSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=yield this._pc.createOffer();m.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?m.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):m.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};m.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%f.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),m.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:s}=r;m.debug("receive() [trackId:%s, kind:%s]",e,t);const o=i.mid||String(this._mapMidTransceiver.size);n.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:i,streamId:s||i.rtcp.cname,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const a=r.parse(o.sdp);for(const r of e){const{trackId:e,rtpParameters:t}=r,i=n.get(e),s=a.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:s})}o={type:"answer",sdp:r.write(a)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:a})),m.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{trackId:e}=r,t=n.get(e),s=this._pc.getTransceivers().find((e=>e.mid===t));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(t,s),i.push({localId:t,track:s.receiver.track,rtpReceiver:s.receiver})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("pauseReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}resumeReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("resumeReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};m.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Chrome74=_}}),Bt=y({"../../node_modules/mediasoup-client/lib/handlers/Chrome70.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome70=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(kt()),l=Lt(),h=Ft(),u=Ut(),p=new s.Logger("Chrome70"),m={OS:1024,MIS:1024},f=class extends l.HandlerInterface{static createFactory(){return()=>new f}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome70"}close(){if(p.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){p.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const i=yield e.createOffer();try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return p.debug("getNativeSctpCapabilities()"),{numStreams:m}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){p.debug("run()"),this._direction=e,this._remoteSdp=new h.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(p.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){p.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(p.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});p.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();p.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),p.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const l=o.clone(this._sendingRtpParametersByKind[e.kind],{});l.codecs=a.reduceCodecs(l.codecs,n);const h=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});h.codecs=a.reduceCodecs(h.codecs,n);const m=this._remoteSdp.getNextMediaSectionIdx(),f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let g,_=yield this._pc.createOffer(),v=r.parse(_.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:v})),t&&t.length>1&&(p.debug("send() | enabling legacy simulcast"),v=r.parse(_.sdp),g=v.media[m.idx],d.addLegacySimulcast({offerMediaObject:g,numStreams:t.length}),_={type:"offer",sdp:r.write(v)});let y=!1;const E=(0,u.parse)((t||[{}])[0].scalabilityMode);if(t&&1===t.length&&E.spatialLayers>1&&"video/vp9"===l.codecs[0].mimeType.toLowerCase()&&(p.debug("send() | enabling legacy simulcast for VP9 SVC"),y=!0,v=r.parse(_.sdp),g=v.media[m.idx],d.addLegacySimulcast({offerMediaObject:g,numStreams:E.spatialLayers}),_={type:"offer",sdp:r.write(v)}),p.debug("send() | calling pc.setLocalDescription() [offer:%o]",_),yield this._pc.setLocalDescription(_),t){p.debug("send() | applying given encodings");const e=f.sender.getParameters();for(let i=0;i<(e.encodings||[]).length;++i){const n=e.encodings[i],r=t[i];if(!r)break;e.encodings[i]=Object.assign(n,r)}yield f.sender.setParameters(e)}const S=f.mid;if(l.mid=S,v=r.parse(this._pc.localDescription.sdp),g=v.media[m.idx],l.rtcp.cname=c.getCname({offerMediaObject:g}),l.encodings=d.getRtpEncodings({offerMediaObject:g}),t)for(let r=0;r<l.encodings.length;++r)t[r]&&Object.assign(l.encodings[r],t[r]);if(y&&(l.encodings=[l.encodings[0]]),l.encodings.length>1&&("video/vp8"===l.codecs[0].mimeType.toLowerCase()||"video/h264"===l.codecs[0].mimeType.toLowerCase()))for(const r of l.encodings)r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:g,reuseMid:m.reuseMid,offerRtpParameters:l,answerRtpParameters:h,codecOptions:i});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return p.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),yield this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(S,f),{localId:S,rtpParameters:l,rtpSender:f.sender}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),p.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender);const i=this._remoteSdp.closeMediaSection(t.mid);if(i)try{t.stop()}catch(s){}const n=yield this._pc.createOffer();p.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),yield this._pc.setLocalDescription(n);const r={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),yield this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?p.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):p.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),p.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();p.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),p.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();p.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s};p.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),p.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:s}=r;p.debug("receive() [trackId:%s, kind:%s]",e,t);const o=i.mid||String(this._mapMidTransceiver.size);n.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:i,streamId:s||i.rtcp.cname,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const a=r.parse(o.sdp);for(const r of e){const{trackId:e,rtpParameters:t}=r,i=n.get(e),s=a.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:s})}o={type:"answer",sdp:r.write(a)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:a})),p.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{trackId:e}=r,t=n.get(e),s=this._pc.getTransceivers().find((e=>e.mid===t));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(t,s),i.push({localId:t,track:s.receiver.track,rtpReceiver:s.receiver})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){p.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();p.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:c,protocol:i};p.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Chrome70=f}}),Ht=y({"../../node_modules/mediasoup-client/lib/handlers/sdp/planBUtils.js"(e){function t({offerMediaObject:e,track:t}){let i;const n=new Set;for(const o of e.ssrcs||[]){if("msid"!==o.attribute)continue;const e=o.value.split(" ")[1];if(e===t.id){const e=o.id;n.add(e),i||(i=e)}}if(0===n.size)throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);const r=new Map;for(const o of e.ssrcGroups||[]){if("FID"!==o.semantics)continue;let[e,t]=o.ssrcs.split(/\s+/);e=Number(e),t=Number(t),n.has(e)&&(n.delete(e),n.delete(t),r.set(e,t))}for(const o of n)r.set(o,null);const s=[];for(const[o,a]of r){const e={ssrc:o};a&&(e.rtx={ssrc:a}),s.push(e)}return s}function i({offerMediaObject:e,track:t,numStreams:i}){if(i<=1)throw new TypeError("numStreams must be greater than 1");let n,r,s;const o=(e.ssrcs||[]).find((e=>{if("msid"!==e.attribute)return!1;const i=e.value.split(" ")[1];return i===t.id&&(n=e.id,s=e.value.split(" ")[0],!0)}));if(!o)throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===n&&(r=Number(t[1]),!0)}));const a=e.ssrcs.find((e=>"cname"===e.attribute&&e.id===n));if(!a)throw new Error(`a=ssrc line with cname information not found [track.id:${t.id}]`);const c=a.value,d=[],l=[];for(let h=0;h<i;++h)d.push(n+h),r&&l.push(r+h);e.ssrcGroups=e.ssrcGroups||[],e.ssrcs=e.ssrcs||[],e.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let h=0;h<d.length;++h){const i=d[h];e.ssrcs.push({id:i,attribute:"cname",value:c}),e.ssrcs.push({id:i,attribute:"msid",value:`${s} ${t.id}`})}for(let h=0;h<l.length;++h){const i=d[h],n=l[h];e.ssrcs.push({id:n,attribute:"cname",value:c}),e.ssrcs.push({id:n,attribute:"msid",value:`${s} ${t.id}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${n}`})}}w(),Object.defineProperty(e,"__esModule",{value:!0}),e.addLegacySimulcast=e.getRtpEncodings=void 0,e.getRtpEncodings=t,e.addLegacySimulcast=i}}),Wt=y({"../../node_modules/mediasoup-client/lib/handlers/Chrome67.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome67=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(Ht()),l=Lt(),h=Ft(),u=new s.Logger("Chrome67"),p={OS:1024,MIS:1024},m=class extends l.HandlerInterface{static createFactory(){return()=>new m}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome67"}close(){if(u.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){u.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const i=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return u.debug("getNativeSctpCapabilities()"),{numStreams:p}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){u.debug("run()"),this._direction=e,this._remoteSdp=new h.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,planB:!0}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(u.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){u.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(u.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});u.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();u.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),u.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&u.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let l,h=yield this._pc.createOffer(),p=r.parse(h.sdp);const m=o.clone(this._sendingRtpParametersByKind[e.kind],{});m.codecs=a.reduceCodecs(m.codecs);const f=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(f.codecs=a.reduceCodecs(f.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:p})),"video"===e.kind&&t&&t.length>1&&(u.debug("send() | enabling simulcast"),p=r.parse(h.sdp),l=p.media.find((e=>"video"===e.type)),d.addLegacySimulcast({offerMediaObject:l,track:e,numStreams:t.length}),h={type:"offer",sdp:r.write(p)}),u.debug("send() | calling pc.setLocalDescription() [offer:%o]",h),yield this._pc.setLocalDescription(h),p=r.parse(this._pc.localDescription.sdp),l=p.media.find((t=>t.type===e.kind)),m.rtcp.cname=c.getCname({offerMediaObject:l}),m.encodings=d.getRtpEncodings({offerMediaObject:l,track:e}),t)for(let r=0;r<m.encodings.length;++r)t[r]&&Object.assign(m.encodings[r],t[r]);if(m.encodings.length>1&&"video/vp8"===m.codecs[0].mimeType.toLowerCase())for(const r of m.encodings)r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,offerRtpParameters:m,answerRtpParameters:f,codecOptions:i});const g={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),yield this._pc.setRemoteDescription(g);const _=String(this._nextSendLocalId);this._nextSendLocalId++;const v=this._pc.getSenders().find((t=>t.track===e));return this._mapSendLocalIdRtpSender.set(_,v),{localId:_,rtpParameters:m,rtpSender:v}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),u.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const i=yield this._pc.createOffer();u.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(r){if(0===this._sendStream.getTracks().length)return void u.warn("stopSending() | ignoring expected error due no sending tracks: %s",r.toString());throw r}if("stable"===this._pc.signalingState)return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?u.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):u.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.track;yield i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),u.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.setParameters(n)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),u.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.setParameters(n)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s};u.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%p.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),u.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[];for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:n}=r;u.debug("receive() [trackId:%s, kind:%s]",e,t);const s=t;this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:n||i.rtcp.cname,trackId:e})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();const o=r.parse(s.sdp);for(const r of e){const{kind:e,rtpParameters:t}=r,i=e,n=o.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:n})}s={type:"answer",sdp:r.write(o)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:o})),u.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s);for(const r of e){const{kind:e,trackId:t,rtpParameters:n}=r,s=t,o=e,a=this._pc.getReceivers().find((e=>e.track&&e.track.id===s));if(!a)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(s,{mid:o,rtpParameters:n,rtpReceiver:a}),i.push({localId:s,track:a.track,rtpReceiver:a})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){u.debug("stopReceiving() [localId:%s]",n);const{mid:e,rtpParameters:t}=this._mapRecvLocalIdInfo.get(n)||{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:e,offerRtpParameters:t})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();u.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:c,protocol:i};u.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Chrome67=m}}),Kt=y({"../../node_modules/mediasoup-client/lib/handlers/Chrome55.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Chrome55=void 0;var r=n(P()),s=_t(),o=Et(),a=n(St()),c=n(wt()),d=n(Dt()),l=n(Ht()),h=Lt(),u=Ft(),p=new s.Logger("Chrome55"),m={OS:1024,MIS:1024},f=class extends h.HandlerInterface{static createFactory(){return()=>new f}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome55"}close(){if(p.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){p.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const i=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(t){}const n=r.parse(i.sdp),s=d.extractRtpCapabilities({sdpObject:n});return s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return p.debug("getNativeSctpCapabilities()"),{numStreams:m}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:d,extendedRtpCapabilities:l}){p.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},a),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(p.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){p.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(p.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});p.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();p.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),p.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&p.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let o,h=yield this._pc.createOffer(),u=r.parse(h.sdp);const m=a.clone(this._sendingRtpParametersByKind[e.kind],{});m.codecs=c.reduceCodecs(m.codecs);const f=a.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(f.codecs=c.reduceCodecs(f.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:u})),"video"===e.kind&&t&&t.length>1&&(p.debug("send() | enabling simulcast"),u=r.parse(h.sdp),o=u.media.find((e=>"video"===e.type)),l.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),h={type:"offer",sdp:r.write(u)}),p.debug("send() | calling pc.setLocalDescription() [offer:%o]",h),yield this._pc.setLocalDescription(h),u=r.parse(this._pc.localDescription.sdp),o=u.media.find((t=>t.type===e.kind)),m.rtcp.cname=d.getCname({offerMediaObject:o}),m.encodings=l.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let r=0;r<m.encodings.length;++r)t[r]&&Object.assign(m.encodings[r],t[r]);if(m.encodings.length>1&&"video/vp8"===m.codecs[0].mimeType.toLowerCase())for(const r of m.encodings)r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:m,answerRtpParameters:f,codecOptions:i});const g={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),yield this._pc.setRemoteDescription(g);const _=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(_,e),{localId:_,rtpParameters:m}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),p.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const i=yield this._pc.createOffer();p.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(r){if(0===this._sendStream.getTracks().length)return void p.warn("stopSending() | ignoring expected error due no sending tracks: %s",r.toString());throw r}if("stable"===this._pc.signalingState)return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){throw new o.UnsupportedError(" not implemented")}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){throw new o.UnsupportedError("not supported")}))}getSenderStats(e){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s};p.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),p.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[];for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:n}=r;p.debug("receive() [trackId:%s, kind:%s]",e,t);const s=t;this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:n||i.rtcp.cname,trackId:e})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();const o=r.parse(s.sdp);for(const r of e){const{kind:e,rtpParameters:t}=r,i=e,n=o.media.find((e=>String(e.mid)===i));d.applyCodecParameters({offerRtpParameters:t,answerMediaObject:n})}s={type:"answer",sdp:r.write(o)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:o})),p.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s);for(const r of e){const{kind:e,trackId:t,rtpParameters:n}=r,s=e,o=t,a=r.streamId||n.rtcp.cname,c=this._pc.getRemoteStreams().find((e=>e.id===a)),d=c.getTrackById(o);if(!d)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(o,{mid:s,rtpParameters:n}),i.push({localId:o,track:d})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){p.debug("stopReceiving() [localId:%s]",n);const{mid:e,rtpParameters:t}=this._mapRecvLocalIdInfo.get(n)||{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:e,offerRtpParameters:t})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();p.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}getReceiverStats(e){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:c,protocol:i};p.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=d.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Chrome55=f}}),Gt=y({"../../node_modules/mediasoup-client/lib/handlers/Firefox60.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Firefox60=void 0;var r=n(P()),s=_t(),o=Et(),a=n(St()),c=n(wt()),d=n(Dt()),l=n(kt()),h=Lt(),u=Ft(),p=Ut(),m=new s.Logger("Firefox60"),f={OS:16,MIS:2048},_=class extends h.HandlerInterface{static createFactory(){return()=>new _}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Firefox60"}close(){if(m.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){m.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const i=t.captureStream(),n=i.getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const i=e.addTransceiver(n,{direction:"sendrecv"}),o=i.sender.getParameters(),a=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];o.encodings=a,yield i.sender.setParameters(o);const c=yield e.createOffer();try{t.remove()}catch(s){}try{n.stop()}catch(s){}try{e.close()}catch(s){}const l=r.parse(c.sdp),h=d.extractRtpCapabilities({sdpObject:l});return h}catch(s){try{t.remove()}catch(o){}try{n.stop()}catch(o){}try{e.close()}catch(o){}throw s}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return m.debug("getNativeSctpCapabilities()"),{numStreams:f}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:d,extendedRtpCapabilities:l}){m.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},a),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(m.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){throw new o.UnsupportedError("not supported")}))}restartIce(e){return b(this,null,(function*(){if(m.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});m.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();m.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),m.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=a.clone(t,[]),t.length>1&&(t.forEach(((e,t)=>{e.rid=`r${t}`})),t.reverse()));const s=a.clone(this._sendingRtpParametersByKind[e.kind],{});s.codecs=c.reduceCodecs(s.codecs,n);const o=a.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=c.reduceCodecs(o.codecs,n);const h=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const e=h.sender.getParameters();e.encodings=t,yield h.sender.setParameters(e)}const u=yield this._pc.createOffer();let f=r.parse(u.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:f}));const g=(0,p.parse)((t||[{}])[0].scalabilityMode);m.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),yield this._pc.setLocalDescription(u);const _=h.mid;s.mid=_,f=r.parse(this._pc.localDescription.sdp);const v=f.media[f.media.length-1];if(s.rtcp.cname=d.getCname({offerMediaObject:v}),t)if(1===t.length){const e=l.getRtpEncodings({offerMediaObject:v});Object.assign(e[0],t[0]),s.encodings=e}else s.encodings=t.reverse();else s.encodings=l.getRtpEncodings({offerMediaObject:v});if(s.encodings.length>1&&("video/vp8"===s.codecs[0].mimeType.toLowerCase()||"video/h264"===s.codecs[0].mimeType.toLowerCase()))for(const r of s.encodings)r.scalabilityMode?r.scalabilityMode=`L1T${g.temporalLayers}`:r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:v,offerRtpParameters:s,answerRtpParameters:o,codecOptions:i,extmapAllowMixed:!0});const y={type:"answer",sdp:this._remoteSdp.getSdp()};return m.debug("send() | calling pc.setRemoteDescription() [answer:%o]",y),yield this._pc.setRemoteDescription(y),this._mapMidTransceiver.set(_,h),{localId:_,rtpParameters:s,rtpSender:h.sender}}))}stopSending(e){return b(this,null,(function*(){m.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const i=yield this._pc.createOffer();m.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=yield this._pc.createOffer();m.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}resumeSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=yield this._pc.createOffer();m.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?m.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):m.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");const n=i.sender.getParameters();t=n.encodings.length-1-t,n.encodings.forEach(((e,i)=>{e.active=i>=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};m.debug("sendDataChannel() [options:%o]",o);const a=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%f.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:t})),m.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const c={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:a,sctpStreamParameters:c}}))}receive(e){return b(this,null,(function*(){this.assertRecvDirection();const t=[],i=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:n,streamId:s}=r;m.debug("receive() [trackId:%s, kind:%s]",e,t);const o=n.mid||String(this._mapMidTransceiver.size);i.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:n,streamId:s||n.rtcp.cname,trackId:e})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();const o=r.parse(s.sdp);for(const a of e){const{trackId:e,rtpParameters:t}=a,n=i.get(e),c=o.media.find((e=>String(e.mid)===n));d.applyCodecParameters({offerRtpParameters:t,answerMediaObject:c}),s={type:"answer",sdp:r.write(o)}}this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:o})),m.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s);for(const r of e){const{trackId:e}=r,n=i.get(e),s=this._pc.getTransceivers().find((e=>e.mid===n));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(n,s),t.push({localId:n,track:s.receiver.track,rtpReceiver:s.receiver})}return t}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("pauseReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}resumeReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("resumeReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:s,maxPacketLifeTime:o,maxRetransmits:a}=e,c={negotiated:!0,id:n,ordered:s,maxPacketLifeTime:o,maxRetransmits:a,protocol:i};m.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:"client",localSdpObject:e})}m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=d.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Firefox60=_}}),qt=y({"../../node_modules/mediasoup-client/lib/handlers/Safari12.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Safari12=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(kt()),l=n(xt()),h=Lt(),u=Ft(),p=Ut(),m=new s.Logger("Safari12"),f={OS:1024,MIS:1024},_=class extends h.HandlerInterface{static createFactory(){return()=>new _}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari12"}close(){if(m.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){m.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const i=yield e.createOffer();try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return l.addNackSuppportForOpus(s),s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return m.debug("getNativeSctpCapabilities()"),{numStreams:f}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){m.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(m.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){m.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(m.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});m.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();m.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),m.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const l=o.clone(this._sendingRtpParametersByKind[e.kind],{});l.codecs=a.reduceCodecs(l.codecs,n);const h=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});h.codecs=a.reduceCodecs(h.codecs,n);const u=this._remoteSdp.getNextMediaSectionIdx(),f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let g,_=yield this._pc.createOffer(),v=r.parse(_.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:v}));const y=(0,p.parse)((t||[{}])[0].scalabilityMode);t&&t.length>1&&(m.debug("send() | enabling legacy simulcast"),v=r.parse(_.sdp),g=v.media[u.idx],d.addLegacySimulcast({offerMediaObject:g,numStreams:t.length}),_={type:"offer",sdp:r.write(v)}),m.debug("send() | calling pc.setLocalDescription() [offer:%o]",_),yield this._pc.setLocalDescription(_);const E=f.mid;if(l.mid=E,v=r.parse(this._pc.localDescription.sdp),g=v.media[u.idx],l.rtcp.cname=c.getCname({offerMediaObject:g}),l.encodings=d.getRtpEncodings({offerMediaObject:g}),t)for(let r=0;r<l.encodings.length;++r)t[r]&&Object.assign(l.encodings[r],t[r]);if(l.encodings.length>1&&("video/vp8"===l.codecs[0].mimeType.toLowerCase()||"video/h264"===l.codecs[0].mimeType.toLowerCase()))for(const r of l.encodings)r.scalabilityMode?r.scalabilityMode=`L1T${y.temporalLayers}`:r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:g,reuseMid:u.reuseMid,offerRtpParameters:l,answerRtpParameters:h,codecOptions:i});const S={type:"answer",sdp:this._remoteSdp.getSdp()};return m.debug("send() | calling pc.setRemoteDescription() [answer:%o]",S),yield this._pc.setRemoteDescription(S),this._mapMidTransceiver.set(E,f),{localId:E,rtpParameters:l,rtpSender:f.sender}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender);const i=this._remoteSdp.closeMediaSection(t.mid);if(i)try{t.stop()}catch(s){}const n=yield this._pc.createOffer();m.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),yield this._pc.setLocalDescription(n);const r={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),yield this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=yield this._pc.createOffer();m.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}resumeSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=yield this._pc.createOffer();m.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?m.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):m.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};m.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%f.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),m.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:s}=r;m.debug("receive() [trackId:%s, kind:%s]",e,t);const o=i.mid||String(this._mapMidTransceiver.size);n.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:i,streamId:s||i.rtcp.cname,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const a=r.parse(o.sdp);for(const r of e){const{trackId:e,rtpParameters:t}=r,i=n.get(e),s=a.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:s})}o={type:"answer",sdp:r.write(a)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:a})),m.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{trackId:e}=r,t=n.get(e),s=this._pc.getTransceivers().find((e=>e.mid===t));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(t,s),i.push({localId:t,track:s.receiver.track,rtpReceiver:s.receiver})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("pauseReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}resumeReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("resumeReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};m.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Safari12=_}}),zt=y({"../../node_modules/mediasoup-client/lib/handlers/Safari11.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Safari11=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(Ht()),l=Lt(),h=Ft(),u=new s.Logger("Safari11"),p={OS:1024,MIS:1024},m=class extends l.HandlerInterface{static createFactory(){return()=>new m}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari11"}close(){if(u.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){u.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const i=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return u.debug("getNativeSctpCapabilities()"),{numStreams:p}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){u.debug("run()"),this._direction=e,this._remoteSdp=new h.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,planB:!0}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(u.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){u.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(u.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});u.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();u.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),u.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&u.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let l,h=yield this._pc.createOffer(),p=r.parse(h.sdp);const m=o.clone(this._sendingRtpParametersByKind[e.kind],{});m.codecs=a.reduceCodecs(m.codecs);const f=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(f.codecs=a.reduceCodecs(f.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:p})),"video"===e.kind&&t&&t.length>1&&(u.debug("send() | enabling simulcast"),p=r.parse(h.sdp),l=p.media.find((e=>"video"===e.type)),d.addLegacySimulcast({offerMediaObject:l,track:e,numStreams:t.length}),h={type:"offer",sdp:r.write(p)}),u.debug("send() | calling pc.setLocalDescription() [offer:%o]",h),yield this._pc.setLocalDescription(h),p=r.parse(this._pc.localDescription.sdp),l=p.media.find((t=>t.type===e.kind)),m.rtcp.cname=c.getCname({offerMediaObject:l}),m.encodings=d.getRtpEncodings({offerMediaObject:l,track:e}),t)for(let r=0;r<m.encodings.length;++r)t[r]&&Object.assign(m.encodings[r],t[r]);if(m.encodings.length>1&&"video/vp8"===m.codecs[0].mimeType.toLowerCase())for(const r of m.encodings)r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,offerRtpParameters:m,answerRtpParameters:f,codecOptions:i});const g={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),yield this._pc.setRemoteDescription(g);const _=String(this._nextSendLocalId);this._nextSendLocalId++;const v=this._pc.getSenders().find((t=>t.track===e));return this._mapSendLocalIdRtpSender.set(_,v),{localId:_,rtpParameters:m,rtpSender:v}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const i=yield this._pc.createOffer();u.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(r){if(0===this._sendStream.getTracks().length)return void u.warn("stopSending() | ignoring expected error due no sending tracks: %s",r.toString());throw r}if("stable"===this._pc.signalingState)return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?u.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):u.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.track;yield i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),u.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.setParameters(n)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),u.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.setParameters(n)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};u.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%p.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),u.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[];for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:n}=r;u.debug("receive() [trackId:%s, kind:%s]",e,t);const s=t;this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:n||i.rtcp.cname,trackId:e})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();const o=r.parse(s.sdp);for(const r of e){const{kind:e,rtpParameters:t}=r,i=e,n=o.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:n})}s={type:"answer",sdp:r.write(o)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:o})),u.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s);for(const r of e){const{kind:e,trackId:t,rtpParameters:n}=r,s=e,o=t,a=this._pc.getReceivers().find((e=>e.track&&e.track.id===o));if(!a)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(o,{mid:s,rtpParameters:n,rtpReceiver:a}),i.push({localId:o,track:a.track,rtpReceiver:a})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){u.debug("stopReceiving() [localId:%s]",n);const{mid:e,rtpParameters:t}=this._mapRecvLocalIdInfo.get(n)||{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:e,offerRtpParameters:t})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();u.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};u.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.Safari11=m}}),Jt=y({"../../node_modules/mediasoup-client/lib/handlers/ortc/edgeUtils.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.mangleRtpParameters=e.getCapabilities=void 0;var r=n(St());function s(){const e=RTCRtpReceiver.getCapabilities(),t=r.clone(e,{});for(const i of t.codecs){if(i.channels=i.numChannels,delete i.numChannels,i.mimeType=i.mimeType||`${i.kind}/${i.name}`,i.parameters){const e=i.parameters;e.apt&&(e.apt=Number(e.apt)),e["packetization-mode"]&&(e["packetization-mode"]=Number(e["packetization-mode"]))}for(const e of i.rtcpFeedback||[])e.parameter||(e.parameter="")}return t}function o(e){const t=r.clone(e,{});t.mid&&(t.muxId=t.mid,delete t.mid);for(const i of t.codecs)i.channels&&(i.numChannels=i.channels,delete i.channels),i.mimeType&&!i.name&&(i.name=i.mimeType.split("/")[1]),delete i.mimeType;return t}e.getCapabilities=s,e.mangleRtpParameters=o}}),Yt=y({"../../node_modules/mediasoup-client/lib/handlers/Edge11.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.Edge11=void 0;var r=_t(),s=Et(),o=n(St()),a=n(wt()),c=n(Jt()),d=Lt(),l=new r.Logger("Edge11"),h=class extends d.HandlerInterface{static createFactory(){return()=>new h}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return"Edge11"}close(){l.debug("close()");try{this._iceGatherer.close()}catch(e){}try{this._iceTransport.stop()}catch(e){}try{this._dtlsTransport.stop()}catch(e){}for(const t of this._rtpSenders.values())try{t.stop()}catch(e){}for(const t of this._rtpReceivers.values())try{t.stop()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){return l.debug("getNativeRtpCapabilities()"),c.getCapabilities()}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return l.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:c,additionalSettings:d,proprietaryConstraints:h,extendedRtpCapabilities:u}){l.debug("run()"),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",u),video:a.getSendingRtpParameters("video",u)},this._remoteIceParameters=t,this._remoteIceCandidates=i,this._remoteDtlsParameters=n,this._cname=`CNAME-${o.generateRandomNumber()}`,this.setIceGatherer({iceServers:s,iceTransportPolicy:c}),this.setIceTransport(),this.setDtlsTransport()}updateIceServers(e){return b(this,null,(function*(){throw new s.UnsupportedError("not supported")}))}restartIce(e){return b(this,null,(function*(){if(l.debug("restartIce()"),this._remoteIceParameters=e,this._transportReady){l.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const e of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(e);this._iceTransport.addRemoteCandidate({})}}))}getTransportStats(){return b(this,null,(function*(){return this._iceTransport.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){l.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||(yield this.setupTransport({localDtlsRole:"server"})),l.debug("send() | calling new RTCRtpSender()");const r=new RTCRtpSender(e,this._dtlsTransport),s=o.clone(this._sendingRtpParametersByKind[e.kind],{});s.codecs=a.reduceCodecs(s.codecs,n);const d=s.codecs.some((e=>/.+\/rtx$/i.test(e.mimeType)));t||(t=[{}]);for(const a of t)a.ssrc=o.generateRandomNumber(),d&&(a.rtx={ssrc:o.generateRandomNumber()});s.encodings=t,s.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const h=c.mangleRtpParameters(s);l.debug("send() | calling rtpSender.send() [params:%o]",h),yield r.send(h);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(u,r),{localId:u,rtpParameters:s,rtpSender:r}}))}stopSending(e){return b(this,null,(function*(){l.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{l.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(i){throw l.warn("stopSending() | rtpSender.stop() failed:%o",i),i}}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){t?l.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):l.debug("replaceTrack() [localId:%s, no track]",e);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");i.setTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){l.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.setParameters(n)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){l.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.setParameters(n)}))}getSenderStats(e){return b(this,null,(function*(){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}))}sendDataChannel(e){return b(this,null,(function*(){throw new s.UnsupportedError("not implemented")}))}receive(e){return b(this,null,(function*(){const t=[];for(const i of e){const{trackId:e,kind:t}=i;l.debug("receive() [trackId:%s, kind:%s]",e,t)}this._transportReady||(yield this.setupTransport({localDtlsRole:"server"}));for(const i of e){const{trackId:e,kind:n,rtpParameters:r}=i;l.debug("receive() | calling new RTCRtpReceiver()");const s=new RTCRtpReceiver(this._dtlsTransport,n);s.addEventListener("error",(e=>{l.error('rtpReceiver "error" event [event:%o]',e)}));const o=c.mangleRtpParameters(r);l.debug("receive() | calling rtpReceiver.receive() [params:%o]",o),yield s.receive(o);const a=e;this._rtpReceivers.set(a,s),t.push({localId:a,track:s.track,rtpReceiver:s})}return t}))}stopReceiving(e){return b(this,null,(function*(){for(const i of e){l.debug("stopReceiving() [localId:%s]",i);const e=this._rtpReceivers.get(i);if(!e)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(i);try{l.debug("stopReceiving() | calling rtpReceiver.stop()"),e.stop()}catch(t){l.warn("stopReceiving() | rtpReceiver.stop() failed:%o",t)}}}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}getReceiverStats(e){return b(this,null,(function*(){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}))}receiveDataChannel(e){return b(this,null,(function*(){throw new s.UnsupportedError("not implemented")}))}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const i=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});i.addEventListener("error",(e=>{l.error('iceGatherer "error" event [event:%o]',e)}));try{i.gather()}catch(n){l.debug("setIceGatherer() | iceGatherer.gather() failed: %s",n.toString())}this._iceGatherer=i}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",(()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})),e.addEventListener("icestatechange",(()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})),e.addEventListener("candidatepairchange",(e=>{l.debug('iceTransport "candidatepairchange" event [pair:%o]',e.pair)})),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",(()=>{l.debug('dtlsTransport "statechange" event [state:%s]',e.state)})),e.addEventListener("dtlsstatechange",(()=>{l.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),"closed"===e.state&&this.emit("@connectionstatechange","closed")})),e.addEventListener("error",(e=>{l.error('dtlsTransport "error" event [event:%o]',e)})),this._dtlsTransport=e}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e}){l.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,yield new Promise(((e,i)=>{this.safeEmit("@connect",{dtlsParameters:t},e,i)})),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const i of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(i);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter((e=>"sha-256"===e.algorithm||"sha-384"===e.algorithm||"sha-512"===e.algorithm)),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}))}};e.Edge11=h}}),Xt=y({"../../node_modules/mediasoup-client/lib/handlers/ReactNativeUnifiedPlan.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.ReactNativeUnifiedPlan=void 0;var r=n(P()),s=_t(),o=n(St()),a=n(wt()),c=n(Dt()),d=n(kt()),l=n(xt()),h=Lt(),u=Ft(),p=Ut(),m=new s.Logger("ReactNativeUnifiedPlan"),f={OS:1024,MIS:1024},_=class extends h.HandlerInterface{static createFactory(){return()=>new _}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNativeUnifiedPlan"}close(){if(m.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){m.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const i=yield e.createOffer();try{e.close()}catch(t){}const n=r.parse(i.sdp),s=c.extractRtpCapabilities({sdpObject:n});return l.addNackSuppportForOpus(s),s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return m.debug("getNativeSctpCapabilities()"),{numStreams:f}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){m.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r}),this._sendingRtpParametersByKind={audio:a.getSendingRtpParameters("audio",l),video:a.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:a.getSendingRemoteRtpParameters("audio",l),video:a.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},c),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(m.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){m.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(m.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});m.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();m.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),m.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach(((e,t)=>{e.rid=`r${t}`}));const l=o.clone(this._sendingRtpParametersByKind[e.kind],{});l.codecs=a.reduceCodecs(l.codecs,n);const h=o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});h.codecs=a.reduceCodecs(h.codecs,n);const u=this._remoteSdp.getNextMediaSectionIdx(),f=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let g,_=yield this._pc.createOffer(),v=r.parse(_.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:v}));let y=!1;const E=(0,p.parse)((t||[{}])[0].scalabilityMode);t&&1===t.length&&E.spatialLayers>1&&"video/vp9"===l.codecs[0].mimeType.toLowerCase()&&(m.debug("send() | enabling legacy simulcast for VP9 SVC"),y=!0,v=r.parse(_.sdp),g=v.media[u.idx],d.addLegacySimulcast({offerMediaObject:g,numStreams:E.spatialLayers}),_={type:"offer",sdp:r.write(v)}),m.debug("send() | calling pc.setLocalDescription() [offer:%o]",_),yield this._pc.setLocalDescription(_);const S=f.mid;if(l.mid=S,v=r.parse(this._pc.localDescription.sdp),g=v.media[u.idx],l.rtcp.cname=c.getCname({offerMediaObject:g}),t)if(1===t.length){let e=d.getRtpEncodings({offerMediaObject:g});Object.assign(e[0],t[0]),y&&(e=[e[0]]),l.encodings=e}else l.encodings=t;else l.encodings=d.getRtpEncodings({offerMediaObject:g});if(l.encodings.length>1&&("video/vp8"===l.codecs[0].mimeType.toLowerCase()||"video/h264"===l.codecs[0].mimeType.toLowerCase()))for(const r of l.encodings)r.scalabilityMode?r.scalabilityMode=`L1T${E.temporalLayers}`:r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:g,reuseMid:u.reuseMid,offerRtpParameters:l,answerRtpParameters:h,codecOptions:i,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return m.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),yield this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(S,f),{localId:S,rtpParameters:l,rtpSender:f.sender}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender);const i=this._remoteSdp.closeMediaSection(t.mid);if(i)try{t.stop()}catch(s){}const n=yield this._pc.createOffer();m.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),yield this._pc.setLocalDescription(n);const r={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),yield this._pc.setRemoteDescription(r),this._mapMidTransceiver.delete(e)}))}pauseSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=yield this._pc.createOffer();m.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}resumeSending(e){return b(this,null,(function*(){this.assertSendDirection(),m.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=yield this._pc.createOffer();m.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}replaceTrack(e,t){return b(this,null,(function*(){this.assertSendDirection(),t?m.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):m.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{e.active=i<=t})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){this.assertSendDirection(),m.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach(((e,i)=>{n.encodings[i]=g(g({},e),t)})),yield i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const r=yield this._pc.createOffer();m.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",r),yield this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",s),yield this._pc.setRemoteDescription(s)}))}getSenderStats(e){return b(this,null,(function*(){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s};m.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%f.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),m.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};m.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i,streamId:s}=r;m.debug("receive() [trackId:%s, kind:%s]",e,t);const o=i.mid||String(this._mapMidTransceiver.size);n.set(e,o),this._remoteSdp.receive({mid:o,kind:t,offerRtpParameters:i,streamId:s||i.rtcp.cname,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const a=r.parse(o.sdp);for(const r of e){const{trackId:e,rtpParameters:t}=r,i=n.get(e),s=a.media.find((e=>String(e.mid)===i));c.applyCodecParameters({offerRtpParameters:t,answerMediaObject:s})}o={type:"answer",sdp:r.write(a)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:a})),m.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{trackId:e}=r,t=n.get(e),s=this._pc.getTransceivers().find((e=>e.mid===t));if(!s)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(t,s),i.push({localId:t,track:s.receiver.track,rtpReceiver:s.receiver})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("stopReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(e.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}))}pauseReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("pauseReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}resumeReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){m.debug("resumeReceiving() [localId:%s]",n);const e=this._mapMidTransceiver.get(n);if(!e)throw new Error("associated RTCRtpTransceiver not found");e.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();m.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}getReceiverStats(e){return b(this,null,(function*(){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};m.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}m.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=c.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.ReactNativeUnifiedPlan=_}}),$t=y({"../../node_modules/mediasoup-client/lib/handlers/ReactNative.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.ReactNative=void 0;var r=n(P()),s=_t(),o=Et(),a=n(St()),c=n(wt()),d=n(Dt()),l=n(Ht()),h=Lt(),u=Ft(),p=new s.Logger("ReactNative"),m={OS:1024,MIS:1024},f=class extends h.HandlerInterface{static createFactory(){return()=>new f}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNative"}close(){if(p.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}getNativeRtpCapabilities(){return b(this,null,(function*(){p.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const i=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(t){}const n=r.parse(i.sdp),s=d.extractRtpCapabilities({sdpObject:n});return s}catch(t){try{e.close()}catch(i){}throw t}}))}getNativeSctpCapabilities(){return b(this,null,(function*(){return p.debug("getNativeSctpCapabilities()"),{numStreams:m}}))}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:d,extendedRtpCapabilities:l}){p.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},n.role&&"auto"!==n.role&&(this._forcedLocalDtlsRole="server"===n.role?"client":"server"),this._pc=new RTCPeerConnection(g({iceServers:s||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},a),d),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(p.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}updateIceServers(e){return b(this,null,(function*(){p.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}))}restartIce(e){return b(this,null,(function*(){if(p.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=yield this._pc.createOffer({iceRestart:!0});p.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();p.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t)}}))}getTransportStats(){return b(this,null,(function*(){return this._pc.getStats()}))}send(e){return b(this,arguments,(function*({track:e,encodings:t,codecOptions:i,codec:n}){var s;this.assertSendDirection(),p.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&p.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let o,h=yield this._pc.createOffer(),u=r.parse(h.sdp);const m=a.clone(this._sendingRtpParametersByKind[e.kind],{});m.codecs=c.reduceCodecs(m.codecs);const f=a.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(f.codecs=c.reduceCodecs(f.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(s=this._forcedLocalDtlsRole)&&void 0!==s?s:"client",localSdpObject:u})),"video"===e.kind&&t&&t.length>1&&(p.debug("send() | enabling simulcast"),u=r.parse(h.sdp),o=u.media.find((e=>"video"===e.type)),l.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),h={type:"offer",sdp:r.write(u)}),p.debug("send() | calling pc.setLocalDescription() [offer:%o]",h),yield this._pc.setLocalDescription(h),u=r.parse(this._pc.localDescription.sdp),o=u.media.find((t=>t.type===e.kind)),m.rtcp.cname=d.getCname({offerMediaObject:o}),m.encodings=l.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let r=0;r<m.encodings.length;++r)t[r]&&Object.assign(m.encodings[r],t[r]);if(m.encodings.length>1&&("video/vp8"===m.codecs[0].mimeType.toLowerCase()||"video/h264"===m.codecs[0].mimeType.toLowerCase()))for(const r of m.encodings)r.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:m,answerRtpParameters:f,codecOptions:i});const g={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),yield this._pc.setRemoteDescription(g);const _=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(_,e),{localId:_,rtpParameters:m}}))}stopSending(e){return b(this,null,(function*(){this.assertSendDirection(),p.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const i=yield this._pc.createOffer();p.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(r){if(0===this._sendStream.getTracks().length)return void p.warn("stopSending() | ignoring expected error due no sending tracks: %s",r.toString());throw r}if("stable"===this._pc.signalingState)return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)}))}pauseSending(e){return b(this,null,(function*(){}))}resumeSending(e){return b(this,null,(function*(){}))}replaceTrack(e,t){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}setMaxSpatialLayer(e,t){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}setRtpEncodingParameters(e,t){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}getSenderStats(e){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}sendDataChannel(e){return b(this,arguments,(function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s}){var o;this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s};p.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=yield this._pc.createOffer(),t=r.parse(e.sdp),i=t.media.find((e=>"application"===e.type));this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(o=this._forcedLocalDtlsRole)&&void 0!==o?o:"client",localSdpObject:t})),p.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),yield this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:i});const n={type:"answer",sdp:this._remoteSdp.getSdp()};p.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n),this._hasDataChannelMediaSection=!0}const d={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:d}}))}receive(e){return b(this,null,(function*(){var t;this.assertRecvDirection();const i=[],n=new Map;for(const r of e){const{trackId:e,kind:t,rtpParameters:i}=r;p.debug("receive() [trackId:%s, kind:%s]",e,t);const s=t;let o=r.streamId||i.rtcp.cname;p.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),o+=`-hack-${a.generateRandomNumber()}`,n.set(e,o),this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:o,trackId:e})}const s={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),yield this._pc.setRemoteDescription(s);let o=yield this._pc.createAnswer();const c=r.parse(o.sdp);for(const r of e){const{kind:e,rtpParameters:t}=r,i=e,n=c.media.find((e=>String(e.mid)===i));d.applyCodecParameters({offerRtpParameters:t,answerMediaObject:n})}o={type:"answer",sdp:r.write(c)},this._transportReady||(yield this.setupTransport({localDtlsRole:null!==(t=this._forcedLocalDtlsRole)&&void 0!==t?t:"client",localSdpObject:c})),p.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);for(const r of e){const{kind:e,trackId:t,rtpParameters:s}=r,o=t,a=e,c=n.get(t),d=this._pc.getRemoteStreams().find((e=>e.id===c)),l=d.getTrackById(o);if(!l)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(o,{mid:a,rtpParameters:s}),i.push({localId:o,track:l})}return i}))}stopReceiving(e){return b(this,null,(function*(){this.assertRecvDirection();for(const n of e){p.debug("stopReceiving() [localId:%s]",n);const{mid:e,rtpParameters:t}=this._mapRecvLocalIdInfo.get(n)||{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:e,offerRtpParameters:t})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);const i=yield this._pc.createAnswer();p.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}))}pauseReceiving(e){return b(this,null,(function*(){}))}resumeReceiving(e){return b(this,null,(function*(){}))}getReceiverStats(e){return b(this,null,(function*(){throw new o.UnsupportedError("not implemented")}))}receiveDataChannel(e){return b(this,arguments,(function*({sctpStreamParameters:e,label:t,protocol:i}){var n;this.assertRecvDirection();const{streamId:s,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,d={negotiated:!0,id:s,ordered:o,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:c,protocol:i};p.debug("receiveDataChannel() [options:%o]",d);const l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),yield this._pc.setRemoteDescription(e);const t=yield this._pc.createAnswer();if(!this._transportReady){const e=r.parse(t.sdp);yield this.setupTransport({localDtlsRole:null!==(n=this._forcedLocalDtlsRole)&&void 0!==n?n:"client",localSdpObject:e})}p.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),yield this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}))}setupTransport(e){return b(this,arguments,(function*({localDtlsRole:e,localSdpObject:t}){t||(t=r.parse(this._pc.localDescription.sdp));const i=d.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),yield new Promise(((e,t)=>{this.safeEmit("@connect",{dtlsParameters:i},e,t)})),this._transportReady=!0}))}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}};e.ReactNative=f}}),Qt=y({"../../node_modules/mediasoup-client/lib/Device.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n},r=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.Device=e.detectDevice=void 0;var s=r(C()),o=_t(),a=yt(),c=Et(),d=n(St()),l=n(wt()),h=Nt(),u=jt(),p=Vt(),m=Bt(),f=Wt(),g=Kt(),_=Gt(),v=qt(),y=zt(),E=Yt(),S=Xt(),T=$t(),R=new o.Logger("Device");function I(){if("object"===typeof navigator&&"ReactNative"===navigator.product)return"undefined"===typeof RTCPeerConnection?void R.warn("this._detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?"):"undefined"!==typeof RTCRtpTransceiver?(R.debug("this._detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(R.debug("this._detectDevice() | ReactNative PlanB handler chosen"),"ReactNative");if("object"!==typeof navigator||"string"!==typeof navigator.userAgent)R.warn("this._detectDevice() | unknown device");else{const e=navigator.userAgent,t=s.default.getParser(e),i=t.getEngine();if(t.satisfies({chrome:">=111",chromium:">=111","microsoft edge":">=111"}))return"Chrome111";if(t.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(t.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(t.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(t.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}}))return"Safari12";if(t.satisfies({safari:">=12.0"})&&"undefined"!==typeof RTCRtpTransceiver&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"}))return"Safari11";if(t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(i.name&&"blink"===i.name.toLowerCase()){const t=e.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(t){const e=Number(t[1]);return e>=111?"Chrome111":e>=74?"Chrome74":e>=70?"Chrome70":e>=67?"Chrome67":"Chrome55"}return"Chrome111"}R.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",t.getBrowserName(),t.getBrowserVersion())}}e.detectDevice=I;var A=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new a.EnhancedEventEmitter,R.debug("constructor()"),i){if(R.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!==typeof i)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=i}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)R.debug("constructor() | handler given: %s",e);else{if(e=I(),!e)throw new c.UnsupportedError("device not supported");R.debug("constructor() | detected handler: %s",e)}switch(e){case"Chrome111":this._handlerFactory=u.Chrome111.createFactory();break;case"Chrome74":this._handlerFactory=p.Chrome74.createFactory();break;case"Chrome70":this._handlerFactory=m.Chrome70.createFactory();break;case"Chrome67":this._handlerFactory=f.Chrome67.createFactory();break;case"Chrome55":this._handlerFactory=g.Chrome55.createFactory();break;case"Firefox60":this._handlerFactory=_.Firefox60.createFactory();break;case"Safari12":this._handlerFactory=v.Safari12.createFactory();break;case"Safari11":this._handlerFactory=y.Safari11.createFactory();break;case"Edge11":this._handlerFactory=E.Edge11.createFactory();break;case"ReactNativeUnifiedPlan":this._handlerFactory=S.ReactNativeUnifiedPlan.createFactory();break;case"ReactNative":this._handlerFactory=T.ReactNative.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}const n=this._handlerFactory();this._handlerName=n.name,n.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}load(e){return b(this,arguments,(function*({routerRtpCapabilities:e}){let t;R.debug("load() [routerRtpCapabilities:%o]",e),e=d.clone(e,void 0);try{if(this._loaded)throw new c.InvalidStateError("already loaded");l.validateRtpCapabilities(e),t=this._handlerFactory();const i=yield t.getNativeRtpCapabilities();R.debug("load() | got native RTP capabilities:%o",i),l.validateRtpCapabilities(i),this._extendedRtpCapabilities=l.getExtendedRtpCapabilities(i,e),R.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=l.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=l.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=l.getRecvRtpCapabilities(this._extendedRtpCapabilities),l.validateRtpCapabilities(this._recvRtpCapabilities),R.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=yield t.getNativeSctpCapabilities(),R.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),l.validateSctpCapabilities(this._sctpCapabilities),R.debug("load() succeeded"),this._loaded=!0,t.close()}catch(i){throw t&&t.close(),i}}))}canProduce(e){if(!this._loaded)throw new c.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:c,appData:d}){return R.debug("createSendTransport()"),this.createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:c,appData:d})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:c,appData:d}){return R.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:r,iceServers:s,iceTransportPolicy:o,additionalSettings:a,proprietaryConstraints:c,appData:d})}createTransport({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:a,additionalSettings:d,proprietaryConstraints:l,appData:u}){if(!this._loaded)throw new c.InvalidStateError("not loaded");if("string"!==typeof t)throw new TypeError("missing id");if("object"!==typeof i)throw new TypeError("missing iceParameters");if(!Array.isArray(n))throw new TypeError("missing iceCandidates");if("object"!==typeof r)throw new TypeError("missing dtlsParameters");if(s&&"object"!==typeof s)throw new TypeError("wrong sctpParameters");if(u&&"object"!==typeof u)throw new TypeError("if given, appData must be an object");const p=new h.Transport({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:r,sctpParameters:s,iceServers:o,iceTransportPolicy:a,additionalSettings:d,proprietaryConstraints:l,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",p),p}};e.Device=A}}),Zt=y({"../../node_modules/mediasoup-client/lib/RtpParameters.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0})}}),ei=y({"../../node_modules/mediasoup-client/lib/SctpParameters.js"(e){w(),Object.defineProperty(e,"__esModule",{value:!0})}}),ti=y({"../../node_modules/mediasoup-client/lib/types.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__exportStar||function(e,i){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(i,n)||t(i,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),i(Qt(),e),i(Nt(),e),i(It(),e),i(At(),e),i(Pt(),e),i(Ot(),e),i(Zt(),e),i(ei(),e),i(Lt(),e),i(Et(),e)}}),ii=y({"../../node_modules/mediasoup-client/lib/index.js"(e){w();var t=e&&e.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e["default"]=t}),n=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&t(n,e,r);return i(n,e),n},r=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.debug=e.parseScalabilityMode=e.detectDevice=e.Device=e.version=e.types=void 0;var s=r(gt());e.debug=s.default;var o=Qt();Object.defineProperty(e,"Device",{enumerable:!0,get:function(){return o.Device}}),Object.defineProperty(e,"detectDevice",{enumerable:!0,get:function(){return o.detectDevice}});var a=n(ti());e.types=a,e.version="3.6.82";var c=Ut();Object.defineProperty(e,"parseScalabilityMode",{enumerable:!0,get:function(){return c.parse}})}});w(),w(),w(),w(),w(),w(),w();var ni=["disable","error","warn","info","debug"],ri=class{constructor(e){this.prefix=e,this.debug=(...e)=>(this._log("debug",...e),Date.now()),this.info=(...e)=>(this._log("info",...e),Date.now()),this.warn=(...e)=>{this._log("warn",...e)},this.error=(...e)=>{this._log("error",...e)},this.elapsed=(e,...t)=>{const i=Date.now()-e;this._log("info",`elapsed ms:${i}`,...t)}}_log(e,...t){const i=ni.indexOf(e),n=ni.indexOf(ri.level);if(n>=i){const i=new Date(Date.now()+324e5).toISOString()+"+JST",n=[this.prefix,...t].map((e=>{if(e instanceof Error)return e.toJSON?e.toJSON():{name:e.name,message:e.message,stack:e.stack};if("object"===typeof e)try{return JSON.parse(JSON.stringify(e))}catch(t){return"json error"}return e}));t=n;let r=[i,e,...t];switch("string"===ri.format&&(r=[i+" "+e+" "+JSON.stringify(t)]),e){case"debug":console.log(...r);break;case"info":console.info(...r);break;case"warn":console.warn(...r);break;case"error":console.error(...r);break}ri.onLog({id:ri.id,timestamp:i,level:e,message:t})}}createBlock(e){return{warn:(...t)=>{this.warn(g({},e),...t)},debug:(...t)=>{this.debug(g({},e),...t)},info:(...t)=>{this.info(g({},e),...t)},error:(...t)=>{this.error(g({},e),...t)}}}},si=ri;si.level="error",si.format="object",si.id=Math.random().toString().slice(2,7),si.onLog=()=>{};var oi=new si("packages/common/src/error.ts"),ai=class extends Error{constructor(e,t=!0){if(super(e.info.detail),this.id=Math.random().toString().slice(2,10),Object.assign(this,e),this.name=this.info.name,t){const e=["SkyWayError",`name:${this.info.name}, detail:${this.info.detail}, solution:${this.info.solution}`];this.path&&e.push(this.path),this.error&&e.push(this.error),this.payload&&e.push(this.payload),e.push(this.id),oi.warn(...e)}}toJSON(){return{id:this.id,info:this.info,path:this.path,payload:this.payload,error:this.error,stack:this.stack}}};w();var ci=new si("packages/common/src/event.ts"),di=class{constructor(e=(()=>{})){this._onSetListener=e,this._stack=[],this._eventIndex=0,this.emit=e=>{for(const i of this._stack)try{i.execute(e)}catch(t){ci.error("task throws error",t)}},this.removeAllListeners=()=>{this._stack=[]},this.pipe=e=>this.add((t=>e.emit(t))),this.add=e=>{const t=this._eventIndex;this._stack.push({execute:e,id:t}),this._eventIndex++;const i=()=>{this._stack=this._stack.filter((e=>e.id!==t&&e))},n=e=>{e.push(i)};return this._onSetListener(),{removeListener:i,disposer:n}},this.once=e=>{const t=this.add((i=>{t.removeListener(),e(i)}))},this.asPromise=e=>new Promise(((t,i)=>{const n=e&&setTimeout((()=>{i("Event asPromise timeout : "+e)}),e);this.once((e=>{n&&clearTimeout(n),t(e)}))})),this.watch=(e,t)=>new Promise(((i,n)=>{const r=t&&setTimeout((()=>{n("Event watch timeout : "+t)}),t),{removeListener:s}=this.add((t=>{const n=e(t);n&&(r&&clearTimeout(r),s(),i(t))}))}))}get length(){return this._stack.length}},li=class{constructor(){this.events=[]}make(){const e=new di;return this.events.push(e),e}dispose(){this.events.forEach((e=>e.removeAllListeners())),this.events=[]}},hi=class{constructor(){this._disposer=[]}push(e){this._disposer.push(e)}dispose(){this._disposer.forEach((e=>e())),this._disposer=[]}};function ui(e,t){return function(){return e.apply(t,arguments)}}w(),w(),w(),w(),w();var{toString:pi}=Object.prototype,{getPrototypeOf:mi}=Object,fi=(e=>t=>{const i=pi.call(t);return e[i]||(e[i]=i.slice(8,-1).toLowerCase())})(Object.create(null)),gi=e=>(e=e.toLowerCase(),t=>fi(t)===e),_i=e=>t=>typeof t===e,{isArray:vi}=Array,yi=_i("undefined");function Ei(e){return null!==e&&!yi(e)&&null!==e.constructor&&!yi(e.constructor)&&Ti(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}var Si=gi("ArrayBuffer");function bi(e){let t;return t="undefined"!==typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Si(e.buffer),t}var wi=_i("string"),Ti=_i("function"),Ci=_i("number"),Ri=e=>null!==e&&"object"===typeof e,Ii=e=>!0===e||!1===e,Ai=e=>{if("object"!==fi(e))return!1;const t=mi(e);return(null===t||t===Object.prototype||null===Object.getPrototypeOf(t))&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},Pi=gi("Date"),Oi=gi("File"),Ni=gi("Blob"),Di=gi("FileList"),ki=e=>Ri(e)&&Ti(e.pipe),xi=e=>{const t="[object FormData]";return e&&("function"===typeof FormData&&e instanceof FormData||pi.call(e)===t||Ti(e.toString)&&e.toString()===t)},Li=gi("URLSearchParams"),Mi=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Fi(e,t,{allOwnKeys:i=!1}={}){if(null===e||"undefined"===typeof e)return;let n,r;if("object"!==typeof e&&(e=[e]),vi(e))for(n=0,r=e.length;n<r;n++)t.call(null,e[n],n,e);else{const r=i?Object.getOwnPropertyNames(e):Object.keys(e),s=r.length;let o;for(n=0;n<s;n++)o=r[n],t.call(null,e[o],o,e)}}function Ui(e,t){t=t.toLowerCase();const i=Object.keys(e);let n,r=i.length;while(r-- >0)if(n=i[r],t===n.toLowerCase())return n;return null}var ji=(()=>"undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:"undefined"!==typeof window?window:global)(),Vi=e=>!yi(e)&&e!==ji;function Bi(){const{caseless:e}=Vi(this)&&this||{},t={},i=(i,n)=>{const r=e&&Ui(t,n)||n;Ai(t[r])&&Ai(i)?t[r]=Bi(t[r],i):Ai(i)?t[r]=Bi({},i):vi(i)?t[r]=i.slice():t[r]=i};for(let n=0,r=arguments.length;n<r;n++)arguments[n]&&Fi(arguments[n],i);return t}var Hi=(e,t,i,{allOwnKeys:n}={})=>(Fi(t,((t,n)=>{i&&Ti(t)?e[n]=ui(t,i):e[n]=t}),{allOwnKeys:n}),e),Wi=e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),Ki=(e,t,i,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),i&&Object.assign(e.prototype,i)},Gi=(e,t,i,n)=>{let r,s,o;const a={};if(t=t||{},null==e)return t;do{r=Object.getOwnPropertyNames(e),s=r.length;while(s-- >0)o=r[s],n&&!n(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=!1!==i&&mi(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},qi=(e,t,i)=>{e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;const n=e.indexOf(t,i);return-1!==n&&n===i},zi=e=>{if(!e)return null;if(vi(e))return e;let t=e.length;if(!Ci(t))return null;const i=new Array(t);while(t-- >0)i[t]=e[t];return i},Ji=(e=>t=>e&&t instanceof e)("undefined"!==typeof Uint8Array&&mi(Uint8Array)),Yi=(e,t)=>{const i=e&&e[Symbol.iterator],n=i.call(e);let r;while((r=n.next())&&!r.done){const i=r.value;t.call(e,i[0],i[1])}},Xi=(e,t)=>{let i;const n=[];while(null!==(i=e.exec(t)))n.push(i);return n},$i=gi("HTMLFormElement"),Qi=e=>e.toLowerCase().replace(/[_-\s]([a-z\d])(\w*)/g,(function(e,t,i){return t.toUpperCase()+i})),Zi=(({hasOwnProperty:e})=>(t,i)=>e.call(t,i))(Object.prototype),en=gi("RegExp"),tn=(e,t)=>{const i=Object.getOwnPropertyDescriptors(e),n={};Fi(i,((i,r)=>{!1!==t(i,r,e)&&(n[r]=i)})),Object.defineProperties(e,n)},nn=e=>{tn(e,((t,i)=>{if(Ti(e)&&-1!==["arguments","caller","callee"].indexOf(i))return!1;const n=e[i];Ti(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))}))},rn=(e,t)=>{const i={},n=e=>{e.forEach((e=>{i[e]=!0}))};return vi(e)?n(e):n(String(e).split(t)),i},sn=()=>{},on=(e,t)=>(e=+e,Number.isFinite(e)?e:t),an=e=>{const t=new Array(10),i=(e,n)=>{if(Ri(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[n]=e;const r=vi(e)?[]:{};return Fi(e,((e,t)=>{const s=i(e,n+1);!yi(s)&&(r[t]=s)})),t[n]=void 0,r}}return e};return i(e,0)},cn={isArray:vi,isArrayBuffer:Si,isBuffer:Ei,isFormData:xi,isArrayBufferView:bi,isString:wi,isNumber:Ci,isBoolean:Ii,isObject:Ri,isPlainObject:Ai,isUndefined:yi,isDate:Pi,isFile:Oi,isBlob:Ni,isRegExp:en,isFunction:Ti,isStream:ki,isURLSearchParams:Li,isTypedArray:Ji,isFileList:Di,forEach:Fi,merge:Bi,extend:Hi,trim:Mi,stripBOM:Wi,inherits:Ki,toFlatObject:Gi,kindOf:fi,kindOfTest:gi,endsWith:qi,toArray:zi,forEachEntry:Yi,matchAll:Xi,isHTMLForm:$i,hasOwnProperty:Zi,hasOwnProp:Zi,reduceDescriptors:tn,freezeMethods:nn,toObjectSet:rn,toCamelCase:Qi,noop:sn,toFiniteNumber:on,findKey:Ui,global:ji,isContextDefined:Vi,toJSONObject:an};function dn(e,t,i,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r)}w(),w(),w(),w(),w(),cn.inherits(dn,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:cn.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var ln=dn.prototype,hn={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{hn[e]={value:e}})),Object.defineProperties(dn,hn),Object.defineProperty(ln,"isAxiosError",{value:!0}),dn.from=(e,t,i,n,r,s)=>{const o=Object.create(ln);return cn.toFlatObject(e,o,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),dn.call(o,e.message,t,i,n,r),o.cause=e,o.name=e.name,s&&Object.assign(o,s),o};var un=dn;w();var pn=S(T(),1),mn=pn.default;function fn(e){return cn.isPlainObject(e)||cn.isArray(e)}function gn(e){return cn.endsWith(e,"[]")?e.slice(0,-2):e}function _n(e,t,i){return e?e.concat(t).map((function(e,t){return e=gn(e),!i&&t?"["+e+"]":e})).join(i?".":""):t}function vn(e){return cn.isArray(e)&&!e.some(fn)}var yn=cn.toFlatObject(cn,{},null,(function(e){return/^is[A-Z]/.test(e)}));function En(e){return e&&cn.isFunction(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator]}function Sn(e,t,i){if(!cn.isObject(e))throw new TypeError("target must be an object");t=t||new(mn||FormData),i=cn.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!cn.isUndefined(t[e])}));const n=i.metaTokens,r=i.visitor||l,s=i.dots,o=i.indexes,a=i.Blob||"undefined"!==typeof Blob&&Blob,c=a&&En(t);if(!cn.isFunction(r))throw new TypeError("visitor must be a function");function d(e){if(null===e)return"";if(cn.isDate(e))return e.toISOString();if(!c&&cn.isBlob(e))throw new un("Blob is not supported. Use a Buffer instead.");return cn.isArrayBuffer(e)||cn.isTypedArray(e)?c&&"function"===typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,i,r){let a=e;if(e&&!r&&"object"===typeof e)if(cn.endsWith(i,"{}"))i=n?i:i.slice(0,-2),e=JSON.stringify(e);else if(cn.isArray(e)&&vn(e)||cn.isFileList(e)||cn.endsWith(i,"[]")&&(a=cn.toArray(e)))return i=gn(i),a.forEach((function(e,n){!cn.isUndefined(e)&&null!==e&&t.append(!0===o?_n([i],n,s):null===o?i:i+"[]",d(e))})),!1;return!!fn(e)||(t.append(_n(r,i,s),d(e)),!1)}const h=[],u=Object.assign(yn,{defaultVisitor:l,convertValue:d,isVisitable:fn});function p(e,i){if(!cn.isUndefined(e)){if(-1!==h.indexOf(e))throw Error("Circular reference detected in "+i.join("."));h.push(e),cn.forEach(e,(function(e,n){const s=!(cn.isUndefined(e)||null===e)&&r.call(t,e,cn.isString(n)?n.trim():n,i,u);!0===s&&p(e,i?i.concat(n):[n])})),h.pop()}}if(!cn.isObject(e))throw new TypeError("data must be an object");return p(e),t}var bn=Sn;function wn(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function Tn(e,t){this._pairs=[],e&&bn(e,this,t)}var Cn=Tn.prototype;Cn.append=function(e,t){this._pairs.push([e,t])},Cn.toString=function(e){const t=e?function(t){return e.call(this,t,wn)}:wn;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var Rn=Tn;function In(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function An(e,t,i){if(!t)return e;const n=i&&i.encode||In,r=i&&i.serialize;let s;if(s=r?r(t,i):cn.isURLSearchParams(t)?t.toString():new Rn(t,i).toString(n),s){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}w();var Pn=class{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){cn.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},On=Pn;w(),w(),w(),w();var Nn={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};w(),w(),w(),w();var Dn="undefined"!==typeof URLSearchParams?URLSearchParams:Rn;w();var kn=FormData,xn=(()=>{let e;return("undefined"===typeof navigator||"ReactNative"!==(e=navigator.product)&&"NativeScript"!==e&&"NS"!==e)&&("undefined"!==typeof window&&"undefined"!==typeof document)})(),Ln=(()=>"undefined"!==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"===typeof self.importScripts)(),Mn={isBrowser:!0,classes:{URLSearchParams:Dn,FormData:kn,Blob:Blob},isStandardBrowserEnv:xn,isStandardBrowserWebWorkerEnv:Ln,protocols:["http","https","file","blob","url","data"]};function Fn(e,t){return bn(e,new Mn.classes.URLSearchParams,Object.assign({visitor:function(e,t,i,n){return Mn.isNode&&cn.isBuffer(e)?(this.append(t,e.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)}},t))}function Un(e){return cn.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}function jn(e){const t={},i=Object.keys(e);let n;const r=i.length;let s;for(n=0;n<r;n++)s=i[n],t[s]=e[s];return t}function Vn(e){function t(e,i,n,r){let s=e[r++];const o=Number.isFinite(+s),a=r>=e.length;if(s=!s&&cn.isArray(n)?n.length:s,a)return cn.hasOwnProp(n,s)?n[s]=[n[s],i]:n[s]=i,!o;n[s]&&cn.isObject(n[s])||(n[s]=[]);const c=t(e,i,n[s],r);return c&&cn.isArray(n[s])&&(n[s]=jn(n[s])),!o}if(cn.isFormData(e)&&cn.isFunction(e.entries)){const i={};return cn.forEachEntry(e,((e,n)=>{t(Un(e),n,i,0)})),i}return null}w();var Bn=Vn,Hn={"Content-Type":void 0};function Wn(e,t,i){if(cn.isString(e))try{return(t||JSON.parse)(e),cn.trim(e)}catch(n){if("SyntaxError"!==n.name)throw n}return(i||JSON.stringify)(e)}var Kn={transitional:Nn,adapter:["xhr","http"],transformRequest:[function(e,t){const i=t.getContentType()||"",n=i.indexOf("application/json")>-1,r=cn.isObject(e);r&&cn.isHTMLForm(e)&&(e=new FormData(e));const s=cn.isFormData(e);if(s)return n&&n?JSON.stringify(Bn(e)):e;if(cn.isArrayBuffer(e)||cn.isBuffer(e)||cn.isStream(e)||cn.isFile(e)||cn.isBlob(e))return e;if(cn.isArrayBufferView(e))return e.buffer;if(cn.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(r){if(i.indexOf("application/x-www-form-urlencoded")>-1)return Fn(e,this.formSerializer).toString();if((o=cn.isFileList(e))||i.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return bn(o?{"files[]":e}:e,t&&new t,this.formSerializer)}}return r||n?(t.setContentType("application/json",!1),Wn(e)):e}],transformResponse:[function(e){const t=this.transitional||Kn.transitional,i=t&&t.forcedJSONParsing,n="json"===this.responseType;if(e&&cn.isString(e)&&(i&&!this.responseType||n)){const i=t&&t.silentJSONParsing,s=!i&&n;try{return JSON.parse(e)}catch(r){if(s){if("SyntaxError"===r.name)throw un.from(r,un.ERR_BAD_RESPONSE,this,null,this.response);throw r}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Mn.classes.FormData,Blob:Mn.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};cn.forEach(["delete","get","head"],(function(e){Kn.headers[e]={}})),cn.forEach(["post","put","patch"],(function(e){Kn.headers[e]=cn.merge(Hn)}));var Gn=Kn;w(),w();var qn=cn.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),zn=e=>{const t={};let i,n,r;return e&&e.split("\n").forEach((function(e){r=e.indexOf(":"),i=e.substring(0,r).trim().toLowerCase(),n=e.substring(r+1).trim(),!i||t[i]&&qn[i]||("set-cookie"===i?t[i]?t[i].push(n):t[i]=[n]:t[i]=t[i]?t[i]+", "+n:n)})),t},Jn=Symbol("internals");function Yn(e){return e&&String(e).trim().toLowerCase()}function Xn(e){return!1===e||null==e?e:cn.isArray(e)?e.map(Xn):String(e)}function $n(e){const t=Object.create(null),i=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;while(n=i.exec(e))t[n[1]]=n[2];return t}function Qn(e){return/^[-_a-zA-Z]+$/.test(e.trim())}function Zn(e,t,i,n){return cn.isFunction(n)?n.call(this,t,i):cn.isString(t)?cn.isString(n)?-1!==t.indexOf(n):cn.isRegExp(n)?n.test(t):void 0:void 0}function er(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,i)=>t.toUpperCase()+i))}function tr(e,t){const i=cn.toCamelCase(" "+t);["get","set","has"].forEach((n=>{Object.defineProperty(e,n+i,{value:function(e,i,r){return this[n].call(this,t,e,i,r)},configurable:!0})}))}var ir=class{constructor(e){e&&this.set(e)}set(e,t,i){const n=this;function r(e,t,i){const r=Yn(t);if(!r)throw new Error("header name must be a non-empty string");const s=cn.findKey(n,r);(!s||void 0===n[s]||!0===i||void 0===i&&!1!==n[s])&&(n[s||t]=Xn(e))}const s=(e,t)=>cn.forEach(e,((e,i)=>r(e,i,t)));return cn.isPlainObject(e)||e instanceof this.constructor?s(e,t):cn.isString(e)&&(e=e.trim())&&!Qn(e)?s(zn(e),t):null!=e&&r(t,e,i),this}get(e,t){if(e=Yn(e),e){const i=cn.findKey(this,e);if(i){const e=this[i];if(!t)return e;if(!0===t)return $n(e);if(cn.isFunction(t))return t.call(this,e,i);if(cn.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Yn(e),e){const i=cn.findKey(this,e);return!(!i||t&&!Zn(this,this[i],i,t))}return!1}delete(e,t){const i=this;let n=!1;function r(e){if(e=Yn(e),e){const r=cn.findKey(i,e);!r||t&&!Zn(i,i[r],r,t)||(delete i[r],n=!0)}}return cn.isArray(e)?e.forEach(r):r(e),n}clear(){return Object.keys(this).forEach(this.delete.bind(this))}normalize(e){const t=this,i={};return cn.forEach(this,((n,r)=>{const s=cn.findKey(i,r);if(s)return t[s]=Xn(n),void delete t[r];const o=e?er(r):String(r).trim();o!==r&&delete t[r],t[o]=Xn(n),i[o]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return cn.forEach(this,((i,n)=>{null!=i&&!1!==i&&(t[n]=e&&cn.isArray(i)?i.join(", "):i)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const i=new this(e);return t.forEach((e=>i.set(e))),i}static accessor(e){const t=this[Jn]=this[Jn]={accessors:{}},i=t.accessors,n=this.prototype;function r(e){const t=Yn(e);i[t]||(tr(n,e),i[t]=!0)}return cn.isArray(e)?e.forEach(r):r(e),this}};ir.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent"]),cn.freezeMethods(ir.prototype),cn.freezeMethods(ir);var nr=ir;function rr(e,t){const i=this||Gn,n=t||i,r=nr.from(n.headers);let s=n.data;return cn.forEach(e,(function(e){s=e.call(i,s,r.normalize(),t?t.status:void 0)})),r.normalize(),s}function sr(e){return!(!e||!e.__CANCEL__)}function or(e,t,i){un.call(this,null==e?"canceled":e,un.ERR_CANCELED,t,i),this.name="CanceledError"}w(),w(),cn.inherits(or,un,{__CANCEL__:!0});var ar=or;w(),w();var cr=null;function dr(e,t,i){const n=i.config.validateStatus;i.status&&n&&!n(i.status)?t(new un("Request failed with status code "+i.status,[un.ERR_BAD_REQUEST,un.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)}w(),w(),w();var lr=Mn.isStandardBrowserEnv?function(){return{write:function(e,t,i,n,r,s){const o=[];o.push(e+"="+encodeURIComponent(t)),cn.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),cn.isString(n)&&o.push("path="+n),cn.isString(r)&&o.push("domain="+r),!0===s&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}();function hr(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function ur(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function pr(e,t){return e&&!hr(t)?ur(e,t):t}w(),w(),w(),w();var mr=Mn.isStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let i;function n(i){let n=i;return e&&(t.setAttribute("href",n),n=t.href),t.setAttribute("href",n),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return i=n(window.location.href),function(e){const t=cn.isString(e)?n(e):e;return t.protocol===i.protocol&&t.host===i.host}}():function(){return function(){return!0}}();function fr(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function gr(e,t){e=e||10;const i=new Array(e),n=new Array(e);let r,s=0,o=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),d=n[o];r||(r=c),i[s]=a,n[s]=c;let l=o,h=0;while(l!==s)h+=i[l++],l%=e;if(s=(s+1)%e,s===o&&(o=(o+1)%e),c-r<t)return;const u=d&&c-d;return u?Math.round(1e3*h/u):void 0}}w(),w();var _r=gr;function vr(e,t){let i=0;const n=_r(50,250);return r=>{const s=r.loaded,o=r.lengthComputable?r.total:void 0,a=s-i,c=n(a),d=s<=o;i=s;const l={loaded:s,total:o,progress:o?s/o:void 0,bytes:a,rate:c||void 0,estimated:c&&o&&d?(o-s)/c:void 0,event:r};l[t?"download":"upload"]=!0,e(l)}}var yr="undefined"!==typeof XMLHttpRequest,Er=yr&&function(e){return new Promise((function(t,i){let n=e.data;const r=nr.from(e.headers).normalize(),s=e.responseType;let o;function a(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}cn.isFormData(n)&&(Mn.isStandardBrowserEnv||Mn.isStandardBrowserWebWorkerEnv)&&r.setContentType(!1);let c=new XMLHttpRequest;if(e.auth){const t=e.auth.username||"",i=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";r.set("Authorization","Basic "+btoa(t+":"+i))}const d=pr(e.baseURL,e.url);function l(){if(!c)return;const n=nr.from("getAllResponseHeaders"in c&&c.getAllResponseHeaders()),r=s&&"text"!==s&&"json"!==s?c.response:c.responseText,o={data:r,status:c.status,statusText:c.statusText,headers:n,config:e,request:c};dr((function(e){t(e),a()}),(function(e){i(e),a()}),o),c=null}if(c.open(e.method.toUpperCase(),An(d,e.params,e.paramsSerializer),!0),c.timeout=e.timeout,"onloadend"in c?c.onloadend=l:c.onreadystatechange=function(){c&&4===c.readyState&&(0!==c.status||c.responseURL&&0===c.responseURL.indexOf("file:"))&&setTimeout(l)},c.onabort=function(){c&&(i(new un("Request aborted",un.ECONNABORTED,e,c)),c=null)},c.onerror=function(){i(new un("Network Error",un.ERR_NETWORK,e,c)),c=null},c.ontimeout=function(){let t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const n=e.transitional||Nn;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(new un(t,n.clarifyTimeoutError?un.ETIMEDOUT:un.ECONNABORTED,e,c)),c=null},Mn.isStandardBrowserEnv){const t=(e.withCredentials||mr(d))&&e.xsrfCookieName&&lr.read(e.xsrfCookieName);t&&r.set(e.xsrfHeaderName,t)}void 0===n&&r.setContentType(null),"setRequestHeader"in c&&cn.forEach(r.toJSON(),(function(e,t){c.setRequestHeader(t,e)})),cn.isUndefined(e.withCredentials)||(c.withCredentials=!!e.withCredentials),s&&"json"!==s&&(c.responseType=e.responseType),"function"===typeof e.onDownloadProgress&&c.addEventListener("progress",vr(e.onDownloadProgress,!0)),"function"===typeof e.onUploadProgress&&c.upload&&c.upload.addEventListener("progress",vr(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=t=>{c&&(i(!t||t.type?new ar(null,e,c):t),c.abort(),c=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));const h=fr(d);h&&-1===Mn.protocols.indexOf(h)?i(new un("Unsupported protocol "+h+":",un.ERR_BAD_REQUEST,e)):c.send(n||null)}))},Sr={http:cr,xhr:Er};cn.forEach(Sr,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(i){}Object.defineProperty(e,"adapterName",{value:t})}}));var br={getAdapter:e=>{e=cn.isArray(e)?e:[e];const{length:t}=e;let i,n;for(let r=0;r<t;r++)if(i=e[r],n=cn.isString(i)?Sr[i.toLowerCase()]:i)break;if(!n){if(!1===n)throw new un(`Adapter ${i} is not supported by the environment`,"ERR_NOT_SUPPORT");throw new Error(cn.hasOwnProp(Sr,i)?`Adapter '${i}' is not available in the build`:`Unknown adapter '${i}'`)}if(!cn.isFunction(n))throw new TypeError("adapter is not a function");return n},adapters:Sr};function wr(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new ar(null,e)}function Tr(e){wr(e),e.headers=nr.from(e.headers),e.data=rr.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);const t=br.getAdapter(e.adapter||Gn.adapter);return t(e).then((function(t){return wr(e),t.data=rr.call(e,e.transformResponse,t),t.headers=nr.from(t.headers),t}),(function(t){return sr(t)||(wr(e),t&&t.response&&(t.response.data=rr.call(e,e.transformResponse,t.response),t.response.headers=nr.from(t.response.headers))),Promise.reject(t)}))}w();var Cr=e=>e instanceof nr?e.toJSON():e;function Rr(e,t){t=t||{};const i={};function n(e,t,i){return cn.isPlainObject(e)&&cn.isPlainObject(t)?cn.merge.call({caseless:i},e,t):cn.isPlainObject(t)?cn.merge({},t):cn.isArray(t)?t.slice():t}function r(e,t,i){return cn.isUndefined(t)?cn.isUndefined(e)?void 0:n(void 0,e,i):n(e,t,i)}function s(e,t){if(!cn.isUndefined(t))return n(void 0,t)}function o(e,t){return cn.isUndefined(t)?cn.isUndefined(e)?void 0:n(void 0,e):n(void 0,t)}function a(i,r,s){return s in t?n(i,r):s in e?n(void 0,i):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(e,t)=>r(Cr(e),Cr(t),!0)};return cn.forEach(Object.keys(e).concat(Object.keys(t)),(function(n){const s=c[n]||r,o=s(e[n],t[n],n);cn.isUndefined(o)&&s!==a||(i[n]=o)})),i}w(),w();var Ir="1.2.4",Ar={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{Ar[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));var Pr={};function Or(e,t,i){if("object"!==typeof e)throw new un("options must be an object",un.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let r=n.length;while(r-- >0){const s=n[r],o=t[s];if(o){const t=e[s],i=void 0===t||o(t,s,e);if(!0!==i)throw new un("option "+s+" must be "+i,un.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new un("Unknown option "+s,un.ERR_BAD_OPTION)}}Ar.transitional=function(e,t,i){function n(e,t){return"[Axios v"+Ir+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return(i,r,s)=>{if(!1===e)throw new un(n(r," has been removed"+(t?" in "+t:"")),un.ERR_DEPRECATED);return t&&!Pr[r]&&(Pr[r]=!0,console.warn(n(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,r,s)}};var Nr={assertOptions:Or,validators:Ar},Dr=Nr.validators,kr=class{constructor(e){this.defaults=e,this.interceptors={request:new On,response:new On}}request(e,t){"string"===typeof e?(t=t||{},t.url=e):t=e||{},t=Rr(this.defaults,t);const{transitional:i,paramsSerializer:n,headers:r}=t;let s;void 0!==i&&Nr.assertOptions(i,{silentJSONParsing:Dr.transitional(Dr.boolean),forcedJSONParsing:Dr.transitional(Dr.boolean),clarifyTimeoutError:Dr.transitional(Dr.boolean)},!1),void 0!==n&&Nr.assertOptions(n,{encode:Dr.function,serialize:Dr.function},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase(),s=r&&cn.merge(r.common,r[t.method]),s&&cn.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete r[e]})),t.headers=nr.concat(s,r);const o=[];let a=!0;this.interceptors.request.forEach((function(e){"function"===typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,o.unshift(e.fulfilled,e.rejected))}));const c=[];let d;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let l,h=0;if(!a){const e=[Tr.bind(this),void 0];e.unshift.apply(e,o),e.push.apply(e,c),l=e.length,d=Promise.resolve(t);while(h<l)d=d.then(e[h++],e[h++]);return d}l=o.length;let u=t;h=0;while(h<l){const e=o[h++],t=o[h++];try{u=e(u)}catch(p){t.call(this,p);break}}try{d=Tr.call(this,u)}catch(p){return Promise.reject(p)}h=0,l=c.length;while(h<l)d=d.then(c[h++],c[h++]);return d}getUri(e){e=Rr(this.defaults,e);const t=pr(e.baseURL,e.url);return An(t,e.params,e.paramsSerializer)}};cn.forEach(["delete","get","head","options"],(function(e){kr.prototype[e]=function(t,i){return this.request(Rr(i||{},{method:e,url:t,data:(i||{}).data}))}})),cn.forEach(["post","put","patch"],(function(e){function t(t){return function(i,n,r){return this.request(Rr(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}kr.prototype[e]=t(),kr.prototype[e+"Form"]=t(!0)}));var xr=kr;w();var Lr=class{constructor(e){if("function"!==typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const i=this;this.promise.then((e=>{if(!i._listeners)return;let t=i._listeners.length;while(t-- >0)i._listeners[t](e);i._listeners=null})),this.promise.then=e=>{let t;const n=new Promise((e=>{i.subscribe(e),t=e})).then(e);return n.cancel=function(){i.unsubscribe(t)},n},e((function(e,n,r){i.reason||(i.reason=new ar(e,n,r),t(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;const t=new Lr((function(t){e=t}));return{token:t,cancel:e}}},Mr=Lr;function Fr(e){return function(t){return e.apply(null,t)}}function Ur(e){return cn.isObject(e)&&!0===e.isAxiosError}w(),w(),w();var jr={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(jr).forEach((([e,t])=>{jr[t]=e}));var Vr=jr;function Br(e){const t=new xr(e),i=ui(xr.prototype.request,t);return cn.extend(i,xr.prototype,t,{allOwnKeys:!0}),cn.extend(i,t,null,{allOwnKeys:!0}),i.create=function(t){return Br(Rr(e,t))},i}var Hr=Br(Gn);Hr.Axios=xr,Hr.CanceledError=ar,Hr.CancelToken=Mr,Hr.isCancel=sr,Hr.VERSION=Ir,Hr.toFormData=bn,Hr.AxiosError=un,Hr.Cancel=Hr.CanceledError,Hr.all=function(e){return Promise.all(e)},Hr.spread=Fr,Hr.isAxiosError=Ur,Hr.mergeConfig=Rr,Hr.AxiosHeaders=nr,Hr.formToJSON=e=>Bn(cn.isHTMLForm(e)?new FormData(e):e),Hr.HttpStatusCode=Vr,Hr.default=Hr;var Wr=Hr,{Axios:Kr,AxiosError:Gr,CanceledError:qr,isCancel:zr,CancelToken:Jr,VERSION:Yr,all:Xr,Cancel:$r,isAxiosError:Qr,spread:Zr,toFormData:es,AxiosHeaders:ts,HttpStatusCode:is,formToJSON:ns,mergeConfig:rs}=Wr,ss=new si("packages/common/src/http.ts"),os=class{constructor(e){this.api=Wr.create({baseURL:e})}get(e,t){return b(this,null,(function*(){const i=yield this.api.get(e,t).catch((e=>e));if(Wr.isAxiosError(i)){const n=_(g({},i.response),{message:i.message});if(null==t?void 0:t.retry){const i=yield t.retry(n);if(i)return ss.warn("retry get",{url:e}),this.get(e,t);throw ss.warn("retry get failed",{url:e}),n}throw ss.warn("response error",{error:n}),n}return i.data}))}post(e,t,i){return b(this,null,(function*(){var n,r,s;const o=yield this.api.post(e,t,i).catch((e=>e));if(Wr.isAxiosError(o)){const a={data:null==(n=o.response)?void 0:n.data,status:null==(r=o.response)?void 0:r.status,statusText:null==(s=o.response)?void 0:s.statusText,message:o.message};if(ss.warn("error received",a),null==i?void 0:i.retry){const n=yield i.retry(a);if(n)return ss.warn("retry post",e,{data:t,error:a,needRetry:n}),this.post(e,t,i);throw a}throw a}return o.data}))}put(e,t,i){return b(this,null,(function*(){const n=yield this.api.put(e,t,i).catch((e=>e));if(Wr.isAxiosError(n)){const r=_(g({},n.response),{message:n.message});if(null==i?void 0:i.retry){const n=yield i.retry(r);if(n)return ss.warn("retry put",{url:e,data:t}),this.put(e,t,i);throw ss.warn("retry put failed",{url:e,data:t}),r}throw ss.warn("response error",{error:r}),r}return n.data}))}delete(e,t){return b(this,null,(function*(){const i=yield this.api.delete(e,t).catch((e=>e));if(Wr.isAxiosError(i)){const n=_(g({},i.response),{message:i.message});if(null==t?void 0:t.retry){const i=yield t.retry(n);if(i)return ss.warn("retry delete",{url:e}),this.delete(e,t);throw ss.warn("retry delete failed",{url:e}),n}throw ss.warn("response error",{error:n}),n}return i.data}))}};w();new si("packages/common/src/promise.ts");var as=class{constructor(){this.id=Math.random().toString().slice(2),this.queue=[],this.running=!1,this.push=e=>new Promise(((t,i)=>{this.queue.push({promise:e,done:t,failed:i}),this.running||this.run()}))}run(){return b(this,null,(function*(){const e=this.queue.shift();if(e){this.running=!0;try{const t=yield e.promise();e.done(t)}catch(t){e.failed(t)}yield this.run()}else this.running=!1}))}};w();var cs=class{constructor(e={}){this.count=0,this.times=8,this.interval=100,this.jitter=0,Object.assign(this,e)}wait(){return b(this,null,(function*(){if(this.exceeded)return!1;const e=this.timeout;return this.count++,yield new Promise((t=>setTimeout(t,e))),!0}))}get timeout(){const e=m(this.count,2)*this.interval+m(this.count,2)*this.jitter*Math.random();return e}get exceeded(){return this.count>=this.times}reset(){this.count=0}},ds=e=>JSON.parse(JSON.stringify(e));w();var ls={internal:{name:"internal",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},missingProperty:{name:"missingProperty",detail:"",solution:""},notFound:{name:"notFound",detail:"",solution:""},invalidParameter:{name:"invalidParameter",detail:"",solution:""},invalidArgumentValue:{name:"invalidArgumentValue",detail:"å¼æ°ã®å¤ãä¸æ­£ã§ã",solution:"æ­£ããå¤ãå¼æ°ã«æ¸¡ãã¦ãã ãã"},invalidContentType:{name:"invalidContentType",detail:"contentTypeãæ­£ããããã¾ãã",solution:"ContentTypeãç¢ºèªãã¦ãã ãã"},localPersonNotJoinedChannel:{name:"localPersonNotJoinedChannel",detail:"æä½ãããã¨ããPersonãChannelã«å±ãªãã®ã§ãæä½ã§ãã¾ãã The person who tried to operate is not in the channel, so the operation is not possible",solution:"Channelã«å±ãªãPersonãæä½ãã¦ããå¯è½æ§ãããã®ã§ç¢ºèªãã¦ãã ãã Please check as you may be operating a person which is not in the channel"},alreadyLocalPersonExist:{name:"alreadyLocalPersonExist",detail:"Channelã«ãã§ã«LocalPersonãå­å¨ãã¾ããä¸ã¤ã®Channelã¤ã³ã¹ã¿ã³ã¹ã«ã¯LocalPersonãä¸ã¤ããJoinã§ãã¾ãã",solution:"è¤æ°ã®LocalPersonãç¨æãããå ´åã¯åå¥ã«Channelã¤ã³ã¹ã¿ã³ã¹ãç¨æãã¦ãã ããã"},alreadySameNameMemberExist:{name:"alreadySameNameMemberExist",detail:"Channelã«ãã§ã«åãNameã®Memberãå­å¨ãã¾ã",solution:"å¥ã®Nameãä½¿ç¨ãã¦ãã ãã"},alreadyPublishedStream:{name:"alreadyPublishedStream",detail:"ãã§ã«PublishããStreamãååº¦Publishãããã¨ã¯ã§ãã¾ãã You cannot re-publish a stream that has already been published",solution:"ãã®StreamãPublishããPublicationãUnpublishããããå¥ã®æ°ããStreamãä½ã£ã¦Publishãã¦ãã ãã Unpublish the publication that published that stream, or create another new stream and publish it"},alreadySubscribedPublication:{name:"alreadySubscribedPublication",detail:"ãã§ã«SubscribeããPublicationãSubscribeãããã¨ã¯ã§ãã¾ãã",solution:"ããã¾ãã"},invalidTrackKind:{name:"invalidTrackKind",detail:"Streamã®ç¨®é¡ã¨MediaStreamTrackã®ç¨®é¡ãä¸è´ãã¾ãã",solution:"Streamã®ç¨®é¡ã¨åãMediaStreamTrackãå©ç¨ãã¦ãã ãã"},cantMoveSameIdChannel:{name:"cantMoveSameIdChannel",detail:"moveChannelã§åãidã®Channelã«ç§»åãããã¨ã¯åºæ¥ã¾ãã",solution:"ç§»ååã®Channelãæ­£ãããç¢ºããã¦ãã ãã"},alreadyChannelClosed:{name:"alreadyChannelClosed",detail:"Channelããã§ã«Closeããã¦ãã¾ã",solution:"ããã¾ãã"},disabledDataStream:{name:"disabledDataStream",detail:"é¢é£ããPublicationãDisableãªDataStreamã«ã¯æ¸ãè¾¼ã¿ã§ãã¾ãã",solution:"é¢é£ããPublicationãEnableãã¦ããæ¸ãè¾¼ãã§ãã ãã"},publicationNotExist:{name:"publicationNotExist",detail:"channelã«è©²å½ããPublicationãå­å¨ãã¾ãã",solution:"publicationIdãæ­£ãããç¢ºããã¦ãã ãã"},subscriptionNotExist:{name:"subscriptionNotExist",detail:"channelã«è©²å½ããSubscriptionãå­å¨ãã¾ãã",solution:"subscriptionIdãæ­£ãããç¢ºããã¦ãã ãã"},unknownMemberType:{name:"unknownMemberType",detail:"å¯¾è±¡ã®Memberã®Subtypeã®ãã©ã°ã¤ã³ãç»é²ããã¦ãã¾ãã",solution:"å¯¾è±¡ã®Memberã®Subtypeã®ãã©ã°ã¤ã³(SfuBotãªã©)ãSkyWayContextã«ç»é²ãã¦ãã ãã"},unknownRemoteMemberType:{name:"unknownMemberType",detail:"å¯¾è±¡ã®Memberã®Subtypeã®ãã©ã°ã¤ã³ãç»é²ããã¦ãã¾ãã",solution:"å¯¾è±¡ã®Memberã®Subtypeã®ãã©ã°ã¤ã³(SfuBotãªã©)ãSkyWayContextã«ç»é²ãã¦ãã ãã"},streamNotExistInSubscription:{name:"streamNotExistInSubscription",detail:"Subscriptionã«Streamãããã¾ãããRemoteMemberã®Subscriptionã®Streamã«ã¯ã¢ã¯ã»ã¹ã§ãã¾ãã",solution:"åç§ãã¦ããSubscriptionãç®çã®ãã®ãç¢ºããã¦ãã ããã"},streamNotExistInPublication:{name:"streamNotExistInPublication",detail:"Publicationã«Streamãããã¾ãããRemoteMemberã®Publicationã®Streamã«ã¯ã¢ã¯ã»ã¹ã§ãã¾ãã",solution:"åç§ãã¦ããPublicationãç®çã®ãã®ãç¢ºããã¦ãã ããã"},dataStreamNotSupportEncoding:{name:"dataStreamNotSupportEncoding",detail:"dataStreamã¯Encodeè¨­å®ã®å¤æ´ã«å¯¾å¿ãã¦ãã¾ãã",solution:"ããã¾ãã"},correspondingEncodeNotExistForId:{name:"correspondingEncodeNotExistForId",detail:"æå®ãããIDã«å¯¾å¿ããEncodeè¨­å®ãå­å¨ãã¾ãã",solution:"æ­£ããEncodingIDãæå®ãã¦ãã ãã"},updateIceParamsFailed:{name:"updateIceParamsFailed",detail:"iceParamsã®æ´æ°ã«å¤±æãã¾ãã",solution:"ããã¾ãã"},invalidElement:{name:"invalidElement",detail:"æ¸¡ãããHTML Elementãæ­£ããããã¾ãã",solution:"è¦æ±ãããæ­£ããElementãæ¸¡ãã¦ãã ãã"},connectRtcApiFailed:{name:"connectRtcApiFailed",detail:"RtcAPIã¸ã®æ¥ç¶ã«å¤±æãã¾ãã",solution:"ã¤ã³ã¿ã¼ãããã¸ã®æ¥ç¶ã§ãã¦ãããããããã¯Tokenã®ãã©ã¡ã¼ã¿ãæ­£ããããç¢ºããã¦ãã ãã"},rtcApiFatalError:{name:"rtcApiFatalError",detail:"RtcAPIã®åå¾©ä¸è½ãªã¨ã©ã¼ã§ãããµã¼ãã¼å´ã®åé¡ã®å¯è½æ§ãããã¾ã",solution:"ã¤ã³ã¿ã¼ãããã¸ã®æ¥ç¶ãåºæ¥ã¦ããããç¢ºããã¦ãã ãã"},invalidExpireTokenValue:{name:"invalidExpireTokenValue",detail:"tokenã®Expireæå»ãä¸æ­£ã§ã",solution:"æ­£ããæå»ãæå®ãã¦ãã ãã"},invalidRemindExpireTokenValue:{name:"invalidRemindExpireTokenValue",detail:"tokenã®Expireããªãã¤ã³ãããæéã®å¤ãä¸æ­£ã§ã",solution:"æ­£ããæéãæå®ãã¦ãã ãã"},invalidTokenAppId:{name:"invalidTokenAppId",detail:"tokenã®appIdãæ­£ããããã¾ãã",solution:"æ­£ããappIdãå«ãTokenãä½¿ç¨ãã¦ãã ãã"},mediaDevicesNotFound:{name:"mediaDevicesNotFound",detail:"navigator.mediaDevicesãã¿ã¤ããã¾ãã",solution:"ã¢ããªã±ã¼ã·ã§ã³ãhttps,localhost,127.0.0.1ã®ããããã®ç°å¢ã§åä½ããã¦ãã ãã"},canNotUseReplaceStream:{name:"canNotUseReplaceStream",detail:"remoteã®PublicationããreplaceStreamã§ãã¾ãã",solution:"å¯¾è±¡ã®PublicationãLocalã®ãã®ãç¢ºèªãã¦ãã ãã"},canNotEnableRemotePublication:{name:"canNotEnableRemotePublication",detail:"remoteã®Publicationãenableãããã¨ã¯ã§ãã¾ãã",solution:"å¯¾è±¡ã®PublicationãLocalã®ãã®ãç¢ºèªãã¦ãã ãã"}};w(),w(),w();var hs=S(C()),us=(S(P()),new si("packages/core/src/util.ts"));function ps(e){const t=[];return e.forEach((e=>{t.push(e)})),t}function ms(e){return b(this,arguments,(function*({operationName:e,channel:t}){const i={operationName:e,appId:t.appId,channelId:t.id};if(t.localPerson){const e=t.localPerson,n=yield Promise.all(e.publications.map((e=>b(this,null,(function*(){var t,i,n;const r={id:e.id,contentType:e.contentType,state:e.state,stats:{},connectionStats:{}};if(e.stream){for(const{memberId:s,stats:o}of yield e.stream._getStatsAll()){const a=o.find((e=>e.type.includes("local-candidate")));r.stats[s]={transportType:null!=(t=null==a?void 0:a.protocol)?t:"none",relayProtocol:null!=(i=null==a?void 0:a.relayProtocol)?i:"none",callType:null==(n=e.subscriptions.find((e=>e.subscriber.id===s)))?void 0:n.subscriber.subtype,outbound:o.find((e=>e.type.includes("outbound-rtp"))),localCandidate:a}}for(const{memberId:t,connectionState:i}of e.stream._getConnectionStateAll())r.connectionStats[t]=i}return r})))));i["publishing"]=n;const r=yield Promise.all(e.subscriptions.map((e=>b(this,null,(function*(){const t={id:e.id,contentType:e.contentType,stats:{}};if(t["callType"]=e.publication.publisher.subtype,e.stream){const i=yield e.stream.getStats();t.stats=i.find((e=>e.type.includes("inbound-rtp")));const n=i.find((e=>e.type.includes("local-candidate")));t["transportType"]=null==n?void 0:n.protocol,t["relayProtocol"]=null==n?void 0:n.relayProtocol}return e.stream&&(t["connectionState"]=e.stream.getConnectionState()),t})))));i["subscribing"]=r}return i}))}function fs({member:e,detail:t,channel:i,operationName:n,payload:r}){const s={operationName:n,payload:r,detail:t};return e&&(s["appId"]=e.channel.appId,s["channelId"]=e.channel.id,s["memberId"]=e.id),i&&(s["appId"]=i.appId,s["channelId"]=i.id),s}function gs({operationName:e,context:t,info:i,error:n,path:r,payload:s,channel:o}){const a={operationName:e,payload:s};return o&&(a["appId"]=o.appId,a["channelId"]=o.id,o.localPerson&&(a["memberId"]=o.localPerson.id)),t&&(a["info"]=t.info,a["plugins"]=t.plugins.map((e=>e.subtype))),new ai({error:n,info:i,payload:a,path:r})}var _s=(e,t,i,n=100,r=1e4)=>b(void 0,null,(function*(){return new Promise(((s,o)=>b(void 0,null,(function*(){for(let a=0;;a+=n){if(a>=r){o(gs({operationName:"Peer.waitForStats",info:_(g({},ls.timeout),{detail:"waitForStats timeout"}),path:us.prefix}));break}const c=yield e.getStats(t);if(i(c)){s(c);break}yield new Promise((e=>setTimeout(e,n)))}}))))})),vs=(e,t)=>{var i,n;return ys(null!=(n=null==(i=e.find((e=>e.payload===t)))?void 0:i.config)?n:"")},ys=e=>{const t=e.split(";").reduce(((e,t)=>{const[i,n]=t.split("=");return i&&(e[i]=Number(n),"profile-level-id"===i&&(e[i]=n)),e}),{});return t};var Es=({isNotBrowser:e}={})=>{if(e)return e;const t=hs.default.getParser(window.navigator.userAgent),i=t.getOSName(),n=t.getOSVersion(),r=t.getBrowserName(),s=t.getBrowserVersion();return{browserName:r,browserVersion:s,osName:i,osVersion:n}};function Ss(){if("object"===typeof navigator&&"ReactNative"===navigator.product){if("undefined"===typeof RTCPeerConnection)return;return"ReactNative"}if("object"!==typeof navigator||"string"!==typeof navigator.userAgent);else{const e=navigator.userAgent,t=hs.default.getParser(e),i=t.getEngine();if(t.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(t.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(t.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(t.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}}))return"Safari12";if(t.satisfies({safari:">=12.0"})&&"undefined"!==typeof RTCRtpTransceiver&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"}))return"Safari11";if(t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(i.name&&"blink"===i.name.toLowerCase()){const t=e.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(t){const e=Number(t[1]);return e>=74?"Chrome74":e>=70?"Chrome70":e>=67?"Chrome67":"Chrome55"}return"Chrome74"}}}var bs=new si("packages/core/src/publication/index.ts"),ws=class{constructor(e){var t,i;this._codecCapabilities=[],this._encodings=[],this._state="enabled",this._events=new li,this.onCanceled=this._events.make(),this.onSubscribed=this._events.make(),this.onUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onEnabled=this._events.make(),this.onDisabled=this._events.make(),this.onStateChanged=this._events.make(),this._onEncodingsChanged=this._events.make(),this._onReplaceStream=this._events.make(),this._onEnabled=this._events.make(),this.cancel=()=>new Promise(((e,t)=>{let i=!1;this._channel._unpublish(this.id).catch((e=>{i=!0,t(e)})),this.stream=void 0,this.onCanceled.asPromise(this._context.config.rtcApi.timeout).then((()=>e())).catch((e=>{i||t(e)}))})),this.updateMetadata=e=>new Promise(((t,i)=>b(this,null,(function*(){const n=bs.info("[start] updateMetadata",yield ms({operationName:"Publication.updateMetadata",channel:this._channel}),this);let r=!1;this._channel._updatePublicationMetadata(this.id,e).catch((e=>{r=!0,i(e)})),this.onMetadataUpdated.watch((t=>t.metadata===e),this._context.config.rtcApi.timeout).catch((e=>{if(!r)throw gs({operationName:"PublicationImpl.updateMetadata",info:_(g({},ls.timeout),{detail:"publication onMetadataUpdated"}),path:bs.prefix,context:this._context,channel:this._channel,error:e})})).then((()=>b(this,null,(function*(){t(),bs.elapsed(n,"[end] updateMetadata",yield ms({operationName:"Publication.updateMetadata",channel:this._channel}),this)}))))})))),this.disable=()=>new Promise(((e,t)=>b(this,null,(function*(){const i=bs.info("[start] disable",yield ms({operationName:"Publication.disable",channel:this._channel}),this);this._disableStream();let n=!1;this._channel._disablePublication(this.id).catch((e=>{n=!0,t(e)})),this.onDisabled.asPromise(this._context.config.rtcApi.timeout).then((()=>b(this,null,(function*(){e(),bs.elapsed(i,"[end] disable",yield ms({operationName:"Publication.disable",channel:this._channel}),this)})))).catch((e=>{n||t(e)}))})))),this.enable=()=>new Promise(((e,t)=>b(this,null,(function*(){if(void 0==this.stream)return void t(gs({operationName:"Publication.enable",context:this._context,info:ls.canNotEnableRemotePublication,path:bs.prefix}));const i=bs.info("[start] enable",yield ms({operationName:"Publication.enable",channel:this._channel}),this);let n=!1;this._channel._enablePublication(this.id).catch((e=>{n=!0,t(e)})),this._onEnabled.asPromise(this._context.config.rtcApi.timeout).then((()=>b(this,null,(function*(){yield this._enableStream(),this.onEnabled.emit(),this.onStateChanged.emit(),bs.elapsed(i,"[end] enable",yield ms({operationName:"Publication.enable",channel:this._channel}),this),e()})))).catch((e=>{n||t(e)}))})))),this.id=e.id,this._channel=e.channel,this._context=this._channel._context,this.publisher=e.publisher,this.contentType=e.contentType,this._metadata=e.metadata,this.origin=e.origin,this.setCodecCapabilities(null!=(t=e.codecCapabilities)?t:[]),this.setEncodings(Ts(null!=(i=e.encodings)?i:[])),this.stream=e.stream,this._state=e.isEnabled?"enabled":"disabled",bs.debug("publication spawned",this.toJSON())}get codecCapabilities(){return this._codecCapabilities}setCodecCapabilities(e){this._codecCapabilities=e}get encodings(){return this._encodings}setEncodings(e){this._encodings=e}get metadata(){return this._metadata}get state(){return this._state}get subscriptions(){return this._channel.subscriptions.filter((e=>e.publication.id===this.id))}_updateMetadata(e){this._metadata=e,this.onMetadataUpdated.emit({metadata:e})}_disable(){this._disableStream(),this.onDisabled.emit(),this.onStateChanged.emit()}_enable(){this.stream?this._onEnabled.emit():(this._state="enabled",this.onEnabled.emit(),this.onStateChanged.emit())}_unpublished(){this._state="canceled",this.stream&&this.stream._unpublished(),this.onCanceled.emit(),this.onStateChanged.emit(),this._dispose()}_subscribed(e){this.onSubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit()}_unsubscribed(e){this.onUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit()}updateEncodings(e){bs.info("updateEncodings",{encodings:e},this),this.setEncodings(Ts(e)),this._onEncodingsChanged.emit(e)}_disableStream(){"disabled"!==this.state&&(this._state="disabled",this.stream&&("data"===this.stream.contentType?this.stream.setIsEnabled(!1):this.stream.setEnabled(!1).catch((e=>{bs.warn(fs({channel:this._channel,operationName:"Publication._disableStream",payload:e,detail:"setEnabled failed"}))})),ms({operationName:"Publication._disableStream",channel:this._channel}).then((e=>bs.info("publication _disableStream",e,{publication:this})))))}_enableStream(){return b(this,null,(function*(){"enabled"!==this.state&&(this._state="enabled",this.stream&&(ms({operationName:"Publication._enableStream",channel:this._channel}).then((e=>bs.info("publication _enableStream",e,{publication:this}))),"data"===this.stream.contentType?this.stream.setIsEnabled(!0):yield this.stream.setEnabled(!0).catch((e=>{bs.warn(fs({channel:this._channel,operationName:"Publication._disableStream",payload:e,detail:"setEnabled failed"}))}))))}))}replaceStream(e,t={}){var i;if(bs.info("replaceStream",{stream:e,options:t},this),!this.stream)throw gs({operationName:"PublicationImpl.replaceStream",context:this._context,info:ls.canNotUseReplaceStream,path:bs.prefix});if(e.contentType!==this.contentType)throw gs({operationName:"PublicationImpl.replaceStream",context:this._context,info:ls.invalidContentType,path:bs.prefix});if(null==(i=t.releaseOldStream)||i){const e=this.stream;e.release()}ms({operationName:"PublicationImpl.replaceStream",channel:this._channel}).then((t=>bs.debug(t,{old:this.stream,new:e}))).catch((e=>e)),e.setEnabled(this.stream.isEnabled),this.stream=e,this._onReplaceStream.emit(e)}getStats(e){if(!this.stream)throw gs({operationName:"PublicationImpl.getStats",context:this._context,info:ls.streamNotExistInSubscription,path:bs.prefix});return this.stream._getStats(e)}getRTCPeerConnection(e){if(!this.stream)throw gs({operationName:"PublicationImpl.getRTCPeerConnection",context:this._context,info:ls.streamNotExistInSubscription,path:bs.prefix});return this.stream._getRTCPeerConnection(e)}getConnectionState(e){if(!this.stream)throw gs({operationName:"PublicationImpl.getConnectionState",context:this._context,info:ls.streamNotExistInSubscription,path:bs.prefix});return this.stream._getConnectionState(e)}toJSON(){var e;return{id:this.id,channelId:this._channel.id,publisherId:this.publisher.id,origin:null==(e=this.origin)?void 0:e.id,contentType:this.contentType,metadata:this.metadata,codecCapabilities:this.codecCapabilities,encodings:this.encodings,state:this.state,stream:this.stream}}_dispose(){this._events.dispose()}},Ts=e=>e.map(((e,t)=>{var i;return _(g({},e),{id:null!=(i=e.id)?i:t.toString()})}));function Cs(e,{publisherId:t,stream:i,origin:n,metadata:r,codecCapabilities:s,encodings:o,contentType:a,id:c,isEnabled:d}){const l=e._getPublication(c);if(l)return l;a=a.toLowerCase();const h=n?e._getPublication(n):void 0;h&&0===o.length&&(o=h.encodings);const u=new ws({id:c,channel:e,publisher:e._getMember(t),contentType:a,metadata:r,origin:h,stream:i,codecCapabilities:null!=s?s:[],encodings:o,isEnabled:d});return u}w(),w();var Rs=new si("packages/core/src/subscription/index.ts"),Is=class{constructor(e){this._disposer=new hi,this._state="enabled",this.onCanceled=new di,this.onStreamAttached=new di,this._onChangeEncoding=new di,this.cancel=()=>new Promise(((e,t)=>{let i=!1;this._channel._unsubscribe(this.id).catch((e=>{i=!0,t(e)})),this.onCanceled.asPromise(this._context.config.rtcApi.timeout).then((()=>e())).catch((e=>{i||t(e)}))})),this._channel=e.channel,this._context=this._channel._context,this.id=e.id,this.contentType=e.contentType,this.subscriber=e.subscriber,this.publication=e.publication,Rs.debug("subscription spawned",this.toJSON()),this._handlePublicationEnabled()}get state(){return this._state}_handlePublicationEnabled(){this.publication.onDisabled.add((()=>{this.stream&&(Rs.debug("disabled",this),this.stream.setIsEnabled(!1))})).disposer(this._disposer),this.publication.onEnabled.add((()=>{this.stream&&(Rs.debug("enabled",this),this.stream.setIsEnabled(!0))})).disposer(this._disposer),this.stream&&this.stream.setIsEnabled("enabled"===this.publication.state)}set stream(e){this._stream=e,e&&this.onStreamAttached.emit()}get stream(){return this._stream}toJSON(){return{id:this.id,contentType:this.contentType,subscriber:this.subscriber,publication:this.publication,channelId:this._channel.id,state:this.state,stream:this.stream}}_canceled(){this.stream=void 0,this._state="canceled",this.onCanceled.emit(),this._disposer.dispose()}changePreferredEncoding(e){if(!this.stream)throw gs({operationName:"SubscriptionImpl.changePreferredEncoding",info:ls.streamNotExistInSubscription,path:Rs.prefix,context:this._context,channel:this._channel});if("data"===this.stream.contentType)throw gs({operationName:"SubscriptionImpl.changePreferredEncoding",info:ls.dataStreamNotSupportEncoding,path:Rs.prefix,context:this._context,channel:this._channel});if(!this.publication.encodings.map((e=>e.id)).includes(e))throw gs({operationName:"SubscriptionImpl.changePreferredEncoding",info:ls.correspondingEncodeNotExistForId,path:Rs.prefix,context:this._context,channel:this._channel});this.preferredEncoding=e,this._onChangeEncoding.emit()}getStats(){if(!this.stream)throw gs({operationName:"SubscriptionImpl.getStats",info:ls.streamNotExistInSubscription,path:Rs.prefix,context:this._context,channel:this._channel});return this.stream._getStats()}getRTCPeerConnection(){if(!this.stream)throw gs({operationName:"SubscriptionImpl.getRTCPeerConnection",info:ls.streamNotExistInSubscription,path:Rs.prefix,context:this._context,channel:this._channel});return this.stream._getRTCPeerConnection()}getConnectionState(){if(!this.stream)throw gs({operationName:"SubscriptionImpl.getConnectionState",info:ls.streamNotExistInSubscription,path:Rs.prefix,context:this._context,channel:this._channel});return this.stream._getConnectionState()}};function As(e,{subscriberId:t,publicationId:i,id:n}){const r=e._getSubscription(n);if(r)return r;const s=e._getPublication(i),o=s.contentType,a=new Is({channel:e,id:n,subscriber:e._getMember(t),publication:e._getPublication(i),contentType:o});return a}var Ps=new si("packages/core/src/channel/index.ts"),Os=class{constructor(e,t){this._context=e,this._channelImpl=t,this.id=this._channelImpl.id,this.name=this._channelImpl.name,this.appId=this._context.appId,this.disposed=!1,this.config=this._context.config,this._state="opened",this._api=this._context._api,this._members={},this._getMember=e=>this._members[e],this._publications={},this._getPublication=e=>this._publications[e],this._subscriptions={},this._getSubscription=e=>this._subscriptions[e],this._events=new li,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this._onDisposed=this._events.make(),this.leave=e=>b(this,null,(function*(){return this._channelImpl.leave(this.id,e.id)})),this.updateMetadata=e=>this._channelImpl.updateChannelMetadata(e),this.close=()=>new Promise(((e,t)=>b(this,null,(function*(){if("closed"===this.state)return void t(gs({operationName:"SkyWayChannelImpl.close",path:Ps.prefix,info:ls.alreadyChannelClosed,channel:this,context:this._context,payload:this.toJSON()}));const i=Ps.info("[start] close channel",yield ms({operationName:"SkyWayChannelImpl.close",channel:this}));try{yield this._channelImpl.close().catch((e=>{const t=gs({operationName:"SkyWayChannelImpl.close",context:this._context,info:_(g({},ls.internal),{detail:"_api.deleteChannel failed"}),error:e,path:Ps.prefix,channel:this});throw t})),"closed"!==this._state&&(yield this.onClosed.asPromise(this._context.config.rtcApi.timeout).catch((e=>{const t=gs({operationName:"SkyWayChannelImpl.close",context:this._context,info:_(g({},ls.timeout),{detail:"channel.onClosed"}),error:e,path:Ps.prefix,channel:this});throw t})))}catch(n){Ps.error(n.message,n),t(n)}Ps.elapsed(i,"[end] close channel",yield ms({operationName:"SkyWayChannelImpl.close",channel:this})),e()})))),this._updateMemberTtl=(e,t)=>this._channelImpl.updateMemberTtl(e,t),this._updateMemberMetadata=(e,t)=>this._channelImpl.updateMemberMetadata(e,t),this._publish=e=>this._channelImpl.publish(e),this._unpublish=e=>b(this,null,(function*(){return this._channelImpl.unpublish(e)})),this._subscribe=(e,t)=>{const i=this._getPublication(t),n=this._getMember(e);if(void 0==n)throw gs({operationName:"SkyWayChannelImpl._subscribe",path:Ps.prefix,info:_(g({},ls.internal),{detail:"subscriber not found"}),channel:this,context:this._context,payload:{subscriberId:e,publicationId:t}});return this._channelImpl.subscribe({publication:i.toJSON(),subscriber:n.toJSON()})},this._unsubscribe=e=>b(this,null,(function*(){if(!this._getSubscription(e))throw gs({operationName:"SkyWayChannelImpl._unsubscribe",path:Ps.prefix,info:_(g({},ls.internal),{detail:"can't unsubscribe not exist subscription"}),channel:this,context:this._context,payload:{subscriptionId:e}});yield this._channelImpl.unsubscribe(e)})),this._updatePublicationMetadata=(e,t)=>this._channelImpl.updatePublicationMetadata(e,t),this._disablePublication=e=>this._channelImpl.disablePublication(e),this._enablePublication=e=>this._channelImpl.enablePublication(e),this._setupPropertiesFromChannel(),this._setupListenChannelEvent(),e._onDisposed.once((()=>{this.dispose()})),Ps.debug("channel spawned",this.toJSON())}_addMember(e){const t=this._getMember(e.id);if(t)return t;const i=this._context._createRemoteMember(this,e);return this._members[i.id]=i,i}_removeMember(e){delete this._members[e]}_addPublication(e){const t=this._getPublication(e.id);if(t)return t;const i=Cs(this,e);return this._publications[e.id]=i,i}_removePublication(e){delete this._publications[e]}_addSubscription(e){const t=this._getSubscription(e.id);if(t)return t;const i=As(this,e);return this._subscriptions[e.id]=i,i}_removeSubscription(e){delete this._subscriptions[e]}get localPerson(){return this._localPerson}get members(){return Object.values(this._members)}get bots(){return this.members.filter((e=>"bot"===e.type))}get publications(){return Object.values(this._publications)}get subscriptions(){return Object.values(this._subscriptions)}get metadata(){return this._channelImpl.metadata}get state(){return this._state}toJSON(){return{id:this.id,name:this.name,appId:this.appId,metadata:this.metadata,members:this.members,publications:this.publications,subscriptions:this.subscriptions}}_setupPropertiesFromChannel(){this._channelImpl.members.forEach((e=>{this._addMember(e)})),this._channelImpl.publications.forEach((e=>{this._addPublication(e)})),this._channelImpl.subscriptions.forEach((e=>{this._addSubscription(e)}))}_setupListenChannelEvent(){this._channelImpl.onClosed.add((()=>this._handleOnChannelClose())),this._channelImpl.onMetadataUpdated.add((({channel:e})=>this._handleOnChannelMetadataUpdate(e.metadata))),this._channelImpl.onMemberJoined.add((({member:e})=>{this._handleOnMemberJoin(e)})),this._channelImpl.onMemberLeft.add((({member:e})=>{this._handleOnMemberLeft(e)})),this._channelImpl.onMemberListChanged.pipe(this.onMemberListChanged),this._channelImpl.onMemberMetadataUpdated.add((({member:e})=>{this._handleOnMemberMetadataUpdate(e,e.metadata)})),this._channelImpl.onStreamPublished.add((({publication:e})=>{this._handleOnStreamPublish(e)})),this._channelImpl.onStreamUnpublished.add((({publication:e})=>{this._handleOnStreamUnpublish(e)})),this._channelImpl.onPublicationListChanged.pipe(this.onPublicationListChanged),this._channelImpl.onPublicationMetadataUpdated.add((({publication:e})=>{this._handleOnPublicationMetadataUpdate(e,e.metadata)})),this._channelImpl.onPublicationEnabled.add((e=>b(this,[e],(function*({publication:e}){return yield this._handleOnPublicationEnabled(e)})))),this._channelImpl.onPublicationDisabled.add((({publication:e})=>this._handleOnPublicationDisabled(e))),this._channelImpl.onPublicationSubscribed.add((({subscription:e})=>{this._handleOnStreamSubscribe(e)})),this._channelImpl.onPublicationUnsubscribed.add((({subscription:e})=>{this._handleOnStreamUnsubscribe(e)})),this._channelImpl.onSubscriptionListChanged.pipe(this.onSubscriptionListChanged)}_handleOnChannelClose(){this._state="closed",this.onClosed.emit({}),this.dispose()}_handleOnChannelMetadataUpdate(e){this.onMetadataUpdated.emit({metadata:e})}_handleOnMemberJoin(e){const t=this._addMember(e);this.onMemberJoined.emit({member:t})}_handleOnMemberLeft(e){var t;const i=this._getMember(e.id);this._removeMember(i.id),i._left(),(null==(t=this.localPerson)?void 0:t.id)===e.id&&(this.localPerson._left(),this._localPerson=void 0),this.onMemberLeft.emit({member:i})}_handleOnMemberMetadataUpdate(e,t){var i;const n=this._getMember(e.id);n._metadataUpdated(t),(null==(i=this.localPerson)?void 0:i.id)===e.id&&this.localPerson._metadataUpdated(t),this.onMemberMetadataUpdated.emit({member:n,metadata:t})}_handleOnStreamPublish(e){const t=this._addPublication(e);this.onStreamPublished.emit({publication:t})}_handleOnStreamUnpublish(e){const t=this._getPublication(e.id);this._removePublication(t.id),t._unpublished(),this.onStreamUnpublished.emit({publication:t})}_handleOnPublicationMetadataUpdate(e,t){const i=this._getPublication(e.id);i._updateMetadata(t),this.onPublicationMetadataUpdated.emit({publication:i,metadata:t})}_handleOnPublicationEnabled(e){return b(this,null,(function*(){const t=this._getPublication(e.id);t._enable(),this.onPublicationEnabled.emit({publication:t})}))}_handleOnPublicationDisabled(e){const t=this._getPublication(e.id);t._disable(),this.onPublicationDisabled.emit({publication:t})}_handleOnStreamSubscribe(e){const t=this._addSubscription(e),i=this._getPublication(t.publication.id);i._subscribed(t),this.onPublicationSubscribed.emit({subscription:t})}_handleOnStreamUnsubscribe(e){const t=this._getSubscription(e.id);this._removeSubscription(t.id),t._canceled();const i=this._getPublication(t.publication.id);i._unsubscribed(t),this.onPublicationUnsubscribed.emit({subscription:t})}join(){return b(this,arguments,(function*(e={}){var t,i;const n=Ps.info("[start] join",yield ms({operationName:"SkyWayChannelImpl.join",channel:this}));if(this._localPerson)throw gs({operationName:"SkyWayChannelImpl.join",path:Ps.prefix,info:ls.alreadyLocalPersonExist,channel:this,context:this._context});if(void 0!=e.name){const t=this.members.find((t=>t.name===e.name));if(t)throw gs({operationName:"SkyWayChannelImpl.join",path:Ps.prefix,info:ls.alreadySameNameMemberExist,channel:this,context:this._context,payload:e})}e.keepaliveIntervalSec=null!=(t=e.keepaliveIntervalSec)?t:this.config.member.keepaliveIntervalSec,e.keepaliveIntervalGapSec=null!=(i=e.keepaliveIntervalGapSec)?i:this.config.member.keepaliveIntervalGapSec;const r=_(g({},e),{type:"person",subtype:"person"});null!==e.keepaliveIntervalSec&&(r["ttlSec"]=(yield this._context._api.getServerUnixtimeInSec())+e.keepaliveIntervalSec);const s=yield this._channelImpl.joinChannel(r).catch((e=>{throw Ps.error("[failed] join",e),e}));Ps.elapsed(n,"[elapsed] join / channelImpl.joinChannel",{member:s});const o=yield this._createLocalPerson(s,{keepaliveIntervalSec:e.keepaliveIntervalSec,keepaliveIntervalGapSec:e.keepaliveIntervalGapSec}),a=new Xa(o);return Ps.elapsed(n,"[end] join",{person:o}),a}))}moveChannel(e){return b(this,null,(function*(){if(this._localPerson)throw gs({operationName:"SkyWayChannelImpl.moveChannel",path:Ps.prefix,info:ls.alreadyLocalPersonExist,channel:this,context:this._context});if(!(e instanceof Xa))throw gs({operationName:"SkyWayChannelImpl.moveChannel",path:Ps.prefix,info:ls.invalidArgumentValue,channel:this,context:this._context});const t=e.channel;if(this.id===t.id)throw gs({operationName:"SkyWayChannelImpl.moveChannel",path:Ps.prefix,info:ls.cantMoveSameIdChannel,channel:this,context:this._context});yield t.leave(e);const i={name:e.name,type:e.type,subtype:e.subtype,metadata:e.metadata};void 0!=e.keepaliveIntervalSec&&(i["ttlSec"]=(yield this._context._api.getServerUnixtimeInSec())+e.keepaliveIntervalSec);const n=yield this._channelImpl.joinChannel(i),r=yield this._createLocalPerson(n,{keepaliveIntervalSec:e.keepaliveIntervalSec,keepaliveIntervalGapSec:e.keepaliveIntervalSec});e.apply(r)}))}_createLocalPerson(e,t){return b(this,arguments,(function*(e,{keepaliveIntervalSec:t,keepaliveIntervalGapSec:i}){const n=yield Sc(this._context,this,e,{keepaliveIntervalSec:t,keepaliveIntervalGapSec:i});return this._localPerson=n,n}))}dispose(){this.disposed||(this.disposed=!0,Ps.debug("disposed",this.toJSON()),this._channelImpl.dispose(),this._onDisposed.emit(),this._events.dispose())}},Ns=class{static Create(e){return b(this,arguments,(function*(e,t={}){const i=Ps.info("[start] createChannel",{operationName:"SkyWayChannel.Create"}),n=yield e._api.createChannel(t).catch((e=>{throw Ps.error("[failed] createChannel",e),e})),r=new Os(e,n);return Ps.elapsed(i,"[end] createChannel"),r}))}static Find(e,t){return b(this,null,(function*(){const i=Ps.info("[start] findChannel",{operationName:"SkyWayChannel.Find"}),n=yield e._api.findChannel(t).catch((e=>{throw Ps.error("[failed] findChannel",e),e})),r=new Os(e,n);return Ps.elapsed(i,"[end] findChannel"),r}))}static FindOrCreate(e,t){return b(this,null,(function*(){const i=Ps.info("[start] findOrCreateChannel",{operationName:"SkyWayChannel.FindOrCreate"}),n=yield e._api.findOrCreateChannel(t).catch((e=>{throw Ps.error("[failed] findOrCreateChannel",e),e})),r=new Os(e,n);return Ps.elapsed(i,"[end] findOrCreateChannel"),r}))}constructor(){}};w(),w(),w(),w(),w(),w(),w();var Ds="rtc-api.skyway.ntt.com",ks=2e4,xs=8;w();var Ls={timeout:{name:"timeout",detail:"",solution:""},internalError:{name:"internalError",detail:"",solution:""},invalidParameter:{name:"invalidParameter",detail:"",solution:""},connectionDisconnected:{name:"connectionDisconnected",detail:"",solution:""},websocketConnectionFailure:{name:"connectionFailure",detail:"ãµã¼ãã¸ã®æ¥ç¶ã«å¤±æãã¾ãã",solution:"ãããã¯ã¼ã¯æ¥ç¶ç¶æ³ãç¢ºèªãã¦ãã ãã"},rpcResponseError:{name:"rpcResponseError",detail:"",solution:"",error:{}},onClosedWhileRequesting:{name:"onClosedWhileRequesting",detail:"requestä¸­ã«ã¯ã©ã¤ã¢ã³ããçµäºããã¾ãã",solution:"ãªã¯ã¨ã¹ãã®å®äºãç¢ºèªãã¦ããã¯ã©ã¤ã¢ã³ããçµäºããã¦ãã ãã"},failedToConnectRtcAPI:{name:"failedToConnectRtcAPI",detail:"rtc-api serverã¸ã®æ¥ç¶ã«å¤±æãã¾ãã",solution:"ã¤ã³ã¿ã¼ãããæ¥ç¶ç¶æ³ã¨Tokenã®åå®¹ãæ­£ããããç¢ºããã¦ãã ãã"},failedToUpdateMemberTTL:{name:"failedToUpdateMemberTTL",detail:"updateMemberTTLãåè©¦è¡ãã¾ããããå¤±æãã¾ãã",solution:"ã¤ã³ã¿ã¼ãããæ¥ç¶ç¶æ³ãç¢ºèªãã¦ãã ãã"}};w();var Ms,Fs=S(O());w(),w();var Us=new Uint8Array(16);function js(){if(!Ms&&(Ms="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!==typeof msCrypto&&"function"===typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),!Ms))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ms(Us)}w(),w(),w();var Vs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Bs(e){return"string"===typeof e&&Vs.test(e)}var Hs,Ws=Bs,Ks=[];for(Hs=0;Hs<256;++Hs)Ks.push((Hs+256).toString(16).substr(1));function Gs(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(Ks[e[t+0]]+Ks[e[t+1]]+Ks[e[t+2]]+Ks[e[t+3]]+"-"+Ks[e[t+4]]+Ks[e[t+5]]+"-"+Ks[e[t+6]]+Ks[e[t+7]]+"-"+Ks[e[t+8]]+Ks[e[t+9]]+"-"+Ks[e[t+10]]+Ks[e[t+11]]+Ks[e[t+12]]+Ks[e[t+13]]+Ks[e[t+14]]+Ks[e[t+15]]).toLowerCase();if(!Ws(i))throw TypeError("Stringified UUID is invalid");return i}var qs=Gs;function zs(e,t,i){e=e||{};var n=e.random||(e.rng||js)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=n[r];return t}return qs(n)}w();var Js=zs;function Ys({operationName:e,info:t,error:i,path:n,payload:r,channelId:s,appId:o,memberId:a}){return new ai({error:i,info:t,payload:{payload:r,operationName:e,channelId:s,appId:o,memberId:a},path:n})}function Xs({appId:e,detail:t,channelId:i,operationName:n,payload:r,memberId:s}){const o={operationName:n,payload:r,detail:t,appId:e,channelId:i,memberId:s};return o}w();var $s,Qs,Zs=new si("packages/rtc-rpc-api-client/src/rpc.ts"),eo=class{constructor(){this._id=Js(),this.closed=!1,this.negotiated=!1,this._reconnecting=!1,this._pendingRequests=[],this._events=new li,this._onMessage=this._events.make(),this.onNotify=this._events.make(),this.onFatalError=this._events.make(),this.onDisconnected=this._events.make(),this.onClosed=this._events.make(),this._send=e=>new Promise(((t,i)=>b(this,null,(function*(){yield new Promise((e=>setTimeout(e,0))),this._ws.readyState===this._ws.OPEN?(this._ws.send(JSON.stringify(e),(e=>{if(e)throw i(Ys({operationName:"RPC._send",info:_(g({},Ls.internalError),{detail:"failed to send rpc message"}),path:Zs.prefix,error:e}))})),t()):i(Ys({operationName:"RPC._send",info:_(g({},Ls.internalError),{detail:"wrong state"}),path:Zs.prefix,payload:{request:e,wsReadyState:no[this._ws.readyState]}}))}))))}set reconnecting(e){this._reconnecting=e}get reconnecting(){return this._reconnecting}connect(e){return b(this,arguments,(function*({domain:e,token:t,secure:i}){const n=t;this._ws=new Fs.default(`${i?"wss":"ws"}://${e}/ws`,n),this._ws.onmessage=e=>{this._onMessage.emit(JSON.parse(e.data))},this._ws.onclose=()=>b(this,null,(function*(){Zs.debug("websocket closed",{id:this._id}),this.onDisconnected.emit()})),this._onMessage.add((e=>{io(e)&&this.onNotify.emit(e)}));const r=yield new Promise(((e,t)=>{const i=setTimeout((()=>{t(Ys({operationName:"RPC.connect",info:_(g({},Ls.timeout),{detail:"ws.open"}),path:Zs.prefix}))}),1e4);this._ws.onerror=e=>{t(Ys({operationName:"RPC.connect",info:Ls.websocketConnectionFailure,path:Zs.prefix,error:e}))},this._ws.onopen=()=>{clearTimeout(i),e()}})).catch((e=>e));if(r)throw r;this.negotiated=!0}))}close(){this.closed||(this.closed=!0,Zs.debug("closed"),this._ws.close(),this.onClosed.emit(),this._events.dispose())}resolvePendingRequests(){Zs.debug("resolve pendingRequests",[...this._pendingRequests]),this._pendingRequests.forEach((e=>b(this,null,(function*(){yield this._send(e)})))),this._pendingRequests=[]}request(e,t){return b(this,null,(function*(){if(this.closed)throw Ys({operationName:"RPC.request",info:_(g({},Ls.internalError),{detail:"rpc closed"}),path:Zs.prefix,payload:{method:e,params:t,id:this._id}});let i=!1;try{const n=to(e,t),r=()=>b(this,null,(function*(){return yield this._onMessage.watch((e=>e.id===n.id),ks).catch((()=>{if(!i)throw Ys({operationName:"RPC.request",info:_(g({},Ls.timeout),{detail:"rpc request timeout"}),path:Zs.prefix,payload:{rpcTimeout:ks,method:e,params:t,wsReadyState:no[this._ws.readyState],id:this._id}})}))}));if(this._reconnecting){Zs.warn("[start] reconnecting. pending request",Xs({operationName:"RPC.request",detail:"[start] reconnecting. pending request",payload:{request:n,id:this._id}})),this._pendingRequests.push(n);const s=yield Promise.race([r(),this.onFatalError.asPromise(ks+100).then((e=>{throw i||Zs.error("[failed] reconnecting. pending request",Ys({operationName:"RPC.request",info:_(g({},Ls.internalError),{detail:"onFatalError while request"}),path:Zs.prefix}),e),e}))]);if(Zs.warn("[end] reconnecting. pending request",Xs({operationName:"RPC.request",detail:"[end] reconnecting. pending request",payload:{request:n,id:this._id}})),s.error)throw Ys({operationName:"RPC.request",info:_(g({},Ls.rpcResponseError),{detail:e,error:s.error}),payload:{message:s,method:e,params:t},path:Zs.prefix});return i=!0,s.result}{this._send(n).catch((e=>{throw e}));const s=yield Promise.race([r(),this.onFatalError.asPromise(ks+100).then((e=>{if(i)return{};throw Ys({operationName:"RPC.request",info:_(g({},Ls.internalError),{detail:"onFatalError while requesting"}),path:Zs.prefix,error:e})})),this.onDisconnected.asPromise(ks+100).then((()=>{if(i)return{};throw Ys({operationName:"RPC.request",info:Ls.connectionDisconnected,path:Zs.prefix})})),this.onClosed.asPromise(ks+100).then((()=>{if(i)return{};throw Ys({operationName:"RPC.request",info:Ls.onClosedWhileRequesting,path:Zs.prefix,payload:{method:e,params:t}})}))]);if(i=!0,s.error)throw Zs.warn("[failed] request ",{message:s,method:e,params:t}),Ys({operationName:"RPC.request",info:_(g({},Ls.rpcResponseError),{detail:e,error:s.error}),payload:{message:s,method:e,params:t},path:Zs.prefix});return s.result}}catch(n){throw i=!0,n}}))}notify(e,t){return b(this,null,(function*(){const i=to(e,t,!0);yield this._send(i)}))}batch(e){return b(this,null,(function*(){const t=e.map((({method:e,params:t})=>to(e,t)));this._send(t).catch((e=>{throw e}));const i=yield Promise.all(t.map((e=>b(this,[e],(function*({id:e}){const t=yield this._onMessage.watch((t=>t.id===e),ks);return t})))));return i}))}},to=(e,t,i)=>{if(i)return{jsonrpc:"2.0",method:e,params:t};const n=Js();return{jsonrpc:"2.0",method:e,params:t,id:n}},io=e=>{const t=e;return!(!t.method||void 0!=t.id)},no=["CONNECTING","OPEN","CLOSING","CLOSED"],ro=new si("packages/rtc-rpc-api-client/src/client.ts"),so=class{constructor(e){var t,i,n,r;this.config=e,this.closed=!1,this._domain=null!=($s=this.config.domain)?$s:Ds,this._secure=null==(Qs=this.config.secure)||Qs,this._token=this.config.token,this._rpc=new eo,this._subscribingChannelEvents=new Set,this._subscribingChannelVersions={},this._httpClient=new os(`http${this.config.secure?"s":""}://${this.config.domain}`),this._reconnectCount=0,this._reconnectLimit=xs,this._events=new li,this.onEvent=this._events.make(),this.onFatalError=this._events.make(),this.onClose=this._events.make(),this.onReconnected=this._events.make(),si.level=null!=(i=null==(t=e.log)?void 0:t.level)?i:si.level,si.format=null!=(r=null==(n=e.log)?void 0:n.format)?r:si.format,ro.debug("RtcRpcApiClient spawned",e),this._rpc.onNotify.add((e=>{if("channelEventNotification"===e.method){const t=e.params;this._subscribingChannelVersions[t.data.channel.id]=t.data.channel.version,this.onEvent.emit({channelId:t.data.channel.id,event:t})}})),this._rpc.onDisconnected.add((()=>b(this,null,(function*(){!this._rpc.negotiated||this._rpc.closed||this._rpc.reconnecting||(yield this._reconnect())})))),this._rpc.onFatalError.once((e=>{ro.error("fatal error",e),this.onFatalError.emit(e),this.close()}))}get token(){return this._token}_reconnect(){return b(this,null,(function*(){if(this._reconnectCount>=this._reconnectLimit)return this._rpc.onFatalError.emit(Ys({operationName:"RtcRpcApiClient._reconnect",info:{name:"failed to reconnect",detail:"_reconnectLimit exceeded",solution:""},path:ro.prefix})),void this.close();this._rpc.reconnecting=!0,ro.warn("[start] reconnect",Xs({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect start",payload:{reconnectCount:this._reconnectCount,limit:this._reconnectLimit}})),this._reconnectCount++;const e=100*m(this._reconnectCount,2)+100*m(this._reconnectCount,2)*Math.random();yield new Promise((t=>setTimeout(t,e)));try{yield this.connect().catch((e=>{throw ro.warn("[failed] reconnect rtc api",Xs({operationName:"RtcRpcApiClient._reconnect",detail:"connect rpc failed",payload:{reconnectCount:this._reconnectCount}}),e),e})),this._rpc.reconnecting=!1,this._reconnectCount=0,this._rpc.resolvePendingRequests(),yield Promise.all([...this._subscribingChannelEvents].map((e=>b(this,null,(function*(){const[t,i]=e.split(":"),n=this._subscribingChannelVersions[i];yield this.subscribeChannelEvents({appId:t,channelId:i,offset:n})}))))).catch((e=>{throw ro.warn("subscribeChannelEvents failed",Xs({operationName:"RtcRpcApiClient._reconnect",detail:"subscribeChannelEvents failed",payload:{reconnectCount:this._reconnectCount}}),e),e})),ro.warn("[end] reconnect",Xs({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect finished",payload:{reconnectCount:this._reconnectCount}})),this.onReconnected.emit()}catch(t){ro.warn("[failed] reconnect",Xs({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect failed",payload:{reconnectCount:this._reconnectCount}}),t),yield this._reconnect()}}))}updateToken(e){return b(this,null,(function*(){ro.debug("token update",{token:e}),this._token=e,yield this._updateAuthToken()}))}close(){this.closed||(this.closed=!0,ro.debug("closed"),this._rpc.close(),this.onClose.emit(),this._events.dispose())}health(){return b(this,null,(function*(){const e=yield this._httpClient.get("/health");return e}))}connect(){return b(this,null,(function*(){ro.debug("connect to rtc api rpc",this._domain),yield this._rpc.connect({domain:this._domain,token:this.token,secure:this._secure}).catch((e=>{throw Ys({operationName:"RtcRpcApiClient.connect",info:Ls.failedToConnectRtcAPI,error:e,path:ro.prefix})}))}))}_channelSubscribed(e,t){this._subscribingChannelEvents.add(e+":"+t),ro.debug("_channelSubscribed",{appId:e,channelId:t,_subscribingChannelEvents:[...this._subscribingChannelEvents]})}_isSubscribingChannel(e,t){return this._subscribingChannelEvents.has(e+":"+t)}createChannel(e){return b(this,arguments,(function*({name:e,metadata:t,appId:i}){const{channel:n}=yield this._rpc.request("createChannel",{name:e,metadata:t,appId:i,authToken:this.token});return this._channelSubscribed(i,n.id),n}))}findOrCreateChannel(e){return b(this,arguments,(function*({name:e,metadata:t,appId:i}){const{channel:n}=yield this._rpc.request("findOrCreateChannel",{name:e,metadata:t,appId:i,authToken:this.token});return this._channelSubscribed(i,n.id),n}))}getChannel(e){return b(this,arguments,(function*({appId:e,id:t}){const i=yield this._rpc.request("getChannel",{id:t,appId:e,authToken:this.token});return this._isSubscribingChannel(e,t)||(this._channelSubscribed(e,t),yield this.subscribeChannelEvents({appId:e,channelId:t,offset:i.channel.version})),i.channel}))}getChannelByName(e){return b(this,arguments,(function*({name:e,appId:t}){const i=yield this._rpc.request("getChannelByName",{name:e,appId:t,authToken:this.token}),n=i.channel.id;return this._isSubscribingChannel(t,n)||(this._channelSubscribed(t,n),yield this.subscribeChannelEvents({appId:t,channelId:n,offset:i.channel.version})),i.channel}))}deleteChannel(e){return b(this,arguments,(function*({id:e,appId:t}){yield this._rpc.request("deleteChannel",{id:e,appId:t,authToken:this.token})}))}updateChannelMetadata(e){return b(this,arguments,(function*({id:e,metadata:t,appId:i}){yield this._rpc.request("updateChannelMetadata",{id:e,metadata:t,appId:i,authToken:this.token})}))}addMember(e){return b(this,arguments,(function*({channelId:e,name:t,metadata:i,subscribeChannelEvents:n,appId:r,ttlSec:s,subtype:o,type:a}){const c=yield this._rpc.request("addMember",{channelId:e,name:t,metadata:i,subscribeChannelEvents:n,appId:r,ttlSec:s&&parseInt(s.toString()),authToken:this.token,subtype:o,type:a});return c}))}updateMemberTtl(e){return b(this,arguments,(function*(e,t=new cs({times:8})){const{appId:i,channelId:n,memberId:r,ttlSec:s}=e;try{yield this._rpc.request("updateMemberTtl",{appId:i,channelId:n,memberId:r,ttlSec:s&&parseInt(s.toString()),authToken:this.token})}catch(o){if(t.exceeded){const e=new ai({path:ro.prefix,info:Ls.failedToUpdateMemberTTL,error:o});throw e}ro.warn("retry updateMemberTtl",Xs({operationName:"RtcRpcApiClient.updateMemberTtl",detail:"retry updateMemberTtl",appId:i,channelId:n,memberId:r,payload:{backoff:t.count}}),o),yield t.wait(),yield this.updateMemberTtl(e,t)}}))}updateMemberMetadata(e){return b(this,arguments,(function*({channelId:e,memberId:t,metadata:i,appId:n}){yield this._rpc.request("updateMemberMetadata",{channelId:e,memberId:t,metadata:i,appId:n,authToken:this.token})}))}leaveChannel(e){return b(this,arguments,(function*({channelId:e,id:t,appId:i}){yield this._rpc.request("removeMember",{channelId:e,id:t,appId:i,authToken:this.token})}))}publishStream(e){return b(this,arguments,(function*({appId:e,channelId:t,publisherId:i,contentType:n,metadata:r,origin:s,codecCapabilities:o,encodings:a}){const c=yield this._rpc.request("publishStream",{channelId:t,publisherId:i,contentType:n[0].toUpperCase()+n.slice(1),metadata:r,origin:s,codecCapabilities:o,encodings:null==a?void 0:a.map((e=>({id:e.id}))),appId:e,authToken:this.token});return{publicationId:c.id}}))}disablePublication(e){return b(this,arguments,(function*({channelId:e,publicationId:t,appId:i}){yield this._rpc.request("disablePublication",{channelId:e,appId:i,publicationId:t,authToken:this.token})}))}enablePublication(e){return b(this,arguments,(function*({channelId:e,publicationId:t,appId:i}){yield this._rpc.request("enablePublication",{channelId:e,appId:i,publicationId:t,authToken:this.token})}))}updatePublicationMetadata(e){return b(this,arguments,(function*({channelId:e,publicationId:t,appId:i,metadata:n}){yield this._rpc.request("updatePublicationMetadata",{channelId:e,publicationId:t,metadata:n,appId:i,authToken:this.token})}))}unpublishStream(e){return b(this,arguments,(function*({channelId:e,publicationId:t,appId:i}){yield this._rpc.request("unpublishStream",{channelId:e,publicationId:t,appId:i,authToken:this.token})}))}subscribeStream(e){return b(this,arguments,(function*({channelId:e,subscriberId:t,publicationId:i,appId:n}){const r=yield this._rpc.request("subscribeStream",{channelId:e,subscriberId:t,publicationId:i,appId:n,authToken:this.token});return{subscriptionId:r.id}}))}unsubscribeStream(e){return b(this,arguments,(function*({channelId:e,subscriptionId:t,appId:i}){yield this._rpc.request("unsubscribeStream",{channelId:e,subscriptionId:t,appId:i,authToken:this.token})}))}getServerUnixtime(e){return b(this,arguments,(function*({appId:e}){const t=yield this._rpc.request("getServerUnixtime",{appId:e,authToken:this.token});return t.unixtime}))}_updateAuthToken(){return b(this,null,(function*(){yield this._rpc.request("updateAuthToken",{authToken:this.token})}))}subscribeChannelEvents(e){return b(this,arguments,(function*({appId:e,channelId:t,offset:i}){try{ro.debug("[start] subscribeChannelEvents",{offset:i}),yield this._rpc.request("subscribeChannelEvents",{appId:e,authToken:this.token,channelId:t,offset:i}),ro.debug("[end] subscribeChannelEvents",{offset:i})}catch(n){if(!(n instanceof ai&&n.info.name===Ls.connectionDisconnected.name))throw ro.error("[failed] subscribeChannelEvents",Ys({operationName:"RtcRpcApiClient.subscribeChannelEvents",info:_(g({},Ls.internalError),{detail:"subscribeChannelEvents failed"}),path:ro.prefix,error:n,payload:{offset:i},appId:e,channelId:t})),n;ro.warn("reconnect happened while subscribeChannelEvents. retry",Xs({operationName:"RtcRpcApiClient.subscribeChannelEvents",detail:"reconnect happened while subscribeChannelEvents. retry",appId:e,channelId:t,payload:{offset:i}}),n),yield this.subscribeChannelEvents({appId:e,channelId:t,offset:i})}}))}};w(),w();var oo=S(N()),ao=class{constructor(e={}){this.rtcApi={domain:"rtc-api.skyway.ntt.com",timeout:3e4,secure:!0,eventSubscribeTimeout:5e3},this.log={level:"error",format:"object"},Object.assign(this,(0,oo.default)(this,e))}};w(),w(),w();var co=S(D());function lo(e){this.message=e}w(),lo.prototype=new Error,lo.prototype.name="InvalidCharacterError";var ho="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new lo("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,n,r=0,s=0,o="";n=t.charAt(s++);~n&&(i=r%4?64*i+n:n,r++%4)?o+=String.fromCharCode(255&i>>(-2*r&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function uo(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(ho(e).replace(/(.)/g,(function(e,t){var i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i})))}(t)}catch(i){return ho(t)}}function po(e){this.message=e}function mo(e,t){if("string"!=typeof e)throw new po("Invalid token specified");var i=!0===(t=t||{}).header?0:1;try{return JSON.parse(uo(e.split(".")[i]))}catch(n){throw new po("Invalid token specified: "+n.message)}}po.prototype=new Error,po.prototype.name="InvalidTokenError";var fo=mo,go=new si("packages/token/src/encoder.ts"),_o=class{constructor(e){Object.assign(this,e)}static Decode(e){try{const t=fo(e),i=new _o(t);return i.tokenString=e,i}catch(t){throw new ai({path:go.prefix,info:vo.invalidParameter,error:t})}}encode(e){const t={jti:this.jti,iat:this.iat,exp:this.exp,scope:this.scope};return this.tokenString=co.default.KJUR.jws.JWS.sign("HS256",JSON.stringify({alg:"HS256",typ:"JWT"}),JSON.stringify(t),e),this.tokenString}toJSON(){return{jti:this.jti,iat:this.iat,exp:this.exp,scope:this.scope,encoded:this.tokenString}}};w();w();w(),w();var vo={invalidParameter:{name:"invalidParameter",detail:"failed to decode token",solution:"Use the correct token according to the specification"}};w();var yo=()=>Math.floor(Date.now()/1e3),Eo=Js;w();var So=_(g({},Ls),{invalidParameter:{name:"invalidParameter",detail:"",solution:""},notFound:{name:"notFound",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internalError:{name:"internalError",detail:"",solution:""},invalidRequestParameter:{name:"invalidRequestParameter",detail:"ãªã¯ã¨ã¹ãã®ãã©ã¡ã¼ã¿ã¼ãæ­£ããããã¾ãã",solution:"APIä»æ§ãç¢ºèªãæ­£ããå¤ãå¥åãã¦ãã ãã"},insufficientPermissions:{name:"insufficientPermissions",detail:"tokenã®æ¨©éãä¸è¶³ãã¦ãã¾ã Token permissions are insufficient",solution:"Tokenã«å¿è¦ãªæ¨©éãå ãã¦ãã ãã Add the necessary permissions to the Token"},publicationNestedTooMuch:{name:"publicationNestedTooMuch",detail:"originãè¨­å®ããã¦ããPublicationãPublicationã®originã«æå®ãããã¨ã¯åºæ¥ã¾ãã It is not possible to specify the origin of a publication for which Origin has been set",solution:"ä»æ§ä¸ã®å¶ç´ãªã®ã§è§£æ±ºæ³ã¯ããã¾ãã There is no solution because it is a specification limitation"},channelNotFound:{name:"channelNotFound",detail:"åç§ãããã¨ããchannelã¯å­å¨ãã¾ãã The channel you tried to reference does not exist.",solution:"channelIdãchannelNameãæ­£ãããç¢ºããã¦ãã ãã Make sure that the Channel id and channel name are correct."},memberNotFound:{name:"memberNotFound",detail:"åç§ãããã¨ããMemberã¯å­å¨ãã¾ãã The member you tried to reference does not exist.",solution:"memberIdãmemberNameãæ­£ãããç¢ºããã¦ãã ãã Make sure that the member id and member name is correct."},publicationNotFound:{name:"publicationNotFound",detail:"åç§ãããã¨ããPublicationã¯å­å¨ãã¾ãã The Publication you tried to reference does not exist.",solution:"publicationIdãæ­£ãããç¢ºããã¦ãã ãã Make sure that the publication id is correct."},subscriptionNotFound:{name:"subscriptionNotFound",detail:"åç§ãããã¨ããSubscriptionã¯å­å¨ãã¾ãã The Subscription you tried to reference does not exist.",solution:"subscriptionIdãæ­£ãããç¢ºããã¦ãã ãã Make sure that the subscription id is correct."},operationConflicted:{name:"operationConflicted",detail:"ä¸ããããååã®ãã£ãã«ã¯ãä»ã¾ã§ã®ç«¶åããè¦æ±ã«ãã£ã¦ããã§ã«ä½æããã¦ãã¾ã The channel with the given name has already been created by a conflicting request up to now",solution:"å¥ã®ååãä½¿ã£ã¦channelãä½æãã¦ãã ãã"},channelNameDuplicated:{name:"channelNameDuplicated",detail:"ãã®ååã®Channelã¯ãã§ã«å­å¨ãã¾ã A channel with that name already exists",solution:"å¥ã®ååãä½¿ã£ã¦channelãä½æãã¦ãã ãã"},memberNameDuplicated:{name:"memberNameDuplicated",detail:"ãã®ååã®Memberã¯ãã§ã«å­å¨ãã¾ã A member with that name already exists",solution:"å¥ã®ååãä½¿ã£ã¦memberãä½æãã¦ãã ãã"},subscriptionAlreadyExists:{name:"subscriptionAlreadyExists",detail:"Publicationã¯ãã§ã«Subscribeããã¦ãã¾ã",solution:"publicationIdãæ­£ãããç¢ºããã¦ãã ãã"},rateLimitExceeded:{name:"rateLimitExceeded",detail:"ãªã½ã¼ã¹ãè¦å®ä»æ§ä»¥ä¸ã«æ¶è²»ãã¦ãã¾ã",solution:"ãªã½ã¼ã¹ã®æ¶è²»éãæ¸ããã¦ãã ãã"},authTokenExpired:{name:"authTokenExpired",detail:"AuthTokenãæéåãã§ã",solution:"é©åãªExpãè¨­å®ããAuthTokenãä½¿ç¨ãã¦ãã ãã"},serverBusy:{name:"serverBusy",detail:"ãµã¼ãã¹å´ã®åé¡ã§ã",solution:"ãã°ããæéãç½®ãã¦åè©¦è¡ãã¦ãã ãã"}});Object.keys(So);function bo({appId:e,detail:t,channelId:i,operationName:n,payload:r}){const s={operationName:n,payload:r,detail:t,appId:e,channelId:i};return s}function wo({operationName:e,info:t,error:i,path:n,channelId:r,appId:s,payload:o}){return new ai({error:i,info:t,payload:{payload:o,operationName:e,channelId:r,appId:s},path:n})}w();var To=new si("packages/rtc-api-client/src/infrastructure/api.ts"),Co=class{constructor(e){this._client=e,this.closed=!1,this.onClose=new di,this.onFatalError=new di,this._token=_o.Decode(this._client.token),e.onClose.once((()=>{this.close()})),e.onFatalError.add((e=>{this.onFatalError.emit(e)}))}connect(){return b(this,null,(function*(){yield this._client.connect()}))}updateAuthToken(e){return b(this,null,(function*(){this._token=_o.Decode(e),yield this._client.updateToken(e)}))}close(){this.closed||(this.closed=!0,To.debug("closed"),this._client.close(),this.onClose.emit(),this.onClose.removeAllListeners())}_commonError(e,t,i){switch(t){case-32602:return wo({operationName:e,info:So.invalidRequestParameter,path:To.prefix,error:i});case-32603:return wo({operationName:e,info:So.internalError,path:To.prefix,error:i});case 403:case 4030:return wo({operationName:e,info:So.insufficientPermissions,path:To.prefix,error:i})}}createChannel(e,t){return b(this,null,(function*(){const{id:i}=yield this._client.createChannel({appId:e,name:t.name,metadata:t.metadata}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.createChannel",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.createChannel",path:To.prefix,info:So.channelNotFound,error:e});case 409:throw wo({operationName:"RtcApiImpl.createChannel",path:To.prefix,info:So.channelNameDuplicated,error:e});default:throw wo({operationName:"RtcApiImpl.createChannel",path:To.prefix,info:So.internalError,error:e})}})),n=yield this.getChannel(e,{id:i});return n}))}getChannel(e,t){return b(this,arguments,(function*(e,{name:t,id:i}){if(i)return yield this._client.getChannel({appId:e,id:i}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.getChannel",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.getChannel",path:To.prefix,info:So.channelNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.getChannel",path:To.prefix,info:So.internalError,error:e})}}));if(t)return yield this._client.getChannelByName({appId:e,name:t}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.getChannel",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"getChannel",path:To.prefix,info:So.channelNotFound,error:e});default:throw wo({operationName:"getChannel",path:To.prefix,info:So.internalError,error:e})}}));throw wo({operationName:"RtcApiImpl.createChannel",path:To.prefix,info:So.invalidRequestParameter})}))}findOrCreateChannel(e,t){return b(this,null,(function*(){return this._client.findOrCreateChannel(_(g({},t),{appId:e})).catch((i=>{var n,r,s,o;const{info:a}=i,c=this._commonError("RtcApiImpl.findOrCreateChannel",null!=(r=null==(n=null==a?void 0:a.error)?void 0:n.code)?r:-1,i);if(c)throw c;if(t.name&&409===(null==(s=null==a?void 0:a.error)?void 0:s.code))return this.getChannel(e,{name:t.name});switch(null==(o=null==a?void 0:a.error)?void 0:o.code){case 404:throw wo({operationName:"RtcApiImpl.findOrCreateChannel",path:To.prefix,info:So.channelNotFound,error:i});case 409:throw wo({operationName:"RtcApiImpl.findOrCreateChannel",path:To.prefix,info:So.channelNameDuplicated,error:i});default:throw wo({operationName:"RtcApiImpl.findOrCreateChannel",path:To.prefix,info:So.internalError,error:i})}}))}))}deleteChannel(e,t){return b(this,null,(function*(){yield this._client.deleteChannel({appId:e,id:t}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.deleteChannel",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.deleteChannel",path:To.prefix,info:So.channelNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.deleteChannel",path:To.prefix,info:So.internalError,error:e})}}))}))}updateChannelMetadata(e,t,i){return b(this,null,(function*(){yield this._client.updateChannelMetadata({appId:e,id:t,metadata:i}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.updateChannelMetadata",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.updateChannelMetadata",path:To.prefix,info:So.channelNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.updateChannelMetadata",path:To.prefix,info:So.internalError,error:e})}}))}))}join(e,t,i){return b(this,null,(function*(){const{memberId:n}=yield this._client.addMember({appId:e,channelId:t,name:i.name,metadata:i.metadata,ttlSec:i.ttlSec,type:i.type,subtype:i.subtype}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.addMember",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.addMember",path:To.prefix,info:So.channelNotFound,error:e});case 409:throw wo({operationName:"RtcApiImpl.addMember",path:To.prefix,info:So.memberNameDuplicated,error:e});default:throw wo({operationName:"RtcApiImpl.addMember",path:To.prefix,info:So.internalError,error:e})}})),r={id:n,name:i.name,type:i.type,subtype:i.subtype,metadata:i.metadata};return r}))}updateMemberTtl(e,t,i,n){return b(this,null,(function*(){yield this._client.updateMemberTtl({appId:e,channelId:t,memberId:i,ttlSec:n}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.updateMemberTtl",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.updateMemberTtl",path:To.prefix,info:So.memberNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.updateMemberTtl",path:To.prefix,info:So.internalError,error:e})}}))}))}getServerUnixtime(e){return b(this,null,(function*(){return yield this._client.getServerUnixtime({appId:e}).catch((e=>{var t,i;const{info:n}=e,r=this._commonError("RtcApiImpl.getServerUnixtime",null!=(i=null==(t=null==n?void 0:n.error)?void 0:t.code)?i:-1,e);if(r)throw r;throw wo({operationName:"RtcApiImpl.getServerUnixtime",path:To.prefix,info:So.internalError,error:e})}))}))}updateMemberMetadata(e,t,i,n){return b(this,null,(function*(){yield this._client.updateMemberMetadata({appId:e,channelId:t,memberId:i,metadata:n}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.updateMemberMetadata",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.updateMemberMetadata",path:To.prefix,info:So.memberNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.updateMemberMetadata",path:To.prefix,info:So.internalError,error:e})}}))}))}leave(e,t,i){return b(this,null,(function*(){yield this._client.leaveChannel({channelId:t,id:i,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.leaveChannel",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.leaveChannel",path:To.prefix,info:So.memberNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.leaveChannel",path:To.prefix,info:So.internalError,error:e})}}))}))}publish(e,t){return b(this,null,(function*(){var i,n;const{publicationId:r}=yield this._client.publishStream({channelId:t.channel,publisherId:t.publisher,contentType:t.contentType,metadata:t.metadata,origin:t.origin,codecCapabilities:t.codecCapabilities,encodings:t.encodings,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.publish",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){default:throw wo({operationName:"RtcApiImpl.publish",path:To.prefix,info:So.internalError,error:e})}})),s={id:r,channelId:t.channel,publisherId:t.publisher,origin:t.origin,contentType:t.contentType,metadata:t.metadata,codecCapabilities:null!=(i=t.codecCapabilities)?i:[],encodings:null!=(n=t.encodings)?n:[],isEnabled:!0};return s}))}updatePublicationMetadata(e,t,i,n){return b(this,null,(function*(){yield this._client.updatePublicationMetadata({channelId:t,publicationId:i,metadata:n,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.updatePublicationMetadata",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.updatePublicationMetadata",path:To.prefix,info:So.publicationNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.updatePublicationMetadata",path:To.prefix,info:So.internalError,error:e})}}))}))}disablePublication(e,t,i){return b(this,null,(function*(){yield this._client.disablePublication({channelId:t,publicationId:i,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.disablePublication",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.disablePublication",path:To.prefix,info:So.publicationNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.disablePublication",path:To.prefix,info:So.internalError,error:e})}}))}))}enablePublication(e,t,i){return b(this,null,(function*(){yield this._client.enablePublication({channelId:t,publicationId:i,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.enablePublication",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.enablePublication",path:To.prefix,info:So.publicationNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.enablePublication",path:To.prefix,info:So.internalError,error:e})}}))}))}unpublish(e,t,i){return b(this,null,(function*(){yield this._client.unpublishStream({channelId:t,publicationId:i,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.unpublishStream",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.unpublishStream",path:To.prefix,info:So.publicationNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.unpublishStream",path:To.prefix,info:So.internalError,error:e})}}))}))}subscribe(e,t){return b(this,null,(function*(){const{subscriptionId:i}=yield this._client.subscribeStream({channelId:t.channel.id,subscriberId:t.subscriber.id,publicationId:t.publication.id,appId:e}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.subscribeStream",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.subscribeStream",path:To.prefix,info:So.publicationNotFound,error:e});case 409:throw wo({operationName:"RtcApiImpl.subscribeStream",path:To.prefix,info:So.subscriptionAlreadyExists,error:e});default:throw wo({operationName:"RtcApiImpl.subscribeStream",path:To.prefix,info:So.internalError,error:e})}})),n={id:i,publicationId:t.publication.id,channelId:t.channel.id,publisherId:t.publication.publisherId,subscriberId:t.subscriber.id,contentType:t.publication.contentType};return n}))}unsubscribe(e,t,i){return b(this,null,(function*(){yield this._client.unsubscribeStream({appId:e,channelId:t,subscriptionId:i}).catch((e=>{var t,i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.unsubscribeStream",null!=(i=null==(t=null==r?void 0:r.error)?void 0:t.code)?i:-1,e);if(s)throw s;switch(null==(n=null==r?void 0:r.error)?void 0:n.code){case 404:throw wo({operationName:"RtcApiImpl.unsubscribeStream",path:To.prefix,info:So.publicationNotFound,error:e});default:throw wo({operationName:"RtcApiImpl.unsubscribeStream",path:To.prefix,info:So.internalError,error:e})}}))}))}};w();var Ro=new si("packages/rtc-api-client/src/infrastructure/eventObserver.ts"),Io=class{constructor(e,t,i,n){this.onEvent=new di,this._disposer=[];const r=new Ao(i.version,(s=>b(this,null,(function*(){yield t.subscribeChannelEvents({appId:e,channelId:i.id,offset:s}),yield new Promise((e=>setTimeout(e,n.eventSubscribeTimeout))),r.packetLostHappened&&Ro.error(wo({operationName:"EventObserverImpl.eventJitterBuffer",info:_(g({},So.internalError),{detail:"failed to resolve event lost"}),channelId:i.id,appId:e,path:Ro.prefix}))}))));this._disposer=[t.onEvent.add((e=>b(this,[e],(function*({channelId:e,event:t}){e===i.id&&r.push({event:t,version:t.data.channel.version})})))).removeListener,r.onEvent.add((e=>{this.onEvent.emit(e)})).removeListener]}dispose(){this._disposer.forEach((e=>e())),this.onEvent.removeAllListeners()}},Ao=class{constructor(e,t,i=1e3){this.presentVersion=e,this.onPacketLost=t,this.packetLifetime=i,this.onEvent=new di,this.eventBuffer={},this.packetLostHappened=!1}get expectNextVersion(){return this.presentVersion+1}push(e){const t=e.version;if(t<this.expectNextVersion)Ro.debug("duplicate event",_(g({},e),{presentVersion:this.presentVersion}));else{if(t>this.expectNextVersion)return Ro.debug("maybe miss order event received",_(g({},e),{presentVersion:this.presentVersion})),this.eventBuffer[t]=e,void this.handlePacketLifetime();this.packetLostHappened&&(Ro.warn("event packetLost resolved",bo({operationName:"EventJitterBuffer.push",detail:"event packetLost resolved",payload:{eventFrame:e}})),this.packetLostHappened=!1),this.eventBuffer[t]=e,this.resolveEvents()}}handlePacketLifetime(){const[e]=Object.keys(this.eventBuffer).sort().map((e=>this.eventBuffer[Number(e)]));void 0==this.packetLifeTimer&&e&&(Ro.debug("set event packetLost timer",_(g({},e),{presentVersion:this.presentVersion})),this.packetLifeTimer=setTimeout((()=>b(this,null,(function*(){if(this.presentVersion<e.version){if(Ro.warn("event packetLost",bo({operationName:"EventJitterBuffer.handlePacketLifetime",detail:"eventPacket lost",payload:{oldestBufferedEvent:e,eventBufferLength:Object.keys(this.eventBuffer).length,presentVersion:this.presentVersion}})),this.packetLostHappened)return;this.packetLostHappened=!0,yield this.onPacketLost(this.expectNextVersion)}this.packetLifeTimer=void 0,this.handlePacketLifetime()}))),this.packetLifetime))}resolveEvents(){const e=[];for(let t=this.expectNextVersion;;t++){const i=this.eventBuffer[t];if(!i)break;e.push(i),delete this.eventBuffer[t]}e.length>0&&(this.presentVersion=e.slice(-1)[0].version,e.forEach((e=>{this.onEvent.emit(e.event)})))}},Po=new si("packages/rtc-api-client/src/client.ts"),Oo=class{constructor(e,t,i,n){this.appId=e,this.config=t,this.apiClient=i,this._eventObserverFactory=n,this.closed=!1,this.onFatalError=new di,this.apiClient.onFatalError.pipe(this.onFatalError)}static Create(e){return b(this,null,(function*(){const t=new ao(e);t.log&&(si.level=t.log.level,si.format=t.log.format),Po.debug("RtcApiClient spawned",t);const i=new so(_(g({},t.rtcApi),{token:e.token,log:t.log})),n=new Co(i);yield n.connect();const r=(e,n)=>new Io(e,i,n,t.rtcApi);return new Oo(e.appId,t,n,r)}))}updateAuthToken(e){return b(this,null,(function*(){yield this.apiClient.updateAuthToken(e)}))}getServerUnixtimeInMs(){return b(this,null,(function*(){return this.apiClient.getServerUnixtime(this.appId)}))}getServerUnixtimeInSec(){return b(this,null,(function*(){return Math.floor((yield this.getServerUnixtimeInMs())/1e3)}))}createChannel(){return b(this,arguments,(function*(e={}){Po.debug("[start] apiClient.createChannel",{init:e});const t=yield this.apiClient.createChannel(this.appId,e).catch((t=>{throw Po.debug("[failed] apiClient.createChannel",{init:e,e:t}),t}));Po.debug("[end] apiClient.createChannel",{init:e,channelDto:t});const i=xo(this.appId,this._eventObserverFactory(this.appId,t),this.apiClient,t,this.config);return i}))}findChannel(e){return b(this,null,(function*(){Po.debug("[start] apiClient.getChannel",{query:e});const t=yield this.apiClient.getChannel(this.appId,e).catch((t=>{throw Po.debug("[failed] apiClient.getChannel",{query:e,e:t}),t})),i=xo(this.appId,this._eventObserverFactory(this.appId,t),this.apiClient,t,this.config);return Po.debug("[end] apiClient.getChannel",{channelId:i.id}),i}))}findOrCreateChannel(e){return b(this,null,(function*(){Po.debug("[start] apiClient.findOrCreateChannel",{query:e});const t=yield this.apiClient.findOrCreateChannel(this.appId,e).catch((t=>{throw Po.debug("[failed] apiClient.findOrCreateChannel",{query:e,e:t}),t}));Po.debug("[end] apiClient.findOrCreateChannel",{query:e});const i=xo(this.appId,this._eventObserverFactory(this.appId,t),this.apiClient,t,this.config);return i}))}deleteChannel(e){return this.apiClient.deleteChannel(this.appId,e)}close(){this.closed||(this.closed=!0,Po.debug("closed",{appid:this.appId}),this.apiClient.close())}};w(),w();var No={};w();var Do=new si("packages/rtc-api-client/src/domain/channel.ts"),ko=class{constructor(e,{id:t,name:i,members:n,metadata:r,publications:s,subscriptions:o,version:a},c,d,l){this.appId=e,this.eventObserver=c,this.apiClient=d,this.config=l,this.disposed=!1,this._events=new li,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.updateChannelMetadata=e=>new Promise(((t,i)=>{let n=!1;this.apiClient.updateChannelMetadata(this.appId,this.id,e).catch((e=>{n=!0,i(e)})),this.onMetadataUpdated.watch((t=>t.channel.metadata===e)).then((()=>t())).catch((e=>{n||i(wo({operationName:"ChannelImpl.updateChannelMetadata",info:_(g({},So.timeout),{detail:"onMetadataUpdated"}),path:Do.prefix,error:e,appId:this.appId,channelId:this.id}))}))})),this.leave=(e,t)=>new Promise(((i,n)=>{let r=!1;this.apiClient.leave(this.appId,e,t).catch((e=>{r=!0,n(e)})),this.onMemberLeft.watch((e=>e.member.id===t),this.config.rtcApi.timeout).then((()=>i())).catch((e=>{r||n(wo({operationName:"ChannelImpl.leave",info:_(g({},So.timeout),{detail:"onMemberLeft"}),path:Do.prefix,error:e,appId:this.appId,channelId:this.id}))}))})),this.updateMemberMetadata=(e,t)=>new Promise(((i,n)=>{let r=!1;this.apiClient.updateMemberMetadata(this.appId,this.id,e,t).catch((e=>{r=!0,n(e)})),this.onMemberMetadataUpdated.watch((i=>i.member.id===e&&i.member.metadata===t)).then((()=>i())).catch((e=>{r||n(wo({operationName:"ChannelImpl.updateMemberMetadata",info:_(g({},So.timeout),{detail:"onMemberMetadataUpdated"}),path:Do.prefix,error:e,appId:this.appId,channelId:this.id}))}))})),this.unpublish=e=>new Promise(((t,i)=>{let n=!1;this.apiClient.unpublish(this.appId,this.id,e).catch((e=>{n=!0,i(e)})),this.onStreamUnpublished.watch((t=>t.publication.id===e)).then((()=>t())).catch((t=>{n||i(wo({operationName:"ChannelImpl.unpublish",info:_(g({},So.timeout),{detail:"onStreamUnpublished"}),path:Do.prefix,error:t,payload:{publicationId:e},appId:this.appId,channelId:this.id}))}))})),this.updatePublicationMetadata=(e,t)=>new Promise(((i,n)=>{let r=!1;this.apiClient.updatePublicationMetadata(this.appId,this.id,e,t).catch((e=>{r=!0,n(e)})),this.onPublicationMetadataUpdated.watch((i=>i.publication.id===e&&i.publication.metadata===t)).then((()=>i())).catch((t=>{r||n(wo({operationName:"ChannelImpl.updatePublicationMetadata",info:_(g({},So.timeout),{detail:"onPublicationMetadataUpdated"}),path:Do.prefix,error:t,payload:{publicationId:e},appId:this.appId,channelId:this.id}))}))})),this.disablePublication=e=>new Promise(((t,i)=>{let n=!1;this.apiClient.disablePublication(this.appId,this.id,e).catch((e=>{n=!0,i(e)})),this.onPublicationDisabled.watch((t=>t.publication.id===e)).then((()=>t())).catch((t=>{n||i(wo({operationName:"ChannelImpl.disablePublication",info:_(g({},So.timeout),{detail:"onPublicationDisabled"}),path:Do.prefix,error:t,payload:{publicationId:e},appId:this.appId,channelId:this.id}))}))})),this.enablePublication=e=>new Promise(((t,i)=>{let n=!1;this.apiClient.enablePublication(this.appId,this.id,e).catch((e=>{n=!0,i(e)})),this.onPublicationEnabled.watch((t=>t.publication.id===e)).then((()=>t())).catch((t=>{n||i(wo({operationName:"ChannelImpl.enablePublication",info:_(g({},So.timeout),{detail:"onPublicationEnabled"}),path:Do.prefix,error:t,payload:{publicationId:e},appId:this.appId,channelId:this.id}))}))})),this.unsubscribe=e=>new Promise(((t,i)=>{let n=!1;this.apiClient.unsubscribe(this.appId,this.id,e).catch((e=>{n=!0,i(e)})),this.onPublicationUnsubscribed.watch((t=>t.subscription.id===e)).then((()=>t())).catch((t=>{n||i(wo({operationName:"ChannelImpl.unsubscribe",info:_(g({},So.timeout),{detail:"onPublicationUnsubscribed"}),path:Do.prefix,error:t,payload:{subscriptionId:e},appId:this.appId,channelId:this.id}))}))})),this.id=t,this.name=i,this.metadata=r,this.members=n,this.publications=s,this.subscriptions=o,this.version=a,c.onEvent.add((e=>{Do.debug("received event: ",e),this.version=e.data.channel.version;try{switch(e.type){case"ChannelDeleted":this._channelClosed();break;case"ChannelMetadataUpdated":this._channelMetadataUpdated(e.data);break;case"MemberAdded":this._memberJoined(e.data);break;case"MemberRemoved":this._memberLeft(e.data);break;case"MemberMetadataUpdated":this._memberMetadataUpdated(e.data);break;case"StreamPublished":this._streamPublished(e.data);break;case"StreamUnpublished":this._streamUnpublished(e.data);break;case"PublicationMetadataUpdated":this._publicationMetadataUpdated(e.data);break;case"PublicationDisabled":this._publicationDisabled(e.data);break;case"PublicationEnabled":this._publicationEnabled(e.data);break;case"StreamSubscribed":this._streamSubscribed(e.data);break;case"StreamUnsubscribed":this._streamUnsubscribed(e.data);break}}catch(t){Do.error(t)}})),d.onClose.once((()=>{this.dispose()}))}getMember(e){return this.members.find((t=>t.id===e))}addMember(e){const t=this.getMember(e.id);return t||(this.members.push(e),e)}deleteMember(e){this.members=this.members.filter((t=>t.id!==e))}getPublication(e){return this.publications.find((t=>t.id===e))}addPublication(e){var t,i;const n=this.getPublication(e.id);if(n)return n;const r=_(g({},e),{channelId:this.id,codecCapabilities:null!=(t=e.codecCapabilities)?t:[],encodings:null!=(i=e.encodings)?i:[]});return this.publications.push(r),r}deletePublication(e){this.publications=this.publications.filter((t=>t.id!==e))}getSubscription(e){return this.subscriptions.find((t=>t.id===e))}addSubscription(e){const t=this.getSubscription(e.id);if(t)return t;const i=this.getPublication(e.publicationId),n=_(g({},e),{channelId:this.id,publisherId:i.publisherId,contentType:i.contentType});return this.subscriptions.push(n),n}deleteSubscription(e){this.subscriptions=this.subscriptions.filter((t=>t.id!==e))}_channelClosed(){this.onClosed.emit({})}_channelMetadataUpdated(e){this.metadata=e.channel.metadata,this.onMetadataUpdated.emit(e)}_memberJoined(e){this.addMember(e.member),this.onMemberJoined.emit(e),this.onMemberListChanged.emit({})}_memberLeft(e){const t=this.getMember(e.member.id);if(!t)throw wo({operationName:"ChannelImpl._memberLeft",info:So.memberNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});this.deleteMember(t.id),this.onMemberLeft.emit({member:t}),this.onMemberListChanged.emit({})}_memberMetadataUpdated(e){const t=this.getMember(e.member.id);if(!t)throw wo({operationName:"ChannelImpl._memberMetadataUpdated",info:So.memberNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});t.metadata=e.member.metadata,this.onMemberMetadataUpdated.emit(e)}_streamPublished(e){const t=this.addPublication(e.publication),i=_(g({},e),{publication:t});this.onStreamPublished.emit(i),this.onPublicationListChanged.emit({})}_streamUnpublished(e){const t=this.getPublication(e.publication.id);if(!t)throw wo({operationName:"ChannelImpl._streamUnpublished",info:So.publicationNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});this.deletePublication(t.id);const i=_(g({},e),{publication:t});this.onStreamUnpublished.emit(i),this.onPublicationListChanged.emit({})}_publicationMetadataUpdated(e){const t=this.getPublication(e.publication.id);if(!t)throw wo({operationName:"ChannelImpl._publicationMetadataUpdated",info:So.publicationNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});t.metadata=e.publication.metadata;const i=_(g({},e),{publication:t});this.onPublicationMetadataUpdated.emit(i)}_publicationDisabled(e){const t=this.getPublication(e.publication.id);if(!t)throw wo({operationName:"ChannelImpl._publicationDisabled",info:So.publicationNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});t.isEnabled=e.publication.isEnabled;const i={publication:t};this.onPublicationDisabled.emit(i)}_publicationEnabled(e){const t=this.getPublication(e.publication.id);if(!t)throw wo({operationName:"ChannelImpl._publicationEnabled",info:So.publicationNotFound,path:Do.prefix,payload:{event:No},appId:this.appId,channelId:this.id});t.isEnabled=e.publication.isEnabled;const i={publication:t};this.onPublicationEnabled.emit(i)}_streamSubscribed(e){const t=this.addSubscription(e.subscription),i=_(g({},e),{subscription:t});this.onPublicationSubscribed.emit(i),this.onSubscriptionListChanged.emit({})}_streamUnsubscribed(e){const t=this.getSubscription(e.subscription.id);if(!t)throw wo({operationName:"ChannelImpl._streamUnsubscribed",info:So.subscriptionNotFound,path:Do.prefix,payload:{event:e},appId:this.appId,channelId:this.id});this.deleteSubscription(t.id);const i=_(g({},e),{subscription:t});this.onPublicationUnsubscribed.emit(i),this.onSubscriptionListChanged.emit({})}joinChannel(e){return b(this,null,(function*(){var t;e.type&&(e.type=e.type[0].toUpperCase()+e.type.slice(1)),e.subtype&&(e.subtype=e.subtype[0].toUpperCase()+e.subtype.slice(1)),Do.debug("[start] joinChannel",{memberInit:e});const i=yield this.apiClient.join(this.appId,this.id,g({},e)),n=null!=(t=this.getMember(i.id))?t:(yield this.onMemberJoined.watch((e=>e.member.id===i.id),this.config.rtcApi.timeout).catch((e=>{throw wo({operationName:"ChannelImpl.joinChannel",info:_(g({},So.timeout),{detail:"onMemberJoined"}),path:Do.prefix,error:e,appId:this.appId,channelId:this.id})}))).member;return Do.debug("[end] joinChannel",{member:n}),n}))}updateMemberTtl(e,t){return this.apiClient.updateMemberTtl(this.appId,this.id,e,t)}publish(e){return b(this,null,(function*(){const t=Do.debug("[start] apiClient.publish",{init:e}),i=yield this.apiClient.publish(this.appId,_(g({},e),{channel:this.id}));Do.elapsed(t,"[ongoing] apiClient.publish",{publicationDto:i});const n=this.getPublication(i.id);if(n)return n;const{publication:r}=yield this.onStreamPublished.watch((e=>e.publication.id===i.id),this.config.rtcApi.timeout).catch((e=>{throw wo({operationName:"ChannelImpl.publish",info:_(g({},So.timeout),{detail:"onStreamPublished"}),path:Do.prefix,error:e,payload:{publicationDto:i},appId:this.appId,channelId:this.id})}));return Do.elapsed(t,"[end] apiClient.publish",{publicationDto:i}),r}))}subscribe(e){return b(this,null,(function*(){const t=Do.debug("[start] apiClient.subscribe",{init:e}),i=yield this.apiClient.subscribe(this.appId,_(g({},e),{channel:this}));Do.elapsed(t,"[ongoing] apiClient.subscribe",{subscriptionDto:i});const n=this.getSubscription(i.id);if(n)return Do.elapsed(t,"[end] apiClient.subscribe",{subscriptionDto:i}),n;const{subscription:r}=yield this.onPublicationSubscribed.watch((e=>e.subscription.id===i.id),this.config.rtcApi.timeout).catch((e=>{throw Do.elapsed(t,"[fail] apiClient.subscribe",e),wo({operationName:"ChannelImpl.subscribe",info:_(g({},So.timeout),{detail:"onPublicationSubscribed"}),path:Do.prefix,error:e,payload:{subscriptionDto:i}})}));return Do.elapsed(t,"[end] apiClient.subscribe",{subscriptionDto:i}),r}))}close(){return this.apiClient.deleteChannel(this.appId,this.id)}dispose(){this.disposed||(this.disposed=!0,Do.debug("disposed",{id:this.id}),this.eventObserver.dispose(),this._events.dispose())}};function xo(e,t,i,n,r){const s=new ko(e,n,t,i,r);return s}var Lo=S(N()),Mo=class{constructor(e={}){this.rtcApi={domain:"rtc-api.skyway.ntt.com",timeout:3e4,secure:!0,eventSubscribeTimeout:5e3},this.iceParamServer={domain:"ice-params.skyway.ntt.com",version:1,secure:!0},this.signalingService={domain:"signaling.skyway.ntt.com",secure:!0},this.rtcConfig={timeout:3e4,turnPolicy:"enable",turnProtocol:"all",encodedInsertableStreams:!1},this.token={updateReminderSec:30},this.log={level:"error",format:"string"},this.internal={disableDPlane:!1,disableSignaling:!1},this.member={keepaliveIntervalGapSec:30,keepaliveIntervalSec:30},Object.assign(this,(0,Lo.default)(this,e))}};w(),w(),w();var Fo=class{constructor(){this._onContextAttached=new di}_attachContext(e){this._context=e,this._onContextAttached.emit(e)}};w();var Uo=new si("packages/core/src/plugin/internal/person/connection/messageBuffer.ts"),jo=class{constructor(e){this.signaling=e,this._indicateMessageBuffer={},this._excludeConnectionIndicateBuffering=new Set,this._disposer=new hi,this.signaling.onMessage.add((e=>{const t=e.src.id+e.src.name;this._excludeConnectionIndicateBuffering.has(t)||(this._indicateMessageBuffer[t]||(this._indicateMessageBuffer[t]=[]),this._indicateMessageBuffer[t].push(e))})).disposer(this._disposer)}resolveMessagingBuffer({id:e,name:t}){const i=e+t,n=this._indicateMessageBuffer[i];(null==n?void 0:n.length)>0&&(Uo.debug("resolveMessagingBuffer",{length:n.length}),n.forEach((e=>{this.signaling.onMessage.emit(e)})),delete this._indicateMessageBuffer[i]),this._excludeConnectionIndicateBuffering.add(i)}close(){this._disposer.dispose(),this._indicateMessageBuffer={},this._excludeConnectionIndicateBuffering=new Set}};w(),w();var Vo=new si("packages/core/src/member/index.ts"),Bo=class{constructor(e){this._state="joined",this._events=new li,this.onLeft=this._events.make(),this.onMetadataUpdated=this._events.make(),this.channel=e.channel,this.id=e.id,this.name=e.name,this._metadata=e.metadata,this.context=e.context}get metadata(){return this._metadata}get state(){return this._state}get publications(){return this.channel.publications.filter((e=>e.publisher.id===this.id))}get subscriptions(){return this.channel.subscriptions.filter((e=>e.subscriber.id===this.id))}toJSON(){return{id:this.id,name:this.name,type:this.type,subtype:this.subtype,metadata:this.metadata}}_left(){this._state="left",this.onLeft.emit(),this._events.dispose()}_metadataUpdated(e){this._metadata=e,this.onMetadataUpdated.emit(e)}updateMetadata(e){return b(this,null,(function*(){yield this.channel._updateMemberMetadata(this.id,e)}))}leave(){return b(this,null,(function*(){const e=Vo.info("[start] leave",yield ms({operationName:"localPerson.leave",channel:this.channel}));if("left"===this.state)throw gs({operationName:"localPerson.leave",info:ls.localPersonNotJoinedChannel,path:Vo.prefix,context:this.context,channel:this.channel});yield this.channel.leave(this),Vo.elapsed(e,"[end] leave")}))}};w(),w();var Ho=S(P());w(),w(),w(),w();var Wo=new si("packages/core/src/media/stream/share.ts");function Ko(e,t){var i;if(void 0===(null==(i=null!=e?e:{})?void 0:i.srcObject))throw gs({operationName:"attachElement",info:ls.invalidElement,payload:{element:e},path:Wo.prefix});if(e.srcObject){const i=e.srcObject,n=i.getTracks().find((e=>"ended"===e.readyState));n&&i.removeTrack(n);const r=i.getTracks().find((e=>e.kind===t.kind));r&&i.removeTrack(r),i.addTrack(t)}else e.srcObject=new MediaStream([t])}function Go(e,t){var i;if(void 0===(null==(i=null!=e?e:{})?void 0:i.srcObject))throw gs({operationName:"attachElement",info:ls.invalidElement,payload:{element:e},path:Wo.prefix});const n=e.srcObject;n.getTracks().length>0&&n.removeTrack(t),0===n.getTracks().length&&(e.srcObject=null)}w();var qo=class{constructor(e,t){this.id=e,this.contentType=t,this.side="remote",this.onConnectionStateChanged=new di,this._getTransport=()=>{},this.getStats=()=>this._getStats(),this._getStats=()=>b(this,null,(function*(){return[]}))}getRTCPeerConnection(){return this._getRTCPeerConnection()}_getRTCPeerConnection(){var e;return null==(e=this._getTransport())?void 0:e.rtcPeerConnection}getConnectionState(){return this._getConnectionState()}_getConnectionState(){var e,t;return null!=(t=null==(e=this._getTransport())?void 0:e.connectionState)?t:"new"}toJSON(){return{contentType:this.contentType,id:this.id,codec:this.codec,side:this.side}}},zo=class extends qo{constructor(e,t,i){super(e,t),this.id=e,this.contentType=t,this.track=i}get isEnabled(){return this.track.enabled}setIsEnabled(e){this.track.enabled=e}attach(e){this._element=e,Ko(e,this.track)}detach(){this._element&&(Go(this._element,this.track),this._element=void 0)}},Jo=class extends zo{constructor(e,t){super(e,"audio",t),this.track=t,this.contentType="audio"}};w(),w(),w(),w();var Yo=class{constructor(e){this.contentType=e,this.side="local",this.onConnectionStateChanged=new di,this.id=Eo(),this._label="",this.published=!1,this._getTransportCallbacks={},this._getStatsCallbacks={}}_setLabel(e){this._label=e}_unpublished(){this.published=!1,this._getTransportCallbacks={},this._getStatsCallbacks={}}_getTransport(e){var t,i;const n="string"===typeof e?e:e.id;return null==(i=(t=this._getTransportCallbacks)[n])?void 0:i.call(t)}getStats(e){return this._getStats(e)}_getStats(e){var t,i,n;const r="string"===typeof e?e:e.id;return null!=(n=null==(i=(t=this._getStatsCallbacks)[r])?void 0:i.call(t))?n:[]}_getStatsAll(){return Promise.all(Object.entries(this._getStatsCallbacks).map((e=>b(this,[e],(function*([e,t]){return{memberId:e,stats:yield t().catch((()=>[]))}})))))}getRTCPeerConnection(e){return this._getRTCPeerConnection(e)}_getRTCPeerConnection(e){var t;return null==(t=this._getTransport(e))?void 0:t.rtcPeerConnection}getConnectionState(e){return this._getConnectionState(e)}_getConnectionState(e){var t,i;return null!=(i=null==(t=this._getTransport(e))?void 0:t.connectionState)?i:"new"}_getConnectionStateAll(){return Object.entries(this._getTransportCallbacks).map((([e,t])=>({memberId:e,connectionState:t().connectionState})))}toJSON(){return{label:this._label,contentType:this.contentType,id:this.id,side:this.side}}};w();var Xo=class extends Yo{constructor(e,t,i={}){super(t),this.onTrackUpdated=new di,this._trackConstraints={},this._onEnableChanged=new di,this._track=e,this._options=i,this._trackConstraints=g({},i)}get trackConstraints(){return this._trackConstraints}toJSON(){const e=super.toJSON();return _(g({},e),{trackConstraints:this.trackConstraints,isEnabled:this.isEnabled,_options:this._options})}get track(){return this._track}attach(e){this._element=e,Ko(e,this._track)}detach(){this._element&&(Go(this._element,this._track),this._element=void 0)}_disable(e){this._options.stopTrackWhenDisabled?(this._trackConstraints=g(g({},this.trackConstraints),this.track.getConstraints()),this.track.stop()):this._oldTrack=this.track;const t=$o(e);t.enabled=!1,this._onEnableChanged.emit(t),this._updateTrack(t)}_updateTrack(e){this._track=e,this._element&&this.attach(this._element),this.onTrackUpdated.emit(e)}release(){this._track.stop()}};function $o(e){const t=new RTCPeerConnection,i=t.addTransceiver(e).receiver.track;return i}var Qo=new si("packages/core/src/media/stream/local/data.ts"),Zo=class extends Yo{constructor(e={}){super("data"),this.options=e,this.contentType="data",this._onWriteData=new di,this._isEnabled=!0,this._setLabel("LocalDataStream")}get isEnabled(){return this._isEnabled}setIsEnabled(e){this._isEnabled=e}write(e){if(!this._isEnabled)throw gs({operationName:"LocalDataStream.write",path:Qo.prefix,info:ls.disabledDataStream});ArrayBuffer.isView(e)||"string"===typeof e||(e=ea+JSON.stringify(e)),this._onWriteData.emit(e)}},ea="skyway_object:",ta=class extends qo{constructor(e,t){super(e,"data"),this._datachannel=t,this._isEnabled=!0,this.contentType="data",this.onData=new di,t.onmessage=({data:e})=>{this.isEnabled&&("string"===typeof e&&e.includes(ea)&&(e=JSON.parse(e.slice(ea.length))),this.onData.emit(e))}}get isEnabled(){return this._isEnabled}setIsEnabled(e){this._isEnabled=e}};w();var ia=class extends zo{constructor(e,t){super(e,"video",t),this.track=t,this.contentType="video"}},na=new si("packages/core/src/media/stream/remote/factory.ts"),ra=(e,t,i)=>{if(t instanceof RTCDataChannel){const n=new ta(e,t);return n.codec=i,n}if("audio"===t.kind){const n=new Jo(e,t);return n.codec=i,n}if("video"===t.kind){const n=new ia(e,t);return n.codec=i,n}throw gs({operationName:"createRemoteStream",path:na.prefix,info:_(g({},ls.invalidArgumentValue),{detail:"invalid stream type"})})};w();var sa=class{constructor(e,t){this.publicationId=e,this.streamId=t}static fromLabel(e){const{p:t,s:i}=JSON.parse(e);return new sa(t,i)}toLabel(){return JSON.stringify({p:this.publicationId,s:this.streamId})}};w();var oa=new si("packages/core/src/plugin/internal/person/connection/peer.ts"),aa=class{constructor(e,t,i,n,r,s){var o;this._context=e,this._iceManager=t,this.signaling=i,this.localPerson=n,this.endpoint=r,this.role=s,this._pendingCandidates=[],this.pc=new RTCPeerConnection(_(g({},this._context.config.rtcConfig),{iceTransportPolicy:"turnOnly"===this._context.config.rtcConfig.turnPolicy?"relay":void 0,iceServers:this._iceManager.iceServers})),this.onSignalingStateChanged=new di,this.onPeerConnectionStateChanged=new di,this.onDisconnect=new di,this.connected=!1,this.disconnected=!1,this._onICECandidate=e=>b(this,null,(function*(){if(null==e.candidate||""===e.candidate||"closed"===this.pc.connectionState)return;const t={kind:"iceCandidateMessage",payload:{candidate:e.candidate,role:this.role}};oa.debug("[start] send candidate",{message:t,localPerson:this.localPerson});try{yield this.signaling.send(this.endpoint,t),oa.debug("[end] send candidate",{message:t,localPerson:this.localPerson})}catch(i){oa.warn("[failed] send candidate",fs({operationName:"Peer._onICECandidate",channel:this.localPerson.channel,detail:"[failed] send candidate",payload:{message:t}}),i)}})),this._onConnectionStateChange=()=>b(this,null,(function*(){const e=this.pc.connectionState;switch(oa.debug("_onConnectionStateChange",this.localPerson.id,e),e){case"connected":this.connected=!0,this._pendingCandidates=[];break}this.onPeerConnectionStateChanged.emit(this.pc.connectionState)})),this.waitForSignalingState=(e,t=1e4)=>b(this,null,(function*(){this.pc.signalingState!==e&&(yield this.onSignalingStateChanged.watch((()=>this.pc.signalingState===e),t).catch((e=>{throw gs({operationName:"Peer.waitForSignalingState",info:_(g({},ls.timeout),{detail:"waitForSignalingState timeout"}),path:oa.prefix,context:this._context,channel:this.localPerson.channel,error:e})})))})),this.waitForConnectionState=(e,t=1e4)=>b(this,null,(function*(){e!==this.pc.connectionState&&(yield this.onPeerConnectionStateChanged.watch((()=>e===this.pc.connectionState),t).catch((e=>{throw gs({operationName:"Peer.waitForConnectionState",info:_(g({},ls.timeout),{detail:"waitForConnectionState timeout"}),path:oa.prefix,context:this._context,channel:this.localPerson.channel,error:e})})))})),this.waitForStats=(e,t,i=100,n=1e4)=>b(this,null,(function*(){for(let r=0;;r+=i){if(r>=n)throw gs({operationName:"Peer.waitForStats",info:_(g({},ls.timeout),{detail:"waitForStats timeout"}),path:oa.prefix,context:this._context,channel:this.localPerson.channel});const s=yield this.pc.getStats(e),o=ga(s);if(t(o))break;yield new Promise((e=>setTimeout(e,i)))}})),oa.debug("peerConfig",this.pc.getConfiguration()),this.setPeerConnectionListener();const a=null==(o=this.pc)?void 0:o.peerIdentity;a&&a.catch((e=>{oa.debug("firefox peerIdentity",e)}))}setPeerConnectionListener(){this.pc.onicecandidate=this._onICECandidate,this.pc.onconnectionstatechange=this._onConnectionStateChange,this.pc.onsignalingstatechange=()=>this.onSignalingStateChanged.emit(this.pc.signalingState)}unSetPeerConnectionListener(){this.pc.onicecandidate=null,this.pc.onconnectionstatechange=null,this.pc.onsignalingstatechange=null}handleCandidate(e){return b(this,null,(function*(){this._pendingCandidates.push(e),this.pc.remoteDescription&&(yield this.resolveCandidates())}))}resolveCandidates(){return b(this,null,(function*(){const e=[...this._pendingCandidates];this._pendingCandidates=[],oa.debug("addIceCandidates",e),yield Promise.all(e.map((e=>{"closed"!==this.pc.signalingState&&this.pc.addIceCandidate(e).catch((e=>{oa.warn("[failed] add ice candidate",fs({operationName:"Peer.resolveCandidates",channel:this.localPerson.channel,detail:"[failed] send candidate",payload:{endpointId:this.endpoint.id}}),e)}))})))}))}},ca=new si("packages/core/src/plugin/internal/person/connection/receiver.ts"),da=class extends aa{constructor(e,t,i,n,r){super(e,t,i,n,r,"receiver"),this.id=Eo(),this.onConnectionStateChanged=new di,this.onStreamAdded=new di,this.onError=new di,this._connectionState="new",this._publicationInfo={},this.streams={},this._subscriptions={},this._promiseQueue=new as,this._disposer=new hi,this._log=ca.createBlock({localPersonId:this.localPerson.id,id:this.id}),this._log.debug("spawned"),this.signaling.onMessage.add((e=>b(this,[e],(function*({src:e,data:t}){if(e.id!==r.id||e.name!==r.name)return;const i=t;switch(i.kind){case"senderProduceMessage":this._promiseQueue.push((()=>this._handleSenderProduce(i.payload))).catch((e=>this._log.error("handle senderProduceMessage failed",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id})));break;case"senderUnproduceMessage":this._promiseQueue.push((()=>this._handleSenderUnproduce(i.payload))).catch((e=>this._log.error("handle handleSenderUnproduce",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id})));break;case"senderRestartIceMessage":this._promiseQueue.push((()=>this._handleSenderRestartIce(i.payload))).catch((e=>this._log.error("_handleSenderRestartIce",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id})));break;case"iceCandidateMessage":{const{role:e,candidate:t}=i.payload;"sender"===e&&(yield this.handleCandidate(t))}break}})))).disposer(this._disposer),this.pc.ontrack=({track:e,transceiver:t})=>{if(!t.mid)throw gs({operationName:"Receiver.pc.ontrack",info:_(g({},ls.missingProperty),{detail:"mid missing"}),path:ca.prefix,context:this._context,channel:this.localPerson.channel});const i=Object.values(this._publicationInfo).find((e=>{var i;return e.mid===(null==(i=t.mid)?void 0:i.toString())}));if(!i){const e=gs({operationName:"Receiver.pc.ontrack",info:_(g({},ls.notFound),{detail:"publicationInfo not found"}),path:ca.prefix,context:this._context,channel:n.channel,payload:{endpointId:this.endpoint.id,publicationInfo:this._publicationInfo,mid:t.mid}});return this.onError.emit(e),void this._log.error(e)}const r=Ho.parse(this.pc.remoteDescription.sdp),s=this._getCodecFromSdp(r,t,e.kind),o=ra(i.streamId,e,s);o.codec=s,this._setupTransportAccessForStream(o),this.streams[i.publicationId]=o,this._log.debug("MediaStreamTrack added",i,e,s),this.onStreamAdded.emit({publicationId:i.publicationId,stream:o})},this.pc.ondatachannel=({channel:e})=>{const{publicationId:t,streamId:i}=sa.fromLabel(e.label),n={mimeType:"datachannel"},r=ra(i,e,n);this._setupTransportAccessForStream(r),this.streams[t]=r,this._log.debug("DataChannel added",t,e,n),this.onStreamAdded.emit({publicationId:t,stream:r})},this.onPeerConnectionStateChanged.add((e=>{switch(e){case"connecting":case"connected":this._setConnectionState(e);break;case"failed":case"closed":this._setConnectionState("disconnected");break}})).disposer(this._disposer)}_setConnectionState(e){this._connectionState!==e&&(this._log.debug("onConnectionStateChanged",e),this._connectionState=e,this.onConnectionStateChanged.emit(e))}_setupTransportAccessForStream(e){e._getTransport=()=>({rtcPeerConnection:this.pc,connectionState:fa(this.pc.connectionState)}),e._getStats=()=>b(this,null,(function*(){if("data"===e.contentType){const e=yield this.pc.getStats(),t=ps(e);return t}const t=yield this.pc.getStats(e.track),i=ps(t);return i})),this._disposer.push((()=>{e._getTransport=()=>{}})),this.onConnectionStateChanged.add((t=>{e.onConnectionStateChanged.emit(t)})).disposer(this._disposer)}_getCodecFromSdp(e,t,i){const n=e.media.find((e=>{var i,n;return(null==(i=e.mid)?void 0:i.toString())===(null==(n=t.mid)?void 0:n.toString())}));if(!n)throw gs({operationName:"Receiver._getCodecFromSdp",info:_(g({},ls.notFound),{detail:"m-line not exist"}),path:ca.prefix,context:this._context,channel:this.localPerson.channel});const r=n.payloads.split(" ")[0],s=n.rtp.find((e=>e.payload.toString()===r)),o=`${i}/${s.codec}`.toLowerCase();let a={};const c=n.fmtp.find((e=>e.payload.toString()===r));(null==c?void 0:c.config)&&(a=ys(c.config));const d={mimeType:o,parameters:a};return d}get hasMedia(){const e=Object.values(this.streams).length;return this._log.debug("hasMedia",{count:e}),e>0}close(){this._log.debug("closed"),this.unSetPeerConnectionListener(),this._disposer.dispose(),this.pc.close()}add(e){this._subscriptions[e.id]=e}remove(e){const t=this._subscriptions[e];if(!t)return;delete this._subscriptions[t.id];const i=t.publication.id,n=this.streams[i];n&&delete this.streams[i]}_validateRemoteOffer(e){const t=Ho.parse(e);this._log.debug("_validateRemoteOffer",{sdpObject:t});for(const i of t.media){if("inactive"===i.direction)continue;const e=Object.values(this._publicationInfo).find((e=>{var t;return(null==(t=i.mid)?void 0:t.toString())===e.mid}));if(!e){const e=gs({operationName:"Receiver._validateRemoteOffer",info:_(g({},ls.notFound),{detail:"mismatch between sdp and state"}),path:ca.prefix,context:this._context,channel:this.localPerson.channel,payload:{sdpMedia:t.media,sdpMediaLine:i,info:this._publicationInfo}});throw this.onError.emit(e),e}}}get isWrongSignalingState(){return"have-local-offer"===this.pc.signalingState&&this.pc.remoteDescription||"have-remote-offer"===this.pc.signalingState}_handleSenderProduce(e){return b(this,arguments,(function*({sdp:e,publicationId:t,info:i}){if("closed"!==this.pc.signalingState){if("stable"!==this.pc.signalingState){if(this.isWrongSignalingState)return this._log.warn("_handleSenderProduce wait for be stable",fs({operationName:"Receiver._handleSenderProduce",channel:this.localPerson.channel,detail:"_handleSenderProduce wait for be stable",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),void(yield this._handleSenderProduce({sdp:e,publicationId:t,info:i}));throw gs({operationName:"Receiver._handleSenderProduce",context:this._context,channel:this.localPerson.channel,info:_(g({},ls.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ca.prefix})}this._log.debug("_handleSenderProduce",{info:i,publicationId:t,publicationInfo:Object.values(this._publicationInfo)}),this._publicationInfo[i.publicationId]=i,this._validateRemoteOffer(e.sdp),yield this.sendAnswer(e),yield this.resolveCandidates()}}))}_handleSenderUnproduce(e){return b(this,arguments,(function*({sdp:e,publicationId:t}){if("closed"!==this.pc.signalingState){if(this._log.debug("<handleSenderUnproduce> start",{sdp:e,publicationId:t}),"stable"!==this.pc.signalingState){if(this.isWrongSignalingState)return this._log.warn("signalingState is not stable",fs({channel:this.localPerson.channel,detail:"signalingState is not stable",operationName:"Receiver._handleSenderUnproduce",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),void(yield this._handleSenderUnproduce({sdp:e,publicationId:t}));throw gs({operationName:"Receiver._handleSenderProduce",context:this._context,channel:this.localPerson.channel,info:_(g({},ls.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ca.prefix})}delete this._publicationInfo[t],yield this.sendAnswer(e),yield this.resolveCandidates(),this._log.debug("<handleSenderUnproduce> end",{publicationId:t})}else this._log.warn("signalingState closed",fs({channel:this.localPerson.channel,detail:"signalingState closed",operationName:"Receiver._handleSenderUnproduce"}))}))}_handleSenderRestartIce(e){return b(this,arguments,(function*({sdp:e}){if("closed"!==this.pc.signalingState){if("stable"!==this.pc.signalingState){if(this.isWrongSignalingState)return this._log.warn("signalingState is not stable",fs({channel:this.localPerson.channel,detail:"signalingState is not stable",operationName:"Receiver._handleSenderRestartIce",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),void(yield this._handleSenderRestartIce({sdp:e}));throw gs({operationName:"Receiver._handleSenderRestartIce",context:this._context,channel:this.localPerson.channel,info:_(g({},ls.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ca.prefix})}this._setConnectionState("reconnecting"),yield this.sendAnswer(e),yield this.resolveCandidates(),"connected"===this.pc.connectionState&&this._setConnectionState("connected")}}))}sendAnswer(e){return b(this,null,(function*(){this._log.debug("[receiver] start: sendAnswer"),yield this.pc.setRemoteDescription(e);const t=yield this.pc.createAnswer(),i=Ho.parse(this.pc.remoteDescription.sdp),n=Ho.parse(t.sdp);i.media.forEach(((e,t)=>{const i=n.media[t];i.fmtp=ds(i.fmtp).map((t=>{const i=e.fmtp.find((e=>e.payload===t.payload));return i||t}))}));const r=Ho.write(n);yield this.pc.setLocalDescription({type:"answer",sdp:r});const s={kind:"receiverAnswerMessage",payload:{sdp:this.pc.localDescription}};yield this.signaling.send(this.endpoint,s).catch((e=>this._log.error("failed to send answer",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}))),this._log.debug("[receiver] end: sendAnswer")}))}};w();var la=S(pt()),ha=S(P());w();var ua=new si("packages/core/src/plugin/internal/person/util.ts"),pa=(e,t)=>b(void 0,null,(function*(){const i=ua.createBlock({label:"setEncodingParams"}),n=e.getParameters();i.debug("getParameters",{params:n,newEncodings:t}),void 0==n.encodings&&(n.encodings=[]),n.encodings=t.map(((e,t)=>g(g({},n.encodings[t]||{}),e))),yield e.setParameters(n)})),ma=()=>"Safari12"===Ss()||"Safari11"===Ss();function fa(e){switch(e){case"closed":case"disconnected":case"failed":return"disconnected";case"connected":return"connected";case"connecting":return"connecting";case"new":return"new";case"reconnecting":return"reconnecting"}}var ga=e=>{const t=[];return e.forEach((e=>{t.push(JSON.parse(JSON.stringify(e)))})),t},_a=new si("packages/core/src/plugin/internal/person/connection/sender.ts"),va=class extends aa{constructor(e,t,i,n,r){super(e,t,i,n,r,"sender"),this.id=Eo(),this.onConnectionStateChanged=new di,this.publications={},this.transceivers={},this.datachannels={},this._pendingPublications=[],this._isNegotiating=!1,this.promiseQueue=new as,this._disposer=new hi,this._ms=new MediaStream,this._backoffIceRestarted=new cs({times:10,interval:100,jitter:100}),this._connectionState="new",this._log=_a.createBlock({localPersonId:this.localPerson.id,id:this.id}),this._unsubscribeStreamEnableChange={},this.restartIce=()=>b(this,null,(function*(){if(this._backoffIceRestarted.exceeded)return this._log.error(gs({operationName:"Sender.restartIce",context:this._context,channel:this.localPerson.channel,info:_(g({},ls.internal),{detail:"restartIce limit exceeded"}),path:_a.prefix})),void this._setConnectionState("disconnected");this._log.warn("[start] restartIce",fs({operationName:"Sender.restartIce",detail:"start restartIce",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}));const e=()=>"left"===this.endpoint.state?(this._log.warn("endpointMemberLeft",fs({operationName:"restartIce",detail:"endpointMemberLeft",channel:this.localPerson.channel,payload:{endpointId:this.endpoint.id}})),this._setConnectionState("disconnected"),!0):"connected"===this.pc.connectionState?(this._log.warn("[end] restartIce",fs({operationName:"restartIce",detail:"reconnected",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}})),this._backoffIceRestarted.reset(),this._setConnectionState("connected"),!0):void 0;if(this._setConnectionState("reconnecting"),yield this._backoffIceRestarted.wait(),e())return;let t=yield this._iceManager.updateIceParams().catch((e=>e));if(t)return this._log.warn("[failed] restartIce",fs({operationName:"restartIce",detail:"update IceParams failed",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}),t),void(yield this.restartIce());if(this.pc.setConfiguration&&(this.pc.setConfiguration(_(g({},this.pc.getConfiguration()),{iceServers:this._iceManager.iceServers})),this._log.debug("<restartIce> setConfiguration",{iceServers:this._iceManager.iceServers})),e())return;if("connected"!==this.signaling.connectionState){if(this._log.warn("<restartIce> reconnect signaling service",fs({operationName:"restartIce",detail:"reconnect signaling service",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}})),t=yield this.signaling.onConnectionStateChanged.watch((e=>"connected"===e),1e4).catch((e=>e)).then((()=>{})),t instanceof ai)return void(yield this.restartIce());if(e())return}const i=yield this.pc.createOffer({iceRestart:!0});yield this.pc.setLocalDescription(i);const n={kind:"senderRestartIceMessage",payload:{sdp:this.pc.localDescription}};if(t=yield this.signaling.send(this.endpoint,n,1e4).catch((e=>e)),t)return this._log.warn("<restartIce> [failed]",fs({operationName:"restartIce",detail:"timeout send signaling message",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}),t),void(yield this.restartIce());t=yield this.waitForConnectionState("connected",5e3).catch((e=>e)),!t&&e()||(yield this.restartIce())})),this._log.debug("spawned"),this.signaling.onMessage.add((e=>b(this,[e],(function*({src:e,data:t}){if(e.id!==r.id||e.name!==r.name)return;const i=t;switch(i.kind){case"receiverAnswerMessage":this.promiseQueue.push((()=>this._handleReceiverAnswer(i.payload))).catch((e=>this._log.error("handle receiverAnswerMessage",{localPersonId:this.localPerson.id,endpointId:this.endpoint.id,err:e})));break;case"iceCandidateMessage":{const{role:e,candidate:t}=i.payload;"receiver"===e&&(yield this.handleCandidate(t))}break}})))).disposer(this._disposer),this.onPeerConnectionStateChanged.add((e=>b(this,null,(function*(){switch(_a.debug("onPeerConnectionStateChanged",{state:e}),e){case"disconnected":case"failed":{const e=yield this.waitForConnectionState("connected",5e3).catch((e=>e));e&&"reconnecting"!==this._connectionState&&(yield this.restartIce())}break;case"connecting":case"connected":this._setConnectionState(e);break;case"closed":this._setConnectionState("disconnected");break}})))).disposer(this._disposer)}_setConnectionState(e){this._connectionState!==e&&(this._log.debug("onConnectionStateChanged",e),this._connectionState=e,this.onConnectionStateChanged.emit(e))}get hasMedia(){const e=Object.keys(this.publications).length;return this._log.debug("hasMedia",{count:e}),e>0}_getMid(e,t){if("data"===e.contentType){const e=t.media.find((e=>"application"===e.type));if(void 0==(null==e?void 0:e.mid))throw gs({operationName:"Sender._getMid",info:_(g({},ls.missingProperty),{detail:"datachannel mid undefined"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel});return e.mid.toString()}{const t=this.transceivers[e.id],i=t.mid;if(void 0==i)throw gs({operationName:"Sender._getMid",info:_(g({},ls.missingProperty),{detail:"media mid undefined"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel});return i.toString()}}_listenStreamEnableChange(e,t){this._unsubscribeStreamEnableChange[t]&&this._unsubscribeStreamEnableChange[t]();const{removeListener:i}=e._onEnableChanged.add((e=>b(this,null,(function*(){yield this._replaceTrack(t,e).catch((e=>{_a.warn(fs({member:this.localPerson,detail:"_replaceTrack failed",operationName:"Sender._listenStreamEnableChange",payload:e}))}))}))));this._unsubscribeStreamEnableChange[t]=i}add(e){return b(this,null,(function*(){var t,i;if(this._isNegotiating||"stable"!==this.pc.signalingState)return this._pendingPublications.push(e),void this._log.debug("<add> isNegotiating",{publication:e,isNegotiating:this._isNegotiating,signalingState:this.pc.signalingState,pendingPublications:this._pendingPublications.length});this._isNegotiating=!0,this._log.debug("<add> add publication",{publication:e}),this.publications[e.id]=e;const n=e.stream;if(!n)throw gs({operationName:"Sender.add",info:_(g({},ls.missingProperty),{detail:"<add> stream not found"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel});if(this._setupTransportAccessForStream(n),"data"===n.contentType){const t=this.pc.createDataChannel(new sa(e.id,n.id).toLabel(),n.options);n._onWriteData.add((e=>{"open"===t.readyState&&t.send(e)})).disposer(this._disposer),this.datachannels[e.id]=t}else{e._onReplaceStream.add((t=>b(this,null,(function*(){this._listenStreamEnableChange(t,e.id),yield this._replaceTrack(e.id,t.track)})))).disposer(this._disposer),this._listenStreamEnableChange(n,e.id);const t=this.pc.addTransceiver(n.track,{direction:"sendonly",streams:[this._ms]});e._onEncodingsChanged.add((e=>b(this,null,(function*(){yield pa(t.sender,e).catch((e=>{this._log.error("_onEncodingsChanged failed",e)}))})))).disposer(this._disposer),this.transceivers[e.id]=t}const r=yield this.pc.createOffer().catch((e=>{throw gs({operationName:"Sender.add",info:_(g({},ls.internal),{detail:"can't create offer"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel,error:e})}));yield this.pc.setLocalDescription(r);const s=ha.parse(this.pc.localDescription.sdp);this._log.debug("<add> create offer base",s);const o=this._getMid(e,s);if("data"!==e.contentType){ya(null!=(t=e.codecCapabilities)?t:[],o,s);const n=ha.write(s);if(yield this.pc.setLocalDescription({type:"offer",sdp:n}),this._log.debug("<add> create offer",this.pc.localDescription),(null==(i=e.encodings)?void 0:i.length)>0)if(ma())this._safariSetupEncoding(e);else{const t=this.transceivers[e.id];yield pa(t.sender,[e.encodings[0]])}}const a={kind:"senderProduceMessage",payload:{sdp:this.pc.localDescription,publicationId:e.id,info:{publicationId:e.id,streamId:n.id,mid:o}}};this._log.debug("[start] send message",a),yield this.signaling.send(this.endpoint,a).catch((e=>{throw this._log.error("[failed] send message :",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}),e})),this._log.debug("[end] send message",a)}))}_setupTransportAccessForStream(e){e._getTransportCallbacks[this.endpoint.id]=()=>({rtcPeerConnection:this.pc,connectionState:this._connectionState}),e._getStatsCallbacks[this.endpoint.id]=()=>b(this,null,(function*(){if("data"===e.contentType){const e=yield this.pc.getStats(),t=ps(e);return t}const t=yield this.pc.getStats(e.track),i=ps(t);return i})),this._disposer.push((()=>{delete e._getTransportCallbacks[this.endpoint.id],delete e._getStatsCallbacks[this.endpoint.id]})),this.onConnectionStateChanged.add((t=>{e.onConnectionStateChanged.emit({remoteMember:this.endpoint,state:t})})).disposer(this._disposer)}remove(e){return b(this,null,(function*(){const t=this.publications[e];if(!t)return void this._log.warn("<remove> publication not found",fs({operationName:"Sender.remove",detail:"publication already removed",channel:this.localPerson.channel,payload:{publicationId:e}}));if(delete this.publications[e],this._isNegotiating||"stable"!==this.pc.signalingState)return this._pendingPublications.push(e),void this._log.debug("<remove> isNegotiating",{publicationId:e,_isNegotiating:this._isNegotiating,signalingState:this.pc.signalingState});this._isNegotiating=!0,this._log.debug("<remove> [start]",{publicationId:e});const i=t.stream;if(!i)throw gs({operationName:"Sender.remove",info:_(g({},ls.missingProperty),{detail:"<remove> publication not have stream"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel,payload:{publication:t}});if("data"===i.contentType){const t=this.datachannels[e];t.close(),delete this.datachannels[e]}else{const t=this.transceivers[e];t.stop(),delete this.transceivers[e]}const n=yield this.pc.createOffer().catch((e=>{throw gs({operationName:"Sender.remove",info:_(g({},ls.internal),{detail:"<remove> can't create offer"}),path:_a.prefix,context:this._context,channel:this.localPerson.channel,error:e})}));yield this.pc.setLocalDescription(n);const r={kind:"senderUnproduceMessage",payload:{sdp:this.pc.localDescription,publicationId:e}};this._log.debug("<remove> send message",{message:r}),yield this.signaling.send(this.endpoint,r).catch((e=>{throw this._log.error("<remove> in remote error :",e,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}),e})),this._log.debug("<remove> [end]",{publicationId:e})}))}_replaceTrack(e,t){return b(this,null,(function*(){const i=this.transceivers[e];i?yield i.sender.replaceTrack(t).catch((e=>{throw gs({operationName:"Sender._replaceTrack",context:this._context,info:ls.internal,error:e,path:_a.prefix,channel:this.localPerson.channel})})):this._log.warn("can't replace track, transceiver not found",fs({operationName:"Sender._replaceTrack",detail:"transceiver already removed",channel:this.localPerson.channel,payload:{publicationId:e}}))}))}_handleReceiverAnswer(e){return b(this,arguments,(function*({sdp:e}){"closed"!==this.pc.signalingState&&(this._log.debug("<handleReceiverAnswer> [start]"),yield this.pc.setRemoteDescription(new RTCSessionDescription(e)).catch((t=>{const i=gs({operationName:"Sender._handleReceiverAnswer",context:this._context,info:_(g({},ls.internal),{detail:"failed to setRemoteDescription"}),path:_a.prefix,payload:{sdp:e},channel:this.localPerson.channel,error:t});throw this._log.error(i),i})),this._log.debug("<handleReceiverAnswer> sRD"),yield this.resolveCandidates(),this._log.debug("<handleReceiverAnswer> resolveCandidates"),yield this.waitForSignalingState("stable"),this._log.debug("<handleReceiverAnswer> waitForSignalingState"),this._isNegotiating=!1,yield this._resolvePendingSender(),this._log.debug("<handleReceiverAnswer> _resolvePendingSender",this._pendingPublications.length),this._log.debug("<handleReceiverAnswer> [end]"))}))}_safariSetupEncoding(e){const t=this.transceivers[e.id],i=e.stream;this.waitForStats(i.track,(e=>{const t=e.find((e=>e.id.includes("RTCOutboundRTP")));return(null==t?void 0:t.keyFramesEncoded)>0}),10,this._context.config.rtcConfig.timeout).then((()=>{pa(t.sender,[e.encodings[0]]).catch((e=>{this._log.error("setEncodingParams failed",e)}))})).catch((e=>{this._log.error("waitForStats",e)}))}_resolvePendingSender(){return b(this,null,(function*(){const e=this._pendingPublications.shift();e&&(this._log.debug("resolve pending sender",{publication:e}),"string"===typeof e?yield this.remove(e):yield this.add(e))}))}close(){this._log.debug("closed"),this.unSetPeerConnectionListener(),this._disposer.dispose(),Object.values(this._unsubscribeStreamEnableChange).forEach((e=>e())),this.pc.close()}};function ya(e,t,i){var n,r;const s=i.media.find((e=>{var i;return(null==(i=e.mid)?void 0:i.toString())===t}));if(!s)throw gs({operationName:"applyCodecCapabilities",info:_(g({},ls.notFound),{detail:"media not found"}),path:_a.prefix});e.forEach((e=>{var t;if(e.parameters)for(const[i,n]of Object.entries(null!=(t=e.parameters)?t:{})){if(!1===n||!e.parameters[i])return;"usedtx"===i&&n&&(e.parameters[i]=1)}}));const o=(e,t,i)=>{var n;const r=t.map((e=>_(g({},e),{parameters:vs(i,e.payload)}))),s=Ea(e.mimeType);if(!s)return;const o=null!=(n=r.find((t=>{var i,n;return t.codec.toLowerCase()===s.toLowerCase()&&(0===Object.keys(null!=(i=e.parameters)?i:{}).length||("audio"===Sa(e.mimeType)||(0,la.default)(t.parameters,null!=(n=e.parameters)?n:{})))})))?n:void 0;return o},a=e.map((e=>o(e,s.rtp,s.fmtp))).filter((e=>void 0!=e)),c=[...a,...s.rtp.filter((e=>!a.find((t=>t.payload===e.payload))))];for(const d of s.fmtp){const t=d.payload,i=c.find((e=>e.payload===t));if(i){const t=e.find((e=>o(e,[i],s.fmtp)));t&&t.parameters&&Object.keys(t.parameters).length>0&&(d.config="",Object.entries(t.parameters).forEach((([e,t])=>{!1===t||d.config.includes(e)||(d.config.length>0?d.config+=`;${e}=${t}`:d.config=`${e}=${t}`)})))}const a=c.find((e=>"opus"===e.codec.toLowerCase())),l=null==(r=null==(n=e.find((e=>"opus"===Ea(e.mimeType).toLowerCase())))?void 0:n.parameters)?void 0:r.usedtx;a&&!1!==l&&d.payload===a.payload&&!d.config.includes("usedtx")&&(d.config.length>0?d.config+=";usedtx=1":d.config="usedtx=1")}s.payloads=c.map((e=>e.payload.toString())).join(" ")}var Ea=e=>e.split("/")[1],Sa=e=>e.split("/")[0],ba=new si("packages/core/src/plugin/internal/person/connection/index.ts"),wa=class{constructor(e,t,i,n,r,s){this._iceManager=e,this._signaling=t,this._context=i,this.channelId=n,this.localPerson=r,this.remoteMember=s,this.id=Eo(),this.type="p2p",this.onDisconnect=new di,this.onClose=new di,this.closed=!1,this.disconnected=!1,this._log=ba.createBlock({id:this.id,localPersonId:this.localPerson.id}),this._pubsubQueue=new as,this.sender=new va(this._context,this._iceManager,this._signaling,this.localPerson,this.remoteMember),this.receiver=new da(this._context,this._iceManager,this._signaling,this.localPerson,this.remoteMember),this.sender.onDisconnect.once((()=>{this.disconnected=!0,this.onDisconnect.emit()})),this.receiver.onDisconnect.once((()=>{this.disconnected=!0,this.onDisconnect.emit()}))}startPublishing(e){return b(this,null,(function*(){yield this._pubsubQueue.push((()=>b(this,null,(function*(){this._log.debug("startPublishing",{publication:e}),yield this.sender.add(e)}))))}))}stopPublishing(e){return b(this,null,(function*(){yield this._pubsubQueue.push((()=>b(this,null,(function*(){this._log.debug("<stopPublishing> start",{publication:e}),this.sender.remove(e.id).then((()=>{this._log.debug("<stopPublishing> removed",{publication:e})})),this._closeIfNeeded(),this._log.debug("<stopPublishing> end",{publication:e})}))))}))}startSubscribing(e){return b(this,null,(function*(){yield this._pubsubQueue.push((()=>b(this,null,(function*(){this._log.debug("startSubscribing",{subscription:e}),this.receiver.add(e);const t=e.publication.id;let i=this.receiver.streams[t];i||(yield this.receiver.onStreamAdded.watch((e=>e.publicationId===t),this._context.config.rtcConfig.timeout).catch((()=>{throw gs({operationName:"P2PConnection.startSubscribing",info:_(g({},ls.timeout),{detail:"onStreamAdded"}),path:ba.prefix,context:this._context,channel:this.localPerson.channel,payload:{subscription:e}})})),i=this.receiver.streams[t]),e.codec=i.codec,e.stream=i}))))}))}stopSubscribing(e){return b(this,null,(function*(){yield this._pubsubQueue.push((()=>b(this,null,(function*(){this._log.debug("stopSubscribing",{subscription:e}),this.receiver.remove(e.id),this._closeIfNeeded()}))))}))}_closeIfNeeded(){this.sender.hasMedia||this.receiver.hasMedia||this.close()}getStats(e){return b(this,null,(function*(){const t=e.stream;if(!t)throw gs({operationName:"P2PConnection.getStats",info:_(g({},ls.invalidArgumentValue),{detail:"Subscription or Publication must has stream"}),path:ba.prefix,context:this._context,channel:this.localPerson.channel});return"local"===t.side?"data"===t.contentType?this.sender.pc.getStats():this.sender.pc.getStats(t.track):"data"===t.contentType?this.receiver.pc.getStats():this.receiver.pc.getStats(t.track)}))}close(){this.closed||(this.closed=!0,this._log.debug("closed",{endpointId:this.remoteMember.id}),this.sender.close(),this.receiver.close(),this.onClose.emit())}},Ta=new si("packages/core/src/plugin/internal/person/member.ts"),Ca=class extends Bo{constructor(e){super(e),this.args=e,this.type="person",this.subtype="person",this.side="remote",this._connections={},this._context=this.args.channel._context,this._disposer=new hi,this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.subscribe=e=>new Promise(((t,i)=>{let n=!1;this.channel._subscribe(this.id,e).catch((e=>{n=!0,i(e)})),this.onPublicationSubscribed.watch((({subscription:t})=>t.publication.id===e),this._context.config.rtcApi.timeout).then((({subscription:e})=>{t({subscription:e})})).catch((()=>{n||i(gs({operationName:"RemotePersonImpl.subscribe",info:_(g({},ls.timeout),{detail:"onPublicationSubscribed"}),path:Ta.prefix,context:this._context,channel:this.channel}))}))})),this.plugin=e.plugin,this.channel.onPublicationUnsubscribed.add((({subscription:e})=>{e.subscriber.id===this.id&&(this.onPublicationUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),this.channel.onPublicationSubscribed.add((({subscription:e})=>{e.subscriber.id===this.id&&(this.onPublicationSubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),this.channel.onStreamPublished.add((({publication:e})=>{e.publisher.id===this.id&&this.onPublicationListChanged.emit()})).disposer(this._disposer),this.channel.onStreamUnpublished.add((({publication:e})=>{e.publisher.id===this.id&&this.onPublicationListChanged.emit()})).disposer(this._disposer),this.onLeft.once((()=>{Ta.debug("RemotePerson left: ",this.toJSON()),Object.values(this._connections).forEach((e=>{e.close()})),this._connections={}}))}_getConnection(e){return this._connections[e]}_getOrCreateConnection(e){var t;const i=null!=(t=this._getConnection(e.id))?t:this._createConnection(this.channel,e,this);return i}_createConnection(e,t,i){if("local"!==t.side)throw gs({operationName:"RemotePersonImpl._createConnection",info:_(g({},ls.invalidArgumentValue),{detail:"wrong localPerson type"}),path:Ta.prefix,context:this._context,channel:this.channel});if(!t._signaling)throw gs({operationName:"RemotePersonImpl._createConnection",info:_(g({},ls.missingProperty),{detail:"signalingSession not exist"}),path:Ta.prefix,context:this._context,channel:this.channel});const n=new wa(t.iceManager,t._signaling,this._context,e.id,t,i);return this.plugin._messageBuffers[t.id].resolveMessagingBuffer(i),n.onClose.once((()=>{Ta.debug("connection closed",this.toJSON(),{connectionId:n.id}),delete this._connections[t.id]})),this._connections[t.id]=n,n}unsubscribe(e){return b(this,null,(function*(){yield this.channel._unsubscribe(e)}))}_dispose(){this._disposer.dispose()}},Ra=class extends Fo{constructor(){super(...arguments),this.subtype="person",this._messageBuffers={},this._whenCreateLocalPerson=e=>b(this,null,(function*(){e._signaling&&(this._messageBuffers[e.id]=new jo(e._signaling))})),this._whenDisposeLocalPerson=e=>b(this,null,(function*(){const t=this._messageBuffers[e.id];t&&(t.close(),delete this._messageBuffers[e.id])})),this._createRemoteMember=(e,t)=>{const i=new Ca(_(g({},this._context),{context:this._context,channel:e,metadata:t.metadata,id:t.id,name:t.name,plugin:this}));return i}}},Ia=e=>{const t=new Ra;return e.registerPlugin(t),t};w(),w(),w();var Aa=new si("packages/core/src/plugin/internal/unknown/connection.ts"),Pa=class{constructor(e,t){this.localPerson=e,this.remoteMember=t,this.type="unknown",this.onDisconnect=new di,this.onClose=new di,this.closed=!1}close(){this.closed=!0,this.onClose.emit()}startPublishing(e){return b(this,null,(function*(){Aa.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{publication:e})}))}stopPublishing(e){return b(this,null,(function*(){Aa.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{publication:e})}))}startSubscribing(e){return b(this,null,(function*(){Aa.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{subscription:e})}))}stopSubscribing(e){return b(this,null,(function*(){Aa.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{subscription:e})}))}},Oa=class extends Bo{constructor(e){super(e),this.type="bot",this.side="remote",this._connections={},this.plugin=e.plugin,this.subtype=e.subtype}_getConnection(e){return this._connections[e]}_getOrCreateConnection(e){var t;const i=null!=(t=this._getConnection(e.id))?t:this._createConnection(e,this);return i}_createConnection(e,t){return new Pa(e,t)}_dispose(){}},Na=class extends Fo{constructor(){super(...arguments),this.subtype="unknown",this._createRemoteMember=(e,t)=>{const i=new Oa(_(g({},this._context),{context:this._context,channel:e,metadata:t.metadata,id:t.id,name:t.name,plugin:this,subtype:t.subtype}));return i}}};w();var Da="1.2.2",ka=new si("packages/core/src/context.ts"),xa=class{constructor(e,t,i,n){this.config=t,this.authToken=i,this.info=n,this.disposed=!1,this.plugins=[],this._unknownPlugin=new Na,this._reminderSec=this.config.token.updateReminderSec,this._events=new li,this.onTokenUpdateReminder=this._events.make(),this.onTokenExpired=this._events.make(),this.onFatalError=this._events.make(),this._onTokenUpdated=this._events.make(),this._onDisposed=this._events.make(),this._authTokenString=i.tokenString,this.appId=this.authToken.scope.app.id,Ia(this),this._api=e,this._api.onFatalError.once((e=>{ka.error("onFatalError",{appId:this.appId,error:e}),this.onFatalError.emit(gs({operationName:"SkyWayContext._api.onFatalError",context:this,info:ls.rtcApiFatalError,error:e,path:ka.prefix})),this.dispose()}))}static Create(e){return b(this,arguments,(function*(e,t={}){const i=new Mo(t);si.level=i.log.level,si.format=i.log.format;const n=_o.Decode(e),{osName:r,osVersion:s,browserName:o,browserVersion:a}=Es(),c={sdkName:"core",sdkVersion:this.version,osName:r,osVersion:s,browserName:o,browserVersion:a},d={rapi:i.rtcApi.domain,signaling:i.signalingService.domain,ice:i.iceParamServer.domain};ka.info("core sdk spawned",{operationName:"SkyWayContext.Create",runtime:c,endpoint:d,config:i,token:n});try{const t=yield Oo.Create({appId:n.scope.app.id,token:e,log:i.log,rtcApi:i.rtcApi}),r=new xa(t,i,n,{endpoint:d,runtime:c});return yield r._setTokenExpireTimer(),r}catch(l){throw gs({operationName:"SkyWayContext.Create",info:ls.connectRtcApiFailed,error:l,path:ka.prefix})}}))}get authTokenString(){return this._authTokenString}_setTokenExpireTimer(){return b(this,null,(function*(){const e=yield this._api.getServerUnixtimeInSec(),t=this.authToken.exp-e;if(t<0)throw gs({operationName:"SkyWayContext._setTokenExpireTimer",context:this,info:ls.invalidExpireTokenValue,path:ka.prefix,payload:{exp:this.authToken.exp,now:e}});this.tokenUpdateReminderTimer&&clearTimeout(this.tokenUpdateReminderTimer);const i=t-this._reminderSec;if(i<0)throw gs({operationName:"SkyWayContext._setTokenExpireTimer",context:this,info:ls.invalidRemindExpireTokenValue,path:ka.prefix,payload:{expiresInSec:t,reminderSec:this._reminderSec}});ka.debug("_setTokenExpireTimer",{expiresInSec:t,tokenExpireReminderTimeSec:i}),this.tokenUpdateReminderTimer=setTimeout((()=>{ka.debug("tokenUpdateReminder",{appid:this.appId}),this.onTokenUpdateReminder.emit()}),1e3*i),this.tokenExpiredTimer&&clearTimeout(this.tokenExpiredTimer),this.tokenExpiredTimer=setTimeout((()=>{ka.debug("tokenExpired",{appid:this.appId}),this.onTokenExpired.emit()}),1e3*t)}))}updateAuthToken(e){return b(this,null,(function*(){const t=_o.Decode(e);if(ka.info({operationName:"SkyWayContext.updateAuthToken"},{oldToken:this.authToken,newToken:t}),t.scope.app.id!==this.appId)throw gs({operationName:"SkyWayContext.updateAuthToken",context:this,info:ls.invalidTokenAppId,path:ka.prefix,payload:{invalid:this.authToken.scope.app.id,expect:this.appId}});this._authTokenString=e,this.authToken=t,this._onTokenUpdated.emit(e),yield this._setTokenExpireTimer(),yield this._api.updateAuthToken(e)}))}registerPlugin(e){this.plugins.find((t=>t.subtype===e.subtype))||(e._attachContext(this),this.plugins.push(e))}_createRemoteMember(e,t){const i=e._getMember(t.id);if(i)return i;ka.debug("createRemoteMember",{memberDto:t}),t.type=t.type.toLowerCase(),t.subtype=t.subtype.toLowerCase();let n=this.plugins.find((e=>e.subtype===t.subtype));n||(n=this._unknownPlugin,ka.error(gs({operationName:"SkyWayContext._createRemoteMember",context:this,info:ls.unknownRemoteMemberType,path:ka.prefix,payload:{memberDto:t}})));const r=n._createRemoteMember(e,t);return r}dispose(){this.disposed||(this.disposed=!0,ka.debug("disposed",{appid:this.appId}),clearTimeout(this.tokenUpdateReminderTimer),this._onDisposed.emit(),this._events.dispose(),this._api.close())}},La=xa;La.version=Da,w();var Ma=new si("packages/core/src/external/ice.ts"),Fa=class{constructor(e){this.args=e,this.domain=this.args.domain,this.version=this.args.version,this.secure=this.args.secure,this.memberId=this.args.memberId,this.channelId=this.args.channelId,this.ttl=this.args.ttl,this.context=this.args.context,this._stunServers=[],this._turnServers=[],this._endpoint=`http${this.secure?"s":""}://${this.domain}/v${this.version}`,this.http=new os(this._endpoint)}updateIceParams(){return b(this,null,(function*(){const e={memberId:this.memberId,channelId:this.channelId,ttl:this.ttl};Ma.debug("[start] fetch iceParams");const t=new cs({times:6,interval:500,jitter:100}),{turn:i,stun:n}=yield this.http.post("/ice-params",e,{headers:{authorization:`Bearer ${this.context.authTokenString}`},retry:()=>t.wait()});i&&(this._turnServers=[{credential:i.credential,urls:`turn:${i.domain}:${i.port}?transport=tcp`,username:i.username},{credential:i.credential,urls:`turn:${i.domain}:${i.port}?transport=udp`,username:i.username},{credential:i.credential,urls:`turns:${i.domain}:${i.port}?transport=tcp`,username:i.username}]),this._stunServers=[{urls:`stun:${n.domain}:${n.port}`}],Ma.debug("[end] fetch iceParams",{turn:i,stun:n})}))}get iceServers(){let e=[...this._stunServers];const t=this._turnServers.filter((e=>{const t=e.urls;switch(this.context.config.rtcConfig.turnProtocol){case"all":return!0;case"udp":return t.endsWith("udp");case"tcp":return!t.startsWith("turns")&&t.endsWith("tcp");case"tls":return t.startsWith("turns")}}));return"disable"!==this.context.config.rtcConfig.turnPolicy&&(e=[...e,...t]),e}};w(),w(),w();var Ua=new si("packages/core/src/media/stream/local/audio.ts"),ja=class extends Xo{constructor(e,t={}){if(super(e,"audio",t),this.contentType="audio",this._isEnabled=!0,this._promiseQueue=new as,"audio"!==e.kind)throw gs({operationName:"LocalAudioStream.constructor",path:Ua.prefix,info:ls.invalidTrackKind,payload:{track:e}})}setEnabled(e){return b(this,null,(function*(){yield this._promiseQueue.push((()=>b(this,null,(function*(){if(!0===this._isEnabled&&!1===e)this._isEnabled=e,this._disable("audio"),Ua.debug("stopped");else if(!1===this._isEnabled&&!0===e){if(this._isEnabled=e,this._options.stopTrackWhenDisabled){const e=!0===this._options.isDisplayMedia?yield this.enableDisplay():yield this.enableMic();this._updateTrack(e),this._onEnableChanged.emit(e)}else this._oldTrack&&(this._updateTrack(this._oldTrack),this._onEnableChanged.emit(this._oldTrack));Ua.debug("resumed")}}))))}))}get isEnabled(){return this._isEnabled}enableMic(){return b(this,null,(function*(){const[e]=(yield navigator.mediaDevices.getUserMedia({audio:this.trackConstraints})).getAudioTracks();return e}))}enableDisplay(){return b(this,null,(function*(){const[e]=(yield navigator.mediaDevices.getDisplayMedia({audio:this.trackConstraints})).getAudioTracks();return e}))}};w();var Va=new si("packages/core/src/media/stream/local/video.ts"),Ba=class extends Xo{constructor(e,t={}){if(super(e,"video",t),this.contentType="video",this._isEnabled=!0,this._promiseQueue=new as,"video"!==e.kind)throw gs({operationName:"LocalVideoStream.constructor",path:Va.prefix,info:ls.invalidTrackKind,payload:{track:e}});Va.debug("LocalVideoStream spawned",this.toJSON())}setEnabled(e){return b(this,null,(function*(){yield this._promiseQueue.push((()=>b(this,null,(function*(){if(!0===this._isEnabled&&!1===e)this._isEnabled=e,this._disable("video"),Va.debug("stopped",this.toJSON());else if(!1===this._isEnabled&&!0===e){if(this._isEnabled=e,this._options.stopTrackWhenDisabled){const e=!0===this._options.isDisplayMedia?yield this.enableDisplay():yield this.enableCamera();this._updateTrack(e),this._onEnableChanged.emit(e)}else this._oldTrack&&(this._updateTrack(this._oldTrack),this._onEnableChanged.emit(this._oldTrack));Va.debug("resumed",this.toJSON())}}))))}))}get isEnabled(){return this._isEnabled}enableCamera(){return b(this,null,(function*(){const[e]=(yield navigator.mediaDevices.getUserMedia({video:this.trackConstraints})).getVideoTracks();return e}))}enableDisplay(){return b(this,null,(function*(){const[e]=(yield navigator.mediaDevices.getDisplayMedia({video:this.trackConstraints})).getVideoTracks();return e}))}},Ha=new si("packages/core/src/media/factory.ts"),Wa=class{constructor(){if(this.onDeviceChange=new di,this._devices=[],!(null==navigator?void 0:navigator.mediaDevices))throw gs({operationName:"StreamFactory.constructor",info:ls.mediaDevicesNotFound,path:Ha.prefix});navigator.mediaDevices.addEventListener("devicechange",(()=>b(this,null,(function*(){const e=yield this._enumerateDevicesArray(),t=[];this._devices.forEach((i=>{e.map((e=>e.id)).includes(i.id)||t.push(i)}));const i=[];e.map((e=>e.id)).forEach((t=>{this._devices.map((e=>e.id)).includes(t)||i.push(e.find((e=>e.id===t)))})),Ha.debug("device changed",{added:i,removed:t}),t.forEach((e=>{this.onDeviceChange.emit({state:"removed",device:e})})),i.forEach((e=>{this.onDeviceChange.emit({state:"added",device:e})})),this._devices=e}))))}_enumerateDevicesArray(){return b(this,null,(function*(){const e=yield navigator.mediaDevices.enumerateDevices();return e.map((e=>new Ga(e))).filter((e=>e.id.length>0))}))}_enumerateDevicesWithAuth(){return b(this,arguments,(function*({video:e,audio:t}={audio:!0,video:!0}){let i=[];if(e||t){const n=yield navigator.mediaDevices.getUserMedia({video:e,audio:t});i=n.getTracks()}return this._devices=yield this._enumerateDevicesArray(),i.forEach((e=>e.stop())),this._devices}))}enumerateDevices(){return b(this,null,(function*(){const e=yield this._enumerateDevicesWithAuth();return e}))}enumerateInputVideoDevices(){return b(this,null,(function*(){const e=yield this._enumerateDevicesWithAuth({video:!0});return e.filter((e=>"videoinput"===e.kind))}))}enumerateInputAudioDevices(){return b(this,null,(function*(){const e=yield this._enumerateDevicesWithAuth({audio:!0});return e.filter((e=>"audioinput"===e.kind))}))}enumerateOutputAudioDevices(){return b(this,null,(function*(){const e=yield this._enumerateDevicesWithAuth({audio:!0});return e.filter((e=>"audiooutput"===e.kind))}))}createCameraVideoStream(){return b(this,arguments,(function*(e={}){var t;e.stopTrackWhenDisabled=null==(t=e.stopTrackWhenDisabled)||t;const[i]=(yield navigator.mediaDevices.getUserMedia({video:e})).getTracks(),n=new Ba(i,e);return n._setLabel("camera"),n}))}createMicrophoneAudioStream(){return b(this,arguments,(function*(e={}){var t;e.stopTrackWhenDisabled=null==(t=e.stopTrackWhenDisabled)||t;const[i]=(yield navigator.mediaDevices.getUserMedia({audio:e})).getTracks(),n=new ja(i,e);return n._setLabel("microphone"),n}))}createDisplayStreams(e){return b(this,null,(function*(){var t,i,n;const r=null!=(t=e.video)?t:{};r.stopTrackWhenDisabled=null==(i=r.stopTrackWhenDisabled)||i;let s=e.audio;s&&(s={},s.stopTrackWhenDisabled=null==(n=s.stopTrackWhenDisabled)||n),e={audio:s,video:r};const o=yield navigator.mediaDevices.getDisplayMedia(e),[a]=o.getVideoTracks(),[c]=o.getAudioTracks();e.audio&&!c&&Ha.warn(fs({operationName:"StreamFactory.createDisplayStreams",detail:"This client does not support device audio capture"}));const d=new Ba(a,_(g({},e.video),{isDisplayMedia:!0}));d._setLabel("displayVideo");const l=c?new ja(c,_(g({},"boolean"===typeof e.audio?{}:e.audio),{isDisplayMedia:!0})):void 0;return l&&l._setLabel("displayAudio"),{video:d,audio:l}}))}createDataStream(){return b(this,arguments,(function*(e={}){return new Zo(e)}))}createMicrophoneAudioAndCameraStream(){return b(this,arguments,(function*({audio:e,video:t}={}){var i,n;const r=yield navigator.mediaDevices.getUserMedia({audio:null==e||e,video:null==t||t}),[s]=r.getAudioTracks(),[o]=r.getVideoTracks();e=null!=e?e:{},e.stopTrackWhenDisabled=null==(i=e.stopTrackWhenDisabled)||i;const a=new ja(s,e);a._setLabel("microphone"),t=null!=t?t:{},t.stopTrackWhenDisabled=null==(n=t.stopTrackWhenDisabled)||n;const c=new Ba(o,t);return c._setLabel("camera"),{audio:a,video:c}}))}},Ka=new Wa,Ga=class{constructor(e){this.id=e.deviceId,this.label=e.label,this.kind=e.kind}};function qa(e){return void 0!=e&&"remote"===e["side"]}w(),w(),w(),w(),w(),w();var za=new si("packages/core/src/dataPlane/agent/publishing.ts"),Ja=class{constructor(e){this._localPerson=e,this.context=this._localPerson.context}startPublishing(e,t){return b(this,null,(function*(){if(this.context.config.internal.disableDPlane)return void(yield new Promise((e=>setTimeout(e,500))));e.stream||(yield this._localPerson.onStreamPublished.watch((t=>t.publication.id===e.id),this.context.config.rtcApi.timeout).catch((t=>{throw gs({operationName:"PublishingAgent.startPublishing",context:this.context,channel:this._localPerson.channel,info:_(g({},ls.timeout),{detail:"PublishingAgent onStreamPublished"}),path:za.prefix,payload:{publication:e},error:t})})));const i=t._getOrCreateConnection(this._localPerson);i.startPublishing&&(yield i.startPublishing(e))}))}stopPublishing(e,t){return b(this,null,(function*(){const i=t._getConnection(this._localPerson.id);(null==i?void 0:i.stopPublishing)&&i.stopPublishing(e).catch((e=>{za.error("stopPublishing failed",e)}))}))}};w();var Ya=class{constructor(e){this._localPerson=e,this._disposers={},this._context=this._localPerson.context}startSubscribing(e){return b(this,null,(function*(){if(this._context.config.internal.disableDPlane)return void(yield new Promise((e=>setTimeout(e,500))));const t=e.publication.publisher,i=t._getOrCreateConnection(this._localPerson);if(i.startSubscribing){yield i.startSubscribing(e);const{removeListener:t}=e._onChangeEncoding.add((()=>b(this,null,(function*(){var t;yield null==(t=i.changePreferredEncoding)?void 0:t.call(i,e)}))));this._disposers[e.id]=t}}))}stopSubscribing(e){return b(this,null,(function*(){var t,i;const n=e.publication.publisher,r=n._getConnection(this._localPerson.id);(null==r?void 0:r.stopSubscribing)&&(yield r.stopSubscribing(e),null==(i=(t=this._disposers)[e.id])||i.call(t))}))}};w();var Xa=class{constructor(e){this._impl=e,this._events=new li,this.onLeft=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberStateChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onFatalError=this._events.make(),this.apply(e)}get keepaliveIntervalSec(){return this._impl.keepaliveIntervalSec}get keepaliveIntervalGapSec(){return this._impl.keepaliveIntervalGapSec}get type(){return this._impl.type}get subtype(){return this._impl.subtype}get side(){return this._impl.side}get id(){return this._impl.id}get name(){return this._impl.name}get channel(){return this._impl.channel}get metadata(){return this._impl.metadata}get state(){return this._impl.state}get publications(){return this._impl.publications}get subscriptions(){return this._impl.subscriptions}apply(e){this._impl=e,e.onLeft.pipe(this.onLeft),e.onMetadataUpdated.pipe(this.onMetadataUpdated),e.onStreamPublished.pipe(this.onStreamPublished),e.onStreamUnpublished.pipe(this.onStreamUnpublished),e.onPublicationListChanged.pipe(this.onPublicationListChanged),e.onPublicationSubscribed.pipe(this.onPublicationSubscribed),e.onPublicationUnsubscribed.pipe(this.onPublicationUnsubscribed),e.onSubscriptionListChanged.pipe(this.onSubscriptionListChanged),e.onFatalError.pipe(this.onFatalError)}subscribe(e,t){return this._impl.subscribe(e,t)}unsubscribe(e){return this._impl.unsubscribe(e)}publish(e,t={}){return this._impl.publish(e,t)}unpublish(e){return this._impl.unpublish(e)}updateMetadata(e){return this._impl.updateMetadata(e)}leave(){return b(this,null,(function*(){yield this._impl.leave()}))}dispose(){this._impl.dispose()}};w(),w();var $a=86400;w(),w(),w(),w();var Qa=20480,Za=class{constructor(e,t={}){if(this.event=e,this.payload=t,this.eventId=Js(),this.data=JSON.stringify({event:this.event,eventId:this.eventId,payload:this.payload}),this.data.length>Qa)throw new Error("payload size exceeds the upper limit")}};w();var ec=["rateLimitExceeded","targetNotFound","payloadLengthExceeded","invalidPayload","unknown","parameterError","permissionError"];function tc(e){return!(!e||"object"!==typeof e)&&(!!nc(e.src)&&!(!e.data||"object"!==typeof e.data))}function ic(e){return!(!e||"object"!==typeof e)&&("string"===typeof e.eventId&&("boolean"===typeof e.ok&&!!("undefined"===typeof e.reason||"string"===typeof e.reason&&ec.includes(e.reason))))}function nc(e){return void 0!==e&&!Array.isArray(e)&&("object"===typeof e&&("string"===typeof e.id&&("undefined"===typeof e.name||"string"===typeof e.name)))}w();var rc=S(O());w();var sc=class{constructor(){this._listeners=new Map,this._listenerIndex=0,this.emit=e=>{this._listeners.forEach((t=>t(e)))},this.removeAllListeners=()=>{this._listeners.clear()},this.addListener=e=>{const t=this._listenerIndex;this._listeners.set(t,e),this._listenerIndex++;const i=()=>{this._listeners.delete(t)};return{removeListener:i}},this.addOneTimeListener=e=>{const t=this.addListener((i=>{t.removeListener(),e(i)}));return t},this.asPromise=e=>new Promise(((t,i)=>{let n=()=>{};const r=e&&setTimeout((()=>{i("Event asPromise timeout"),n()}),e),s=this.addOneTimeListener((e=>{r&&clearTimeout(r),t(e)}));n=s.removeListener}))}};w();var oc="0.2.0-beta.0",ac=["open","sendRequestSignalingMessage","sendResponseSignalingMessage","acknowledge"],cc=e=>1e3*(m(2,e)+Math.random()),dc=class{constructor({channelId:e,channelName:t,memberId:i,memberName:n,sessionEndpoint:r,token:s,logger:o}){this._isOpen=!1,this._isDestroyed=!1,this._reconnectCount=0,this.connectionState="closed",this.onConnectionStateChanged=new sc,this.onOpened=new sc,this.onEventReceived=new sc,this.onConnectionFailed=new sc,this._sessionEndpoint=r,this._channelId=e,this._channelName=t,this._memberId=i,this._memberName=n,this._token=s,this._logger=o,this._connect()}_setConnectionState(e){this._logger.debug(`connectionState changed : ${e}`),this.connectionState=e,this.onConnectionStateChanged.emit(e)}_connect(){let e;try{const t=`SkyWayAuthToken!${this._token}`,i={channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,platform:"javascript",version:oc},n=Object.entries(i).filter((([e,t])=>void 0!==t)).map((e=>e.join("="))).join("&"),r=`${this._sessionEndpoint}?${n}`;e=new rc.default(r,t),this._logger.debug(`Connecting to signaling-server: ${this._sessionEndpoint}`),e.onerror=t=>{this._logger.error("WebSocket error occurred",t.error),e.close(4202)}}catch(t){const e=t instanceof Error?t:new Error;return this._logger.error("Failed to create WebSocket instance",e),void this.reconnect()}e.onopen=()=>{this._logger.debug("Connected to signaling-server")},e.onclose=e=>{const t="Close event fired: "+JSON.stringify({code:e.code,reason:e.reason,type:e.type});4100<=e.code&&e.code<=4199?this._logger.error(t,new Error):this._logger.debug(t),1e3===e.code||4e3<=e.code&&e.code<=4199?4e3!==e.code&&(this._logger.debug("Closed the connection to signaling-server"),this.onConnectionFailed.emit(),this.destroy()):this.reconnect()},e.onmessage=e=>{this._messageHandler(e.data)},this._ws=e}updateAuthToken(e){this._token=e}reconnect(){if(void 0!==this._ws&&this._ws.close(4e3),this._ws=void 0,this._isOpen=!1,this._reconnectCount>=8)this.onConnectionFailed.emit(),this.destroy(),this._logger.error("Failed to reconnect for eight times",new Error);else{this._setConnectionState("reconnecting");const e=cc(this._reconnectCount);this._reconnectTimer=setTimeout((()=>{this._connect(),this._reconnectCount++,this._logger.debug(`Try to reconnect: count = ${this._reconnectCount}`)}),e)}}destroy(){this._isDestroyed=!0,this._setConnectionState("closed"),this.onConnectionStateChanged.removeAllListeners(),this.onOpened.removeAllListeners(),this.onEventReceived.removeAllListeners(),this.onConnectionFailed.removeAllListeners(),this._reconnectTimer&&clearTimeout(this._reconnectTimer),void 0!==this._ws&&this._ws.close(1e3)}send(e){return new Promise(((t,i)=>{const n=()=>{this.onOpened.addOneTimeListener((()=>{this.send(e).then((()=>{t()})).catch((e=>{i(e)}))})),this.onConnectionFailed.addOneTimeListener((()=>{i(new Error("Connection failed"))}))};if(this._isDestroyed)i(new Error("The socket is already destroyed"));else{if(void 0===this._ws||!this._isOpen)return this._logger.debug("Retry send the client event when connected because WebSocket is undefined or isOpen = false"),void n();this._logger.debug(`Send the event: ${e.data}`),this._ws.send(e.data,(e=>{if(e){if(void 0===this._ws||!this._isOpen||this._ws.readyState!==rc.default.OPEN)return this._logger.debug("Retry send the client event when connected because WebSocket.send failed"),void n();i(e)}else t()}))}}))}_messageHandler(e){if("string"!==typeof e)return void this._logger.error("Received invalid message: not string",new Error);let t;try{t=JSON.parse(e)}catch(i){const e=i instanceof Error?i:new Error;return void this._logger.error("Received invalid message: parse error",e)}lc(t)?"open"===t.event?(this._logger.debug("Received a open event"),this._isOpen=!0,this._setConnectionState("connected"),0!==this._reconnectCount&&(this._reconnectCount=0,this._logger.debug("Succeeded to reconnect")),this.onOpened.emit()):(this._logger.debug(`Received the event: ${t.event}, payload: ${JSON.stringify(t.payload)}`),this.onEventReceived.emit(t)):this._logger.error(`Received invalid message: ${t}`,new Error)}};function lc(e){return!(!e||"object"!==typeof e)&&(!("string"!==typeof e.event||!ac.includes(e.event))&&("string"===typeof e.eventId&&(!e.payload||"object"===typeof e.payload)))}var hc="signaling.skyway.ntt.com",uc="v1",pc=class{constructor({token:e,channelId:t,channelName:i,memberId:n,memberName:r},s){this.onConnectionStateChanged=new sc,this.onConnectionFailed=new sc,this.onRequested=new sc,this._connectivityCheckTimers=new Map,this._responseCallbacks=new Map,this._acknowledgeCallbacks=new Map,this._token=e,this._channelId=t,this._channelName=i,this._memberId=n,this._memberName=r;const o={connectivityCheckIntervalSec:30,signalingServerDomain:hc,secure:!0,logger:{debug:e=>{console.debug(e)},error:e=>{console.error(e)}}};this._options=Object.assign({},o,null!=s?s:{}),this._logger=this._options.logger,this._logger.debug(`Created instance with the options: ${this._options}`)}get connectionState(){var e,t;return null!=(t=null==(e=this._socket)?void 0:e.connectionState)?t:"closed"}connect(){return b(this,null,(function*(){const e=this._options.secure?"wss":"ws",t=this._options.signalingServerDomain||hc;this._socket=new dc({sessionEndpoint:`${e}://${t}/${uc}/ws`,channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,token:this._token,logger:this._logger}),this._socket.onEventReceived.addListener((e=>{try{this._eventReceivedHandler(e)}catch(t){this._logger.error("in _eventReceivedHandler",t)}})),this._socket.onConnectionFailed.addListener((()=>{this.onConnectionFailed.emit()})),this._socket.onConnectionStateChanged.addListener((e=>{this.onConnectionStateChanged.emit(e)})),yield this._socket.onOpened.asPromise(15e3),this._startConnectivityCheck()}))}disconnect(){var e;this._stopConnectivityCheck(),null==(e=this._socket)||e.destroy(),this._socket=void 0,this._responseCallbacks.clear(),this._acknowledgeCallbacks.clear()}_startConnectivityCheck(){this._connectivityCheckInterval?this._logger.debug("connectivity check timer is already set"):(this._connectivityCheckInterval=setInterval((()=>{var e;const t=new Za("checkConnectivity");null==(e=this._socket)||e.send(t).catch((()=>{this._acknowledgeCallbacks.delete(t.eventId)})),this._connectivityCheckTimers.set(t.eventId,setTimeout((()=>{var e;this._acknowledgeCallbacks.delete(t.eventId),null==(e=this._socket)||e.reconnect(),this._logger.debug("connectivity check timer is expired")}),5e3)),this._setAcknowledgeCallback(t.eventId,(e=>{var i;const n=this._connectivityCheckTimers.get(t.eventId);n&&(clearTimeout(n),this._connectivityCheckTimers.delete(t.eventId)),e.ok||(null==(i=this._socket)||i.reconnect(),this._logger.debug("connectivity check response from server was not ok"))}))}),1e3*this._options.connectivityCheckIntervalSec),this._logger.debug("Started connectivity check timer"))}_stopConnectivityCheck(){if(this._connectivityCheckInterval){clearInterval(this._connectivityCheckInterval),this._connectivityCheckInterval=void 0,this._logger.debug("Stopped connectivity check timer");for(const[e,t]of this._connectivityCheckTimers)clearTimeout(t);this._connectivityCheckTimers.clear()}else this._logger.debug("connectivity check timer is not set")}request(e,t,i=10){return fc(e),mc(t),new Promise(((n,r)=>{if(void 0===this._socket)return void r(new Error("websocket is not connected"));const s={dst:e,data:t},o=new Za("sendRequestSignalingMessage",s),a=setTimeout((()=>{this._acknowledgeCallbacks.delete(o.eventId),r(new Error("request timeout"))}),1e3*i);this._setResponseCallback(o.eventId,(e=>{clearTimeout(a),n(e)})),this._setAcknowledgeCallback(o.eventId,(e=>{e.ok||(clearTimeout(a),r(e))})),this._socket.send(o).catch((e=>{this._acknowledgeCallbacks.delete(o.eventId),clearTimeout(a),r(e)}))}))}_response(e,t,i,n){return new Promise(((r,s)=>{if(mc(i),void 0===this._socket)return void s(new Error("websocket is not connected"));const o={dst:e,requestEventId:t,data:i},a=new Za("sendResponseSignalingMessage",o),c=setTimeout((()=>{this._acknowledgeCallbacks.delete(a.eventId),s(new Error("response timeout"))}),1e3*n);this._setAcknowledgeCallback(a.eventId,(e=>{clearTimeout(c),e.ok?r():s(e)})),this._socket.send(a).catch((e=>{this._acknowledgeCallbacks.delete(a.eventId),clearTimeout(c),s(e)}))}))}updateSkyWayAuthToken(e,t=10){return new Promise(((i,n)=>{if(void 0===this._socket)return void n(new Error("websocket is not connected"));const r={token:e},s=new Za("updateSkyWayAuthToken",r),o=setTimeout((()=>{this._acknowledgeCallbacks.delete(s.eventId),n(new Error("updateSkyWayAuthToken timeout"))}),1e3*t);this._setAcknowledgeCallback(s.eventId,(t=>{if(clearTimeout(o),t.ok){if(void 0===this._socket)return void n(new Error("websocket is not connected"));this._socket.updateAuthToken(e),i()}else n(t)})),this._socket.send(s).catch((e=>{this._acknowledgeCallbacks.delete(s.eventId),clearTimeout(o),n(e)}))}))}_eventReceivedHandler(e){switch(e.event){case"acknowledge":this._acknowledgeHandler(e.payload);break;case"sendRequestSignalingMessage":this._eventMessageRequestHandler(e.payload);break;case"sendResponseSignalingMessage":this._eventMessageResponseHandler(e.payload);break;case"open":break;default:e.event;this._logger.debug(`Unknown event: ${e.event}`)}}_acknowledgeHandler(e){if(!ic(e))throw new Error("Invalid payload");const{eventId:t}=e;if(!this._acknowledgeCallbacks.has(t))throw new Error(`acknowledge event has unknown eventId: ${t}`);const i=this._acknowledgeCallbacks.get(t);i&&(this._acknowledgeCallbacks.delete(t),i(e))}_eventMessageRequestHandler(e){if(!tc(e))throw new Error("Invalid payload");if(!e.requestEventId)throw new Error("Invalid payload");const t=e.src,i=e.requestEventId,n=(e,n=10)=>b(this,null,(function*(){yield this._response(t,i,e,n)}));this.onRequested.emit({data:e.data,reply:n,requestEventId:e.requestEventId,src:e.src})}_eventMessageResponseHandler(e){if(!tc(e))throw new Error("Invalid payload");if(!e.requestEventId||!this._responseCallbacks.has(e.requestEventId))throw new Error(`received response has unknown eventId: ${e.requestEventId}`);const t=this._responseCallbacks.get(e.requestEventId);t&&(this._responseCallbacks.delete(e.requestEventId),t(e.data))}_setResponseCallback(e,t){this._responseCallbacks.set(e,t)}_setAcknowledgeCallback(e,t){this._acknowledgeCallbacks.set(e,t)}};function mc(e){if(!e||"object"!==typeof e)throw new Error("the type of data must be object")}function fc(e){if(!nc(e))throw new Error("the type of target must be {id: string, name: string}");if(!Ws(e.id))throw new Error("the type of target.id must be uuid format")}w();var gc=new si("packages/core/src/external/signaling.ts");function _c(e,t,i){return b(this,null,(function*(){const{signalingService:n}=e.config,r=new pc({token:e.authTokenString,channelId:t.id,channelName:t.name,memberId:i.id,memberName:i.name},{logger:{error:i=>b(this,null,(function*(){gc.error("SignalingClient error",gs({operationName:"SignalingClient.logger",context:e,info:_(g({},ls.internal),{detail:"signalingClient error"}),error:i,path:gc.prefix,channel:t}))})),debug:e=>{}},signalingServerDomain:n.domain,secure:n.secure}),s=new vc(r,e);return yield s.connect(),s}))}var vc=class{constructor(e,t){this._client=e,this.context=t,this.onConnectionFailed=new di,this.onConnectionStateChanged=new di,this.onMessage=new di,this._chunkedMessageBuffer={},this._backoffUpdateSkyWayAuthToken=new cs({times:8,interval:100,jitter:100}),this._listen(),t._onTokenUpdated.add((e=>b(this,null,(function*(){yield this._updateSkyWayAuthToken(e)}))))}updateClient(e){this._client=e,this._listen()}_listen(){this._client.onConnectionFailed.addOneTimeListener((()=>{this.onConnectionFailed.emit({})})),this._client.onConnectionStateChanged.addListener((e=>{gc.debug("signalingClient onConnectionStateChanged",e),this.onConnectionStateChanged.emit(e)})),this._client.onRequested.addListener((e=>b(this,[e],(function*({data:e,src:t,reply:i}){var n;const r=e,{chunk:s,length:o,offset:a,id:c,type:d}=r;if(d===yc){if(0===o)this.onMessage.emit({src:t,data:JSON.parse(s)});else if(this._chunkedMessageBuffer[c]=[...null!=(n=this._chunkedMessageBuffer[c])?n:[],r.chunk],o===a){const e=this._chunkedMessageBuffer[c].join("");delete this._chunkedMessageBuffer[c],this.onMessage.emit({src:t,data:JSON.parse(e)})}yield i({}).catch((e=>{gc.warn("failed to reply",fs({operationName:"SignalingSession.reply",detail:"SignalingClient failed to reply"}),e)}))}}))))}_updateSkyWayAuthToken(e){return b(this,null,(function*(){if(this._backoffUpdateSkyWayAuthToken.exceeded)return void gc.error("[failed] updateSkyWayAuthToken");yield this._backoffUpdateSkyWayAuthToken.wait(),gc.debug("[start] updateSkyWayAuthToken",{count:this._backoffUpdateSkyWayAuthToken.count});const t=yield this._client.updateSkyWayAuthToken(e).catch((e=>e));if(t)return gc.warn("[retry] updateSkyWayAuthToken",fs({operationName:"SignalingSession._updateSkyWayAuthToken",detail:"[retry] updateSkyWayAuthToken"}),t),void this._updateSkyWayAuthToken(e);gc.debug("[end] updateSkyWayAuthToken"),this._backoffUpdateSkyWayAuthToken.reset()}))}get connectionState(){return this._client.connectionState}connect(){return b(this,null,(function*(){gc.debug("[start] connect signalingService"),yield this._client.connect().catch((e=>{throw gs({operationName:"signalingSession.connect",path:gc.prefix,info:_(g({},ls.internal),{detail:"signalingClient failed to connect Server"}),context:this.context,error:e})})),gc.debug("[end] connect signalingService")}))}disconnect(){this._client.disconnect()}send(e,t,i=1e4){return b(this,null,(function*(){var n;try{const r=JSON.stringify(t),s=Eo();if(r.length>20480){const t=null!=(n=r.match(/.{1,20480}/g))?n:[];let o=0;for(const n of t){const r={type:yc,length:t.length-1,offset:o++,chunk:n,id:s};yield this._client.request(e,r,i/1e3)}}else{const t={type:yc,length:0,offset:0,chunk:r,id:s};yield this._client.request(e,t,i/1e3)}}catch(r){if("joined"===e.state)throw gs({operationName:"SignalingSession.send",context:this.context,info:_(g({},ls.internal),{detail:"signalingClient"}),error:r,path:gc.prefix,payload:{target:e,data:t}});gc.warn("target already left",r)}}))}},yc="signalingMessage",Ec=new si("packages/core/src/member/person/local/factory.ts");function Sc(e,t,i){return b(this,arguments,(function*(e,t,i,{keepaliveIntervalSec:n,keepaliveIntervalGapSec:r}={}){var s;Ec.debug("createLocalPerson",{channel:t,memberDto:i,keepaliveIntervalSec:n,keepaliveIntervalGapSec:r});const{iceParamServer:o}=e.config,a=!0===e.config.internal.disableSignaling?void 0:yield _c(e,t,i),c=new Fa(_(g({},o),{memberId:i.id,channelId:t.id,ttl:$a,context:e}));yield c.updateIceParams().catch((i=>{throw gs({operationName:"createLocalPerson",context:e,channel:t,info:_(g({},ls.internal),{detail:"updateIceParams failed"}),path:Ec.prefix,error:i})}));const d=yield wc.Create({iceManager:c,channel:t,signaling:a,metadata:i.metadata,name:i.name,id:i.id,keepaliveIntervalSec:n,keepaliveIntervalGapSec:r,context:e});for(const l of e.plugins)yield null==(s=l._whenCreateLocalPerson)?void 0:s.call(l,d),d._onDisposed.once((()=>b(this,null,(function*(){var e;yield null==(e=l._whenDisposeLocalPerson)?void 0:e.call(l,d)}))));return d}))}var bc=new si("packages/core/src/member/localPerson/index.ts"),wc=class extends Bo{constructor(e){super(e),this.args=e,this.type="person",this.subtype="person",this.side="local",this.keepaliveIntervalSec=this.args.keepaliveIntervalSec,this.keepaliveIntervalGapSec=this.args.keepaliveIntervalGapSec,this.config=this.context.config,this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onFatalError=this._events.make(),this._onStreamSubscribeFailed=this._events.make(),this._onDisposed=this._events.make(),this._disposer=new hi,this._subscribing={},this._requestQueue=new as,this.iceManager=this.args.iceManager,this._disposed=!1,this._publishingAgent=new Ja(this),this._subscribingAgent=new Ya(this),this._signaling=e.signaling,this._listenChannelEvent(),this._listenBeforeUnload()}static Create(...e){return b(this,null,(function*(){const t=new wc(...e);return yield t._setupTtlTimer(),t}))}_listenChannelEvent(){this.channel.onPublicationSubscribed.add((e=>b(this,[e],(function*({subscription:e}){yield this._handleOnPublicationSubscribe(e).catch((e=>bc.error("_handleOnStreamSubscribe",e)))})))).disposer(this._disposer),this.channel.onPublicationUnsubscribed.add((e=>b(this,[e],(function*({subscription:e}){yield this._handleOnPublicationUnsubscribe(e).catch((e=>bc.error("_handleOnStreamUnsubscribe",e)))})))).disposer(this._disposer),this.channel._onDisposed.once((()=>{this.dispose()})),this.onLeft.once((()=>{this.dispose()}))}_setupTtlTimer(){return b(this,null,(function*(){const{keepaliveIntervalSec:e,keepaliveIntervalGapSec:t}=this;if(null==e)return;if(bc.debug("_setupTtlTimer",this.toJSON(),{keepaliveIntervalSec:e,keepaliveIntervalGapSec:t}),-1===e)return;const i=()=>b(this,null,(function*(){if(this._disposed)return;const i=yield this.context._api.getServerUnixtimeInSec();this.ttlSec=Math.floor(i+e+(null!=t?t:0));try{yield this.channel._updateMemberTtl(this.id,this.ttlSec),bc.debug("updateTtl",this.toJSON(),{now:i,ttlSec:this.ttlSec,keepaliveIntervalSec:null!=e?e:0,keepaliveIntervalGapSec:null!=t?t:0,diff:this.ttlSec-i})}catch(n){if(this._disposed)return;throw n}}));yield i(),this.ttlInterval=setInterval((()=>b(this,null,(function*(){yield i().catch((e=>{this._disposed||(this.onFatalError.emit(gs({operationName:"localPerson._setupTtlTimer",path:bc.prefix,info:_(g({},ls.internal),{detail:"updateMemberTtl failed"}),channel:this.channel,context:this.context,error:e})),this.dispose())}))}))),1e3*e)}))}_listenBeforeUnload(){if(window){const e=()=>b(this,null,(function*(){window.removeEventListener("beforeunload",e),"joined"===this.state&&(bc.debug("leave by beforeunload",this.toJSON()),yield this.leave())}));window.addEventListener("beforeunload",e)}}_handleOnPublicationSubscribe(e){return b(this,null,(function*(){var t;if(e.subscriber.id===this.id)try{const i=bc.info("[start] startSubscribing",yield ms({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e}),n=null==(t=this._subscribing[e.publication.id])?void 0:t.options;n&&(e.preferredEncoding=n.preferredEncodingId),yield this._subscribingAgent.startSubscribing(e),this.onPublicationSubscribed.emit({subscription:e,stream:e.stream}),this.onSubscriptionListChanged.emit(),bc.elapsed(i,"[end] startSubscribing",yield ms({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e})}catch(i){throw this._onStreamSubscribeFailed.emit({error:i,subscription:e}),i}if(e.publication.publisher.id===this.id){if(e.subscriber.id===this.id)throw gs({operationName:"localPerson._handleOnStreamSubscribe",path:bc.prefix,info:_(g({},ls.internal),{detail:"can not subscribe own Publication"}),channel:this.channel,context:this.context});const t=bc.info("[start] startPublishing",yield ms({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e});yield this._publishingAgent.startPublishing(e.publication,e.subscriber).catch((t=>{throw bc.error("[failed] startPublishing",t,{subscription:e}),t})),bc.elapsed(t,"[end] startPublishing",yield ms({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e})}}))}_handleOnPublicationUnsubscribe(e){return b(this,null,(function*(){if(e.publication.publisher.id===this.id){const t=bc.info("[start] stopPublishing",yield ms({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e});yield this._publishingAgent.stopPublishing(e.publication,e.subscriber).catch((t=>{throw bc.error("[failed] stopPublishing",t,{subscription:e}),t})),bc.elapsed(t,"[end] stopPublishing",yield ms({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e})}if(e.subscriber.id===this.id){const t=bc.info("[start] stopSubscribing",yield ms({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e});yield this._subscribingAgent.stopSubscribing(e).catch((t=>{throw bc.error("[failed] stopSubscribing",{subscription:e},t),t})),this.onPublicationUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit(),bc.elapsed(t,"[end] stopSubscribing",yield ms({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e})}}))}publish(e){return b(this,arguments,(function*(e,t={}){var i,n,r;const s=bc.info("[start] publish",yield ms({operationName:"localPerson.publish",channel:this.channel}),{options:t});if("joined"!==this.state)throw gs({operationName:"localPerson.publish",info:ls.localPersonNotJoinedChannel,path:bc.prefix,channel:this.channel,context:this.context});if(e.published)throw gs({operationName:"localPerson.publish",channel:this.channel,context:this.context,info:ls.alreadyPublishedStream,path:bc.prefix});e.published=!0;const o={metadata:t.metadata,publisher:this.id,channel:this.channel.id,contentType:e.contentType,codecCapabilities:null!=(i=t.codecCapabilities)?i:[]};"video"===e.contentType&&0===o.codecCapabilities.length&&(o.codecCapabilities=[{mimeType:"video/vp8"}]),t.encodings&&t.encodings.length>0&&(o.encodings=Tc(Ts(t.encodings)));const a=yield this._requestQueue.push((()=>this.channel._publish(o).catch((e=>{throw gs({operationName:"localPerson.publish",context:this.context,channel:this.channel,info:e.info,path:bc.prefix,error:e})})))),c=this.channel._addPublication(a);return c.stream=e,(null==(n=o.codecCapabilities)?void 0:n.length)&&c.setCodecCapabilities(o.codecCapabilities),(null==(r=o.encodings)?void 0:r.length)&&c.setEncodings(o.encodings),yield this._handleOnStreamPublish(c),bc.elapsed(s,"[end] publish",yield ms({operationName:"localPerson.publish",channel:this.channel}),{publication:c}),c}))}_handleOnStreamPublish(e){return b(this,null,(function*(){bc.info("onStreamPublished",yield ms({operationName:"onStreamPublished",channel:this.channel})),this.onStreamPublished.emit({publication:e}),this.onPublicationListChanged.emit()}))}unpublish(e){return b(this,null,(function*(){const t=bc.info("[start] unpublish",yield ms({operationName:"localPerson.unpublish",channel:this.channel})),i="string"===typeof e?e:e.id;if("joined"!==this.state)throw gs({operationName:"localPerson.unpublish",info:ls.localPersonNotJoinedChannel,path:bc.prefix,context:this.context,channel:this.channel});const n=this.channel._getPublication(i);if(!n)throw gs({operationName:"localPerson.unpublish",info:ls.publicationNotExist,path:bc.prefix,context:this.context,channel:this.channel,payload:{publicationId:i}});n.stream&&n.stream._unpublished(),yield this._requestQueue.push((()=>this.channel._unpublish(i))),n.subscriptions.map((e=>e.subscriber)).forEach((e=>{qa(e)&&this._publishingAgent.stopPublishing(n,e)})),yield this._handleOnStreamUnpublished(n),bc.elapsed(t,"[end] unpublish",yield ms({operationName:"localPerson.unpublish",channel:this.channel}),{publication:n})}))}_handleOnStreamUnpublished(e){return b(this,null,(function*(){bc.info("onStreamUnpublished",yield ms({operationName:"onStreamUnpublished",channel:this.channel})),this.onStreamUnpublished.emit({publication:e}),this.onPublicationListChanged.emit()}))}subscribe(e){return b(this,arguments,(function*(e,t={}){const i=bc.info("[start] subscribe",yield ms({operationName:"localPerson.subscribe",channel:this.channel}),{target:e}),n="string"===typeof e?e:e.id;if("joined"!==this.state)throw gs({operationName:"localPerson.subscribe",info:ls.localPersonNotJoinedChannel,path:bc.prefix,context:this.context,channel:this.channel,payload:{target:e}});const r=this.channel._getPublication(n);if(void 0==r)throw gs({operationName:"localPerson.subscribe",info:ls.publicationNotExist,path:bc.prefix,context:this.context,channel:this.channel,payload:r});this._validatePublicationForSubscribe(r),this._subscribing[r.id]={options:t,processing:!0};const s=this._subscribing[r.id];try{const e=yield this._requestQueue.push((()=>this.channel._subscribe(this.id,n)));bc.elapsed(i,"[elapsed] subscribe / subscriptionDto received",{subscriptionDto:e});const t=this.channel._addSubscription(e);return t.stream||(yield Promise.race([new Promise(((e,i)=>{this.onPublicationSubscribed.watch((({subscription:e})=>e.publication.id===n),this.context.config.rtcApi.timeout).catch((e=>b(this,null,(function*(){s.processing&&i(gs({operationName:"localPerson.subscribe",info:_(g({},ls.timeout),{detail:"failed to subscribe publication. maybe publisher already left room"}),path:bc.prefix,context:this.context,channel:this.channel,payload:{subscription:t,publication:r},error:e}))})))).then(e)})),new Promise(((e,i)=>{this.channel.onMemberLeft.watch((e=>e.member.id===r.publisher.id),this.context.config.rtcApi.timeout+1e3).then((()=>{s.processing&&i(gs({operationName:"localPerson.subscribe",info:_(g({},ls.internal),{detail:"failed to subscribe publication. publisher already left room"}),path:bc.prefix,context:this.context,channel:this.channel,payload:{subscription:t,publication:r}}))})).catch(e)})),new Promise(((e,i)=>{this._onStreamSubscribeFailed.watch((e=>e.subscription.publication.id===r.id),this.context.config.rtcApi.timeout+1e3).then((e=>{var n,o;if(s.processing){const s=null!=(o=null==(n=null==e?void 0:e.error)?void 0:n.info)?o:_(g({},ls.internal),{detail:"subscribe _onStreamSubscribeFailed"});i(gs({operationName:"localPerson.subscribe",info:s,path:bc.prefix,context:this.context,channel:this.channel,error:e.error,payload:{subscription:t,publication:r}}))}})).catch(e)}))])),s.processing=!1,bc.elapsed(i,"[end] subscribe",yield ms({operationName:"localPerson.subscribe",channel:this.channel}),{subscription:t,publication:r}),{subscription:t,stream:t.stream}}catch(o){throw s.processing=!1,bc.warn("[failed] subscribe",o,{publication:r}),o}}))}_validatePublicationForSubscribe(e){if(e.publisher.id===this.id)throw gs({operationName:"localPerson._validatePublicationForSubscribe",info:ls.publicationNotExist,path:bc.prefix,context:this.context,channel:this.channel,payload:{publication:e}});if(e.publisher instanceof Oa)throw gs({operationName:"localPerson._validatePublicationForSubscribe",info:ls.unknownMemberType,path:bc.prefix,context:this.context,channel:this.channel,payload:{publication:e}});if(this.subscriptions.find((t=>t.publication.id===e.id)))throw gs({operationName:"localPerson._validatePublicationForSubscribe",info:ls.alreadySubscribedPublication,path:bc.prefix,context:this.context,channel:this.channel,payload:{publication:e}})}unsubscribe(e){return b(this,null,(function*(){const t=bc.info("[start] unsubscribe",yield ms({operationName:"localPerson.unsubscribe",channel:this.channel})),i="string"===typeof e?e:e.id;if("joined"!==this.state)throw gs({operationName:"localPerson.unsubscribe",info:ls.localPersonNotJoinedChannel,path:bc.prefix,context:this.context,channel:this.channel});const n=this.subscriptions.find((e=>e.id===i));if(!n)throw gs({operationName:"localPerson.unsubscribe",info:ls.subscriptionNotExist,path:bc.prefix,context:this.context,channel:this.channel,payload:{subscriptionId:i}});delete this._subscribing[n.publication.id],yield this._requestQueue.push((()=>this.channel._unsubscribe(i))),bc.elapsed(t,"[end] unsubscribe",yield ms({operationName:"localPerson.unsubscribe",channel:this.channel}),{subscription:n})}))}_getConnections(){const e=this.channel.members.map((e=>e._getConnection(this.id))),t=e.filter((e=>!1===(null==e?void 0:e.closed)));return t}dispose(){this._disposed||(this._disposed=!0,bc.debug("disposed",this.toJSON()),clearInterval(this.ttlInterval),this._signaling&&this._signaling.disconnect(),this._getConnections().forEach((e=>e.close())),this._onDisposed.emit(),this._events.dispose(),this._disposer.dispose())}};function Tc(e){const[t]=e;return t.maxBitrate?e.sort(((e,t)=>e.maxBitrate-t.maxBitrate)):t.scaleResolutionDownBy?e.sort(((e,t)=>t.scaleResolutionDownBy-e.scaleResolutionDownBy)):t.maxFramerate?e.sort(((e,t)=>e.maxFramerate-t.maxFramerate)):e}w(),w();var Cc={invalidParameter:{name:"invalidParameter",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internal:{name:"internal",detail:"",solution:""},notImplemented:{name:"notImplemented",detail:"å¯¾å¿ãã¦ããªãRoomTypeã§ã",solution:"æ­£ããRoomTypeãæå®ãã¦ãã ãã"},roomNotOpened:{name:"roomNotOpened",detail:"RoomãOpenããã¦ãã¾ãã",solution:"Roomã®ç¶æãç¢ºããã¦ãã ãã"},subscribeOtherMemberType:{name:"subscribeOtherMemberType",detail:"RemoteMemberã«Subscribe/Unsubscribeãããå ´åãå¯¾è±¡ã®Memberã®Typeã¯Personã§ããå¿è¦ãããã¾ã",solution:"å¯¾è±¡ã®RemoteMemberãæ­£ãããç¢ºèªãã¦ãã ãã"},sfuRoomNotSupportDataStream:{name:"sfuRoomNotSupportDataStream",detail:"SFURoomã§DataStreamãä½¿ããã¨ã¯åºæ¥ã¾ãã",solution:"ããã¾ãã"},publicationNotHasOrigin:{name:"publicationNotHasOrigin",detail:"SfuRoomã§æä½ããPublicationã¯Originããã¤å¿è¦ãããã¾ã",solution:"SfuRoomã¨P2PRoomãåä¸ã®IDã§æ··å¨ããã¦ããªããç¢ºããã¦ãã ãã"},notFound:{name:"notFound",detail:"åç§ãããã¨ãã¦ãããã®ãè¦ã¤ããã¾ãã",solution:"åç§ãããã¨ãããã®ãå­å¨ãããç¢ºããã¦ãã ãã"}},Rc=g(g({},ls),Cc);w();var Ic=class{constructor(e,t){this.member=e,this.room=t,this.onLeft=new di;const{removeListener:i}=t.onMemberLeft.add((e=>{e.member.id===this.member.id&&(i(),this.onLeft.emit())}));this.onMetadataUpdated=e.onMetadataUpdated}get id(){return this.member.id}get name(){return this.member.name}get roomId(){return this.room.id}get roomName(){return this.room.name}get roomType(){return this.room.type}get state(){return this.member.state}get metadata(){return this.member.metadata}get _member(){return this.member}get publications(){return this.room.publications.filter((e=>e.publisher.id===this.id))}get subscriptions(){return this.member.subscriptions.map((e=>this.room._getSubscription(e.id)))}updateMetadata(e){return this.member.updateMetadata(e)}leave(){return this.member.leave()}toJSON(){return{id:this.id,name:this.name,metadata:this.metadata}}};w();var Ac=class extends Ic{constructor(e,t){super(e,t),this.side="local",this._local=this._member,this.onStreamPublished=new di,this.onStreamUnpublished=new di,this.onPublicationListChanged=new di,this.onPublicationSubscribed=new di,this.onPublicationUnsubscribed=new di,this.onSubscriptionListChanged=new di,this.onFatalError=new di,this._context=this.room._context,this._local.onPublicationSubscribed.add((e=>b(this,null,(function*(){const i=t._addSubscription(e.subscription);this.onPublicationSubscribed.emit({subscription:i,stream:e.stream})})))),this._local.onFatalError.pipe(this.onFatalError),this._listenRoomEvent(),this.onStreamPublished.add((()=>this.onPublicationListChanged.emit())),this.onStreamUnpublished.add((()=>this.onPublicationListChanged.emit())),this.onPublicationSubscribed.add((()=>this.onSubscriptionListChanged.emit())),this.onPublicationUnsubscribed.add((()=>this.onSubscriptionListChanged.emit()))}get subscriptions(){return this.member.subscriptions.map((e=>this.room._getSubscription(e.id))).filter((e=>e.stream))}_listenRoomEvent(){this.room.onPublicationUnsubscribed.add((e=>{e.subscription.subscriber._member.id===this._local.id&&this.onPublicationUnsubscribed.emit(e)}))}};function Pc({operationName:e,context:t,info:i,error:n,path:r,payload:s,room:o}){const a={operationName:e,payload:s};return o&&(a["appId"]=o._channel.appId,a["roomId"]=o.id,o.localRoomMember&&(a["memberId"]=o.localRoomMember.id)),t&&(a["info"]=t.info,a["plugins"]=t.plugins.map((e=>e.subtype))),new ai({error:n,info:i,payload:a,path:r})}w(),w();var Oc=new si("packages/room/src/member/local/p2p.ts"),Nc=class extends Ac{constructor(e,t){super(e,t)}publish(e){return b(this,arguments,(function*(e,t={}){const i=yield this._local.publish(e,t),n=this.room._addPublication(i);return this.onStreamPublished.emit({publication:n}),n}))}unpublish(e){return b(this,null,(function*(){const t="string"===typeof e?e:e.id;this._local.unpublish(t);const{publication:i}=yield this.room.onStreamUnpublished.watch((e=>e.publication.id===t),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"LocalP2PRoomMemberImpl.unpublish",context:this._context,room:this.room,info:_(g({},Rc.timeout),{detail:"onStreamUnpublished"}),path:Oc.prefix,error:e})}));this.onStreamUnpublished.emit({publication:i})}))}subscribe(e){return b(this,null,(function*(){const t="string"===typeof e?e:e.id,{subscription:i,stream:n}=yield this._local.subscribe(t),r=this.room._addSubscription(i);return{subscription:r,stream:n}}))}unsubscribe(e){return b(this,null,(function*(){const t="string"===typeof e?e:e.id;this._local.unsubscribe(t),yield this.room.onPublicationUnsubscribed.watch((e=>e.subscription.id===t),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"LocalP2PRoomMemberImpl.unsubscribe",context:this._context,room:this.room,info:_(g({},Rc.timeout),{detail:"onPublicationUnsubscribed"}),path:Oc.prefix,error:e})}))}))}_updateRoom(e){Oc.debug("_updateRoom",{memberId:this.id}),this.room=e,this._listenRoomEvent()}};w(),w(),w(),w();var Dc={invalidParameter:{name:"invalidParameter",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internal:{name:"internal",detail:"",solution:""},sfuBotNotInChannel:{name:"sfuBotNotInChannel",detail:"SfuBotãChannelã«å­å¨ãã¾ãã",solution:"æä½ãããã¨ãã¦ããSfuBotãæ­£ãããç¢ºããã¦ãã ãã"},maxSubscribersMustNotBeZero:{name:"maxSubscribersMustNotBeZero",detail:"maxSubscribersã¯ï¼ä»¥ä¸ã§ããå¿è¦ãããã¾ã",solution:"æ­£ããå¤ãå¥åãã¦ãã ãã"},remotePublisherId:{name:"remotePublisherId",detail:"publisherãremoteã®PublicationãForwardingãããã¨ã¯ã§ãã¾ãã",solution:"PublicationãLocalã§Publishããããã®ãç¢ºããã¦ãã ãã"},dataStreamNotSupported:{name:"dataStreamNotSupported",detail:"dataStreamã¯SFUã«å¯¾å¿ãã¦ãã¾ãã",solution:"ããã¾ãã"},streamNotExistInPublication:{name:"streamNotExistInPublication",detail:"Publicationã«Streamãããã¾ãããRemoteMemberã®PublicationãForwardingåºæ¥ã¾ãã",solution:"PublicationãLocalã§Publishããããã®ãç¢ºããã¦ãã ãã"},invalidPreferredEncoding:{name:"invalidPreferredEncoding",detail:"preferredEncodingã®å¤ãä¸æ­£ã§ããã¨ã³ã³ã¼ãè¨­å®åãæ¿ãæ©è½ãä½¿ãã¾ãã",solution:"æ­£ããæå­åãå¥åãã¦ãã ãã"},invalidEncodings:{name:"invalidEncodings",detail:"ã¨ã³ã³ã¼ãè¨­å®ãè¨­å®ããã¦ãã¾ãããã¨ã³ã³ã¼ãè¨­å®åãæ¿ãæ©è½ãä½¿ãã¾ãã",solution:"ã¨ã³ã³ã¼ãè¨­å®åãæ¿ãæ©è½ãå©ç¨ããå ´åã¯ã¨ã³ã³ã¼ãè¨­å®ãããPublicationãForwardingãã¦ãã ãã"},receiverNotFound:{name:"receiverNotFound",detail:"SFUã¯RemoteMemberã®Subscriptionãæä½ã§ãã¾ãã",solution:"SFUã§subscriptionã®æä½ãããéã«ã¯LocalPersonãSubscribeãã¦ããSubscriptionã¤ã³ã¹ã¿ã³ã¹ãå©ç¨ãã¦ãã ãã"},consumerNotFound:{name:"consumerNotFound",detail:"SFUã¯LocalPersonãUnsubscribeããSubscriptionãæåºæ¥ã¾ãã",solution:"æä½å¯¾è±¡ã®Subscriptionãæ­£ãããç¢ºããã¦ãã ãã"},forwardingNotFound:{name:"forwardingNotFound",detail:"å­å¨ããªãForwardingãæä½ãããã¨ãã¦ãã¾ã",solution:"å¯¾è±¡ã®Forwardingãæ­£ãããç¢ºããã¦ãã ãã"},netWorkError:{name:"netWorkError",detail:"éä¿¡ç°å¢ã«åé¡ãããã¾ã",solution:"ãããã¯ã¼ã¯æ¥ç¶ç¶æ³ãç¢ºèªãã¦ãã ãã"}};function kc(e,t){let i=0;for(;i<t.length;i++){const n=t[i];if(n.id===e)break}return i}function xc({channel:e,detail:t,operationName:i,payload:n,bot:r}){var s;const o={operationName:i,payload:n,detail:t};return e&&(o["appId"]=e.appId,o["channelId"]=e.id,e.localPerson&&(o["memberId"]=e.localPerson.id)),r&&(o["botId"]=r.id,o["appId"]=r.channel.appId,o["channelId"]=r.channel.id,o["memberId"]=null==(s=r.channel.localPerson)?void 0:s.id),o}w(),w();var Lc=new si("packages/sfu-bot/src/connection/receiver.ts"),Mc=class{constructor(e,t,i,n,r,s,o){this.subscription=e,this._api=t,this._transportRepository=i,this._localPerson=n,this._bot=r,this._iceManager=s,this._context=o,this._disposer=new hi}toJSON(){return{transport:this.transport,subscription:this.subscription}}consume(){return b(this,null,(function*(){var e,t;let i=this._transportRepository.rtpCapabilities;i||(Lc.debug("[start] getCapabilities"),i=yield this._api.getRtpCapabilities({botId:this._bot.id,forwardingId:this.subscription.publication.id,originPublicationId:this.subscription.publication.origin.id}),Lc.debug("[end] getCapabilities"),yield this._transportRepository.loadDevice(i).catch((e=>{throw gs({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:_(g({},Dc.internal),{detail:"sfu loadDevice failed"}),path:Lc.prefix,error:e})})));const n=this.subscription.preferredEncoding?kc(this.subscription.preferredEncoding,null!=(t=null==(e=this.subscription.publication.origin)?void 0:e.encodings)?t:[]):void 0;Lc.debug("[start] createConsumer",{subscription:this.subscription});const{consumerOptions:r,transportOptions:s,transportId:o,producerId:a}=yield this._api.createConsumer({botId:this._bot.id,forwardingId:this.subscription.publication.id,rtpCapabilities:i,subscriptionId:this.subscription.id,subscriberId:this.subscription.subscriber.id,spatialLayer:n,originPublicationId:this.subscription.publication.origin.id});s&&this._transportRepository.createTransport(this._localPerson.id,this._bot,s,"recv",this._iceManager),this.transport=this._transportRepository.getTransport(this._localPerson.id,o),this.transport||(Lc.warn("transport is under race condition",{transportId:o}),yield this._transportRepository.onTransportCreated.watch((e=>e===o),this._bot.options.endpointTimeout).catch((e=>{throw gs({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:_(g({},Dc.timeout),{detail:"receiver sfuTransport not found"}),path:Lc.prefix,error:e,payload:{transportOptions:s,transportId:o,producerId:a,consumerOptions:r,subscription:this.subscription}})})),this.transport=this._transportRepository.getTransport(this._localPerson.id,o)),Lc.debug("[end] createConsumer"),Lc.debug("[start] consume",{consumerOptions:r,subscription:this.subscription});const c=yield this.transport.msTransport.consume(_(g({},r),{producerId:a})).catch((e=>{throw gs({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:_(g({},Dc.internal),{detail:"consume failed, maybe subscribing unsupported codec"}),path:Lc.prefix,error:e})}));this.consumer=c,Lc.debug("[end] consume",{subscription:this.subscription});const[d]=c.rtpParameters.codecs,l=ra(Eo(),c.track,d),h={mimeType:d.mimeType,parameters:d.parameters};return this._setupTransportAccessForStream(l,c),{stream:l,codec:h}}))}_setupTransportAccessForStream(e,t){const i=this.transport,n=this.pc;e._getTransport=()=>({rtcPeerConnection:n,connectionState:i.connectionState,info:this}),e._getStats=()=>b(this,null,(function*(){const e=yield t.getStats();let n=ps(e);return n=n.map((e=>(e["sfuTransportId"]=i.id,e))),n})),this._disposer.push((()=>{e._getTransport=()=>{}})),i.onConnectionStateChanged.add((t=>e.onConnectionStateChanged.emit(t))).disposer(this._disposer)}unconsume(){this.consumer?(this.consumer.close(),this.consumer=void 0):Lc.debug("unconsume failed, consumer not exist",{subscription:this.subscription})}close(){this._disposer.dispose()}get pc(){var e;return null==(e=this.transport)?void 0:e.pc}};w();var Fc=S(pt());w();var Uc=class{constructor(e,t,i){this.configure=e,this.originPublication=t,this.relayingPublication=i,this.state="started",this.onStopped=new di}get id(){return this.relayingPublication.id}_stop(){this.state="stopped",this.onStopped.emit()}toJSON(){return{id:this.id,configure:this.configure,originPublication:this.originPublication,relayingPublication:this.relayingPublication}}},jc=new si("packages/sfu-bot/src/connection/sender.ts"),Vc=class{constructor(e,t,i,n,r,s,o,a){this.publication=e,this.channel=t,this._api=i,this._transportRepository=n,this._localPerson=r,this._bot=s,this._iceManager=o,this._context=a,this._disposer=new hi,this.closed=!1}toJSON(){return{forwarding:this.forwarding,broadcasterTransport:this._broadcasterTransport,ackTransport:this._ackTransport}}startForwarding(e){return b(this,null,(function*(){if("data"===this.publication.contentType)throw gs({operationName:"Sender.startForwarding",context:this._context,info:Dc.dataStreamNotSupported,path:jc.prefix,channel:this.channel});const t=this.publication.stream;if(!t)throw gs({operationName:"Sender.startForwarding",context:this._context,info:Dc.streamNotExistInPublication,path:jc.prefix,channel:this.channel});jc.debug("[start] Sender startForwarding",{botId:this._bot.id,publicationId:this.publication.id,contentType:this.publication.contentType,maxSubscribers:e.maxSubscribers});const{forwardingId:i,broadcasterTransportId:n,broadcasterTransportOptions:r,rtpCapabilities:s,ackTransportId:o,ackTransportOptions:a,ackProducerId:c,ackConsumerOptions:d}=yield this._api.startForwarding({botId:this._bot.id,publicationId:this.publication.id,contentType:this.publication.contentType,maxSubscribers:e.maxSubscribers,publisherId:this.publication.publisher.id});if(this.forwardingId=i,r&&(jc.debug("sender create new transport",{broadcasterTransportOptions:r,ackTransportOptions:a}),yield this._transportRepository.loadDevice(s),this._broadcasterTransport=this._transportRepository.createTransport(this._localPerson.id,this._bot,r,"send",this._iceManager)),this._broadcasterTransport=this._transportRepository.getTransport(this._localPerson.id,n),!this._broadcasterTransport)throw gs({operationName:"Sender.startForwarding",context:this._context,info:_(g({},Dc.internal),{detail:"_broadcasterTransport not found"}),path:jc.prefix,channel:this.channel,payload:{ackTransportOptions:a,broadcasterTransportOptions:r}});if(a){this._ackTransport=this._transportRepository.createTransport(this._localPerson.id,this._bot,a,"recv",this._iceManager);const e=yield this._ackTransport.msTransport.consumeData(d);e.addListener("open",(()=>b(this,null,(function*(){const e=yield ms({operationName:"acmConsumer.opened",channel:this.channel});jc.debug(e,{ackTransportId:o})}))));const t=Eo();this._broadcasterTransport.onProduceData.watch((e=>{var i;return(null==(i=e.producerOptions.appData)?void 0:i.transactionId)===t})).then((({callback:e})=>{e({id:c})}));const i=yield this._broadcasterTransport.msTransport.produceData({appData:{transactionId:t}});this._handleMessage(e,i)}if(this._ackTransport=this._transportRepository.getTransport(this._localPerson.id,o),!this._ackTransport)throw gs({operationName:"Sender.startForwarding",context:this._context,info:_(g({},Dc.internal),{detail:"_ackTransport not found"}),path:jc.prefix,channel:this.channel,payload:{ackTransportOptions:a,broadcasterTransportOptions:r}});const l=yield this._produce(t,this._broadcasterTransport);this._setupTransportAccessForStream(t,this._broadcasterTransport,l),jc.debug("[end] Sender startForwarding",{forwardingId:i});let h=this.channel._getPublication(i);h||(h=(yield this.channel.onStreamPublished.watch((e=>e.publication.id===i),this._context.config.rtcApi.timeout).catch((()=>{throw gs({operationName:"Sender.startForwarding",context:this._context,info:_(g({},Dc.timeout),{detail:"SfuBotMember onStreamPublished"}),path:jc.prefix,channel:this.channel,payload:{forwardingId:i}})}))).publication);const u=new Uc(e,this.publication,h);this.forwarding=u;const p=this.channel.subscriptions.find((e=>e.publication.id===this.publication.id)),[m]=l.rtpParameters.codecs;return p.codec=m,_s(t,this._bot.id,(e=>!!e.find((e=>e.type.includes("local-candidate"))))).then((()=>b(this,null,(function*(){const e=yield ms({operationName:"startForwarding/waitForLocalStats",channel:this.channel});jc.debug(e,"forwarding connection connected",{broadcasterTransportId:n})})))).catch((()=>{})),u}))}_listenStreamEnableChange(e){this._unsubscribeStreamEnableChange&&this._unsubscribeStreamEnableChange();const{removeListener:t}=e._onEnableChanged.add((e=>b(this,null,(function*(){yield this._replaceTrack(e).catch((e=>{jc.warn(xc({detail:"replaceTrack failed",operationName:"Sender._listenStreamEnableChange",bot:this._bot,payload:e}))}))}))));this._unsubscribeStreamEnableChange=t}_produce(e,t){return b(this,null,(function*(){var i,n,r,s,o,a,c,d;this.publication._onReplaceStream.add((e=>b(this,null,(function*(){this._listenStreamEnableChange(e),yield this._replaceTrack(e.track)})))).disposer(this._disposer),this._listenStreamEnableChange(e);const l=Eo(),h={track:e.track,stopTracks:!1,appData:{transactionId:l},disableTrackOnPause:!1},u=this.publication.encodings;u&&(h.encodings=u),this.publication._onEncodingsChanged.add((e=>b(this,null,(function*(){yield pa(v.rtpSender,e).catch((e=>{jc.error("_onEncodingsChanged failed",e,this)}))})))).disposer(this._disposer);const p=this.publication.codecCapabilities,m=null!=(n=null==(i=this._transportRepository.rtpCapabilities)?void 0:i.codecs)?n:[];jc.debug("select codec",{codecCapabilities:p,deviceCodecs:m});const[f]=p.map((e=>{if(e.mimeType.toLowerCase().includes("video")){const t=m.find((t=>{var i;return t.mimeType.toLowerCase()===e.mimeType.toLowerCase()&&!(Object.keys(null!=(i=e.parameters)?i:{}).length>0&&!(0,Fc.default)(e.parameters,t.parameters))}));return t}const t=m.find((t=>t.mimeType.toLowerCase()===e.mimeType.toLowerCase()));return t}));if(jc.debug("selected codec",{codec:f}),f){const[t,i]=f.mimeType.split("/");h.codec=_(g({},f),{mimeType:`${t}/${i.toUpperCase()}`}),"video"===e.contentType&&this._fixVideoCodecWithParametersOrder(f)}else p.length>0&&jc.warn("preferred codec not supported",xc({channel:this.channel,detail:"preferred codec not supported",operationName:"Sender._produce",bot:this._bot,payload:{codecCapabilities:p,deviceCodecs:m}}));if("audio"===e.contentType){const e=null==(s=null==(r=p.find((e=>"audio/opus"===e.mimeType.toLowerCase())))?void 0:r.parameters)?void 0:s.usedtx;!1!==e&&(h.codecOptions=_(g({},h.codecOptions),{opusDtx:!0}));const t=null==(a=null==(o=p.find((e=>"audio/opus"===e.mimeType.toLowerCase())))?void 0:o.parameters)?void 0:a.stereo;t&&(h.codecOptions=_(g({},h.codecOptions),{opusStereo:!0}));const i=null==(d=null==(c=p.find((e=>"audio/opus"===e.mimeType.toLowerCase())))?void 0:c.parameters)?void 0:d.useinbandfec;i&&(h.codecOptions=_(g({},h.codecOptions),{opusFec:!0}))}t.onProduce.watch((e=>{var t;return(null==(t=e.producerOptions.appData)?void 0:t.transactionId)===l}),this._context.config.rtcConfig.timeout).then((e=>b(this,null,(function*(){try{const{producerId:i}=yield this._api.createProducer({botId:this._bot.id,transportId:t.id,forwardingId:this.forwardingId,producerOptions:e.producerOptions});e.callback({id:i})}catch(i){e.errback(i)}})))),jc.debug("[start] msTransport.produce",this);const v=yield t.msTransport.produce(h).catch((e=>{throw gs({operationName:"Sender._produce",context:this._context,info:_(g({},Dc.internal),{detail:"msTransport.produce failed"}),path:jc.prefix,channel:this.channel,error:e})}));return jc.debug("[end] msTransport.produce",this),this._producer=v,ma()&&u.length>0&&(yield pa(v.rtpSender,u).catch((e=>{jc.error("_onEncodingsChanged failed",e,this)}))),v}))}_fixVideoCodecWithParametersOrder(e){const t=this._broadcasterTransport.msTransport._handler,i=t=>t.mimeType===e.mimeType&&(!(e.parameters&&Object.keys(e.parameters).length>0)||!!(0,Fc.default)(t.parameters,e.parameters)),n=(e,t)=>{for(const i of Object.keys(e))"payloadType"!==i&&(e[i]=t[i])};if(t._sendingRtpParametersByKind){const e=t._sendingRtpParametersByKind["video"],r=e.codecs.find(i);if(e&&r){const t=JSON.parse(JSON.stringify(e)),[i]=e.codecs,s=JSON.parse(JSON.stringify(i));n(i,r),n(r,s),jc.debug("sort _sendingRtpParametersByKind",{origin:t,new:e.codecs})}}if(t._sendingRemoteRtpParametersByKind){const e=t._sendingRemoteRtpParametersByKind["video"],r=e.codecs.find(i);if(e&&r){const t=JSON.parse(JSON.stringify(e)),[i]=e.codecs,s=JSON.parse(JSON.stringify(i));n(i,r),n(r,s),jc.debug("sort _sendingRemoteRtpParametersByKind",{origin:t,new:e.codecs})}}}_setupTransportAccessForStream(e,t,i){e._getTransportCallbacks[this._bot.id]=()=>({rtcPeerConnection:t.pc,connectionState:t.connectionState,info:this}),e._getStatsCallbacks[this._bot.id]=()=>b(this,null,(function*(){if(i.closed)return delete e._getStatsCallbacks[this._bot.id],[];const n=yield i.getStats();let r=ps(n);return r=r.map((e=>(e["sfuTransportId"]=t.id,e))),r})),this._disposer.push((()=>{delete e._getTransportCallbacks[this._bot.id],delete e._getStatsCallbacks[this._bot.id]})),t.onConnectionStateChanged.add((t=>{e.onConnectionStateChanged.emit({remoteMember:this._bot,state:t})})).disposer(this._disposer),e.onConnectionStateChanged.emit({remoteMember:this._bot,state:t.connectionState})}_handleMessage(e,t){e.on("message",(e=>b(this,null,(function*(){try{const{type:n,payload:r,id:s}=JSON.parse(e);switch(n){case"request":{const{subscriberId:e,publicationId:n}=r;jc.debug("ackConsume",{subscriberId:e,publicationId:n});const o=this.channel.subscriptions.find((t=>t.publication.id===n&&t.subscriber.id===e));o||(yield this.channel.onPublicationSubscribed.watch((({subscription:t})=>t.publication.id===n&&t.subscriber.id===e),this._bot.options.ackTimeout).catch((t=>{throw gs({operationName:"Sender._handleMessage",context:this._context,info:_(g({},Dc.timeout),{detail:"ackConsume publication.onSubscribed"}),path:jc.prefix,channel:this.channel,error:t,payload:{subscriberId:e,subscriptions:this.channel.subscriptions}})})));for(let r=0;r<10;r++){try{t.send(JSON.stringify({type:"response",id:s}))}catch(i){jc.error(gs({operationName:"Sender._handleMessage",context:this._context,info:_(g({},Dc.internal),{detail:"An error occurred in producer.send"}),path:jc.prefix,channel:this.channel,error:i,payload:{subscriberId:e,subscriptions:this.channel.subscriptions}}))}if(yield new Promise((e=>setTimeout(e,1e3))),this.closed)break}jc.debug("ackConsume accepted",{subscriberId:e,publicationId:n})}break}}catch(i){jc.error("_handleMessage",i)}}))))}unproduce(){this._producer&&(this._producer.close(),this._producer=void 0)}_replaceTrack(e){return b(this,null,(function*(){var t,i;yield null==(i=null==(t=this._producer)?void 0:t.replaceTrack)?void 0:i.call(t,{track:e}).catch((e=>{throw gs({operationName:"Sender._replaceTrack",context:this._context,info:Dc.internal,error:e,path:jc.prefix,channel:this.channel})}))}))}close(){this.closed=!0,this._disposer.dispose(),this._unsubscribeStreamEnableChange&&this._unsubscribeStreamEnableChange()}get pc(){var e;return null==(e=this._broadcasterTransport)?void 0:e.pc}},Bc=new si("packages/sfu-bot/src/connection/index.ts"),Hc=class{constructor(e,t,i,n,r,s){this._api=e,this.channel=t,this.localPerson=i,this.remoteMember=n,this._transportRepository=r,this._context=s,this.type="sfu",this.onDisconnect=new di,this.onClose=new di,this.closed=!1,this._receivers={},this._senders={}}addSender(e){const t=new Vc(e,this.channel,this._api,this._transportRepository,this.localPerson,this.remoteMember,this.localPerson.iceManager,this._context);return this._senders[e.id]=t,t}removeSender(e){Bc.debug("removeSender",e);const t=this._senders[e];t&&t.unproduce()}startSubscribing(e){return b(this,null,(function*(){const t=new Mc(e,this._api,this._transportRepository,this.localPerson,this.remoteMember,this.localPerson.iceManager,this._context);this._receivers[e.id]=t;const i=Bc.debug("[start] _startSubscribing consume"),{stream:n,codec:r}=yield t.consume().catch((t=>{throw Bc.error("[failed] _startSubscribing consume",gs({operationName:"SFUConnection.startSubscribing",context:this._context,channel:this.channel,info:_(g({},Dc.internal),{detail:"failed to receiver.consume"}),error:t,path:Bc.prefix,payload:{subscription:e.toJSON()}})),t}));Bc.elapsed(i,"[end] _startSubscribing consume"),e.codec=r,e.stream=n}))}stopSubscribing(e){return b(this,null,(function*(){const t=this._receivers[e.id];t&&t.unconsume()}))}stopPublishing(e){return b(this,null,(function*(){this.removeSender(e.id)}))}close(){this.closed||(Bc.debug("close sfu connection",{remote:this.remoteMember,local:this.localPerson}),this.closed=!0,Object.values(this._senders).forEach((e=>{e.close()})),Object.values(this._receivers).forEach((e=>{e.close()})),this._senders={},this._receivers={},this.onClose.emit())}_getReceiver(e){return this._receivers[e]}changePreferredEncoding(e){return b(this,null,(function*(){var t;const i=e.preferredEncoding,n=null==(t=e.publication.origin)?void 0:t.encodings;if(Bc.debug("changePreferredEncoding",{preferredEncoding:i,encodings:n,subscription:e}),!i)throw gs({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:Dc.invalidPreferredEncoding,path:Bc.prefix,payload:{subscription:e}});if(!n||0===n.length)throw gs({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:Dc.invalidEncodings,path:Bc.prefix,payload:{subscription:e}});const r=kc(i,n),s=this._getReceiver(e.id);if(!s)throw gs({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:Dc.receiverNotFound,path:Bc.prefix,payload:{subscription:e}});const o=s.transport;if(!o)throw gs({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:_(g({},Dc.internal),{detail:"transport not found"}),path:Bc.prefix,payload:{subscription:e}});const a=s.consumer;if(!a)throw gs({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:Dc.consumerNotFound,path:Bc.prefix,payload:{subscription:e}});yield this._api.changeConsumerLayer({transportId:o.id,consumerId:a.id,publicationId:e.publication.id,spatialLayer:r})}))}};w(),w();var Wc=10,Kc=new si("packages/sfu-bot/src/member.ts"),Gc=class extends Bo{constructor(e){super(e),this.side="remote",this.subtype=Gc.subtype,this.type="bot",this._connections={},this.onForwardingStarted=new di,this.onForwardingStopped=new di,this.onForwardingListChanged=new di,this._startForwardQueue=new as,this._forwardings={},this.stopForwarding=e=>new Promise(((t,i)=>b(this,null,(function*(){const n=Kc.info("[start] stopForwarding",yield ms({operationName:"SfuBotMember.stopForwarding",channel:this.channel}));if("joined"!==this.state)return void i(gs({operationName:"SfuBotMember.stopForwarding",context:this._context,info:Dc.sfuBotNotInChannel,path:Kc.prefix,channel:this.channel,payload:{status:this.state}}));const r="string"===typeof e?e:e.id,s=this._forwardings[r];if(!s)return void i(gs({operationName:"SfuBotMember.stopForwarding",context:this._context,info:Dc.forwardingNotFound,path:Kc.prefix,channel:this.channel,payload:{forwardingId:r,_forwardings:Object.keys(this._forwardings)}}));delete this._forwardings[s.id];const{promise:o,fulfilled:a}=this._api.stopForwarding({botId:this.id,forwardingId:r});let c=!1;o.catch((e=>{c=!0,i(e)})),this.onForwardingStopped.watch((e=>e.forwarding.id===r),this._context.config.rtcApi.timeout).catch((e=>{c||i(gs({operationName:"SfuBotMember.stopForwarding",context:this._context,info:_(g({},Dc.timeout),{detail:"onForwardingStopped"}),path:Kc.prefix,channel:this.channel,payload:{fulfilled:a},error:e}))})).then((()=>b(this,null,(function*(){Kc.elapsed(n,"[end] stopForwarding",yield ms({operationName:"SfuBotMember.stopForwarding",channel:this.channel})),t()}))))})))),this._api=e.api,this._context=e.context,this._transportRepository=e.transportRepository,this.options=e.options,this.onLeft.once((()=>{Kc.debug("SfuBotMember left: ",{id:this.id}),Object.values(this._connections).forEach((e=>{e.close()})),this._connections={}}))}get forwardings(){return Object.values(this._forwardings)}_getConnection(e){return this._connections[e]}_getOrCreateConnection(e){var t;const i=null!=(t=this._getConnection(e.id))?t:this._createConnection(this.channel,e,this);return i}_createConnection(e,t,i){const n=new Hc(i._api,e,t,i,this._transportRepository,this._context);return n.onClose.once((()=>{delete this._connections[t.id]})),this._connections[t.id]=n,n}startForwarding(e){return b(this,arguments,(function*(e,t={}){const i=Kc.info("[start] startForwarding",yield ms({operationName:"SfuBotMember.startForwarding",channel:this.channel})),n=yield this._startForwardQueue.push((()=>this._startForwarding(e,t)));return Kc.elapsed(i,"[end] startForwarding",yield ms({operationName:"SfuBotMember.startForwarding",channel:this.channel})),n}))}_startForwarding(e,t){return b(this,null,(function*(){if(void 0==t.maxSubscribers&&(t.maxSubscribers=Wc),0===t.maxSubscribers)throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:Dc.maxSubscribersMustNotBeZero,path:Kc.prefix,payload:{configure:t}});if("joined"!==this.state)throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:Dc.sfuBotNotInChannel,path:Kc.prefix,payload:{status:this.state}});if(!this.channel._getPublication(e.id))throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:ls.publicationNotExist,path:Kc.prefix});const i=this.channel.localPerson;if(!i)throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:ls.localPersonNotJoinedChannel,path:Kc.prefix});if(i.id!==e.publisher.id)throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,info:Dc.remotePublisherId,path:Kc.prefix,channel:this.channel});const n=Kc.debug("[start] SfuBotMember startForwarding",{publication:e.toJSON(),configure:t}),r=this._getOrCreateConnection(i),s=r.addSender(e),o=yield s.startForwarding(t).catch((t=>{throw gs({operationName:"SfuBotMember._startForwarding",context:this._context,info:_(g({},Dc.internal),{detail:"[failed] SfuBotMember startForwarding"}),path:Kc.prefix,channel:this.channel,error:t,payload:{publication:e.toJSON()}})}));return this._forwardings[o.id]=o,this.listenStopForwardEvent(o),this.onForwardingStarted.emit({forwarding:o}),this.onForwardingListChanged.emit(),Kc.elapsed(n,"[end] SfuBotMember startForwarding",{forwarding:o.toJSON()}),o}))}listenStopForwardEvent(e){const{removeListener:t}=this.channel.onStreamUnpublished.add((i=>{if(i.publication.id===e.id){t(),e._stop();const i=e.originPublication,n=this._getConnection(i.publisher.id);n&&n.removeSender(i.id),this.onForwardingStopped.emit({forwarding:e}),this.onForwardingListChanged.emit()}}))}_dispose(){}},qc=Gc;qc.subtype="sfu",w(),w(),w(),w();var zc={domain:"sfu.skyway.ntt.com",secure:!0,version:3};w();var Jc={invalidParameter:{name:"invalidParameter",detail:"",solution:""},invalidRequestParameter:{name:"invalidRequestParameter",detail:"ãªã¯ã¨ã¹ãã®å¤ãä¸æ­£ã§ã",solution:"æ­£ããå¤ãå¥åãã¦ãã ãã"},notFound:{name:"notFound",detail:"å¯¾è±¡ã®ãªã½ã¼ã¹ãè¦ã¤ããã¾ãã",solution:"å¯¾è±¡ã®ãªã½ã¼ã¹ãå­å¨ãããç¢ºããã¦ãã ãã"},maxSubscriberExceededError:{name:"maxSubscribersExceededError",detail:"forwardingã®maxSubscribersã®å¶éãè¶ãã¦ãã¾ããmaxSubscribersã®å¤ãè¶ãã¦Subscribeãããã¨ã¯ã§ãã¾ãã",solution:"maxSubscribersã®ç¯å²åã§ãå©ç¨ãã ãã"},quotaExceededError:{name:"quotaExceededError",detail:"ãªã½ã¼ã¹ã®å¶ééãè¶ãã¦ãªã½ã¼ã¹ãå©ç¨ãããã¨ã¯ã§ãã¾ãã",solution:"ãªã½ã¼ã¹å¶ééã®ç¯å²åã§ãå©ç¨ãã ãã"},timeout:{name:"timeout",detail:"",solution:""},insufficientPermissions:{name:"insufficientPermissions",detail:"tokenã®æ¨©éãä¸è¶³ãã¦ãã¾ã",solution:"tokenã«å¿è¦ãªæ¨©éãä»ä¸ãã¦ãã ãã"},backendError:{name:"backendError:",detail:"",solution:""}};function Yc({operationName:e,info:t,error:i,path:n,payload:r}){return new ai({error:i,info:t,payload:{payload:r,operationName:e},path:n})}function Xc({appId:e,detail:t,channelId:i,operationName:n,payload:r,memberId:s,botId:o}){const a={operationName:n,payload:r,detail:t,appId:e,channelId:i,memberId:s,botId:o};return a}w();var $c=new si("packages/sfu-api-client/src/api.ts"),Qc=class{constructor(e,t){this._token=e,this._headers={authorization:`Bearer ${this._token}`},this.options=g(g({},zc),t),this.endpoint=`http${this.options.secure?"s":""}://${this.options.domain}/v${this.options.version}`,this.http=new os(this.endpoint),si.level=this.options.log.level,si.format=this.options.log.format,$c.debug("SfuRestApiClient spawned",{endpoint:this.endpoint})}updateToken(e){this._token=e}_commonErrorHandler(e,t){switch(null==e?void 0:e.status){case 401:return Yc({operationName:t,info:Jc.invalidRequestParameter,path:$c.prefix,payload:e});case 403:return Yc({operationName:t,info:Jc.insufficientPermissions,path:$c.prefix,payload:e});case 404:return Yc({operationName:t,info:Jc.notFound,path:$c.prefix,payload:e});case 429:return Yc({operationName:t,info:Jc.quotaExceededError,path:$c.prefix,payload:e});default:return Yc({operationName:t,info:Jc.backendError,path:$c.prefix,payload:e})}}createBot(e){return b(this,arguments,(function*({appId:e,channelId:t}){const i=yield this.http.post("/bots",{appId:e,channelId:t},{headers:{authorization:`Bearer ${this._token}`}}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.createBot")}));return i.id}))}deleteBot(e){return b(this,arguments,(function*({botId:e}){yield this.http.delete(`/bots/${e}`,{headers:{authorization:`Bearer ${this._token}`}}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.deleteBot")}))}))}startForwarding(e){return b(this,arguments,(function*({botId:e,publicationId:t,maxSubscribers:i,contentType:n,publisherId:r}){const s=new cs,o={publicationId:t,maxSubscribers:i,contentType:n[0].toUpperCase()+n.slice(1),publisherId:r},a=yield this.http.post(`/bots/${e}/forwardings`,o,{headers:{authorization:`Bearer ${this._token}`},retry:e=>b(this,null,(function*(){return![400,403,429].includes(e.status)&&(yield s.wait())}))}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.startForwarding")}));return s.count>0&&$c.warn("success to retry startForwarding",Xc({operationName:"SfuRestApiClient.startForwarding",detail:"success to retry startForwarding",botId:e,memberId:r,payload:{publicationId:t,count:s.count}})),a}))}createProducer(e){return b(this,arguments,(function*({botId:e,forwardingId:t,transportId:i,producerOptions:n}){const r=new cs,s=yield this.http.put(`/bots/${e}/forwardings/${t}/transport/producer`,{transportId:i,producerOptions:n},{headers:{authorization:`Bearer ${this._token}`},retry:()=>b(this,null,(function*(){return yield r.wait()}))}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.createProducer")}));return r.count>0&&$c.warn("success to retry createProducer",Xc({operationName:"SfuRestApiClient.createProducer",detail:"success to retry createProducer",botId:e,payload:{forwardingId:t,transportId:i,count:r.count}})),s}))}createConsumer(e){return b(this,arguments,(function*({botId:e,forwardingId:t,rtpCapabilities:i,subscriptionId:n,subscriberId:r,spatialLayer:s,originPublicationId:o}){const a=new cs({times:5,interval:100}),c={rtpCapabilities:i,subscriptionId:n,subscriberId:r,spatialLayer:s,originPublicationId:o},d=yield this.http.post(`/bots/${e}/forwardings/${t}/transport/consumers`,c,{retry:e=>b(this,null,(function*(){return![400,429].includes(e.status)&&(yield a.wait())})),headers:{authorization:`Bearer ${this._token}`}}).catch((e=>{throw 429===e.status?Yc({operationName:"SfuRestApiClient.createConsumer",info:Jc.maxSubscriberExceededError,path:$c.prefix,payload:e}):this._commonErrorHandler(e,"SfuRestApiClient.createConsumer")}));return a.count>0&&$c.warn("success to retry createConsumer",Xc({operationName:"SfuRestApiClient.createConsumer",detail:"success to retry createConsumer",botId:e,payload:{forwardingId:t,count:a.count}})),$c.debug("response of createConsumer",d),d}))}connect(e){return b(this,arguments,(function*({transportId:e,dtlsParameters:t}){const i=new cs,n={transportId:e,dtlsParameters:t},r=yield this.http.put("/transport/connection",n,{headers:{authorization:`Bearer ${this._token}`},retry:()=>b(this,null,(function*(){return yield i.wait()}))}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.connect")}));return i.count>0&&$c.warn("success to retry connect",Xc({operationName:"SfuRestApiClient.connect",detail:"success to retry connect",payload:{transportId:e,count:i.count}})),r}))}changeConsumerLayer(e){return b(this,arguments,(function*({transportId:e,consumerId:t,spatialLayer:i,publicationId:n}){const r=yield this.http.put(`transport/consumers/${t}/layer`,{transportId:e,spatialLayer:i,publicationId:n},{headers:{authorization:`Bearer ${this._token}`}}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.changeConsumerLayer")}));return r}))}stopForwarding({botId:e,forwardingId:t}){let i=!1;const n=this.http.delete(`/bots/${e}/forwardings/${t}`,{headers:{authorization:`Bearer ${this._token}`}}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.stopForwarding")})).then((e=>{i=e}));return{promise:n,fulfilled:i}}iceRestart(e){return b(this,arguments,(function*({transportId:e}){const t=yield this.http.put("/transport/connection/ice",{transportId:e},{headers:this._headers}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.iceRestart")}));return t.iceParameters}))}getRtpCapabilities(e){return b(this,arguments,(function*({botId:e,forwardingId:t,originPublicationId:i}){const n=new cs,r=yield this.http.get(`/bots/${e}/forwardings/${t}/transport/rtp_capabilities?originPublicationId=${i}`,{headers:{authorization:`Bearer ${this._token}`},retry:()=>b(this,null,(function*(){return yield n.wait()}))}).catch((e=>{throw this._commonErrorHandler(e,"SfuRestApiClient.getRtpCapabilities")}));return n.count>0&&$c.warn("getCapabilities to retry connect",Xc({operationName:"SfuRestApiClient.getRtpCapabilities",detail:"getCapabilities to retry connect",botId:e,payload:{forwardingId:t,count:n.count}})),r.rtpCapabilities}))}},Zc=_(g({},zc),{endpointTimeout:3e4,ackTimeout:1e4,peerConnectionJitterTimeout:5e3,disableRestartIce:!1});w(),w();var ed=S(ii());w();var td=new si("packages/sfu-bot/src/connection/transport/transport.ts"),id=class{constructor(e,t,i,n,r){var s,o,a;this.msTransport=e,this._bot=t,this._iceManager=i,this._api=n,this._context=r,this._backoffIceRestart=new cs({times:10,interval:100,jitter:100}),this._connectionState="new",this.onProduce=new di,this.onProduceData=new di,this.onMediasoupConnectionStateChanged=new di,this.onConnectionStateChanged=new di,this.restartIce=()=>b(this,null,(function*(){if(this._backoffIceRestart.exceeded)return td.error("_iceRestartedCount exceeded",gs({operationName:"SfuTransport.restartIce",context:this._context,info:Dc.netWorkError,path:td.prefix})),void this._setConnectionState("disconnected");td.warn("[start] restartIce",xc({bot:this._bot,detail:"start restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}}));const e=()=>"left"===this._bot.state?(td.debug("bot already left",this),this._setConnectionState("disconnected"),td.warn("[end] restartIce",xc({bot:this._bot,detail:"end restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}})),!0):"connected"===this.msTransport.connectionState?(this._backoffIceRestart.reset(),this._setConnectionState("connected"),td.warn("[end] restartIce",xc({bot:this._bot,detail:"end restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}})),!0):void 0;if(this._setConnectionState("reconnecting"),yield this._backoffIceRestart.wait(),e())return;let t=yield this._iceManager.updateIceParams().catch((e=>e));if(t)return td.warn("updateIceParams failed",xc({operationName:"SfuTransport.restartIce",detail:"updateIceParams failed",bot:this._bot,payload:{transport:this}}),t),void(yield this.restartIce());if(yield this.msTransport.updateIceServers({iceServers:this._iceManager.iceServers}),e())return;const i=yield this._mediasoupRestartIce();if(t=yield this._waitForMsConnectionState("connected",this._options.peerConnectionJitterTimeout).catch((e=>e)),!t&&e())return i;yield this.restartIce()})),this._waitForMsConnectionState=(e,t=1e4)=>b(this,null,(function*(){e!==this.msTransport.connectionState&&(yield this.onMediasoupConnectionStateChanged.watch((()=>e===this.msTransport.connectionState),t).catch((e=>{throw gs({operationName:"SfuTransport._waitForMsConnectionState",context:this._context,info:_(g({},Dc.timeout),{detail:"waitForConnectionState timeout"}),error:e,path:td.prefix})})))})),this._onConnect=e=>(t,i,n)=>b(this,[t,i,n],(function*({dtlsParameters:t},i,n){try{td.debug("[start] transport connect",{transportId:e}),yield this._api.connect({transportId:e,dtlsParameters:t}),td.debug("[end] transport connect",{transportId:e}),i()}catch(r){td.error("[failed] transport connect",{error:r,transportId:e}),n(r)}}));const c=r.plugins.find((e=>e.subtype===cd.subtype));this._options=c.options,td.debug("peerConfig",null!=(a=null==(o=null==(s=this.pc)?void 0:s.getConfiguration)?void 0:o.call(s))?a:{}),e.on("connect",((t,i,n)=>this._onConnect(e.id)(t,i,n))),e.on("connectionstatechange",(e=>this.onMediasoupConnectionStateChanged.emit(e))),e.on("produce",((e,t,i)=>{this.onProduce.emit({producerOptions:e,callback:t,errback:i})})),e.on("producedata",((e,t,i)=>{this.onProduceData.emit({producerOptions:e,callback:t,errback:i})})),this.onMediasoupConnectionStateChanged.add((e=>b(this,null,(function*(){switch(ms({operationName:"onMediasoupConnectionStateChanged",channel:this._bot.channel}).then((i=>{td.debug(i,{state:e,transportId:this.id,bot:t})})),e){case"disconnected":case"failed":{if("reconnecting"===this._connectionState)return;const e=yield this._waitForMsConnectionState("connected",this._options.peerConnectionJitterTimeout).catch((e=>e));e&&"reconnecting"!==this._connectionState&&!0!==t.options.disableRestartIce&&(yield this.restartIce())}break;case"connecting":case"connected":this._setConnectionState(e);break;case"closed":this._setConnectionState("disconnected");break}td.debug("onMediasoupConnectionStateChanged",this)}))))}get pc(){var e,t,i;return null!=(i=null==(t=null==(e=this.msTransport)?void 0:e._handler)?void 0:t._pc)?i:{}}get id(){return this.msTransport.id}get connectionState(){return this._connectionState}toJSON(){return{id:this.id,direction:this.msTransport.direction,connectionState:this._connectionState}}close(){var e;(null==(e=this.pc)?void 0:e.peerIdentity)&&this.pc.peerIdentity.catch((()=>{})),this.msTransport.close()}_setConnectionState(e){this._connectionState!==e&&(this._connectionState=e,td.debug("onConnectionStateChanged",this),this.onConnectionStateChanged.emit(e))}_mediasoupRestartIce(){return b(this,null,(function*(){const e=yield this._api.iceRestart({transportId:this.id}).catch((e=>e));return e instanceof Error?(td.warn("iceRestart failed",xc({operationName:"SfuTransport._mediasoupRestartIce",detail:"iceRestart failed",bot:this._bot,payload:{transport:this}}),e),void(yield this.restartIce())):(yield this.msTransport.restartIce({iceParameters:e}),e)}))}},nd=new si("packages/sfu-bot/src/connection/transport/transportRepository.ts"),rd=class{constructor(e,t){this._context=e,this._api=t,this.onTransportCreated=new di,this._transports={},this.getTransport=(e,t)=>this._transports[e+t];const{browserName:i,browserVersion:n}=Es();nd.debug("runtime info",{browserName:i,browserVersion:n}),this._device="Safari"===i&&void 0==n?new ed.Device({handlerName:"Safari12"}):new ed.Device}get rtpCapabilities(){if(this._device.loaded)return this._device.rtpCapabilities}loadDevice(e){return b(this,null,(function*(){this._device.loaded||(yield this._device.load({routerRtpCapabilities:e}).catch((t=>{throw gs({operationName:"TransportRepository.loadDevice",context:this._context,info:_(g({},Dc.internal),{detail:"loadDevice failed"}),path:nd.prefix,payload:{rtpCapabilities:e},error:t})})),nd.debug("device loaded",{routerRtpCapabilities:e,rtpCapabilities:this._device.rtpCapabilities}))}))}createTransport(e,t,i,n,r){const s="send"===n?e=>this._device.createSendTransport(e):e=>this._device.createRecvTransport(e),o=s(_(g({},i),{iceServers:r.iceServers,iceTransportPolicy:"turnOnly"===this._context.config.rtcConfig.turnPolicy?"relay":void 0,additionalSettings:this._context.config.rtcConfig})),a=new id(o,t,r,this._api,this._context);return this._transports[e+o.id]=a,this.onTransportCreated.emit(o.id),a}deleteTransports(e){Object.entries(g({},this._transports)).forEach((([t,i])=>{t.includes(e)&&(i.close(),delete this._transports[t])}))}};w();var sd="1.2.2",od=new si("packages/sfu-bot/src/plugin.ts"),ad=class extends Fo{constructor(e={}){super(),this.subtype=ad.subtype,this._createRemoteMember=(e,t)=>{const i=new qc(_(g({},this._context),{channel:e,id:t.id,name:t.name,metadata:t.metadata,plugin:this,api:this._api,context:this._context,transportRepository:this._transportRepository,options:this.options}));return i},this.createBot=e=>b(this,null,(function*(){var t;const i=od.info("[start] createBot",yield ms({operationName:"SfuBotPlugin.createBot",channel:e})),n=yield this._api.createBot({appId:this._context.authToken.scope.app.id,channelId:e.id}),r=null!=(t=e._getMember(n))?t:(yield e.onMemberJoined.watch((e=>e.member.id===n),this._context.config.rtcApi.timeout).catch((e=>{throw gs({operationName:"SfuBotPlugin.createBot",info:_(g({},Dc.timeout),{detail:"onMemberJoined"}),path:od.prefix,error:e,context:this._context})}))).member;return od.elapsed(i,"[end] createBot",yield ms({operationName:"SfuBotPlugin.createBot",channel:e})),r})),this.deleteBot=(e,t)=>b(this,null,(function*(){return new Promise(((i,n)=>b(this,null,(function*(){const r=od.info("[start] deleteBot",yield ms({operationName:"SfuBotPlugin.deleteBot",channel:e}));let s=!1;this._api.deleteBot({botId:t}).catch((e=>{s=!0,n(e)})),e.onMemberLeft.watch((e=>e.member.id===t),this._context.config.rtcApi.timeout).catch((t=>{s||n(gs({operationName:"SfuBotPlugin.deleteBot",info:_(g({},Dc.timeout),{detail:"onMemberLeft"}),path:od.prefix,channel:e,error:t,context:this._context}))})).then((()=>b(this,null,(function*(){od.elapsed(r,"[end] deleteBot",yield ms({operationName:"SfuBotPlugin.deleteBot",channel:e})),i()}))))}))))})),this.options=g(g({},Zc),e),this._onContextAttached.once((e=>{si.level=e.config.log.level,si.format=e.config.log.format,od.info("SfuBotPlugin spawned",{operationName:"SfuBotPlugin.constructor",endpoint:{sfu:this.options.domain},options:this.options,sdkName:"sfu-bot",sdkVersion:sd}),this._api=new Qc(e.authTokenString,_(g({},this.options),{log:e.config.log})),this._transportRepository=new rd(e,this._api),e._onTokenUpdated.add((e=>{this._api.updateToken(e)}))})),this._whenDisposeLocalPerson=e=>b(this,null,(function*(){this._transportRepository.deleteTransports(e.id)}))}},cd=ad;cd.subtype=qc.subtype,w();var dd=10,ld=new si("packages/room/src/member/local/sfu.ts"),hd=class extends Ac{constructor(e,t){super(e,t)}publish(e){return b(this,arguments,(function*(e,t={}){var i;if(e instanceof Zo)throw Pc({operationName:"LocalSFURoomMemberImpl.publish",context:this._context,room:this.room,info:Rc.sfuRoomNotSupportDataStream,path:ld.prefix});t.maxSubscribers=null!=(i=t.maxSubscribers)?i:dd;const n=yield this._local.publish(e,t),r=this.room._channel.members.find((e=>e.subtype===qc.subtype));if(!r)throw Pc({operationName:"LocalSFURoomMemberImpl.publish",context:this._context,room:this.room,info:Dc.sfuBotNotInChannel,path:ld.prefix});const s=yield r.startForwarding(n,{maxSubscribers:t.maxSubscribers}),o=s.relayingPublication,a=this.room._addPublication(o);return this.onStreamPublished.emit({publication:a}),a}))}unpublish(e){return b(this,null,(function*(){const t="string"===typeof e?e:e.id,i=this.room._getPublication(t),n=i._publication.origin;if(!n)throw Pc({operationName:"LocalSFURoomMemberImpl.unpublish",context:this._context,room:this.room,info:Rc.publicationNotHasOrigin,path:ld.prefix});this._local.unpublish(n.id),yield this.room.onStreamUnpublished.watch((e=>e.publication.id===t),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"LocalSFURoomMemberImpl.unpublish",context:this._context,room:this.room,info:_(g({},Rc.timeout),{detail:"onStreamUnpublished"}),path:ld.prefix,error:e})})),this.onStreamUnpublished.emit({publication:i})}))}subscribe(e,t){return b(this,null,(function*(){const i="string"===typeof e?e:e.id,{subscription:n,stream:r}=yield this._local.subscribe(i,t),s=this.room._addSubscription(n);return{subscription:s,stream:r}}))}unsubscribe(e){return b(this,null,(function*(){const t="string"===typeof e?e:e.id;this._local.unsubscribe(t),yield this.room.onPublicationUnsubscribed.watch((e=>e.subscription.id===t),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"LocalSFURoomMemberImpl.unsubscribe",context:this._context,room:this.room,info:_(g({},Rc.timeout),{detail:"onPublicationUnsubscribed"}),path:ld.prefix,error:e})}))}))}_updateRoom(e){ld.debug("_updateRoom",{memberId:this.id}),this.room=e,this._listenRoomEvent()}};w();var ud=new si("packages/room/src/member/remote/base.ts"),pd=class extends Ic{constructor(e,t){super(e,t),this.side="remote",this.onPublicationSubscribed=new di,this.onPublicationUnsubscribed=new di,this.onSubscriptionListChanged=new di,this.onPublicationListChanged=new di,this._disposer=new hi,this.subscribe=e=>new Promise(((t,i)=>{if(!(this.member instanceof Ca))return void i(Pc({operationName:"RemoteRoomMemberImpl.subscribe",context:this.room._context,room:this.room,info:Rc.subscribeOtherMemberType,path:ud.prefix}));let n=!1;this.member.subscribe(e).catch((e=>{n=!0,i(e)})),this.onPublicationSubscribed.watch((t=>t.subscription.publication.id===e)).then((e=>t(e))).catch((e=>{n||i(e)}))})),this.unsubscribe=e=>new Promise(((t,i)=>{if(!(this.member instanceof Ca))return void i(Pc({operationName:"RemoteRoomMemberImpl.unsubscribe",context:this.room._context,room:this.room,info:Rc.subscribeOtherMemberType,path:ud.prefix}));let n=!1;this.member.unsubscribe(e).catch((e=>{n=!0,i(e)})),this.onPublicationUnsubscribed.watch((t=>t.subscription.id===e)).then((()=>t())).catch((e=>{n||i(e)}))})),t.onPublicationSubscribed.add((t=>{t.subscription.subscriber._member.id===e.id&&(this.onPublicationSubscribed.emit(t),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),t.onPublicationUnsubscribed.add((t=>{t.subscription.subscriber._member.id===e.id&&(this.onPublicationUnsubscribed.emit(t),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),e instanceof Ca&&e.onPublicationListChanged.pipe(this.onPublicationListChanged).disposer(this._disposer)}_dispose(){this._disposer.dispose()}};w();var md="packages/room/src/publication/index.ts",fd=class{constructor(e,t){var i;this._publication=e,this._room=t,this._disposer=new hi,this._events=new li,this.onCanceled=this._events.make(),this.onSubscribed=this._events.make(),this.onUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onEnabled=this._events.make(),this.onDisabled=this._events.make(),this.onStateChanged=this._events.make(),this.enable=()=>new Promise(((e,t)=>{this._origin?Promise.all([this._origin.enable(),this._publication.onEnabled.asPromise()]).then((()=>e())).catch(t):this._publication.enable().then(e).catch(t)})),this.disable=()=>new Promise(((e,t)=>{this._origin?Promise.all([this._origin.disable(),this._publication.onDisabled.asPromise()]).then((()=>e())).catch(t):this._publication.disable().then(e).catch(t)})),this.replaceStream=(e,t={})=>{this._preferredPublication.replaceStream(e,t)},this.id=e.id,this.contentType=e.contentType,this._origin=e.origin;{const e=null!=(i=this._origin)?i:this._publication;this.publisher=this._room._getMember(e.publisher.id)}this._setEvents()}_setEvents(){var e;this._room.onStreamUnpublished.add((e=>{e.publication.id===this.id&&(this.onCanceled.emit(),this._events.dispose())})),this._room.onPublicationSubscribed.add((e=>{e.subscription.publication.id===this.id&&(this.onSubscribed.emit({subscription:e.subscription}),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),this._room.onPublicationUnsubscribed.add((e=>{e.subscription.publication.id===this.id&&(this.onUnsubscribed.emit({subscription:e.subscription}),this.onSubscriptionListChanged.emit())})).disposer(this._disposer),this._publication.onEnabled.pipe(this.onEnabled),this._publication.onDisabled.pipe(this.onDisabled),this._publication.onStateChanged.pipe(this.onStateChanged);{const t=null!=(e=this._origin)?e:this._publication;t.onMetadataUpdated.pipe(this.onMetadataUpdated)}}get subscriptions(){return this._publication.subscriptions.map((e=>this._room._getSubscription(e.id)))}get _preferredPublication(){var e;return null!=(e=this._origin)?e:this._publication}get codecCapabilities(){return this._preferredPublication.codecCapabilities}get encodings(){return this._preferredPublication.encodings}get stream(){return this._preferredPublication.stream}get state(){return this._preferredPublication.state}get metadata(){return this._preferredPublication.metadata}cancel(){return b(this,null,(function*(){yield Promise.all([this._preferredPublication.cancel(),this.onCanceled.asPromise()])}))}updateMetadata(e){return b(this,null,(function*(){yield this._preferredPublication.updateMetadata(e)}))}updateEncodings(e){this._preferredPublication.updateEncodings(e)}_dispose(){this._disposer.dispose()}getStats(e){var t;if(this._origin){const e=null==(t=this._origin.subscriptions.find((e=>e.subscriber.subtype===qc.subtype)))?void 0:t.subscriber;if(!e)throw Pc({operationName:"RoomPublicationImpl.getStats",room:this._room,path:md,info:_(g({},Rc.notFound),{detail:"bot not found"})});return this._origin.getStats(e)}{const t="string"===typeof e?e:e.id;return this._publication.getStats(t)}}getRTCPeerConnection(e){var t;if(this._origin){const e=null==(t=this._origin.subscriptions.find((e=>e.subscriber.subtype===qc.subtype)))?void 0:t.subscriber;if(!e)throw Pc({operationName:"RoomPublicationImpl.getRTCPeerConnection",room:this._room,path:md,info:_(g({},Rc.notFound),{detail:"bot not found"})});return this._origin.getRTCPeerConnection(e)}{const t="string"===typeof e?e:e.id;return this._publication.getRTCPeerConnection(t)}}getConnectionState(e){var t;if(this._origin){const e=null==(t=this._origin.subscriptions.find((e=>e.subscriber.subtype===qc.subtype)))?void 0:t.subscriber;if(!e)throw Pc({operationName:"RoomPublicationImpl.getConnectionState",room:this._room,path:md,info:_(g({},Rc.notFound),{detail:"bot not found"})});return this._origin.getConnectionState(e)}{const t="string"===typeof e?e:e.id;return this._publication.getConnectionState(t)}}toJSON(){return{id:this.id,contentType:this.contentType,metadata:this.metadata,publisher:this.publisher,subscriptions:this.subscriptions,codecCapabilities:this.codecCapabilities,encodings:this.encodings,state:this.state}}};w();var gd=new si("packages/room/src/room/index.ts"),_d=class{constructor(){}},vd=_d;vd.Create=(e,t)=>b(_d,null,(function*(){var i,n;gd.info("room created",{operationName:"SkyWayRoom._Factory",sdkName:"room",sdkVersion:Id,init:t});const r=new cd(null==(i=null==t?void 0:t.options)?void 0:i.sfu);e.registerPlugin(r);const s=yield Ns.Create(e,{name:null!=(n=t.name)?n:Js(),metadata:t.metadata}),o=yield _d._Factory(e,t.type,s);return o})),vd.Find=(e,t,i,n)=>b(_d,null,(function*(){const r=new cd(null==n?void 0:n.sfu);e.registerPlugin(r);const s=yield Ns.Find(e,t),o=yield _d._Factory(e,i,s);return o})),vd.FindOrCreate=(e,t)=>b(_d,null,(function*(){var i;const n=new cd(null==(i=null==t?void 0:t.options)?void 0:i.sfu);e.registerPlugin(n);const r=yield Ns.FindOrCreate(e,g({},t)),s=yield _d._Factory(e,t.type,r);return s})),vd._Factory=(e,t,i)=>b(_d,null,(function*(){switch(t){case"p2p":return new bd(i);case"sfu":return yield Td.Create(e,i);default:throw gs({operationName:"SkyWayRoom._Factory",context:e,channel:i,info:Rc.notImplemented,path:gd.prefix})}}));w();var yd=new si("packages/room/src/room/base.ts"),Ed=class{constructor(e,t){this._channel=t,this._members={},this._publications={},this._subscriptions={},this._context=this._channel._context,this._events=new li,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.type=e,this._channel.onClosed.pipe(this.onClosed),this._channel.onMetadataUpdated.pipe(this.onMetadataUpdated),this._channel.onMemberMetadataUpdated.add((e=>{this._handleOnMemberMetadataUpdate(e)}))}_getMember(e){return this._members[e]}_getPublication(e){return this._publications[e]}_addPublication(e){const t=this._publications[e.id];if(t)return t;const i=new fd(e,this);return this._publications[e.id]=i,i}_getSubscription(e){return this._subscriptions[e]}_addSubscription(e){const t=this._subscriptions[e.id];if(t)return t;const i=new Rd(e,this);return this._subscriptions[e.id]=i,i}get id(){return this._channel.id}get name(){return this._channel.name}get metadata(){return this._channel.metadata}get state(){return this._channel.state}get disposed(){return this._channel.disposed}_handleOnMemberMetadataUpdate(e){const t=this._getMember(e.member.id);this.onMemberMetadataUpdated.emit({member:t,metadata:e.metadata})}get members(){return Object.values(this._members)}get publications(){return Object.values(this._publications)}get subscriptions(){return Object.values(this._subscriptions)}joinChannel(){return b(this,arguments,(function*(e={}){var t;if("opened"!==this.state)throw Pc({operationName:"RoomImpl.joinChannel",context:this._context,room:this,info:Rc.roomNotOpened,path:yd.prefix});e.name=null!=(t=e.name)?t:Js();const i=yield this._channel.join(e);return this._getMember(i.id)||(yield this.onMemberJoined.watch((e=>e.member._member.id===i.id),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"RoomImpl.joinChannel",context:this._context,room:this,info:_(g({},Rc.timeout),{detail:"RoomImpl onMemberJoined"}),path:yd.prefix,error:e})}))),i}))}leave(e){return b(this,null,(function*(){yield this._channel.leave(e._member)}))}moveRoom(e){return b(this,null,(function*(){return yield this._channel.moveChannel(e._local),e._updateRoom(this),e}))}updateMetadata(e){return this._channel.updateMetadata(e)}close(){return b(this,null,(function*(){yield this._channel.close()}))}dispose(){return b(this,null,(function*(){return this._channel.dispose()}))}toJSON(){return{type:this.type,id:this.id,name:this.name,metadata:this.metadata,members:this.members,publications:this.publications,subscriptions:this.subscriptions}}};w(),w();var Sd=new si("packages/room/src/room/p2p.ts"),bd=class extends Ed{constructor(e){super("p2p",e),this.setChannelState(),this.setChannelListener()}setChannelState(){this._channel.members.forEach((e=>{const t=new pd(e,this);this._members[e.id]=t})),this._channel.publications.forEach((e=>{this._addPublication(e)})),this._channel.subscriptions.forEach((e=>{this._addSubscription(e)}))}setChannelListener(){this._channel.onMemberJoined.add((e=>this._handleOnMemberJoin(e.member))),this._channel.onMemberLeft.add((e=>this._handleOnMemberLeft(e.member))),this._channel.onStreamPublished.add((e=>this._handleOnStreamPublish(e.publication))),this._channel.onStreamUnpublished.add((e=>this._handleOnStreamUnpublish(e.publication))),this._channel.onPublicationMetadataUpdated.add((e=>{this._handleOnPublicationMetadataUpdate(e.publication)})),this._channel.onPublicationEnabled.add((e=>{this._handleOnPublicationEnabled(e.publication)})),this._channel.onPublicationDisabled.add((e=>{this._handleOnPublicationDisabled(e.publication)})),this._channel.onPublicationSubscribed.add((e=>this._handleOnStreamSubscribe(e.subscription))),this._channel.onPublicationUnsubscribed.add((e=>this._handleOnStreamUnsubscribe(e.subscription)))}_handleOnMemberJoin(e){if(this._getMember(e.id))return;const t=new pd(e,this);this._members[e.id]=t,this.onMemberJoined.emit({member:t}),this.onMemberListChanged.emit({})}_handleOnMemberLeft(e){const t=this._getMember(e.id);delete this._members[e.id],t._dispose(),this.onMemberLeft.emit({member:t}),this.onMemberListChanged.emit({})}_handleOnStreamPublish(e){if(this._getPublication(e.id))return;const t=this._addPublication(e);this.onStreamPublished.emit({publication:t}),this.onPublicationListChanged.emit({})}_handleOnStreamUnpublish(e){const t=this._getPublication(e.id);delete this._publications[e.id],t._dispose(),this.onStreamUnpublished.emit({publication:t}),this.onPublicationListChanged.emit({})}_handleOnPublicationMetadataUpdate(e){const t=this._getPublication(e.id);this.onPublicationMetadataUpdated.emit({publication:t,metadata:t.metadata})}_handleOnPublicationEnabled(e){const t=this._getPublication(e.id);this.onPublicationEnabled.emit({publication:t})}_handleOnPublicationDisabled(e){const t=this._getPublication(e.id);this.onPublicationDisabled.emit({publication:t})}_handleOnStreamSubscribe(e){if(this._getSubscription(e.id))return;const t=this._addSubscription(e);this.onPublicationSubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit({})}_handleOnStreamUnsubscribe(e){const t=this._getSubscription(e.id);delete this._subscriptions[e.id],this.onPublicationUnsubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit({})}join(){return b(this,arguments,(function*(e={}){const t=yield this.joinChannel(e),i=new Nc(t,this);return Sd.debug("member joined",e),this.localRoomMember=i,i.onLeft.once((()=>{this.localRoomMember=void 0})),i}))}};w();var wd=new si("packages/room/src/room/sfu.ts"),Td=class extends Ed{constructor(e,t){super("sfu",e),this._plugin=t,this.setChannelState(),this.setChannelListener()}static Create(e,t){return b(this,null,(function*(){const i=e.plugins.find((e=>"sfu"===e.subtype)),n=t.members.find((e=>e.subtype===qc.subtype));n||(yield i.createBot(t)),e.config.internal.disableSignaling=!0;const r=new Td(t,i);return r}))}setChannelState(){this._channel.members.forEach((e=>{if("bot"===e.type)return;const t=new pd(e,this);this._members[e.id]=t})),this._channel.publications.forEach((e=>{e.origin&&this._addPublication(e)})),this._channel.subscriptions.forEach((e=>{"bot"!==e.subscriber.type&&this._addSubscription(e)}))}setChannelListener(){this._channel.onMemberJoined.add((e=>this._handleOnMemberJoin(e.member))),this._channel.onMemberLeft.add((e=>this._handleOnMemberLeft(e.member))),this._channel.onStreamPublished.add((e=>{this._handleOnStreamPublish(e.publication)})),this._channel.onStreamUnpublished.add((e=>this._handleOnStreamUnpublish(e.publication))),this._channel.onPublicationMetadataUpdated.add((e=>{this._handleOnPublicationMetadataUpdate(e.publication)})),this._channel.onPublicationEnabled.add((e=>{this._handleOnPublicationEnabled(e.publication)})),this._channel.onPublicationDisabled.add((e=>{this._handleOnPublicationDisabled(e.publication)})),this._channel.onPublicationSubscribed.add((e=>{this._handleOnStreamSubscribe(e.subscription)})),this._channel.onPublicationUnsubscribed.add((e=>this._handleOnStreamUnsubscribe(e.subscription)))}_handleOnMemberJoin(e){if("bot"===e.type)return;const t=new pd(e,this);this._members[e.id]=t,this.onMemberJoined.emit({member:t}),this.onMemberListChanged.emit({})}_handleOnMemberLeft(e){const t=this._getMember(e.id);t&&(delete this._members[e.id],t._dispose(),this.onMemberLeft.emit({member:t}),this.onMemberListChanged.emit({}))}_handleOnStreamPublish(e){var t;if(!(null==(t=e.origin)?void 0:t.id))return;const i=this._addPublication(e);this.onStreamPublished.emit({publication:i}),this.onPublicationListChanged.emit({})}_handleOnStreamUnpublish(e){var t;if(!(null==(t=e.origin)?void 0:t.id))return;const i=this._getPublication(e.id);delete this._publications[e.id],i._dispose(),this.onStreamUnpublished.emit({publication:i}),this.onPublicationListChanged.emit({})}_getRelayedPublication(e){const t=this.publications.find((t=>{var i;return(null==(i=t._publication.origin)?void 0:i.id)===e}));return t}_handleOnPublicationMetadataUpdate(e){const t=this._getRelayedPublication(e.id);t&&this.onPublicationMetadataUpdated.emit({publication:t,metadata:t.metadata})}_handleOnPublicationEnabled(e){const t=this._getRelayedPublication(e.id);t&&this.onPublicationEnabled.emit({publication:t})}_handleOnPublicationDisabled(e){const t=this._getRelayedPublication(e.id);t&&this.onPublicationDisabled.emit({publication:t})}_handleOnStreamSubscribe(e){if("bot"===e.subscriber.type)return;const t=this._addSubscription(e);this.onPublicationSubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit({})}_handleOnStreamUnsubscribe(e){if("bot"===e.subscriber.type)return;const t=this._getSubscription(e.id);delete this._subscriptions[e.id],this.onPublicationUnsubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit({})}join(){return b(this,arguments,(function*(e={}){const t=yield this.joinChannel(e),i=new hd(t,this);return this.localRoomMember=i,i.onLeft.once((()=>{this.localRoomMember=void 0})),wd.debug("member joined",e),i}))}};w();var Cd=new si("packages/room/src/subscription/index.ts"),Rd=class{constructor(e,t){this._subscription=e,this._room=t,this._context=this._room._context,this.onStreamAttached=new di,this.onCanceled=new di,this.id=e.id,this.contentType=e.contentType,this.publication=this._room._getPublication(e.publication.id),this.subscriber=this._room._getMember(e.subscriber.id),e.onStreamAttached.pipe(this.onStreamAttached),e.onCanceled.pipe(this.onCanceled)}get stream(){return this._subscription.stream}get state(){return this._subscription.state}get codec(){return this._subscription.codec}get preferredEncoding(){return this._subscription.preferredEncoding}changePreferredEncoding(e){this._subscription.changePreferredEncoding(e)}cancel(){return b(this,null,(function*(){this._subscription.cancel(),yield this._room.onPublicationUnsubscribed.watch((e=>e.subscription.id===this.id),this._context.config.rtcApi.timeout).catch((e=>{throw Pc({operationName:"RoomSubscriptionImpl.cancel",context:this._context,room:this._room,info:_(g({},Rc.timeout),{detail:"onPublicationUnsubscribed"}),error:e,path:Cd.prefix})}))}))}toJSON(){return{id:this.id,contentType:this.contentType,publication:this.publication,codec:this.codec}}getStats(){return this._subscription.getStats()}getRTCPeerConnection(){return this._subscription.getRTCPeerConnection()}getConnectionState(){return this._subscription.getConnectionState()}};w();var Id="1.2.2",Ad=i(1022),Pd=i(4186);
/*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
 */
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
/*! (c) Tom Wu, Kenji Urushima | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
/*! CryptoJS v3.1.2 core-fix.js
 * code.google.com/p/crypto-js
 * (c) 2009-2013 by Jeff Mott. All rights reserved.
 * code.google.com/p/crypto-js/wiki/License
 * THIS IS FIX of 'core.js' to fix Hmac issue.
 * https://code.google.com/p/crypto-js/issues/detail?id=84
 * https://crypto-js.googlecode.com/svn-history/r667/branches/3.x/src/core.js
 */
/*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
 */
/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */const Od=!1;let Nd,Dd,kd,xd,Ld,Md,Fd,Ud,jd,Vd={},Bd=!1;async function Hd(e,t){try{Fd=t,await Wd(),Ld="room"+e,Md=Ad.t.SKYWAY_CONNECT_WAY_SFU,Ad.t.SKYWAY_USE_SFU||(Md=Ad.t.SKYWAY_CONNECT_WAY_P2P),Ud=await Ka.createMicrophoneAudioStream(),await Kd(),Nd.onFatalError.add((async()=>{Nd.dispose(),await Kd(),console.log("[ã¨ã©ã¼ã«ããSkyway Roomåå¥å®¤] "),await Yd(jd),console.log("[ã¨ã©ã¼ã«ããåsubscribe] "),Bd&&(await Gd(jd),console.log("[ã¨ã©ã¼ã«ããåpublish] "))}))}catch(i){console.error(i)}}async function Wd(){try{const e=await(0,Pd.Pb)();Vd=new _o({jti:Eo(),iat:yo(),exp:yo()+3600,scope:{app:{id:e.apiKey,turn:!0,actions:["read"],channels:Ad.t.SKYWAY_CHANNEL_PARAMS}}}).encode(e.apiSecret),console.log("[ãã¼ã¯ã³çæ]")}catch(e){console.error(e)}}async function Kd(){try{Nd=await La.Create(Vd),xd=await vd.FindOrCreate(Nd,{type:Md,name:Ld}),console.log("[Skyway Roomå¥å®¤éå§] "+Ld+" - "+Md),Dd=await xd.join({name:Fd.toString()}),console.log("[Skyway Roomå¥å®¤] "+Ld+" - "+Md),console.log(Dd)}catch(e){console.error(e)}}async function Gd(e){try{jd=e,await qd();const t=async t=>{await zd(t,e)};xd.publications.forEach(t),xd.onStreamPublished.add((e=>t(e.publication)))}catch(t){console.error(t)}}async function qd(){try{kd=await Dd.publish(Ud),console.log(`èªé³å£°publish: ${Dd.id}`),Bd=!0}catch(e){console.error(e)}}async function zd(e,t){try{if(e.publisher.id===Dd.id)return void console.log("[èªåã®é³å£°ã¯subscribeã¹ã­ãã]");const{stream:i}=await Dd.subscribe(e.id);let n;switch(i.track.kind){case"audio":n=document.createElement("audio"),n.autoplay=!0,n.controls=Od,console.log("[å¯¾è±¡èã®é³å£°ãsubscribe]"),console.log(i);break;default:return}i.attach(n),t.appendChild(n)}catch(i){console.error(i)}}async function Jd(){try{await Dd.unpublish(kd.id),console.log("[èªé³å£°publishåæ­¢]"),Bd=!1}catch(e){console.error(e)}}async function Yd(e){try{console.log("[subscribeéå§]");const t=async t=>{await zd(t,e)};xd.publications.forEach(t),xd.onStreamPublished.add((e=>t(e.publication)))}catch(t){console.error(t)}}async function Xd(){try{var e=kd.stream._track;e.enabled=!1,console.log(kd.stream),console.log("[ãã¥ã¼ãå®æ½]")}catch(t){console.error(t)}}async function $d(){try{var e=kd.stream._track;e.enabled=!0,console.log("[ãã¥ã¼ãè§£é¤]")}catch(t){console.error(t)}}async function Qd(e){try{let t="room"+e,i=Ad.t.SKYWAY_CONNECT_WAY_SFU;Ad.t.SKYWAY_USE_SFU||(i=Ad.t.SKYWAY_CONNECT_WAY_P2P),console.log(t),xd=await vd.Find(Nd,{name:t},i),await xd.leave(Dd),console.log("[Skyway Rooméå®¤] "+t+" - "+i),console.log(Dd)}catch(t){console.error(t)}}},395:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return $}});var n=i(3396),r=i(9242),s=i(5101),o=i(11),a=i(6572),c=i(1888),d=i(1334),l=i(3601),h=i(1666),u=i(6824),p=i(8521),m=i(9234),f=i(3369),g=i(3289),_=i(3140),v=i(5869);const y={id:"roomContainer"},E={class:"roomHeader"},S={id:"chatArea"},b={ref:"remoteMediaArea"},w=["src"];function T(e,t,i,T,C,R){const I=(0,n.up)("ChatItem"),A=(0,n.up)("v-content"),P=(0,n.up)("footer-menu"),O=(0,n.up)("MusicPlayerPopover");return(0,n.wg)(),(0,n.j4)(_.O,null,{default:(0,n.w5)((()=>[(0,n._)("div",y,[(0,n._)("header",E,[(0,n.Wm)(u.o,null,{default:(0,n.w5)((()=>[(0,n.Wm)(p.D,{cols:"9"}),(0,n.Wm)(p.D,{cols:"3",class:"text-right"},{default:(0,n.w5)((()=>[(0,n.Wm)(l.B,{modelValue:C.dialog,"onUpdate:modelValue":t[1]||(t[1]=e=>C.dialog=e),persistent:"",width:"auto"},{activator:(0,n.w5)((({props:e})=>[(0,n.Wm)(s.T,(0,n.dG)(e,{rounded:""}),{default:(0,n.w5)((()=>[(0,n.Wm)(g.t,null,{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-phone")])),_:1}),(0,n.Uk)("éè©±ã«åå  ")])),_:2},1040)])),default:(0,n.w5)((()=>[(0,n.Wm)(o._,null,{default:(0,n.w5)((()=>[(0,n.Wm)(a.E,{class:"text-h5"}),(0,n.Wm)(c.Z,null,{default:(0,n.w5)((()=>[(0,n.Uk)("éè©±ã«åå ãã¾ããããããã§ããï¼")])),_:1}),(0,n.Wm)(d.h,null,{default:(0,n.w5)((()=>[(0,n.Wm)(m.C),(0,n.Wm)(s.T,{color:"green-darken-1",variant:"text",onClick:t[0]||(t[0]=e=>C.dialog=!1)},{default:(0,n.w5)((()=>[(0,n.Uk)(" Cancel ")])),_:1}),(0,n.Wm)(s.T,{color:"green-darken-1",variant:"text",onClick:R.connectToVCRoom},{default:(0,n.w5)((()=>[(0,n.Uk)(" OK ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})]),(0,n.Wm)(A,null,{default:(0,n.w5)((()=>[(0,n.Wm)(f.K,null,{default:(0,n.w5)((()=>[(0,n._)("div",S,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(C.chats,(e=>((0,n.wg)(),(0,n.iD)("section",{key:e.text,class:"item"},[(0,n.Wm)(u.o,null,{default:(0,n.w5)((()=>[(0,n.Wm)(p.D,{cols:"12"},{default:(0,n.w5)((()=>[(0,n.Wm)(I,{chat:e},null,8,["chat"])])),_:2},1024)])),_:2},1024)])))),128))]),(0,n._)("div",b,null,512),(0,n._)("audio",{ref:"audioElement",src:C.musicFile},null,8,w)])),_:1})])),_:1}),(0,n.Wm)(P),(0,n.Wm)(h.c,{app:"",dark:"",class:"dark"},{default:(0,n.w5)((()=>[(0,n.Wm)(u.o,{justify:"center"},{default:(0,n.w5)((()=>[(0,n.Wm)(p.D,{cols:"8"},{default:(0,n.w5)((()=>[(0,n.Wm)(v.h,{id:"commentTextBox",placeholder:"",modelValue:C.inputtedTxt,"onUpdate:modelValue":t[2]||(t[2]=e=>C.inputtedTxt=e),label:"ã³ã¡ã³ããå¥å",onKeydown:t[3]||(t[3]=(0,r.D2)((e=>R.onEnterKeyPressedAtChatTextBox(e.keyCode)),["enter"]))},null,8,["modelValue"])])),_:1}),(0,n.Wm)(p.D,{cols:"1"},{default:(0,n.w5)((()=>[(0,n.Wm)(s.T,{icon:"mdi-heart",onClick:R.onLikeButtonClick,rounded:"",color:"pink"},null,8,["onClick"])])),_:1}),(0,n.Wm)(p.D,{cols:"1"},{default:(0,n.w5)((()=>[(0,n.Wm)(O)])),_:1}),(0,n.Wm)(p.D,{cols:"1"},{default:(0,n.w5)((()=>[(0,n.wy)((0,n.Wm)(s.T,{icon:"mdi-microphone",onClick:R.muteMyVC,fab:""},null,8,["onClick"]),[[r.F8,C.hasUnMuted]]),(0,n.wy)((0,n.Wm)(s.T,{icon:"mdi-microphone-off",onClick:R.unmuteMyVC,fab:"",rounded:"",color:"grey"},null,8,["onClick"]),[[r.F8,C.hasMuted]])])),_:1})])),_:1})])),_:1})])])),_:1})}i(7658);var C=i(1022),R=i(7130),I=i(8578),A=i(4702),P=i(7139);const O={class:"chatItem"},N=["src"],D={class:"name"},k={class:"text"};function x(e,t,i,r,s,o){return(0,n.wg)(),(0,n.iD)("div",O,[(0,n._)("img",{src:i.chat.image,class:"round-image",width:"24"},null,8,N),(0,n._)("span",D,(0,P.zw)(i.chat.name),1),(0,n._)("span",k,(0,P.zw)(i.chat.text),1)])}var L={name:"ChatItem",props:["chat"],data(){return{}},setup:function(){console.log("chat item setup")}},M=i(89);const F=(0,M.Z)(L,[["render",x],["__scopeId","data-v-4adbf212"]]);var U=F,j=i(4075),V=i(6145),B=i(3150),H=i(4193);const W={class:"text-center"},K=["src"];function G(e,t,i,a,c,d){return(0,n.wg)(),(0,n.iD)("div",W,[(0,n.Wm)(H.T,{modelValue:c.menu,"onUpdate:modelValue":t[2]||(t[2]=e=>c.menu=e),"close-on-content-click":!1,location:"end"},{activator:(0,n.w5)((({props:e})=>[(0,n.Wm)(s.T,(0,n.dG)(e,{icon:"mdi-music"}),null,16)])),default:(0,n.w5)((()=>[(0,n.Wm)(o._,{"min-width":"300"},{default:(0,n.w5)((()=>[(0,n.Wm)(V.i,null,{default:(0,n.w5)((()=>[(0,n.Wm)(B.l,{title:"Music",subtitle:""},{append:(0,n.w5)((()=>[])),_:1})])),_:1}),(0,n.Wm)(j.J),(0,n.Wm)(V.i,null,{default:(0,n.w5)((()=>[(0,n.Wm)(B.l,{class:"playButtonArea"},{default:(0,n.w5)((()=>[(0,n.Wm)(u.o,{justify:"center",id:"playButtonArea"},{default:(0,n.w5)((()=>[c.isPlaying?((0,n.wg)(),(0,n.j4)(s.T,{key:1,onClick:d.pauseAudio,icon:"mdi-stop"},null,8,["onClick"])):((0,n.wg)(),(0,n.j4)(s.T,{key:0,onClick:d.playAudio,icon:"mdi-play"},null,8,["onClick"]))])),_:1})])),_:1}),(0,n.Wm)(B.l,null,{default:(0,n.w5)((()=>[(0,n.Wm)(u.o,{justify:"center",id:"volumeArea"},{default:(0,n.w5)((()=>[(0,n.Wm)(g.t,null,{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-volume-high")])),_:1}),(0,n.Uk)(),(0,n._)("audio",{ref:"audioElement",src:c.musicFile},null,8,K),(0,n.wy)((0,n._)("input",{type:"range",min:"0",max:"1",step:"0.05","onUpdate:modelValue":t[0]||(t[0]=e=>c.volume=e),onChange:t[1]||(t[1]=(...e)=>d.changeVolume&&d.changeVolume(...e))},null,544),[[r.nr,c.volume]])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])}var q={name:"MusicPlayerDialog",data(){return{fav:!0,menu:!1,message:!1,hints:!0,isPlaying:!1,musicFile:"",volume:.1}},mounted(){this.$nextTick((()=>{}))},methods:{playAudio(){console.log(this.volume),this.isPlaying=!0,this.$store.commit("setIsBgmPlaying",!0)},pauseAudio(){this.isPlaying=!1,this.$store.commit("setIsBgmPlaying",!1)},changeVolume(){this.$store.commit("setBgmVolume",this.volume)}}};const z=(0,M.Z)(q,[["render",G],["__scopeId","data-v-d7f23cd0"]]);var J=z,Y={data(){return{user:{},chats:[],chat:{name:"",screenName:"",image:"",text:""},activeRoomMember:{userId:0,roomId:0,hasTalkJoined:!1,userProfileImage:"",isOwner:!1},roomID:0,sessionId:0,dbKeyChats:"",dbKeyActiveRoomUsers:"",dbKeyConReqs:"",dbKeyConAcks:"",inputtedTxt:"",isOwner:!1,hasSendReq:!1,hasReqAcked:!1,isExistConReq:!1,hasMuted:!1,hasUnMuted:!0,dialog:!1,musicFile:""}},components:{ChatItem:U,MusicPlayerPopover:J},setup:function(){console.log("setup LiveView")},mounted:function(){this.roomID=this.$route.params.roomID,this.dbKeyChats=`${C.t.FB_TABLE_ROOM_CHATS}/${this.roomID}`,this.dbKeyActiveRoomUsers=`${C.t.FB_TABLE_ROOM_CHATS}/${this.roomID}`,this.sessionId=Math.floor(1e5*Math.random()),(0,I.DQ)(this.dbKeyChats,(e=>{var t=[];e.forEach((function(e){var i=e.val();t.push(i)})),t.reverse(),this.chats=t}))},computed:{isBgmPlaying(){return this.$store.getters.getIsBgmPlaying},bgmVolume(){return this.$store.getters.getBgmVolume}},methods:{execAuth(){C.t.USE_GOOGLE_AUTH?(0,I.ZX)():C.t.USE_TWITTER_AUTH?(0,I.X6)():(0,I.e7)()},subscribe(){},onEnterKeyPressedAtChatTextBox(e){const t=13;e===t&&(this.chat={name:this.$store.getters.getTwitterUser.name,image:this.$store.getters.getTwitterUser.profileImageUrl,text:this.inputtedTxt},(0,I.ns)(this.dbKeyChats,this.chat),this.inputtedTxt="")},onLikeButtonClick(){const e="ãããã­ãéãã¾ããï¼";this.chat={name:this.$store.getters.getTwitterUser.name,image:this.$store.getters.getTwitterUser.profileImageUrl,text:e},(0,I.ns)(this.dbKeyChats,this.chat)},sendConReqToFB(){this.hasSendReq||((0,R.VF)((0,R.iH)((0,R.N8)(),this.dbKeyConReqs),{sesId:this.sessionId}),this.hasSendReq=!0)},sendConAckToFB(e){(0,R.VF)((0,R.iH)((0,R.N8)(),this.dbKeyConAcks),{sesId:e}),this.hasSendReq=!0},scrollBottom(){this.$nextTick((()=>{window.scrollTo(0,document.body.clientHeight)}))},connectToVCRoom(){(0,A.uX)(this.roomID,this.$refs.remoteMediaArea)},async muteMyVC(){this.hasMuted=!0,this.hasUnMuted=!1,(0,A.r0)()},async unmuteMyVC(){this.hasMuted=!1,this.hasUnMuted=!0,(0,A.$9)()}},watch:{isBgmPlaying(e,t){console.log(`isBgmPlaying: ${t} -> ${e}`),e?(console.log(this.bgmVolume),this.$refs.audioElement.play(),this.$refs.audioElement.volume=this.bgmVolume,this.$refs.audioElement.loop=!0):this.$refs.audioElement.pause()},bgmVolume(e,t){console.log(`volumeChange: ${t} -> ${e}`),this.$refs.audioElement.volume=this.bgmVolume}}};const X=(0,M.Z)(Y,[["render",T]]);var $=X},4756:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return ye}});var n=i(3396),r=i(7139),s=i(9242),o=i(6439),a=i(6562),c=i(5101),d=i(11),l=i(1888),h=i(1334),u=i(7103),p=i(3601),m=i(3369),f=i(6824),g=i(8521),_=i(3289),v=i(1285),y=i(3140);const E={id:"roomHeader"},S={class:"ma-2",id:"rightHeaderLeftArea"},b={id:"roomTitle"},w={id:"roomOwnerName"},T=(0,n._)("span",{class:"smallText"},"éä¿¡èç»é¢",-1),C={class:"chip-container"},R={ref:"remoteMediaArea"};function I(e,t,i,I,A,P){const O=(0,n.up)("RoomChatItem"),N=(0,n.up)("RoomFooter");return(0,n.wg)(),(0,n.j4)(m.K,{id:"roomContainer"},{default:(0,n.w5)((()=>[(0,n._)("header",E,[(0,n.Wm)(o.L,{id:"roomHeaderArea",class:"px-3",color:"grey-lighten-4",flat:"",app:""},{default:(0,n.w5)((()=>[(0,n.Wm)(m.K,null,{default:(0,n.w5)((()=>[(0,n.Wm)(f.o,{class:"justify-space-between"},{default:(0,n.w5)((()=>[(0,n.Wm)(g.D,{cols:"8"},{default:(0,n.w5)((()=>[(0,n._)("div",S,[(0,n.Wm)(v.f,{src:A.targetRoomData.thumImageUrl,id:"roomOwnerImage",width:"50"},null,8,["src"]),(0,n._)("span",b,(0,r.zw)(A.targetRoomData.title),1),(0,n._)("div",w,[(0,n.Uk)((0,r.zw)(A.targetRoomData.ownerUserName)+" ",1),(0,n.wy)((0,n.Wm)(a.G,{id:"roomOwnerBadge",class:"smallText",color:"pink",inline:""},{badge:(0,n.w5)((()=>[T])),_:1},512),[[s.F8,A.isRoomOwner]])])])])),_:1}),(0,n.Wm)(g.D,{cols:"4"},{default:(0,n.w5)((()=>[(0,n.Wm)(c.T,{icon:"mdi-close",variant:"tonal",class:"closeBox",rounded:"",size:"x-small",onClick:P.onCloseBoxClick},null,8,["onClick"])])),_:1})])),_:1}),(0,n.Wm)(f.o,{align:"center"},{default:(0,n.w5)((()=>[(0,n.Wm)(g.D,{cols:"4"},{default:(0,n.w5)((()=>[(0,n._)("div",C,[(0,n.Wm)(u.v,{class:"ma-2",size:"x-small"},{default:(0,n.w5)((()=>[(0,n.Wm)(_.t,{color:"success"},{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-account")])),_:1}),(0,n.Uk)("Â "+(0,r.zw)(A.roomListnerDatas.length)+"äººÂ Â Â  ",1)])),_:1}),(0,n.Wm)(_.t,{color:"grey"},{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-clock")])),_:1}),(0,n.Uk)("Â "+(0,r.zw)(P.getRemainMinutes)+":"+(0,r.zw)(P.getRemainSeconds),1)])])),_:1}),(0,n.Wm)(g.D,{cols:"5"}),(0,n.Wm)(g.D,{cols:"3"},{default:(0,n.w5)((()=>[(0,n.wy)((0,n.Wm)(c.T,{elevation:"1",onClick:P.onPublishButtonClick,class:"smallText callButton",rounded:""},{default:(0,n.w5)((()=>[(0,n.Wm)(_.t,{color:"success"},{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-phone")])),_:1}),(0,n.Uk)("Â éè©±ã«åå  ")])),_:1},8,["onClick"]),[[s.F8,!A.isPublishing]]),(0,n.wy)((0,n.Wm)(c.T,{elevation:"1",onClick:P.onUnpublishButtonClick,class:"smallText callButton",rounded:""},{default:(0,n.w5)((()=>[(0,n.Wm)(_.t,{color:"red"},{default:(0,n.w5)((()=>[(0,n.Uk)("mdi-phone-off")])),_:1}),(0,n.Uk)("Â éè©±ãåæ­ ")])),_:1},8,["onClick"]),[[s.F8,A.isPublishing]])])),_:1})])),_:1})])),_:1})])),_:1})]),(0,n.Wm)(y.O,{id:"roomMainArea"},{default:(0,n.w5)((()=>[(0,n.Wm)(f.o,null,{default:(0,n.w5)((()=>[(0,n.Wm)(g.D,{cols:"12",id:"chatArea",ref:"chatArea"},{default:(0,n.w5)((()=>[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(A.chatDatas,(e=>((0,n.wg)(),(0,n.iD)("section",{key:e.text,class:"item"},[(0,n.Wm)(O,{chat:e},null,8,["chat"])])))),128))])),_:1},512),(0,n._)("div",R,null,512)])),_:1})])),_:1}),(0,n.Wm)(N,{targetRoomId:A.targetRoomId,isPublishing:A.isPublishing},null,8,["targetRoomId","isPublishing"]),(0,n._)("div",null,[(0,n.Wm)(p.B,{modelValue:A.showInitDialog,"onUpdate:modelValue":t[1]||(t[1]=e=>A.showInitDialog=e),activator:"parent",width:"auto"},{default:(0,n.w5)((()=>[(0,n.Wm)(d._,null,{default:(0,n.w5)((()=>[(0,n.Wm)(l.Z,null,{default:(0,n.w5)((()=>[(0,n.Uk)((0,r.zw)(A.dialogTxt),1)])),_:1}),(0,n.Wm)(h.h,null,{default:(0,n.w5)((()=>[(0,n.Wm)(c.T,{color:"primary",block:"",onClick:t[0]||(t[0]=e=>A.showInitDialog=!1)},{default:(0,n.w5)((()=>[(0,n.Uk)("OK")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])])),_:1})}i(7658);var A=i(1022);const P=["src"],O={class:"item-name"},N={class:"item-message"};function D(e,t,i,s,o,a){return(0,n.wg)(),(0,n.j4)(g.D,{cols:"10",class:"item"},{default:(0,n.w5)((()=>[(0,n._)("img",{src:i.chat.profileImageUrl,class:"item-image"},null,8,P),(0,n._)("div",O,(0,r.zw)(i.chat.userName),1),(0,n._)("span",N,(0,r.zw)(i.chat.text),1)])),_:1})}var k={props:["chat"],data(){return{}},setup:function(){console.log("chat item setup")}},x=i(89);const L=(0,x.Z)(k,[["render",D],["__scopeId","data-v-721e6d06"]]);var M=L,F=i(1666),U=i(5869);const j={class:"d-flex justify-space-between"};function V(e,t,i,r,o,a){const d=(0,n.up)("RoomPopupMenu");return(0,n.wg)(),(0,n.j4)(F.c,{app:"",dark:"",class:"dark",height:"64"},{default:(0,n.w5)((()=>[(0,n.Wm)(f.o,null,{default:(0,n.w5)((()=>[(0,n.Wm)(g.D,{cols:"2"},{default:(0,n.w5)((()=>[(0,n.Wm)(d)])),_:1}),(0,n.Wm)(g.D,{cols:"6"},{default:(0,n.w5)((()=>[(0,n.Wm)(U.h,{"bg-color":"grey-lighten-1",class:"rounded-pill overflow-hidden",density:"compact","hide-details":"",label:"ã³ã¡ã³ããå¥å",variant:"solo","prepend-inner-icon":"mdi-comment-processing",modelValue:o.inputtedTxt,"onUpdate:modelValue":t[0]||(t[0]=e=>o.inputtedTxt=e),onKeydown:t[1]||(t[1]=(0,s.D2)((e=>a.onEnterKeyPressedAtChatTextBox(e.keyCode)),["enter"]))},null,8,["modelValue"])])),_:1}),(0,n.Wm)(g.D,{cols:"4",class:"text-right"},{default:(0,n.w5)((()=>[(0,n._)("div",j,[(0,n.Wm)(c.T,{icon:"mdi-heart",onClick:a.onLikeButtonClick,rounded:"",style:{color:"rgb(255, 77, 107)"}},null,8,["onClick"]),(0,n.wy)((0,n.Wm)(c.T,{icon:"mdi-microphone",onClick:a.onMuteButtonClick},null,8,["onClick"]),[[s.F8,i.isPublishing&&!o.isMuting]]),(0,n.wy)((0,n.Wm)(c.T,{icon:"mdi-microphone-off",color:"grey",onClick:a.onMuteButtonClick},null,8,["onClick"]),[[s.F8,i.isPublishing&&o.isMuting]])])])),_:1})])),_:1})])),_:1})}var B=i(8578),H=i(6145),W=i(3150),K=i(2127),G=i(4193);function q(e,t,i,s,o,a){return(0,n.wg)(),(0,n.iD)(n.HY,null,[(0,n.Wm)(G.T,null,{activator:(0,n.w5)((({props:e})=>[(0,n.Wm)(c.T,(0,n.dG)({"prepend-icon":"mdi-menu-up",class:"d-none d-sm-flex mx-auto",id:"largeMenuButton"},e,{rounded:""}),{prepend:(0,n.w5)((()=>[(0,n.Wm)(_.t,{color:"success"})])),default:(0,n.w5)((()=>[(0,n.Uk)(" ã¡ãã¥ã¼")])),_:2},1040)])),default:(0,n.w5)((()=>[(0,n.Wm)(H.i,null,{default:(0,n.w5)((()=>[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(o.menuItems,((e,t)=>((0,n.wg)(),(0,n.j4)(W.l,{key:t,value:e,"active-color":"success",variant:"plain",onClick:t=>a.onListItemClick(e)},{prepend:(0,n.w5)((()=>[(0,n.Wm)(_.t,{icon:e.icon,color:"success"},null,8,["icon"])])),default:(0,n.w5)((()=>[(0,n.Wm)(K.V,{textContent:(0,r.zw)(e.title)},null,8,["textContent"])])),_:2},1032,["value","onClick"])))),128))])),_:1})])),_:1}),(0,n.Wm)(G.T,null,{activator:(0,n.w5)((({props:e})=>[(0,n.Wm)(c.T,(0,n.dG)({icon:"mdi-menu-up",style:{color:"rgb(65, 156, 95)"},class:"d-flex d-sm-none mx-auto",id:"smallMenuButton"},e,{rounded:""}),null,16)])),default:(0,n.w5)((()=>[(0,n.Wm)(H.i,null,{default:(0,n.w5)((()=>[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(o.menuItems,((e,t)=>((0,n.wg)(),(0,n.j4)(W.l,{key:t,value:e,"active-color":"success",variant:"plain",onClick:t=>a.onListItemClick(e)},{prepend:(0,n.w5)((()=>[(0,n.Wm)(_.t,{icon:e.icon,color:"success"},null,8,["icon"])])),default:(0,n.w5)((()=>[(0,n.Wm)(K.V,{textContent:(0,r.zw)(e.title)},null,8,["textContent"])])),_:2},1032,["value","onClick"])))),128))])),_:1})])),_:1})],64)}var z={props:[],data(){return{menuItems:[A.t.ROOM_FOOTER_MENU_ITEM_NAMES_BGM_STOP],isBgmPlaying:!0}},mounted(){try{this.imageFiles=this.$store.getters.getBgImages,this.$store.commit("setIsBgmPlaying",this.isBgmPlaying)}catch(e){console.error(e)}},methods:{onListItemClick(e,t){try{console.log(e,t),"BGMåæ­¢"===e.title?(this.isBgmPlaying=!1,this.menuItems=[A.t.ROOM_FOOTER_MENU_ITEM_NAMES_BGM_PLAY]):(this.isBgmPlaying=!0,this.menuItems=[A.t.ROOM_FOOTER_MENU_ITEM_NAMES_BGM_STOP]),this.$store.commit("setIsBgmPlaying",this.isBgmPlaying)}catch(i){console.error(i)}},onOKButtonClick(){try{console.log()}catch(e){console.error(e)}}}};const J=(0,x.Z)(z,[["render",q]]);var Y=J,X={props:["targetRoomId","isRoomOwner","isPublishing"],components:{RoomPopupMenu:Y},data(){return{targetUserData:{},targetChatData:{roomId:0,userId:0,userName:"",profileImageUrl:"",text:"",createdAt:null},inputtedTxt:"",isMuting:!1}},mounted(){try{this.targetUserData=this.$store.getters.getTargetUserData}catch(e){console.error(e)}},methods:{onLikeButtonClick(){try{this.targetChatData={roomId:this.targetRoomId,userId:this.targetUserData.id,userName:this.targetUserData.name,profileImageUrl:this.targetUserData.profileImageUrl,text:this.targetUserData.name+"ãããã­ï¼ ãéãã¾ããã",createdAt:new Date},console.log("[ãã£ãããã¼ã¿ç»é²]"),console.log(this.targetChatData),(0,B.fT)(this.targetChatData.roomId,this.targetChatData),this.inputtedTxt=""}catch(e){console.error(e)}},onEnterKeyPressedAtChatTextBox(e){const t=13;try{if(e!==t)return;if(""==this.inputtedTxt)return;this.targetChatData={roomId:this.targetRoomId,userId:this.targetUserData.id,userName:this.targetUserData.name,profileImageUrl:this.targetUserData.profileImageUrl,text:this.inputtedTxt,createdAt:new Date},console.log("[ãã£ãããã¼ã¿ç»é²]"),console.log(this.targetChatData),(0,B.fT)(this.targetChatData.roomId,this.targetChatData),this.inputtedTxt=""}catch(i){console.error(i)}},onMuteButtonClick(){try{this.isMuting?this.isMuting=!1:this.isMuting=!0,this.$store.commit("setIsMuting",this.isMuting)}catch(e){console.error(e)}}}};const $=(0,x.Z)(X,[["render",V],["__scopeId","data-v-58de362a"]]);var Q=$,Z=i(4186),ee=i(4702),te=i(8799),ie=i.n(te);const ne="host",re="audience";let se,oe={},ae={localAudioTrack:null,remoteAudioTrack:null,remoteUid:null},ce=!1;async function de(){try{oe.role=ne,await se.setClientRole(oe.role),ae.localAudioTrack=await ie().createMicrophoneAudioTrack(),await se.publish(ae.localAudioTrack),console.log("Publish success!"),ce=!0}catch(e){console.error(e)}}async function le(){try{ae.localAudioTrack.close(),console.log("UnPublish success!"),ce=!1}catch(e){console.error(e)}}async function he(e,t,i){try{ue(t,i,re),pe(e),await se.setClientRole(oe.role),await se.join(oe.appId,oe.channel,oe.token,oe.uid),console.log("Joined channel: "+oe.channel)}catch(n){console.error(n)}}function ue(e,t,i){try{oe={appId:A.t.AGORA_APP_ID,channel:"room"+e,token:null,role:i,uid:t}}catch(n){console.error(n)}}async function pe(e){try{se=ie().createClient({mode:"live",codec:"vp8"}),se.on("user-unpublished",(e=>{console.log(e.uid+"has left the channel"),console.log("Remote user has left the channel")})),se.on("user-published",(async(t,i)=>{await se.subscribe(t,i),console.log("subscribe success"),"audio"==i&&t.uid!==oe.uid&&(ae.remoteUid=t.uid,ae.remoteAudioTrack=t.audioTrack,ae.remoteAudioTrack.play(),console.log("Remote user connected: "+t.uid),console.log(e))}))}catch(t){console.error(t)}}async function me(){try{await ae.localAudioTrack.setMuted(!0)}catch(e){console.error(e)}}async function fe(){try{await ae.localAudioTrack.setMuted(!1)}catch(e){console.error(e)}}async function ge(){try{ce&&(ae.localAudioTrack.close(),ce=!1),await se.leave(),console.log("[Agora Rooméå®¤] ")}catch(e){console.error(e)}}var _e={components:{RoomChatItem:M,RoomFooter:Q},data(){return{targetRoomId:0,targetRoomData:{id:0,title:"",ownerUserId:0,ownerUserName:"",thumImageUrl:"",bgImageUrl:"",bgmUrl:"",category:"",description:"",webRtcService:"",startedAt:new Date},roomMyListnerData:{roomId:0,userId:0,userName:"",profileImageUrl:"",roomJoinedAt:new Date,isCallRequesting:!1,isInCall:!1},remainingTime:60,myListnerFbKey:"",roomListnerDatas:[],targetUserData:{},isRoomOwner:!1,targetChatData:{roomId:0,userId:0,userName:"",profileImageUrl:"",text:"",createdAt:null},bgmVolume:.03,chatDatas:[],isPublishing:!1,isMuting:!1,showInitDialog:!1,dialogTxt:"éè©±ã«åå ããã«ã¯ãç»é¢å³ä¸ã®ãéè©±ã«åå ããã¿ã³ãæ¼ãã¦ä¸ããã",audioElement:null}},mounted:async function(){try{this.targetRoomId=this.$route.params.roomId,this.targetRoomData=await(0,Z.UO)(this.targetRoomId),console.log("[é¨å±ãã¼ã¿åå¾]"),console.log(this.targetRoomData),await(0,B.e7)(),this.watchFireBaseChats(),await this.watchFireBaseRoomListnerDatas(),this.targetUserData=this.$store.getters.getTargetUserData,console.log("[ã¦ã¼ã¶ãã¼ã¿åå¾]"),console.log(this.targetUserData),console.log("[æ¥ç¶ææ®µ]"),console.log(this.targetRoomData.webRtcService),this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.uX)(this.targetRoomId,this.targetUserData.id):this.showInitDialog=!0,this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.uD)():(console.log("agora"),await he(this.audioElement,this.targetRoomId,this.targetUserData.id)),this.targetRoomData.ownerUserId===this.targetUserData.id&&(console.log("[éä¿¡èã¨ãã¦å¥å®¤]"+this.targetRoomData.ownerUserId+" "+this.targetUserData.id),this.isRoomOwner=!0,this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.JW)():(this.dialogTxt="Agora.ioãä½¿ç¨ãã¦é³å£°éä¿¡ãéå§ãã¾ãã",await de()),this.isPublishing=!0),this.insertRoomMyListnerDataToFireBase(),this.drawClock(),this.playBGM()}catch(e){console.error(e)}},computed:{getRemainMinutes(){return Math.floor(this.remainingTime/60)},getRemainSeconds(){let e=this.remainingTime%60;return e.toString().padStart(2,"0")}},watch:{"$store.getters.getTargetUserData":function(e){try{console.log(e)}catch(t){console.error(t)}},"$store.getters.getIsMuting":function(e){try{console.log("[ãã¥ã¼ãç¶æ]"+e),e?this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?(0,ee.r0)():me():this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?(0,ee.$9)():fe()}catch(t){console.error(t)}},"$store.getters.getIsBgmPlaying":function(e){try{if(console.log("[BGMåçç¶æ]"+e),console.log(this.audioElement),""===this.targetRoomData.bgmUrl)return void console.log("[BGMä¸ä½¿ç¨ã®ããåçã¹ã­ãã]");!0===e?this.$nextTick((()=>{this.audioElement.play(),console.log("[BGMåç]")})):this.$nextTick((()=>{this.audioElement.pause(),console.log("[BGMåæ­¢]")}))}catch(t){console.error(t)}},chatDatas(e){try{this.scrollToBottomAtChatArea(),console.log("[ãã£ããæ´æ°]"+e.length+"ä»¶")}catch(t){console.error(t)}}},methods:{watchFireBaseChats(){try{const e=e=>{this.chatDatas=e,console.log(this.chatDatas.length+"ä»¶ã®ãã£ãã")};(0,B.MB)(this.targetRoomId,e)}catch(e){console.error(e)}},async watchFireBaseRoomListnerDatas(){try{const e=e=>{this.roomListnerDatas=e,console.log(this.roomListnerDatas.length+"ä»¶ã®Listner")};await(0,B.RI)(this.targetRoomId,e)}catch(e){console.error(e)}},async insertRoomMyListnerDataToFireBase(){try{this.roomMyListnerData={roomId:this.targetRoomId,userId:this.targetUserData.id,userName:this.targetUserData.name,profileImageUrl:this.targetUserData.profileImageUrl,roomJoinedAt:(new Date).toLocaleString(),isCallRequesting:!1,isInCall:!1},this.myListnerFbKey=await(0,B.EI)(this.targetRoomId,this.roomMyListnerData),console.log("[Firebase Listnerãã¼ã¿ç»é²] "+this.myListnerFbKey)}catch(e){console.error(e)}},scrollToBottomAtChatArea(){try{this.$nextTick((()=>{window.scrollTo(0,document.body.clientHeight)}))}catch(e){console.error(e)}},drawClock(){const e=1e3;try{console.log(this.targetRoomData.startedAt);const t=new Date(this.targetRoomData.startedAt);console.log("[éå§æ¥æ]"+t);const i=new Date,n=Math.floor((i-t)/1e3);this.remainingTime=60*A.t.ROOM_VALID_PERIOD_MIN-n,console.log("[æ®ãç§æ°]"+this.remainingTime),this.timer=setInterval((()=>{0<this.remainingTime?this.remainingTime--:clearInterval(this.timer)}),e)}catch(t){console.error(t)}},playBGM(){try{if(""===this.targetRoomData.bgmUrl)return void console.log("[BGMä¸ä½¿ç¨ã®ããåçã¹ã­ãã]");this.$nextTick((()=>{this.audioElement=new Audio(this.targetRoomData.bgmUrl),this.audioElement.volume=this.bgmVolume,this.audioElement.loop=!0,this.audioElement.play(),console.log("[BGMåçéå§]"),console.log(this.audioElement)}))}catch(e){console.error(e)}},async onPublishButtonClick(){try{if(confirm("éè©±ã«åå ãã¾ããããããã§ããï¼")){if(this.isPublishing)return;this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?(await(0,ee.JW)(),await(0,ee.uD)()):(await de(),await he()),this.isPublishing=!0,this.sendChat(this.targetUserData.name+"ãéè©±ã«åå ãã¾ããã")}}catch(e){console.error(e)}},async sendChat(e){try{let t={roomId:this.targetRoomId,userId:this.targetUserData.id,userName:this.targetUserData.name,profileImageUrl:this.targetUserData.profileImageUrl,text:e,createdAt:new Date};console.log("[ãã£ãããã¼ã¿ç»é²]"),console.log(t),(0,B.fT)(t.roomId,t)}catch(t){console.error(t)}},async onUnpublishButtonClick(){try{confirm("éè©±ããéåºãã¾ããããããã§ããï¼")&&(this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.mg)():await le(),this.isPublishing=!1,this.sendChat(this.targetUserData.name+"ãéè©±ããéåºãã¾ããã"))}catch(e){console.error(e)}},async onCloseBoxClick(e,t,i){try{confirm("æ¬å½ã«ãã¼ã¸ãé¢ãã¾ããï¼")?(this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.j8)(this.targetRoomId):await ge(this.targetRoomId),this.$router.push("/rooms")):i(!1)}catch(n){console.error(n)}},async beforeLeave(e,t,i){try{this.targetRoomData.webRtcService==A.t.WEB_RTC_SERVICE_SKYWAY?await(0,ee.j8)(this.targetRoomId):await ge(this.targetRoomId),await(0,B.f0)(this.targetRoomId,this.myListnerFbKey),this.stopBGM(),i()}catch(n){console.error(n)}},stopBGM(){try{this.audioElement.pause(),this.audioElement=null}catch(e){console.error(e)}},sample(){}},beforeRouteLeave(e,t,i){try{this.beforeLeave(e,t,i)}catch(n){console.error(n)}}};const ve=(0,x.Z)(_e,[["render",I]]);var ye=ve},7130:function(e,t,i){"use strict";i.d(t,{U2:function(){return qo},N8:function(){return sa},jM:function(){return Xo},VF:function(){return Wo},iH:function(){return Bo},Od:function(){return Ko}});i(7658);var n=i(7077),r=i(7142),s=i(223),o=i(5168);const a="@firebase/database",c="0.14.4";
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let d="";function l(e){d=e}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class h{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),(0,s.Wl)(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:(0,s.cI)(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class u{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t}get(e){return(0,s.r3)(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const p=function(e){try{if("undefined"!==typeof window&&"undefined"!==typeof window[e]){const t=window[e];return t.setItem("firebase:sentinel","cache"),t.removeItem("firebase:sentinel"),new h(t)}}catch(t){}return new u},m=p("localStorage"),f=p("sessionStorage"),g=new o.Yd("@firebase/database"),_=function(){let e=1;return function(){return e++}}(),v=function(e){const t=(0,s.dS)(e),i=new s.gQ;i.update(t);const n=i.digest();return s.US.encodeByteArray(n)},y=function(...e){let t="";for(let i=0;i<e.length;i++){const n=e[i];Array.isArray(n)||n&&"object"===typeof n&&"number"===typeof n.length?t+=y.apply(null,n):t+="object"===typeof n?(0,s.Wl)(n):n,t+=" "}return t};let E=null,S=!0;const b=function(e,t){(0,s.hu)(!t||!0===e||!1===e,"Can't turn on custom loggers persistently."),!0===e?(g.logLevel=o["in"].VERBOSE,E=g.log.bind(g),t&&f.set("logging_enabled",!0)):"function"===typeof e?E=e:(E=null,f.remove("logging_enabled"))},w=function(...e){if(!0===S&&(S=!1,null===E&&!0===f.get("logging_enabled")&&b(!0)),E){const t=y.apply(null,e);E(t)}},T=function(e){return function(...t){w(e,...t)}},C=function(...e){const t="FIREBASE INTERNAL ERROR: "+y(...e);g.error(t)},R=function(...e){const t=`FIREBASE FATAL ERROR: ${y(...e)}`;throw g.error(t),new Error(t)},I=function(...e){const t="FIREBASE WARNING: "+y(...e);g.warn(t)},A=function(){"undefined"!==typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&I("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},P=function(e){return"number"===typeof e&&(e!==e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)},O=function(e){if((0,s.Yr)()||"complete"===document.readyState)e();else{let t=!1;const i=function(){document.body?t||(t=!0,e()):setTimeout(i,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",i,!1),window.addEventListener("load",i,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",(()=>{"complete"===document.readyState&&i()})),window.attachEvent("onload",i))}},N="[MIN_NAME]",D="[MAX_NAME]",k=function(e,t){if(e===t)return 0;if(e===N||t===D)return-1;if(t===N||e===D)return 1;{const i=q(e),n=q(t);return null!==i?null!==n?i-n===0?e.length-t.length:i-n:-1:null!==n?1:e<t?-1:1}},x=function(e,t){return e===t?0:e<t?-1:1},L=function(e,t){if(t&&e in t)return t[e];throw new Error("Missing required key ("+e+") in object: "+(0,s.Wl)(t))},M=function(e){if("object"!==typeof e||null===e)return(0,s.Wl)(e);const t=[];for(const n in e)t.push(n);t.sort();let i="{";for(let n=0;n<t.length;n++)0!==n&&(i+=","),i+=(0,s.Wl)(t[n]),i+=":",i+=M(e[t[n]]);return i+="}",i},F=function(e,t){const i=e.length;if(i<=t)return[e];const n=[];for(let r=0;r<i;r+=t)r+t>i?n.push(e.substring(r,i)):n.push(e.substring(r,r+t));return n};function U(e,t){for(const i in e)e.hasOwnProperty(i)&&t(i,e[i])}const j=function(e){(0,s.hu)(!P(e),"Invalid JSON number");const t=11,i=52,n=(1<<t-1)-1;let r,o,a,c,d;0===e?(o=0,a=0,r=1/e===-1/0?1:0):(r=e<0,e=Math.abs(e),e>=Math.pow(2,1-n)?(c=Math.min(Math.floor(Math.log(e)/Math.LN2),n),o=c+n,a=Math.round(e*Math.pow(2,i-c)-Math.pow(2,i))):(o=0,a=Math.round(e/Math.pow(2,1-n-i))));const l=[];for(d=i;d;d-=1)l.push(a%2?1:0),a=Math.floor(a/2);for(d=t;d;d-=1)l.push(o%2?1:0),o=Math.floor(o/2);l.push(r?1:0),l.reverse();const h=l.join("");let u="";for(d=0;d<64;d+=8){let e=parseInt(h.substr(d,8),2).toString(16);1===e.length&&(e="0"+e),u+=e}return u.toLowerCase()},V=function(){return!("object"!==typeof window||!window["chrome"]||!window["chrome"]["extension"]||/^chrome/.test(window.location.href))},B=function(){return"object"===typeof Windows&&"object"===typeof Windows.UI};function H(e,t){let i="Unknown Error";"too_big"===e?i="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===e?i="Client doesn't have permission to access the desired data.":"unavailable"===e&&(i="The service is unavailable");const n=new Error(e+" at "+t._path.toString()+": "+i);return n.code=e.toUpperCase(),n}const W=new RegExp("^-?(0*)\\d{1,10}$"),K=-2147483648,G=2147483647,q=function(e){if(W.test(e)){const t=Number(e);if(t>=K&&t<=G)return t}return null},z=function(e){try{e()}catch(t){setTimeout((()=>{const e=t.stack||"";throw I("Exception was thrown by user callback.",e),t}),Math.floor(0))}},J=function(){const e="object"===typeof window&&window["navigator"]&&window["navigator"]["userAgent"]||"";return e.search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Y=function(e,t){const i=setTimeout(e,t);return"number"===typeof i&&"undefined"!==typeof Deno&&Deno["unrefTimer"]?Deno.unrefTimer(i):"object"===typeof i&&i["unref"]&&i["unref"](),i};
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class X{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=null===t||void 0===t?void 0:t.getImmediate({optional:!0}),this.appCheck||null===t||void 0===t||t.get().then((e=>this.appCheck=e))}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise(((t,i)=>{setTimeout((()=>{this.appCheck?this.getToken(e).then(t,i):t(null)}),0)}))}addTokenChangeListener(e){var t;null===(t=this.appCheckProvider)||void 0===t||t.get().then((t=>t.addTokenListener(e)))}notifyForInvalidToken(){I(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ${constructor(e,t,i){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=i,this.auth_=null,this.auth_=i.getImmediate({optional:!0}),this.auth_||i.onInit((e=>this.auth_=e))}getToken(e){return this.auth_?this.auth_.getToken(e).catch((e=>e&&"auth/token-not-initialized"===e.code?(w("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(e))):new Promise(((t,i)=>{setTimeout((()=>{this.auth_?this.getToken(e).then(t,i):t(null)}),0)}))}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then((t=>t.addAuthTokenListener(e)))}removeTokenChangeListener(e){this.authProvider_.get().then((t=>t.removeAuthTokenListener(e)))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',I(e)}}class Q{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}Q.OWNER="owner";
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Z="5",ee="v",te="s",ie="r",ne="f",re=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,se="ls",oe="p",ae="ac",ce="websocket",de="long_polling";
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class le{constructor(e,t,i,n,r=!1,s="",o=!1,a=!1){this.secure=t,this.namespace=i,this.webSocketOnly=n,this.nodeAdmin=r,this.persistenceKey=s,this.includeNamespaceInQueryParams=o,this.isUsingEmulator=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=m.get("host:"+e)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&m.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function he(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams}function ue(e,t,i){let n;if((0,s.hu)("string"===typeof t,"typeof type must == string"),(0,s.hu)("object"===typeof i,"typeof params must == object"),t===ce)n=(e.secure?"wss://":"ws://")+e.internalHost+"/.ws?";else{if(t!==de)throw new Error("Unknown connection type: "+t);n=(e.secure?"https://":"http://")+e.internalHost+"/.lp?"}he(e)&&(i["ns"]=e.namespace);const r=[];return U(i,((e,t)=>{r.push(e+"="+t)})),n+r.join("&")}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pe{constructor(){this.counters_={}}incrementCounter(e,t=1){(0,s.r3)(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return(0,s.p$)(this.counters_)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const me={},fe={};function ge(e){const t=e.toString();return me[t]||(me[t]=new pe),me[t]}function _e(e,t){const i=e.toString();return fe[i]||(fe[i]=t()),fe[i]}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ve{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){this.pendingResponses[e]=t;while(this.pendingResponses[this.currentResponseNum]){const e=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let t=0;t<e.length;++t)e[t]&&z((()=>{this.onMessage_(e[t])}));if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ye="start",Ee="close",Se="pLPCommand",be="pRTLPCB",we="id",Te="pw",Ce="ser",Re="cb",Ie="seg",Ae="ts",Pe="d",Oe="dframe",Ne=1870,De=30,ke=Ne-De,xe=25e3,Le=3e4;class Me{constructor(e,t,i,n,r,s,o){this.connId=e,this.repoInfo=t,this.applicationId=i,this.appCheckToken=n,this.authToken=r,this.transportSessionId=s,this.lastSessionId=o,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=T(e),this.stats_=ge(t),this.urlFn=e=>(this.appCheckToken&&(e[ae]=this.appCheckToken),ue(t,de,e))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new ve(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout((()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null}),Math.floor(Le)),O((()=>{if(this.isClosed_)return;this.scriptTagHolder=new Fe(((...e)=>{const[t,i,n,r,s]=e;if(this.incrementIncomingBytes_(e),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,t===ye)this.id=i,this.password=n;else{if(t!==Ee)throw new Error("Unrecognized command received: "+t);i?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(i,(()=>{this.onClosed_()}))):this.onClosed_()}}),((...e)=>{const[t,i]=e;this.incrementIncomingBytes_(e),this.myPacketOrderer.handleResponse(t,i)}),(()=>{this.onClosed_()}),this.urlFn);const e={};e[ye]="t",e[Ce]=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(e[Re]=this.scriptTagHolder.uniqueCallbackIdentifier),e[ee]=Z,this.transportSessionId&&(e[te]=this.transportSessionId),this.lastSessionId&&(e[se]=this.lastSessionId),this.applicationId&&(e[oe]=this.applicationId),this.appCheckToken&&(e[ae]=this.appCheckToken),"undefined"!==typeof location&&location.hostname&&re.test(location.hostname)&&(e[ie]=ne);const t=this.urlFn(e);this.log_("Connecting via long-poll to "+t),this.scriptTagHolder.addTag(t,(()=>{}))}))}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Me.forceAllow_=!0}static forceDisallow(){Me.forceDisallow_=!0}static isAvailable(){return!(0,s.Yr)()&&(!!Me.forceAllow_||!Me.forceDisallow_&&"undefined"!==typeof document&&null!=document.createElement&&!V()&&!B())}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=(0,s.Wl)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const i=(0,s.h$)(t),n=F(i,ke);for(let r=0;r<n.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,n.length,n[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if((0,s.Yr)())return;this.myDisconnFrame=document.createElement("iframe");const i={};i[Oe]="t",i[we]=e,i[Te]=t,this.myDisconnFrame.src=this.urlFn(i),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=(0,s.Wl)(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class Fe{constructor(e,t,i,n){if(this.onDisconnect=i,this.urlFn=n,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,s.Yr)())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=_(),window[Se+this.uniqueCallbackIdentifier]=e,window[be+this.uniqueCallbackIdentifier]=t,this.myIFrame=Fe.createIFrame_();let i="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length)){const e=document.domain;i='<script>document.domain="'+e+'";<\/script>'}const n="<html><body>"+i+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(n),this.myIFrame.doc.close()}catch(r){w("frame writing exception"),r.stack&&w(r.stack),w(r)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{const t=e.contentWindow.document;t||w("No IE domain setting required")}catch(t){const i=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+i+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout((()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)}),Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){this.myID=e,this.myPW=t,this.alive=!0;while(this.newRequest_());}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e[we]=this.myID,e[Te]=this.myPW,e[Ce]=this.currentSerial;let t=this.urlFn(e),i="",n=0;while(this.pendingSegs.length>0){const e=this.pendingSegs[0];if(!(e.d.length+De+i.length<=Ne))break;{const e=this.pendingSegs.shift();i=i+"&"+Ie+n+"="+e.seg+"&"+Ae+n+"="+e.ts+"&"+Pe+n+"="+e.d,n++}}return t+=i,this.addLongPollTag_(t,this.currentSerial),!0}return!1}enqueueSegment(e,t,i){this.pendingSegs.push({seg:e,ts:t,d:i}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const i=()=>{this.outstandingRequests.delete(t),this.newRequest_()},n=setTimeout(i,Math.floor(xe)),r=()=>{clearTimeout(n),i()};this.addTag(e,r)}addTag(e,t){(0,s.Yr)()?this.doNodeLongPoll(e,t):setTimeout((()=>{try{if(!this.sendNewPolls)return;const i=this.myIFrame.doc.createElement("script");i.type="text/javascript",i.async=!0,i.src=e,i.onload=i.onreadystatechange=function(){const e=i.readyState;e&&"loaded"!==e&&"complete"!==e||(i.onload=i.onreadystatechange=null,i.parentNode&&i.parentNode.removeChild(i),t())},i.onerror=()=>{w("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(i)}catch(i){}}),Math.floor(1))}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ue=16384,je=45e3;let Ve=null;"undefined"!==typeof MozWebSocket?Ve=MozWebSocket:"undefined"!==typeof WebSocket&&(Ve=WebSocket);class Be{constructor(e,t,i,n,r,s,o){this.connId=e,this.applicationId=i,this.appCheckToken=n,this.authToken=r,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=T(this.connId),this.stats_=ge(t),this.connURL=Be.connectionURL_(t,s,o,n,i),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,i,n,r){const o={};return o[ee]=Z,!(0,s.Yr)()&&"undefined"!==typeof location&&location.hostname&&re.test(location.hostname)&&(o[ie]=ne),t&&(o[te]=t),i&&(o[se]=i),n&&(o[ae]=n),r&&(o[oe]=r),ue(e,ce,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,m.set("previous_websocket_failure",!0);try{let e;if((0,s.Yr)()){const t=this.nodeAdmin?"AdminNode":"Node";e={headers:{"User-Agent":`Firebase/${Z}/${d}/${process.platform}/${t}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(e.headers["Authorization"]=`Bearer ${this.authToken}`),this.appCheckToken&&(e.headers["X-Firebase-AppCheck"]=this.appCheckToken);const i={NODE_ENV:"production",BASE_URL:"/"},n=0===this.connURL.indexOf("wss://")?i["HTTPS_PROXY"]||i["https_proxy"]:i["HTTP_PROXY"]||i["http_proxy"];n&&(e["proxy"]={origin:n})}this.mySock=new Ve(this.connURL,[],e)}catch(i){this.log_("Error instantiating WebSocket.");const e=i.message||i.data;return e&&this.log_(e),void this.onClosed_()}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=e=>{this.handleIncomingFrame(e)},this.mySock.onerror=e=>{this.log_("WebSocket error.  Closing connection.");const t=e.message||e.data;t&&this.log_(t),this.onClosed_()}}start(){}static forceDisallow(){Be.forceDisallow_=!0}static isAvailable(){let e=!1;if("undefined"!==typeof navigator&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(t);i&&i.length>1&&parseFloat(i[1])<4.4&&(e=!0)}return!e&&null!==Ve&&!Be.forceDisallow_}static previouslyFailed(){return m.isInMemoryStorage||!0===m.get("previous_websocket_failure")}markConnectionHealthy(){m.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const e=this.frames.join("");this.frames=null;const t=(0,s.cI)(e);this.onMessage(t)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if((0,s.hu)(null===this.frames,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(null===this.mySock)return;const t=e["data"];if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(t);else{const e=this.extractFrameCount_(t);null!==e&&this.appendFrame_(e)}}send(e){this.resetKeepAlive();const t=(0,s.Wl)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const i=F(t,Ue);i.length>1&&this.sendString_(String(i.length));for(let n=0;n<i.length;n++)this.sendString_(i[n])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval((()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()}),Math.floor(je))}sendString_(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}Be.responsesRequiredToBeHealthy=2,Be.healthyTimeout=3e4;
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class He{constructor(e){this.initTransports_(e)}static get ALL_TRANSPORTS(){return[Me,Be]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(e){const t=Be&&Be["isAvailable"]();let i=t&&!Be.previouslyFailed();if(e.webSocketOnly&&(t||I("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Be];else{const e=this.transports_=[];for(const t of He.ALL_TRANSPORTS)t&&t["isAvailable"]()&&e.push(t);He.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}He.globalTransportInitialized_=!1;
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const We=6e4,Ke=5e3,Ge=10240,qe=102400,ze="t",Je="d",Ye="s",Xe="r",$e="e",Qe="o",Ze="a",et="n",tt="p",it="h";class nt{constructor(e,t,i,n,r,s,o,a,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=i,this.appCheckToken_=n,this.authToken_=r,this.onMessage_=s,this.onReady_=o,this.onDisconnect_=a,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=T("c:"+this.id+":"),this.transportManager_=new He(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e["responsesRequiredToBeHealthy"]||0;const t=this.connReceiver_(this.conn_),i=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout((()=>{this.conn_&&this.conn_.open(t,i)}),Math.floor(0));const n=e["healthyTimeout"]||0;n>0&&(this.healthyTimeout_=Y((()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>qe?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>Ge?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))}),Math.floor(n)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{2!==this.state_&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(ze in e){const t=e[ze];t===Ze?this.upgradeIfSecondaryHealthy_():t===Xe?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):t===Qe&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=L("t",e),i=L("d",e);if("c"===t)this.onSecondaryControl_(i);else{if("d"!==t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(i)}}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:tt,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Ze,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:et,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=L("t",e),i=L("d",e);"c"===t?this.onControl_(i):"d"===t&&this.onDataMessage_(i)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=L(ze,e);if(Je in e){const i=e[Je];if(t===it){const e=Object.assign({},i);this.repoInfo_.isUsingEmulator&&(e.h=this.repoInfo_.host),this.onHandshake_(e)}else if(t===et){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let e=0;e<this.pendingDataMessages.length;++e)this.onDataMessage_(this.pendingDataMessages[e]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===Ye?this.onConnectionShutdown_(i):t===Xe?this.onReset_(i):t===$e?C("Server Error: "+i):t===Qe?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):C("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,i=e.v,n=e.h;this.sessionId=e.s,this.repoInfo_.host=n,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Z!==i&&I("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e["responsesRequiredToBeHealthy"]||0;const t=this.connReceiver_(this.secondaryConn_),i=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,i),Y((()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())}),Math.floor(We))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Y((()=>{this.sendPingOnPrimaryIfNecessary_()}),Math.floor(Ke))}sendPingOnPrimaryIfNecessary_(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:tt,d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==e&&this.rx_!==e||this.close()}onConnectionLost_(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(m.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rt{put(e,t,i,n){}merge(e,t,i,n){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,i){}onDisconnectMerge(e,t,i){}onDisconnectCancel(e,t){}reportStats(e){}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class st{constructor(e){this.allowedEvents_=e,this.listeners_={},(0,s.hu)(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const i=[...this.listeners_[e]];for(let e=0;e<i.length;e++)i[e].callback.apply(i[e].context,t)}}on(e,t,i){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:i});const n=this.getInitialEvent(e);n&&t.apply(i,n)}off(e,t,i){this.validateEventType_(e);const n=this.listeners_[e]||[];for(let r=0;r<n.length;r++)if(n[r].callback===t&&(!i||i===n[r].context))return void n.splice(r,1)}validateEventType_(e){(0,s.hu)(this.allowedEvents_.find((t=>t===e)),"Unknown event: "+e)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ot extends st{constructor(){super(["online"]),this.online_=!0,"undefined"===typeof window||"undefined"===typeof window.addEventListener||(0,s.uI)()||(window.addEventListener("online",(()=>{this.online_||(this.online_=!0,this.trigger("online",!0))}),!1),window.addEventListener("offline",(()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))}),!1))}static getInstance(){return new ot}getInitialEvent(e){return(0,s.hu)("online"===e,"Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const at=32,ct=768;class dt{constructor(e,t){if(void 0===t){this.pieces_=e.split("/");let t=0;for(let e=0;e<this.pieces_.length;e++)this.pieces_[e].length>0&&(this.pieces_[t]=this.pieces_[e],t++);this.pieces_.length=t,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"}}function lt(){return new dt("")}function ht(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function ut(e){return e.pieces_.length-e.pieceNum_}function pt(e){let t=e.pieceNum_;return t<e.pieces_.length&&t++,new dt(e.pieces_,t)}function mt(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function ft(e){let t="";for(let i=e.pieceNum_;i<e.pieces_.length;i++)""!==e.pieces_[i]&&(t+="/"+encodeURIComponent(String(e.pieces_[i])));return t||"/"}function gt(e,t=0){return e.pieces_.slice(e.pieceNum_+t)}function _t(e){if(e.pieceNum_>=e.pieces_.length)return null;const t=[];for(let i=e.pieceNum_;i<e.pieces_.length-1;i++)t.push(e.pieces_[i]);return new dt(t,0)}function vt(e,t){const i=[];for(let n=e.pieceNum_;n<e.pieces_.length;n++)i.push(e.pieces_[n]);if(t instanceof dt)for(let n=t.pieceNum_;n<t.pieces_.length;n++)i.push(t.pieces_[n]);else{const e=t.split("/");for(let t=0;t<e.length;t++)e[t].length>0&&i.push(e[t])}return new dt(i,0)}function yt(e){return e.pieceNum_>=e.pieces_.length}function Et(e,t){const i=ht(e),n=ht(t);if(null===i)return t;if(i===n)return Et(pt(e),pt(t));throw new Error("INTERNAL ERROR: innerPath ("+t+") is not within outerPath ("+e+")")}function St(e,t){if(ut(e)!==ut(t))return!1;for(let i=e.pieceNum_,n=t.pieceNum_;i<=e.pieces_.length;i++,n++)if(e.pieces_[i]!==t.pieces_[n])return!1;return!0}function bt(e,t){let i=e.pieceNum_,n=t.pieceNum_;if(ut(e)>ut(t))return!1;while(i<e.pieces_.length){if(e.pieces_[i]!==t.pieces_[n])return!1;++i,++n}return!0}class wt{constructor(e,t){this.errorPrefix_=t,this.parts_=gt(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let i=0;i<this.parts_.length;i++)this.byteLength_+=(0,s.ug)(this.parts_[i]);Rt(this)}}function Tt(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=(0,s.ug)(t),Rt(e)}function Ct(e){const t=e.parts_.pop();e.byteLength_-=(0,s.ug)(t),e.parts_.length>0&&(e.byteLength_-=1)}function Rt(e){if(e.byteLength_>ct)throw new Error(e.errorPrefix_+"has a key path longer than "+ct+" bytes ("+e.byteLength_+").");if(e.parts_.length>at)throw new Error(e.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+at+") or object contains a cycle "+It(e))}function It(e){return 0===e.parts_.length?"":"in property '"+e.parts_.join(".")+"'"}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class At extends st{constructor(){let e,t;super(["visible"]),"undefined"!==typeof document&&"undefined"!==typeof document.addEventListener&&("undefined"!==typeof document["hidden"]?(t="visibilitychange",e="hidden"):"undefined"!==typeof document["mozHidden"]?(t="mozvisibilitychange",e="mozHidden"):"undefined"!==typeof document["msHidden"]?(t="msvisibilitychange",e="msHidden"):"undefined"!==typeof document["webkitHidden"]&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,(()=>{const t=!document[e];t!==this.visible_&&(this.visible_=t,this.trigger("visible",t))}),!1)}static getInstance(){return new At}getInitialEvent(e){return(0,s.hu)("visible"===e,"Unknown event type: "+e),[this.visible_]}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pt=1e3,Ot=3e5,Nt=3e4,Dt=1.3,kt=3e4,xt="server_kill",Lt=3;class Mt extends rt{constructor(e,t,i,n,r,o,a,c){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=i,this.onConnectStatus_=n,this.onServerInfoUpdate_=r,this.authTokenProvider_=o,this.appCheckTokenProvider_=a,this.authOverride_=c,this.id=Mt.nextPersistentConnectionId_++,this.log_=T("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Pt,this.maxReconnectDelay_=Ot,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!(0,s.Yr)())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");At.getInstance().on("visible",this.onVisible_,this),-1===e.host.indexOf("fblocal")&&ot.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,i){const n=++this.requestNumber_,r={r:n,a:e,b:t};this.log_((0,s.Wl)(r)),(0,s.hu)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(r),i&&(this.requestCBHash_[n]=i)}get(e){this.initConnection_();const t=new s.BH,i={p:e._path.toString(),q:e._queryObject},n={action:"g",request:i,onComplete:e=>{const i=e["d"];"ok"===e["s"]?t.resolve(i):t.reject(i)}};this.outstandingGets_.push(n),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,i,n){this.initConnection_();const r=e._queryIdentifier,o=e._path.toString();this.log_("Listen called for "+o+" "+r),this.listens.has(o)||this.listens.set(o,new Map),(0,s.hu)(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,s.hu)(!this.listens.get(o).has(r),"listen() called twice for same path/queryId.");const a={onComplete:n,hashFn:t,query:e,tag:i};this.listens.get(o).set(r,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,(i=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(i)}))}sendListen_(e){const t=e.query,i=t._path.toString(),n=t._queryIdentifier;this.log_("Listen on "+i+" for "+n);const r={p:i},s="q";e.tag&&(r["q"]=t._queryObject,r["t"]=e.tag),r["h"]=e.hashFn(),this.sendRequest(s,r,(r=>{const s=r["d"],o=r["s"];Mt.warnOnListenWarnings_(s,t);const a=this.listens.get(i)&&this.listens.get(i).get(n);a===e&&(this.log_("listen response",r),"ok"!==o&&this.removeListen_(i,n),e.onComplete&&e.onComplete(o,s))}))}static warnOnListenWarnings_(e,t){if(e&&"object"===typeof e&&(0,s.r3)(e,"w")){const i=(0,s.DV)(e,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){const e='".indexOn": "'+t._queryParams.getIndex().toString()+'"',i=t._path.toString();I(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${e} at ${i} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},(()=>{})),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){const t=e&&40===e.length;(t||(0,s.GJ)(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Nt)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},(()=>{}))}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=(0,s.w9)(e)?"auth":"gauth",i={cred:e};null===this.authOverride_?i["noauth"]=!0:"object"===typeof this.authOverride_&&(i["authvar"]=this.authOverride_),this.sendRequest(t,i,(t=>{const i=t["s"],n=t["d"]||"error";this.authToken_===e&&("ok"===i?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(i,n))}))}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},(e=>{const t=e["s"],i=e["d"]||"error";"ok"===t?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,i)}))}unlisten(e,t){const i=e._path.toString(),n=e._queryIdentifier;this.log_("Unlisten called for "+i+" "+n),(0,s.hu)(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query");const r=this.removeListen_(i,n);r&&this.connected_&&this.sendUnlisten_(i,n,e._queryObject,t)}sendUnlisten_(e,t,i,n){this.log_("Unlisten on "+e+" for "+t);const r={p:e},s="n";n&&(r["q"]=i,r["t"]=n),this.sendRequest(s,r)}onDisconnectPut(e,t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,i):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:i})}onDisconnectMerge(e,t,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,i):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:i})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,i,n){const r={p:t,d:i};this.log_("onDisconnect "+e,r),this.sendRequest(e,r,(e=>{n&&setTimeout((()=>{n(e["s"],e["d"])}),Math.floor(0))}))}put(e,t,i,n){this.putInternal("p",e,t,i,n)}merge(e,t,i,n){this.putInternal("m",e,t,i,n)}putInternal(e,t,i,n,r){this.initConnection_();const s={p:t,d:i};void 0!==r&&(s["h"]=r),this.outstandingPuts_.push({action:e,request:s,onComplete:n}),this.outstandingPutCount_++;const o=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(o):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,i=this.outstandingPuts_[e].request,n=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,i,(i=>{this.log_(t+" response",i),delete this.outstandingPuts_[e],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),n&&n(i["s"],i["d"])}))}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,(e=>{const t=e["s"];if("ok"!==t){const t=e["d"];this.log_("reportStats","Error sending stats: "+t)}}))}}onDataMessage_(e){if("r"in e){this.log_("from server: "+(0,s.Wl)(e));const t=e["r"],i=this.requestCBHash_[t];i&&(delete this.requestCBHash_[t],i(e["b"]))}else{if("error"in e)throw"A server-side error has occurred: "+e["error"];"a"in e&&this.onDataPush_(e["a"],e["b"])}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),"d"===e?this.onDataUpdate_(t["p"],t["d"],!1,t["t"]):"m"===e?this.onDataUpdate_(t["p"],t["d"],!0,t["t"]):"c"===e?this.onListenRevoked_(t["p"],t["q"]):"ac"===e?this.onAuthRevoked_(t["s"],t["d"]):"apc"===e?this.onAppCheckRevoked_(t["s"],t["d"]):"sd"===e?this.onSecurityDebugPacket_(t):C("Unrecognized action received from server: "+(0,s.Wl)(e)+"\nAre you using the latest client?")}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){(0,s.hu)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout((()=>{this.establishConnectionTimer_=null,this.establishConnection_()}),Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){const e=(new Date).getTime()-this.lastConnectionEstablishedTime_;e>kt&&(this.reconnectDelay_=Pt),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();const e=(new Date).getTime()-this.lastConnectionAttemptTime_;let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Dt)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),n=this.id+":"+Mt.nextConnectionId_++,r=this.lastSessionId;let o=!1,a=null;const c=function(){a?a.close():(o=!0,i())},d=function(e){(0,s.hu)(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(e)};this.realtime_={close:c,sendRequest:d};const l=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[s,c]=await Promise.all([this.authTokenProvider_.getToken(l),this.appCheckTokenProvider_.getToken(l)]);o?w("getToken() completed but was canceled"):(w("getToken() completed. Creating connection."),this.authToken_=s&&s.accessToken,this.appCheckToken_=c&&c.token,a=new nt(n,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,i,(e=>{I(e+" ("+this.repoInfo_.toString()+")"),this.interrupt(xt)}),r))}catch(C){this.log_("Failed to get token: "+C),o||(this.repoInfo_.nodeAdmin&&I(C),c())}}}interrupt(e){w("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){w("Resuming connection for reason: "+e),delete this.interruptReasons_[e],(0,s.xb)(this.interruptReasons_)&&(this.reconnectDelay_=Pt,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let i;i=t?t.map((e=>M(e))).join("$"):"default";const n=this.removeListen_(e,i);n&&n.onComplete&&n.onComplete("permission_denied")}removeListen_(e,t){const i=new dt(e).toString();let n;if(this.listens.has(i)){const e=this.listens.get(i);n=e.get(t),e.delete(t),0===e.size&&this.listens.delete(i)}else n=void 0;return n}onAuthRevoked_(e,t){w("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Lt&&(this.reconnectDelay_=Nt,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){w("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Lt&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e["msg"].replace("\n","\nFIREBASE: "))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);while(this.onDisconnectRequestQueue_.length){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};let t="js";(0,s.Yr)()&&(t=this.repoInfo_.nodeAdmin?"admin_node":"node"),e["sdk."+t+"."+d.replace(/\./g,"-")]=1,(0,s.uI)()?e["framework.cordova"]=1:(0,s.b$)()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=ot.getInstance().currentlyOnline();return(0,s.xb)(this.interruptReasons_)&&e}}Mt.nextPersistentConnectionId_=0,Mt.nextConnectionId_=0;
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Ft{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new Ft(e,t)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ut{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const i=new Ft(N,e),n=new Ft(N,t);return 0!==this.compare(i,n)}minPost(){return Ft.MIN}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let jt;class Vt extends Ut{static get __EMPTY_NODE(){return jt}static set __EMPTY_NODE(e){jt=e}compare(e,t){return k(e.name,t.name)}isDefinedOn(e){throw(0,s.g5)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return Ft.MIN}maxPost(){return new Ft(D,jt)}makePost(e,t){return(0,s.hu)("string"===typeof e,"KeyIndex indexValue must always be a string."),new Ft(e,jt)}toString(){return".key"}}const Bt=new Vt;
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ht{constructor(e,t,i,n,r=null){this.isReverse_=n,this.resultGenerator_=r,this.nodeStack_=[];let s=1;while(!e.isEmpty())if(s=t?i(e.key,t):1,n&&(s*=-1),s<0)e=this.isReverse_?e.left:e.right;else{if(0===s){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}getNext(){if(0===this.nodeStack_.length)return null;let e,t=this.nodeStack_.pop();if(e=this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value},this.isReverse_){t=t.left;while(!t.isEmpty())this.nodeStack_.push(t),t=t.right}else{t=t.right;while(!t.isEmpty())this.nodeStack_.push(t),t=t.left}return e}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class Wt{constructor(e,t,i,n,r){this.key=e,this.value=t,this.color=null!=i?i:Wt.RED,this.left=null!=n?n:Gt.EMPTY_NODE,this.right=null!=r?r:Gt.EMPTY_NODE}copy(e,t,i,n,r){return new Wt(null!=e?e:this.key,null!=t?t:this.value,null!=i?i:this.color,null!=n?n:this.left,null!=r?r:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,i){let n=this;const r=i(e,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(e,t,i),null):0===r?n.copy(null,t,null,null,null):n.copy(null,null,null,null,n.right.insert(e,t,i)),n.fixUp_()}removeMin_(){if(this.left.isEmpty())return Gt.EMPTY_NODE;let e=this;return e.left.isRed_()||e.left.left.isRed_()||(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let i,n;if(i=this,t(e,i.key)<0)i.left.isEmpty()||i.left.isRed_()||i.left.left.isRed_()||(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),i.right.isEmpty()||i.right.isRed_()||i.right.left.isRed_()||(i=i.moveRedRight_()),0===t(e,i.key)){if(i.right.isEmpty())return Gt.EMPTY_NODE;n=i.right.min_(),i=i.copy(n.key,n.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,Wt.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,Wt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}Wt.RED=!0,Wt.BLACK=!1;class Kt{copy(e,t,i,n,r){return this}insert(e,t,i){return new Wt(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class Gt{constructor(e,t=Gt.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new Gt(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,Wt.BLACK,null,null))}remove(e){return new Gt(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,Wt.BLACK,null,null))}get(e){let t,i=this.root_;while(!i.isEmpty()){if(t=this.comparator_(e,i.key),0===t)return i.value;t<0?i=i.left:t>0&&(i=i.right)}return null}getPredecessorKey(e){let t,i=this.root_,n=null;while(!i.isEmpty()){if(t=this.comparator_(e,i.key),0===t){if(i.left.isEmpty())return n?n.key:null;i=i.left;while(!i.right.isEmpty())i=i.right;return i.key}t<0?i=i.left:t>0&&(n=i,i=i.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ht(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ht(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ht(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ht(this.root_,null,this.comparator_,!0,e)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function qt(e,t){return k(e.name,t.name)}function zt(e,t){return k(e,t)}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Jt;function Yt(e){Jt=e}Gt.EMPTY_NODE=new Kt;const Xt=function(e){return"number"===typeof e?"number:"+j(e):"string:"+e},$t=function(e){if(e.isLeafNode()){const t=e.val();(0,s.hu)("string"===typeof t||"number"===typeof t||"object"===typeof t&&(0,s.r3)(t,".sv"),"Priority must be a string or number.")}else(0,s.hu)(e===Jt||e.isEmpty(),"priority of unexpected type.");(0,s.hu)(e===Jt||e.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
let Qt,Zt,ei;class ti{constructor(e,t=ti.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,(0,s.hu)(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),$t(this.priorityNode_)}static set __childrenNodeConstructor(e){Qt=e}static get __childrenNodeConstructor(){return Qt}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new ti(this.value_,e)}getImmediateChild(e){return".priority"===e?this.priorityNode_:ti.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return yt(e)?this:".priority"===ht(e)?this.priorityNode_:ti.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return".priority"===e?this.updatePriority(t):t.isEmpty()&&".priority"!==e?this:ti.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const i=ht(e);return null===i?t:t.isEmpty()&&".priority"!==i?this:((0,s.hu)(".priority"!==i||1===ut(e),".priority must be the last token in a path"),this.updateImmediateChild(i,ti.__childrenNodeConstructor.EMPTY_NODE.updateChild(pt(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Xt(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",e+="number"===t?j(this.value_):this.value_,this.lazyHash_=v(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===ti.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof ti.__childrenNodeConstructor?-1:((0,s.hu)(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,i=typeof this.value_,n=ti.VALUE_TYPE_ORDER.indexOf(t),r=ti.VALUE_TYPE_ORDER.indexOf(i);return(0,s.hu)(n>=0,"Unknown leaf type: "+t),(0,s.hu)(r>=0,"Unknown leaf type: "+i),n===r?"object"===i?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:r-n}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}return!1}}function ii(e){Zt=e}function ni(e){ei=e}ti.VALUE_TYPE_ORDER=["object","boolean","number","string"];class ri extends Ut{compare(e,t){const i=e.node.getPriority(),n=t.node.getPriority(),r=i.compareTo(n);return 0===r?k(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return Ft.MIN}maxPost(){return new Ft(D,new ti("[PRIORITY-POST]",ei))}makePost(e,t){const i=Zt(e);return new Ft(t,new ti("[PRIORITY-POST]",i))}toString(){return".priority"}}const si=new ri,oi=Math.log(2);
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ai{constructor(e){const t=e=>parseInt(Math.log(e)/oi,10),i=e=>parseInt(Array(e+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;const n=i(this.count);this.bits_=e+1&n}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const ci=function(e,t,i,n){e.sort(t);const r=function(t,n){const s=n-t;let o,a;if(0===s)return null;if(1===s)return o=e[t],a=i?i(o):o,new Wt(a,o.node,Wt.BLACK,null,null);{const c=parseInt(s/2,10)+t,d=r(t,c),l=r(c+1,n);return o=e[c],a=i?i(o):o,new Wt(a,o.node,Wt.BLACK,d,l)}},s=function(t){let n=null,s=null,o=e.length;const a=function(t,n){const s=o-t,a=o;o-=t;const d=r(s+1,a),l=e[s],h=i?i(l):l;c(new Wt(h,l.node,n,null,d))},c=function(e){n?(n.left=e,n=e):(s=e,n=e)};for(let e=0;e<t.count;++e){const i=t.nextBitIsOne(),n=Math.pow(2,t.count-(e+1));i?a(n,Wt.BLACK):(a(n,Wt.BLACK),a(n,Wt.RED))}return s},o=new ai(e.length),a=s(o);return new Gt(n||t,a)};
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let di;const li={};class hi{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return(0,s.hu)(li&&si,"ChildrenNode.ts has not been loaded"),di=di||new hi({".priority":li},{".priority":si}),di}get(e){const t=(0,s.DV)(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Gt?t:null}hasIndex(e){return(0,s.r3)(this.indexSet_,e.toString())}addIndex(e,t){(0,s.hu)(e!==Bt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const i=[];let n=!1;const r=t.getIterator(Ft.Wrap);let o,a=r.getNext();while(a)n=n||e.isDefinedOn(a.node),i.push(a),a=r.getNext();o=n?ci(i,e.getCompare()):li;const c=e.toString(),d=Object.assign({},this.indexSet_);d[c]=e;const l=Object.assign({},this.indexes_);return l[c]=o,new hi(l,d)}addToIndexes(e,t){const i=(0,s.UI)(this.indexes_,((i,n)=>{const r=(0,s.DV)(this.indexSet_,n);if((0,s.hu)(r,"Missing index implementation for "+n),i===li){if(r.isDefinedOn(e.node)){const i=[],n=t.getIterator(Ft.Wrap);let s=n.getNext();while(s)s.name!==e.name&&i.push(s),s=n.getNext();return i.push(e),ci(i,r.getCompare())}return li}{const n=t.get(e.name);let r=i;return n&&(r=r.remove(new Ft(e.name,n))),r.insert(e,e.node)}}));return new hi(i,this.indexSet_)}removeFromIndexes(e,t){const i=(0,s.UI)(this.indexes_,(i=>{if(i===li)return i;{const n=t.get(e.name);return n?i.remove(new Ft(e.name,n)):i}}));return new hi(i,this.indexSet_)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ui;class pi{constructor(e,t,i){this.children_=e,this.priorityNode_=t,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&$t(this.priorityNode_),this.children_.isEmpty()&&(0,s.hu)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return ui||(ui=new pi(new Gt(zt),null,hi.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||ui}updatePriority(e){return this.children_.isEmpty()?this:new pi(this.children_,e,this.indexMap_)}getImmediateChild(e){if(".priority"===e)return this.getPriority();{const t=this.children_.get(e);return null===t?ui:t}}getChild(e){const t=ht(e);return null===t?this:this.getImmediateChild(t).getChild(pt(e))}hasChild(e){return null!==this.children_.get(e)}updateImmediateChild(e,t){if((0,s.hu)(t,"We should always be passing snapshot nodes"),".priority"===e)return this.updatePriority(t);{const i=new Ft(e,t);let n,r;t.isEmpty()?(n=this.children_.remove(e),r=this.indexMap_.removeFromIndexes(i,this.children_)):(n=this.children_.insert(e,t),r=this.indexMap_.addToIndexes(i,this.children_));const s=n.isEmpty()?ui:this.priorityNode_;return new pi(n,s,r)}}updateChild(e,t){const i=ht(e);if(null===i)return t;{(0,s.hu)(".priority"!==ht(e)||1===ut(e),".priority must be the last token in a path");const n=this.getImmediateChild(i).updateChild(pt(e),t);return this.updateImmediateChild(i,n)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let i=0,n=0,r=!0;if(this.forEachChild(si,((s,o)=>{t[s]=o.val(e),i++,r&&pi.INTEGER_REGEXP_.test(s)?n=Math.max(n,Number(s)):r=!1})),!e&&r&&n<2*i){const e=[];for(const i in t)e[i]=t[i];return e}return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(null===this.lazyHash_){let e="";this.getPriority().isEmpty()||(e+="priority:"+Xt(this.getPriority().val())+":"),this.forEachChild(si,((t,i)=>{const n=i.hash();""!==n&&(e+=":"+t+":"+n)})),this.lazyHash_=""===e?"":v(e)}return this.lazyHash_}getPredecessorChildName(e,t,i){const n=this.resolveIndex_(i);if(n){const i=n.getPredecessorKey(new Ft(e,t));return i?i.name:null}return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const e=t.minKey();return e&&e.name}return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new Ft(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const e=t.maxKey();return e&&e.name}return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new Ft(t,this.children_.get(t)):null}forEachChild(e,t){const i=this.resolveIndex_(e);return i?i.inorderTraversal((e=>t(e.name,e.node))):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const i=this.resolveIndex_(t);if(i)return i.getIteratorFrom(e,(e=>e));{const i=this.children_.getIteratorFrom(e.name,Ft.Wrap);let n=i.peek();while(null!=n&&t.compare(n,e)<0)i.getNext(),n=i.peek();return i}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const i=this.resolveIndex_(t);if(i)return i.getReverseIteratorFrom(e,(e=>e));{const i=this.children_.getReverseIteratorFrom(e.name,Ft.Wrap);let n=i.peek();while(null!=n&&t.compare(n,e)>0)i.getNext(),n=i.peek();return i}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===fi?-1:0}withIndex(e){if(e===Bt||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new pi(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Bt||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority())){if(this.children_.count()===t.children_.count()){const e=this.getIterator(si),i=t.getIterator(si);let n=e.getNext(),r=i.getNext();while(n&&r){if(n.name!==r.name||!n.node.equals(r.node))return!1;n=e.getNext(),r=i.getNext()}return null===n&&null===r}return!1}return!1}}resolveIndex_(e){return e===Bt?null:this.indexMap_.get(e.toString())}}pi.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class mi extends pi{constructor(){super(new Gt(zt),pi.EMPTY_NODE,hi.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return pi.EMPTY_NODE}isEmpty(){return!1}}const fi=new mi;Object.defineProperties(Ft,{MIN:{value:new Ft(N,pi.EMPTY_NODE)},MAX:{value:new Ft(D,fi)}}),Vt.__EMPTY_NODE=pi.EMPTY_NODE,ti.__childrenNodeConstructor=pi,Yt(fi),ni(fi);
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const gi=!0;function _i(e,t=null){if(null===e)return pi.EMPTY_NODE;if("object"===typeof e&&".priority"in e&&(t=e[".priority"]),(0,s.hu)(null===t||"string"===typeof t||"number"===typeof t||"object"===typeof t&&".sv"in t,"Invalid priority type found: "+typeof t),"object"===typeof e&&".value"in e&&null!==e[".value"]&&(e=e[".value"]),"object"!==typeof e||".sv"in e){const i=e;return new ti(i,_i(t))}if(e instanceof Array||!gi){let i=pi.EMPTY_NODE;return U(e,((t,n)=>{if((0,s.r3)(e,t)&&"."!==t.substring(0,1)){const e=_i(n);!e.isLeafNode()&&e.isEmpty()||(i=i.updateImmediateChild(t,e))}})),i.updatePriority(_i(t))}{const i=[];let n=!1;const r=e;if(U(r,((e,t)=>{if("."!==e.substring(0,1)){const r=_i(t);r.isEmpty()||(n=n||!r.getPriority().isEmpty(),i.push(new Ft(e,r)))}})),0===i.length)return pi.EMPTY_NODE;const s=ci(i,qt,(e=>e.name),zt);if(n){const e=ci(i,si.getCompare());return new pi(s,_i(t),new hi({".priority":e},{".priority":si}))}return new pi(s,_i(t),hi.Default)}}ii(_i);
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class vi extends Ut{constructor(e){super(),this.indexPath_=e,(0,s.hu)(!yt(e)&&".priority"!==ht(e),"Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const i=this.extractChild(e.node),n=this.extractChild(t.node),r=i.compareTo(n);return 0===r?k(e.name,t.name):r}makePost(e,t){const i=_i(e),n=pi.EMPTY_NODE.updateChild(this.indexPath_,i);return new Ft(t,n)}maxPost(){const e=pi.EMPTY_NODE.updateChild(this.indexPath_,fi);return new Ft(D,e)}toString(){return gt(this.indexPath_,0).join("/")}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yi extends Ut{compare(e,t){const i=e.node.compareTo(t.node);return 0===i?k(e.name,t.name):i}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return Ft.MIN}maxPost(){return Ft.MAX}makePost(e,t){const i=_i(e);return new Ft(t,i)}toString(){return".value"}}const Ei=new yi;
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Si(e){return{type:"value",snapshotNode:e}}function bi(e,t){return{type:"child_added",snapshotNode:t,childName:e}}function wi(e,t){return{type:"child_removed",snapshotNode:t,childName:e}}function Ti(e,t,i){return{type:"child_changed",snapshotNode:t,childName:e,oldSnap:i}}function Ci(e,t){return{type:"child_moved",snapshotNode:t,childName:e}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ri{constructor(e){this.index_=e}updateChild(e,t,i,n,r,o){(0,s.hu)(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const a=e.getImmediateChild(t);return a.getChild(n).equals(i.getChild(n))&&a.isEmpty()===i.isEmpty()?e:(null!=o&&(i.isEmpty()?e.hasChild(t)?o.trackChildChange(wi(t,a)):(0,s.hu)(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(bi(t,i)):o.trackChildChange(Ti(t,i,a))),e.isLeafNode()&&i.isEmpty()?e:e.updateImmediateChild(t,i).withIndex(this.index_))}updateFullNode(e,t,i){return null!=i&&(e.isLeafNode()||e.forEachChild(si,((e,n)=>{t.hasChild(e)||i.trackChildChange(wi(e,n))})),t.isLeafNode()||t.forEachChild(si,((t,n)=>{if(e.hasChild(t)){const r=e.getImmediateChild(t);r.equals(n)||i.trackChildChange(Ti(t,n,r))}else i.trackChildChange(bi(t,n))}))),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?pi.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ii{constructor(e){this.indexedFilter_=new Ri(e.getIndex()),this.index_=e.getIndex(),this.startPost_=Ii.getStartPost_(e),this.endPost_=Ii.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,i=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&i}updateChild(e,t,i,n,r,s){return this.matches(new Ft(t,i))||(i=pi.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,i,n,r,s)}updateFullNode(e,t,i){t.isLeafNode()&&(t=pi.EMPTY_NODE);let n=t.withIndex(this.index_);n=n.updatePriority(pi.EMPTY_NODE);const r=this;return t.forEachChild(si,((e,t)=>{r.matches(new Ft(e,t))||(n=n.updateImmediateChild(e,pi.EMPTY_NODE))})),this.indexedFilter_.updateFullNode(e,n,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}return e.getIndex().maxPost()}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ai{constructor(e){this.withinDirectionalStart=e=>this.reverse_?this.withinEndPost(e):this.withinStartPost(e),this.withinDirectionalEnd=e=>this.reverse_?this.withinStartPost(e):this.withinEndPost(e),this.withinStartPost=e=>{const t=this.index_.compare(this.rangedFilter_.getStartPost(),e);return this.startIsInclusive_?t<=0:t<0},this.withinEndPost=e=>{const t=this.index_.compare(e,this.rangedFilter_.getEndPost());return this.endIsInclusive_?t<=0:t<0},this.rangedFilter_=new Ii(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,i,n,r,s){return this.rangedFilter_.matches(new Ft(t,i))||(i=pi.EMPTY_NODE),e.getImmediateChild(t).equals(i)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,i,n,r,s):this.fullLimitUpdateChild_(e,t,i,r,s)}updateFullNode(e,t,i){let n;if(t.isLeafNode()||t.isEmpty())n=pi.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<t.numChildren()&&t.isIndexed(this.index_)){let e;n=pi.EMPTY_NODE.withIndex(this.index_),e=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let i=0;while(e.hasNext()&&i<this.limit_){const t=e.getNext();if(this.withinDirectionalStart(t)){if(!this.withinDirectionalEnd(t))break;n=n.updateImmediateChild(t.name,t.node),i++}}}else{let e;n=t.withIndex(this.index_),n=n.updatePriority(pi.EMPTY_NODE),e=this.reverse_?n.getReverseIterator(this.index_):n.getIterator(this.index_);let i=0;while(e.hasNext()){const t=e.getNext(),r=i<this.limit_&&this.withinDirectionalStart(t)&&this.withinDirectionalEnd(t);r?i++:n=n.updateImmediateChild(t.name,pi.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,n,i)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,i,n,r){let o;if(this.reverse_){const e=this.index_.getCompare();o=(t,i)=>e(i,t)}else o=this.index_.getCompare();const a=e;(0,s.hu)(a.numChildren()===this.limit_,"");const c=new Ft(t,i),d=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),l=this.rangedFilter_.matches(c);if(a.hasChild(t)){const e=a.getImmediateChild(t);let s=n.getChildAfterChild(this.index_,d,this.reverse_);while(null!=s&&(s.name===t||a.hasChild(s.name)))s=n.getChildAfterChild(this.index_,s,this.reverse_);const h=null==s?1:o(s,c),u=l&&!i.isEmpty()&&h>=0;if(u)return null!=r&&r.trackChildChange(Ti(t,i,e)),a.updateImmediateChild(t,i);{null!=r&&r.trackChildChange(wi(t,e));const i=a.updateImmediateChild(t,pi.EMPTY_NODE),n=null!=s&&this.rangedFilter_.matches(s);return n?(null!=r&&r.trackChildChange(bi(s.name,s.node)),i.updateImmediateChild(s.name,s.node)):i}}return i.isEmpty()?e:l&&o(d,c)>=0?(null!=r&&(r.trackChildChange(wi(d.name,d.node)),r.trackChildChange(bi(t,i))),a.updateImmediateChild(t,i).updateImmediateChild(d.name,pi.EMPTY_NODE)):e}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pi{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=si}hasStart(){return this.startSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,s.hu)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return(0,s.hu)(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:N}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,s.hu)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return(0,s.hu)(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:D}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,s.hu)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===si}copy(){const e=new Pi;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Oi(e){return e.loadsAllData()?new Ri(e.getIndex()):e.hasLimit()?new Ai(e):new Ii(e)}function Ni(e){const t={};if(e.isDefault())return t;let i;if(e.index_===si?i="$priority":e.index_===Ei?i="$value":e.index_===Bt?i="$key":((0,s.hu)(e.index_ instanceof vi,"Unrecognized index type!"),i=e.index_.toString()),t["orderBy"]=(0,s.Wl)(i),e.startSet_){const i=e.startAfterSet_?"startAfter":"startAt";t[i]=(0,s.Wl)(e.indexStartValue_),e.startNameSet_&&(t[i]+=","+(0,s.Wl)(e.indexStartName_))}if(e.endSet_){const i=e.endBeforeSet_?"endBefore":"endAt";t[i]=(0,s.Wl)(e.indexEndValue_),e.endNameSet_&&(t[i]+=","+(0,s.Wl)(e.indexEndName_))}return e.limitSet_&&(e.isViewFromLeft()?t["limitToFirst"]=e.limit_:t["limitToLast"]=e.limit_),t}function Di(e){const t={};if(e.startSet_&&(t["sp"]=e.indexStartValue_,e.startNameSet_&&(t["sn"]=e.indexStartName_),t["sin"]=!e.startAfterSet_),e.endSet_&&(t["ep"]=e.indexEndValue_,e.endNameSet_&&(t["en"]=e.indexEndName_),t["ein"]=!e.endBeforeSet_),e.limitSet_){t["l"]=e.limit_;let i=e.viewFrom_;""===i&&(i=e.isViewFromLeft()?"l":"r"),t["vf"]=i}return e.index_!==si&&(t["i"]=e.index_.toString()),t}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ki extends rt{constructor(e,t,i,n){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=i,this.appCheckTokenProvider_=n,this.log_=T("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return void 0!==t?"tag$"+t:((0,s.hu)(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,i,n){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=ki.getListenId_(e,i),a={};this.listens_[o]=a;const c=Ni(e._queryParams);this.restRequest_(r+".json",c,((e,t)=>{let c=t;if(404===e&&(c=null,e=null),null===e&&this.onDataUpdate_(r,c,!1,i),(0,s.DV)(this.listens_,o)===a){let t;t=e?401===e?"permission_denied":"rest_error:"+e:"ok",n(t,null)}}))}unlisten(e,t){const i=ki.getListenId_(e,t);delete this.listens_[i]}get(e){const t=Ni(e._queryParams),i=e._path.toString(),n=new s.BH;return this.restRequest_(i+".json",t,((e,t)=>{let r=t;404===e&&(r=null,e=null),null===e?(this.onDataUpdate_(i,r,!1,null),n.resolve(r)):n.reject(new Error(r))})),n.promise}refreshAuthToken(e){}restRequest_(e,t={},i){return t["format"]="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then((([n,r])=>{n&&n.accessToken&&(t["auth"]=n.accessToken),r&&r.token&&(t["ac"]=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+(0,s.xO)(t);this.log_("Sending REST request for "+o);const a=new XMLHttpRequest;a.onreadystatechange=()=>{if(i&&4===a.readyState){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let t=null;if(a.status>=200&&a.status<300){try{t=(0,s.cI)(a.responseText)}catch(e){I("Failed to parse JSON response for "+o+": "+a.responseText)}i(null,t)}else 401!==a.status&&404!==a.status&&I("Got unsuccessful REST response for "+o+" Status: "+a.status),i(a.status);i=null}},a.open("GET",o,!0),a.send()}))}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xi{constructor(){this.rootNode_=pi.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Li(){return{value:null,children:new Map}}function Mi(e,t,i){if(yt(t))e.value=i,e.children.clear();else if(null!==e.value)e.value=e.value.updateChild(t,i);else{const n=ht(t);e.children.has(n)||e.children.set(n,Li());const r=e.children.get(n);t=pt(t),Mi(r,t,i)}}function Fi(e,t,i){null!==e.value?i(t,e.value):Ui(e,((e,n)=>{const r=new dt(t.toString()+"/"+e);Fi(n,r,i)}))}function Ui(e,t){e.children.forEach(((e,i)=>{t(i,e)}))}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ji{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t=Object.assign({},e);return this.last_&&U(this.last_,((e,i)=>{t[e]=t[e]-i})),this.last_=e,t}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vi=1e4,Bi=3e4,Hi=3e5;class Wi{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new ji(e);const i=Vi+(Bi-Vi)*Math.random();Y(this.reportStats_.bind(this),Math.floor(i))}reportStats_(){const e=this.statsListener_.get(),t={};let i=!1;U(e,((e,n)=>{n>0&&(0,s.r3)(this.statsToReport_,e)&&(t[e]=n,i=!0)})),i&&this.server_.reportStats(t),Y(this.reportStats_.bind(this),Math.floor(2*Math.random()*Hi))}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ki;function Gi(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function qi(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function zi(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(function(e){e[e["OVERWRITE"]=0]="OVERWRITE",e[e["MERGE"]=1]="MERGE",e[e["ACK_USER_WRITE"]=2]="ACK_USER_WRITE",e[e["LISTEN_COMPLETE"]=3]="LISTEN_COMPLETE"})(Ki||(Ki={}));class Ji{constructor(e,t,i){this.path=e,this.affectedTree=t,this.revert=i,this.type=Ki.ACK_USER_WRITE,this.source=Gi()}operationForChild(e){if(yt(this.path)){if(null!=this.affectedTree.value)return(0,s.hu)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new dt(e));return new Ji(lt(),t,this.revert)}}return(0,s.hu)(ht(this.path)===e,"operationForChild called for unrelated child."),new Ji(pt(this.path),this.affectedTree,this.revert)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yi{constructor(e,t){this.source=e,this.path=t,this.type=Ki.LISTEN_COMPLETE}operationForChild(e){return yt(this.path)?new Yi(this.source,lt()):new Yi(this.source,pt(this.path))}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xi{constructor(e,t,i){this.source=e,this.path=t,this.snap=i,this.type=Ki.OVERWRITE}operationForChild(e){return yt(this.path)?new Xi(this.source,lt(),this.snap.getImmediateChild(e)):new Xi(this.source,pt(this.path),this.snap)}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $i{constructor(e,t,i){this.source=e,this.path=t,this.children=i,this.type=Ki.MERGE}operationForChild(e){if(yt(this.path)){const t=this.children.subtree(new dt(e));return t.isEmpty()?null:t.value?new Xi(this.source,lt(),t.value):new $i(this.source,lt(),t)}return(0,s.hu)(ht(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new $i(this.source,pt(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qi{constructor(e,t,i){this.node_=e,this.fullyInitialized_=t,this.filtered_=i}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(yt(e))return this.isFullyInitialized()&&!this.filtered_;const t=ht(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zi{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function en(e,t,i,n){const r=[],s=[];return t.forEach((t=>{"child_changed"===t.type&&e.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&s.push(Ci(t.childName,t.snapshotNode))})),tn(e,r,"child_removed",t,n,i),tn(e,r,"child_added",t,n,i),tn(e,r,"child_moved",s,n,i),tn(e,r,"child_changed",t,n,i),tn(e,r,"value",t,n,i),r}function tn(e,t,i,n,r,s){const o=n.filter((e=>e.type===i));o.sort(((t,i)=>rn(e,t,i))),o.forEach((i=>{const n=nn(e,i,s);r.forEach((r=>{r.respondsTo(i.type)&&t.push(r.createEvent(n,e.query_))}))}))}function nn(e,t,i){return"value"===t.type||"child_removed"===t.type||(t.prevName=i.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}function rn(e,t,i){if(null==t.childName||null==i.childName)throw(0,s.g5)("Should only compare child_ events.");const n=new Ft(t.childName,t.snapshotNode),r=new Ft(i.childName,i.snapshotNode);return e.index_.compare(n,r)}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sn(e,t){return{eventCache:e,serverCache:t}}function on(e,t,i,n){return sn(new Qi(t,i,n),e.serverCache)}function an(e,t,i,n){return sn(e.eventCache,new Qi(t,i,n))}function cn(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function dn(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ln;const hn=()=>(ln||(ln=new Gt(x)),ln);class un{constructor(e,t=hn()){this.value=e,this.children=t}static fromObject(e){let t=new un(null);return U(e,((e,i)=>{t=t.set(new dt(e),i)})),t}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(null!=this.value&&t(this.value))return{path:lt(),value:this.value};if(yt(e))return null;{const i=ht(e),n=this.children.get(i);if(null!==n){const r=n.findRootMostMatchingPathAndValue(pt(e),t);if(null!=r){const e=vt(new dt(i),r.path);return{path:e,value:r.value}}return null}return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,(()=>!0))}subtree(e){if(yt(e))return this;{const t=ht(e),i=this.children.get(t);return null!==i?i.subtree(pt(e)):new un(null)}}set(e,t){if(yt(e))return new un(t,this.children);{const i=ht(e),n=this.children.get(i)||new un(null),r=n.set(pt(e),t),s=this.children.insert(i,r);return new un(this.value,s)}}remove(e){if(yt(e))return this.children.isEmpty()?new un(null):new un(null,this.children);{const t=ht(e),i=this.children.get(t);if(i){const n=i.remove(pt(e));let r;return r=n.isEmpty()?this.children.remove(t):this.children.insert(t,n),null===this.value&&r.isEmpty()?new un(null):new un(this.value,r)}return this}}get(e){if(yt(e))return this.value;{const t=ht(e),i=this.children.get(t);return i?i.get(pt(e)):null}}setTree(e,t){if(yt(e))return t;{const i=ht(e),n=this.children.get(i)||new un(null),r=n.setTree(pt(e),t);let s;return s=r.isEmpty()?this.children.remove(i):this.children.insert(i,r),new un(this.value,s)}}fold(e){return this.fold_(lt(),e)}fold_(e,t){const i={};return this.children.inorderTraversal(((n,r)=>{i[n]=r.fold_(vt(e,n),t)})),t(e,this.value,i)}findOnPath(e,t){return this.findOnPath_(e,lt(),t)}findOnPath_(e,t,i){const n=!!this.value&&i(t,this.value);if(n)return n;if(yt(e))return null;{const n=ht(e),r=this.children.get(n);return r?r.findOnPath_(pt(e),vt(t,n),i):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,lt(),t)}foreachOnPath_(e,t,i){if(yt(e))return this;{this.value&&i(t,this.value);const n=ht(e),r=this.children.get(n);return r?r.foreachOnPath_(pt(e),vt(t,n),i):new un(null)}}foreach(e){this.foreach_(lt(),e)}foreach_(e,t){this.children.inorderTraversal(((i,n)=>{n.foreach_(vt(e,i),t)})),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal(((t,i)=>{i.value&&e(t,i.value)}))}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pn{constructor(e){this.writeTree_=e}static empty(){return new pn(new un(null))}}function mn(e,t,i){if(yt(t))return new pn(new un(i));{const n=e.writeTree_.findRootMostValueAndPath(t);if(null!=n){const r=n.path;let s=n.value;const o=Et(r,t);return s=s.updateChild(o,i),new pn(e.writeTree_.set(r,s))}{const n=new un(i),r=e.writeTree_.setTree(t,n);return new pn(r)}}}function fn(e,t,i){let n=e;return U(i,((e,i)=>{n=mn(n,vt(t,e),i)})),n}function gn(e,t){if(yt(t))return pn.empty();{const i=e.writeTree_.setTree(t,new un(null));return new pn(i)}}function _n(e,t){return null!=vn(e,t)}function vn(e,t){const i=e.writeTree_.findRootMostValueAndPath(t);return null!=i?e.writeTree_.get(i.path).getChild(Et(i.path,t)):null}function yn(e){const t=[],i=e.writeTree_.value;return null!=i?i.isLeafNode()||i.forEachChild(si,((e,i)=>{t.push(new Ft(e,i))})):e.writeTree_.children.inorderTraversal(((e,i)=>{null!=i.value&&t.push(new Ft(e,i.value))})),t}function En(e,t){if(yt(t))return e;{const i=vn(e,t);return new pn(null!=i?new un(i):e.writeTree_.subtree(t))}}function Sn(e){return e.writeTree_.isEmpty()}function bn(e,t){return wn(lt(),e.writeTree_,t)}function wn(e,t,i){if(null!=t.value)return i.updateChild(e,t.value);{let n=null;return t.children.inorderTraversal(((t,r)=>{".priority"===t?((0,s.hu)(null!==r.value,"Priority writes must always be leaf nodes"),n=r.value):i=wn(vt(e,t),r,i)})),i.getChild(e).isEmpty()||null===n||(i=i.updateChild(vt(e,".priority"),n)),i}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Tn(e,t){return qn(t,e)}function Cn(e,t,i,n,r){(0,s.hu)(n>e.lastWriteId,"Stacking an older write on top of newer ones"),void 0===r&&(r=!0),e.allWrites.push({path:t,snap:i,writeId:n,visible:r}),r&&(e.visibleWrites=mn(e.visibleWrites,t,i)),e.lastWriteId=n}function Rn(e,t){for(let i=0;i<e.allWrites.length;i++){const n=e.allWrites[i];if(n.writeId===t)return n}return null}function In(e,t){const i=e.allWrites.findIndex((e=>e.writeId===t));(0,s.hu)(i>=0,"removeWrite called with nonexistent writeId.");const n=e.allWrites[i];e.allWrites.splice(i,1);let r=n.visible,o=!1,a=e.allWrites.length-1;while(r&&a>=0){const t=e.allWrites[a];t.visible&&(a>=i&&An(t,n.path)?r=!1:bt(n.path,t.path)&&(o=!0)),a--}if(r){if(o)return Pn(e),!0;if(n.snap)e.visibleWrites=gn(e.visibleWrites,n.path);else{const t=n.children;U(t,(t=>{e.visibleWrites=gn(e.visibleWrites,vt(n.path,t))}))}return!0}return!1}function An(e,t){if(e.snap)return bt(e.path,t);for(const i in e.children)if(e.children.hasOwnProperty(i)&&bt(vt(e.path,i),t))return!0;return!1}function Pn(e){e.visibleWrites=Nn(e.allWrites,On,lt()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}function On(e){return e.visible}function Nn(e,t,i){let n=pn.empty();for(let r=0;r<e.length;++r){const o=e[r];if(t(o)){const e=o.path;let t;if(o.snap)bt(i,e)?(t=Et(i,e),n=mn(n,t,o.snap)):bt(e,i)&&(t=Et(e,i),n=mn(n,lt(),o.snap.getChild(t)));else{if(!o.children)throw(0,s.g5)("WriteRecord should have .snap or .children");if(bt(i,e))t=Et(i,e),n=fn(n,t,o.children);else if(bt(e,i))if(t=Et(e,i),yt(t))n=fn(n,lt(),o.children);else{const e=(0,s.DV)(o.children,ht(t));if(e){const i=e.getChild(pt(t));n=mn(n,lt(),i)}}}}}return n}function Dn(e,t,i,n,r){if(n||r){const s=En(e.visibleWrites,t);if(!r&&Sn(s))return i;if(r||null!=i||_n(s,lt())){const s=function(e){return(e.visible||r)&&(!n||!~n.indexOf(e.writeId))&&(bt(e.path,t)||bt(t,e.path))},o=Nn(e.allWrites,s,t),a=i||pi.EMPTY_NODE;return bn(o,a)}return null}{const n=vn(e.visibleWrites,t);if(null!=n)return n;{const n=En(e.visibleWrites,t);if(Sn(n))return i;if(null!=i||_n(n,lt())){const e=i||pi.EMPTY_NODE;return bn(n,e)}return null}}}function kn(e,t,i){let n=pi.EMPTY_NODE;const r=vn(e.visibleWrites,t);if(r)return r.isLeafNode()||r.forEachChild(si,((e,t)=>{n=n.updateImmediateChild(e,t)})),n;if(i){const r=En(e.visibleWrites,t);return i.forEachChild(si,((e,t)=>{const i=bn(En(r,new dt(e)),t);n=n.updateImmediateChild(e,i)})),yn(r).forEach((e=>{n=n.updateImmediateChild(e.name,e.node)})),n}{const i=En(e.visibleWrites,t);return yn(i).forEach((e=>{n=n.updateImmediateChild(e.name,e.node)})),n}}function xn(e,t,i,n,r){(0,s.hu)(n||r,"Either existingEventSnap or existingServerSnap must exist");const o=vt(t,i);if(_n(e.visibleWrites,o))return null;{const t=En(e.visibleWrites,o);return Sn(t)?r.getChild(i):bn(t,r.getChild(i))}}function Ln(e,t,i,n){const r=vt(t,i),s=vn(e.visibleWrites,r);if(null!=s)return s;if(n.isCompleteForChild(i)){const t=En(e.visibleWrites,r);return bn(t,n.getNode().getImmediateChild(i))}return null}function Mn(e,t){return vn(e.visibleWrites,t)}function Fn(e,t,i,n,r,s,o){let a;const c=En(e.visibleWrites,t),d=vn(c,lt());if(null!=d)a=d;else{if(null==i)return[];a=bn(c,i)}if(a=a.withIndex(o),a.isEmpty()||a.isLeafNode())return[];{const e=[],t=o.getCompare(),i=s?a.getReverseIteratorFrom(n,o):a.getIteratorFrom(n,o);let c=i.getNext();while(c&&e.length<r)0!==t(c,n)&&e.push(c),c=i.getNext();return e}}function Un(){return{visibleWrites:pn.empty(),allWrites:[],lastWriteId:-1}}function jn(e,t,i,n){return Dn(e.writeTree,e.treePath,t,i,n)}function Vn(e,t){return kn(e.writeTree,e.treePath,t)}function Bn(e,t,i,n){return xn(e.writeTree,e.treePath,t,i,n)}function Hn(e,t){return Mn(e.writeTree,vt(e.treePath,t))}function Wn(e,t,i,n,r,s){return Fn(e.writeTree,e.treePath,t,i,n,r,s)}function Kn(e,t,i){return Ln(e.writeTree,e.treePath,t,i)}function Gn(e,t){return qn(vt(e.treePath,t),e.writeTree)}function qn(e,t){return{treePath:e,writeTree:t}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zn{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,i=e.childName;(0,s.hu)("child_added"===t||"child_changed"===t||"child_removed"===t,"Only child changes supported for tracking"),(0,s.hu)(".priority"!==i,"Only non-priority child changes can be tracked.");const n=this.changeMap.get(i);if(n){const r=n.type;if("child_added"===t&&"child_removed"===r)this.changeMap.set(i,Ti(i,e.snapshotNode,n.snapshotNode));else if("child_removed"===t&&"child_added"===r)this.changeMap.delete(i);else if("child_removed"===t&&"child_changed"===r)this.changeMap.set(i,wi(i,n.oldSnap));else if("child_changed"===t&&"child_added"===r)this.changeMap.set(i,bi(i,e.snapshotNode));else{if("child_changed"!==t||"child_changed"!==r)throw(0,s.g5)("Illegal combination of changes: "+e+" occurred after "+n);this.changeMap.set(i,Ti(i,e.snapshotNode,n.oldSnap))}}else this.changeMap.set(i,e)}getChanges(){return Array.from(this.changeMap.values())}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jn{getCompleteChild(e){return null}getChildAfterChild(e,t,i){return null}}const Yn=new Jn;class Xn{constructor(e,t,i=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=i}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const t=null!=this.optCompleteServerCache_?new Qi(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Kn(this.writes_,e,t)}}getChildAfterChild(e,t,i){const n=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:dn(this.viewCache_),r=Wn(this.writes_,n,t,1,i,e);return 0===r.length?null:r[0]}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $n(e){return{filter:e}}function Qn(e,t){(0,s.hu)(t.eventCache.getNode().isIndexed(e.filter.getIndex()),"Event snap not indexed"),(0,s.hu)(t.serverCache.getNode().isIndexed(e.filter.getIndex()),"Server snap not indexed")}function Zn(e,t,i,n,r){const o=new zn;let a,c;if(i.type===Ki.OVERWRITE){const d=i;d.source.fromUser?a=nr(e,t,d.path,d.snap,n,r,o):((0,s.hu)(d.source.fromServer,"Unknown source."),c=d.source.tagged||t.serverCache.isFiltered()&&!yt(d.path),a=ir(e,t,d.path,d.snap,n,r,c,o))}else if(i.type===Ki.MERGE){const d=i;d.source.fromUser?a=sr(e,t,d.path,d.children,n,r,o):((0,s.hu)(d.source.fromServer,"Unknown source."),c=d.source.tagged||t.serverCache.isFiltered(),a=ar(e,t,d.path,d.children,n,r,c,o))}else if(i.type===Ki.ACK_USER_WRITE){const s=i;a=s.revert?lr(e,t,s.path,n,r,o):cr(e,t,s.path,s.affectedTree,n,r,o)}else{if(i.type!==Ki.LISTEN_COMPLETE)throw(0,s.g5)("Unknown operation type: "+i.type);a=dr(e,t,i.path,n,o)}const d=o.getChanges();return er(t,a,d),{viewCache:a,changes:d}}function er(e,t,i){const n=t.eventCache;if(n.isFullyInitialized()){const r=n.getNode().isLeafNode()||n.getNode().isEmpty(),s=cn(e);(i.length>0||!e.eventCache.isFullyInitialized()||r&&!n.getNode().equals(s)||!n.getNode().getPriority().equals(s.getPriority()))&&i.push(Si(cn(t)))}}function tr(e,t,i,n,r,o){const a=t.eventCache;if(null!=Hn(n,i))return t;{let c,d;if(yt(i))if((0,s.hu)(t.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),t.serverCache.isFiltered()){const i=dn(t),r=i instanceof pi?i:pi.EMPTY_NODE,s=Vn(n,r);c=e.filter.updateFullNode(t.eventCache.getNode(),s,o)}else{const i=jn(n,dn(t));c=e.filter.updateFullNode(t.eventCache.getNode(),i,o)}else{const l=ht(i);if(".priority"===l){(0,s.hu)(1===ut(i),"Can't have a priority with additional path components");const r=a.getNode();d=t.serverCache.getNode();const o=Bn(n,i,r,d);c=null!=o?e.filter.updatePriority(r,o):a.getNode()}else{const s=pt(i);let h;if(a.isCompleteForChild(l)){d=t.serverCache.getNode();const e=Bn(n,i,a.getNode(),d);h=null!=e?a.getNode().getImmediateChild(l).updateChild(s,e):a.getNode().getImmediateChild(l)}else h=Kn(n,l,t.serverCache);c=null!=h?e.filter.updateChild(a.getNode(),l,h,s,r,o):a.getNode()}}return on(t,c,a.isFullyInitialized()||yt(i),e.filter.filtersNodes())}}function ir(e,t,i,n,r,s,o,a){const c=t.serverCache;let d;const l=o?e.filter:e.filter.getIndexedFilter();if(yt(i))d=l.updateFullNode(c.getNode(),n,null);else if(l.filtersNodes()&&!c.isFiltered()){const e=c.getNode().updateChild(i,n);d=l.updateFullNode(c.getNode(),e,null)}else{const e=ht(i);if(!c.isCompleteForPath(i)&&ut(i)>1)return t;const r=pt(i),s=c.getNode().getImmediateChild(e),o=s.updateChild(r,n);d=".priority"===e?l.updatePriority(c.getNode(),o):l.updateChild(c.getNode(),e,o,r,Yn,null)}const h=an(t,d,c.isFullyInitialized()||yt(i),l.filtersNodes()),u=new Xn(r,h,s);return tr(e,h,i,r,u,a)}function nr(e,t,i,n,r,s,o){const a=t.eventCache;let c,d;const l=new Xn(r,t,s);if(yt(i))d=e.filter.updateFullNode(t.eventCache.getNode(),n,o),c=on(t,d,!0,e.filter.filtersNodes());else{const r=ht(i);if(".priority"===r)d=e.filter.updatePriority(t.eventCache.getNode(),n),c=on(t,d,a.isFullyInitialized(),a.isFiltered());else{const s=pt(i),d=a.getNode().getImmediateChild(r);let h;if(yt(s))h=n;else{const e=l.getCompleteChild(r);h=null!=e?".priority"===mt(s)&&e.getChild(_t(s)).isEmpty()?e:e.updateChild(s,n):pi.EMPTY_NODE}if(d.equals(h))c=t;else{const i=e.filter.updateChild(a.getNode(),r,h,s,l,o);c=on(t,i,a.isFullyInitialized(),e.filter.filtersNodes())}}}return c}function rr(e,t){return e.eventCache.isCompleteForChild(t)}function sr(e,t,i,n,r,s,o){let a=t;return n.foreach(((n,c)=>{const d=vt(i,n);rr(t,ht(d))&&(a=nr(e,a,d,c,r,s,o))})),n.foreach(((n,c)=>{const d=vt(i,n);rr(t,ht(d))||(a=nr(e,a,d,c,r,s,o))})),a}function or(e,t,i){return i.foreach(((e,i)=>{t=t.updateChild(e,i)})),t}function ar(e,t,i,n,r,s,o,a){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;let c,d=t;c=yt(i)?n:new un(null).setTree(i,n);const l=t.serverCache.getNode();return c.children.inorderTraversal(((i,n)=>{if(l.hasChild(i)){const c=t.serverCache.getNode().getImmediateChild(i),l=or(e,c,n);d=ir(e,d,new dt(i),l,r,s,o,a)}})),c.children.inorderTraversal(((i,n)=>{const c=!t.serverCache.isCompleteForChild(i)&&null===n.value;if(!l.hasChild(i)&&!c){const c=t.serverCache.getNode().getImmediateChild(i),l=or(e,c,n);d=ir(e,d,new dt(i),l,r,s,o,a)}})),d}function cr(e,t,i,n,r,s,o){if(null!=Hn(r,i))return t;const a=t.serverCache.isFiltered(),c=t.serverCache;if(null!=n.value){if(yt(i)&&c.isFullyInitialized()||c.isCompleteForPath(i))return ir(e,t,i,c.getNode().getChild(i),r,s,a,o);if(yt(i)){let n=new un(null);return c.getNode().forEachChild(Bt,((e,t)=>{n=n.set(new dt(e),t)})),ar(e,t,i,n,r,s,a,o)}return t}{let d=new un(null);return n.foreach(((e,t)=>{const n=vt(i,e);c.isCompleteForPath(n)&&(d=d.set(e,c.getNode().getChild(n)))})),ar(e,t,i,d,r,s,a,o)}}function dr(e,t,i,n,r){const s=t.serverCache,o=an(t,s.getNode(),s.isFullyInitialized()||yt(i),s.isFiltered());return tr(e,o,i,n,Yn,r)}function lr(e,t,i,n,r,o){let a;if(null!=Hn(n,i))return t;{const c=new Xn(n,t,r),d=t.eventCache.getNode();let l;if(yt(i)||".priority"===ht(i)){let i;if(t.serverCache.isFullyInitialized())i=jn(n,dn(t));else{const e=t.serverCache.getNode();(0,s.hu)(e instanceof pi,"serverChildren would be complete if leaf node"),i=Vn(n,e)}l=e.filter.updateFullNode(d,i,o)}else{const r=ht(i);let s=Kn(n,r,t.serverCache);null==s&&t.serverCache.isCompleteForChild(r)&&(s=d.getImmediateChild(r)),l=null!=s?e.filter.updateChild(d,r,s,pt(i),c,o):t.eventCache.getNode().hasChild(r)?e.filter.updateChild(d,r,pi.EMPTY_NODE,pt(i),c,o):d,l.isEmpty()&&t.serverCache.isFullyInitialized()&&(a=jn(n,dn(t)),a.isLeafNode()&&(l=e.filter.updateFullNode(l,a,o)))}return a=t.serverCache.isFullyInitialized()||null!=Hn(n,lt()),on(t,l,a,e.filter.filtersNodes())}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hr{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const i=this.query_._queryParams,n=new Ri(i.getIndex()),r=Oi(i);this.processor_=$n(r);const s=t.serverCache,o=t.eventCache,a=n.updateFullNode(pi.EMPTY_NODE,s.getNode(),null),c=r.updateFullNode(pi.EMPTY_NODE,o.getNode(),null),d=new Qi(a,s.isFullyInitialized(),n.filtersNodes()),l=new Qi(c,o.isFullyInitialized(),r.filtersNodes());this.viewCache_=sn(l,d),this.eventGenerator_=new Zi(this.query_)}get query(){return this.query_}}function ur(e){return e.viewCache_.serverCache.getNode()}function pr(e){return cn(e.viewCache_)}function mr(e,t){const i=dn(e.viewCache_);return i&&(e.query._queryParams.loadsAllData()||!yt(t)&&!i.getImmediateChild(ht(t)).isEmpty())?i.getChild(t):null}function fr(e){return 0===e.eventRegistrations_.length}function gr(e,t){e.eventRegistrations_.push(t)}function _r(e,t,i){const n=[];if(i){(0,s.hu)(null==t,"A cancel should cancel all event registrations.");const r=e.query._path;e.eventRegistrations_.forEach((e=>{const t=e.createCancelEvent(i,r);t&&n.push(t)}))}if(t){let i=[];for(let n=0;n<e.eventRegistrations_.length;++n){const r=e.eventRegistrations_[n];if(r.matches(t)){if(t.hasAnyCallback()){i=i.concat(e.eventRegistrations_.slice(n+1));break}}else i.push(r)}e.eventRegistrations_=i}else e.eventRegistrations_=[];return n}function vr(e,t,i,n){t.type===Ki.MERGE&&null!==t.source.queryId&&((0,s.hu)(dn(e.viewCache_),"We should always have a full cache before handling merges"),(0,s.hu)(cn(e.viewCache_),"Missing event cache, even though we have a server cache"));const r=e.viewCache_,o=Zn(e.processor_,r,t,i,n);return Qn(e.processor_,o.viewCache),(0,s.hu)(o.viewCache.serverCache.isFullyInitialized()||!r.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),e.viewCache_=o.viewCache,Er(e,o.changes,o.viewCache.eventCache.getNode(),null)}function yr(e,t){const i=e.viewCache_.eventCache,n=[];if(!i.getNode().isLeafNode()){const e=i.getNode();e.forEachChild(si,((e,t)=>{n.push(bi(e,t))}))}return i.isFullyInitialized()&&n.push(Si(i.getNode())),Er(e,n,i.getNode(),t)}function Er(e,t,i,n){const r=n?[n]:e.eventRegistrations_;return en(e.eventGenerator_,t,i,r)}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Sr,br;class wr{constructor(){this.views=new Map}}function Tr(e){(0,s.hu)(!Sr,"__referenceConstructor has already been defined"),Sr=e}function Cr(){return(0,s.hu)(Sr,"Reference.ts has not been loaded"),Sr}function Rr(e){return 0===e.views.size}function Ir(e,t,i,n){const r=t.source.queryId;if(null!==r){const o=e.views.get(r);return(0,s.hu)(null!=o,"SyncTree gave us an op for an invalid query."),vr(o,t,i,n)}{let r=[];for(const s of e.views.values())r=r.concat(vr(s,t,i,n));return r}}function Ar(e,t,i,n,r){const s=t._queryIdentifier,o=e.views.get(s);if(!o){let e=jn(i,r?n:null),s=!1;e?s=!0:n instanceof pi?(e=Vn(i,n),s=!1):(e=pi.EMPTY_NODE,s=!1);const o=sn(new Qi(e,s,!1),new Qi(n,r,!1));return new hr(t,o)}return o}function Pr(e,t,i,n,r,s){const o=Ar(e,t,n,r,s);return e.views.has(t._queryIdentifier)||e.views.set(t._queryIdentifier,o),gr(o,i),yr(o,i)}function Or(e,t,i,n){const r=t._queryIdentifier,s=[];let o=[];const a=Lr(e);if("default"===r)for(const[c,d]of e.views.entries())o=o.concat(_r(d,i,n)),fr(d)&&(e.views.delete(c),d.query._queryParams.loadsAllData()||s.push(d.query));else{const t=e.views.get(r);t&&(o=o.concat(_r(t,i,n)),fr(t)&&(e.views.delete(r),t.query._queryParams.loadsAllData()||s.push(t.query)))}return a&&!Lr(e)&&s.push(new(Cr())(t._repo,t._path)),{removed:s,events:o}}function Nr(e){const t=[];for(const i of e.views.values())i.query._queryParams.loadsAllData()||t.push(i);return t}function Dr(e,t){let i=null;for(const n of e.views.values())i=i||mr(n,t);return i}function kr(e,t){const i=t._queryParams;if(i.loadsAllData())return Mr(e);{const i=t._queryIdentifier;return e.views.get(i)}}function xr(e,t){return null!=kr(e,t)}function Lr(e){return null!=Mr(e)}function Mr(e){for(const t of e.views.values())if(t.query._queryParams.loadsAllData())return t;return null}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fr(e){(0,s.hu)(!br,"__referenceConstructor has already been defined"),br=e}function Ur(){return(0,s.hu)(br,"Reference.ts has not been loaded"),br}let jr=1;class Vr{constructor(e){this.listenProvider_=e,this.syncPointTree_=new un(null),this.pendingWriteTree_=Un(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Br(e,t,i,n,r){return Cn(e.pendingWriteTree_,t,i,n,r),r?Zr(e,new Xi(Gi(),t,i)):[]}function Hr(e,t,i=!1){const n=Rn(e.pendingWriteTree_,t),r=In(e.pendingWriteTree_,t);if(r){let t=new un(null);return null!=n.snap?t=t.set(lt(),!0):U(n.children,(e=>{t=t.set(new dt(e),!0)})),Zr(e,new Ji(n.path,t,i))}return[]}function Wr(e,t,i){return Zr(e,new Xi(qi(),t,i))}function Kr(e,t,i){const n=un.fromObject(i);return Zr(e,new $i(qi(),t,n))}function Gr(e,t){return Zr(e,new Yi(qi(),t))}function qr(e,t,i){const n=ss(e,i);if(n){const i=os(n),r=i.path,s=i.queryId,o=Et(r,t),a=new Yi(zi(s),o);return as(e,r,a)}return[]}function zr(e,t,i,n,r=!1){const s=t._path,o=e.syncPointTree_.get(s);let a=[];if(o&&("default"===t._queryIdentifier||xr(o,t))){const c=Or(o,t,i,n);Rr(o)&&(e.syncPointTree_=e.syncPointTree_.remove(s));const d=c.removed;if(a=c.events,!r){const i=-1!==d.findIndex((e=>e._queryParams.loadsAllData())),r=e.syncPointTree_.findOnPath(s,((e,t)=>Lr(t)));if(i&&!r){const t=e.syncPointTree_.subtree(s);if(!t.isEmpty()){const i=cs(t);for(let t=0;t<i.length;++t){const n=i[t],r=n.query,s=is(e,n);e.listenProvider_.startListening(ds(r),ns(e,r),s.hashFn,s.onComplete)}}}if(!r&&d.length>0&&!n)if(i){const i=null;e.listenProvider_.stopListening(ds(t),i)}else d.forEach((t=>{const i=e.queryToTagMap.get(rs(t));e.listenProvider_.stopListening(ds(t),i)}))}ls(e,d)}return a}function Jr(e,t,i,n){const r=ss(e,n);if(null!=r){const n=os(r),s=n.path,o=n.queryId,a=Et(s,t),c=new Xi(zi(o),a,i);return as(e,s,c)}return[]}function Yr(e,t,i,n){const r=ss(e,n);if(r){const n=os(r),s=n.path,o=n.queryId,a=Et(s,t),c=un.fromObject(i),d=new $i(zi(o),a,c);return as(e,s,d)}return[]}function Xr(e,t,i,n=!1){const r=t._path;let o=null,a=!1;e.syncPointTree_.foreachOnPath(r,((e,t)=>{const i=Et(e,r);o=o||Dr(t,i),a=a||Lr(t)}));let c,d=e.syncPointTree_.get(r);if(d?(a=a||Lr(d),o=o||Dr(d,lt())):(d=new wr,e.syncPointTree_=e.syncPointTree_.set(r,d)),null!=o)c=!0;else{c=!1,o=pi.EMPTY_NODE;const t=e.syncPointTree_.subtree(r);t.foreachChild(((e,t)=>{const i=Dr(t,lt());i&&(o=o.updateImmediateChild(e,i))}))}const l=xr(d,t);if(!l&&!t._queryParams.loadsAllData()){const i=rs(t);(0,s.hu)(!e.queryToTagMap.has(i),"View does not exist, but we have a tag");const n=hs();e.queryToTagMap.set(i,n),e.tagToQueryMap.set(n,i)}const h=Tn(e.pendingWriteTree_,r);let u=Pr(d,t,i,h,o,c);if(!l&&!a&&!n){const i=kr(d,t);u=u.concat(us(e,t,i))}return u}function $r(e,t,i){const n=!0,r=e.pendingWriteTree_,s=e.syncPointTree_.findOnPath(t,((e,i)=>{const n=Et(e,t),r=Dr(i,n);if(r)return r}));return Dn(r,t,s,i,n)}function Qr(e,t){const i=t._path;let n=null;e.syncPointTree_.foreachOnPath(i,((e,t)=>{const r=Et(e,i);n=n||Dr(t,r)}));let r=e.syncPointTree_.get(i);r?n=n||Dr(r,lt()):(r=new wr,e.syncPointTree_=e.syncPointTree_.set(i,r));const s=null!=n,o=s?new Qi(n,!0,!1):null,a=Tn(e.pendingWriteTree_,t._path),c=Ar(r,t,a,s?o.getNode():pi.EMPTY_NODE,s);return pr(c)}function Zr(e,t){return es(t,e.syncPointTree_,null,Tn(e.pendingWriteTree_,lt()))}function es(e,t,i,n){if(yt(e.path))return ts(e,t,i,n);{const r=t.get(lt());null==i&&null!=r&&(i=Dr(r,lt()));let s=[];const o=ht(e.path),a=e.operationForChild(o),c=t.children.get(o);if(c&&a){const e=i?i.getImmediateChild(o):null,t=Gn(n,o);s=s.concat(es(a,c,e,t))}return r&&(s=s.concat(Ir(r,e,n,i))),s}}function ts(e,t,i,n){const r=t.get(lt());null==i&&null!=r&&(i=Dr(r,lt()));let s=[];return t.children.inorderTraversal(((t,r)=>{const o=i?i.getImmediateChild(t):null,a=Gn(n,t),c=e.operationForChild(t);c&&(s=s.concat(ts(c,r,o,a)))})),r&&(s=s.concat(Ir(r,e,n,i))),s}function is(e,t){const i=t.query,n=ns(e,i);return{hashFn:()=>{const e=ur(t)||pi.EMPTY_NODE;return e.hash()},onComplete:t=>{if("ok"===t)return n?qr(e,i._path,n):Gr(e,i._path);{const n=H(t,i);return zr(e,i,null,n)}}}}function ns(e,t){const i=rs(t);return e.queryToTagMap.get(i)}function rs(e){return e._path.toString()+"$"+e._queryIdentifier}function ss(e,t){return e.tagToQueryMap.get(t)}function os(e){const t=e.indexOf("$");return(0,s.hu)(-1!==t&&t<e.length-1,"Bad queryKey."),{queryId:e.substr(t+1),path:new dt(e.substr(0,t))}}function as(e,t,i){const n=e.syncPointTree_.get(t);(0,s.hu)(n,"Missing sync point for query tag that we're tracking");const r=Tn(e.pendingWriteTree_,t);return Ir(n,i,r,null)}function cs(e){return e.fold(((e,t,i)=>{if(t&&Lr(t)){const e=Mr(t);return[e]}{let e=[];return t&&(e=Nr(t)),U(i,((t,i)=>{e=e.concat(i)})),e}}))}function ds(e){return e._queryParams.loadsAllData()&&!e._queryParams.isDefault()?new(Ur())(e._repo,e._path):e}function ls(e,t){for(let i=0;i<t.length;++i){const n=t[i];if(!n._queryParams.loadsAllData()){const t=rs(n),i=e.queryToTagMap.get(t);e.queryToTagMap.delete(t),e.tagToQueryMap.delete(i)}}}function hs(){return jr++}function us(e,t,i){const n=t._path,r=ns(e,t),o=is(e,i),a=e.listenProvider_.startListening(ds(t),r,o.hashFn,o.onComplete),c=e.syncPointTree_.subtree(n);if(r)(0,s.hu)(!Lr(c.value),"If we're adding a query, it shouldn't be shadowed");else{const t=c.fold(((e,t,i)=>{if(!yt(e)&&t&&Lr(t))return[Mr(t).query];{let e=[];return t&&(e=e.concat(Nr(t).map((e=>e.query)))),U(i,((t,i)=>{e=e.concat(i)})),e}}));for(let i=0;i<t.length;++i){const n=t[i];e.listenProvider_.stopListening(ds(n),ns(e,n))}}return a}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ps{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new ps(t)}node(){return this.node_}}class ms{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=vt(this.path_,e);return new ms(this.syncTree_,t)}node(){return $r(this.syncTree_,this.path_)}}const fs=function(e){return e=e||{},e["timestamp"]=e["timestamp"]||(new Date).getTime(),e},gs=function(e,t,i){return e&&"object"===typeof e?((0,s.hu)(".sv"in e,"Unexpected leaf node or priority contents"),"string"===typeof e[".sv"]?_s(e[".sv"],t,i):"object"===typeof e[".sv"]?vs(e[".sv"],t):void(0,s.hu)(!1,"Unexpected server value: "+JSON.stringify(e,null,2))):e},_s=function(e,t,i){switch(e){case"timestamp":return i["timestamp"];default:(0,s.hu)(!1,"Unexpected server value: "+e)}},vs=function(e,t,i){e.hasOwnProperty("increment")||(0,s.hu)(!1,"Unexpected server value: "+JSON.stringify(e,null,2));const n=e["increment"];"number"!==typeof n&&(0,s.hu)(!1,"Unexpected increment value: "+n);const r=t.node();if((0,s.hu)(null!==r&&"undefined"!==typeof r,"Expected ChildrenNode.EMPTY_NODE for nulls"),!r.isLeafNode())return n;const o=r,a=o.getValue();return"number"!==typeof a?n:a+n},ys=function(e,t,i,n){return Ss(t,new ms(i,e),n)},Es=function(e,t,i){return Ss(e,new ps(t),i)};function Ss(e,t,i){const n=e.getPriority().val(),r=gs(n,t.getImmediateChild(".priority"),i);let s;if(e.isLeafNode()){const n=e,s=gs(n.getValue(),t,i);return s!==n.getValue()||r!==n.getPriority().val()?new ti(s,_i(r)):e}{const n=e;return s=n,r!==n.getPriority().val()&&(s=s.updatePriority(new ti(r))),n.forEachChild(si,((e,n)=>{const r=Ss(n,t.getImmediateChild(e),i);r!==n&&(s=s.updateImmediateChild(e,r))})),s}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bs{constructor(e="",t=null,i={children:{},childCount:0}){this.name=e,this.parent=t,this.node=i}}function ws(e,t){let i=t instanceof dt?t:new dt(t),n=e,r=ht(i);while(null!==r){const e=(0,s.DV)(n.node.children,r)||{children:{},childCount:0};n=new bs(r,n,e),i=pt(i),r=ht(i)}return n}function Ts(e){return e.node.value}function Cs(e,t){e.node.value=t,Ds(e)}function Rs(e){return e.node.childCount>0}function Is(e){return void 0===Ts(e)&&!Rs(e)}function As(e,t){U(e.node.children,((i,n)=>{t(new bs(i,e,n))}))}function Ps(e,t,i,n){i&&!n&&t(e),As(e,(e=>{Ps(e,t,!0,n)})),i&&n&&t(e)}function Os(e,t,i){let n=i?e:e.parent;while(null!==n){if(t(n))return!0;n=n.parent}return!1}function Ns(e){return new dt(null===e.parent?e.name:Ns(e.parent)+"/"+e.name)}function Ds(e){null!==e.parent&&ks(e.parent,e.name,e)}function ks(e,t,i){const n=Is(i),r=(0,s.r3)(e.node.children,t);n&&r?(delete e.node.children[t],e.node.childCount--,Ds(e)):n||r||(e.node.children[t]=i.node,e.node.childCount++,Ds(e))}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xs=/[\[\].#$\/\u0000-\u001F\u007F]/,Ls=/[\[\].#$\u0000-\u001F\u007F]/,Ms=10485760,Fs=function(e){return"string"===typeof e&&0!==e.length&&!xs.test(e)},Us=function(e){return"string"===typeof e&&0!==e.length&&!Ls.test(e)},js=function(e){return e&&(e=e.replace(/^\/*\.info(\/|$)/,"/")),Us(e)},Vs=function(e,t,i,n){n&&void 0===t||Bs((0,s.gK)(e,"value"),t,i)},Bs=function(e,t,i){const n=i instanceof dt?new wt(i,e):i;if(void 0===t)throw new Error(e+"contains undefined "+It(n));if("function"===typeof t)throw new Error(e+"contains a function "+It(n)+" with contents = "+t.toString());if(P(t))throw new Error(e+"contains "+t.toString()+" "+It(n));if("string"===typeof t&&t.length>Ms/3&&(0,s.ug)(t)>Ms)throw new Error(e+"contains a string greater than "+Ms+" utf8 bytes "+It(n)+" ('"+t.substring(0,50)+"...')");if(t&&"object"===typeof t){let i=!1,r=!1;if(U(t,((t,s)=>{if(".value"===t)i=!0;else if(".priority"!==t&&".sv"!==t&&(r=!0,!Fs(t)))throw new Error(e+" contains an invalid key ("+t+") "+It(n)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');Tt(n,t),Bs(e,s,n),Ct(n)})),i&&r)throw new Error(e+' contains ".value" child '+It(n)+" in addition to actual children.")}},Hs=function(e,t,i,n){if((!n||void 0!==i)&&!Us(i))throw new Error((0,s.gK)(e,t)+'was an invalid path = "'+i+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},Ws=function(e,t,i,n){i&&(i=i.replace(/^\/*\.info(\/|$)/,"/")),Hs(e,t,i,n)},Ks=function(e,t){if(".info"===ht(t))throw new Error(e+" failed = Can't modify data under /.info/")},Gs=function(e,t){const i=t.path.toString();if("string"!==typeof t.repoInfo.host||0===t.repoInfo.host.length||!Fs(t.repoInfo.namespace)&&"localhost"!==t.repoInfo.host.split(":")[0]||0!==i.length&&!js(i))throw new Error((0,s.gK)(e,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class qs{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function zs(e,t){let i=null;for(let n=0;n<t.length;n++){const r=t[n],s=r.getPath();null===i||St(s,i.path)||(e.eventLists_.push(i),i=null),null===i&&(i={events:[],path:s}),i.events.push(r)}i&&e.eventLists_.push(i)}function Js(e,t,i){zs(e,i),Xs(e,(e=>St(e,t)))}function Ys(e,t,i){zs(e,i),Xs(e,(e=>bt(e,t)||bt(t,e)))}function Xs(e,t){e.recursionDepth_++;let i=!0;for(let n=0;n<e.eventLists_.length;n++){const r=e.eventLists_[n];if(r){const s=r.path;t(s)?($s(e.eventLists_[n]),e.eventLists_[n]=null):i=!1}}i&&(e.eventLists_=[]),e.recursionDepth_--}function $s(e){for(let t=0;t<e.events.length;t++){const i=e.events[t];if(null!==i){e.events[t]=null;const n=i.getEventRunner();E&&w("event: "+i.toString()),z(n)}}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qs="repo_interrupt",Zs=25;class eo{constructor(e,t,i,n){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=i,this.appCheckProvider_=n,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new qs,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Li(),this.transactionQueueTree_=new bs,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function to(e,t,i){if(e.stats_=ge(e.repoInfo_),e.forceRestClient_||J())e.server_=new ki(e.repoInfo_,((t,i,n,r)=>{ro(e,t,i,n,r)}),e.authTokenProvider_,e.appCheckProvider_),setTimeout((()=>so(e,!0)),0);else{if("undefined"!==typeof i&&null!==i){if("object"!==typeof i)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,s.Wl)(i)}catch(n){throw new Error("Invalid authOverride provided: "+n)}}e.persistentConnection_=new Mt(e.repoInfo_,t,((t,i,n,r)=>{ro(e,t,i,n,r)}),(t=>{so(e,t)}),(t=>{oo(e,t)}),e.authTokenProvider_,e.appCheckProvider_,i),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener((t=>{e.server_.refreshAuthToken(t)})),e.appCheckProvider_.addTokenChangeListener((t=>{e.server_.refreshAppCheckToken(t.token)})),e.statsReporter_=_e(e.repoInfo_,(()=>new Wi(e.stats_,e.server_))),e.infoData_=new xi,e.infoSyncTree_=new Vr({startListening:(t,i,n,r)=>{let s=[];const o=e.infoData_.getNode(t._path);return o.isEmpty()||(s=Wr(e.infoSyncTree_,t._path,o),setTimeout((()=>{r("ok")}),0)),s},stopListening:()=>{}}),ao(e,"connected",!1),e.serverSyncTree_=new Vr({startListening:(t,i,n,r)=>(e.server_.listen(t,n,i,((i,n)=>{const s=r(i,n);Ys(e.eventQueue_,t._path,s)})),[]),stopListening:(t,i)=>{e.server_.unlisten(t,i)}})}function io(e){const t=e.infoData_.getNode(new dt(".info/serverTimeOffset")),i=t.val()||0;return(new Date).getTime()+i}function no(e){return fs({timestamp:io(e)})}function ro(e,t,i,n,r){e.dataUpdateCount++;const o=new dt(t);i=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,i):i;let a=[];if(r)if(n){const t=(0,s.UI)(i,(e=>_i(e)));a=Yr(e.serverSyncTree_,o,t,r)}else{const t=_i(i);a=Jr(e.serverSyncTree_,o,t,r)}else if(n){const t=(0,s.UI)(i,(e=>_i(e)));a=Kr(e.serverSyncTree_,o,t)}else{const t=_i(i);a=Wr(e.serverSyncTree_,o,t)}let c=o;a.length>0&&(c=So(e,o)),Ys(e.eventQueue_,c,a)}function so(e,t){ao(e,"connected",t),!1===t&&uo(e)}function oo(e,t){U(t,((t,i)=>{ao(e,t,i)}))}function ao(e,t,i){const n=new dt("/.info/"+t),r=_i(i);e.infoData_.updateSnapshot(n,r);const s=Wr(e.infoSyncTree_,n,r);Ys(e.eventQueue_,n,s)}function co(e){return e.nextWriteId_++}function lo(e,t,i){const n=Qr(e.serverSyncTree_,t);return null!=n?Promise.resolve(n):e.server_.get(t).then((n=>{const r=_i(n).withIndex(t._queryParams.getIndex());let s;if(Xr(e.serverSyncTree_,t,i,!0),t._queryParams.loadsAllData())s=Wr(e.serverSyncTree_,t._path,r);else{const i=ns(e.serverSyncTree_,t);s=Jr(e.serverSyncTree_,t._path,r,i)}return Ys(e.eventQueue_,t._path,s),zr(e.serverSyncTree_,t,i,null,!0),r}),(i=>(go(e,"get for query "+(0,s.Wl)(t)+" failed: "+i),Promise.reject(new Error(i)))))}function ho(e,t,i,n,r){go(e,"set",{path:t.toString(),value:i,priority:n});const s=no(e),o=_i(i,n),a=$r(e.serverSyncTree_,t),c=Es(o,a,s),d=co(e),l=Br(e.serverSyncTree_,t,c,d,!0);zs(e.eventQueue_,l),e.server_.put(t.toString(),o.val(!0),((i,n)=>{const s="ok"===i;s||I("set at "+t+" failed: "+i);const o=Hr(e.serverSyncTree_,d,!s);Ys(e.eventQueue_,t,o),_o(e,r,i,n)}));const h=Io(e,t);So(e,h),Ys(e.eventQueue_,h,[])}function uo(e){go(e,"onDisconnectEvents");const t=no(e),i=Li();Fi(e.onDisconnect_,lt(),((n,r)=>{const s=ys(n,r,e.serverSyncTree_,t);Mi(i,n,s)}));let n=[];Fi(i,lt(),((t,i)=>{n=n.concat(Wr(e.serverSyncTree_,t,i));const r=Io(e,t);So(e,r)})),e.onDisconnect_=Li(),Ys(e.eventQueue_,lt(),n)}function po(e,t,i){let n;n=".info"===ht(t._path)?Xr(e.infoSyncTree_,t,i):Xr(e.serverSyncTree_,t,i),Js(e.eventQueue_,t._path,n)}function mo(e,t,i){let n;n=".info"===ht(t._path)?zr(e.infoSyncTree_,t,i):zr(e.serverSyncTree_,t,i),Js(e.eventQueue_,t._path,n)}function fo(e){e.persistentConnection_&&e.persistentConnection_.interrupt(Qs)}function go(e,...t){let i="";e.persistentConnection_&&(i=e.persistentConnection_.id+":"),w(i,...t)}function _o(e,t,i,n){t&&z((()=>{if("ok"===i)t(null);else{const e=(i||"error").toUpperCase();let r=e;n&&(r+=": "+n);const s=new Error(r);s.code=e,t(s)}}))}function vo(e,t,i){return $r(e.serverSyncTree_,t,i)||pi.EMPTY_NODE}function yo(e,t=e.transactionQueueTree_){if(t||Ro(e,t),Ts(t)){const i=To(e,t);(0,s.hu)(i.length>0,"Sending zero length transaction queue");const n=i.every((e=>0===e.status));n&&Eo(e,Ns(t),i)}else Rs(t)&&As(t,(t=>{yo(e,t)}))}function Eo(e,t,i){const n=i.map((e=>e.currentWriteId)),r=vo(e,t,n);let o=r;const a=r.hash();for(let l=0;l<i.length;l++){const e=i[l];(0,s.hu)(0===e.status,"tryToSendTransactionQueue_: items in queue should all be run."),e.status=1,e.retryCount++;const n=Et(t,e.path);o=o.updateChild(n,e.currentOutputSnapshotRaw)}const c=o.val(!0),d=t;e.server_.put(d.toString(),c,(n=>{go(e,"transaction put response",{path:d.toString(),status:n});let r=[];if("ok"===n){const n=[];for(let t=0;t<i.length;t++)i[t].status=2,r=r.concat(Hr(e.serverSyncTree_,i[t].currentWriteId)),i[t].onComplete&&n.push((()=>i[t].onComplete(null,!0,i[t].currentOutputSnapshotResolved))),i[t].unwatcher();Ro(e,ws(e.transactionQueueTree_,t)),yo(e,e.transactionQueueTree_),Ys(e.eventQueue_,t,r);for(let e=0;e<n.length;e++)z(n[e])}else{if("datastale"===n)for(let e=0;e<i.length;e++)3===i[e].status?i[e].status=4:i[e].status=0;else{I("transaction at "+d.toString()+" failed: "+n);for(let e=0;e<i.length;e++)i[e].status=4,i[e].abortReason=n}So(e,t)}}),a)}function So(e,t){const i=wo(e,t),n=Ns(i),r=To(e,i);return bo(e,r,n),n}function bo(e,t,i){if(0===t.length)return;const n=[];let r=[];const o=t.filter((e=>0===e.status)),a=o.map((e=>e.currentWriteId));for(let c=0;c<t.length;c++){const o=t[c],d=Et(i,o.path);let l,h=!1;if((0,s.hu)(null!==d,"rerunTransactionsUnderNode_: relativePath should not be null."),4===o.status)h=!0,l=o.abortReason,r=r.concat(Hr(e.serverSyncTree_,o.currentWriteId,!0));else if(0===o.status)if(o.retryCount>=Zs)h=!0,l="maxretry",r=r.concat(Hr(e.serverSyncTree_,o.currentWriteId,!0));else{const i=vo(e,o.path,a);o.currentInputSnapshot=i;const n=t[c].update(i.val());if(void 0!==n){Bs("transaction failed: Data returned ",n,o.path);let t=_i(n);const c="object"===typeof n&&null!=n&&(0,s.r3)(n,".priority");c||(t=t.updatePriority(i.getPriority()));const d=o.currentWriteId,l=no(e),h=Es(t,i,l);o.currentOutputSnapshotRaw=t,o.currentOutputSnapshotResolved=h,o.currentWriteId=co(e),a.splice(a.indexOf(d),1),r=r.concat(Br(e.serverSyncTree_,o.path,h,o.currentWriteId,o.applyLocally)),r=r.concat(Hr(e.serverSyncTree_,d,!0))}else h=!0,l="nodata",r=r.concat(Hr(e.serverSyncTree_,o.currentWriteId,!0))}Ys(e.eventQueue_,i,r),r=[],h&&(t[c].status=2,function(e){setTimeout(e,Math.floor(0))}(t[c].unwatcher),t[c].onComplete&&("nodata"===l?n.push((()=>t[c].onComplete(null,!1,t[c].currentInputSnapshot))):n.push((()=>t[c].onComplete(new Error(l),!1,null)))))}Ro(e,e.transactionQueueTree_);for(let s=0;s<n.length;s++)z(n[s]);yo(e,e.transactionQueueTree_)}function wo(e,t){let i,n=e.transactionQueueTree_;i=ht(t);while(null!==i&&void 0===Ts(n))n=ws(n,i),t=pt(t),i=ht(t);return n}function To(e,t){const i=[];return Co(e,t,i),i.sort(((e,t)=>e.order-t.order)),i}function Co(e,t,i){const n=Ts(t);if(n)for(let r=0;r<n.length;r++)i.push(n[r]);As(t,(t=>{Co(e,t,i)}))}function Ro(e,t){const i=Ts(t);if(i){let e=0;for(let t=0;t<i.length;t++)2!==i[t].status&&(i[e]=i[t],e++);i.length=e,Cs(t,i.length>0?i:void 0)}As(t,(t=>{Ro(e,t)}))}function Io(e,t){const i=Ns(wo(e,t)),n=ws(e.transactionQueueTree_,t);return Os(n,(t=>{Ao(e,t)})),Ao(e,n),Ps(n,(t=>{Ao(e,t)})),i}function Ao(e,t){const i=Ts(t);if(i){const n=[];let r=[],o=-1;for(let t=0;t<i.length;t++)3===i[t].status||(1===i[t].status?((0,s.hu)(o===t-1,"All SENT items should be at beginning of queue."),o=t,i[t].status=3,i[t].abortReason="set"):((0,s.hu)(0===i[t].status,"Unexpected transaction status in abort"),i[t].unwatcher(),r=r.concat(Hr(e.serverSyncTree_,i[t].currentWriteId,!0)),i[t].onComplete&&n.push(i[t].onComplete.bind(null,new Error("set"),!1,null))));-1===o?Cs(t,void 0):i.length=o+1,Ys(e.eventQueue_,Ns(t),r);for(let e=0;e<n.length;e++)z(n[e])}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Po(e){let t="";const i=e.split("/");for(let r=0;r<i.length;r++)if(i[r].length>0){let e=i[r];try{e=decodeURIComponent(e.replace(/\+/g," "))}catch(n){}t+="/"+e}return t}function Oo(e){const t={};"?"===e.charAt(0)&&(e=e.substring(1));for(const i of e.split("&")){if(0===i.length)continue;const n=i.split("=");2===n.length?t[decodeURIComponent(n[0])]=decodeURIComponent(n[1]):I(`Invalid query segment '${i}' in query '${e}'`)}return t}const No=function(e,t){const i=Do(e),n=i.namespace;"firebase.com"===i.domain&&R(i.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),n&&"undefined"!==n||"localhost"===i.domain||R("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),i.secure||A();const r="ws"===i.scheme||"wss"===i.scheme;return{repoInfo:new le(i.host,i.secure,n,r,t,"",n!==i.subdomain),path:new dt(i.pathString)}},Do=function(e){let t="",i="",n="",r="",s="",o=!0,a="https",c=443;if("string"===typeof e){let d=e.indexOf("//");d>=0&&(a=e.substring(0,d-1),e=e.substring(d+2));let l=e.indexOf("/");-1===l&&(l=e.length);let h=e.indexOf("?");-1===h&&(h=e.length),t=e.substring(0,Math.min(l,h)),l<h&&(r=Po(e.substring(l,h)));const u=Oo(e.substring(Math.min(e.length,h)));d=t.indexOf(":"),d>=0?(o="https"===a||"wss"===a,c=parseInt(t.substring(d+1),10)):d=t.length;const p=t.slice(0,d);if("localhost"===p.toLowerCase())i="localhost";else if(p.split(".").length<=2)i=p;else{const e=t.indexOf(".");n=t.substring(0,e).toLowerCase(),i=t.substring(e+1),s=n}"ns"in u&&(s=u["ns"])}return{host:t,port:c,domain:i,subdomain:n,secure:o,scheme:a,pathString:r,namespace:s}},ko="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",xo=function(){let e=0;const t=[];return function(i){const n=i===e;let r;e=i;const o=new Array(8);for(r=7;r>=0;r--)o[r]=ko.charAt(i%64),i=Math.floor(i/64);(0,s.hu)(0===i,"Cannot push at time == 0");let a=o.join("");if(n){for(r=11;r>=0&&63===t[r];r--)t[r]=0;t[r]++}else for(r=0;r<12;r++)t[r]=Math.floor(64*Math.random());for(r=0;r<12;r++)a+=ko.charAt(t[r]);return(0,s.hu)(20===a.length,"nextPushId: Length should be 20."),a}}();
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Lo{constructor(e,t,i,n){this.eventType=e,this.eventRegistration=t,this.snapshot=i,this.prevName=n}getPath(){const e=this.snapshot.ref;return"value"===this.eventType?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+(0,s.Wl)(this.snapshot.exportVal())}}class Mo{constructor(e,t,i){this.eventRegistration=e,this.error=t,this.path=i}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fo{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return(0,s.hu)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||void 0!==this.snapshotCallback.userCallback&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Uo{constructor(e,t,i,n){this._repo=e,this._path=t,this._queryParams=i,this._orderByCalled=n}get key(){return yt(this._path)?null:mt(this._path)}get ref(){return new jo(this._repo,this._path)}get _queryIdentifier(){const e=Di(this._queryParams),t=M(e);return"{}"===t?"default":t}get _queryObject(){return Di(this._queryParams)}isEqual(e){if(e=(0,s.m9)(e),!(e instanceof Uo))return!1;const t=this._repo===e._repo,i=St(this._path,e._path),n=this._queryIdentifier===e._queryIdentifier;return t&&i&&n}toJSON(){return this.toString()}toString(){return this._repo.toString()+ft(this._path)}}class jo extends Uo{constructor(e,t){super(e,t,new Pi,!1)}get parent(){const e=_t(this._path);return null===e?null:new jo(this._repo,e)}get root(){let e=this;while(null!==e.parent)e=e.parent;return e}}class Vo{constructor(e,t,i){this._node=e,this.ref=t,this._index=i}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new dt(e),i=Ho(this.ref,e);return new Vo(this._node.getChild(t),i,si)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){if(this._node.isLeafNode())return!1;const t=this._node;return!!t.forEachChild(this._index,((t,i)=>e(new Vo(i,Ho(this.ref,t),si))))}hasChild(e){const t=new dt(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return!this._node.isLeafNode()&&!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function Bo(e,t){return e=(0,s.m9)(e),e._checkNotDeleted("ref"),void 0!==t?Ho(e._root,t):e._root}function Ho(e,t){return e=(0,s.m9)(e),null===ht(e._path)?Ws("child","path",t,!1):Hs("child","path",t,!1),new jo(e._repo,vt(e._path,t))}function Wo(e,t){e=(0,s.m9)(e),Ks("push",e._path),Vs("push",t,e._path,!0);const i=io(e._repo),n=xo(i),r=Ho(e,n),o=Ho(e,n);let a;return a=null!=t?Go(o,t).then((()=>o)):Promise.resolve(o),r.then=a.then.bind(a),r.catch=a.then.bind(a,void 0),r}function Ko(e){return Ks("remove",e._path),Go(e,null)}function Go(e,t){e=(0,s.m9)(e),Ks("set",e._path),Vs("set",t,e._path,!1);const i=new s.BH;return ho(e._repo,e._path,t,null,i.wrapCallback((()=>{}))),i.promise}function qo(e){e=(0,s.m9)(e);const t=new Fo((()=>{})),i=new zo(t);return lo(e._repo,e,i).then((t=>new Vo(t,new jo(e._repo,e._path),e._queryParams.getIndex())))}class zo{constructor(e){this.callbackContext=e}respondsTo(e){return"value"===e}createEvent(e,t){const i=t._queryParams.getIndex();return new Lo("value",this,new Vo(e.snapshotNode,new jo(t._repo,t._path),i))}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Mo(this,e,t):null}matches(e){return e instanceof zo&&(!e.callbackContext||!this.callbackContext||e.callbackContext.matches(this.callbackContext))}hasAnyCallback(){return null!==this.callbackContext}}class Jo{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t="children_added"===e?"child_added":e;return t="children_removed"===t?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Mo(this,e,t):null}createEvent(e,t){(0,s.hu)(null!=e.childName,"Child events should have a childName.");const i=Ho(new jo(t._repo,t._path),e.childName),n=t._queryParams.getIndex();return new Lo(e.type,this,new Vo(e.snapshotNode,i,n),e.prevName)}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof Jo&&(this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)))}hasAnyCallback(){return!!this.callbackContext}}function Yo(e,t,i,n,r){let s;if("object"===typeof n&&(s=void 0,r=n),"function"===typeof n&&(s=n),r&&r.onlyOnce){const t=i,n=(i,n)=>{mo(e._repo,e,a),t(i,n)};n.userCallback=i.userCallback,n.context=i.context,i=n}const o=new Fo(i,s||void 0),a="value"===t?new zo(o):new Jo(t,o);return po(e._repo,e,a),()=>mo(e._repo,e,a)}function Xo(e,t,i,n){return Yo(e,"value",t,i,n)}Tr(jo),Fr(jo);
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const $o="FIREBASE_DATABASE_EMULATOR_HOST",Qo={};let Zo=!1;function ea(e,t,i,n){e.repoInfo_=new le(`${t}:${i}`,!1,e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams,!0),n&&(e.authTokenProvider_=n)}function ta(e,t,i,n,r){let s=n||e.options.databaseURL;void 0===s&&(e.options.projectId||R("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),w("Using default host for project ",e.options.projectId),s=`${e.options.projectId}-default-rtdb.firebaseio.com`);let o,a,c=No(s,r),d=c.repoInfo;"undefined"!==typeof process&&(a={NODE_ENV:"production",BASE_URL:"/"}[$o]),a?(o=!0,s=`http://${a}?ns=${d.namespace}`,c=No(s,r),d=c.repoInfo):o=!c.repoInfo.secure;const l=r&&o?new Q(Q.OWNER):new $(e.name,e.options,t);Gs("Invalid Firebase Database URL",c),yt(c.path)||R("Database URL must point to the root of a Firebase Database (not including a child path).");const h=na(d,e,l,new X(e.name,i));return new ra(h,e)}function ia(e,t){const i=Qo[t];i&&i[e.key]===e||R(`Database ${t}(${e.repoInfo_}) has already been deleted.`),fo(e),delete i[e.key]}function na(e,t,i,n){let r=Qo[t.name];r||(r={},Qo[t.name]=r);let s=r[e.toURLString()];return s&&R("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new eo(e,Zo,i,n),r[e.toURLString()]=s,s}class ra{constructor(e,t){this._repoInternal=e,this.app=t,this["type"]="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(to(this._repoInternal,this.app.options.appId,this.app.options["databaseAuthVariableOverride"]),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new jo(this._repo,lt())),this._rootInternal}_delete(){return null!==this._rootInternal&&(ia(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){null===this._rootInternal&&R("Cannot call "+e+" on a deleted database.")}}function sa(e=(0,n.Mq)(),t){const i=(0,n.qX)(e,"database").getImmediate({identifier:t});if(!i._instanceStarted){const e=(0,s.P0)("database");e&&oa(i,...e)}return i}function oa(e,t,i,n={}){e=(0,s.m9)(e),e._checkNotDeleted("useEmulator"),e._instanceStarted&&R("Cannot call useEmulator() after instance has already been initialized.");const r=e._repoInternal;let o;if(r.repoInfo_.nodeAdmin)n.mockUserToken&&R('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new Q(Q.OWNER);else if(n.mockUserToken){const t="string"===typeof n.mockUserToken?n.mockUserToken:(0,s.Sg)(n.mockUserToken,e.app.options.projectId);o=new Q(t)}ea(r,t,i,o)}
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function aa(e){l(n.Jn),(0,n.Xd)(new r.wA("database",((e,{instanceIdentifier:t})=>{const i=e.getProvider("app").getImmediate(),n=e.getProvider("auth-internal"),r=e.getProvider("app-check-internal");return ta(i,n,r,t)}),"PUBLIC").setMultipleInstances(!0)),(0,n.KN)(a,c,e),(0,n.KN)(a,c,"esm2017")}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Mt.prototype.simpleListen=function(e,t){this.sendRequest("q",{p:e},t)},Mt.prototype.echo=function(e,t){this.sendRequest("echo",{d:e},t)};aa()},7103:function(e,t,i){"use strict";i.d(t,{v:function(){return P}});var n=i(3396),r=i(9242),s=i(652),o=i(1970),a=i(1138),c=i(7041),d=i(5221),l=i(8434),h=i(320),u=i(131),p=i(9888),m=i(4870);const f=Symbol.for("vuetify:v-chip-group");(0,h.ev)()({name:"VChipGroup",props:{column:Boolean,filter:Boolean,valueComparator:{type:Function,default:u.vZ},...(0,o.k4)({selectedClass:"v-chip--selected"}),...(0,a.Q)(),...(0,c.x$)(),...(0,d.bk)({variant:"tonal"})},emits:{"update:modelValue":e=>!0},setup(e,t){let{slots:i}=t;const{themeClasses:r}=(0,c.ER)(e),{isSelected:s,select:a,next:d,prev:h,selected:u}=(0,o._v)(e,f);return(0,l.AF)({VChip:{color:(0,m.Vh)(e,"color"),disabled:(0,m.Vh)(e,"disabled"),filter:(0,m.Vh)(e,"filter"),variant:(0,m.Vh)(e,"variant")}}),(0,p.L)((()=>(0,n.Wm)(e.tag,{class:["v-chip-group",{"v-chip-group--column":e.column},r.value]},{default:()=>[i.default?.({isSelected:s,select:a,next:d,prev:h,selected:u.value})]}))),{}}});var g=i(836),_=i(8952),v=i(3289),y=i(2718),E=i(9694),S=i(2465),b=i(4231),w=i(6183),T=i(9374),C=i(8717),R=i(4960),I=i(1629),A=i(3824);const P=(0,h.ev)()({name:"VChip",directives:{Ripple:A.H},props:{activeClass:String,appendAvatar:String,appendIcon:R.lE,closable:Boolean,closeIcon:{type:R.lE,default:"$delete"},closeLabel:{type:String,default:"$vuetify.close"},draggable:Boolean,filter:Boolean,filterIcon:{type:String,default:"$complete"},label:Boolean,link:{type:Boolean,default:void 0},pill:Boolean,prependAvatar:String,prependIcon:R.lE,ripple:{type:Boolean,default:!0},text:String,modelValue:{type:Boolean,default:!0},onClick:u.as,onClickOnce:u.as,...(0,y.m)(),...(0,E.f)(),...(0,S.c)(),...(0,o.YQ)(),...(0,b.I)(),...(0,w.GN)(),...(0,T.Z)(),...(0,a.Q)({tag:"span"}),...(0,c.x$)(),...(0,d.bk)({variant:"tonal"})},emits:{"click:close":e=>!0,"update:modelValue":e=>!0,"group:selected":e=>!0,click:e=>!0},setup(e,t){let{attrs:i,emit:a,slots:l}=t;const{t:h}=(0,I.bU)(),{borderClasses:u}=(0,y.P)(e),{colorClasses:p,colorStyles:m,variantClasses:R}=(0,d.c1)(e),{densityClasses:A}=(0,E.t)(e),{elevationClasses:P}=(0,S.Y)(e),{roundedClasses:O}=(0,b.b)(e),{sizeClasses:N}=(0,T.t)(e),{themeClasses:D}=(0,c.ER)(e),k=(0,C.z)(e,"modelValue"),x=(0,o.Yt)(e,f,!1),L=(0,w.nB)(e,i),M=(0,n.Fl)((()=>!1!==e.link&&L.isLink.value)),F=(0,n.Fl)((()=>!e.disabled&&!1!==e.link&&(!!x||e.link||L.isClickable.value))),U=(0,n.Fl)((()=>({"aria-label":h(e.closeLabel),onClick(e){k.value=!1,a("click:close",e)}})));function j(e){a("click",e),F.value&&(L.navigate?.(e),x?.toggle())}function V(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),j(e))}return()=>{const t=L.isLink.value?"a":e.tag,i=!(!e.appendIcon&&!e.appendAvatar),o=!(!i&&!l.append),a=!(!l.close&&!e.closable),c=!(!l.filter&&!e.filter)&&x,h=!(!e.prependIcon&&!e.prependAvatar),f=!(!h&&!l.prepend),y=!x||x.isSelected.value;return k.value&&(0,n.wy)((0,n.Wm)(t,{class:["v-chip",{"v-chip--disabled":e.disabled,"v-chip--label":e.label,"v-chip--link":F.value,"v-chip--filter":c,"v-chip--pill":e.pill},D.value,u.value,y?p.value:void 0,A.value,P.value,O.value,N.value,R.value,x?.selectedClass.value],style:[y?m.value:void 0],disabled:e.disabled||void 0,draggable:e.draggable,href:L.href.value,tabindex:F.value?0:void 0,onClick:j,onKeydown:F.value&&!M.value&&V},{default:()=>[(0,d.Ux)(F.value,"v-chip"),c&&(0,n.Wm)(_.Zq,{key:"filter"},{default:()=>[(0,n.wy)((0,n.Wm)("div",{class:"v-chip__filter"},[l.filter?(0,n.wy)((0,n.Wm)(g.z,{key:"filter-defaults",disabled:!e.filterIcon,defaults:{VIcon:{icon:e.filterIcon}}},null),[[(0,n.Q2)("slot"),l.filter,"default"]]):(0,n.Wm)(v.t,{key:"filter-icon",icon:e.filterIcon},null)]),[[r.F8,x.isSelected.value]])]}),f&&(0,n.Wm)("div",{key:"prepend",class:"v-chip__prepend"},[l.prepend?(0,n.Wm)(g.z,{key:"prepend-defaults",disabled:!h,defaults:{VAvatar:{image:e.prependAvatar,start:!0},VIcon:{icon:e.prependIcon,start:!0}}},l.prepend):(0,n.Wm)(n.HY,null,[e.prependIcon&&(0,n.Wm)(v.t,{key:"prepend-icon",icon:e.prependIcon,start:!0},null),e.prependAvatar&&(0,n.Wm)(s.V,{key:"prepend-avatar",image:e.prependAvatar,start:!0},null)])]),l.default?.({isSelected:x?.isSelected.value,selectedClass:x?.selectedClass.value,select:x?.select,toggle:x?.toggle,value:x?.value.value,disabled:e.disabled})??e.text,o&&(0,n.Wm)("div",{key:"append",class:"v-chip__append"},[l.append?(0,n.Wm)(g.z,{key:"append-defaults",disabled:!i,defaults:{VAvatar:{end:!0,image:e.appendAvatar},VIcon:{end:!0,icon:e.appendIcon}}},l.append):(0,n.Wm)(n.HY,null,[e.appendIcon&&(0,n.Wm)(v.t,{key:"append-icon",end:!0,icon:e.appendIcon},null),e.appendAvatar&&(0,n.Wm)(s.V,{key:"append-avatar",end:!0,image:e.appendAvatar},null)])]),a&&(0,n.Wm)("div",(0,n.dG)({key:"close",class:"v-chip__close"},U.value),[l.close?(0,n.Wm)(g.z,{key:"close-defaults",defaults:{VIcon:{icon:e.closeIcon,size:"x-small"}}},l.close):(0,n.Wm)(v.t,{key:"close-icon",icon:e.closeIcon,size:"x-small"},null)])]}),[[(0,n.Q2)("ripple"),F.value&&e.ripple,null]])}}})},1666:function(e,t,i){"use strict";i.d(t,{c:function(){return f}});var n=i(3396),r=i(2718),s=i(2465),o=i(7396),a=i(4231),c=i(1138),d=i(7041),l=i(2370),h=i(3712),u=i(4870),p=i(320),m=i(9888);const f=(0,p.ev)()({name:"VFooter",props:{app:Boolean,color:String,height:{type:[Number,String],default:"auto"},...(0,r.m)(),...(0,s.c)(),...(0,o.o8)(),...(0,a.I)(),...(0,c.Q)({tag:"footer"}),...(0,d.x$)()},setup(e,t){let{slots:i}=t;const{themeClasses:c}=(0,d.ER)(e),{backgroundColorClasses:p,backgroundColorStyles:f}=(0,l.Y5)((0,u.Vh)(e,"color")),{borderClasses:g}=(0,r.P)(e),{elevationClasses:_}=(0,s.Y)(e),{roundedClasses:v}=(0,a.b)(e),y=(0,u.iH)(32),{resizeRef:E}=(0,h.y)((e=>{e.length&&(y.value=e[0].target.clientHeight)})),S=(0,n.Fl)((()=>"auto"===e.height?y.value:parseInt(e.height,10))),{layoutItemStyles:b}=(0,o.eW)({id:e.name,order:(0,n.Fl)((()=>parseInt(e.order,10))),position:(0,n.Fl)((()=>"bottom")),layoutSize:S,elementSize:(0,n.Fl)((()=>"auto"===e.height?void 0:S.value)),active:(0,n.Fl)((()=>e.app)),absolute:(0,u.Vh)(e,"absolute")});return(0,m.L)((()=>(0,n.Wm)(e.tag,{ref:E,class:["v-footer",c.value,p.value,g.value,_.value,v.value],style:[f.value,e.app?b.value:void 0]},i))),{}}})},4193:function(e,t,i){"use strict";i.d(t,{T:function(){return g}});var n=i(3396),r=i(2583),s=i(836),o=i(3354),a=i(3185),c=i(8717),d=i(5975),l=i(4870),h=i(320),u=i(131),p=i(7514),m=i(9888),f=i(4360);const g=(0,h.ev)()({name:"VMenu",props:{id:String,...(0,u.CE)((0,o.B)({closeDelay:250,closeOnContentClick:!0,locationStrategy:"connected",openDelay:300,scrim:!1,scrollStrategy:"reposition",transition:{component:r.v}}),["absolute"])},emits:{"update:modelValue":e=>!0},setup(e,t){let{slots:i}=t;const r=(0,c.z)(e,"modelValue"),{scopeId:h}=(0,d.a)(),u=(0,p.sq)(),g=(0,n.Fl)((()=>e.id||`v-menu-${u}`)),_=(0,l.iH)(),v=(0,n.f3)(f.N,null),y=(0,l.iH)(0);function E(){v?.closeParents()}(0,n.JJ)(f.N,{register(){++y.value},unregister(){--y.value},closeParents(){setTimeout((()=>{y.value||(r.value=!1,v?.closeParents())}),40)}}),(0,n.YP)(r,(e=>{e?v?.register():v?.unregister()}));const S=(0,n.Fl)((()=>(0,n.dG)({"aria-haspopup":"menu","aria-expanded":String(r.value),"aria-owns":g.value},e.activatorProps)));return(0,m.L)((()=>{const[t]=o.y.filterProps(e);return(0,n.Wm)(o.y,(0,n.dG)({ref:_,class:["v-menu"]},t,{modelValue:r.value,"onUpdate:modelValue":e=>r.value=e,absolute:!0,activatorProps:S.value,"onClick:outside":E},h),{activator:i.activator,default:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,n.Wm)(s.z,{root:!0},{default:()=>[i.default?.(...t)]})}})})),(0,a.F)({id:g,"Î¨openChildren":y},_)}})}}]);
//# sourceMappingURL=live.5cab2ca6.js.map